function e(e,t,r,n){Object.defineProperty(e,t,{get:r,set:n,enumerable:!0,configurable:!0})}function t(e){return e&&e.__esModule?e.default:e}var r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},n=r.parcelRequire26fc,i=n.register;i("7qSdr",function(t,r){e(t.exports,"FUniver",function(){return te});var i=n("7yNYd"),a=n("86b1c"),o=n("3e0Iz"),s=n("4zmLB"),l=n("1HHm1"),d=n("bRzks"),u=n("4XALk"),c=n("fL2Ug"),h=n("2nZdy"),m=n("g6Cit"),p=n("lMvMU"),g=n("7kbBA"),f=n("ca7WX"),v=n("ejawP"),_=n("gwMUy"),I=n("iGtRt"),S=n("5duFt"),C=n("i5NZc");n("25IRk");var y,w=n("9zRwE"),b=n("eqDU2"),R=n("1Dbxg"),w=n("9zRwE"),E=n("2KoFD"),T=Object.defineProperty,M=(e,t,r)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,O=(e,t)=>T(e,"name",{value:t,configurable:!0}),D=(e,t,r)=>M(e,"symbol"!=typeof t?t+"":t,r),U=Object.defineProperty,k=Object.getOwnPropertyDescriptor,P=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?k(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&U(t,r,a),a},"__decorateClass$b"),N=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$b");let x=(O(y=class{constructor(e,t,r,n,i,a){D(this,"id"),this._documentDataModel=e,this._injector=t,this._univerInstanceService=r,this._commandService=n,this._resourceManagerService=i,this._renderManagerService=a,this.id=this._documentDataModel.getUnitId()}getId(){return this._documentDataModel.getUnitId()}getName(){return this.getSnapshot().title||""}getSnapshot(){let e=this._resourceManagerService.getResourcesByType(this.id,i.UniverInstanceType.UNIVER_DOC),t=this._documentDataModel.getSnapshot();return t.resources=e,t}undo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.UndoCommand.id)}redo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.RedoCommand.id)}appendText(e){let t=this.id,{body:r}=this.getSnapshot();if(!r)throw Error("The document body is empty");let n=r.dataStream.length-2,i={startOffset:n,endOffset:n,collapsed:!0,segmentId:""},{segmentId:a}=i;return this._commandService.executeCommand(m.InsertCommand.id,{unitId:t,body:{dataStream:e},range:i,segmentId:a})}setSelection(e,t){var r;let n=null==(r=this._renderManagerService.getRenderById(this.getId()))?void 0:r.with(m.DocSelectionRenderService);null==n||n.removeAllRanges(),null==n||n.addDocRanges([{startOffset:e,endOffset:t,rangeType:i.DOC_RANGE_TYPE.TEXT}],!0)}},"FDocument"),y);x=P([N(1,(0,i.Inject)(i.Injector)),N(2,i.IUniverInstanceService),N(3,i.ICommandService),N(4,i.IResourceManagerService),N(5,o.IRenderManagerService)],x);let A={onBeforeCopy(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{t.id===c.CopyCommand.id&&e()})},onCopy(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{t.id===c.CopyCommand.id&&e()})},onBeforePaste(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{t.id===c.PasteCommand.id&&e()})},onPaste(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{t.id===c.PasteCommand.id&&e()})}},L={beforeUndo(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{if(t.id===i.UndoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopUndoElement();t&&e(t)}})},afterUndo(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{if(t.id===i.UndoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopUndoElement();t&&e(t)}})},beforeRedo(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{if(t.id===i.RedoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopRedoElement();t&&e(t)}})},afterRedo(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{if(t.id===i.RedoCommand.id){let t=this._injector.get(i.IUndoRedoService).pitchTopRedoElement();t&&e(t)}})}};var F,j=Object.defineProperty,V=Object.getOwnPropertyDescriptor,H=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?V(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&j(t,r,a),a},"__decorateClass$a"),$=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$a");let B=(O(F=class{constructor(e,t){D(this,"onBeforeUndo",L.beforeUndo.bind(this)),D(this,"onUndo",L.afterUndo.bind(this)),D(this,"onBeforeRedo",L.beforeRedo.bind(this)),D(this,"onRedo",L.afterRedo.bind(this)),D(this,"onBeforeCopy",A.onBeforeCopy.bind(this)),D(this,"onCopy",A.onCopy.bind(this)),D(this,"onBeforePaste",A.onBeforePaste.bind(this)),D(this,"onPaste",A.onPaste.bind(this)),this._injector=e,this._lifecycleService=t}onStarting(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,p.filter)(e=>e===i.LifecycleStages.Starting)).subscribe(e))}onReady(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,p.filter)(e=>e===i.LifecycleStages.Ready)).subscribe(e))}onRendered(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,p.filter)(e=>e===i.LifecycleStages.Rendered)).subscribe(e))}onSteady(e){return(0,i.toDisposable)(this._lifecycleService.lifecycle$.pipe((0,p.filter)(e=>e===i.LifecycleStages.Steady)).subscribe(e))}},"FHooks"),F);B=H([$(0,(0,i.Inject)(i.Injector)),$(1,(0,i.Inject)(i.LifecycleService))],B);var W,G=Object.defineProperty,z=Object.getOwnPropertyDescriptor,Y=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&G(t,r,a),a},"__decorateClass$9"),K=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let q=(O(W=class{constructor(e,t,r,n,i){this._workbook=e,this._worksheet=t,this._filterModel=r,this._injector=n,this._commandSrv=i}getFilteredOutRows(){return Array.from(this._filterModel.filteredOutRows).sort()}getColumnFilterCriteria(e){var t;return null==(t=this._filterModel.getFilterColumn(e))?void 0:t.getColumnData()}removeColumnFilterCriteria(e){return this._commandSrv.executeCommand(I.SetSheetsFilterCriteriaCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),col:e,criteria:null})}setColumnFilterCriteria(e,t){return this._commandSrv.executeCommand(I.SetSheetsFilterCriteriaCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),col:e,criteria:t})}getRange(){let e=this._filterModel.getRange();return this._injector.createInstance(e_,this._workbook,this._worksheet,e)}removeFilterCriteria(){return this._commandSrv.executeCommand(I.ClearSheetsFilterCriteriaCommand.id)}remove(){return this._commandSrv.executeCommand(I.RemoveSheetFilterCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId()})}},"FFilter"),W);q=Y([K(3,(0,i.Inject)(i.Injector)),K(4,i.ICommandService)],q);var X,Q=Object.defineProperty,Z=Object.getOwnPropertyDescriptor,J=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&Q(t,r,a),a},"__decorateClass$8"),ee=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");let et=(O(X=class{constructor(e,t,r,n,i,a){this._thread=e,this._parent=t,this._injector=r,this._commandService=n,this._univerInstanceService=i,this._threadCommentModel=a}_getRef(){var e;let t=(null==(e=this._parent)?void 0:e.ref)||this._thread.ref;return(0,a.deserializeRangeWithSheet)(t).range}getIsRoot(){return!this._parent}getCommentData(){let{children:e,...t}=this._thread;return t}getReplies(){var e;let t=this._getRef(),r=this._threadCommentModel.getCommentWithChildren(this._thread.unitId,this._thread.subUnitId,t.startRow,t.startColumn);return null==(e=null==r?void 0:r.children)?void 0:e.map(e=>this._injector.createInstance(et,e))}getRange(){let e=this._univerInstanceService.getUnit(this._thread.unitId,i.UniverInstanceType.UNIVER_SHEET);if(!e)return null;let t=e.getSheetBySheetId(this._thread.subUnitId);if(!t)return null;let r=this._getRef();return this._injector.createInstance(e_,e,t,r)}getContent(){return this._thread.text}delete(){return this._commandService.executeCommand(this.getIsRoot()?w.DeleteCommentTreeCommand.id:w.DeleteCommentCommand.id,{commentId:this._thread.id,unitId:this._thread.unitId,subUnitId:this._thread.subUnitId})}async update(e){let t=(0,R.getDT)();return await this._commandService.executeCommand(w.UpdateCommentCommand.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,payload:{commentId:this._thread.id,text:e,updated:!0,updateT:t}})}resolve(e){return this._commandService.executeCommand(w.ResolveCommentCommand.id,{unitId:this._thread.unitId,subUnitId:this._thread.subUnitId,commentId:this._thread.id,resolved:null!=e?e:!this._thread.resolved})}},"FThreadComment"),X);function er(e){switch(e){case"left":return i.HorizontalAlign.LEFT;case"center":return i.HorizontalAlign.CENTER;case"normal":return i.HorizontalAlign.RIGHT;default:throw Error(`Invalid horizontal alignment: ${e}`)}}function en(e){switch(e){case i.HorizontalAlign.LEFT:return"left";case i.HorizontalAlign.CENTER:return"center";case i.HorizontalAlign.RIGHT:return"normal";default:throw Error(`Invalid horizontal alignment: ${e}`)}}function ei(e){switch(e){case"top":return i.VerticalAlign.TOP;case"middle":return i.VerticalAlign.MIDDLE;case"bottom":return i.VerticalAlign.BOTTOM;default:throw Error(`Invalid vertical alignment: ${e}`)}}function ea(e){switch(e){case i.VerticalAlign.TOP:return"top";case i.VerticalAlign.MIDDLE:return"middle";case i.VerticalAlign.BOTTOM:return"bottom";default:throw Error(`Invalid vertical alignment: ${e}`)}}function eo(e){return(0,i.isFormulaString)(e)?{f:e}:(0,i.isCellV)(e)?{v:e}:((0,i.isICellData)(e),e)}function es(e,t){let r=new i.ObjectMatrix,{startRow:n,startColumn:a,endRow:o,endColumn:s}=t;if((0,i.Tools).isArray(e))for(let t=0;t<=o-n;t++)for(let i=0;i<=s-a;i++)r.setValue(t+n,i+a,eo(e[t][i]));else new(0,i.ObjectMatrix)(e).forValue((e,t,n)=>{r.setValue(e,t,eo(n))});return r.getMatrix()}function el(e,t){return!!ed(e,t)&&(t.startColumn!==t.endColumn||t.startRow!==t.endRow)}function ed(e,t){return e.startColumn===t.startColumn&&e.endColumn===t.endColumn&&e.startRow===t.startRow&&e.endRow===t.endRow}function eu(e,t){let r;let{componentKey:n,isVue3:a}=e,o=new i.DisposableCollection;return"string"==typeof n?r=n:(r=`External_${(0,i.generateRandomId)(6)}`,o.add(t.register(r,n,{framework:a?"vue3":"react"}))),{key:r,disposableCollection:o}}function ec(e,t){return{startRow:e.startRow,endRow:e.endRow,startColumn:0,endColumn:t.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW}}function eh(e,t){return{startRow:0,endRow:t.getRowCount()-1,startColumn:e.startColumn,endColumn:e.endColumn,rangeType:i.RANGE_TYPE.COLUMN}}et=J([ee(2,(0,i.Inject)(i.Injector)),ee(3,i.ICommandService),ee(4,i.IUniverInstanceService),ee(5,(0,i.Inject)(b.SheetsThreadCommentModel))],et),O(er,"transformFacadeHorizontalAlignment"),O(en,"transformCoreHorizontalAlignment"),O(ei,"transformFacadeVerticalAlignment"),O(ea,"transformCoreVerticalAlignment"),O(eo,"covertCellValue"),O(es,"covertCellValues"),O(el,"isCellMerged"),O(ed,"isSingleCell"),O(eu,"transformComponentKey"),O(ec,"covertToRowRange"),O(eh,"covertToColRange");var em,ep=Object.defineProperty,eg=Object.getOwnPropertyDescriptor,ef=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eg(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ep(t,r,a),a},"__decorateClass$7"),ev=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let e_=(em=class{constructor(e,t,r,n,i,a,o){this._workbook=e,this._worksheet=t,this._range=r,this._injector=n,this._commandService=i,this._renderManagerService=a,this._formulaDataModel=o}getUnitId(){return this._workbook.getUnitId()}getSheetName(){return this._worksheet.getName()}getRange(){return this._range}getRow(){return this._range.startRow}getColumn(){return this._range.startColumn}getWidth(){return this._range.endColumn-this._range.startColumn+1}getHeight(){return this._range.endRow-this._range.startRow+1}getCellData(){var e;return null!=(e=this._worksheet.getCell(this._range.startRow,this._range.startColumn))?e:null}getCell(){let e=this._workbook.getUnitId(),t=this._worksheet.getSheetId();return this._renderManagerService.getRenderById(e).with(u.SheetSkeletonManagerService).getWorksheetSkeleton(t).skeleton.getCellByIndex(this._range.startRow,this._range.startColumn)}isMerged(){return el(this.getCell().mergeInfo,this._range)}getCellRect(){let{startX:e,startY:t,endX:r,endY:n}=this.getCell(),i={x:e,y:t,width:r-e,height:n-t,top:t,left:e,bottom:n,right:r};return{...i,toJSON:/* @__PURE__ */O(()=>JSON.stringify(i),"toJSON")}}getCellStyleData(){var e;let t=this.getCellData(),r=this._workbook.getStyles();return t&&r&&null!=(e=r.getStyleByCell(t))?e:null}getValue(){var e,t;return null!=(t=null==(e=this._worksheet.getCell(this._range.startRow,this._range.startColumn))?void 0:e.v)?t:null}getValues(){var e,t;let{startRow:r,endRow:n,startColumn:i,endColumn:a}=this._range,o=[];for(let s=r;s<=n;s++){let r=[];for(let n=i;n<=a;n++)r.push(null!=(t=null==(e=this._worksheet.getCell(s,n))?void 0:e.v)?t:null);o.push(r)}return o}getCellDataGrid(){let{startRow:e,endRow:t,startColumn:r,endColumn:n}=this._range,i=[];for(let a=e;a<=t;a++){let e=[];for(let t=r;t<=n;t++)e.push(this._worksheet.getCellRaw(a,t));i.push(e)}return i}getFormulas(){let e=[],{startRow:t,endRow:r,startColumn:n,endColumn:i}=this._range,a=this._worksheet.getSheetId(),o=this._workbook.getUnitId();for(let s=t;s<=r;s++){let t=[];for(let e=n;e<=i;e++){let r=this._formulaDataModel.getFormulaStringByCell(s,e,a,o);t.push(r||"")}e.push(t)}return e}getWrap(){return this._worksheet.getRange(this._range).getWrap()===i.BooleanNumber.TRUE}getWrapStrategy(){return this._worksheet.getRange(this._range).getWrapStrategy()}getHorizontalAlignment(){return en(this._worksheet.getRange(this._range).getHorizontalAlignment())}getVerticalAlignment(){return ea(this._worksheet.getRange(this._range).getVerticalAlignment())}setBackgroundColor(e){return this._commandService.executeCommand(v.SetStyleCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"bg",value:{rgb:e}}})}setValue(e){let t=eo(e);if(!t)throw Error("Invalid value");return this._commandService.executeCommand(v.SetRangeValuesCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:t})}setWrap(e){return this._commandService.executeCommand(v.SetTextWrapCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:e?i.WrapStrategy.WRAP:i.WrapStrategy.UNSPECIFIED})}setWrapStrategy(e){return this._commandService.executeCommand(v.SetTextWrapCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:e})}setVerticalAlignment(e){return this._commandService.executeCommand(v.SetVerticalTextAlignCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:ei(e)})}setHorizontalAlignment(e){return this._commandService.executeCommand(v.SetHorizontalTextAlignCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:er(e)})}setNumberFormat(e){let t=[];return this.forEach((r,n)=>t.push({row:r,col:n,pattern:e})),this._commandService.executeCommand(C.SetNumfmtCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId()})}setValues(e){let t=es(e,this._range);return this._commandService.executeCommand(v.SetRangeValuesCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,value:t})}setFontWeight(e){let t;if("bold"===e)t=i.BooleanNumber.TRUE;else if("normal"===e)t=i.BooleanNumber.FALSE;else if(null===e)t=null;else throw Error("Invalid fontWeight");let r={type:"bl",value:t},n={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:r};return this._commandService.executeCommand(v.SetStyleCommand.id,n),this}setFontStyle(e){let t;if("italic"===e)t=i.BooleanNumber.TRUE;else if("normal"===e)t=i.BooleanNumber.FALSE;else if(null===e)t=null;else throw Error("Invalid fontStyle");let r={type:"it",value:t},n={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:r};return this._commandService.executeCommand(v.SetStyleCommand.id,n),this}setFontLine(e){if("underline"===e)this._setFontUnderline({s:i.BooleanNumber.TRUE});else if("line-through"===e)this._setFontStrikethrough({s:i.BooleanNumber.TRUE});else if("none"===e)this._setFontUnderline({s:i.BooleanNumber.FALSE}),this._setFontStrikethrough({s:i.BooleanNumber.FALSE});else if(null===e)this._setFontUnderline(null),this._setFontStrikethrough(null);else throw Error("Invalid fontLine");return this}_setFontUnderline(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"ul",value:e}};this._commandService.executeCommand(v.SetStyleCommand.id,t)}_setFontStrikethrough(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"st",value:e}};this._commandService.executeCommand(v.SetStyleCommand.id,t)}setFontFamily(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"ff",value:e}};return this._commandService.executeCommand(v.SetStyleCommand.id,t),this}setFontSize(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"fs",value:e}};return this._commandService.executeCommand(v.SetStyleCommand.id,t),this}setFontColor(e){let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range,style:{type:"cl",value:null===e?null:{rgb:e}}};return this._commandService.executeCommand(v.SetStyleCommand.id,t),this}forEach(e){let{startColumn:t,startRow:r,endColumn:n,endRow:i}=this._range;this._worksheet.getMatrixWithMergedCells(r,t,i,n).forValue((t,r,n)=>{e(t,r,n)})}generateHTML(){var e;let t=this._injector.get(u.ISheetClipboardService).generateCopyContent(this._workbook.getUnitId(),this._worksheet.getSheetId(),this._range);return null!=(e=null==t?void 0:t.html)?e:""}setDataValidation(e){if(!e)return this._commandService.syncExecuteCommand(f.ClearRangeDataValidationCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),ranges:[this._range]}),this;let t={unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),rule:{...e.rule,ranges:[this._range]}};return this._commandService.syncExecuteCommand(f.AddSheetDataValidationCommand.id,t),this}getDataValidation(){let e=this._injector.get(f.SheetsDataValidationValidatorService).getDataValidation(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]);return e&&new eS(e)}getDataValidations(){return this._injector.get(f.SheetsDataValidationValidatorService).getDataValidations(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range]).map(e=>new eS(e))}async getValidatorStatus(){return this._injector.get(f.SheetsDataValidationValidatorService).validatorRanges(this._workbook.getUnitId(),this._worksheet.getSheetId(),[this._range])}async createFilter(){return this._getFilterModel()||!await this._commandService.executeCommand(I.SetSheetFilterRangeCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),range:this._range})?null:this.getFilter()}getFilter(){let e=this._getFilterModel();return e?this._injector.createInstance(q,this._workbook,this._worksheet,e):null}_getFilterModel(){return this._injector.get(_.SheetsFilterService).getFilterModel(this._workbook.getUnitId(),this._worksheet.getSheetId())}attachPopup(e){let{key:t,disposableCollection:r}=eu(e,this._injector.get(c.ComponentManager)),n=this._injector.get(u.SheetCanvasPopManagerService).attachPopupToCell(this._range.startRow,this._range.startColumn,{...e,componentKey:t},this.getUnitId(),this._worksheet.getSheetId());return n?(r.add(n),r):(r.dispose(),null)}attachAlertPopup(e){let t=this._injector.get(u.CellAlertManagerService),r={workbook:this._workbook,worksheet:this._worksheet,row:this._range.startRow,col:this._range.startColumn,unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId()};return t.showAlert({...e,location:r}),{dispose:/* @__PURE__ */O(()=>{t.removeAlert(e.key)},"dispose")}}getComment(){let e=this._injector.get(b.SheetsThreadCommentModel),t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=e.getByLocation(t,r,this._range.startRow,this._range.startColumn);if(!n)return null;let i=e.getComment(t,r,n);return i?this._injector.createInstance(et,i):null}addComment(e){var t;let r=this._injector,n=null==(t=this.getComment())?void 0:t.getCommentData(),a=r.get(i.ICommandService),o=r.get(i.UserManagerService),s=this._workbook.getUnitId(),l=this._worksheet.getSheetId(),d=`${(0,i.Tools).chatAtABC(this._range.startColumn)}${this._range.startRow+1}`,u=o.getCurrentUser();return a.executeCommand(w.AddCommentCommand.id,{unitId:s,subUnitId:l,comment:{text:e,attachments:[],dT:(0,R.getDT)(),id:(0,i.Tools).generateRandomId(),ref:d,personId:u.userID,parentId:null==n?void 0:n.id,unitId:s,subUnitId:l,threadId:null==n?void 0:n.threadId}})}clearComment(){var e;let t=this._injector,r=null==(e=this.getComment())?void 0:e.getCommentData(),n=t.get(i.ICommandService),a=this._workbook.getUnitId(),o=this._worksheet.getSheetId();return r?n.executeCommand(w.DeleteCommentTreeCommand.id,{unitId:a,subUnitId:o,threadId:r.threadId,commentId:r.id}):Promise.resolve(!0)}async merge(){let e=this._workbook.getUnitId(),t=this._worksheet.getSheetId();return await (0,v.addMergeCellsUtil)(this._injector,e,t,[this._range]),this}async mergeAcross(){let e=(0,v.getAddMergeMutationRangeByType)([this._range],i.Dimension.ROWS),t=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return await (0,v.addMergeCellsUtil)(this._injector,t,r,e),this}async mergeVertically(){let e=(0,v.getAddMergeMutationRangeByType)([this._range],i.Dimension.COLUMNS),t=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return await (0,v.addMergeCellsUtil)(this._injector,t,r,e),this}isPartOfMerge(){let{startRow:e,startColumn:t,endRow:r,endColumn:n}=this._range;return this._worksheet.getMergedCellRange(e,t,r,n).length>0}breakApart(){return this._commandService.executeCommand(v.RemoveWorksheetMergeCommand.id,{ranges:[this._range]}),this}setHyperLink(e,t){let r={unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId(),link:{row:this._range.startRow,column:this._range.startColumn,payload:e,display:t,id:(0,i.generateRandomId)()}};return this._commandService.executeCommand(S.AddHyperLinkCommand.id,r)}getHyperLinks(){var e,t,r;let n=this._worksheet.getCellRaw(this._range.startRow,this._range.startColumn);return null!=n&&n.p&&null!=(r=null==(t=null==(e=n.p.body)?void 0:e.customRanges)?void 0:t.filter(e=>e.rangeType===i.CustomRangeType.HYPERLINK).map(e=>{var t,r,i,a,o;return{id:e.rangeId,startIndex:e.startIndex,endIndex:e.endIndex,url:null!=(r=null==(t=e.properties)?void 0:t.url)?r:"",label:null!=(o=null==(a=null==(i=n.p)?void 0:i.body)?void 0:a.dataStream.slice(e.startIndex+1,e.endIndex))?o:""}}))?r:[]}updateHyperLink(e,t,r){let n={unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this._range.startRow,column:this._range.startColumn,id:e,payload:{payload:t,display:r}};return this._commandService.executeCommand(S.UpdateHyperLinkCommand.id,n)}cancelHyperLink(e){let t={unitId:this.getUnitId(),subUnitId:this._worksheet.getSheetId(),row:this._range.startRow,column:this._range.startColumn,id:e};return this._commandService.executeCommand(S.CancelHyperLinkCommand.id,t)}},O(em,"FRange"),em);e_=ef([ev(3,(0,i.Inject)(i.Injector)),ev(4,i.ICommandService),ev(5,o.IRenderManagerService),ev(6,(0,i.Inject)(a.FormulaDataModel))],e_);let eI=class{constructor(e,t){D(this,"rule"),D(this,"_worksheet"),this.rule=e,this._worksheet=t}getAllowInvalid(){return this.rule.errorStyle!==i.DataValidationErrorStyle.STOP}getCriteriaType(){return this.rule.type}getCriteriaValues(){return[this.rule.operator,this.rule.formula1,this.rule.formula2]}getHelpText(){return this.rule.error}copy(){return new ey(this.rule)}getApplied(){if(!this._worksheet)return!1;let e=this._worksheet.getInject().get(g.DataValidationModel).getRuleById(this._worksheet.getWorkbook().getUnitId(),this._worksheet.getSheetId(),this.rule.uid);return!!(e&&e.ranges.length)}getRanges(){var e;if(!this.getAllowInvalid())return[];let t=null==(e=this._worksheet)?void 0:e.getWorkbook(),r=this.getSheetId();if(!r)return[];let n=null==t?void 0:t.getSheetBySheetId(r);return t&&n?this.rule.ranges.map(e=>{var r;return null==(r=this._worksheet)?void 0:r.getInject().createInstance(e_,t,n,e)}):[]}getUnitId(){var e;return null==(e=this._worksheet)?void 0:e.getWorkbook().getUnitId()}getSheetId(){var e;return null==(e=this._worksheet)?void 0:e.getSheetId()}setCriteria(e,t){return(!this.getApplied()||!!this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(f.UpdateSheetDataValidationSettingCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,setting:{operator:t[0],formula1:t[1],formula2:t[2],type:this.rule.type}}))&&(this.rule.operator=t[0],this.rule.formula1=t[1],this.rule.formula2=t[2],this.rule.type=e,!0)}setOptions(e){return(!this.getApplied()||!!this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(f.UpdateSheetDataValidationOptionsCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,options:{...(0,g.getRuleOptions)(this.rule),...e}}))&&(Object.assign(this.rule,e),!0)}setRanges(e){return(!this.getApplied()||!!this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(f.UpdateSheetDataValidationRangeCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid,ranges:e.map(e=>e.getRange())}))&&(this.rule.ranges=e,!0)}delete(){return!!this.getApplied()&&this._worksheet.getInject().get(i.ICommandService).syncExecuteCommand(f.RemoveSheetDataValidationCommand.id,{unitId:this.getUnitId(),subUnitId:this.getSheetId(),ruleId:this.rule.uid})}};O(eI,"FDataValidation");let eS=eI,eC=class e{constructor(e){D(this,"_rule"),this._rule=null!=e?e:{uid:(0,i.generateRandomId)(),ranges:void 0,type:i.DataValidationType.CUSTOM}}build(){return new eS(this._rule)}copy(){return new e({...this._rule,uid:(0,i.generateRandomId)()})}getAllowInvalid(){return this._rule.errorStyle!==i.DataValidationErrorStyle.STOP}getCriteriaType(){return this._rule.type}getCriteriaValues(){return[this._rule.operator,this._rule.formula1,this._rule.formula2]}getHelpText(){return this._rule.error}requireCheckbox(e,t){return this._rule.type=i.DataValidationType.CHECKBOX,this._rule.formula1=e,this._rule.formula2=t,this}requireDateAfter(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.operator=i.DataValidationOperator.GREATER_THAN,this}requireDateBefore(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN,this}requireDateBetween(e,t){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=t.toLocaleDateString(),this._rule.operator=i.DataValidationOperator.BETWEEN,this}requireDateEqualTo(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.EQUAL,this}requireDateNotBetween(e,t){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=t.toLocaleDateString(),this._rule.operator=i.DataValidationOperator.NOT_BETWEEN,this}requireDateOnOrAfter(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.GREATER_THAN_OR_EQUAL,this}requireDateOnOrBefore(e){return this._rule.type=i.DataValidationType.DATE,this._rule.formula1=e.toLocaleDateString(),this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN_OR_EQUAL,this}requireFormulaSatisfied(e){return this._rule.type=i.DataValidationType.CUSTOM,this._rule.formula1=e,this._rule.formula2=void 0,this}requireNumberBetween(e,t,r){return this._rule.formula1=`${e}`,this._rule.formula2=`${t}`,this._rule.operator=i.DataValidationOperator.BETWEEN,this._rule.type=r?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberGreaterThan(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.GREATER_THAN,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberGreaterThanOrEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.GREATER_THAN_OR_EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberLessThan(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberLessThanOrEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.LESS_THAN_OR_EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberNotBetween(e,t,r){return this._rule.formula1=`${e}`,this._rule.formula2=`${t}`,this._rule.operator=i.DataValidationOperator.NOT_BETWEEN,this._rule.type=r?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireNumberNotEqualTo(e,t){return this._rule.formula1=`${e}`,this._rule.formula2=void 0,this._rule.operator=i.DataValidationOperator.NOT_EQUAL,this._rule.type=t?i.DataValidationType.WHOLE:i.DataValidationType.DECIMAL,this}requireValueInList(e,t,r){return this._rule.type=t?i.DataValidationType.LIST_MULTIPLE:i.DataValidationType.LIST,this._rule.formula1=e.join(","),this._rule.formula2=void 0,this._rule.showDropDown=null==r||r,this}requireValueInRange(e,t,r){return this._rule.type=t?i.DataValidationType.LIST_MULTIPLE:i.DataValidationType.LIST,this._rule.formula1=`=${(0,a.serializeRangeToRefString)({unitId:e.getUnitId(),sheetName:e.getSheetName(),range:e.getRange()})}`,this._rule.formula2=void 0,this._rule.showDropDown=null==r||r,this}setAllowInvalid(e){return this._rule.errorStyle=e?i.DataValidationErrorStyle.WARNING:i.DataValidationErrorStyle.STOP,this}setHelpText(e){return this._rule.error=e,this._rule.showErrorMessage=!0,this}withCriteriaValues(e,t){return this._rule.type=e,this._rule.operator=t[0],this._rule.formula1=t[1],this._rule.formula2=t[2],this}setOptions(e){return Object.assign(this._rule,e),this}};O(eC,"FDataValidationBuilder");let ey=eC;var ew,eb=Object.defineProperty,eR=Object.getOwnPropertyDescriptor,eE=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eR(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eb(t,r,a),a},"__decorateClass$6"),eT=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let eM=(O(ew=class{constructor(e){this._commandService=e}executeCalculation(){this._commandService.executeCommand(a.SetFormulaCalculationStartMutation.id,{commands:[],forceCalculation:!0},{onlyLocal:!0})}stopCalculation(){this._commandService.executeCommand(a.SetFormulaCalculationStopMutation.id,{})}calculationStart(e){return this._commandService.onCommandExecuted(t=>{t.id===a.SetFormulaCalculationStartMutation.id&&e(t.params.forceCalculation)})}calculationEnd(e){return this._commandService.onCommandExecuted(t=>{if(t.id!==a.SetFormulaCalculationNotificationMutation.id)return;let r=t.params;void 0!==r.functionsExecutedState&&e(r.functionsExecutedState)})}onCalculationEnd(){return new Promise((e,t)=>{let r=setTimeout(()=>{t(Error("Calculation end timeout"))},3e4),n=this.calculationEnd(()=>{clearTimeout(r),n.dispose(),e()})})}calculationProcessing(e){return this._commandService.onCommandExecuted(t=>{if(t.id!==a.SetFormulaCalculationNotificationMutation.id)return;let r=t.params;void 0!==r.stageInfo&&e(r.stageInfo)})}},"FFormula"),ew);eM=eE([eT(0,i.ICommandService)],eM);var eO,eD=Object.defineProperty,eU=Object.getOwnPropertyDescriptor,ek=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eU(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eD(t,r,a),a},"__decorateClass$5"),eP=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let eN=(O(eO=class{constructor(e,t,r,n,i,a,o){this._injector=e,this._commandService=t,this._permissionService=r,this._worksheetProtectionRuleModel=n,this._rangeProtectionRuleModel=i,this._worksheetProtectionPointRuleModel=a,this._authzIoService=o}setWorkbookPermissionPoint(e,t,r){let n=new t(e);this._permissionService.getPermissionPoint(n.id)||this._permissionService.addPermissionPoint(n),this._permissionService.updatePermissionPoint(n.id,r)}setWorkbookEditPermission(e,t){this.setWorkbookPermissionPoint(e,v.WorkbookEditablePermission,t)}async addWorksheetBasePermission(e,t){if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).length>0)throw Error("sheet protection cannot intersect with range protection");let r=await this._authzIoService.create({objectType:v.UnitObject.Worksheet});if(this._commandService.syncExecuteCommand(v.AddWorksheetProtectionMutation.id,{unitId:e,subUnitId:t,rule:{permissionId:r,unitType:v.UnitObject.Worksheet,unitId:e,subUnitId:t}}))return r}removeWorksheetPermission(e,t){this._commandService.syncExecuteCommand(v.DeleteWorksheetProtectionMutation.id,{unitId:e,subUnitId:t}),[...(0,v.getAllWorksheetPermissionPoint)(),...(0,v.getAllWorksheetPermissionPointByPointPanel)()].forEach(r=>{let n=new r(e,t);this._permissionService.updatePermissionPoint(n.id,!0)}),this._worksheetProtectionPointRuleModel.deleteRule(e,t)}async setWorksheetPermissionPoint(e,t,r,n){let i;let a=this._worksheetProtectionRuleModel.getRule(e,t);if(r===v.WorksheetEditPermission||r===v.WorksheetViewPermission){if(a)i=a.permissionId;else{if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).length>0)throw Error("sheet protection cannot intersect with range protection");i=await this.addWorksheetBasePermission(e,t)}}else{let r=this._worksheetProtectionPointRuleModel.getRule(e,t);r?i=r.permissionId:(i=await this._authzIoService.create({objectType:v.UnitObject.Worksheet}),this._commandService.executeCommand(v.SetWorksheetPermissionPointsMutation.id,{unitId:e,subUnitId:t,permissionId:i}))}let o=new r(e,t);return this._permissionService.getPermissionPoint(o.id)||this._permissionService.addPermissionPoint(o),this._permissionService.updatePermissionPoint(o.id,n),i}async addRangeBaseProtection(e,t,r){let n=await this._authzIoService.create({objectType:v.UnitObject.SelectRange}),a=`ruleId_${(0,i.generateRandomId)(6)}`;if(this._worksheetProtectionRuleModel.getRule(e,t))throw Error("sheet protection cannot intersect with range protection");if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).some(e=>e.ranges.some(e=>r.some(t=>(0,i.Rectangle).intersects(t,e)))))throw Error("range protection cannot intersect");if(this._commandService.syncExecuteCommand(v.AddRangeProtectionMutation.id,{unitId:e,subUnitId:t,rules:[{permissionId:n,unitType:v.UnitObject.SelectRange,unitId:e,subUnitId:t,ranges:r,id:a}]}))return{permissionId:n,ruleId:a}}removeRangeProtection(e,t,r){this._commandService.syncExecuteCommand(v.DeleteRangeProtectionMutation.id,{unitId:e,subUnitId:t,ruleIds:r})&&0===this._rangeProtectionRuleModel.getSubunitRuleList(e,t).length&&(this._worksheetProtectionPointRuleModel.deleteRule(e,t),[...(0,v.getAllWorksheetPermissionPointByPointPanel)()].forEach(r=>{let n=new r(e,t);this._permissionService.updatePermissionPoint(n.id,n.value)}))}setRangeProtectionPermissionPoint(e,t,r,n,i){let a=new n(e,t,r);this._permissionService.getPermissionPoint(a.id)||this._permissionService.addPermissionPoint(a),this._permissionService.updatePermissionPoint(a.id,i)}setRangeProtectionRanges(e,t,r,n){let a=this._rangeProtectionRuleModel.getRule(e,t,r);if(a){if(this._rangeProtectionRuleModel.getSubunitRuleList(e,t).filter(e=>e.id!==r).some(e=>e.ranges.some(e=>n.some(t=>(0,i.Rectangle).intersects(t,e)))))throw Error("range protection cannot intersect");this._commandService.syncExecuteCommand(v.SetRangeProtectionMutation.id,{unitId:e,subUnitId:t,ruleId:r,rule:{...a,ranges:n}})}}setPermissionDialogVisible(e){this._permissionService.setShowComponents(e)}},"FPermission"),eO);eN=ek([eP(0,(0,i.Inject)(i.Injector)),eP(1,i.ICommandService),eP(2,i.IPermissionService),eP(3,(0,i.Inject)(v.WorksheetProtectionRuleModel)),eP(4,(0,i.Inject)(v.RangeProtectionRuleModel)),eP(5,(0,i.Inject)(v.WorksheetProtectionPointModel)),eP(6,(0,i.Inject)(i.IAuthzIoService))],eN);var ex,eA=Object.defineProperty,eL=Object.getOwnPropertyDescriptor,eF=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eL(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eA(t,r,a),a},"__decorateClass$4"),ej=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let eV=(O(ex=class{constructor(e,t,r,n){this._hoverManagerService=e,this._dragManagerService=t,this._commandService=r,this._injector=n}onCellPointerMove(e){return(0,i.toDisposable)(this._hoverManagerService.currentPosition$.subscribe(e))}onCellPointerOver(e){return(0,i.toDisposable)(this._hoverManagerService.currentCell$.subscribe(e))}onCellDragOver(e){return(0,i.toDisposable)(this._dragManagerService.currentCell$.subscribe(e))}onCellDrop(e){return(0,i.toDisposable)(this._dragManagerService.endCell$.subscribe(e))}},"FSheetHooks"),ex);eV=eF([ej(0,(0,i.Inject)(u.HoverManagerService)),ej(1,(0,i.Inject)(u.DragManagerService)),ej(2,(0,i.Inject)(i.ICommandService)),ej(3,(0,i.Inject)(i.Injector))],eV);var eH,e$=Object.defineProperty,eB=Object.getOwnPropertyDescriptor,eW=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eB(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e$(t,r,a),a},"__decorateClass$3"),eG=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let ez=(O(eH=class{constructor(e,t,r,n){this._workbook=e,this._worksheet=t,this._selections=r,this._injector=n}getActiveRange(){let e=this._selections.find(e=>!!e.primary);return e?this._injector.createInstance(e_,this._workbook,this._worksheet,e.range):null}},"FSelection"),eH);ez=eW([eG(3,(0,i.Inject)(i.Injector))],ez);var eY,eK=Object.defineProperty,eq=Object.getOwnPropertyDescriptor,eX=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eq(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eK(t,r,a),a},"__decorateClass$2"),eQ=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let eZ=(eY=class{constructor(e,t,r,n,i,a){D(this,"setActiveSelection",this.setActiveRange),this._fWorkbook=e,this._workbook=t,this._worksheet=r,this._injector=n,this._selectionManagerService=i,this._commandService=a}getInject(){return this._injector}getWorkbook(){return this._workbook}getSheetId(){return this._worksheet.getSheetId()}getSheetName(){return this._worksheet.getName()}getSelection(){let e=this._selectionManagerService.getCurrentSelections();return e?this._injector.createInstance(ez,this._workbook,this._worksheet,e):null}getDefaultStyle(){return this._worksheet.getDefaultCellStyle()}getRowDefaultStyle(e,t=!1){return this._worksheet.getRowStyle(e,t)}getColumnDefaultStyle(e,t=!1){return this._worksheet.getColumnStyle(e,t)}async setDefaultStyle(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId();return await this._commandService.executeCommand(v.SetWorksheetDefaultStyleCommand.id,{unitId:t,subUnitId:r,defaultStyle:e}),this}async setColumnDefaultStyle(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId();return await this._commandService.executeCommand(v.SetColDataCommand.id,{unitId:r,subUnitId:n,columnData:{[e]:{s:t}}}),this}async setRowDefaultStyle(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId();return await this._commandService.executeCommand(v.SetRowDataCommand.id,{unitId:r,subUnitId:n,rowData:{[e]:{s:t}}}),this}getRange(e,t,r,n){let o,s;if("string"==typeof e){let{range:t,sheetName:r}=(0,a.deserializeRangeWithSheet)(e),n=r?this._workbook.getSheetBySheetName(r):this._worksheet;if(!n)throw Error("Range not found");s=n,o={...t,unitId:this._workbook.getUnitId(),sheetId:s.getSheetId(),rangeType:i.RANGE_TYPE.NORMAL,startRow:t.rangeType===i.RANGE_TYPE.COLUMN?0:t.startRow,endRow:t.rangeType===i.RANGE_TYPE.COLUMN?s.getMaxRows()-1:t.endRow,startColumn:t.rangeType===i.RANGE_TYPE.ROW?0:t.startColumn,endColumn:t.rangeType===i.RANGE_TYPE.ROW?s.getMaxColumns()-1:t.endColumn}}else if("number"==typeof e&&void 0!==t)s=this._worksheet,o={startRow:e,endRow:e+(null!=r?r:1)-1,startColumn:t,endColumn:t+(null!=n?n:1)-1,unitId:this._workbook.getUnitId(),sheetId:this._worksheet.getSheetId()};else throw Error("Invalid range specification");return this._injector.createInstance(e_,this._workbook,s,o)}getMaxColumns(){return this._worksheet.getMaxColumns()}getMaxRows(){return this._worksheet.getMaxRows()}getDataValidations(){return this._injector.get(g.DataValidationModel).getRules(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>new eS(e))}getValidatorStatus(){return this._injector.get(f.SheetsDataValidationValidatorService).validatorWorksheet(this._workbook.getUnitId(),this._worksheet.getSheetId())}getFilter(){let e=this._getFilterModel();return e?this._injector.createInstance(q,this._workbook,this._worksheet,e):null}_getFilterModel(){return this._injector.get(_.SheetsFilterService).getFilterModel(this._workbook.getUnitId(),this._worksheet.getSheetId())}getComments(){return this._injector.get(b.SheetsThreadCommentModel).getSubUnitAll(this._workbook.getUnitId(),this._worksheet.getSheetId()).map(e=>this._injector.createInstance(et,e))}addFloatDomToPosition(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),{key:i,disposableCollection:a}=eu(e,this._injector.get(c.ComponentManager)),o=this._injector.get(E.SheetCanvasFloatDomManagerService).addFloatDomToPosition({...e,componentKey:i,unitId:r,subUnitId:n},t);return o?(a.add(o.dispose),{id:o.id,dispose:/* @__PURE__ */O(()=>{a.dispose(),o.dispose()},"dispose")}):(a.dispose(),null)}async insertRowAfter(e){return this.insertRowsAfter(e,1)}async insertRowBefore(e){return this.insertRowsBefore(e,1)}async insertRows(e,t=1){return this.insertRowsBefore(e,t)}async insertRowsAfter(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.DOWN,o=e+1,s=e+t,l=this._worksheet.getColumnCount()-1,d=(0,v.copyRangeStyles)(this._worksheet,o,s,0,l,!0,e);return await this._commandService.executeCommand(v.InsertRowCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:o,endRow:s,startColumn:0,endColumn:l},cellValue:d}),this}async insertRowsBefore(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.UP,o=e+t-1,s=this._worksheet.getColumnCount()-1,l=(0,v.copyRangeStyles)(this._worksheet,e,o,0,s,!0,e-1);return await this._commandService.executeCommand(v.InsertRowCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:e,endRow:o,startColumn:0,endColumn:s},cellValue:l}),this}async deleteRow(e){return this.deleteRows(e,1)}async deleteRows(e,t){let r={startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1};return await this._commandService.executeCommand(v.RemoveRowCommand.id,{range:r}),this}async moveRows(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),i=ec(e.getRange(),this._worksheet),a={startRow:t,endRow:t,startColumn:i.startColumn,endColumn:i.endColumn};return await this._commandService.executeCommand(v.MoveRowsCommand.id,{unitId:r,subUnitId:n,range:i,fromRange:i,toRange:a}),this}async hideRow(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=ec(e.getRange(),this._worksheet);return await this._commandService.executeCommand(v.SetRowHiddenCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async hideRows(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return await this._commandService.executeCommand(v.SetRowHiddenCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async unhideRow(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=ec(e.getRange(),this._worksheet);return await this._commandService.executeCommand(v.SetSpecificRowsVisibleCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async showRows(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1,rangeType:i.RANGE_TYPE.ROW};return await this._commandService.executeCommand(v.SetSpecificRowsVisibleCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async setRowHeight(e,t){return this.setRowHeights(e,1,t)}async setRowHeights(e,t,r){var n;let i=this._workbook.getUnitId(),a=this._worksheet.getSheetId(),o=this._worksheet.getRowManager(),s=[],l=[];for(let i=e;i<e+t;i++){let e=(null==(n=o.getRow(i))?void 0:n.ah)||this._worksheet.getConfig().defaultRowHeight,t={startRow:i,endRow:i,startColumn:0,endColumn:this._worksheet.getColumnCount()-1};r<=e?s.push(t):l.push(t)}return l.length>0&&await this._commandService.executeCommand(v.SetRowHeightCommand.id,{unitId:i,subUnitId:a,ranges:l,value:r}),s.length>0&&await this._commandService.executeCommand(v.SetWorksheetRowIsAutoHeightCommand.id,{unitId:i,subUnitId:a,ranges:s}),this}async setRowHeightsForced(e,t,r){let n=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),a=[{startRow:e,endRow:e+t-1,startColumn:0,endColumn:this._worksheet.getColumnCount()-1}];return await this._commandService.executeCommand(v.SetRowHeightCommand.id,{unitId:n,subUnitId:i,ranges:a,value:r}),this}async setRowCustom(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n={};for(let[t,r]of Object.entries(e))n[Number(t)]={custom:r};return await this._commandService.executeCommand(v.SetRowDataCommand.id,{unitId:t,subUnitId:r,rowData:n}),this}async insertColumnAfter(e){return this.insertColumnsAfter(e,1)}async insertColumnBefore(e){return this.insertColumnsBefore(e,1)}async insertColumns(e,t=1){return this.insertColumnsBefore(e,t)}async insertColumnsAfter(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.RIGHT,o=this._worksheet.getRowCount()-1,s=e+1,l=e+t,d=(0,v.copyRangeStyles)(this._worksheet,0,o,s,l,!1,e);return await this._commandService.executeCommand(v.InsertColCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:0,endRow:o,startColumn:s,endColumn:l},cellValue:d}),this}async insertColumnsBefore(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a=i.Direction.LEFT,o=this._worksheet.getRowCount()-1,s=e+t-1,l=(0,v.copyRangeStyles)(this._worksheet,0,o,e,s,!1,e-1);return await this._commandService.executeCommand(v.InsertColCommand.id,{unitId:r,subUnitId:n,direction:a,range:{startRow:0,endRow:o,startColumn:e,endColumn:s},cellValue:l}),this}async deleteColumn(e){return this.deleteColumns(e,1)}async deleteColumns(e,t){let r={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:e,endColumn:e+t-1};return await this._commandService.executeCommand(v.RemoveColCommand.id,{range:r}),this}async moveColumns(e,t){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),i=eh(e.getRange(),this._worksheet),a={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:t,endColumn:t};return await this._commandService.executeCommand(v.MoveColsCommand.id,{unitId:r,subUnitId:n,range:i,fromRange:i,toRange:a}),this}async hideColumn(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=eh(e.getRange(),this._worksheet);return await this._commandService.executeCommand(v.SetColHiddenCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async hideColumns(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:e,endColumn:e+t-1,rangeType:i.RANGE_TYPE.COLUMN};return await this._commandService.executeCommand(v.SetColHiddenCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async unhideColumn(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n=eh(e.getRange(),this._worksheet);return await this._commandService.executeCommand(v.SetSpecificColsVisibleCommand.id,{unitId:t,subUnitId:r,ranges:[n]}),this}async showColumns(e,t=1){let r=this._workbook.getUnitId(),n=this._worksheet.getSheetId(),a={startRow:0,endRow:this._worksheet.getRowCount()-1,startColumn:e,endColumn:e+t-1,rangeType:i.RANGE_TYPE.COLUMN};return await this._commandService.executeCommand(v.SetSpecificColsVisibleCommand.id,{unitId:r,subUnitId:n,ranges:[a]}),this}async setColumnWidth(e,t){return this.setColumnWidths(e,1,t)}async setColumnWidths(e,t,r){let n=this._workbook.getUnitId(),i=this._worksheet.getSheetId(),a=[{startColumn:e,endColumn:e+t-1,startRow:0,endRow:this._worksheet.getRowCount()-1}];return await this._commandService.executeCommand(v.SetColWidthCommand.id,{unitId:n,subUnitId:i,ranges:a,value:r}),this}async setColumnCustom(e){let t=this._workbook.getUnitId(),r=this._worksheet.getSheetId(),n={};for(let[t,r]of Object.entries(e))n[Number(t)]={custom:r};return await this._commandService.executeCommand(v.SetColDataCommand.id,{unitId:t,subUnitId:r,columnData:n}),this}getMergedRanges(){return this._worksheet.getSnapshot().mergeData.map(e=>this._injector.createInstance(e_,this._workbook,this._worksheet,e))}getCellMergeData(e,t){let r=this._worksheet.getMergedCell(e,t);if(r)return this._injector.createInstance(e_,this._workbook,this._worksheet,r)}getActiveRange(){return this._fWorkbook.getActiveRange()}setActiveRange(e){let{unitId:t,sheetId:r}=e.getRange();if(t!==this._workbook.getUnitId()||r!==this._worksheet.getSheetId())throw Error("Specified range must be part of the sheet.");this._fWorkbook.setActiveRange(e)}setFreeze(e){return this._commandService.syncExecuteCommand(v.SetFrozenCommand.id,{...e,unitId:this._workbook.getUnitId(),subUnitId:this.getSheetId()})}cancelFreeze(){return this._commandService.syncExecuteCommand(u.CancelFrozenCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this.getSheetId()})}getFreeze(){return this._worksheet.getFreeze()}setFrozenColumns(e){let t=this.getFreeze();this.setFreeze({...t,startColumn:e>0?e:-1,xSplit:e})}setFrozenRows(e){let t=this.getFreeze();this.setFreeze({...t,startRow:e>0?e:-1,ySplit:e})}getFrozenColumns(){let e=this.getFreeze();return -1===e.startColumn?0:e.startColumn}getFrozenRows(){let e=this.getFreeze();return -1===e.startRow?0:e.startRow}hasHiddenGridLines(){return this._worksheet.getConfig().showGridlines===i.BooleanNumber.FALSE}setHiddenGridlines(e){return this._commandService.executeCommand(v.ToggleGridlinesCommand.id,{unitId:this._workbook.getUnitId(),subUnitId:this._worksheet.getSheetId(),showGridlines:e?i.BooleanNumber.FALSE:i.BooleanNumber.TRUE})}onCellDataChange(e){return this._injector.get(i.ICommandService).onCommandExecuted(t=>{if(t.id===v.SetRangeValuesMutation.id){let r=t.params;r.unitId===this._workbook.getUnitId()&&r.subUnitId===this._worksheet.getSheetId()&&r.cellValue&&e(new i.ObjectMatrix(r.cellValue))}})}onBeforeCellDataChange(e){return this._injector.get(i.ICommandService).beforeCommandExecuted(t=>{if(t.id===v.SetRangeValuesMutation.id){let r=t.params;r.unitId===this._workbook.getUnitId()&&r.subUnitId===this._worksheet.getSheetId()&&r.cellValue&&e(new i.ObjectMatrix(r.cellValue))}})}},O(eY,"FWorksheet"),eY);eZ=eX([eQ(3,(0,i.Inject)(i.Injector)),eQ(4,(0,i.Inject)(v.SheetsSelectionsService)),eQ(5,i.ICommandService)],eZ);var eJ,e1=Object.defineProperty,e0=Object.getOwnPropertyDescriptor,e3=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e0(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e1(t,r,a),a},"__decorateClass$1"),e2=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let e4=(eJ=class{constructor(e,t,r,n,i,a,o,s){D(this,"id"),this._workbook=e,this._injector=t,this._resourceLoaderService=r,this._selectionManagerService=n,this._univerInstanceService=i,this._commandService=a,this._permissionService=o,this._logService=s,this.id=this._workbook.getUnitId()}get _dataValidationModel(){return this._injector.get(f.SheetDataValidationModel)}get _threadCommentModel(){return this._injector.get(w.ThreadCommentModel)}getId(){return this.id}getName(){return this._workbook.getName()}save(){return this._resourceLoaderService.saveUnit(this._workbook.getUnitId())}getSnapshot(){return this._logService.warn("use 'save' instead of 'getSnapshot'"),this.save()}getActiveSheet(){let e=this._workbook.getActiveSheet();return this._injector.createInstance(eZ,this,this._workbook,e)}getSheets(){return this._workbook.getSheets().map(e=>this._injector.createInstance(eZ,this,this._workbook,e))}create(e,t,r){let n=(0,i.mergeWorksheetSnapshotWithDefault)({});n.rowCount=t,n.columnCount=r,n.name=e,n.id=e.toLowerCase().replace(/ /g,"-"),this._commandService.syncExecuteCommand(v.InsertSheetCommand.id,{unitId:this.id,index:this._workbook.getSheets().length,sheet:n}),this._commandService.syncExecuteCommand(v.SetWorksheetActiveOperation.id,{unitId:this.id,subUnitId:this._workbook.getSheets()[this._workbook.getSheets().length-1].getSheetId()});let a=this._workbook.getActiveSheet();if(!a)throw Error("No active sheet found");return this._injector.createInstance(eZ,this,this._workbook,a)}getSheetBySheetId(e){let t=this._workbook.getSheetBySheetId(e);return t?this._injector.createInstance(eZ,this,this._workbook,t):null}getSheetByName(e){let t=this._workbook.getSheetBySheetName(e);return t?this._injector.createInstance(eZ,this,this._workbook,t):null}setActiveSheet(e){return this._commandService.syncExecuteCommand(v.SetWorksheetActiveOperation.id,{unitId:this.id,subUnitId:e.getSheetId()}),e}insertSheet(){this._commandService.syncExecuteCommand(v.InsertSheetCommand.id);let e=this.id,t=this._workbook.getSheets()[this._workbook.getSheets().length-1].getSheetId();this._commandService.syncExecuteCommand(v.SetWorksheetActiveOperation.id,{unitId:e,subUnitId:t});let r=this._workbook.getActiveSheet();if(!r)throw Error("No active sheet found");return this._injector.createInstance(eZ,this,this._workbook,r)}deleteSheet(e){let t=this.id,r=e.getSheetId();this._commandService.executeCommand(v.RemoveSheetCommand.id,{unitId:t,subUnitId:r})}undo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.UndoCommand.id)}redo(){return this._univerInstanceService.focusUnit(this.id),this._commandService.executeCommand(i.RedoCommand.id)}openSiderbar(e){return this._injector.get(c.ISidebarService).open(e)}openDialog(e){let t=this._injector.get(c.IDialogService).open({...e,onClose:/* @__PURE__ */O(()=>{t.dispose()},"onClose")});return t}onBeforeCommandExecute(e){return this._commandService.beforeCommandExecuted(t=>{var r;(null==(r=t.params)?void 0:r.unitId)===this.id&&e(t)})}onCommandExecuted(e){return this._commandService.onCommandExecuted(t=>{var r;(null==(r=t.params)?void 0:r.unitId)===this.id&&e(t)})}onSelectionChange(e){return(0,i.toDisposable)(this._selectionManagerService.selectionMoveEnd$.subscribe(t=>{this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId()===this.id&&(null!=t&&t.length?e(t.map(e=>e.range)):e([]))}))}setEditable(e){let t=new v.WorkbookEditablePermission(this._workbook.getUnitId());this._permissionService.getPermissionPoint(t.id)||this._permissionService.addPermissionPoint(t),this._permissionService.updatePermissionPoint(t.id,e)}getValidatorStatus(){return this._injector.get(f.SheetsDataValidationValidatorService).validatorWorkbook(this._workbook.getUnitId())}setActiveRange(e){let t=this.getActiveSheet(),r=e.getRange().sheetId||t.getSheetId(),n=r?this._workbook.getSheetBySheetId(r):this._workbook.getActiveSheet(!0);if(!n)throw Error("No active sheet found");n.getSheetId()!==t.getSheetId()&&this.setActiveSheet(this._injector.createInstance(eZ,this,this._workbook,n));let i={unitId:this.getId(),subUnitId:r,selections:[e].map(e=>({range:e.getRange(),primary:(0,v.getPrimaryForRange)(e.getRange(),n),style:null}))};this._commandService.syncExecuteCommand(v.SetSelectionsOperation.id,i)}getActiveRange(){let e=this._workbook.getActiveSheet(),t=this._selectionManagerService.getCurrentSelections().find(e=>!!e.primary);return t?this._injector.createInstance(e_,this._workbook,e,t.range):null}onDataValidationChange(e){return(0,i.toDisposable)(this._dataValidationModel.ruleChange$.pipe((0,p.filter)(e=>e.unitId===this._workbook.getUnitId())).subscribe(e))}onDataValidationStatusChange(e){return(0,i.toDisposable)(this._dataValidationModel.validStatusChange$.pipe((0,p.filter)(e=>e.unitId===this._workbook.getUnitId())).subscribe(e))}onBeforeAddDataValidation(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===f.AddSheetDataValidationCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeAddDataValidation")}}))}onBeforeUpdateDataValidationCriteria(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===f.UpdateSheetDataValidationSettingCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateDataValidationCriteria")}}))}onBeforeUpdateDataValidationRange(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===f.UpdateSheetDataValidationRangeCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateDataValidationRange")}}))}onBeforeUpdateDataValidationOptions(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===f.UpdateSheetDataValidationOptionsCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateDataValidationOptions")}}))}onBeforeDeleteDataValidation(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===f.RemoveSheetDataValidationCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeDeleteDataValidation")}}))}onBeforeDeleteAllDataValidation(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===f.RemoveSheetAllDataValidationCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeDeleteAllDataValidation")}}))}onThreadCommentChange(e){return(0,i.toDisposable)(this._threadCommentModel.commentUpdate$.pipe((0,p.filter)(e=>e.unitId===this._workbook.getUnitId())).subscribe(e))}onBeforeAddThreadComment(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===w.AddCommentCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeAddThreadComment")}}))}onBeforeUpdateThreadComment(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===w.UpdateCommentCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeUpdateThreadComment")}}))}onBeforeDeleteThreadComment(e){return(0,i.toDisposable)(this._commandService.beforeCommandExecuted((t,r)=>{let n=t.params;if(t.id===w.DeleteCommentCommand.id||t.id===w.DeleteCommentTreeCommand.id){if(n.unitId!==this._workbook.getUnitId())return;if(!1===e(n,r))throw Error("Command is stopped by the hook onBeforeDeleteThreadComment")}}))}createSheetHyperlink(e,t){return this._injector.get(S.SheetsHyperLinkResolverService).buildHyperLink(this.getId(),e,t)}parseSheetHyperlink(e){return this._injector.get(S.SheetsHyperLinkResolverService).parseHyperLink(e)}navigateToSheetHyperlink(e){this._injector.get(S.SheetsHyperLinkResolverService).parseHyperLink(e).handler()}},O(eJ,"FWorkbook"),eJ);e4=e3([e2(1,(0,i.Inject)(i.Injector)),e2(2,(0,i.Inject)(i.IResourceLoaderService)),e2(3,(0,i.Inject)(v.SheetsSelectionsService)),e2(4,i.IUniverInstanceService),e2(5,i.ICommandService),e2(6,i.IPermissionService),e2(7,i.ILogService)],e4);var e6,e9=Object.defineProperty,e5=Object.getOwnPropertyDescriptor,e8=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e5(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e9(t,r,a),a},"__decorateClass"),e7=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let te=(O(e6=class{constructor(e,t,r){D(this,"_debouncedFormulaCalculation"),this._injector=e,this._univerInstanceService=t,this._commandService=r,this._initialize()}_initialize(){this._debouncedFormulaCalculation=(0,i.debounce)(()=>{this._commandService.executeCommand(a.SetFormulaCalculationStartMutation.id,{commands:[],forceCalculation:!0},{onlyLocal:!0})},10)}static getDependencies(e,t){let r=t||[];return e.get(s.ISocketService,i.Quantity.OPTIONAL)||r.push([s.ISocketService,{useClass:s.WebSocketService}]),r}static newAPI(e){let t=e instanceof i.Univer?e.__getInjector():e;return te.getDependencies(t).forEach(e=>t.add(e)),t.createInstance(te)}static newDataValidation(){return new ey}createUniverSheet(e){let t=this._univerInstanceService.createUnit(i.UniverInstanceType.UNIVER_SHEET,e);return this._injector.createInstance(e4,t)}createUniverDoc(e){let t=this._univerInstanceService.createUnit(i.UniverInstanceType.UNIVER_DOC,e);return this._injector.createInstance(x,t)}disposeUnit(e){return this._univerInstanceService.disposeUnit(e)}getUniverSheet(e){let t=this._univerInstanceService.getUniverSheetInstance(e);return t?this._injector.createInstance(e4,t):null}getUniverDoc(e){let t=this._univerInstanceService.getUniverDocInstance(e);return t?this._injector.createInstance(x,t):null}getActiveWorkbook(){let e=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET);return e?this._injector.createInstance(e4,e):null}getActiveDocument(){let e=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_DOC);return e?this._injector.createInstance(x,e):null}registerFunction(e){let t=this._injector.get(d.IRegisterFunctionService);t||(this._injector.add([d.IRegisterFunctionService,{useClass:d.RegisterFunctionService}]),t=this._injector.get(d.IRegisterFunctionService));let r=t.registerFunctions(e);return this._debouncedFormulaCalculation(),(0,i.toDisposable)(()=>{r.dispose()})}registerSheetRowHeaderExtension(e,...t){let r=this._getSheetRenderComponent(e,u.SHEET_VIEW_KEY.ROW),n=r.register(...t);return(0,i.toDisposable)(()=>{n.dispose(),r.makeDirty(!0)})}registerSheetColumnHeaderExtension(e,...t){let r=this._getSheetRenderComponent(e,u.SHEET_VIEW_KEY.COLUMN),n=r.register(...t);return(0,i.toDisposable)(()=>{n.dispose(),r.makeDirty(!0)})}registerSheetMainExtension(e,...t){let r=this._getSheetRenderComponent(e,u.SHEET_VIEW_KEY.MAIN),n=r.register(...t);return(0,i.toDisposable)(()=>{n.dispose(),r.makeDirty(!0)})}getFormula(){return this._injector.createInstance(eM)}getCurrentLifecycleStage(){return this._injector.get(i.LifecycleService).stage}undo(){return this._commandService.executeCommand(i.UndoCommand.id)}redo(){return this._commandService.executeCommand(i.RedoCommand.id)}copy(){return this._commandService.executeCommand(c.CopyCommand.id)}paste(){return this._commandService.executeCommand(c.PasteCommand.id)}onBeforeCommandExecute(e){return this._commandService.beforeCommandExecuted((t,r)=>{e(t,r)})}onCommandExecuted(e){return this._commandService.onCommandExecuted((t,r)=>{e(t,r)})}executeCommand(e,t,r){return this._commandService.executeCommand(e,t,r)}createSocket(e){let t=this._injector.get(s.ISocketService).createSocket(e);if(!t)throw Error("[WebSocketService]: failed to create socket!");return t}getSheetHooks(){return this._injector.createInstance(eV)}getHooks(){return this._injector.createInstance(B)}_getSheetRenderComponent(e,t){let r=this._injector.get(o.IRenderManagerService).getRenderById(e);if(!r)throw Error("Render not found");let{components:n}=r,i=n.get(t);if(!i)throw Error("Render component not found");return i}customizeColumnHeader(e){let t=this.getActiveWorkbook();if(!t){console.error("WorkBook not exist");return}let r=null==t?void 0:t.getId();this._getSheetRenderComponent(r,u.SHEET_VIEW_KEY.COLUMN).setCustomHeader(e)}customizeRowHeader(e){let t=this.getActiveWorkbook();if(!t){console.error("WorkBook not exist");return}let r=null==t?void 0:t.getId();this._getSheetRenderComponent(r,u.SHEET_VIEW_KEY.ROW).setCustomHeader(e)}setCrosshairHighlightEnabled(e){e?this._commandService.executeCommand(l.EnableCrosshairHighlightOperation.id):this._commandService.executeCommand(l.DisableCrosshairHighlightOperation.id)}setCrosshairHighlightColor(e){this._commandService.executeCommand(l.SetCrosshairHighlightColorOperation.id,{value:e})}getPermission(){return this._injector.createInstance(eN)}addWatermark(e,t){let r=this._injector.get(h.WatermarkService);if(e===h.IWatermarkTypeEnum.Text)r.updateWatermarkConfig({type:h.IWatermarkTypeEnum.Text,config:{text:{...h.WatermarkTextBaseConfig,...t}}});else if(e===h.IWatermarkTypeEnum.Image)r.updateWatermarkConfig({type:h.IWatermarkTypeEnum.Image,config:{image:{...h.WatermarkImageBaseConfig,...t}}});else throw Error("Unknown watermark type")}deleteWatermark(){this._injector.get(h.WatermarkService).deleteWatermarkConfig()}},"FUniver"),D(e6,"BorderStyle",i.BorderStyleTypes),D(e6,"WrapStrategy",i.WrapStrategy),e6);te=e8([e7(0,(0,i.Inject)(i.Injector)),e7(1,i.IUniverInstanceService),e7(2,i.ICommandService)],te)}),i("4zmLB",function(t,r){let i,a;e(t.exports,"ISocketService",function(){return G}),e(t.exports,"WebSocketService",function(){return Y});var o=n("7yNYd"),s=(n("1kRQq"),n("dBx9C")),l=n("1O3Nt"),d=n("3yupB"),u=(n("8kCX6"),n("1X68D")),c=(n("7T08c"),n("8LCGH")),h=Object.defineProperty,m=(e,t,r)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,p=(e,t)=>h(e,"name",{value:t,configurable:!0}),g=(e,t,r)=>m(e,"symbol"!=typeof t?t+"":t,r);let f="application/json",v=class{constructor(e){g(this,"_headers",/* @__PURE__ */new Map),"string"==typeof e?this._handleHeadersString(e):e instanceof Headers?this._handleHeaders(e):e&&this._handleHeadersConstructorProps(e)}forEach(e){this._headers.forEach((t,r)=>e(r,t))}has(e){return!!this._headers.has(e.toLowerCase())}get(e){let t=e.toLowerCase();return this._headers.has(t)?this._headers.get(t):null}set(e,t){this._setHeader(e,t)}toHeadersInit(){let e={};return this._headers.forEach((t,r)=>{e[r]=t.join(",")}),null!=e.accept||(e.accept="application/json, text/plain, */*"),null!=e["content-type"]||(e["content-type"]="application/json;charset=UTF-8"),e}_setHeader(e,t){let r=e.toLowerCase();this._headers.has(r)?this._headers.get(r).push(t.toString()):this._headers.set(r,[t.toString()])}_handleHeadersString(e){e.split(`
`).forEach(e=>{let[t,r]=e.split(":");t&&r&&this._setHeader(t,r)})}_handleHeadersConstructorProps(e){Object.entries(e).forEach(([e,t])=>this._setHeader(e,t))}_handleHeaders(e){e.forEach((e,t)=>this._setHeader(t,e))}};p(v,"HTTPHeaders");let _=(0,o.createIdentifier)("network.http-implementation"),I=class{constructor(e){this.params=e}toString(){return this.params?Object.keys(this.params).map(e=>`${e}=${this.params[e]}`).join("&"):""}};p(I,"HTTPParams");let S=0,C=class{constructor(e,t,r){g(this,"uid",S++),this.method=e,this.url=t,this.requestParams=r}get headers(){return this.requestParams.headers}get withCredentials(){return this.requestParams.withCredentials}get responseType(){return this.requestParams.responseType}getUrlWithParams(){var e,t;let r=null==(t=null==(e=this.requestParams)?void 0:e.params)?void 0:t.toString();return r?`${this.url}${this.url.includes("?")?"&":"?"}${r}`:this.url}getBody(){var e,t;let r=null!=(e=this.headers.get("Content-Type"))?e:f,n=null==(t=this.requestParams)?void 0:t.body;return r===f&&n&&"object"==typeof n?JSON.stringify(n):n?`${n}`:null}getHeadersInit(){return this.headers.toHeadersInit()}};p(C,"HTTPRequest");var y,w=Object.defineProperty,b=Object.getOwnPropertyDescriptor,R=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?b(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&w(t,r,a),a},"__decorateClass$1"),E=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let T=(p(y=class extends o.Disposable{constructor(e){super(),g(this,"_interceptors",[]),g(this,"_pipe"),this._http=e}registerHTTPInterceptor(e){if(-1!==this._interceptors.indexOf(e))throw Error("[HTTPService]: The interceptor has already been registered!");return this._interceptors.push(e),this._interceptors=this._interceptors.sort((e,t)=>{var r,n;return(null!=(r=e.priority)?r:0)-(null!=(n=t.priority)?n:0)}),this._pipe=null,(0,o.toDisposable)(()=>(0,o.remove)(this._interceptors,e))}get(e,t){return this._request("GET",e,t)}post(e,t){return this._request("POST",e,t)}put(e,t){return this._request("PUT",e,t)}delete(e,t){return this._request("DELETE",e,t)}patch(e,t){return this._request("PATCH",e,t)}getSSE(e,t,r){var n,i;let a=new C(e,t,{headers:new v(null==r?void 0:r.headers),params:new I(null==r?void 0:r.params),withCredentials:null!=(n=null==r?void 0:r.withCredentials)&&n,reportProgress:!0,responseType:null!=(i=null==r?void 0:r.responseType)?i:"json",body:["GET","DELETE"].includes(e)||null==r?void 0:r.body});return(0,d.of)(a).pipe((0,u.concatMap)(e=>this._runInterceptorsAndImplementation(e)))}async _request(e,t,r){var n,i;let a=new C(e,t,{headers:new v(null==r?void 0:r.headers),params:new I(null==r?void 0:r.params),withCredentials:null!=(n=null==r?void 0:r.withCredentials)&&n,responseType:null!=(i=null==r?void 0:r.responseType)?i:"json",body:["GET","DELETE"].includes(e)||null==r?void 0:r.body}),o=(0,d.of)(a).pipe((0,u.concatMap)(e=>this._runInterceptorsAndImplementation(e)));return await (0,s.firstValueFrom)(o)}_runInterceptorsAndImplementation(e){return this._pipe||(this._pipe=this._interceptors.map(e=>e.interceptor).reduceRight((e,t)=>M(e,t),(e,t)=>t(e))),this._pipe(e,e=>this._http.send(e))}},"HTTPService"),y);function M(e,t){return(r,n)=>t(r,t=>e(t,n))}T=R([E(0,_)],T),p(M,"chainInterceptorFn");var O=((i=O||{})[i.Continue=100]="Continue",i[i.SwitchingProtocols=101]="SwitchingProtocols",i[i.Processing=102]="Processing",i[i.EarlyHints=103]="EarlyHints",i[i.Ok=200]="Ok",i[i.Created=201]="Created",i[i.Accepted=202]="Accepted",i[i.NonAuthoritativeInformation=203]="NonAuthoritativeInformation",i[i.NoContent=204]="NoContent",i[i.ResetContent=205]="ResetContent",i[i.PartialContent=206]="PartialContent",i[i.MultiStatus=207]="MultiStatus",i[i.AlreadyReported=208]="AlreadyReported",i[i.ImUsed=226]="ImUsed",i[i.MultipleChoices=300]="MultipleChoices",i[i.MovedPermanently=301]="MovedPermanently",i[i.Found=302]="Found",i[i.SeeOther=303]="SeeOther",i[i.NotModified=304]="NotModified",i[i.UseProxy=305]="UseProxy",i[i.Unused=306]="Unused",i[i.TemporaryRedirect=307]="TemporaryRedirect",i[i.PermanentRedirect=308]="PermanentRedirect",i[i.BadRequest=400]="BadRequest",i[i.Unauthorized=401]="Unauthorized",i[i.PaymentRequired=402]="PaymentRequired",i[i.Forbidden=403]="Forbidden",i[i.NotFound=404]="NotFound",i[i.MethodNotAllowed=405]="MethodNotAllowed",i[i.NotAcceptable=406]="NotAcceptable",i[i.ProxyAuthenticationRequired=407]="ProxyAuthenticationRequired",i[i.RequestTimeout=408]="RequestTimeout",i[i.Conflict=409]="Conflict",i[i.Gone=410]="Gone",i[i.LengthRequired=411]="LengthRequired",i[i.PreconditionFailed=412]="PreconditionFailed",i[i.PayloadTooLarge=413]="PayloadTooLarge",i[i.UriTooLong=414]="UriTooLong",i[i.UnsupportedMediaType=415]="UnsupportedMediaType",i[i.RangeNotSatisfiable=416]="RangeNotSatisfiable",i[i.ExpectationFailed=417]="ExpectationFailed",i[i.ImATeapot=418]="ImATeapot",i[i.MisdirectedRequest=421]="MisdirectedRequest",i[i.UnprocessableEntity=422]="UnprocessableEntity",i[i.Locked=423]="Locked",i[i.FailedDependency=424]="FailedDependency",i[i.TooEarly=425]="TooEarly",i[i.UpgradeRequired=426]="UpgradeRequired",i[i.PreconditionRequired=428]="PreconditionRequired",i[i.TooManyRequests=429]="TooManyRequests",i[i.RequestHeaderFieldsTooLarge=431]="RequestHeaderFieldsTooLarge",i[i.UnavailableForLegalReasons=451]="UnavailableForLegalReasons",i[i.InternalServerError=500]="InternalServerError",i[i.NotImplemented=501]="NotImplemented",i[i.BadGateway=502]="BadGateway",i[i.ServiceUnavailable=503]="ServiceUnavailable",i[i.GatewayTimeout=504]="GatewayTimeout",i[i.HttpVersionNotSupported=505]="HttpVersionNotSupported",i[i.VariantAlsoNegotiates=506]="VariantAlsoNegotiates",i[i.InsufficientStorage=507]="InsufficientStorage",i[i.LoopDetected=508]="LoopDetected",i[i.NotExtended=510]="NotExtended",i[i.NetworkAuthenticationRequired=511]="NetworkAuthenticationRequired",i),D=((a=D||{})[a.DownloadProgress=0]="DownloadProgress",a[a.Response=1]="Response",a);let U=class{constructor({body:e,headers:t,status:r,statusText:n}){g(this,"type",1),g(this,"body"),g(this,"headers"),g(this,"status"),g(this,"statusText"),this.body=e,this.headers=t,this.status=r,this.statusText=n}};p(U,"HTTPResponse");let k=class{constructor(e,t,r){g(this,"type",0),this.total=e,this.loaded=t,this.partialText=r}};p(k,"HTTPProgress");let P=class{constructor(e,t,r){this.headers=e,this.status=t,this.statusText=r}};p(P,"ResponseHeader");let N=class{constructor({headers:e,status:t,statusText:r,error:n}){g(this,"headers"),g(this,"status"),g(this,"statusText"),g(this,"error"),this.headers=e,this.status=t,this.statusText=r,this.error=n}};p(N,"HTTPResponseError");let x=class{send(e){return new l.Observable(t=>{let r=new XMLHttpRequest;r.open(e.method,e.getUrlWithParams()),e.withCredentials&&(r.withCredentials=!0),e.headers.forEach((e,t)=>r.setRequestHeader(e,t.join(","))),e.headers.has("Accept")||r.setRequestHeader("Accept","application/json, text/plain, */*"),e.headers.has("Content-Type")||r.setRequestHeader("Content-Type","application/json;charset=UTF-8");let n=/* @__PURE__ */p(()=>{let e=r.statusText||"OK";return new P(new v(r.getAllResponseHeaders()),r.status,e)},"buildResponseHeader"),i=/* @__PURE__ */p(()=>{let{headers:i,statusText:a,status:o}=n(),{responseType:s}=e,l=null,d=null;o!==O.NoContent&&(l=typeof r.response>"u"?r.responseText:r.response);let u=o>=200&&o<300;if("json"===s&&"string"==typeof l){let e=l;try{l=l?JSON.parse(l):null}catch(t){u=!1,l=e,d=t}}u?t.next(new U({body:l,headers:i,status:o,statusText:a})):t.error(new N({error:d,headers:i,status:o,statusText:a}))},"onLoadHandler"),a=/* @__PURE__ */p(e=>{let i=new N({error:e,status:r.status||0,statusText:r.statusText||"Unknown Error",headers:n().headers});t.error(i)},"onErrorHandler");r.addEventListener("load",i),r.addEventListener("error",a),r.addEventListener("abort",a),r.addEventListener("timeout",a);let o=e.getBody();return r.send(o),()=>{r.readyState!==r.DONE&&r.abort(),r.removeEventListener("load",i),r.removeEventListener("error",a),r.removeEventListener("abort",a),r.removeEventListener("timeout",a)}})}};p(x,"XHRHTTPImplementation");var A,L=Object.defineProperty,F=Object.getOwnPropertyDescriptor,j=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?F(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&L(t,r,a),a},"__decorateClass"),V=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let H=(p(A=class extends o.Plugin{constructor(e,t){super(),this._config=e,this._injector=t}onStarting(){var e;(0,o.registerDependencies)(this._injector,(0,o.mergeOverrideWithDependencies)([[T],[_,{useClass:x}]],null==(e=this._config)?void 0:e.override))}},"UniverNetworkPlugin"),g(A,"pluginName","UNIVER_NETWORK_PLUGIN"),A);function $(e,t){let r=new Uint8Array(t),n=0;for(let t of e)r.set(t,n),n+=t.length;return r}H=j([V(1,(0,o.Inject)(o.Injector))],H),p(class{send(e){return new l.Observable(t=>{let r=new AbortController;return this._send(e,t,r).then(()=>{},e=>{t.error(new N({error:e}))}),()=>r.abort()})}async _send(e,t,r){var n,i;let a;try{let t=this._parseFetchParamsFromRequest(e);a=await fetch(e.getUrlWithParams(),{signal:r.signal,...t})}catch(e){t.error(new N({error:e,status:null!=(n=e.status)?n:0,statusText:null!=(i=e.statusText)?i:"Unknown Error",headers:e.headers}));return}let o=new v(a.headers),s=a.status,l=a.statusText,d=null;a.body&&(d=await this._readBody(e,a,t)),s>=O.Ok&&s<O.MultipleChoices?t.next(new U({body:d,headers:o,status:s,statusText:l})):t.error(new N({error:d,status:s,statusText:l,headers:o})),t.complete()}async _readBody(e,t,r){var n,i;let a,o;let s=[],l=t.body.getReader(),d=t.headers.get("content-length"),u=0,c=null==(n=e.requestParams)?void 0:n.reportProgress,h=e.responseType;for(;;){let{done:e,value:t}=await l.read();if(e)break;s.push(t),u+=t.length,c&&"text"===h&&(a=(null!=a?a:"")+(null!=o?o:o=new TextDecoder).decode(t,{stream:!0}),r.next(new k(d?Number.parseInt(d,10):void 0,u,a)))}let m=$(s,u);try{let r=null!=(i=t.headers.get("content-type"))?i:"";return W(e,m,r)}catch(e){return r.error(new N({error:e,status:t.status,statusText:t.statusText,headers:new v(t.headers)})),null}}_parseFetchParamsFromRequest(e){return{method:e.method,headers:e.getHeadersInit(),body:e.getBody(),credentials:e.withCredentials?"include":void 0}}},"FetchHTTPImplementation"),p($,"mergeChunks");let B=/^\)\]\}',?\n/;function W(e,t,r){switch(e.responseType){case"json":let n=new TextDecoder().decode(t).replace(B,"");return""===n?null:JSON.parse(n);case"text":return new TextDecoder().decode(t);case"blob":return new Blob([t],{type:r});case"arraybuffer":return t.buffer;default:throw Error(`[FetchHTTPImplementation]: unknown response type: ${e.responseType}.`)}}p(W,"deserialize");let G=(0,o.createIdentifier)("univer.socket"),z=class extends o.Disposable{createSocket(e){try{let t=new WebSocket(e),r=new o.DisposableCollection;return{URL:e,close:/* @__PURE__ */p((e,n)=>{t.close(e,n),r.dispose()},"close"),send:/* @__PURE__ */p(e=>{t.send(e)},"send"),open$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("open",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("open",n)))}).pipe((0,c.share)()),close$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("close",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("close",n)))}).pipe((0,c.share)()),error$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("error",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("error",n)))}).pipe((0,c.share)()),message$:new(0,l.Observable)(e=>{let n=/* @__PURE__ */p(t=>e.next(t),"callback");t.addEventListener("message",n),r.add((0,o.toDisposable)(()=>t.removeEventListener("message",n)))}).pipe((0,c.share)())}}catch(e){return console.error(e),null}}};p(z,"WebSocketService");let Y=z;/* @__PURE__ */(e=300)=>{let t=/* @__PURE__ */p(()=>{},"noop");return r=>new Promise(r=>{t();let n=setTimeout(()=>{r(!0)},e);t=/* @__PURE__ */p(()=>{clearTimeout(n),r(!1)},"cancel")})},/* @__PURE__ */()=>(e,t)=>t.map(t=>({config:t,result:e}))}),i("1kRQq",function(t,r){e(t.exports,"catchError",function(){return function e(t){return(0,o.operate)(function(r,n){var o,s=null,l=!1;s=r.subscribe((0,a.createOperatorSubscriber)(n,void 0,void 0,function(a){o=(0,i.innerFrom)(t(a,e(t)(r))),s?(s.unsubscribe(),s=null,o.subscribe(n)):l=!0})),l&&(s.unsubscribe(),s=null,o.subscribe(n))})}});var i=n("b7gpN"),a=n("iNetn"),o=n("jSzwf")}),i("8kCX6",function(t,r){e(t.exports,"throwError",function(){return o});var i=n("1O3Nt"),a=n("3IQI0");function o(e,t){var r=(0,a.isFunction)(e)?e:function(){return e},n=function(e){return e.error(r())};return new i.Observable(t?function(e){return t.schedule(n,0,e)}:n)}}),i("1X68D",function(t,r){e(t.exports,"concatMap",function(){return o});var i=n("97m73"),a=n("3IQI0");function o(e,t){return(0,a.isFunction)(t)?(0,i.mergeMap)(e,t,1):(0,i.mergeMap)(e,1)}}),i("7T08c",function(t,r){e(t.exports,"retry",function(){return d});var i=n("jSzwf"),a=n("iNetn"),o=n("2N6l4"),s=n("aMpZj"),l=n("b7gpN");function d(e){void 0===e&&(e=1/0);var t,r=(t=e&&"object"==typeof e?e:{count:e}).count,n=void 0===r?1/0:r,d=t.delay,u=t.resetOnSuccess,c=void 0!==u&&u;return n<=0?o.identity:(0,i.operate)(function(e,t){var r,i=0,o=function(){var u=!1;r=e.subscribe((0,a.createOperatorSubscriber)(t,function(e){c&&(i=0),t.next(e)},void 0,function(e){if(i++<n){var c=function(){r?(r.unsubscribe(),r=null,o()):u=!0};if(null!=d){var h="number"==typeof d?(0,s.timer)(d):(0,l.innerFrom)(d(e,i)),m=(0,a.createOperatorSubscriber)(t,function(){m.unsubscribe(),c()},function(){t.complete()});h.subscribe(m)}else c()}else t.error(e)})),u&&(r.unsubscribe(),r=null,o())};o()})}}),i("1HHm1",function(r,i){e(r.exports,"SetCrosshairHighlightColorOperation",function(){return P}),e(r.exports,"EnableCrosshairHighlightOperation",function(){return N}),e(r.exports,"DisableCrosshairHighlightOperation",function(){return x});var a=n("7yNYd"),o=n("3e0Iz"),s=n("fL2Ug"),l=n("5LPkb"),d=n("5K4WI"),u=n("hciHF"),c=n("i54iF"),h=n("ezO1S"),m=n("b7wVW"),p=n("5gqvu"),g=n("4XALk"),f=n("ejawP"),v=Object.defineProperty,_=(e,t,r)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t)=>v(e,"name",{value:t,configurable:!0}),S=(e,t,r)=>_(e,"symbol"!=typeof t?t+"":t,r),C=function(){return(C=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},y=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},w=(0,p.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=y(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,p.useRef)("_".concat(T()));return b(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},C({ref:t,className:s},o),a)});function b(e,t,r,n,i){return(0,p.createElement)(e.tag,C(C({key:t},R(e,r,i)),n),(E(e,r).children||[]).map(function(n,a){return b(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function R(e,t,r){var n=C({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function E(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?C(C({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?C(C({},e),{attrs:C(C({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function T(){return Math.random().toString(36).substring(2,8)}I(b,"render"),I(R,"replaceRuntimeIdsAndExtInAttrs"),I(E,"replaceRuntimeIdsInDefs"),I(T,"generateShortUuid"),w.displayName="UniverIcon";var M={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"#E5E5E5",d:"M1.6499 3.65002C1.6499 2.54545 2.54533 1.65002 3.6499 1.65002H12.3499C13.4545 1.65002 14.3499 2.54545 14.3499 3.65002V12.35C14.3499 13.4546 13.4545 14.35 12.3499 14.35H3.6499C2.54533 14.35 1.6499 13.4546 1.6499 12.35V3.65002Z"}},{tag:"path",attrs:{fill:"#fff",d:"M9.9998 1.65002H5.9998V6H1.6499V10H5.9998V14.35H9.9998V10H14.3499V6H9.9998V1.65002Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.6498 1.05005C2.21386 1.05005 1.0498 2.21411 1.0498 3.65005V12.35C1.0498 13.786 2.21386 14.95 3.6498 14.95H12.3498C13.7857 14.95 14.9498 13.786 14.9498 12.3501V3.65005C14.9498 2.21411 13.7857 1.05005 12.3498 1.05005H3.6498ZM5.4002 2.25005H3.6498C2.87661 2.25005 2.2498 2.87685 2.2498 3.65005V5.40002H5.4002V2.25005ZM2.2498 10.6V12.35C2.2498 13.1232 2.87661 13.75 3.6498 13.75H5.4002V10.6H2.2498ZM6.60019 13.75H9.4002V9.40002H13.7498V6.60002H9.4002V2.25005H6.60019V6.60002H2.25029V9.40002H6.60019V13.75ZM10.6002 2.25005V5.40002H13.7498V3.65005C13.7498 2.87685 13.123 2.25005 12.3498 2.25005H10.6002ZM13.7498 10.6H10.6002V13.75H12.3498C13.123 13.75 13.7498 13.1232 13.7498 12.3501V10.6Z",fillRule:"evenodd",clipRule:"evenodd"}}]},O=(0,p.forwardRef)(function(e,t){return(0,p.createElement)(w,Object.assign({},e,{id:"cross-highlighting-single",ref:t,icon:M}))});O.displayName="CrossHighlightingSingle";let D=["rgba(158, 109, 227, 0.3)","rgba(254, 75, 75, 0.3)","rgba(255, 140, 81, 0.3)","rgba(164, 220, 22, 0.3)","rgba(45, 174, 255, 0.3)","rgba(58, 96, 247, 0.3)","rgba(242, 72, 166, 0.3)","rgba(153, 153, 153, 0.3)","rgba(158, 109, 227, 0.15)","rgba(254, 75, 75, 0.15)","rgba(255, 140, 81, 0.15)","rgba(164, 220, 22, 0.15)","rgba(45, 174, 255, 0.15)","rgba(58, 96, 247, 0.15)","rgba(242, 72, 166, 0.15)","rgba(153, 153, 153, 0.15)"],U=class extends a.Disposable{constructor(){super(...arguments),S(this,"_enabled$",new l.BehaviorSubject(!1)),S(this,"enabled$",this._enabled$.asObservable()),S(this,"_color$",new l.BehaviorSubject(D[0])),S(this,"color$",this._color$.asObservable())}get enabled(){return this._enabled$.getValue()}get color(){return this._color$.getValue()}dispose(){this._enabled$.complete()}setEnabled(e){this._enabled$.next(e)}setColor(e){this._color$.next(e)}};I(U,"SheetsCrosshairHighlightService");let k={id:"sheet.operation.toggle-crosshair-highlight",type:a.CommandType.OPERATION,handler(e){let t=e.get(U),r=t.enabled;return t.setEnabled(!r),!0}},P={id:"sheet.operation.set-crosshair-highlight-color",type:a.CommandType.OPERATION,handler(e,{value:t}){let r=e.get(U);return r.enabled||r.setEnabled(!0),r.setColor(t),!0}},N={id:"sheet.operation.enable-crosshair-highlight",type:a.CommandType.OPERATION,handler(e){let t=e.get(U);return!t.enabled&&(t.setEnabled(!0),!0)}},x={id:"sheet.operation.disable-crosshair-highlight",type:a.CommandType.OPERATION,handler(e){let t=e.get(U);return!!t.enabled&&(t.setEnabled(!1),!0)}};function A(e){var t,r,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e){if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(r=A(e[t]))&&(n&&(n+=" "),n+=r)}else for(r in e)e[r]&&(n&&(n+=" "),n+=r)}return n}function L(){for(var e,t,r=0,n="",i=arguments.length;r<i;r++)(e=arguments[r])&&(t=A(e))&&(n&&(n+=" "),n+=t);return n}function F(e){let{onChange:r}=e,n=(0,a.useDependency)(U),i=(0,a.useObservable)(n.color$),o=(0,p.useCallback)(e=>{null==r||r(e)},[r]);return /* @__PURE__ *//*@__PURE__*/t(p).createElement("div",{className:"univer-crosshair-highlight-overlay"},D.map(e=>/* @__PURE__ *//*@__PURE__*/t(p).createElement("div",{key:e,className:L("univer-crosshair-highlight-item",{"univer-crosshair-highlight-item-selected":e===i}),style:{backgroundColor:e},onClick:/* @__PURE__ */I(()=>o(e),"onClick")})))}I(A,"r"),I(L,"clsx"),I(F,"CrosshairOverlay");let j="CROSSHAIR_HIGHLIGHT_OVERLAY_COMPONENT";function V(e){let t=e.get(U);return{id:k.id,tooltip:"crosshair.button.tooltip",type:s.MenuItemType.BUTTON_SELECTOR,icon:"CrossHighlightingSingle",selections:[{label:{name:j,hoverable:!1}}],selectionsCommandId:P.id,activated$:t.enabled$,hidden$:(0,s.getMenuHiddenObservable)(e,a.UniverInstanceType.UNIVER_SHEET)}}I(V,"CrosshairHighlightMenuItemFactory");let H={[s.ContextMenuPosition.FOOTER_MENU]:{[s.ContextMenuGroup.OTHERS]:{[k.id]:{order:0,menuItemFactory:V}}}};var $,B=Object.defineProperty,W=Object.getOwnPropertyDescriptor,G=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?W(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&B(t,r,a),a},"__decorateClass$2"),z=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let Y=(I($=class extends a.Disposable{constructor(e,t,r){super(),this._componentMgr=e,this._menuManagerService=t,this._cmdSrv=r,this._initCommands(),this._initMenus(),this._initComponents()}_initCommands(){[k,P,N,x].forEach(e=>this._cmdSrv.registerCommand(e))}_initMenus(){this._menuManagerService.mergeMenu(H)}_initComponents(){this._componentMgr.register(j,F),this._componentMgr.register("CrossHighlightingSingle",O)}},"SheetsCrosshairHighlightController"),$);Y=G([z(0,(0,a.Inject)(s.ComponentManager)),z(1,s.IMenuManagerService),z(2,a.ICommandService)],Y);let K=class{constructor(){S(this,"_selectedRanges",[]),S(this,"_ranges",[])}addRange(e){if(e.rangeType===a.RANGE_TYPE.COLUMN||e.rangeType===a.RANGE_TYPE.ROW||e.rangeType===a.RANGE_TYPE.ALL)return;let t=this._getIntersects(e),r=this._getSplitRanges(e,t);r.length>0&&this._ranges.push(...r)}setSelectedRanges(e){this._selectedRanges=e}_getSplitRanges(e,t){let r=[e];for(let e of t.concat(this._selectedRanges)){let t=[];for(let n of r){let r=(0,a.Rectangle).subtract(n,e);r&&r.length>0&&t.push(...r)}r=t}return r.filter(e=>e.startRow<=e.endRow&&e.startColumn<=e.endColumn)}_getIntersects(e){let t=[];for(let r of this._ranges){let n=(0,a.Rectangle).getIntersects(r,e);n&&t.push(n)}return t}getRanges(){return this._ranges}reset(){this._ranges=[],this._selectedRanges=[]}};I(K,"CrossHairRangeCollection");let q=class extends o.Shape{constructor(e,t){super(e,t),S(this,"_color"),t&&this.setShapeProps(t)}setShapeProps(e){"u">typeof e.color&&(this._color=e.color),this.transformByState({width:e.width,height:e.height})}_draw(e){let t=`rgba(${this._color.r}, ${this._color.g}, ${this._color.b}, ${this._color.a})`;(0,o.Rect).drawWith(e,{width:this.width,height:this.height,fill:t,stroke:void 0,strokeWidth:0,evented:!1})}};I(q,"SheetCrossHairHighlightShape");var X,Q=Object.defineProperty,Z=Object.getOwnPropertyDescriptor,J=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&Q(t,r,a),a},"__decorateClass$1"),ee=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let et=(I(X=class extends a.Disposable{constructor(e,t,r,n,i,a){super(),S(this,"_shapes",[]),S(this,"_rangeCollection",new K),S(this,"_color","rgba(255,0,0,0.5)"),this._context=e,this._sheetSkeletonManagerService=t,this._sheetsSelectionsService=r,this._sheetsCrosshairHighlightService=n,this._contextService=i,this._refSelectionsService=a,this._initRenderListener()}_transformSelection(e,t){if(!e)return;let r=t.getRowCount(),n=t.getColumnCount(),i=[];for(let t of e){let{startRow:e,endRow:a,startColumn:o,endColumn:s}=t.range;a-e+1===r||s-o+1===n||i.push(t.range)}for(let e of(this._rangeCollection.setSelectedRanges(i),i))this.addSelection(e,t)}_initRenderListener(){let e=this._context.unit;this.disposeWithMe((0,d.combineLatest)([this._contextService.subscribeContextValue$(f.DISABLE_NORMAL_SELECTIONS).pipe((0,h.startWith)(!1)),this._sheetSkeletonManagerService.currentSkeleton$,this._sheetsCrosshairHighlightService.enabled$,this._sheetsCrosshairHighlightService.color$.pipe((0,m.tap)(e=>this._color=e)),(0,c.merge)(this._sheetsSelectionsService.selectionMoveStart$,this._sheetsSelectionsService.selectionMoving$,this._sheetsSelectionsService.selectionMoveEnd$,e.activeSheet$.pipe((0,u.map)(()=>this._sheetsSelectionsService.getCurrentSelections()))),(0,c.merge)(this._refSelectionsService.selectionMoveStart$,this._refSelectionsService.selectionMoving$,this._refSelectionsService.selectionMoveEnd$,e.activeSheet$.pipe((0,u.map)(()=>this._refSelectionsService.getCurrentSelections())))]).subscribe(([t,r,n,i,a,o])=>{this._clear(),n&&(this._rangeCollection.reset(),this._transformSelection(t?o:a,e.getActiveSheet()),this.render(this._rangeCollection.getRanges()))}))}addSelection(e,t){if(e.rangeType===a.RANGE_TYPE.COLUMN||e.rangeType===a.RANGE_TYPE.ROW||e.rangeType===a.RANGE_TYPE.ALL)return;let r=t.getRowCount(),n=t.getColumnCount(),{startRow:i,endRow:o,startColumn:s,endColumn:l}=e;for(let e of[{startRow:i,endRow:o,startColumn:0,endColumn:s-1},{startRow:i,endRow:o,startColumn:l+1,endColumn:n},{startRow:0,endRow:i-1,startColumn:s,endColumn:l},{startRow:o+1,endRow:r,startColumn:s,endColumn:l}])e.startRow<=e.endRow&&e.startColumn<=e.endColumn&&this._rangeCollection.addRange(e)}_clear(){this._shapes.forEach(e=>{e.dispose()}),this._shapes=[]}_addShapes(e,t,r,n){let{startRow:i,endRow:o,startColumn:s,endColumn:l}=e,d=(0,g.getCoordByCell)(i,s,r,n),u=(0,g.getCoordByCell)(o,l,r,n),{startX:c,startY:h}=d,{endX:m,endY:p}=u,f=new q(`crosshair-${t}`,{left:c,top:h,color:new(0,a.ColorKit)(this._color).toRgb(),width:m-c,height:p-h,zIndex:1,evented:!1});this._shapes.push(f),r.addObject(f)}render(e){let t=this._sheetSkeletonManagerService.getCurrentSkeleton();if(!t)return;let{scene:r}=this._context;this._clear();for(let n=0;n<e.length;n++){let i=e[n];this._addShapes(i,n,r,t)}r.makeDirty(!0)}async dispose(){super.dispose()}},"SheetCrosshairHighlightRenderController"),X);et=J([ee(1,(0,a.Inject)(g.SheetSkeletonManagerService)),ee(2,(0,a.Inject)(f.SheetsSelectionsService)),ee(3,(0,a.Inject)(U)),ee(4,(0,a.Inject)(a.IContextService)),ee(5,f.IRefSelectionsService)],et);let er={};var en,ei=Object.defineProperty,ea=Object.getOwnPropertyDescriptor,eo=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ea(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ei(t,r,a),a},"__decorateClass"),es=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let el=(I(en=class extends a.Plugin{constructor(e=er,t,r,n){super(),this._config=e,this._injector=t,this._renderManagerService=r,this._configService=n;let{...i}=this._config;this._configService.setConfig("sheets-crosshair-highlight.config",i)}onStarting(){[[U],[Y]].forEach(e=>this._injector.add(e))}onReady(){[[et]].forEach(e=>this._injector.add(e)),this._injector.get(Y),this._renderManagerService.registerRenderModule(a.UniverInstanceType.UNIVER_SHEET,[et])}},"UniverSheetsCrosshairHighlightPlugin"),S(en,"pluginName","SHEET_CROSSHAIR_HIGHLIGHT_PLUGIN"),S(en,"type",a.UniverInstanceType.UNIVER_SHEET),en);eo([es(1,(0,a.Inject)(a.Injector)),es(2,o.IRenderManagerService),es(3,a.IConfigService)],el)}),i("2nZdy",function(r,i){let a;e(r.exports,"WatermarkTextBaseConfig",function(){return b}),e(r.exports,"WatermarkImageBaseConfig",function(){return R}),e(r.exports,"IWatermarkTypeEnum",function(){return M}),e(r.exports,"WatermarkService",function(){return ea});var o,s=n("7yNYd"),l=n("3e0Iz"),d=n("fL2Ug"),u=n("5gqvu"),c=n("1UDbf"),h=n("3yupB"),m=n("1mjSk"),p=n("23cfA"),g=Object.defineProperty,f=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,v=(e,t)=>g(e,"name",{value:t,configurable:!0}),_=(e,t,r)=>f(e,"symbol"!=typeof t?t+"":t,r);let I="UNIVER_WATERMARK_MENU",S="WATERMARK_PANEL",C="WATERMARK_PANEL_FOOTER",y="UNIVER_WATERMARK_STORAGE_KEY",w=["image/png","image/jpeg","image/jpg","image/bmp"],b={content:"",fontSize:16,color:"rgb(0,0,0)",bold:!1,italic:!1,direction:"ltr",x:60,y:36,repeat:!0,spacingX:200,spacingY:100,rotate:0,opacity:.15},R={url:"",width:100,height:100,maintainAspectRatio:!0,originRatio:1,x:60,y:36,repeat:!0,spacingX:200,spacingY:100,rotate:0,opacity:.15},E={name:!0,email:!1,phone:!1,uid:!1,fontSize:16,color:"rgb(0,0,0)",bold:!1,italic:!1,direction:"ltr",x:60,y:60,repeat:!0,spacingX:200,spacingY:100,rotate:-30,opacity:.15},T={type:s.CommandType.OPERATION,id:"univer.operation.open-watermark-panel",handler(e){let t=e.get(d.ISidebarService),r=e.get(s.LocaleService);return t.open({header:{title:r.t("univer-watermark.title")},children:{label:S},footer:{label:C},onClose:/* @__PURE__ */v(()=>{},"onClose"),width:330}),!0}};var M=((a=M||{}).UserInfo="userInfo",a.Text="text",a.Image="image",a),O=function(){return(O=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},D=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},U=(0,u.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=D(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,u.useRef)("_".concat(x()));return k(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},O({ref:t,className:s},o),a)});function k(e,t,r,n,i){return(0,u.createElement)(e.tag,O(O({key:t},P(e,r,i)),n),(N(e,r).children||[]).map(function(n,a){return k(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function P(e,t,r){var n=O({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function N(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?O(O({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?O(O({},e),{attrs:O(O({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function x(){return Math.random().toString(36).substring(2,8)}v(k,"render"),v(P,"replaceRuntimeIdsAndExtInAttrs"),v(N,"replaceRuntimeIdsInDefs"),v(x,"generateShortUuid"),U.displayName="UniverIcon";var A={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.65791 1.30005C3.77355 1.30005 3.05664 2.01696 3.05664 2.90132V12.8588C3.05664 13.8755 3.88086 14.6998 4.89759 14.6998H9.1016C11.2233 14.6998 12.9433 12.9798 12.9433 10.8581C12.9433 9.13925 11.8145 7.68407 10.2578 7.1934C10.8806 6.56856 11.2655 5.70659 11.2655 4.75472C11.2655 2.84676 9.71883 1.30005 7.81087 1.30005H4.65791ZM4.25664 2.90132C4.25664 2.6797 4.4363 2.50005 4.65791 2.50005H7.81087C9.05609 2.50005 10.0655 3.5095 10.0655 4.75472C10.0655 5.99993 9.05609 7.00938 7.81087 7.00938H4.25664V2.90132ZM4.25664 12.8588V8.21636H9.1016C10.5606 8.21636 11.7433 9.39909 11.7433 10.8581C11.7433 12.317 10.5606 13.4998 9.1016 13.4998H4.89759C4.5436 13.4998 4.25664 13.2128 4.25664 12.8588Z",fillRule:"evenodd",clipRule:"evenodd"}}]},L=(0,u.forwardRef)(function(e,t){return(0,u.createElement)(U,Object.assign({},e,{id:"bold-single",ref:t,icon:A}))});L.displayName="BoldSingle";var F={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"mask",attrs:{id:"mask0_102_1198",style:{maskType:"alpha"},width:16,height:16,x:0,y:0,maskUnits:"userSpaceOnUse"},children:[{tag:"path",attrs:{fill:"#DCDCDC",d:"M0 0H16V16H0z"}}]},{tag:"g",attrs:{mask:"url(#mask0_102_1198)"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.68731 9.98425C5.73282 9.87144 5.77827 9.75442 5.82366 9.63323L6.3312 8.27586H9.65859L10.3523 10.1159C10.405 10.284 10.4868 10.4276 10.6023 10.5378C10.74 10.669 10.9119 10.7236 11.1014 10.714C11.3544 10.7131 11.5919 10.6379 11.6996 10.4032L11.7013 10.3992C11.7901 10.1937 11.7749 9.9634 11.6929 9.7289L8.85351 1.86337C8.79546 1.68828 8.6901 1.54881 8.54213 1.45002C8.38836 1.33863 8.1989 1.29112 7.98798 1.29112C7.78272 1.29112 7.59752 1.34014 7.4446 1.45198C7.30481 1.55223 7.20617 1.69184 7.14935 1.86343L4.324 9.70145L4.32281 9.70495C4.27002 9.86052 4.23828 10.0056 4.23828 10.1346C4.23828 10.2646 4.27116 10.3937 4.36281 10.4909C4.50256 10.6468 4.6921 10.714 4.90604 10.714C5.0369 10.714 5.15805 10.6745 5.26156 10.5916C5.3633 10.5247 5.44621 10.4332 5.51101 10.3217C5.57988 10.2177 5.63858 10.1051 5.68731 9.98425ZM6.72105 7.00152L8.00144 3.32827L9.28183 7.00152H6.72105Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"rect",attrs:{width:11.58,height:2.56,x:2.21,y:12.2,fill:"colorChannel1",rx:1.28}}]}]},j=(0,u.forwardRef)(function(e,t){return(0,u.createElement)(U,Object.assign({},e,{id:"font-color",ref:t,icon:F}))});j.displayName="FontColor";var V={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M9.80385 1.40005H11.9997C12.3311 1.40005 12.5997 1.66868 12.5997 2.00005C12.5997 2.33143 12.3311 2.60005 11.9997 2.60005H10.1185L7.12251 13.4001H9.33324C9.66461 13.4001 9.93324 13.6687 9.93324 14.0001C9.93324 14.3314 9.66461 14.6001 9.33324 14.6001H6.34785C6.33847 14.6003 6.32905 14.6003 6.31962 14.6001H3.9999C3.66853 14.6001 3.3999 14.3314 3.3999 14.0001C3.3999 13.6687 3.66853 13.4001 3.9999 13.4001H5.87719L8.87322 2.60005H6.66641C6.33504 2.60005 6.06641 2.33143 6.06641 2.00005C6.06641 1.66868 6.33504 1.40005 6.66641 1.40005H9.52916C9.61698 1.37929 9.71064 1.3781 9.80385 1.40005Z"}}]},H=(0,u.forwardRef)(function(e,t){return(0,u.createElement)(U,Object.assign({},e,{id:"italic-single",ref:t,icon:V}))});H.displayName="ItalicSingle";var $={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.93949 12.3363L1.94048 12.3357 1.95034 12.33C1.95981 12.3245 1.97499 12.3158 1.99548 12.3043 2.0365 12.2813 2.09866 12.2474 2.17888 12.2061 2.33971 12.1234 2.57112 12.0123 2.84885 11.9012 3.41339 11.6754 4.12822 11.4664 4.81552 11.4664 5.82167 11.4664 6.71309 11.8774 7.74399 12.3643 7.7595 12.3717 7.77504 12.379 7.79061 12.3864 8.77119 12.8497 9.88765 13.3772 11.185 13.3772 12.0901 13.3772 12.9676 13.1085 13.5973 12.8566 13.9167 12.7289 14.1829 12.6011 14.3704 12.5047 14.4644 12.4564 14.5391 12.4157 14.5914 12.3864 14.6175 12.3717 14.6381 12.3599 14.6527 12.3514L14.6702 12.3412 14.6755 12.3381 14.6772 12.337 14.6782 12.3365C14.6782 12.3365 14.6784 12.3363 14.3697 11.8218L14.6782 12.3365C14.9623 12.166 15.0547 11.7973 14.8842 11.5131 14.7138 11.2291 14.3454 11.1369 14.0613 11.3071L14.06 11.3079 14.0502 11.3137C14.0407 11.3192 14.0255 11.3279 14.005 11.3394 13.964 11.3623 13.9019 11.3963 13.8216 11.4375 13.6608 11.5202 13.4294 11.6314 13.1517 11.7424 12.5871 11.9683 11.8723 12.1772 11.185 12.1772 10.1788 12.1772 9.28742 11.7663 8.25652 11.2793 8.24101 11.272 8.22547 11.2646 8.2099 11.2573 7.22931 10.7939 6.11286 10.2664 4.81552 10.2664 3.91046 10.2664 3.03292 10.5351 2.40318 10.787 2.08377 10.9148 1.81757 11.0425 1.63007 11.139 1.53613 11.1873 1.46144 11.228 1.40916 11.2573 1.383 11.2719 1.36241 11.2837 1.34778 11.2922L1.33033 11.3024 1.32504 11.3056 1.32327 11.3066 1.32233 11.3072C1.32233 11.3072 1.32209 11.3073 1.63068 11.8217L1.32233 11.3072C1.03818 11.4777.945803 11.8464 1.11629 12.1305 1.28674 12.4146 1.65536 12.5066 1.93949 12.3363zM1.93949 8.51464L1.94048 8.51406 1.95034 8.50829C1.95981 8.50279 1.97499 8.49407 1.99548 8.4826 2.0365 8.45963 2.09866 8.4257 2.17888 8.38443 2.33971 8.30172 2.57112 8.19061 2.84885 8.07952 3.41339 7.85371 4.12822 7.64473 4.81552 7.64473 5.82167 7.64473 6.71309 8.05572 7.74399 8.54267 7.7595 8.54999 7.77504 8.55733 7.79061 8.56469 8.77119 9.02803 9.88765 9.55557 11.185 9.55557 12.0901 9.55557 12.9676 9.28684 13.5973 9.03494 13.9167 8.90718 14.1829 8.77943 14.3704 8.683 14.4644 8.63469 14.5391 8.59398 14.5914 8.5647 14.6175 8.55006 14.6381 8.53825 14.6527 8.52975L14.6702 8.51954 14.6755 8.51641 14.6772 8.51535 14.6782 8.51479C14.6782 8.51479 14.6784 8.51464 14.3697 8.00015L14.6782 8.51479C14.9623 8.3443 15.0547 7.9756 14.8842 7.69145 14.7138 7.4074 14.3454 7.31523 14.0613 7.48547L14.06 7.48623 14.0502 7.492C14.0407 7.4975 14.0255 7.50622 14.005 7.5177 13.964 7.54067 13.9019 7.5746 13.8216 7.61586 13.6608 7.69857 13.4294 7.80968 13.1517 7.92077 12.5871 8.14659 11.8723 8.35557 11.185 8.35557 10.1788 8.35557 9.28742 7.94457 8.25652 7.45762 8.24101 7.4503 8.22547 7.44296 8.2099 7.4356 7.22931 6.97226 6.11286 6.44473 4.81552 6.44473 3.91046 6.44473 3.03292 6.71346 2.40318 6.96535 2.08377 7.09311 1.81757 7.22086 1.63007 7.31729 1.53613 7.3656 1.46144 7.40631 1.40916 7.43559 1.383 7.45024 1.36241 7.46205 1.34778 7.47054L1.33033 7.48075 1.32504 7.48389 1.32327 7.48494 1.32233 7.48551C1.32233 7.48551 1.32209 7.48565 1.63068 7.99997L1.32233 7.48551C1.03818 7.656.945803 8.0247 1.11629 8.30884 1.28674 8.59292 1.65536 8.68496 1.93949 8.51464zM1.93949 4.69296L1.94048 4.69238 1.95034 4.68661C1.95981 4.68111 1.97499 4.67239 1.99548 4.66092 2.0365 4.63795 2.09866 4.60402 2.17888 4.56276 2.33971 4.48004 2.57112 4.36893 2.84885 4.25784 3.41339 4.03203 4.12822 3.82305 4.81552 3.82305 5.82167 3.82305 6.71309 4.23404 7.74399 4.72099 7.7595 4.72831 7.77504 4.73566 7.79061 4.74301 8.77119 5.20635 9.88765 5.73389 11.185 5.73389 12.0901 5.73389 12.9676 5.46516 13.5973 5.21326 13.9167 5.0855 14.1829 4.95775 14.3704 4.86132 14.4644 4.81301 14.5391 4.7723 14.5914 4.74302 14.6175 4.72838 14.6381 4.71657 14.6527 4.70807L14.6702 4.69786 14.6755 4.69473 14.6772 4.69367 14.6782 4.69311C14.6782 4.69311 14.6784 4.69296 14.3697 4.17847L14.6782 4.69311C14.9623 4.52262 15.0547 4.15392 14.8842 3.86977 14.7138 3.58572 14.3454 3.49355 14.0613 3.66379L14.06 3.66455 14.0502 3.67032C14.0407 3.67582 14.0255 3.68454 14.005 3.69602 13.964 3.71899 13.9019 3.75292 13.8216 3.79418 13.6608 3.87689 13.4294 3.988 13.1517 4.09909 12.5871 4.32491 11.8723 4.53389 11.185 4.53389 10.1788 4.53389 9.28742 4.12289 8.25652 3.63594 8.24101 3.62862 8.22547 3.62128 8.2099 3.61392 7.22931 3.15058 6.11286 2.62305 4.81552 2.62305 3.91046 2.62305 3.03292 2.89178 2.40318 3.14367 2.08377 3.27143 1.81757 3.39918 1.63007 3.49561 1.53613 3.54392 1.46144 3.58463 1.40916 3.61391 1.383 3.62856 1.36241 3.64037 1.34778 3.64886L1.33033 3.65907 1.32504 3.66221 1.32327 3.66326 1.32233 3.66383C1.32233 3.66383 1.32209 3.66397 1.63068 4.17829L1.32233 3.66383C1.03818 3.83432.945803 4.20302 1.11629 4.48716 1.28674 4.77124 1.65536 4.86329 1.93949 4.69296z",fillRule:"evenodd",clipRule:"evenodd"}}]},B=(0,u.forwardRef)(function(e,t){return(0,u.createElement)(U,Object.assign({},e,{id:"watermark-single",ref:t,icon:$}))});B.displayName="WatermarkSingle";var W={exports:{}},G={},z=/*@__PURE__*/t(u),Y=Symbol.for("react.element"),K=Symbol.for("react.fragment"),q=Object.prototype.hasOwnProperty,X=z.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,Q={key:!0,ref:!0,__self:!0,__source:!0};function Z(e,t,r){var n,i={},a=null,o=null;for(n in void 0!==r&&(a=""+r),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(o=t.ref),t)q.call(t,n)&&!Q.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:Y,type:e,key:a,ref:o,props:i,_owner:X.current}}v(Z,"q"),G.Fragment=K,G.jsx=Z,G.jsxs=Z,W.exports=G;var J,ee=W.exports,et=Object.defineProperty,er=Object.getOwnPropertyDescriptor,en=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?er(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&et(t,r,a),a},"__decorateClass$3"),ei=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let ea=(v(J=class extends s.Disposable{constructor(e){super(),_(this,"_updateConfig$",new m.Subject),_(this,"updateConfig$",this._updateConfig$.asObservable()),_(this,"_refresh$",new m.Subject),_(this,"refresh$",this._refresh$.asObservable()),this._localStorageService=e}async getWatermarkConfig(){return await this._localStorageService.getItem(y)}updateWatermarkConfig(e){this._localStorageService.setItem(y,e),this._updateConfig$.next(e)}deleteWatermarkConfig(){this._localStorageService.removeItem(y),this._updateConfig$.next(null)}refresh(){this._refresh$.next(Math.random())}dispose(){this._refresh$.complete(),this._updateConfig$.complete()}},"WatermarkService"),J);ea=en([ei(0,(0,s.Inject)(s.ILocalStorageService))],ea);let eo={watermarkPanel:"univer-watermark-panel",watermarkPanelTypeTitle:"univer-watermark-panel-type-title",watermarkPanelTypeSelect:"univer-watermark-panel-type-select",watermarkPanelSetting:"univer-watermark-panel-setting",watermarkPanelFooter:"univer-watermark-panel-footer",watermarkPanelFooterButtonWrapper:"univer-watermark-panel-footer-button-wrapper",watermarkPanelFooterReset:"univer-watermark-panel-footer-reset",watermarkTextSetting:"univer-watermark-text-setting",watermarkTextSettingHeader:"univer-watermark-text-setting-header",watermarkTextSettingFontContent:"univer-watermark-text-setting-font-content",watermarkTextSettingFontStylePart:"univer-watermark-text-setting-font-style-part",watermarkTextSettingLayoutFontWrapper:"univer-watermark-text-setting-layout-font-wrapper",watermarkImageSetting:"univer-watermark-image-setting",watermarkInput:"univer-watermark-input",watermarkInputContent:"univer-watermark-input-content",watermarkIcon:"univer-watermark-icon",watermarkIconWrapper:"univer-watermark-icon-wrapper",watermarkIconWrapperSelect:"univer-watermark-icon-wrapper-select",watermarkColorPickerWrapper:"univer-watermark-color-picker-wrapper"},es=/* @__PURE__ */v(({config:e,onChange:t})=>{let r=(0,s.useDependency)(d.ILocalFileService),n=(0,s.useDependency)(s.LocaleService);if(!e)return null;let i=/* @__PURE__ */v(async()=>{let n=await r.openFile({multiple:!1,accept:w.map(e=>`.${e.replace("image/","")}`).join(",")});if(0===n.length)return!1;let i=n[0],a=new FileReader;a.onload=function(r){var n;if(null!=(n=r.target)&&n.result){let n=r.target.result,i=new Image;i.onload=function(){t({...e,url:n,width:Math.max(20,i.width),height:Math.max(i.height,20),originRatio:i.width/i.height})},i.src=n}},a.readAsDataURL(i)},"handleUpdateImageUrl");return /* @__PURE__ */ee.jsxs("div",{className:eo.watermarkImageSetting,children:[/* @__PURE__ */ee.jsx("div",{className:eo.watermarkTextSettingHeader,children:n.t("univer-watermark.image")}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayout,children:[/* @__PURE__ */ee.jsx("span",{children:n.t("univer-watermark.image")}),/* @__PURE__ */ee.jsx(c.Button,{onClick:i,style:{marginLeft:8},children:e.url?n.t("univer-watermark.replaceImage"):n.t("univer-watermark.uploadImage")}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.opacity")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.opacity,onChange:/* @__PURE__ */v(r=>{null!=r&&t({...e,opacity:Number.parseFloat(r.toString())})},"onChange"),max:1,min:0,step:.05,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.keepRatio")}),/* @__PURE__ */ee.jsx(c.Checkbox,{checked:e.maintainAspectRatio,onChange:/* @__PURE__ */v(r=>{t(!0===r?{...e,maintainAspectRatio:r,height:Math.round(e.width/e.originRatio)}:{...e,maintainAspectRatio:r})},"onChange")})]})]})]}),/* @__PURE__ */ee.jsx("div",{className:eo.watermarkTextSettingLayout,children:/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.width")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.width,onChange:/* @__PURE__ */v(r=>{if(null!=r){let n=Math.max(20,Number.parseInt(r.toString()));e.maintainAspectRatio?t({...e,width:n,height:Math.round(n/e.originRatio)}):t({...e,width:n})}},"onChange"),min:20,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.height")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.height,onChange:/* @__PURE__ */v(r=>{if(null!=r){let n=Math.max(20,Number.parseInt(r.toString()));e.maintainAspectRatio?t({...e,height:n,width:Math.round(n*e.originRatio)}):t({...e,height:Number.parseInt(r.toString())})}},"onChange"),min:20,className:eo.watermarkInput})]})]})}),/* @__PURE__ */ee.jsx("div",{className:eo.watermarkTextSettingHeader,children:n.t("univer-watermark.layout")}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayout,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.rotate")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.rotate,onChange:/* @__PURE__ */v(r=>{null!=r&&t({...e,rotate:Number.parseInt(r.toString())})},"onChange"),max:360,min:-360,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.repeat")}),/* @__PURE__ */ee.jsx(c.Checkbox,{checked:e.repeat,onChange:/* @__PURE__ */v(r=>t({...e,repeat:r}),"onChange")})]})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.spacingX")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.spacingX,onChange:/* @__PURE__ */v(r=>{null!=r&&t({...e,spacingX:Number.parseInt(r.toString())})},"onChange"),min:0,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.spacingY")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.spacingY,onChange:/* @__PURE__ */v(r=>{null!=r&&t({...e,spacingY:Number.parseInt(r.toString())})},"onChange"),min:0,className:eo.watermarkInput})]})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.startX")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.x,onChange:/* @__PURE__ */v(r=>{null!=r&&t({...e,x:Number.parseInt(r.toString())})},"onChange"),min:0,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:n.t("univer-watermark.startY")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:e.y,onChange:/* @__PURE__ */v(r=>{null!=r&&t({...e,y:Number.parseInt(r.toString())})},"onChange"),min:0,className:eo.watermarkInput})]})]})]})]})},"WatermarkImageSetting");function el(e){var t,r,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e){if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(r=el(e[t]))&&(n&&(n+=" "),n+=r)}else for(r in e)e[r]&&(n&&(n+=" "),n+=r)}return n}function ed(){for(var e,t,r=0,n="",i=arguments.length;r<i;r++)(e=arguments[r])&&(t=el(e))&&(n&&(n+=" "),n+=t);return n}v(el,"r"),v(ed,"clsx");let eu=/* @__PURE__ */v(e=>{var t;let{config:r,onChange:n}=e,i=(0,s.useDependency)(s.LocaleService);return r?/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSetting,children:[/* @__PURE__ */ee.jsx("div",{className:eo.watermarkTextSettingHeader,children:i.t("univer-watermark.style")}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontContent,children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.content")}),/* @__PURE__ */ee.jsx(c.Input,{value:r.content,onChange:/* @__PURE__ */v(e=>n({...r,content:e}),"onChange"),className:eo.watermarkInputContent,placeholder:i.t("univer-watermark.textPlaceholder")})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStyle,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.fontSize")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:r.fontSize,onChange:/* @__PURE__ */v(e=>{null!=e&&n({...r,fontSize:Number.parseInt(e.toString())})},"onChange"),max:72,min:12,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{style:{margin:"0 8px"},children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.direction")}),/* @__PURE__ */ee.jsx(c.Select,{value:r.direction,onChange:/* @__PURE__ */v(e=>n({...r,direction:e}),"onChange"),options:[{label:i.t("univer-watermark.ltr"),value:"ltr"},{label:i.t("univer-watermark.rtl"),value:"rtl"}]})]}),/* @__PURE__ */ee.jsxs("div",{children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.opacity")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:r.opacity,onChange:/* @__PURE__ */v(e=>{null!=e&&n({...r,opacity:Number.parseFloat(e.toString())})},"onChange"),max:1,min:0,step:.05,className:eo.watermarkInput})]})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsx("div",{className:eo.watermarkIconWrapper,children:/* @__PURE__ */ee.jsx(c.Dropdown,{overlay:/* @__PURE__ */ee.jsx("div",{className:eo.watermarkColorPickerWrapper,children:/* @__PURE__ */ee.jsx(c.ColorPicker,{color:r.color,onChange:/* @__PURE__ */v(e=>n({...r,color:e}),"onChange")})}),children:/* @__PURE__ */ee.jsx(j,{className:eo.watermarkIcon,extend:{colorChannel1:null!=(t=r.color)?t:"rgb(var(--primary-color))"}})})}),/* @__PURE__ */ee.jsx("div",{className:ed(eo.watermarkIconWrapper,{[eo.watermarkIconWrapperSelect]:r.bold}),onClick:/* @__PURE__ */v(()=>{n({...r,bold:!r.bold})},"onClick"),children:/* @__PURE__ */ee.jsx(L,{className:eo.watermarkIcon})}),/* @__PURE__ */ee.jsx("div",{className:ed(eo.watermarkIconWrapper,{[eo.watermarkIconWrapperSelect]:r.italic}),onClick:/* @__PURE__ */v(()=>{n({...r,italic:!r.italic})},"onClick"),children:/* @__PURE__ */ee.jsx(H,{className:eo.watermarkIcon})})]})]}),/* @__PURE__ */ee.jsx("div",{className:eo.watermarkTextSettingHeader,children:i.t("univer-watermark.layout")}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayout,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.rotate")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:r.rotate,onChange:/* @__PURE__ */v(e=>{null!=e&&n({...r,rotate:Number.parseInt(e.toString())})},"onChange"),max:360,min:-360,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.repeat")}),/* @__PURE__ */ee.jsx(c.Checkbox,{checked:r.repeat,onChange:/* @__PURE__ */v(e=>n({...r,repeat:e}),"onChange")})]})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.spacingX")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:r.spacingX,onChange:/* @__PURE__ */v(e=>{null!=e&&n({...r,spacingX:Number.parseInt(e.toString())})},"onChange"),min:0,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.spacingY")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:r.spacingY,onChange:/* @__PURE__ */v(e=>{null!=e&&n({...r,spacingY:Number.parseInt(e.toString())})},"onChange"),min:0,className:eo.watermarkInput})]})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingFontStylePart,children:[/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.startX")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:r.x,onChange:/* @__PURE__ */v(e=>{null!=e&&n({...r,x:Number.parseInt(e.toString())})},"onChange"),min:0,className:eo.watermarkInput})]}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkTextSettingLayoutFontWrapper,children:[/* @__PURE__ */ee.jsx("div",{children:i.t("univer-watermark.startY")}),/* @__PURE__ */ee.jsx(c.InputNumber,{value:r.y,onChange:/* @__PURE__ */v(e=>{null!=e&&n({...r,y:Number.parseInt(e.toString())})},"onChange"),min:0,className:eo.watermarkInput})]})]})]})]}):null},"WatermarkTextSetting"),ec=/* @__PURE__ */v(()=>{let[e,t]=(0,u.useState)(M.Text),[r,n]=(0,u.useState)(),i=(0,s.useDependency)(ea),a=(0,s.useDependency)(s.ILocalStorageService),o=(0,s.useObservable)(i.refresh$),l=(0,s.useDependency)(s.LocaleService);function d(t,r){n(t),i.updateWatermarkConfig({type:null!=r?r:e,config:t})}v(d,"handleConfigChange");let h=(0,u.useCallback)(async()=>{let e=await a.getItem(y);e?(t(e.type),n(e.config)):n({text:b})},[]);return(0,u.useEffect)(()=>{h()},[o,h]),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkPanel,children:[/* @__PURE__ */ee.jsx("div",{className:eo.watermarkPanelTypeTitle,children:l.t("univer-watermark.type")}),/* @__PURE__ */ee.jsx(c.Select,{value:e,onChange:/* @__PURE__ */v(e=>{t(e),e===M.Text?d({text:b},M.Text):e===M.Image&&d({image:R},M.Image)},"onChange"),options:[{label:l.t("univer-watermark.text"),value:M.Text},{label:l.t("univer-watermark.image"),value:M.Image}],className:eo.watermarkPanelTypeSelect}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkPanelSetting,children:[e===M.Text&&/* @__PURE__ */ee.jsx(eu,{config:null==r?void 0:r.text,onChange:/* @__PURE__ */v(e=>d({text:e}),"onChange")}),e===M.Image&&/* @__PURE__ */ee.jsx(es,{config:null==r?void 0:r.image,onChange:/* @__PURE__ */v(e=>d({image:e}),"onChange")})]})]})},"WatermarkPanel"),eh=/* @__PURE__ */v(()=>{let e=(0,s.useDependency)(d.ISidebarService),t=(0,s.useDependency)(ea),r=(0,s.useDependency)(s.LocaleService),n=(0,s.useDependency)(d.IClipboardInterfaceService);return /* @__PURE__ */ee.jsxs("div",{className:eo.watermarkPanelFooter,children:[/* @__PURE__ */ee.jsx("div",{className:eo.watermarkPanelFooterReset,onClick:/* @__PURE__ */v(()=>{t.updateWatermarkConfig({type:M.Text,config:{text:b}}),t.refresh()},"onClick"),children:r.t("univer-watermark.cancel")}),/* @__PURE__ */ee.jsxs("div",{className:eo.watermarkPanelFooterButtonWrapper,children:[/* @__PURE__ */ee.jsx(c.Button,{style:{marginRight:8},onClick:/* @__PURE__ */v(async()=>{let e;let r=await t.getWatermarkConfig();(null==r?void 0:r.type)===M.Text?e=r.config.text:(null==r?void 0:r.type)===M.Image&&(e=r.config.image),n.writeText(JSON.stringify(e))},"onClick"),children:r.t("univer-watermark.copy")}),/* @__PURE__ */ee.jsx(c.Button,{onClick:/* @__PURE__ */v(async()=>{var r,n;let i=await t.getWatermarkConfig();((null==i?void 0:i.type)!==M.Text||null!=(r=i.config.text)&&r.content)&&((null==i?void 0:i.type)!==M.Image||null!=(n=i.config.image)&&n.url)||t.deleteWatermarkConfig(),e.close()},"onClick"),children:r.t("univer-watermark.close")})]})]})},"WatermarkPanelFooter");function em(e){return{id:T.id,title:"univer-watermark.title",tooltip:"univer-watermark.title",icon:I,type:d.MenuItemType.BUTTON,hidden$:ep(e)}}function ep(e){return e.get(s.IUniverInstanceService).focused$.pipe((0,p.switchMap)(e=>e===s.DOCS_ZEN_EDITOR_UNIT_ID_KEY?(0,h.of)(!0):(0,h.of)(!1)))}v(em,"WatermarkMenuItemFactory"),v(ep,"getWatermarkMenuHiddenObservable");let eg={[d.RibbonStartGroup.OTHERS]:{[T.id]:{order:0,menuItemFactory:em}}};var ef,ev=Object.defineProperty,e_=Object.getOwnPropertyDescriptor,eI=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e_(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ev(t,r,a),a},"__decorateClass$2"),eS=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let eC=(v(ef=class extends s.Disposable{constructor(e,t){super(),this._menuManagerService=e,this._componentManager=t,this._initMenu(),this._initComponents()}_initComponents(){[[I,B],[S,ec],[C,eh]].forEach(([e,t])=>{this.disposeWithMe(this._componentManager.register(e,t))})}_initMenu(){this._menuManagerService.mergeMenu(eg)}},"UniverWatermarkMenuController"),ef);function ey(e,t,r,n){let i=t.type,a=t.config;i===M.UserInfo&&a.userInfo?ew(e,a.userInfo,n):i===M.Image&&a.image?eR(e,a.image,r):i===M.Text&&a.text&&eb(e,a.text)}function ew(e,t,r){let{x:n,y:i,repeat:a,spacingX:o,spacingY:s,rotate:l,opacity:d,name:u,fontSize:c,color:h,bold:m,italic:p,direction:g}=t;if(!r)return;let f="";if(u&&(f+=`${r.name} `),!f)return;e.save(),e.globalAlpha=d,e.direction=g;let v="";if(p&&(v+="italic "),m&&(v+="bold "),v+=`${c}px Arial`,e.font=v,e.fillStyle=h,a){let t=e.canvas.width,r=e.canvas.height;for(let a=i;a<r;a+=c+s)for(let r=n;r<t;r+=e.measureText(f).width+o)e.save(),e.translate(r,a),e.rotate(Math.PI/180*l),e.fillText(f,0,0),e.restore()}else e.save(),e.translate(n,i),e.rotate(Math.PI/180*l),e.fillText(f,0,0),e.restore();e.restore()}function eb(e,t){let{x:r,y:n,repeat:i,spacingX:a,spacingY:o,rotate:s,opacity:l,content:d,fontSize:u,color:c,bold:h,italic:m,direction:p}=t;e.save(),e.globalAlpha=l,e.direction=p;let g="";if(m&&(g+="italic "),h&&(g+="bold "),g+=`${u}px Arial`,e.font=g,e.fillStyle=c,d){if(i){let t=e.canvas.width,i=e.canvas.height;for(let l=n;l<i;l+=u+o)for(let n=r;n<t;n+=e.measureText(d).width+a)e.save(),e.translate(n,l),e.rotate(Math.PI/180*s),e.fillText(d,0,0),e.restore()}else e.save(),e.translate(r,n),e.rotate(Math.PI/180*s),e.fillText(d,0,0),e.restore()}e.restore()}function eR(e,t,r){let{x:n,y:i,repeat:a,spacingX:o,spacingY:s,rotate:l,opacity:d,width:u,height:c,maintainAspectRatio:h,originRatio:m}=t;if(!(null!=r&&r.complete))return;e.save(),e.globalAlpha=d;let p=h?u/m:c;if(a){let t=e.canvas.width,a=e.canvas.height;for(let d=i;d<a;d+=p+s)for(let i=n;i<t;i+=u+o)e.save(),e.translate(i,d),e.rotate(Math.PI/180*l),e.drawImage(r,0,0,u,p),e.restore()}else e.save(),e.translate(n,i),e.rotate(Math.PI/180*l),e.drawImage(r,0,0,u,p),e.restore();e.restore()}eC=eI([eS(0,d.IMenuManagerService),eS(1,(0,s.Inject)(d.ComponentManager))],eC),v(ey,"renderWatermark"),v(ew,"renderUserInfoWatermark"),v(eb,"renderTextWatermark"),v(eR,"renderImageWatermark");let eE=class extends l.Layer{constructor(){super(...arguments),_(this,"_config"),_(this,"_image"),_(this,"_user")}render(e,t=!1){var r;super.render(e,t);let n=e||(null==(r=this.scene.getEngine())?void 0:r.getCanvas().getContext());return n&&n.getId()&&this._renderWatermark(n),this}updateConfig(e,t){var r;this._config=e,(null==(r=this._config)?void 0:r.type)===M.Image&&this._config.config.image&&(this._image=new Image,this._image.src=this._config.config.image.url),t&&(this._user=t)}_renderWatermark(e){this._config&&ey(e,this._config,this._image,this._user)}};v(eE,"WatermarkLayer");var eT,eM=Object.defineProperty,eO=Object.getOwnPropertyDescriptor,eD=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eO(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eM(t,r,a),a},"__decorateClass$1"),eU=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let ek=(v(eT=class extends s.RxDisposable{constructor(e,t,r,n){super(),_(this,"_watermarkLayer"),this._context=e,this._watermarkService=t,this._localStorageService=r,this._userManagerService=n,this._watermarkLayer=new eE(e.scene,[],10),this._initAddRender(),this._initWatermarkUpdate(),this._initWatermarkConfig()}_initAddRender(){let{scene:e}=this._context;e.addLayer(this._watermarkLayer)}async _initWatermarkConfig(){var e;let t=await this._localStorageService.getItem(y);t&&(this._watermarkService.updateWatermarkConfig(t),null==(e=this._context.mainComponent)||e.makeDirty())}_initWatermarkUpdate(){this.disposeWithMe(this._watermarkService.updateConfig$.subscribe(e=>{var t,r;if(!e){this._watermarkLayer.updateConfig(),null==(t=this._context.mainComponent)||t.makeDirty();return}e.type===M.UserInfo?this._watermarkLayer.updateConfig(e,this._userManagerService.getCurrentUser()):this._watermarkLayer.updateConfig(e),null==(r=this._context.mainComponent)||r.makeDirty()}))}},"WatermarkRenderController"),eT);ek=eD([eU(1,(0,s.Inject)(ea)),eU(2,(0,s.Inject)(s.ILocalStorageService)),eU(3,(0,s.Inject)(s.UserManagerService))],ek);var eP=Object.defineProperty,eN=Object.getOwnPropertyDescriptor,ex=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eN(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eP(t,r,a),a},"__decorateClass"),eA=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let eL=(v(o=class extends s.Plugin{constructor(e={},t,r,n,i,a){super(),this._config=e,this._injector=t,this._configService=r,this._commandService=n,this._renderManagerSrv=i,this._localStorageService=a;let{menu:o}=this._config;o&&this._configService.setConfig("menu",o,{merge:!0}),this._initWatermarkStorage(),this._initDependencies(),this._initRegisterCommand()}async _initWatermarkStorage(){let{menu:e,...t}=this._config;if(t.userWatermarkSettings)this._localStorageService.setItem(y,{type:M.UserInfo,config:{userInfo:{...E,...t.userWatermarkSettings}}});else if(t.textWatermarkSettings)this._localStorageService.setItem(y,{type:M.Text,config:{text:{...b,...t.textWatermarkSettings}}});else if(t.imageWatermarkSettings)this._localStorageService.setItem(y,{type:M.Image,config:{image:{...R,...t.imageWatermarkSettings}}});else{let e=await this._localStorageService.getItem(y);(null==e?void 0:e.type)===M.UserInfo&&this._localStorageService.removeItem(y)}}_initDependencies(){[[ea],[eC]].forEach(e=>{this._injector.add(e)})}_initRegisterCommand(){[T].forEach(e=>this._commandService.registerCommand(e))}onRendered(){let e=this._injector;e.get(ea);let{userWatermarkSettings:t,textWatermarkSettings:r,imageWatermarkSettings:n,showMenu:i=!0}=this._config;!(t||r||n)&&i&&e.get(eC),this._initRenderDependencies()}_initRenderDependencies(){[[ek]].forEach(e=>{this._renderManagerSrv.registerRenderModule(s.UniverInstanceType.UNIVER_SHEET,e),this._renderManagerSrv.registerRenderModule(s.UniverInstanceType.UNIVER_DOC,e)})}},"UniverWatermarkPlugin"),_(o,"pluginName","UNIVER_WATERMARK_PLUGIN"),o);ex([eA(1,(0,s.Inject)(s.Injector)),eA(2,s.IConfigService),eA(3,(0,s.Inject)(s.ICommandService)),eA(4,l.IRenderManagerService),eA(5,(0,s.Inject)(s.ILocalStorageService))],eL)}),i("7kbBA",function(t,r){let i,a;e(t.exports,"getRuleSetting",function(){return v}),e(t.exports,"getRuleOptions",function(){return _}),e(t.exports,"UpdateRuleType",function(){return S}),e(t.exports,"DataValidationModel",function(){return R}),e(t.exports,"DataValidatorRegistryService",function(){return P}),e(t.exports,"AddDataValidationMutation",function(){return N}),e(t.exports,"RemoveDataValidationMutation",function(){return x}),e(t.exports,"UpdateDataValidationMutation",function(){return A}),e(t.exports,"UniverDataValidationPlugin",function(){return Y}),e(t.exports,"TextLengthErrorTitleMap",function(){return X}),e(t.exports,"BaseDataValidator",function(){return ei});var o,s,l,d=n("7yNYd"),u=n("5LPkb"),c=n("bXJOC"),h=n("1mjSk"),m=Object.defineProperty,p=(e,t,r)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,g=(e,t)=>m(e,"name",{value:t,configurable:!0}),f=(e,t,r)=>p(e,"symbol"!=typeof t?t+"":t,r);function v(e){return{type:e.type,operator:e.operator,formula1:e.formula1,formula2:e.formula2,allowBlank:e.allowBlank}}function _(e){return{error:e.error,errorStyle:e.errorStyle,errorTitle:e.errorTitle,imeMode:e.imeMode,prompt:e.prompt,promptTitle:e.promptTitle,showDropDown:e.showDropDown,showErrorMessage:e.showErrorMessage,showInputMessage:e.showInputMessage,renderMode:e.renderMode,bizInfo:e.bizInfo}}g(v,"getRuleSetting"),g(_,"getRuleOptions");var I,S=((i=S||{})[i.SETTING=0]="SETTING",i[i.RANGE=1]="RANGE",i[i.OPTIONS=2]="OPTIONS",i),C=Object.defineProperty,y=Object.getOwnPropertyDescriptor,w=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?y(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&C(t,r,a),a},"__decorateClass$3"),b=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let R=(I=class extends d.Disposable{constructor(e){super(),f(this,"_model",/* @__PURE__ */new Map),f(this,"_ruleChange$",new h.Subject),f(this,"ruleChange$",this._ruleChange$.asObservable()),f(this,"ruleChangeDebounce$",this.ruleChange$.pipe((0,c.debounceTime)(20))),this._logService=e,this.disposeWithMe({dispose:/* @__PURE__ */g(()=>{this._ruleChange$.complete()},"dispose")})}_ensureMap(e,t){this._model.has(e)||this._model.set(e,/* @__PURE__ */new Map);let r=this._model.get(e);if(r.has(t))return r.get(t);let n={map:/* @__PURE__ */new Map,list:[]};return r.set(t,n),n}_addSubUnitRule(e,t,r){let{map:n,list:i}=e,a=(Array.isArray(t)?t:[t]).filter(e=>!n.has(e.uid));"number"==typeof r&&r<i.length?i.splice(r,0,...a):i.push(...a),a.forEach(e=>{n.set(e.uid,e)})}_removeSubUnitRule(e,t){let{map:r,list:n}=e,i=n.findIndex(e=>e.uid===t);i>-1&&(n.splice(i,1),r.delete(t))}_updateSubUnitRule(e,t,r){let{map:n,list:i}=e,a=n.get(t),o=i.findIndex(e=>t===e.uid);if(!a)throw Error(`Data validation rule is not found, ruleId: ${t}.`);let s={...a};switch(r.type){case S.RANGE:s.ranges=r.payload;break;case S.SETTING:Object.assign(s,v(r.payload));break;case S.OPTIONS:Object.assign(s,_(r.payload))}return i[o]=s,n.set(t,s),s}_addRuleSideEffect(e,t,r,n){if(!this._ensureMap(e,t).map.get(r.uid))return{rule:r,type:"add",unitId:e,subUnitId:t,source:n}}addRule(e,t,r,n,i){try{let a=this._ensureMap(e,t),o=(Array.isArray(r)?r:[r]).map(r=>this._addRuleSideEffect(e,t,r,n));this._addSubUnitRule(a,r,i),o.forEach(e=>{e&&this._ruleChange$.next(e)})}catch(e){this._logService.error(e)}}updateRule(e,t,r,n,i){try{let a=this._ensureMap(e,t),o=(0,d.Tools).deepClone(a.map.get(r));if(!o)throw Error(`Data validation rule is not found, ruleId: ${r}.`);let s=this._updateSubUnitRule(a,r,n);this._ruleChange$.next({rule:s,type:"update",unitId:e,subUnitId:t,source:i,updatePayload:n,oldRule:o})}catch(e){this._logService.error(e)}}removeRule(e,t,r,n){try{let i=this._ensureMap(e,t),a=i.map.get(r);a&&(this._removeSubUnitRule(i,r),this._ruleChange$.next({rule:a,type:"remove",unitId:e,subUnitId:t,source:n}))}catch(e){this._logService.error(e)}}getRuleById(e,t,r){return this._ensureMap(e,t).map.get(r)}getRuleIndex(e,t,r){return this._ensureMap(e,t).list.findIndex(e=>e.uid===r)}getRules(e,t){return[...this._ensureMap(e,t).list]}getUnitRules(e){let t=this._model.get(e);if(!t)return[];let r=[];return t.forEach((e,t)=>{r.push([t,e.list])}),r}deleteUnitRules(e){this._model.delete(e)}getSubUnitIds(e){var t,r;return Array.from(null!=(r=null==(t=this._model.get(e))?void 0:t.keys())?r:[])}getAll(){return Array.from(this._model.keys()).map(e=>[e,this.getUnitRules(e)])}},g(I,"DataValidationModel"),I);R=w([b(0,d.ILogService)],R);var E=Object.defineProperty,T=Object.getOwnPropertyDescriptor,M=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?T(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&E(t,r,a),a},"__decorateClass$2"),O=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let D=(o=class extends d.Disposable{constructor(e,t,r){super(),this._resourceManagerService=e,this._univerInstanceService=t,this._dataValidationModel=r,this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */g(e=>{let t=this._dataValidationModel.getUnitRules(e),r={};return t?(t.forEach(([e,t])=>{r[e]=t}),JSON.stringify(r)):""},"toJson"),t=/* @__PURE__ */g(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:"SHEET_DATA_VALIDATION_PLUGIN",businesses:[d.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */g(t=>e(t),"toJson"),parseJson:/* @__PURE__ */g(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */g(e=>{this._dataValidationModel.deleteUnitRules(e)},"onUnLoad"),onLoad:/* @__PURE__ */g((e,t)=>{Object.keys(t).forEach(r=>{t[r].forEach(t=>{this._dataValidationModel.addRule(e,r,t,"patched")})})},"onLoad")}))}},g(o,"DataValidationResourceController"),o);D=M([O(0,d.IResourceManagerService),O(1,d.IUniverInstanceService),O(2,(0,d.Inject)(R))],D);var U=((a=U||{}).SHEET="sheet",a);let k=class{constructor(){f(this,"_validatorByScopes",/* @__PURE__ */new Map),f(this,"_validatorMap",/* @__PURE__ */new Map),f(this,"_validatorsChange$",new u.BehaviorSubject(void 0)),f(this,"validatorsChange$",this._validatorsChange$.asObservable())}_addValidatorToScope(e,t){this._validatorByScopes.has(t)||this._validatorByScopes.set(t,[]);let r=this._validatorByScopes.get(t);if(r.findIndex(t=>t.id===e.id)>-1)throw Error(`Validator item with the same id ${e.id} has already been added!`);r.push(e)}_removeValidatorFromScope(e,t){let r=this._validatorByScopes.get(t);if(!r)return;let n=r.findIndex(t=>t.id===e.id);n>-1&&r.splice(n,1)}register(e){return this._validatorMap.set(e.id,e),Array.isArray(e.scopes)?e.scopes.forEach(t=>{this._addValidatorToScope(e,t)}):this._addValidatorToScope(e,e.scopes),this._validatorsChange$.next(),(0,d.toDisposable)(()=>{this._validatorMap.delete(e.id),Array.isArray(e.scopes)?e.scopes.forEach(t=>{this._removeValidatorFromScope(e,t)}):this._removeValidatorFromScope(e,e.scopes),this._validatorsChange$.next()})}getValidatorItem(e){return this._validatorMap.get(e)}getValidatorsByScope(e){return this._validatorByScopes.get(e)}};g(k,"DataValidatorRegistryService");let P=k,N={type:d.CommandType.MUTATION,id:"data-validation.mutation.addRule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,rule:i,index:a,source:o="command"}=t;return e.get(R).addRule(r,n,i,o,a),!0}},x={type:d.CommandType.MUTATION,id:"data-validation.mutation.removeRule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ruleId:i,source:a="command"}=t,o=e.get(R);return Array.isArray(i)?i.forEach(e=>{o.removeRule(r,n,e,a)}):o.removeRule(r,n,i,a),!0}},A={type:d.CommandType.MUTATION,id:"data-validation.mutation.updateRule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ruleId:i,payload:a,source:o="command"}=t;return e.get(R).updateRule(r,n,i,a,o),!0}},L={type:d.CommandType.COMMAND,id:"data-validation.command.addRule",async handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `AddDataValidationCommand` is deprecated, please use `AddSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let{rule:r,unitId:n,subUnitId:i}=t,a=e.get(d.ICommandService),o=e.get(d.IUndoRedoService),s={...t,rule:{...t.rule,ranges:[t.rule.range]}},l=[{id:N.id,params:s}],u=[{id:x.id,params:{unitId:n,subUnitId:i,ruleId:r.uid}}];return o.pushUndoRedo({unitID:n,redoMutations:l,undoMutations:u}),await a.executeCommand(N.id,s),!0}},F={type:d.CommandType.COMMAND,id:"data-validation.command.removeRule",handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `RemoveDataValidationCommand` is deprecated, please use `RemoveSheetDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let{unitId:r,subUnitId:n,ruleId:i}=t,a=e.get(d.ICommandService),o=e.get(d.IUndoRedoService),s=e.get(R),l=[{id:x.id,params:t}],u=[{id:N.id,params:{unitId:r,subUnitId:n,rule:{...s.getRuleById(r,n,i)},index:s.getRuleIndex(r,n,i)}}];return o.pushUndoRedo({undoMutations:u,redoMutations:l,unitID:t.unitId}),a.executeCommand(x.id,t),!0}},j={type:d.CommandType.COMMAND,id:"data-validation.command.updateDataValidationSetting",handler(e,t){if(e.get(d.ILogService).warn("[Deprecated]: `UpdateDataValidationOptionsCommand` is deprecated, please use `UpdateSheetDataValidationOptionsCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let r=e.get(d.ICommandService),n=e.get(d.IUndoRedoService),i=e.get(R),{unitId:a,subUnitId:o,ruleId:s,options:l}=t,u=i.getRuleById(a,o,s);if(!u)return!1;let c={unitId:a,subUnitId:o,ruleId:s,payload:{type:S.OPTIONS,payload:l}},h=[{id:A.id,params:c}],m={unitId:a,subUnitId:o,ruleId:s,payload:{type:S.OPTIONS,payload:_(u)}},p=[{id:A.id,params:m}];return n.pushUndoRedo({unitID:a,redoMutations:h,undoMutations:p}),r.executeCommand(A.id,c),!0}},V={type:d.CommandType.COMMAND,id:"data-validation.command.updateDataValidationOptions",handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `UpdateDataValidationSettingCommand` is deprecated, please use `UpdateSheetDataValidationSettingCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let r=e.get(d.ICommandService),n=e.get(d.IUndoRedoService),i=e.get(R),a=e.get(P),{unitId:o,subUnitId:s,ruleId:l,setting:u}=t,c=a.getValidatorItem(u.type);if(!c)return!1;let h=i.getRuleById(o,s,l);if(!h)return!1;let m={...h,...u};if(!c.validatorFormula(m,o,s).success)return!1;let p={unitId:o,subUnitId:s,ruleId:l,payload:{type:S.SETTING,payload:{...u,...c.normalizeFormula(m,o,s)}}},g=[{id:A.id,params:p}],f={unitId:o,subUnitId:s,ruleId:l,payload:{type:S.SETTING,payload:v(h)}},_=[{id:A.id,params:f}];return n.pushUndoRedo({unitID:o,redoMutations:g,undoMutations:_}),r.executeCommand(A.id,p),!0}},H={type:d.CommandType.COMMAND,id:"data-validation.command.removeAll",handler(e,t){if(e.get(d.ILogService).error("[Deprecated]: `RemoveAllDataValidationCommand` is deprecated, please use `RemoveSheetAllDataValidationCommand` in `@univerjs/sheets-data-validation` instead!"),!t)return!1;let{unitId:r,subUnitId:n}=t,i=e.get(d.ICommandService),a=e.get(R),o=e.get(d.IUndoRedoService),s=[...a.getRules(r,n)],l={unitId:r,subUnitId:n,ruleId:s.map(e=>e.uid)},u=[{id:x.id,params:l}],c=[{id:N.id,params:{unitId:r,subUnitId:n,rule:s}}];return o.pushUndoRedo({redoMutations:u,undoMutations:c,unitID:r}),i.executeCommand(x.id,l),!0}},$={};var B=Object.defineProperty,W=Object.getOwnPropertyDescriptor,G=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?W(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&B(t,r,a),a},"__decorateClass$1"),z=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let Y=(g(s=class extends d.Plugin{constructor(e=$,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{...i}=this._config;this._configService.setConfig("data-validation.config",i)}onStarting(){[[R],[P],[D]].forEach(e=>this._injector.add(e)),[L,H,j,V,F,N,A,x].forEach(e=>{this._commandService.registerCommand(e)})}onReady(){this._injector.get(D)}},"UniverDataValidationPlugin"),f(s,"pluginName","UNIVER_DATA_VALIDATION_PLUGIN"),f(s,"type",d.UniverInstanceType.UNIVER_SHEET),s);Y=G([z(1,(0,d.Inject)(d.Injector)),z(2,d.ICommandService),z(3,d.IConfigService)],Y),d.DataValidationOperator.BETWEEN,d.DataValidationOperator.EQUAL,d.DataValidationOperator.GREATER_THAN,d.DataValidationOperator.GREATER_THAN_OR_EQUAL,d.DataValidationOperator.LESS_THAN,d.DataValidationOperator.LESS_THAN_OR_EQUAL,d.DataValidationOperator.NOT_BETWEEN,d.DataValidationOperator.NOT_EQUAL;let K={[d.DataValidationOperator.BETWEEN]:"dataValidation.ruleName.between",[d.DataValidationOperator.EQUAL]:"dataValidation.ruleName.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.ruleName.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.ruleName.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.ruleName.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.ruleName.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.ruleName.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.ruleName.notEqual"},q={[d.DataValidationOperator.BETWEEN]:"dataValidation.errorMsg.between",[d.DataValidationOperator.EQUAL]:"dataValidation.errorMsg.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.errorMsg.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.errorMsg.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.errorMsg.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.errorMsg.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.errorMsg.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.errorMsg.notEqual"},X={[d.DataValidationOperator.BETWEEN]:"dataValidation.textLength.errorMsg.between",[d.DataValidationOperator.EQUAL]:"dataValidation.textLength.errorMsg.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.textLength.errorMsg.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.textLength.errorMsg.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.textLength.errorMsg.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.textLength.errorMsg.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.textLength.errorMsg.notEqual"};d.DataValidationOperator.BETWEEN,d.DataValidationOperator.NOT_BETWEEN;var Q=Object.defineProperty,Z=Object.getOwnPropertyDescriptor,J=/* @__PURE__ */g((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&Q(t,r,a),a},"__decorateClass"),ee=/* @__PURE__ */g((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let et="{FORMULA1}",er="{FORMULA2}",en={[d.DataValidationOperator.BETWEEN]:"dataValidation.operators.between",[d.DataValidationOperator.EQUAL]:"dataValidation.operators.equal",[d.DataValidationOperator.GREATER_THAN]:"dataValidation.operators.greaterThan",[d.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.operators.greaterThanOrEqual",[d.DataValidationOperator.LESS_THAN]:"dataValidation.operators.lessThan",[d.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.operators.lessThanOrEqual",[d.DataValidationOperator.NOT_BETWEEN]:"dataValidation.operators.notBetween",[d.DataValidationOperator.NOT_EQUAL]:"dataValidation.operators.notEqual"},ei=(g(l=class{constructor(e,t){f(this,"formulaInput"),f(this,"canvasRender",null),f(this,"dropdown"),f(this,"optionsInput"),f(this,"skipDefaultFontRender"),this.localeService=e,this.injector=t}get operatorNames(){return this.operators.map(e=>this.localeService.t(en[e]))}get titleStr(){return this.localeService.t(this.title)}generateRuleName(e){var t,r;if(!e.operator)return this.titleStr;let n=this.localeService.t(K[e.operator]).replace(et,null!=(t=e.formula1)?t:"").replace(er,null!=(r=e.formula2)?r:"");return`${this.titleStr} ${n}`}generateRuleErrorMessage(e){var t,r;return e.operator?`${this.localeService.t(q[e.operator]).replace(et,null!=(t=e.formula1)?t:"").replace(er,null!=(r=e.formula2)?r:"")}`:this.titleStr}getExtraStyle(e,t,r){}getRuleFinalError(e){return e.showErrorMessage&&e.error?e.error:this.generateRuleErrorMessage(e)}isEmptyCellValue(e){return""===e||null==e}normalizeFormula(e,t,r){return{formula1:e.formula1,formula2:e.formula2}}async isValidType(e,t,r){return!0}transform(e,t,r){return e}async validatorIsEqual(e,t,r){return!0}async validatorIsNotEqual(e,t,r){return!0}async validatorIsBetween(e,t,r){return!0}async validatorIsNotBetween(e,t,r){return!0}async validatorIsGreaterThan(e,t,r){return!0}async validatorIsGreaterThanOrEqual(e,t,r){return!0}async validatorIsLessThan(e,t,r){return!0}async validatorIsLessThanOrEqual(e,t,r){return!0}async validator(e,t){let{value:r,unitId:n,subUnitId:i}=e,a=this.isEmptyCellValue(r),{allowBlank:o=!0,operator:s}=t;if(a)return o;let l=await this.parseFormula(t,n,i);if(!l.isFormulaValid||!await this.isValidType(e,l,t))return!1;if(!(0,d.Tools).isDefine(s))return!0;let u=this.transform(e,l,t);switch(s){case d.DataValidationOperator.BETWEEN:return this.validatorIsBetween(u,l,t);case d.DataValidationOperator.EQUAL:return this.validatorIsEqual(u,l,t);case d.DataValidationOperator.GREATER_THAN:return this.validatorIsGreaterThan(u,l,t);case d.DataValidationOperator.GREATER_THAN_OR_EQUAL:return this.validatorIsGreaterThanOrEqual(u,l,t);case d.DataValidationOperator.LESS_THAN:return this.validatorIsLessThan(u,l,t);case d.DataValidationOperator.LESS_THAN_OR_EQUAL:return this.validatorIsLessThanOrEqual(u,l,t);case d.DataValidationOperator.NOT_BETWEEN:return this.validatorIsNotBetween(u,l,t);case d.DataValidationOperator.NOT_EQUAL:return this.validatorIsNotEqual(u,l,t);default:throw Error("Unknown operator.")}}},"BaseDataValidator"),l);ei=J([ee(0,(0,d.Inject)(d.LocaleService)),ee(1,(0,d.Inject)(d.Injector))],ei)}),i("ca7WX",function(t,i){let a;e(t.exports,"SheetDataValidationModel",function(){return q}),e(t.exports,"UpdateSheetDataValidationRangeCommand",function(){return eR}),e(t.exports,"AddSheetDataValidationCommand",function(){return eE}),e(t.exports,"UpdateSheetDataValidationSettingCommand",function(){return eT}),e(t.exports,"UpdateSheetDataValidationOptionsCommand",function(){return eM}),e(t.exports,"ClearRangeDataValidationCommand",function(){return eO}),e(t.exports,"RemoveSheetAllDataValidationCommand",function(){return eD}),e(t.exports,"RemoveSheetDataValidationCommand",function(){return ek}),e(t.exports,"SheetsDataValidationValidatorService",function(){return ta});var o,s=n("7yNYd"),l=n("7kbBA"),d=n("ejawP"),u=n("kRhbk"),c=n("lMvMU"),h=n("1mjSk"),m=n("86b1c"),p=n("bRzks"),g=Object.defineProperty,f=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,v=(e,t)=>g(e,"name",{value:t,configurable:!0}),_=(e,t,r)=>f(e,"symbol"!=typeof t?t+"":t,r),I=Object.defineProperty,S=Object.getOwnPropertyDescriptor,C=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?S(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&I(t,r,a),a},"__decorateClass$9"),y=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let w=(v(o=class extends s.Disposable{constructor(e){super(),_(this,"_cacheMatrix",/* @__PURE__ */new Map),_(this,"_dirtyRanges$",new h.Subject),_(this,"dirtyRanges$",this._dirtyRanges$.asObservable()),this._commandService=e,this._initDirtyRanges()}_initDirtyRanges(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===d.SetRangeValuesMutation.id){let{cellValue:t,unitId:r,subUnitId:n}=e.params;if(t){let e=new(0,s.ObjectMatrix)(t).getDataRange();if(-1===e.endRow)return;this._dirtyRanges$.next({unitId:r,subUnitId:n,ranges:[e]})}}}))}_ensureCache(e,t){let r=this._cacheMatrix.get(e);r||(r=/* @__PURE__ */new Map,this._cacheMatrix.set(e,r));let n=r.get(t);return n||(n=new s.ObjectMatrix,r.set(t,n)),n}ensureCache(e,t){return this._ensureCache(e,t)}addRule(e,t,r){this.markRangeDirty(e,t,r.ranges)}removeRule(e,t,r){this._deleteRange(e,t,r.ranges)}updateRuleRanges(e,t,r,n,i){let a=this._ensureCache(e,t);i.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let r=a.getValue(e,t);r&&(r.temp=!0)})}),n.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=a.getValue(e,t);n&&n.ruleId===r?n.temp=!1:a.setValue(e,t,void 0)})}),i.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let r=a.getValue(e,t);r&&!0===r.temp&&a.realDeleteValue(e,t)})}),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:[...i,...n]})}markRangeDirty(e,t,r){let n=this._ensureCache(e,t);r.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{n.setValue(e,t,void 0)})}),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:r})}markCellDirty(e,t,r,n){this._ensureCache(e,t).setValue(r,n,void 0),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:[{startRow:r,startColumn:n,endRow:r,endColumn:n}]})}_deleteRange(e,t,r){let n=this._ensureCache(e,t);r.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{n.realDeleteValue(e,t)})}),this._dirtyRanges$.next({unitId:e,subUnitId:t,ranges:r})}getValue(e,t,r,n){return this._ensureCache(e,t).getValue(r,n)}setValue(e,t,r,n,i){return this._ensureCache(e,t).setValue(r,n,i)}},"DataValidationCacheService"),o);w=C([y(0,(0,s.Inject)(s.ICommandService))],w);var b=Object.defineProperty,R=Object.getOwnPropertyDescriptor,E=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?R(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&b(t,r,a),a},"__decorateClass$8"),T=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");function M(e,t,r,n,i,a){return e.moveFormulaRefOffset(t,a-n,i-r)}v(M,"transformFormula");let O=(v(D=class extends s.Disposable{constructor(e,t,r,n,i,a){super(),_(this,"_formulaMap",/* @__PURE__ */new Map),_(this,"_ruleFormulaMap",/* @__PURE__ */new Map),_(this,"_formulaCellMap",/* @__PURE__ */new Map),this._instanceSrv=e,this._registerOtherFormulaService=t,this._lexerTreeBuilder=r,this._dataValidationModel=n,this._dataValidationCacheService=i,this._injector=a,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(let t in e){let r=e[t];if(this._instanceSrv.getUnitType(t)===s.UniverInstanceType.UNIVER_SHEET)for(let e in r){let n=r[e],{formulaCellMap:i,ruleFormulaMap:a}=this._ensureMaps(t,e);n.forEach(r=>{var n,o;let s=a.get(null==(n=r.extra)?void 0:n.ruleId),l=i.get(r.formulaId),d=this._dataValidationModel.getRuleById(t,e,null==(o=r.extra)?void 0:o.ruleId);d&&s&&!s.isTransformable&&this._dataValidationCacheService.markRangeDirty(t,e,d.ranges),l&&this._dataValidationCacheService.markCellDirty(t,e,l.row,l.column)})}}}))}_ensureMaps(e,t){let r=this._formulaMap.get(e),n=this._ruleFormulaMap.get(e),i=this._formulaCellMap.get(e);r&&n&&i||(r=/* @__PURE__ */new Map,n=/* @__PURE__ */new Map,i=/* @__PURE__ */new Map,this._formulaMap.set(e,r),this._ruleFormulaMap.set(e,n),this._formulaCellMap.set(e,i));let a=r.get(t),o=n.get(t),l=i.get(t);return a&&o&&l||(a=new s.ObjectMatrix,r.set(t,a),o=/* @__PURE__ */new Map,n.set(t,o),l=/* @__PURE__ */new Map,i.set(t,l)),{formulaMap:a,ruleFormulaMap:o,formulaCellMap:l}}_registerFormula(e,t,r,n){return this._registerOtherFormulaService.registerFormula(e,t,n,{ruleId:r})}deleteByRuleId(e,t,r){let{formulaMap:n,formulaCellMap:i,ruleFormulaMap:a}=this._ensureMaps(e,t),o=this._dataValidationModel.getRuleById(e,t,r),l=/* @__PURE__ */new Set,d=a.get(r);o&&d&&(a.delete(r),o.ranges.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let a=n.getValue(e,t);if(a&&a.ruleId===r){let{formulaId:r}=a;n.realDeleteValue(e,t),l.add(r),i.delete(r)}})}),this._registerOtherFormulaService.deleteFormula(e,t,Array.from(l.values())))}_addFormulaByRange(e,t,r,n,i){let a;let{formulaMap:o,ruleFormulaMap:l,formulaCellMap:d}=this._ensureMaps(e,t);if(!n)return;let u=i[0].startRow,c=i[0].startColumn;i.forEach(i=>{(0,s.Range).foreach(i,(i,a)=>{let s=M(this._lexerTreeBuilder,n,u,c,i,a),l=this._registerFormula(e,t,r,s);o.setValue(i,a,{formulaId:l,ruleId:r}),d.set(l,{row:i,column:a})})}),l.set(r,{formula:n,originCol:c,originRow:u,formulaId:a,isTransformable:!0})}addRule(e,t,r){let{ranges:n,formula1:i,uid:a,type:o}=r;o===s.DataValidationType.CUSTOM&&i&&(0,s.isFormulaString)(i)&&this._addFormulaByRange(e,t,a,i,n)}updateRuleRanges(e,t,r,n,i){let{formulaMap:a,ruleFormulaMap:o,formulaCellMap:l}=this._ensureMaps(e,t),d=o.get(r);if(!d)return;let{formula:u,originCol:c,originRow:h,isTransformable:m,formulaId:p}=d,g=/* @__PURE__ */new Set;n.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=a.getValue(e,t);n&&n.ruleId===r&&(n.temp=!0)})}),i.forEach(n=>{(0,s.Range).foreach(n,(n,i)=>{var s;let d=null!=(s=a.getValue(n,i))?s:{};if(d.ruleId!==r){let s=o.get(d.ruleId);if(null!=s&&s.isTransformable&&g.add(d.formulaId),m){let o=M(this._lexerTreeBuilder,u,h,c,n,i),s=this._registerFormula(e,t,r,o);a.setValue(n,i,{ruleId:r,formulaId:s}),l.set(s,{row:n,column:i})}else a.setValue(n,i,{ruleId:r,formulaId:p})}else d.temp=!1})}),n.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=a.getValue(e,t);n&&n.ruleId===r&&!0===n.temp&&(a.realDeleteValue(e,t),m&&g.add(n.formulaId))})}),g.forEach(e=>{l.delete(e)}),this._registerOtherFormulaService.deleteFormula(e,t,Array.from(g.values()))}updateRuleFormula(e,t,r,n,i){let{ruleFormulaMap:a}=this._ensureMaps(e,t),o=a.get(r);o&&o.formula===i||this._addFormulaByRange(e,t,r,i,n)}getCellFormulaValue(e,t,r,n){let{formulaMap:i}=this._ensureMaps(e,t),a=i.getValue(r,n);return a?this._registerOtherFormulaService.getFormulaValue(e,t,a.formulaId):Promise.resolve(void 0)}getRuleFormulaInfo(e,t,r){let{ruleFormulaMap:n}=this._ensureMaps(e,t);return n.get(r)}},"DataValidationCustomFormulaService"),D);O=E([T(0,s.IUniverInstanceService),T(1,(0,s.Inject)(p.RegisterOtherFormulaService)),T(2,(0,s.Inject)(m.LexerTreeBuilder)),T(3,(0,s.Inject)(l.DataValidationModel)),T(4,(0,s.Inject)(w)),T(5,(0,s.Inject)(s.Injector))],O);var D,U,k=Object.defineProperty,P=Object.getOwnPropertyDescriptor,N=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?P(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&k(t,r,a),a},"__decorateClass$7"),x=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let A=(U=class extends s.Disposable{constructor(e,t,r,n){super(),_(this,"_formulaRuleMap",/* @__PURE__ */new Map),this._instanceService=e,this._registerOtherFormulaService=t,this._dataValidationCacheService=r,this._dataValidationModel=n,this._initFormulaResultHandler()}_initFormulaResultHandler(){this.disposeWithMe(this._registerOtherFormulaService.formulaResult$.subscribe(e=>{for(let t in e){let r=e[t];if(this._instanceService.getUnitType(t)===s.UniverInstanceType.UNIVER_SHEET)for(let e in r){let n=r[e],i=this._ensureRuleFormulaMap(t,e);n.forEach(r=>{var n,a;if(i.get(null==(n=r.extra)?void 0:n.ruleId)){let n=this._dataValidationModel.getRuleById(t,e,null==(a=r.extra)?void 0:a.ruleId);n&&this._dataValidationCacheService.markRangeDirty(t,e,n.ranges)}})}}}))}_ensureRuleFormulaMap(e,t){let r=this._formulaRuleMap.get(e);r||(r=/* @__PURE__ */new Map,this._formulaRuleMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}addRule(e,t,r,n,i){let a=(0,s.isFormulaString)(n),o=(0,s.isFormulaString)(i);if(!a&&!o)return;let l=this._ensureRuleFormulaMap(e,t),d=[void 0,void 0];if(a){let i=this._registerOtherFormulaService.registerFormula(e,t,n,{ruleId:r});d[0]={id:i,text:n}}if(o){let n=this._registerOtherFormulaService.registerFormula(e,t,i,{ruleId:r});d[1]={id:n,text:i}}l.set(r,d)}removeRule(e,t,r){let n=this._ensureRuleFormulaMap(e,t).get(r);if(!n)return;let[i,a]=n,o=[null==i?void 0:i.id,null==a?void 0:a.id].filter(Boolean);o.length&&this._registerOtherFormulaService.deleteFormula(e,t,o)}updateRuleFormulaText(e,t,r,n,i){let a=this._ensureRuleFormulaMap(e,t).get(r);if(!a){this.addRule(e,t,r,n,i);return}let[o,l]=a;if((null==o?void 0:o.text)!==n){if(o&&this._registerOtherFormulaService.deleteFormula(e,t,[o.id]),(0,s.isFormulaString)(n)){let i=this._registerOtherFormulaService.registerFormula(e,t,n,{ruleId:r});a[0]={text:n,id:i}}else a[0]=void 0}if((null==l?void 0:l.text)!==i){if(l&&this._registerOtherFormulaService.deleteFormula(e,t,[l.id]),(0,s.isFormulaString)(i)){let n=this._registerOtherFormulaService.registerFormula(e,t,i,{ruleId:r});a[1]={text:i,id:n}}else a[1]=void 0}}getRuleFormulaResult(e,t,r){let n=this._ensureRuleFormulaMap(e,t).get(r);if(!n)return Promise.resolve(null);let i=/* @__PURE__ */v(async r=>r&&this._registerOtherFormulaService.getFormulaValue(e,t,r.id),"getResult");return Promise.all([i(n[0]),i(n[1])])}getRuleFormulaResultSync(e,t,r){let n=this._ensureRuleFormulaMap(e,t).get(r);if(n)return n.map(r=>{if(r)return this._registerOtherFormulaService.getFormulaValueSync(e,t,r.id)})}getRuleFormulaInfo(e,t,r){return this._ensureRuleFormulaMap(e,t).get(r)}},v(U,"DataValidationFormulaService"),U);function L(e){return(0,s.getOriginCellValue)(e)}function F(e){var t;return String(null!=(t=L(e))?t:"")}A=N([x(0,s.IUniverInstanceService),x(1,(0,s.Inject)(p.RegisterOtherFormulaService)),x(2,(0,s.Inject)(w)),x(3,(0,s.Inject)(l.DataValidationModel))],A),v(L,"getCellValueOrigin"),v(F,"getStringCellValue");let j=(v(B=class{constructor(e,t){this.low=e,this.high=t}clone(){return new B(this.low,this.high)}get max(){return this.clone()}less_than(e){return this.low<e.low||this.low===e.low&&this.high<e.high}equal_to(e){return this.low===e.low&&this.high===e.high}intersect(e){return!this.not_intersect(e)}not_intersect(e){return this.high<e.low||e.high<this.low}merge(e){return new B(void 0===this.low?e.low:this.low<e.low?this.low:e.low,void 0===this.high?e.high:this.high>e.high?this.high:e.high)}output(){return[this.low,this.high]}static comparable_max(e,t){return e.merge(t)}static comparable_less_than(e,t){return e<t}},"Interval"),B),V=class{constructor(e,t,r=null,n=null,i=null,a=1){if(this.left=r,this.right=n,this.parent=i,this.color=a,this.item={key:e,value:t},e&&e instanceof Array&&2===e.length&&!Number.isNaN(e[0])&&!Number.isNaN(e[1])){let[t,r]=e;t>r&&([t,r]=[r,t]),this.item.key=new j(t,r)}this.max=this.item.key?this.item.key.max:void 0}isNil(){return void 0===this.item.key&&void 0===this.item.value&&null===this.left&&null===this.right&&1===this.color}_value_less_than(e){return this.item.value&&e.item.value&&this.item.value.less_than?this.item.value.less_than(e.item.value):this.item.value<e.item.value}less_than(e){return this.item.value===this.item.key&&e.item.value===e.item.key?this.item.key.less_than(e.item.key):this.item.key.less_than(e.item.key)||this.item.key.equal_to(e.item.key)&&this._value_less_than(e)}_value_equal(e){return this.item.value&&e.item.value&&this.item.value.equal_to?this.item.value.equal_to(e.item.value):this.item.value===e.item.value}equal_to(e){return this.item.value===this.item.key&&e.item.value===e.item.key?this.item.key.equal_to(e.item.key):this.item.key.equal_to(e.item.key)&&this._value_equal(e)}intersect(e){return this.item.key.intersect(e.item.key)}copy_data(e){this.item.key=e.item.key,this.item.value=e.item.value}update_max(){if(this.max=this.item.key?this.item.key.max:void 0,this.right&&this.right.max){let e=this.item.key.constructor.comparable_max;this.max=e(this.max,this.right.max)}if(this.left&&this.left.max){let e=this.item.key.constructor.comparable_max;this.max=e(this.max,this.left.max)}}not_intersect_left_subtree(e){return(0,this.item.key.constructor.comparable_less_than)(void 0!==this.left.max.high?this.left.max.high:this.left.max,e.item.key.low)}not_intersect_right_subtree(e){let t=this.item.key.constructor.comparable_less_than,r=void 0!==this.right.max.low?this.right.max.low:this.right.item.key.low;return t(e.item.key.high,r)}};v(V,"Node");let H=class e{constructor(){this.root=null,this.nil_node=new V}get size(){let e=0;return this.tree_walk(this.root,()=>e++),e}get keys(){let e=[];return this.tree_walk(this.root,t=>e.push(t.item.key.output?t.item.key.output():t.item.key)),e}get values(){let e=[];return this.tree_walk(this.root,t=>e.push(t.item.value)),e}get items(){let e=[];return this.tree_walk(this.root,t=>e.push({key:t.item.key.output?t.item.key.output():t.item.key,value:t.item.value})),e}isEmpty(){return null==this.root||this.root===this.nil_node}clear(){this.root=null}insert(e,t=e){if(void 0===e)return;let r=new V(e,t,this.nil_node,this.nil_node,null,0);return this.tree_insert(r),this.recalc_max(r),r}exist(e,t=e){let r=new V(e,t);return!!this.tree_search(this.root,r)}remove(e,t=e){let r=new V(e,t),n=this.tree_search(this.root,r);return n&&this.tree_delete(n),n}search(e,t=(e,t)=>e===t?t.output():e){let r=new V(e),n=[];return this.tree_search_interval(this.root,r,n),n.map(e=>t(e.item.value,e.item.key))}intersect_any(e){let t=new V(e);return this.tree_find_any_interval(this.root,t)}forEach(e){this.tree_walk(this.root,t=>e(t.item.key,t.item.value))}map(t){let r=new e;return this.tree_walk(this.root,e=>r.insert(e.item.key,t(e.item.value,e.item.key))),r}*iterate(e,t=(e,t)=>e===t?t.output():e){let r;for(e?r=this.tree_search_nearest_forward(this.root,new V(e)):this.root&&(r=this.local_minimum(this.root));r;)yield t(r.item.value,r.item.key),r=this.tree_successor(r)}recalc_max(e){let t=e;for(;null!=t.parent;)t.parent.update_max(),t=t.parent}tree_insert(e){let t=this.root,r=null;if(null==this.root||this.root===this.nil_node)this.root=e;else{for(;t!==this.nil_node;)r=t,t=e.less_than(t)?t.left:t.right;e.parent=r,e.less_than(r)?r.left=e:r.right=e}this.insert_fixup(e)}insert_fixup(e){let t,r;for(t=e;t!==this.root&&0===t.parent.color;)t.parent===t.parent.parent.left?0===(r=t.parent.parent.right).color?(t.parent.color=1,r.color=1,t.parent.parent.color=0,t=t.parent.parent):(t===t.parent.right&&(t=t.parent,this.rotate_left(t)),t.parent.color=1,t.parent.parent.color=0,this.rotate_right(t.parent.parent)):0===(r=t.parent.parent.left).color?(t.parent.color=1,r.color=1,t.parent.parent.color=0,t=t.parent.parent):(t===t.parent.left&&(t=t.parent,this.rotate_right(t)),t.parent.color=1,t.parent.parent.color=0,this.rotate_left(t.parent.parent));this.root.color=1}tree_delete(e){let t,r;(r=(t=e.left===this.nil_node||e.right===this.nil_node?e:this.tree_successor(e)).left!==this.nil_node?t.left:t.right).parent=t.parent,t===this.root?this.root=r:(t===t.parent.left?t.parent.left=r:t.parent.right=r,t.parent.update_max()),this.recalc_max(r),t!==e&&(e.copy_data(t),e.update_max(),this.recalc_max(e)),1===t.color&&this.delete_fixup(r)}delete_fixup(e){let t=e,r;for(;t!==this.root&&null!=t.parent&&1===t.color;)t===t.parent.left?(0===(r=t.parent.right).color&&(r.color=1,t.parent.color=0,this.rotate_left(t.parent),r=t.parent.right),1===r.left.color&&1===r.right.color?(r.color=0,t=t.parent):(1===r.right.color&&(r.color=0,r.left.color=1,this.rotate_right(r),r=t.parent.right),r.color=t.parent.color,t.parent.color=1,r.right.color=1,this.rotate_left(t.parent),t=this.root)):(0===(r=t.parent.left).color&&(r.color=1,t.parent.color=0,this.rotate_right(t.parent),r=t.parent.left),1===r.left.color&&1===r.right.color?(r.color=0,t=t.parent):(1===r.left.color&&(r.color=0,r.right.color=1,this.rotate_left(r),r=t.parent.left),r.color=t.parent.color,t.parent.color=1,r.left.color=1,this.rotate_right(t.parent),t=this.root));t.color=1}tree_search(e,t){if(!(null==e||e===this.nil_node))return t.equal_to(e)?e:t.less_than(e)?this.tree_search(e.left,t):this.tree_search(e.right,t)}tree_search_nearest_forward(e,t){let r,n=e;for(;n&&n!==this.nil_node;)n.less_than(t)?n.intersect(t)?(r=n,n=n.left):n=n.right:((!r||n.less_than(r))&&(r=n),n=n.left);return r||null}tree_search_interval(e,t,r){null==e||e===this.nil_node||(e.left===this.nil_node||e.not_intersect_left_subtree(t)||this.tree_search_interval(e.left,t,r),e.intersect(t)&&r.push(e),e.right===this.nil_node||e.not_intersect_right_subtree(t)||this.tree_search_interval(e.right,t,r))}tree_find_any_interval(e,t){let r=!1;return null==e||e===this.nil_node||(e.left===this.nil_node||e.not_intersect_left_subtree(t)||(r=this.tree_find_any_interval(e.left,t)),r||(r=e.intersect(t)),r||e.right===this.nil_node||e.not_intersect_right_subtree(t)||(r=this.tree_find_any_interval(e.right,t))),r}local_minimum(e){let t=e;for(;null!=t.left&&t.left!==this.nil_node;)t=t.left;return t}local_maximum(e){let t=e;for(;null!=t.right&&t.right!==this.nil_node;)t=t.right;return t}tree_successor(e){let t,r,n;if(e.right!==this.nil_node)t=this.local_minimum(e.right);else{for(r=e,n=e.parent;null!=n&&n.right===r;)r=n,n=n.parent;t=n}return t}rotate_left(e){let t=e.right;e.right=t.left,t.left!==this.nil_node&&(t.left.parent=e),t.parent=e.parent,e===this.root?this.root=t:e===e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t,null!=e&&e!==this.nil_node&&e.update_max(),null!=(t=e.parent)&&t!==this.nil_node&&t.update_max()}rotate_right(e){let t=e.left;e.left=t.right,t.right!==this.nil_node&&(t.right.parent=e),t.parent=e.parent,e===this.root?this.root=t:e===e.parent.left?e.parent.left=t:e.parent.right=t,t.right=e,e.parent=t,null!==e&&e!==this.nil_node&&e.update_max(),null!=(t=e.parent)&&t!==this.nil_node&&t.update_max()}tree_walk(e,t){null!=e&&e!==this.nil_node&&(this.tree_walk(e.left,t),t(e),this.tree_walk(e.right,t))}testRedBlackProperty(){let e=!0;return this.tree_walk(this.root,function(t){0===t.color&&(1===t.left.color&&1===t.right.color||(e=!1))}),e}testBlackHeightProperty(e){let t=0,r=0;if(1===e.color&&t++,(r=e.left!==this.nil_node?this.testBlackHeightProperty(e.left):1)!==(e.right!==this.nil_node?this.testBlackHeightProperty(e.right):1))throw Error("Red-black height property violated");return t+r}};v(H,"IntervalTree");let $=class e{constructor(e,t,r,n,i=!1){_(this,"_map"),_(this,"_tree",/* @__PURE__ */new Map),_(this,"_dirty",!0),_(this,"_buildTree",/* @__PURE__ */v(()=>{if(!this._dirty||this._disableTree)return;let e=/* @__PURE__ */new Map;this._map.forEach((t,r)=>{t.forEach(t=>{for(let n=t.startColumn;n<=t.endColumn;n++){let i=e.get(n);i||(i=[],e.set(n,i)),i.push({startRow:t.startRow,endRow:t.endRow,ruleId:r})}})});let t=/* @__PURE__ */new Map;e.forEach((e,r)=>{let n=new H;e.forEach(e=>{n.insert([e.startRow,e.endRow],e.ruleId)}),t.set(r,n)}),this._tree=t,this._dirty=!1},"_buildTree")),_(this,"_debonceBuildTree",(0,s.debounce)(this._buildTree,0)),this._unitId=t,this._subUnitId=r,this._univerInstanceService=n,this._disableTree=i,this._map=e,this._buildTree()}get _worksheet(){var e;return null==(e=this._univerInstanceService.getUnit(this._unitId,s.UniverInstanceType.UNIVER_SHEET))?void 0:e.getSheetBySheetId(this._subUnitId)}addRule(e){if(!this._worksheet)return;let t=e.uid,r=e.ranges.map(e=>(0,s.Range).transformRange(e,this._worksheet));this._map.forEach((e,t)=>{let n=(0,s.Rectangle).subtractMulti(e,r);0===n.length?this._map.delete(t):this._map.set(t,n)}),this._dirty=!0,this._map.set(t,r),this._debonceBuildTree()}removeRange(e){if(!this._worksheet)return;let t=e.map(e=>(0,s.Range).transformRange(e,this._worksheet));this._map.forEach((e,r)=>{let n=(0,s.Rectangle).subtractMulti(e,t);0===n.length?this._map.delete(r):this._map.set(r,n)}),this._dirty=!0,this._debonceBuildTree()}removeRule(e){this._map.delete(e.uid),this._dirty=!0,this._debonceBuildTree()}updateRange(e,t){if(!this._worksheet)return;this._map.delete(e);let r=t.map(e=>(0,s.Range).transformRange(e,this._worksheet));this._map.forEach((e,t)=>{let n=(0,s.Rectangle).subtractMulti(e,r);0===n.length?this._map.delete(t):this._map.set(t,n)}),this._map.set(e,r),this._dirty=!0,this._debonceBuildTree()}addRangeRules(e){e.forEach(({id:e,ranges:t})=>{if(!t.length)return;let r=this._map.get(e);r?(this._map.set(e,(0,s.Rectangle).mergeRanges([...r,...t])),r=this._map.get(e)):(r=t,this._map.set(e,r)),this._map.forEach((r,n)=>{if(n===e)return;let i=(0,s.Rectangle).subtractMulti(r,t);0===i.length?this._map.delete(n):this._map.set(n,i)})}),this._dirty=!0,this._debonceBuildTree()}diff(e){let t=[],r=0;return e.forEach((e,n)=>{var i;let a=null!=(i=this._map.get(e.uid))?i:[],o=e.ranges;0!==a.length&&(a.length!==o.length||a.some((e,t)=>!(0,s.Rectangle).equals(e,o[t])))&&t.push({type:"update",ruleId:e.uid,oldRanges:o,newRanges:(0,s.Rectangle).sort(a),rule:e}),0===a.length&&(t.push({type:"delete",rule:e,index:n-r}),r++)}),t}diffWithAddition(e,t){let r=[],n=0;return e.forEach((e,t)=>{var i;let a=null!=(i=this._map.get(e.uid))?i:[],o=e.ranges;0!==a.length&&(a.length!==o.length||a.some((e,t)=>!(0,s.Rectangle).equals(e,o[t])))&&r.push({type:"update",ruleId:e.uid,oldRanges:o,newRanges:(0,s.Rectangle).sort(a),rule:e}),0===a.length&&(r.push({type:"delete",rule:e,index:t-n}),n++)}),Array.from(t).forEach(e=>{var t;let n=null!=(t=this._map.get(e.uid))?t:[];r.push({type:"add",rule:{...e,ranges:(0,s.Rectangle).sort(n)}})}),r}clone(){return new e(new Map((0,s.Tools).deepClone(Array.from(this._map.entries()))),this._unitId,this._subUnitId,this._univerInstanceService,!0)}getValue(e,t){this._dirty&&this._buildTree();let r=this._tree.get(t);if(!r)return;let n=r.search([e,e]);return n.length>0?n[0]:void 0}};v($,"RuleMatrix");var B,W,G=Object.defineProperty,z=Object.getOwnPropertyDescriptor,Y=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?z(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&G(t,r,a),a},"__decorateClass$6"),K=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let q=(W=class extends s.Disposable{constructor(e,t,r,n,i,a,o){super(),_(this,"_ruleMatrixMap",/* @__PURE__ */new Map),_(this,"_validStatusChange$",new h.Subject),_(this,"_ruleChange$",new h.Subject),_(this,"ruleChange$",this._ruleChange$.asObservable()),_(this,"validStatusChange$",this._validStatusChange$.asObservable()),this._dataValidationModel=e,this._univerInstanceService=t,this._dataValidatorRegistryService=r,this._dataValidationCacheService=n,this._dataValidationFormulaService=i,this._dataValidationCustomFormulaService=a,this._commandService=o,this._initRuleUpdateListener(),this.disposeWithMe(()=>{this._ruleChange$.complete(),this._validStatusChange$.complete()}),this._initUniverInstanceListener()}_initUniverInstanceListener(){this.disposeWithMe(this._univerInstanceService.unitDisposed$.subscribe(e=>{this._ruleMatrixMap.delete(e.getUnitId())})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===d.RemoveSheetMutation.id){let{unitId:t,subUnitId:r}=e.params,n=this._ruleMatrixMap.get(t);n&&n.delete(r)}}))}_initRuleUpdateListener(){for(let[e,t]of this._dataValidationModel.getAll())for(let[r,n]of t)for(let t of n)this._addRule(e,r,t),this._ruleChange$.next({type:"add",unitId:e,subUnitId:r,rule:t,source:"patched"});this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":this._addRule(e.unitId,e.subUnitId,e.rule);break;case"update":this._updateRule(e.unitId,e.subUnitId,e.rule.uid,e.oldRule,e.updatePayload);break;case"remove":this._removeRule(e.unitId,e.subUnitId,e.rule)}this._ruleChange$.next(e)}))}_ensureRuleMatrix(e,t){let r=this._ruleMatrixMap.get(e);r||(r=/* @__PURE__ */new Map,this._ruleMatrixMap.set(e,r));let n=r.get(t);return n||(n=new $(/* @__PURE__ */new Map,e,t,this._univerInstanceService),r.set(t,n)),n}_addRuleSideEffect(e,t,r){this._ensureRuleMatrix(e,t).addRule(r),this._dataValidationCacheService.addRule(e,t,r),this._dataValidationFormulaService.addRule(e,t,r.uid,r.formula1,r.formula2),r.type===s.DataValidationType.CUSTOM&&this._dataValidationCustomFormulaService.addRule(e,t,r)}_addRule(e,t,r){(Array.isArray(r)?r:[r]).forEach(r=>{this._addRuleSideEffect(e,t,r)})}_updateRule(e,t,r,n,i){let a=this._ensureRuleMatrix(e,t);i.type===l.UpdateRuleType.RANGE?(a.updateRange(r,i.payload),this._dataValidationCacheService.updateRuleRanges(e,t,r,i.payload,n.ranges),n.type===s.DataValidationType.CUSTOM&&this._dataValidationCustomFormulaService.updateRuleRanges(e,t,r,n.ranges,i.payload)):i.type===l.UpdateRuleType.SETTING&&(this._dataValidationCacheService.markRangeDirty(e,t,n.ranges),this._dataValidationFormulaService.updateRuleFormulaText(e,t,r,i.payload.formula1,i.payload.formula2),n.type===s.DataValidationType.CUSTOM?this._dataValidationCustomFormulaService.updateRuleFormula(e,t,r,n.ranges,i.payload.formula1):i.payload.type===s.DataValidationType.CUSTOM&&this._dataValidationCustomFormulaService.addRule(e,t,{...n,...i.payload}))}_removeRule(e,t,r){this._ensureRuleMatrix(e,t).removeRule(r),this._dataValidationCacheService.removeRule(e,t,r),r.type===s.DataValidationType.CUSTOM&&this._dataValidationCustomFormulaService.deleteByRuleId(e,t,r.uid)}getValidator(e){return this._dataValidatorRegistryService.getValidatorItem(e)}getRuleIdByLocation(e,t,r,n){return this._ensureRuleMatrix(e,t).getValue(r,n)}getRuleByLocation(e,t,r,n){let i=this.getRuleIdByLocation(e,t,r,n);if(i)return this._dataValidationModel.getRuleById(e,t,i)}validator(e,t,r){let{col:n,row:i,unitId:a,subUnitId:o,worksheet:l}=t,d=e.uid,u=e.formula1,c=e.formula2,h=/* @__PURE__ */v((t,s)=>{r&&r(t,s),s&&this._validStatusChange$.next({unitId:a,subUnitId:o,ruleId:e.uid,status:t,row:i,col:n})},"onCompete"),m=l.getCellValueOnly(i,n),p=this.getValidator(e.type),g=l.getCellRaw(i,n),f=L(g),_=L(m);if(!p)return h(s.DataValidationStatus.VALID,!1),s.DataValidationStatus.VALID;{let r=this._dataValidationCacheService.ensureCache(a,o),l=r.getValue(i,n);return l&&l.value===f&&l.interceptValue===_&&l.ruleId===d&&l.formula1===u&&l.formula2===c?(h(l.status,!1),l.status):(r.setValue(i,n,{value:f,interceptValue:_,status:s.DataValidationStatus.VALIDATING,ruleId:d,formula1:u||"",formula2:c||""}),p.validator({value:f,unitId:a,subUnitId:o,row:i,column:n,worksheet:t.worksheet,workbook:t.workbook,interceptValue:L(m),t:null==g?void 0:g.t},e).then(e=>{let t=e?s.DataValidationStatus.VALID:s.DataValidationStatus.INVALID;r.setValue(i,n,{value:f,status:t,ruleId:d,interceptValue:_,formula1:u||"",formula2:c||""}),h(t,!0)}),s.DataValidationStatus.VALIDATING)}}getRuleErrorMsg(e,t,r){let n=this._dataValidationModel.getRuleById(e,t,r);if(!n)return"";let i=this._dataValidatorRegistryService.getValidatorItem(n.type);return n.error?n.error:i?i.getRuleFinalError(n):""}getRuleObjectMatrix(e,t){return this._ensureRuleMatrix(e,t)}getRuleById(e,t,r){return this._dataValidationModel.getRuleById(e,t,r)}getRuleIndex(e,t,r){return this._dataValidationModel.getRuleIndex(e,t,r)}getRules(e,t){return[...this._dataValidationModel.getRules(e,t)]}getUnitRules(e){return this._dataValidationModel.getUnitRules(e)}deleteUnitRules(e){return this._dataValidationModel.deleteUnitRules(e)}getSubUnitIds(e){return this._dataValidationModel.getSubUnitIds(e)}getAll(){return this._dataValidationModel.getAll()}},v(W,"SheetDataValidationModel"),W);function X(e){var t,r;return null==(r=null==(t=null==e?void 0:e[0])?void 0:t[0])?void 0:r.v}function Q(e){var t;return null==(t=null==e?void 0:e[0])?void 0:t[0]}function Z(e){return!(0,m.ERROR_TYPE_SET).has(e)}function J(e,t){return(0,s.Tools).isBlank(e)?t.t("dataValidation.validFail.value"):(0,s.isFormulaString)(e)?t.t("dataValidation.validFail.primitive"):""}q=Y([K(0,(0,s.Inject)(l.DataValidationModel)),K(1,s.IUniverInstanceService),K(2,(0,s.Inject)(l.DataValidatorRegistryService)),K(3,(0,s.Inject)(w)),K(4,(0,s.Inject)(A)),K(5,(0,s.Inject)(O)),K(6,s.ICommandService)],q),v(X,"getFormulaResult"),v(Q,"getFormulaCellData"),v(Z,"isLegalFormulaResult"),v(J,"getFailMessage");let ee=/* @__PURE__ */v(e=>(0,s.Tools).isDefine(e)&&"true"===String(e).toLowerCase()?"1":"false"===String(e).toLowerCase()?"0":e,"transformCheckboxValue"),et=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"id",s.DataValidationType.CHECKBOX),_(this,"title","dataValidation.checkbox.title"),_(this,"operators",[]),_(this,"scopes",["sheet"]),_(this,"_formulaService",this.injector.get(A)),_(this,"skipDefaultFontRender",/* @__PURE__ */v((e,t,r)=>{let{formula1:n,formula2:i}=this.parseFormulaSync(e,r.unitId,r.subUnitId),a=`${null!=t?t:""}`;return!a||a===`${n}`||a===`${i}`},"skipDefaultFontRender"))}validatorFormula(e,t,r){let{formula1:n,formula2:i}=e,a=n===i;if((0,s.Tools).isBlank(n)&&(0,s.Tools).isBlank(i))return{success:!0};if(a)return{success:!1,formula1:this.localeService.t("dataValidation.validFail.checkboxEqual"),formula2:this.localeService.t("dataValidation.validFail.checkboxEqual")};let o=J(n,this.localeService),l=J(i,this.localeService);return{success:!o&&!l,formula1:o,formula2:l}}async parseFormula(e,t,r){var n,i;let{formula1:a=1,formula2:o=0}=e,l=await this._formulaService.getRuleFormulaResult(t,r,e.uid),d=(0,s.isFormulaString)(a)?X(null==(n=null==l?void 0:l[0])?void 0:n.result):a,u=(0,s.isFormulaString)(o)?X(null==(i=null==l?void 0:l[1])?void 0:i.result):o,c=Z(String(d))&&Z(String(u));return{formula1:ee(d),formula2:ee(u),originFormula1:d,originFormula2:u,isFormulaValid:c}}getExtraStyle(e,t){return{tb:s.WrapStrategy.CLIP}}parseFormulaSync(e,t,r){var n,i;let{formula1:a=1,formula2:o=0}=e,l=this._formulaService.getRuleFormulaResultSync(t,r,e.uid),d=(0,s.isFormulaString)(a)?X(null==(n=null==l?void 0:l[0])?void 0:n.result):a,u=(0,s.isFormulaString)(o)?X(null==(i=null==l?void 0:l[1])?void 0:i.result):o;return{formula1:ee(d),formula2:ee(u),originFormula1:d,originFormula2:u}}async isValidType(e,t,r){let{value:n,unitId:i,subUnitId:a}=e,{formula1:o,formula2:l,originFormula1:d,originFormula2:u}=await this.parseFormula(r,i,a);return!((0,s.Tools).isDefine(o)&&(0,s.Tools).isDefine(l))||(0,s.Tools).isDefine(n)&&(String(n)===String(o)||String(n)===String(l)||String(n)===String(null!=d?d:"")||String(n)===String(null!=u?u:""))}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.checkbox.error")}};function er(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}v(et,"CheckboxValidator"),"u">typeof globalThis?globalThis:"u">typeof window?window:"u">typeof r||"u">typeof self&&self,v(er,"getDefaultExportFromCjs");var en={exports:{}};eF=function(){var e="millisecond",t="second",r="minute",n="hour",i="week",a="month",o="quarter",s="year",l="date",d="Invalid Date",u=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,c=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,h={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:/* @__PURE__ */v(function(e){var t=["th","st","nd","rd"],r=e%100;return"["+e+(t[(r-20)%10]||t[r]||"th")+"]"},"ordinal")},m=/* @__PURE__ */v(function(e,t,r){var n=String(e);return!n||n.length>=t?e:""+Array(t+1-n.length).join(r)+e},"m"),p={s:m,z:/* @__PURE__ */v(function(e){var t=-e.utcOffset(),r=Math.abs(t);return(t<=0?"+":"-")+m(Math.floor(r/60),2,"0")+":"+m(r%60,2,"0")},"z"),m:/* @__PURE__ */v(function e(t,r){if(t.date()<r.date())return-e(r,t);var n=12*(r.year()-t.year())+(r.month()-t.month()),i=t.clone().add(n,a),o=r-i<0,s=t.clone().add(n+(o?-1:1),a);return+(-(n+(r-i)/(o?i-s:s-i))||0)},"t"),a:/* @__PURE__ */v(function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},"a"),p:/* @__PURE__ */v(function(d){return({M:a,y:s,w:i,d:"day",D:l,h:n,m:r,s:t,ms:e,Q:o})[d]||String(d||"").toLowerCase().replace(/s$/,"")},"p"),u:/* @__PURE__ */v(function(e){return void 0===e},"u")},g="en",f={};f[g]=h;var _="$isDayjsObject",I=/* @__PURE__ */v(function(e){return e instanceof y||!(!e||!e[_])},"S"),S=/* @__PURE__ */v(function e(t,r,n){var i;if(!t)return g;if("string"==typeof t){var a=t.toLowerCase();f[a]&&(i=a),r&&(f[a]=r,i=a);var o=t.split("-");if(!i&&o.length>1)return e(o[0])}else{var s=t.name;f[s]=t,i=s}return!n&&i&&(g=i),i||!n&&g},"t"),C=/* @__PURE__ */v(function(e,t){if(I(e))return e.clone();var r="object"==typeof t?t:{};return r.date=e,r.args=arguments,new y(r)},"O");p.l=S,p.i=I,p.w=function(e,t){return C(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var y=function(){function h(e){this.$L=S(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[_]=!0}v(h,"M");var m=h.prototype;return m.parse=function(e){this.$d=function(e){var t=e.date,r=e.utc;if(null===t)return /* @__PURE__ */new Date(NaN);if(p.u(t))return /* @__PURE__ */new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var n=t.match(u);if(n){var i=n[2]-1||0,a=(n[7]||"0").substring(0,3);return r?new Date(Date.UTC(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,a)):new Date(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,a)}}return new Date(t)}(e),this.init()},m.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},m.$utils=function(){return p},m.isValid=function(){return this.$d.toString()!==d},m.isSame=function(e,t){var r=C(e);return this.startOf(t)<=r&&r<=this.endOf(t)},m.isAfter=function(e,t){return C(e)<this.startOf(t)},m.isBefore=function(e,t){return this.endOf(t)<C(e)},m.$g=function(e,t,r){return p.u(e)?this[t]:this.set(r,e)},m.unix=function(){return Math.floor(this.valueOf()/1e3)},m.valueOf=function(){return this.$d.getTime()},m.startOf=function(e,o){var d=this,u=!!p.u(o)||o,c=p.p(e),h=/* @__PURE__ */v(function(e,t){var r=p.w(d.$u?Date.UTC(d.$y,t,e):new Date(d.$y,t,e),d);return u?r:r.endOf("day")},"l"),m=/* @__PURE__ */v(function(e,t){return p.w(d.toDate()[e].apply(d.toDate("s"),(u?[0,0,0,0]:[23,59,59,999]).slice(t)),d)},"$"),g=this.$W,f=this.$M,_=this.$D,I="set"+(this.$u?"UTC":"");switch(c){case s:return u?h(1,0):h(31,11);case a:return u?h(1,f):h(0,f+1);case i:var S=this.$locale().weekStart||0,C=(g<S?g+7:g)-S;return h(u?_-C:_+(6-C),f);case"day":case l:return m(I+"Hours",0);case n:return m(I+"Minutes",1);case r:return m(I+"Seconds",2);case t:return m(I+"Milliseconds",3);default:return this.clone()}},m.endOf=function(e){return this.startOf(e,!1)},m.$set=function(i,o){var d,u=p.p(i),c="set"+(this.$u?"UTC":""),h=((d={}).day=c+"Date",d[l]=c+"Date",d[a]=c+"Month",d[s]=c+"FullYear",d[n]=c+"Hours",d[r]=c+"Minutes",d[t]=c+"Seconds",d[e]=c+"Milliseconds",d)[u],m="day"===u?this.$D+(o-this.$W):o;if(u===a||u===s){var g=this.clone().set(l,1);g.$d[h](m),g.init(),this.$d=g.set(l,Math.min(this.$D,g.daysInMonth())).$d}else h&&this.$d[h](m);return this.init(),this},m.set=function(e,t){return this.clone().$set(e,t)},m.get=function(e){return this[p.p(e)]()},m.add=function(e,o){var l,d=this;e=Number(e);var u=p.p(o),c=/* @__PURE__ */v(function(t){var r=C(d);return p.w(r.date(r.date()+Math.round(t*e)),d)},"y");if(u===a)return this.set(a,this.$M+e);if(u===s)return this.set(s,this.$y+e);if("day"===u)return c(1);if(u===i)return c(7);var h=((l={})[r]=6e4,l[n]=36e5,l[t]=1e3,l)[u]||1,m=this.$d.getTime()+e*h;return p.w(m,this)},m.subtract=function(e,t){return this.add(-1*e,t)},m.format=function(e){var t=this,r=this.$locale();if(!this.isValid())return r.invalidDate||d;var n=e||"YYYY-MM-DDTHH:mm:ssZ",i=p.z(this),a=this.$H,o=this.$m,s=this.$M,l=r.weekdays,u=r.months,h=r.meridiem,m=/* @__PURE__ */v(function(e,r,i,a){return e&&(e[r]||e(t,n))||i[r].slice(0,a)},"h"),g=/* @__PURE__ */v(function(e){return p.s(a%12||12,e,"0")},"d"),f=h||function(e,t,r){var n=e<12?"AM":"PM";return r?n.toLowerCase():n};return n.replace(c,function(e,n){return n||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return p.s(t.$y,4,"0");case"M":return s+1;case"MM":return p.s(s+1,2,"0");case"MMM":return m(r.monthsShort,s,u,3);case"MMMM":return m(u,s);case"D":return t.$D;case"DD":return p.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return m(r.weekdaysMin,t.$W,l,2);case"ddd":return m(r.weekdaysShort,t.$W,l,3);case"dddd":return l[t.$W];case"H":return String(a);case"HH":return p.s(a,2,"0");case"h":return g(1);case"hh":return g(2);case"a":return f(a,o,!0);case"A":return f(a,o,!1);case"m":return String(o);case"mm":return p.s(o,2,"0");case"s":return String(t.$s);case"ss":return p.s(t.$s,2,"0");case"SSS":return p.s(t.$ms,3,"0");case"Z":return i}return null}(e)||i.replace(":","")})},m.utcOffset=function(){return-(15*Math.round(this.$d.getTimezoneOffset()/15))},m.diff=function(e,l,d){var u,c=this,h=p.p(l),m=C(e),g=(m.utcOffset()-this.utcOffset())*6e4,f=this-m,_=/* @__PURE__ */v(function(){return p.m(c,m)},"D");switch(h){case s:u=_()/12;break;case a:u=_();break;case o:u=_()/3;break;case i:u=(f-g)/6048e5;break;case"day":u=(f-g)/864e5;break;case n:u=f/36e5;break;case r:u=f/6e4;break;case t:u=f/1e3;break;default:u=f}return d?u:p.a(u)},m.daysInMonth=function(){return this.endOf(a).$D},m.$locale=function(){return f[this.$L]},m.locale=function(e,t){if(!e)return this.$L;var r=this.clone(),n=S(e,t,!0);return n&&(r.$L=n),r},m.clone=function(){return p.w(this.$d,this)},m.toDate=function(){return new Date(this.valueOf())},m.toJSON=function(){return this.isValid()?this.toISOString():null},m.toISOString=function(){return this.$d.toISOString()},m.toString=function(){return this.$d.toUTCString()},h}(),w=y.prototype;return C.prototype=w,[["$ms",e],["$s",t],["$m",r],["$H",n],["$W","day"],["$M",a],["$y",s],["$D",l]].forEach(function(e){w[e[1]]=function(t){return this.$g(t,e[0],e[1])}}),C.extend=function(e,t){return e.$i||(e(t,y,C),e.$i=!0),C},C.locale=S,C.isDayjs=I,C.unix=function(e){return C(1e3*e)},C.en=f[g],C.Ls=f,C.p={},C},en.exports=eF();let ei=/* @__PURE__ */er(en.exports),ea={[s.DataValidationOperator.BETWEEN]:"dataValidation.date.operators.between",[s.DataValidationOperator.EQUAL]:"dataValidation.date.operators.equal",[s.DataValidationOperator.GREATER_THAN]:"dataValidation.date.operators.greaterThan",[s.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.operators.greaterThanOrEqual",[s.DataValidationOperator.LESS_THAN]:"dataValidation.date.operators.lessThan",[s.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.operators.lessThanOrEqual",[s.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.operators.notBetween",[s.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.operators.notEqual"};s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL;let eo={[s.DataValidationOperator.BETWEEN]:"dataValidation.date.ruleName.between",[s.DataValidationOperator.EQUAL]:"dataValidation.date.ruleName.equal",[s.DataValidationOperator.GREATER_THAN]:"dataValidation.date.ruleName.greaterThan",[s.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.ruleName.greaterThanOrEqual",[s.DataValidationOperator.LESS_THAN]:"dataValidation.date.ruleName.lessThan",[s.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.ruleName.lessThanOrEqual",[s.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.ruleName.notBetween",[s.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.ruleName.notEqual"},es={[s.DataValidationOperator.BETWEEN]:"dataValidation.date.errorMsg.between",[s.DataValidationOperator.EQUAL]:"dataValidation.date.errorMsg.equal",[s.DataValidationOperator.GREATER_THAN]:"dataValidation.date.errorMsg.greaterThan",[s.DataValidationOperator.GREATER_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.greaterThanOrEqual",[s.DataValidationOperator.LESS_THAN]:"dataValidation.date.errorMsg.lessThan",[s.DataValidationOperator.LESS_THAN_OR_EQUAL]:"dataValidation.date.errorMsg.lessThanOrEqual",[s.DataValidationOperator.NOT_BETWEEN]:"dataValidation.date.errorMsg.notBetween",[s.DataValidationOperator.NOT_EQUAL]:"dataValidation.date.errorMsg.notEqual"},el=[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.NOT_BETWEEN],ed="{FORMULA1}",eu="{FORMULA2}",ec=/* @__PURE__ */v(e=>{var t,r;if(null==e||"boolean"==typeof e)return;if("number"==typeof e||!Number.isNaN(+e))return+e;let n=null==(t=(0,s.numfmt).parseDate(e))?void 0:t.v;return(0,s.Tools).isDefine(n)?n:null==(r=(0,s.numfmt).parseDate(ei(e).format("YYYY-MM-DD HH:mm:ss")))?void 0:r.v},"transformDate2SerialNumber"),eh=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"id",s.DataValidationType.DATE),_(this,"title","dataValidation.date.title"),_(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),_(this,"scopes",["sheet"]),_(this,"_formulaService",this.injector.get(A))}async parseFormula(e,t,r){var n,i;let a=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:o,formula2:l}=e,d=X(null==(n=null==a?void 0:a[0])?void 0:n.result),u=X(null==(i=null==a?void 0:a[1])?void 0:i.result),c=Z(String(d))&&Z(String(u));return{formula1:ec((0,s.isFormulaString)(o)?d:o),formula2:ec((0,s.isFormulaString)(l)?u:l),isFormulaValid:c}}parseFormulaSync(e,t,r){var n,i;let a=this._formulaService.getRuleFormulaResultSync(t,r,e.uid),{formula1:o,formula2:l}=e;return{formula1:ec((0,s.isFormulaString)(o)?X(null==(n=null==a?void 0:a[0])?void 0:n.result):o),formula2:ec((0,s.isFormulaString)(l)?X(null==(i=null==a?void 0:a[1])?void 0:i.result):l)}}async isValidType(e){let{interceptValue:t,value:r}=e;return"number"==typeof r&&"string"==typeof t||"string"==typeof t&&!!(0,s.numfmt).parseDate(t)}_validatorSingleFormula(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e)||!!(e&&(0,s.numfmt).parseDate(e)))}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=this._validatorSingleFormula(e.formula1),a=this.localeService.t("dataValidation.validFail.date");if(el.includes(n)){let t=this._validatorSingleFormula(e.formula2);return{success:i&&t,formula1:i?void 0:a,formula2:t?void 0:a}}return{success:i,formula1:i?void 0:a}}normalizeFormula(e,t,r){let{formula1:n,formula2:i,bizInfo:a}=e,o=/* @__PURE__ */v(e=>{var t;let r;if(!e)return e;if(Number.isNaN(+e)){let n=null==(t=(0,s.numfmt).parseDate(e))?void 0:t.v;if(null==n)return"";r=(0,s.numfmt).dateFromSerial(n)}else r=(0,s.numfmt).dateFromSerial(+e);return ei(`${r[0]}/${r[1]}/${r[2]} ${r[3]}:${r[4]}:${r[5]}`).format(null!=a&&a.showTime?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD")},"normlizeSingleFormula");return{formula1:(0,s.isFormulaString)(n)?n:o(`${n}`),formula2:(0,s.isFormulaString)(i)?i:o(`${i}`)}}transform(e,t,r){let{value:n}=e;return{...e,value:ec(n)}}async validatorIsEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!Number.isNaN(n)||i===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value>=a&&e.value<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value<a||e.value>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<=n}get operatorNames(){return this.operators.map(e=>this.localeService.t(ea[e]))}generateRuleName(e){var t,r;if(!e.operator)return this.titleStr;let n=this.localeService.t(eo[e.operator]).replace(ed,null!=(t=e.formula1)?t:"").replace(eu,null!=(r=e.formula2)?r:"");return`${this.titleStr} ${n}`}generateRuleErrorMessage(e){var t,r;return e.operator?`${this.localeService.t(es[e.operator]).replace(ed,null!=(t=e.formula1)?t:"").replace(eu,null!=(r=e.formula2)?r:"")}`:this.titleStr}};function em(e){let t=e;return"string"==typeof e?((e.startsWith("¥")||e.startsWith("$"))&&(t=e.slice(1)),+t):+e}v(eh,"DateValidator"),v(em,"getCellValueNumber");let ep=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"_formulaService",this.injector.get(A)),_(this,"id",s.DataValidationType.DECIMAL),_(this,"title","dataValidation.decimal.title"),_(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),_(this,"scopes",["sheet"])}_isFormulaOrNumber(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e))}async isValidType(e,t,r){let{value:n}=e;return!Number.isNaN(em(n))}transform(e,t,r){let{value:n}=e;return{...e,value:em(n)}}_parseNumber(e){return null==e?Number.NaN:+e}async parseFormula(e,t,r){var n,i;let a=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:o,formula2:l}=e,d=X(null==(n=null==a?void 0:a[0])?void 0:n.result),u=X(null==(i=null==a?void 0:a[1])?void 0:i.result),c=Z(String(d))&&Z(String(u));return{formula1:this._parseNumber((0,s.isFormulaString)(o)?d:o),formula2:this._parseNumber((0,s.isFormulaString)(l)?u:l),isFormulaValid:c}}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=(0,s.Tools).isDefine(e.formula1)&&this._isFormulaOrNumber(e.formula1),a=(0,s.Tools).isDefine(e.formula2)&&this._isFormulaOrNumber(e.formula2),o=el.includes(n),l=this.localeService.t("dataValidation.validFail.number");return o?{success:i&&a,formula1:i?void 0:l,formula2:a?void 0:l}:{success:i,formula1:i?"":l}}async validatorIsEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!Number.isNaN(n)||i===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value>=a&&e.value<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value<a||e.value>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<=n}};function eg(e){return e.split(",").filter(Boolean)}function ef(e){if(!e)return[];let t=/* @__PURE__ */new Set;return e.forEach(e=>{e.forEach(e=>{var r,n;let i=L(e);if(null!=i){if("string"!=typeof i&&"object"==typeof(null==e?void 0:e.s)&&null!=(n=null==(r=e.s)?void 0:r.n)&&n.pattern){t.add((0,s.numfmt).format(e.s.n.pattern,i,{throws:!1}));return}Z(i.toString())&&t.add(i.toString())}})}),[...t]}v(ep,"DecimalValidator"),v(function(e){return e.filter(Boolean).join(",")},"serializeListOptions"),v(eg,"deserializeListOptions"),v(function(e){let t=L(e);return null==t?"":t.toString()},"getDataValidationCellValue"),v(ef,"getRuleFormulaResultSet");let ev=["if","indirect","choose","offset"];function e_(e,t){if(!(0,s.isFormulaString)(e)||(0,m.isReferenceString)(e.slice(1)))return!0;let r=t.sequenceNodesBuilder(e);return r&&r.some(e=>"object"==typeof e&&e.nodeType===m.sequenceNodeType.FUNCTION&&ev.indexOf(e.token.toLowerCase())>-1)}function eI(e,t){let{formula1:r="",ranges:n}=e;if((0,m.isReferenceString)(r.slice(1))){let e=(0,m.deserializeRangeWithSheet)(r.slice(1));if((!e.sheetName||e.sheetName===t)&&n.some(t=>(0,s.Rectangle).intersects(t,e.range)))return!0}return!1}v(e_,"isValidListFormula"),v(eI,"isRuleIntersects");let eS=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"formulaService",this.injector.get(A)),_(this,"_lexer",this.injector.get(m.LexerTreeBuilder)),_(this,"_univerInstanceService",this.injector.get(s.IUniverInstanceService)),_(this,"id",s.DataValidationType.LIST),_(this,"title","dataValidation.list.title"),_(this,"operators",[]),_(this,"scopes",["sheet"]),_(this,"skipDefaultFontRender",/* @__PURE__ */v(e=>e.renderMode!==s.DataValidationRenderMode.TEXT,"skipDefaultFontRender"))}validatorFormula(e,t,r){var n,i,a;let o=!(0,s.Tools).isBlank(e.formula1),l=e_(null!=(n=e.formula1)?n:"",this._lexer),d=null==(a=null==(i=this._univerInstanceService.getUnit(t,s.UniverInstanceType.UNIVER_SHEET))?void 0:i.getSheetBySheetId(r))?void 0:a.getName(),u=eI(e,null!=d?d:"");return{success:!!(o&&l&&!u),formula1:o?l?u?this.localeService.t("dataValidation.validFail.listIntersects"):void 0:this.localeService.t("dataValidation.validFail.listInvalid"):this.localeService.t("dataValidation.validFail.list")}}getExtraStyle(e,t,{style:r}){var n;let i=null!=(n=r.tb!==s.WrapStrategy.OVERFLOW?r.tb:s.WrapStrategy.CLIP)?n:s.WrapStrategy.WRAP;if(e.type===s.DataValidationType.LIST&&(e.renderMode===s.DataValidationRenderMode.ARROW||e.renderMode===s.DataValidationRenderMode.TEXT)){let r=this.getListWithColorMap(e)[`${null!=t?t:""}`];if(r)return{bg:{rgb:r},tb:i}}return{tb:i}}parseCellValue(e){return eg(e.toString())}async parseFormula(e,t,r){var n,i;let{formula1:a=""}=e,o=await this.formulaService.getRuleFormulaResult(t,r,e.uid),l=Z(String(X(null==(n=null==o?void 0:o[0])?void 0:n.result)));return{formula1:(0,s.isFormulaString)(a)?ef(null==(i=null==o?void 0:o[0])?void 0:i.result):eg(a),formula2:void 0,isFormulaValid:l}}async isValidType(e,t,r){let{value:n}=e,{formula1:i=[]}=t;return this.parseCellValue(n).every(e=>i.includes(e))}generateRuleName(){return this.localeService.t("dataValidation.list.name")}generateRuleErrorMessage(){return this.localeService.t("dataValidation.list.error")}getList(e,t,r){var n,i,a;let{formula1:o=""}=e,l=this.injector.get(s.IUniverInstanceService),d=null!=(n=t?l.getUniverSheetInstance(t):void 0)?n:l.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);if(!d)return[];let u=null!=(i=r?d.getSheetBySheetId(r):void 0)?i:d.getActiveSheet();if(!u)return[];let c=d.getUnitId(),h=u.getSheetId(),m=this.formulaService.getRuleFormulaResultSync(c,h,e.uid);return(0,s.isFormulaString)(o)?ef(null==(a=null==m?void 0:m[0])?void 0:a.result):eg(o)}async getListAsync(e,t,r){var n,i,a;let{formula1:o=""}=e,l=this.injector.get(s.IUniverInstanceService),d=null!=(n=t?l.getUniverSheetInstance(t):void 0)?n:l.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET);if(!d)return[];let u=null!=(i=r?d.getSheetBySheetId(r):void 0)?i:d.getActiveSheet();if(!u)return[];let c=d.getUnitId(),h=u.getSheetId(),m=await this.formulaService.getRuleFormulaResult(c,h,e.uid);return(0,s.isFormulaString)(o)?ef(null==(a=null==m?void 0:m[0])?void 0:a.result):eg(o)}getListWithColor(e,t,r){let n=this.getList(e,t,r),i=(e.formula2||"").split(",");return n.map((e,t)=>({label:e,color:i[t]}))}getListWithColorMap(e,t,r){let n=this.getListWithColor(e,t,r),i={};return n.forEach(e=>{e.color&&(i[e.label]=e.color)}),i}};v(eS,"ListValidator");let eC=eS,ey=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"id",s.DataValidationType.TEXT_LENGTH),_(this,"title","dataValidation.textLength.title"),_(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),_(this,"scopes",["sheet"]),_(this,"_formulaService",this.injector.get(A))}_isFormulaOrInt(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=(0,s.Tools).isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),a=(0,s.Tools).isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),o=el.includes(n),l=this.localeService.t("dataValidation.validFail.number");return o?{success:i&&a,formula1:i?void 0:l,formula2:a?void 0:l}:{success:i,formula1:l}}_parseNumber(e){return null==e?Number.NaN:+e}_isValidFormula(e){return!Number.isNaN(e)}async parseFormula(e,t,r){var n,i;let a=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:o,formula2:l}=e,d=X(null==(n=null==a?void 0:a[0])?void 0:n.result),u=X(null==(i=null==a?void 0:a[1])?void 0:i.result),c=Z(String(d))&&Z(String(u));return{formula1:this._parseNumber((0,s.isFormulaString)(o)?d:o),formula2:this._parseNumber((0,s.isFormulaString)(l)?u:l),isFormulaValid:c}}transform(e,t,r){return{...e,value:e.value.toString().length}}async isValidType(e,t,r){let{value:n}=e;return"string"==typeof n||"number"==typeof n}async validatorIsEqual(e,t,r){let{formula1:n}=t;return!!(0,s.Tools).isDefine(n)&&e.value===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!(0,s.Tools).isDefine(n)&&e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t,{value:a}=e;if(!this._isValidFormula(n)||!this._isValidFormula(i))return!1;let o=Math.max(n,i);return a>=Math.min(n,i)&&a<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t,{value:a}=e;if(!this._isValidFormula(n)||!this._isValidFormula(i))return!1;let o=Math.max(n,i);return a<Math.min(n,i)||a>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!this._isValidFormula(n)&&i<=n}generateRuleErrorMessage(e){var t,r;return e.operator?`${this.localeService.t(l.TextLengthErrorTitleMap[e.operator]).replace("{FORMULA1}",null!=(t=e.formula1)?t:"").replace("{FORMULA2}",null!=(r=e.formula2)?r:"")}`:this.titleStr}};function ew(e){var t,r;return!e||(e.p?!(null!=(r=null==(t=e.p.body)?void 0:t.dataStream)?r:"").slice(0,-2).trim():(0,s.Tools).isBlank(e.v))}function eb(e,t,r,n,i="command",a=!0){let o=n.get(m.LexerTreeBuilder),u=[],c=[],h=n.get(q),p=n.get(s.IUniverInstanceService),g=(0,d.getSheetCommandTarget)(p,{unitId:e,subUnitId:t});if(!g)return{redoMutations:u,undoMutations:c};let{worksheet:f}=g,_=new s.ObjectMatrix;function I(e,t){a&&e.forEach(e=>{(0,s.Range).foreach(e,(e,r)=>{let n=f.getCellRaw(e,r),i=F(n);(ew(n)||i===t)&&_.setValue(e,r,{v:t,p:null})})})}v(I,"setRangesDefaultValue"),r.forEach(r=>{switch(r.type){case"delete":u.push({id:l.RemoveDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.rule.uid,source:i}}),c.unshift({id:l.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:r.rule,index:r.index,source:i}});break;case"update":{if(u.push({id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.ruleId,payload:{type:l.UpdateRuleType.RANGE,payload:r.newRanges},source:i}}),c.unshift({id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.ruleId,payload:{type:l.UpdateRuleType.RANGE,payload:r.oldRanges},source:i}}),r.rule.type===s.DataValidationType.CUSTOM){let n=r.oldRanges[0].startRow,i=r.oldRanges[0].startColumn,a=r.newRanges[0].startRow,s=r.newRanges[0].startColumn,d=o.moveFormulaRefOffset(r.rule.formula1,s-i,a-n);d!==r.rule.formula1&&(u.push({id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.ruleId,payload:{type:l.UpdateRuleType.SETTING,payload:{...(0,l.getRuleSetting)(r.rule),formula1:d}}}}),c.unshift({id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.ruleId,payload:{type:l.UpdateRuleType.SETTING,payload:(0,l.getRuleSetting)(r.rule)}}}))}let n=h.getRuleById(e,t,r.ruleId);if(n&&n.type===s.DataValidationType.CHECKBOX){let i=h.getValidator(s.DataValidationType.CHECKBOX).parseFormulaSync(n,e,t);I(r.newRanges,i.formula2)}break}case"add":if(u.push({id:l.AddDataValidationMutation.id,params:{unitId:e,subUnitId:t,rule:r.rule,source:i}}),c.unshift({id:l.RemoveDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.rule.uid,source:i}}),r.rule.type===s.DataValidationType.CHECKBOX){let n=h.getValidator(s.DataValidationType.CHECKBOX).parseFormulaSync(r.rule,e,t);I(r.rule.ranges,n.originFormula2)}}});let S={id:d.SetRangeValuesMutation.id,params:{unitId:e,subUnitId:t,cellValue:_.getData()}},C={id:d.SetRangeValuesMutation.id,params:(0,d.SetRangeValuesUndoMutationFactory)(n,S.params)};return u.push(S),c.push(C),{redoMutations:u,undoMutations:c}}v(ey,"TextLengthValidator"),v(ew,"isBlankCell"),v(eb,"getDataValidationDiffMutations");let eR={type:s.CommandType.COMMAND,id:"sheet.command.updateDataValidationRuleRange",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ranges:i,ruleId:a}=t,o=e.get(q),l=e.get(s.ICommandService),d=e.get(s.IUndoRedoService);if(!o.getRuleById(r,n,a))return!1;let u=o.getRuleObjectMatrix(r,n).clone();u.updateRange(a,i);let c=u.diff(o.getRules(r,n)),{redoMutations:h,undoMutations:m}=eb(r,n,c,e);return d.pushUndoRedo({undoMutations:m,redoMutations:h,unitID:r}),(0,s.sequenceExecute)(h,l),!0}},eE={type:s.CommandType.COMMAND,id:"sheet.command.addDataValidation",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,rule:i}=t,a=e.get(q),o=e.get(s.ICommandService),d=e.get(s.IUndoRedoService),u=a.getRuleObjectMatrix(r,n).clone();u.addRule(i);let c=u.diff(a.getRules(r,n)),{redoMutations:h,undoMutations:m}=eb(r,n,c,e);return h.push({id:l.AddDataValidationMutation.id,params:{unitId:r,subUnitId:n,rule:i}}),m.unshift({id:l.RemoveDataValidationMutation.id,params:{unitId:r,subUnitId:n,ruleId:i.uid}}),d.pushUndoRedo({unitID:r,redoMutations:h,undoMutations:m}),(0,s.sequenceExecute)(h,o),!0}},eT={type:s.CommandType.COMMAND,id:"sheets.command.update-data-validation-setting",handler(e,t){if(!t)return!1;let r=e.get(s.ICommandService),n=e.get(s.IUndoRedoService),i=e.get(q),a=e.get(l.DataValidatorRegistryService),{unitId:o,subUnitId:u,ruleId:c,setting:h}=t,m=a.getValidatorItem(h.type);if(!m)return!1;let p=i.getRuleById(o,u,c);if(!p)return!1;let g={...p,...h};if(!m.validatorFormula(g,o,u).success)return!1;let f={unitId:o,subUnitId:u,ruleId:c,payload:{type:l.UpdateRuleType.SETTING,payload:{...h,...m.normalizeFormula(g,o,u)}}},v=[{id:l.UpdateDataValidationMutation.id,params:f}],_={unitId:o,subUnitId:u,ruleId:c,payload:{type:l.UpdateRuleType.SETTING,payload:(0,l.getRuleSetting)(p)}},I=[{id:l.UpdateDataValidationMutation.id,params:_}];if(h.type===s.DataValidationType.CHECKBOX){let t=p.ranges,r=e.get(s.IUniverInstanceService),n=(0,d.getSheetCommandTarget)(r,{unitId:o,subUnitId:u});if(n){let r=new s.ObjectMatrix,{worksheet:i}=n,{formula2:a=0,formula1:l=1}=p,{formula2:c=0,formula1:m=1}=h;t.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let n=i.getCellRaw(e,t),o=F(n);ew(n)||o===String(a)?r.setValue(e,t,{v:c,p:null}):o===String(l)&&r.setValue(e,t,{v:m,p:null})})});let g={id:d.SetRangeValuesMutation.id,params:{unitId:o,subUnitId:u,cellValue:r.getData()}},f={id:d.SetRangeValuesMutation.id,params:(0,d.SetRangeValuesUndoMutationFactory)(e,g.params)};v.push(g),I.push(f)}}return!!(0,s.sequenceExecute)(v,r).result&&(n.pushUndoRedo({unitID:o,redoMutations:v,undoMutations:I}),!0)}},eM={type:s.CommandType.COMMAND,id:"sheets.command.update-data-validation-options",handler(e,t){if(!t)return!1;let r=e.get(s.ICommandService),n=e.get(s.IUndoRedoService),i=e.get(q),{unitId:a,subUnitId:o,ruleId:d,options:u}=t,c=i.getRuleById(a,o,d);if(!c)return!1;let h={unitId:a,subUnitId:o,ruleId:d,payload:{type:l.UpdateRuleType.OPTIONS,payload:u}},m=[{id:l.UpdateDataValidationMutation.id,params:h}],p={unitId:a,subUnitId:o,ruleId:d,payload:{type:l.UpdateRuleType.OPTIONS,payload:(0,l.getRuleOptions)(c)}},g=[{id:l.UpdateDataValidationMutation.id,params:p}];return n.pushUndoRedo({unitID:a,redoMutations:m,undoMutations:g}),r.executeCommand(l.UpdateDataValidationMutation.id,h),!0}},eO={type:s.CommandType.COMMAND,id:"sheets.command.clear-range-data-validation",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ranges:i}=t,a=e.get(s.ICommandService),o=e.get(s.IUniverInstanceService),l=(0,d.getSheetCommandTarget)(o,{unitId:r,subUnitId:n}),u=e.get(q);if(!l)return!1;let c=e.get(s.IUndoRedoService),h=u.getRuleObjectMatrix(r,n).clone();h.removeRange(i);let m=h.diff(u.getRules(r,n)),{redoMutations:p,undoMutations:g}=eb(r,n,m,e);return c.pushUndoRedo({unitID:r,redoMutations:p,undoMutations:g}),(0,s.sequenceExecute)(p,a).result}},eD={type:s.CommandType.COMMAND,id:"sheet.command.remove-all-data-validation",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n}=t,i=e.get(s.ICommandService),a=e.get(q),o=e.get(s.IUndoRedoService),d=[...a.getRules(r,n)],u={unitId:r,subUnitId:n,ruleId:d.map(e=>e.uid)},c=[{id:l.RemoveDataValidationMutation.id,params:u}],h=[{id:l.AddDataValidationMutation.id,params:{unitId:r,subUnitId:n,rule:d}}];return o.pushUndoRedo({redoMutations:c,undoMutations:h,unitID:r}),i.executeCommand(l.RemoveDataValidationMutation.id,u),!0}},eU=/* @__PURE__ */v((e,t)=>{let r=e.get(q),{unitId:n,subUnitId:i,ruleId:a,source:o}=t;if(Array.isArray(a)){let e=a.map(e=>r.getRuleById(n,i,e)).filter(Boolean);return[{id:l.AddDataValidationMutation.id,params:{unitId:n,subUnitId:i,rule:e,source:o}}]}return[{id:l.AddDataValidationMutation.id,params:{unitId:n,subUnitId:i,rule:{...r.getRuleById(n,i,a)},index:r.getRuleIndex(n,i,a)}}]},"removeDataValidationUndoFactory"),ek={type:s.CommandType.COMMAND,id:"sheet.command.remove-data-validation-rule",handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,ruleId:i}=t,a=e.get(s.ICommandService),o=e.get(s.IUndoRedoService),d=e.get(q),u=[{id:l.RemoveDataValidationMutation.id,params:t}],c=[{id:l.AddDataValidationMutation.id,params:{unitId:r,subUnitId:n,rule:{...d.getRuleById(r,n,i)},index:d.getRuleIndex(r,n,i)}}];return o.pushUndoRedo({undoMutations:c,redoMutations:u,unitID:t.unitId}),a.executeCommand(l.RemoveDataValidationMutation.id,t),!0}},eP={},eN=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"id",s.DataValidationType.ANY),_(this,"title","dataValidation.any.title"),_(this,"operators",[]),_(this,"scopes",["sheet"])}async parseFormula(e,t,r){return{formula1:e.formula1,formula2:e.formula2,isFormulaValid:!0}}validatorFormula(e,t,r){return{success:!0}}async isValidType(e,t,r){return!0}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.any.error")}};v(eN,"AnyValidator");let ex=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"id",s.DataValidationType.CUSTOM),_(this,"title","dataValidation.custom.title"),_(this,"operators",[]),_(this,"scopes",["sheet"]),_(this,"_customFormulaService",this.injector.get(O))}validatorFormula(e,t,r){let n=(0,s.isFormulaString)(e.formula1);return{success:n,formula1:n?"":this.localeService.t("dataValidation.validFail.formula")}}async parseFormula(e,t,r){return{formula1:void 0,formula2:void 0,isFormulaValid:!1}}async isValidType(e,t,r){let{column:n,row:i,unitId:a,subUnitId:o}=e,l=await this._customFormulaService.getCellFormulaValue(a,o,i,n),d=Q(null==l?void 0:l.result),u=null==d?void 0:d.v;return!!(Z(String(u))&&(0,s.Tools).isDefine(u))&&""!==u&&(d.t===s.CellValueType.BOOLEAN?!!u:"boolean"==typeof u?u:"number"==typeof u?!!u:"string"==typeof u?Z(u):!!u)}generateRuleErrorMessage(e){return this.localeService.t("dataValidation.custom.error")}generateRuleName(e){var t;return this.localeService.t("dataValidation.custom.ruleName").replace("{FORMULA1}",null!=(t=e.formula1)?t:"")}};v(ex,"CustomFormulaValidator");let eA=class extends eC{constructor(){super(...arguments),_(this,"id",s.DataValidationType.LIST_MULTIPLE),_(this,"title","dataValidation.listMultiple.title"),_(this,"skipDefaultFontRender",/* @__PURE__ */v(()=>!0,"skipDefaultFontRender"))}};v(eA,"ListMultipleValidator");let eL=class extends l.BaseDataValidator{constructor(){super(...arguments),_(this,"_formulaService",this.injector.get(A)),_(this,"id",s.DataValidationType.WHOLE),_(this,"title","dataValidation.whole.title"),_(this,"operators",[s.DataValidationOperator.BETWEEN,s.DataValidationOperator.EQUAL,s.DataValidationOperator.GREATER_THAN,s.DataValidationOperator.GREATER_THAN_OR_EQUAL,s.DataValidationOperator.LESS_THAN,s.DataValidationOperator.LESS_THAN_OR_EQUAL,s.DataValidationOperator.NOT_BETWEEN,s.DataValidationOperator.NOT_EQUAL]),_(this,"scopes",["sheet"])}_isFormulaOrInt(e){return!(0,s.Tools).isBlank(e)&&((0,s.isFormulaString)(e)||!Number.isNaN(+e)&&Number.isInteger(+e))}async isValidType(e,t,r){let{value:n}=e,i=em(n);return!Number.isNaN(i)&&Number.isInteger(i)}transform(e,t,r){let{value:n}=e;return{...e,value:em(n)}}_parseNumber(e){return null==e?Number.NaN:+e}async parseFormula(e,t,r){var n,i,a,o,l,d,u,c;let h=await this._formulaService.getRuleFormulaResult(t,r,e.uid),{formula1:m,formula2:p}=e,g=(0,s.isFormulaString)(m)?null==(o=null==(a=null==(i=null==(n=null==h?void 0:h[0])?void 0:n.result)?void 0:i[0])?void 0:a[0])?void 0:o.v:m,f=(0,s.isFormulaString)(p)?null==(c=null==(u=null==(d=null==(l=null==h?void 0:h[1])?void 0:l.result)?void 0:d[0])?void 0:u[0])?void 0:c.v:p,v=Z(`${g}`)&&Z(`${f}`);return{formula1:this._parseNumber(g),formula2:this._parseNumber(f),isFormulaValid:v}}validatorFormula(e,t,r){let n=e.operator;if(!n)return{success:!1};let i=(0,s.Tools).isDefine(e.formula1)&&this._isFormulaOrInt(e.formula1),a=(0,s.Tools).isDefine(e.formula2)&&this._isFormulaOrInt(e.formula2),o=el.includes(n),l=this.localeService.t("dataValidation.validFail.number");return o?{success:i&&a,formula1:i?void 0:l,formula2:a?void 0:l}:{success:i,formula1:l}}async validatorIsEqual(e,t,r){let{formula1:n}=t,{value:i}=e;return!!Number.isNaN(n)||i===n}async validatorIsNotEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value!==n}async validatorIsBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value>=a&&e.value<=o}async validatorIsNotBetween(e,t,r){let{formula1:n,formula2:i}=t;if(Number.isNaN(n)||Number.isNaN(i))return!0;let a=Math.min(n,i),o=Math.max(n,i);return e.value<a||e.value>o}async validatorIsGreaterThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>n}async validatorIsGreaterThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value>=n}async validatorIsLessThan(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<n}async validatorIsLessThanOrEqual(e,t,r){let{formula1:n}=t;return!!Number.isNaN(n)||e.value<=n}};v(eL,"WholeValidator");var eF,ej,eV=Object.defineProperty,eH=Object.getOwnPropertyDescriptor,e$=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eH(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eV(t,r,a),a},"__decorateClass$5"),eB=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let eW=(ej=class extends s.RxDisposable{constructor(e,t,r,n,i,a){super(),this._univerInstanceService=e,this._dataValidatorRegistryService=t,this._injector=r,this._selectionManagerService=n,this._sheetInterceptorService=i,this._sheetDataValidationModel=a,this._init()}_init(){this._registerValidators(),this._initCommandInterceptor()}_registerValidators(){[eN,ep,eL,ey,eh,et,eC,eA,ex].forEach(e=>{let t=this._injector.createInstance(e);this.disposeWithMe(this._dataValidatorRegistryService.register(t)),this.disposeWithMe((0,s.toDisposable)(()=>this._injector.delete(e)))})}_initCommandInterceptor(){this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */v(e=>{var t;if(e.id===d.ClearSelectionAllCommand.id){let e=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),r=e.getUnitId(),n=e.getActiveSheet();if(!n)throw Error("No active sheet found");let i=n.getSheetId(),a=null==(t=this._selectionManagerService.getCurrentSelections())?void 0:t.map(e=>e.range),o=this._sheetDataValidationModel.getRuleObjectMatrix(r,i).clone();a&&o.removeRange(a);let l=o.diff(this._sheetDataValidationModel.getRules(r,i)),{redoMutations:d,undoMutations:u}=eb(r,i,l,this._injector,"patched");return{undos:u,redos:d}}return{undos:[],redos:[]}},"getMutations")})}},v(ej,"DataValidationController"),ej);eW=e$([eB(0,s.IUniverInstanceService),eB(1,(0,s.Inject)(l.DataValidatorRegistryService)),eB(2,(0,s.Inject)(s.Injector)),eB(3,(0,s.Inject)(d.SheetsSelectionsService)),eB(4,(0,s.Inject)(d.SheetInterceptorService)),eB(5,(0,s.Inject)(q))],eW);var eG,ez=((a=ez||{})[a.View=0]="View",a[a.Edit=1]="Edit",a[a.ManageCollaborator=2]="ManageCollaborator",a[a.Print=3]="Print",a[a.Duplicate=4]="Duplicate",a[a.Comment=5]="Comment",a[a.Copy=6]="Copy",a[a.Share=7]="Share",a[a.Export=8]="Export",a[a.MoveWorksheet=9]="MoveWorksheet",a[a.DeleteWorksheet=10]="DeleteWorksheet",a[a.HideWorksheet=11]="HideWorksheet",a[a.RenameWorksheet=12]="RenameWorksheet",a[a.CreateWorksheet=13]="CreateWorksheet",a[a.SetWorksheetStyle=14]="SetWorksheetStyle",a[a.EditWorksheetCell=15]="EditWorksheetCell",a[a.InsertHyperlink=16]="InsertHyperlink",a[a.Sort=17]="Sort",a[a.Filter=18]="Filter",a[a.PivotTable=19]="PivotTable",a[a.FloatImg=20]="FloatImg",a[a.History=21]="History",a[a.RwHgtClWdt=22]="RwHgtClWdt",a[a.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",a[a.ViewFilter=24]="ViewFilter",a[a.MoveSheet=25]="MoveSheet",a[a.DeleteSheet=26]="DeleteSheet",a[a.HideSheet=27]="HideSheet",a[a.CopySheet=28]="CopySheet",a[a.RenameSheet=29]="RenameSheet",a[a.CreateSheet=30]="CreateSheet",a[a.SelectProtectedCells=31]="SelectProtectedCells",a[a.SelectUnProtectedCells=32]="SelectUnProtectedCells",a[a.SetCellStyle=33]="SetCellStyle",a[a.SetCellValue=34]="SetCellValue",a[a.SetRowStyle=35]="SetRowStyle",a[a.SetColumnStyle=36]="SetColumnStyle",a[a.InsertRow=37]="InsertRow",a[a.InsertColumn=38]="InsertColumn",a[a.DeleteRow=39]="DeleteRow",a[a.DeleteColumn=40]="DeleteColumn",a[a.EditExtraObject=41]="EditExtraObject",a[a.Delete=42]="Delete",a[a.RecoverHistory=43]="RecoverHistory",a[a.ViewHistory=44]="ViewHistory",a[a.CreatePermissionObject=45]="CreatePermissionObject",a[a.UNRECOGNIZED=-1]="UNRECOGNIZED",a),eY=Object.defineProperty,eK=Object.getOwnPropertyDescriptor,eq=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eK(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eY(t,r,a),a},"__decorateClass$4"),eX=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let eQ=(v(eG=class extends s.Disposable{constructor(e,t,r){super(),this._univerInstanceService=e,this._permissionService=t,this._lexerTreeBuilder=r}getFormulaRefCheck(e){var t,r;let n=this._lexerTreeBuilder.sequenceNodesBuilder(e);if(!n)return!0;for(let e=0;e<n.length;e++){let i=n[e];if("string"==typeof i)continue;let{token:a}=i,o=(0,m.deserializeRangeWithSheetWithCache)(a),l=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),u=l.getActiveSheet(),c=l.getUnitId();if(o.sheetName){if(!(u=l.getSheetBySheetName(o.sheetName)))return!1;let e=null==u?void 0:u.getSheetId();if(!this._permissionService.getPermissionPoint(new d.WorksheetViewPermission(c,e).id))return!1}if(!u)return!1;let{startRow:h,endRow:p,startColumn:g,endColumn:f}=o.range;for(let e=h;e<=p;e++)for(let n=g;n<=f;n++){let i=null==(r=null==(t=u.getCell(e,n))?void 0:t.selectionProtection)?void 0:r[0];if((null==i?void 0:i[ez.View])===!1)return!1}}return!0}},"DataValidationFormulaController"),eG);eQ=eq([eX(0,s.IUniverInstanceService),eX(1,s.IPermissionService),eX(2,(0,s.Inject)(m.LexerTreeBuilder))],eQ);var eZ,eJ=Object.defineProperty,e1=Object.getOwnPropertyDescriptor,e0=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e1(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eJ(t,r,a),a},"__decorateClass$3"),e3=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let e2=(eZ=class extends s.Disposable{constructor(e,t,r,n,i,a){super(),_(this,"_disposableMap",/* @__PURE__ */new Map),_(this,"registerRule",/* @__PURE__ */v((e,t,r)=>{this.register(e,t,r),this.registerFormula(e,t,r)},"registerRule")),this._dataValidationModel=e,this._injector=t,this._refRangeService=r,this._dataValidationCustomFormulaService=n,this._dataValidationFormulaService=i,this._formulaRefRangeService=a,this._initRefRange()}_getIdWithUnitId(e,t,r){return`${e}_${t}_${r}`}registerFormula(e,t,r){var n;let i=r.uid,a=this._getIdWithUnitId(e,t,i),o=null!=(n=this._disposableMap.get(a))?n:/* @__PURE__ */new Set,d=/* @__PURE__ */v((n,a)=>{let o=this._dataValidationModel.getRuleById(e,t,i);if(!o)return{redos:[],undos:[]};let s=o[n];if(!s||s===a)return{redos:[],undos:[]};let d={unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.SETTING,payload:{type:o.type,formula1:o.formula1,formula2:o.formula2,[n]:a}}},u={unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.SETTING,payload:{type:o.type,formula1:o.formula1,formula2:o.formula2}}};return{redos:[{id:l.UpdateDataValidationMutation.id,params:d}],undos:[{id:l.UpdateDataValidationMutation.id,params:u}]}},"handleFormulaChange");if(r.type===s.DataValidationType.CUSTOM){let r=this._dataValidationCustomFormulaService.getRuleFormulaInfo(e,t,i);if(r){let n=this._formulaRefRangeService.registerFormula(e,t,r.formula,e=>d("formula1",e));o.add(()=>n.dispose())}}else{let r=this._dataValidationFormulaService.getRuleFormulaInfo(e,t,i);if(r){let[n,i]=r;if(n){let r=this._formulaRefRangeService.registerFormula(e,t,n.text,e=>d("formula1",e));o.add(()=>r.dispose())}if(i){let r=this._formulaRefRangeService.registerFormula(e,t,i.text,e=>d("formula2",e));o.add(()=>r.dispose())}}}}register(e,t,r){var n;let i=/* @__PURE__ */v(n=>{let i=[...r.ranges],a=i.map(e=>(0,d.handleCommonDefaultRangeChangeWithEffectRefCommands)(e,n)).filter(e=>!!e).flat();if((0,s.isRangesEqual)(a,i))return{redos:[],undos:[]};if(a.length){let n={unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.RANGE,payload:a},source:"patched"};return{redos:[{id:l.UpdateDataValidationMutation.id,params:n}],undos:[{id:l.UpdateDataValidationMutation.id,params:{unitId:e,subUnitId:t,ruleId:r.uid,payload:{type:l.UpdateRuleType.RANGE,payload:i},source:"patched"}}]}}{let n={unitId:e,subUnitId:t,ruleId:r.uid};return{redos:[{id:l.RemoveDataValidationMutation.id,params:n}],undos:eU(this._injector,n)}}},"handleRangeChange"),a=[];r.ranges.forEach(r=>{let n=this._refRangeService.registerRefRange(r,i,e,t);a.push(()=>n.dispose())});let o=this._getIdWithUnitId(e,t,r.uid),u=null!=(n=this._disposableMap.get(o))?n:/* @__PURE__ */new Set;u.add(()=>a.forEach(e=>e())),this._disposableMap.set(o,u)}_initRefRange(){for(let[e,t]of this._dataValidationModel.getAll())for(let[r,n]of t)for(let t of n)this.registerRule(e,r,t);this.disposeWithMe(this._dataValidationModel.ruleChange$.subscribe(e=>{let{unitId:t,subUnitId:r,rule:n}=e;switch(e.type){case"add":{let t=e.rule;this.registerRule(e.unitId,e.subUnitId,t);break}case"remove":{let e=this._disposableMap.get(this._getIdWithUnitId(t,r,n.uid));e&&e.forEach(e=>e());break}case"update":{let n=e.rule,i=this._disposableMap.get(this._getIdWithUnitId(t,r,n.uid));i&&i.forEach(e=>e()),this.registerRule(e.unitId,e.subUnitId,n)}}})),this.disposeWithMe((0,s.toDisposable)(()=>{this._disposableMap.forEach(e=>{e.forEach(e=>e())}),this._disposableMap.clear()}))}},v(eZ,"DataValidationRefRangeController"),eZ);e2=e0([e3(0,(0,s.Inject)(q)),e3(1,(0,s.Inject)(s.Injector)),e3(2,(0,s.Inject)(d.RefRangeService)),e3(3,(0,s.Inject)(O)),e3(4,(0,s.Inject)(A)),e3(5,(0,s.Inject)(p.FormulaRefRangeService))],e2);var e4,e6=Object.defineProperty,e9=Object.getOwnPropertyDescriptor,e5=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e9(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e6(t,r,a),a},"__decorateClass$2"),e8=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let e7=(e4=class extends s.Disposable{constructor(e,t,r){super(),this._sheetInterceptorService=e,this._univerInstanceService=t,this._sheetDataValidationModel=r,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */v(e=>{var t;if(e.id===d.RemoveSheetCommand.id){let r=e.params,n=r.unitId||this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET).getUnitId(),i=this._univerInstanceService.getUniverSheetInstance(n);if(!i)return{redos:[],undos:[]};let a=r.subUnitId||(null==(t=i.getActiveSheet())?void 0:t.getSheetId());if(!a)return{redos:[],undos:[]};let o=this._sheetDataValidationModel.getRules(n,a);if(0===o.length)return{redos:[],undos:[]};let d=o.map(e=>e.uid),u={unitId:n,subUnitId:a,rule:[...o],source:"patched"};return{redos:[{id:l.RemoveDataValidationMutation.id,params:{unitId:n,subUnitId:a,ruleId:d,source:"patched"}}],undos:[{id:l.AddDataValidationMutation.id,params:u}]}}return{redos:[],undos:[]}},"getMutations")}))}},v(e4,"SheetDataValidationSheetController"),e4);e7=e5([e8(0,(0,s.Inject)(d.SheetInterceptorService)),e8(1,(0,s.Inject)(s.IUniverInstanceService)),e8(2,(0,s.Inject)(q))],e7);var te,tt=Object.defineProperty,tr=Object.getOwnPropertyDescriptor,tn=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tr(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tt(t,r,a),a},"__decorateClass$1"),ti=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let ta=(te=class extends s.Disposable{constructor(e,t,r,n){super(),this._univerInstanceService=e,this._sheetDataValidationModel=t,this._dataValidationCacheService=r,this._lifecycleService=n,this._initRecalculate()}_initRecalculate(){let e=/* @__PURE__ */v(e=>{if(0===e.length)return;let t=this._univerInstanceService.getCurrentUnitForType(s.UniverInstanceType.UNIVER_SHEET),r=null==t?void 0:t.getActiveSheet(),n={};e.flat().forEach(e=>{n[e.unitId]||(n[e.unitId]={}),n[e.unitId][e.subUnitId]||(n[e.unitId][e.subUnitId]=[]);let t=this._univerInstanceService.getUnit(e.unitId,s.UniverInstanceType.UNIVER_SHEET),r=null==t?void 0:t.getSheetBySheetId(e.subUnitId);r&&n[e.unitId][e.subUnitId].push(...e.ranges.map(e=>(0,s.Range).transformRange(e,r)))}),Object.entries(n).forEach(([e,n])=>{Object.entries(n).forEach(([n,i])=>{(null==t?void 0:t.getUnitId())===e&&(null==r?void 0:r.getSheetId())===n?this.validatorRanges(e,n,i):requestIdleCallback(()=>{this.validatorRanges(e,n,i)})})})},"handleDirtyRanges");this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe((0,u.bufferWhen)(()=>this._lifecycleService.lifecycle$.pipe((0,c.filter)(e=>e===s.LifecycleStages.Rendered)))).subscribe(e)),this.disposeWithMe(this._dataValidationCacheService.dirtyRanges$.pipe((0,c.filter)(()=>this._lifecycleService.stage>=s.LifecycleStages.Rendered),(0,s.bufferDebounceTime)(20)).subscribe(e))}async validatorCell(e,t,r,n){let i=this._univerInstanceService.getUnit(e,s.UniverInstanceType.UNIVER_SHEET);if(!i)throw Error(`cannot find current workbook, unitId: ${e}`);let a=i.getSheetBySheetId(t);if(!a)throw Error(`cannot find current worksheet, sheetId: ${t}`);if(!(0,s.Tools).isDefine(r)||!(0,s.Tools).isDefine(n))throw Error(`row or col is not defined, row: ${r}, col: ${n}`);let o=this._sheetDataValidationModel.getRuleByLocation(e,t,r,n);return o?new Promise(s=>{this._sheetDataValidationModel.validator(o,{unitId:e,subUnitId:t,row:r,col:n,worksheet:a,workbook:i},e=>{s(e)})}):s.DataValidationStatus.VALID}validatorRanges(e,t,r){return Promise.all(r.map(r=>{let n=[];return(0,s.Range).foreach(r,(r,i)=>{n.push(this.validatorCell(e,t,r,i))}),n}))}async validatorWorksheet(e,t){let r=this._sheetDataValidationModel.getRules(e,t);return await Promise.all(r.map(r=>Promise.all(r.ranges.map(r=>{let n=[];return(0,s.Range).foreach(r,(r,i)=>{n.push(this.validatorCell(e,t,r,i))}),n})))),this._dataValidationCacheService.ensureCache(e,t)}async validatorWorkbook(e){let t=this._sheetDataValidationModel.getSubUnitIds(e),r=await Promise.all(t.map(t=>this.validatorWorksheet(e,t))),n={};return r.forEach((e,r)=>{n[t[r]]=e}),n}getDataValidations(e,t,r){let n=this._sheetDataValidationModel.getRuleObjectMatrix(e,t),i=/* @__PURE__ */new Set;return r.forEach(e=>{(0,s.Range).foreach(e,(e,t)=>{let r=n.getValue(e,t);r&&i.add(r)})}),Array.from(i).map(r=>this._sheetDataValidationModel.getRuleById(e,t,r)).filter(Boolean)}getDataValidation(e,t,r){return this.getDataValidations(e,t,r)[0]}},v(te,"SheetsDataValidationValidatorService"),te);ta=tn([ti(0,s.IUniverInstanceService),ti(1,(0,s.Inject)(q)),ti(2,(0,s.Inject)(w)),ti(3,(0,s.Inject)(s.LifecycleService))],ta);var to,ts=Object.defineProperty,tl=Object.getOwnPropertyDescriptor,td=/* @__PURE__ */v((e,t,r)=>t in e?ts(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),tu=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tl(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ts(t,r,a),a},"__decorateClass"),tc=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),th=/* @__PURE__ */v((e,t,r)=>td(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let tm=(v(to=class extends s.Plugin{constructor(e=eP,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{...i}=this._config;this._configService.setConfig("sheets-data-validation.config",i)}onStarting(){[[w],[A],[O],[ta],[q],[eW],[e2],[eQ],[e7]].forEach(e=>{this._injector.add(e)}),[eE,eR,eT,eM,ek,eD,eO].forEach(e=>{this._commandService.registerCommand(e)}),this._injector.get(w),this._injector.get(ta),this._injector.get(e2)}onReady(){this._injector.get(e7)}onRendered(){this._injector.get(eW),this._injector.get(eQ)}},"UniverSheetsDataValidationPlugin"),to);th(tm,"pluginName","SHEET_DATA_VALIDATION_PLUGIN"),th(tm,"type",s.UniverInstanceType.UNIVER_SHEET),tm=tu([(0,s.DependentOn)(l.UniverDataValidationPlugin),tc(1,(0,s.Inject)(s.Injector)),tc(2,s.ICommandService),tc(3,s.IConfigService)],tm),v(function(e){let t=e.get(d.SheetsSelectionsService).getCurrentSelections().map(e=>e.range);return{uid:(0,s.Tools).generateRandomId(6),type:s.DataValidationType.DECIMAL,operator:s.DataValidationOperator.EQUAL,formula1:"100",ranges:null!=t?t:[{startColumn:0,endColumn:0,startRow:0,endRow:0}]}},"createDefaultNewRule")}),i("kRhbk",function(t,r){e(t.exports,"bufferWhen",function(){return l});var i=n("jSzwf"),a=n("f1euv"),o=n("iNetn"),s=n("b7gpN");function l(e){return(0,i.operate)(function(t,r){var n=null,i=null,l=function(){null==i||i.unsubscribe();var t=n;n=[],t&&r.next(t),(0,s.innerFrom)(e()).subscribe(i=(0,o.createOperatorSubscriber)(r,l,a.noop))};l(),t.subscribe((0,o.createOperatorSubscriber)(r,function(e){return null==n?void 0:n.push(e)},function(){n&&r.next(n),r.complete()},void 0,function(){return n=i=null}))})}}),i("gwMUy",function(t,r){let i;e(t.exports,"SetSheetsFilterRangeMutation",function(){return f}),e(t.exports,"SheetsFilterService",function(){return et}),e(t.exports,"SetSheetsFilterCriteriaMutation",function(){return v}),e(t.exports,"RemoveSheetsFilterMutation",function(){return _}),e(t.exports,"ReCalcSheetsFilterMutation",function(){return I}),e(t.exports,"CustomFilterOperator",function(){return S}),e(t.exports,"FILTER_MUTATIONS",function(){return J}),e(t.exports,"UniverSheetsFilterPlugin",function(){return ev});var a=n("7yNYd"),o=n("5LPkb"),s=n("lMvMU"),l=n("i54iF"),d=n("3yupB"),u=n("23cfA"),c=n("ejawP"),h=Object.defineProperty,m=(e,t,r)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,p=(e,t)=>h(e,"name",{value:t,configurable:!0}),g=(e,t,r)=>m(e,"symbol"!=typeof t?t+"":t,r);let f={id:"sheet.mutation.set-filter-range",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{subUnitId:r,unitId:n,range:i}=t;return e.get(et).ensureFilterModel(n,r).setRange(i),!0},"handler")},v={id:"sheet.mutation.set-filter-criteria",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{subUnitId:r,unitId:n,criteria:i,col:a,reCalc:o=!0}=t,s=e.get(et).getFilterModel(n,r);return!!s&&(s.setCriteria(a,i,o),!0)},"handler")},_={id:"sheet.mutation.remove-filter",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{unitId:r,subUnitId:n}=t;return e.get(et).removeFilterModel(r,n)},"handler")},I={id:"sheet.mutation.re-calc-filter",type:a.CommandType.MUTATION,handler:/* @__PURE__ */p((e,t)=>{let{unitId:r,subUnitId:n}=t,i=e.get(et).getFilterModel(r,n);return!!i&&(i.reCalc(),!0)},"handler")};var S=((i=S||{}).EQUAL="equal",i.GREATER_THAN="greaterThan",i.GREATER_THAN_OR_EQUAL="greaterThanOrEqual",i.LESS_THAN="lessThan",i.LESS_THAN_OR_EQUAL="lessThanOrEqual",i.NOT_EQUALS="notEqual",i);let C={operator:S.GREATER_THAN,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e>t,"fn")},y={operator:S.GREATER_THAN_OR_EQUAL,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e>=t,"fn")},w={operator:S.LESS_THAN,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e<t,"fn")},b={operator:S.LESS_THAN_OR_EQUAL,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e<=t,"fn")},R={operator:S.EQUAL,fn:/* @__PURE__ */p((e,t)=>!!U(e)&&e===t,"fn")},E={operator:S.NOT_EQUALS,fn:/* @__PURE__ */p((e,t)=>{if("string"==typeof t){if(" "===t)return null!=e;let r=P(e);return r&&N(t)?!x(t).test(r):r!==t}return!U(e)||e!==t},"fn")},T=/* @__PURE__ */new Map([]);function M(e){return!!e}[C,y,w,b,R,E].forEach(e=>{T.set(e.operator,e)}),p(M,"isNumericFilterFn");let O={fn:/* @__PURE__ */p((e,t)=>{let r=P(e);return null===r?""===t:x(t).test(r)},"fn")};function D(e){return e?T.get(e):O}function U(e){return"number"==typeof e}function k(e){return!!("number"==typeof e||"string"==typeof e&&(0,a.isNumeric)(e))}function P(e){return"boolean"==typeof e||null==e?null:"string"==typeof e?e:e.toString()}function N(e){return"number"!=typeof e&&(-1!==e.indexOf("*")||-1!==e.indexOf("?"))}function x(e){let t=e.replace(/[.+^${}()|[\]\\]/g,"\\$&").replaceAll("?",".").replace(/[*]/g,".$&");return RegExp(`^${t}$`)}p(D,"getCustomFilterFn"),p(U,"ensureNumber"),p(k,"ensureNumeric"),p(P,"ensureString"),p(N,"isWildCardString"),p(x,"createREGEXFromWildChar");let A=/* @__PURE__ */p(()=>/* @__PURE__ */new Set,"EMPTY"),L=class e extends a.Disposable{constructor(e,t,r){super(),g(this,"_filteredOutRows$",new o.BehaviorSubject(A())),g(this,"filteredOutRows$",this._filteredOutRows$.asObservable()),g(this,"_hasCriteria$",new o.BehaviorSubject(!1)),g(this,"hasCriteria$",this._hasCriteria$.asObservable()),g(this,"_filterColumnByIndex",/* @__PURE__ */new Map),g(this,"_alreadyFilteredOutRows",A()),g(this,"_range"),this.unitId=e,this.subUnitId=t,this._worksheet=r}get filteredOutRows(){return this._filteredOutRows$.getValue()}set filteredOutRows(e){this._alreadyFilteredOutRows=e,this._filteredOutRows$.next(e)}dispose(){super.dispose(),this._filteredOutRows$.complete(),this._hasCriteria$.complete()}serialize(){let e={ref:(0,a.Rectangle).clone(this._range),filterColumns:this._getAllFilterColumns(!0).sort(([e],[t])=>e-t).map(([e,t])=>t.serialize())};return this._alreadyFilteredOutRows&&(e.cachedFilteredOut=Array.from(this._alreadyFilteredOutRows).sort()),e}static deserialize(t,r,n,i){let a=new e(t,r,n);return a._dump(i),a}_dump(e){var t;this.setRange(e.ref),null==(t=e.filterColumns)||t.forEach(e=>this._setCriteriaWithoutReCalc(e.colId,e)),e.cachedFilteredOut&&(this._alreadyFilteredOutRows=new Set(e.cachedFilteredOut),this._emit()),this._emitHasCriteria()}isRowFiltered(e){return this._alreadyFilteredOutRows.has(e)}getRange(){if(!this._range)throw Error("[FilterModel] could not get range before a range is set!");return this._range}getFilteredOutRowsExceptCol(e){return this._getAllFilterColumns(!0).filter(([t])=>t!==e).reduce((e,[,t])=>{let r=t.calc({getAlreadyFilteredOutRows:/* @__PURE__ */p(()=>e,"getAlreadyFilteredOutRows")});return r?(0,a.mergeSets)(e,r):e},/* @__PURE__ */new Set)}setRange(e){this._range=e,this._getAllFilterColumns(!0).forEach(([t,r])=>{r.setRangeAndColumn({startRow:e.startRow,endRow:e.endRow,startColumn:t,endColumn:t},t)})}setCriteria(e,t,r=!1){if(!this._range)throw Error("[FilterModel] could not set criteria before a range is set!");if(!t){this._removeCriteria(e),this._rebuildAlreadyFilteredOutRowsWithCache(),r&&this._reCalcAllColumns(),this._emit(),this._emitHasCriteria();return}this._setCriteriaWithoutReCalc(e,t),r&&(this._rebuildAlreadyFilteredOutRowsWithCache(),this._reCalcWithNoCacheColumns(),this._emit(),this._emitHasCriteria())}getAllFilterColumns(){return this._getAllFilterColumns(!0)}getFilterColumn(e){var t;return null!=(t=this._filterColumnByIndex.get(e))?t:null}reCalc(){this._reCalcAllColumns(),this._emit()}_getAllFilterColumns(e=!1){let t=Array.from(this._filterColumnByIndex.entries());return e?t:t.map(([e,t])=>t)}_reCalcAllColumns(){this._alreadyFilteredOutRows=A(),this._getAllFilterColumns().forEach(e=>e.__clearCache()),this._reCalcWithNoCacheColumns()}_setCriteriaWithoutReCalc(e,t){let r;let n=this._range;if(!n)throw Error("[FilterModel] could not set criteria before a range is set!");let{startColumn:i,endColumn:a}=n;if(e>a||e<i)throw Error(`[FilterModel] could not set criteria on column ${e} which is out of range!`);this._filterColumnByIndex.has(e)?r=this._filterColumnByIndex.get(e):((r=new j(this.unitId,this.subUnitId,this._worksheet,t,{getAlreadyFilteredOutRows:/* @__PURE__ */p(()=>this._alreadyFilteredOutRows,"getAlreadyFilteredOutRows")})).setRangeAndColumn(n,e),this._filterColumnByIndex.set(e,r)),r.setCriteria(t)}_removeCriteria(e){let t=this._filterColumnByIndex.get(e);t&&(t.dispose(),this._filterColumnByIndex.delete(e))}_emit(){this._filteredOutRows$.next(this._alreadyFilteredOutRows)}_emitHasCriteria(){this._hasCriteria$.next(this._filterColumnByIndex.size>0)}_rebuildAlreadyFilteredOutRowsWithCache(){let e=this._getAllFilterColumns().filter(e=>e.hasCache()).reduce((e,t)=>(0,a.mergeSets)(e,t.filteredOutRows),/* @__PURE__ */new Set);this._alreadyFilteredOutRows=e}_reCalcWithNoCacheColumns(){for(let e of this._getAllFilterColumns().filter(e=>!e.hasCache())){let t=e.reCalc();t&&(this._alreadyFilteredOutRows=(0,a.mergeSets)(this._alreadyFilteredOutRows,t))}}};p(L,"FilterModel");let F=class extends a.Disposable{constructor(e,t,r,n,i){super(),g(this,"_filteredOutRows",null),g(this,"_filterFn",null),g(this,"_range",null),g(this,"_column",0),g(this,"_filterByValues",!1),this.unitId=e,this.subUnitId=t,this._worksheet=r,this._criteria=n,this._filterColumnContext=i}get filteredOutRows(){return this._filteredOutRows}dispose(){super.dispose(),this._filteredOutRows=null}__clearCache(){this._filteredOutRows=null}serialize(){if(!this._criteria)throw Error("[FilterColumn]: could not serialize without a filter column!");return(0,a.Tools).deepClone({...this._criteria,colId:this._column})}hasCache(){return null!==this._filteredOutRows}setRangeAndColumn(e,t){this._range=e,this._column=t}setCriteria(e){this._criteria=e,this._generateFilterFn(),this._filteredOutRows=null}getColumnData(){return(0,a.Tools).deepClone(this._criteria)}reCalc(){return this._filteredOutRows=this.calc(this._filterColumnContext),this._filteredOutRows}calc(e){if(!this._filterFn)throw Error("[FilterColumn] cannot calculate without a filter fn!");if(!this._range)throw Error("[FilterColumn] cannot calculate without a range!");if("number"!=typeof this._column)throw TypeError("[FilterColumn] cannot calculate without a column offset!");let t=this._column,r={startColumn:t,endColumn:t,startRow:this._range.startRow+1,endRow:this._range.endRow},n=/* @__PURE__ */new Set,i=e.getAlreadyFilteredOutRows();for(let e of this._worksheet.iterateByColumn(r,!1,!1)){let{row:t,rowSpan:r,col:o}=e;if(i.has(t)&&(!r||1===r))continue;let s=this._filterByValues?(0,a.extractPureTextFromCell)(this._worksheet.getCell(t,o)):Y(this._worksheet,t,o);if(!this._filterFn(s)&&(n.add(t),r))for(let e=1;e<r;e++)n.add(t+e)}return n}_generateFilterFn(){this._criteria&&(this._filterFn=V(this._criteria),this._filterByValues=!!this._criteria.filters)}};p(F,"FilterColumn");let j=F;function V(e){if(e.filters)return H(e.filters);if(e.customFilters)return $(e.customFilters);throw Error("[FilterModel]: other types of filters are not supported yet.")}function H(e){let t=!!e.blank,r=new Set(e.filters);return e=>void 0===e||""===e?t:r.has("string"==typeof e?e:`${e}`)}function $(e){let t=e.customFilters.map(e=>z(e));return G(t)?e.and?B(t):W(t):t[0]}function B(e){let[t,r]=e;return e=>t(e)&&r(e)}function W(e){let[t,r]=e;return e=>t(e)||r(e)}function G(e){return 2===e.length}function z(e){let t=e.val;if(e.operator===S.NOT_EQUALS&&!k(t))return e=>E.fn(e,t);if(M(e.operator)){if(!k(t))return()=>!1;let r=D(e.operator),n=Number(t);return e=>r.fn(e,n)}let r=D(e.operator);return e=>r.fn(e,t)}function Y(e,t,r){let n=e.getCell(t,r);if(!n)return null;let i=e.getCellRaw(t,r);return n&&!i?K(n):i?n.t===a.CellValueType.NUMBER&&"string"==typeof n.v?i.v:K(i):null}function K(e){var t,r;let n=null==(r=null==(t=e.p)?void 0:t.body)?void 0:r.dataStream;if(n)return n.trimEnd();let i=e.v;return"string"==typeof i?e.t===a.CellValueType.BOOLEAN?i.toUpperCase():i:"number"==typeof i?e.t===a.CellValueType.BOOLEAN?i?"TRUE":"FALSE":i:"boolean"==typeof i?i?"TRUE":"FALSE":""}p(V,"generateFilterFn"),p(H,"filterByValuesFnFactory"),p($,"customFilterFnFactory"),p(B,"AND"),p(W,"OR"),p(G,"isCompoundCustomFilter"),p(z,"generateCustomFilterFn"),p(Y,"getFilterValueForConditionalFiltering"),p(K,"extractFilterValueFromCell");var q=Object.defineProperty,X=Object.getOwnPropertyDescriptor,Q=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?X(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&q(t,r,a),a},"__decorateClass$2"),Z=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let J=/* @__PURE__ */new Set([f.id,v.id,_.id,I.id]),ee="SHEET_FILTER_PLUGIN",et=(ei=class extends a.Disposable{constructor(e,t,r){super(),g(this,"_filterModels",/* @__PURE__ */new Map),g(this,"_loadedUnitId$",new o.BehaviorSubject(null)),g(this,"loadedUnitId$",this._loadedUnitId$.asObservable()),g(this,"_errorMsg$",new o.BehaviorSubject(null)),g(this,"errorMsg$",this._errorMsg$.asObservable()),g(this,"_activeFilterModel$",new o.BehaviorSubject(null)),g(this,"activeFilterModel$",this._activeFilterModel$.asObservable()),this._resourcesManagerService=e,this._univerInstanceService=t,this._commandService=r,this._initModel(),this._initActiveFilterModel()}get activeFilterModel(){return this._activeFilterModel$.getValue()}ensureFilterModel(e,t){let r=this.getFilterModel(e,t);if(r)return r;let n=this._univerInstanceService.getUniverSheetInstance(e);if(!n)throw Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing workbook ${e}!`);let i=n.getSheetBySheetId(t);if(!i)throw Error(`[SheetsFilterService]: could not create "FilterModel" on a non-existing worksheet ${t}!`);let a=new L(e,t,i);return this._cacheFilterModel(e,t,a),a}getFilterModel(e,t){var r,n;return null!=(n=null==(r=this._filterModels.get(e))?void 0:r.get(t))?n:null}removeFilterModel(e,t){let r=this.getFilterModel(e,t);return!!r&&(r.dispose(),this._filterModels.get(e).delete(t),!0)}setFilterErrorMsg(e){this._errorMsg$.next(e)}_updateActiveFilterModel(){let e;try{if(!(e=this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET))){this._activeFilterModel$.next(null);return}}catch(e){console.error("[SheetsFilterService]: could not get active workbook!",e);return}let t=e.getActiveSheet(!0);if(!t){this._activeFilterModel$.next(null);return}let r=t.getUnitId(),n=t.getSheetId(),i=this.getFilterModel(r,n);this._activeFilterModel$.next(i)}_initActiveFilterModel(){this.disposeWithMe((0,l.merge)((0,a.fromCallback)(this._commandService.onCommandExecuted.bind(this._commandService)).pipe((0,s.filter)(([e])=>e.type===a.CommandType.MUTATION&&J.has(e.id))),this._univerInstanceService.getCurrentTypeOfUnit$(a.UniverInstanceType.UNIVER_SHEET).pipe((0,u.switchMap)(e=>{var t;return null!=(t=null==e?void 0:e.activeSheet$)?t:(0,d.of)(null)}))).subscribe(()=>this._updateActiveFilterModel()))}_serializeAutoFiltersForUnit(e){let t=this._filterModels.get(e);if(!t)return"{}";let r={};return t.forEach((e,t)=>{r[t]=e.serialize()}),JSON.stringify(r)}_deserializeAutoFiltersForUnit(e,t){let r=this._univerInstanceService.getUniverSheetInstance(e);Object.keys(t).forEach(n=>{let i=t[n],a=L.deserialize(e,n,r.getSheetBySheetId(n),i);this._cacheFilterModel(e,n,a)})}_initModel(){this._resourcesManagerService.registerPluginResource({pluginName:ee,businesses:[a.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */p(e=>this._serializeAutoFiltersForUnit(e),"toJson"),parseJson:/* @__PURE__ */p(e=>JSON.parse(e),"parseJson"),onLoad:/* @__PURE__ */p((e,t)=>{this._deserializeAutoFiltersForUnit(e,t),this._loadedUnitId$.next(e),this._updateActiveFilterModel()},"onLoad"),onUnLoad:/* @__PURE__ */p(e=>{let t=this._filterModels.get(e);t&&(t.forEach(e=>e.dispose()),this._filterModels.delete(e))},"onUnLoad")})}_cacheFilterModel(e,t,r){this._filterModels.has(e)||this._filterModels.set(e,/* @__PURE__ */new Map),this._filterModels.get(e).set(t,r)}},p(ei,"SheetsFilterService"),ei);function er(e,t){for(let r=0;r<e.length;r++){let n=r;if(e[r])for(let i=r+1;i<e.length;i++)e[n]&&e[i]&&t(e[n],e[i])&&(e[n]=null,n=i)}return e.filter(e=>null!==e)}function en(e){return er(e,(e,t)=>e.id===v.id&&t.id===v.id&&e.params.unitId===t.params.unitId&&e.params.subUnitId===t.params.subUnitId&&e.params.col===t.params.col)}et=Q([Z(0,a.IResourceManagerService),Z(1,a.IUniverInstanceService),Z(2,a.ICommandService)],et),p(er,"objectsShaker"),p(en,"mergeSetFilterCriteria");var ei,ea,eo=Object.defineProperty,es=Object.getOwnPropertyDescriptor,el=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?es(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eo(t,r,a),a},"__decorateClass$1"),ed=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let eu=(ea=class extends a.Disposable{constructor(e,t,r,n,i){super(),g(this,"_disposableCollection",new a.DisposableCollection),this._commandService=e,this._sheetInterceptorService=t,this._sheetsFilterService=r,this._univerInstanceService=n,this._refRangeService=i,this._initCommands(),this._initRowFilteredInterceptor(),this._initInterceptors(),this._commandExecutedListener(),this._initErrorHandling()}_initCommands(){[v,f,I,_].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_initInterceptors(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */p(e=>this._getUpdateFilter(e),"getMutations")})),this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===c.SetWorksheetActiveOperation.id){let t=e.params,r=t.subUnitId,n=t.unitId;if(!r||!n)return;this._registerRefRange(n,r)}if(e.id===f.id){let t=e.params,r=t.subUnitId,n=t.unitId;if(!r||!n)return;this._registerRefRange(t.unitId,t.subUnitId)}})),this.disposeWithMe(this._sheetsFilterService.loadedUnitId$.subscribe(e=>{if(e){let t=this._univerInstanceService.getUniverSheetInstance(e),r=null==t?void 0:t.getActiveSheet();r&&this._registerRefRange(e,r.getSheetId())}}))}_registerRefRange(e,t){var r;this._disposableCollection.dispose();let n=this._univerInstanceService.getUniverSheetInstance(e),i=null==n?void 0:n.getSheetBySheetId(t);if(!n||!i)return;let a=null==(r=this._sheetsFilterService.getFilterModel(e,t))?void 0:r.getRange(),o=/* @__PURE__ */p(r=>{switch(r.id){case c.InsertRowCommand.id:{let n=r.params,i=n.unitId||e,a=n.subUnitId||t;return this._handleInsertRowCommand(n,i,a)}case c.InsertColCommand.id:{let n=r.params,i=n.unitId||e,a=n.subUnitId||t;return this._handleInsertColCommand(n,i,a)}case c.RemoveColCommand.id:{let n=r.params;return this._handleRemoveColCommand(n,e,t)}case c.RemoveRowCommand.id:{let n=r.params;return this._handleRemoveRowCommand(n,e,t)}case c.EffectRefRangId.MoveColsCommandId:{let n=r.params;return this._handleMoveColsCommand(n,e,t)}case c.EffectRefRangId.MoveRowsCommandId:{let n=r.params;return this._handleMoveRowsCommand(n,e,t)}case c.MoveRangeCommand.id:{let n=r.params;return this._handleMoveRangeCommand(n,e,t)}}return{redos:[],undos:[]}},"handler");a&&this._disposableCollection.add(this._refRangeService.registerRefRange(a,o,e,t))}_getUpdateFilter(e){let{id:t}=e;switch(t){case c.RemoveSheetCommand.id:{let t=e.params;return this._handleRemoveSheetCommand(t,t.unitId,t.subUnitId)}case c.CopySheetCommand.id:{let{targetSubUnitId:t,unitId:r,subUnitId:n}=e.params;return r&&n&&t?this._handleCopySheetCommand(r,n,t):this._handleNull()}}return{redos:[],undos:[]}}_handleInsertColCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),a=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!a)return this._handleNull();let{startColumn:o,endColumn:s}=a,{startColumn:l,endColumn:d}=e.range,u=d-l+1;if(d>s)return this._handleNull();let c=[],h=[],m={unitId:t,subUnitId:r,range:{...a,startColumn:l<=o?o+u:o,endColumn:s+u}};c.push({id:f.id,params:m}),h.push({id:f.id,params:{unitId:t,subUnitId:r,range:a}});let p=i.getAllFilterColumns().filter(e=>e[0]>=l);if(0!==p.length){let{newRange:e,oldRange:n}=this.moveCriteria(t,r,p,u);c.push(...e.redos,...n.redos),h.push(...e.undos,...n.undos)}return{redos:en(c),undos:en(h)}}_handleInsertRowCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),a=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!a)return this._handleNull();let{startRow:o,endRow:s}=a,{startRow:l,endRow:d}=e.range,u=d-l+1;if(d>s)return this._handleNull();let c=[],h=[],m={unitId:t,subUnitId:r,range:{...a,startRow:l<=o?o+u:o,endRow:s+u}};return c.push({id:f.id,params:m}),h.push({id:f.id,params:{unitId:t,subUnitId:r,range:a}}),{redos:en(c),undos:en(h)}}_handleRemoveColCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),a=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!a)return this._handleNull();let{startColumn:o,endColumn:s}=a,{startColumn:l,endColumn:d}=e.range;if(l>s)return this._handleNull();let u=[],c=[],h=d<o?0:Math.min(d,s)-Math.max(l,o)+1,m=d-l+1,p=i.getAllFilterColumns();p.forEach(e=>{let[n,i]=e;n<=d&&n>=l&&(u.push({id:v.id,params:{unitId:t,subUnitId:r,col:n,criteria:null}}),c.push({id:v.id,params:{unitId:t,subUnitId:r,col:n,criteria:{...i.serialize(),colId:n}}}))});let g=p.filter(e=>{let[t,r]=e;return t>d}),I={undos:[],redos:[]};if(g.length>0){let{oldRange:e,newRange:n}=this.moveCriteria(t,r,g,-m);I=n,u.push(...e.redos),c.unshift(...e.undos)}if(h===s-o+1)u.push({id:_.id,params:{unitId:t,subUnitId:r}}),c.unshift({id:f.id,params:{range:a,unitId:t,subUnitId:r}});else{let e={unitId:t,subUnitId:r,range:{...a,startColumn:o<=l?o:0===h?o-m:l,endColumn:o<=l?s-h:s-m}};u.push({id:f.id,params:e}),c.unshift({id:f.id,params:{range:a,unitId:t,subUnitId:r}}),u.push(...I.redos),c.unshift(...I.undos)}return{undos:c,redos:u}}_handleRemoveRowCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r);if(!i)return this._handleNull();let a=i.getRange(),{startRow:o,endRow:s}=a,{startRow:l,endRow:d}=e.range;if(l>s)return this._handleNull();if(d<o)return{undos:[{id:f.id,params:{range:a,unitId:t,subUnitId:r}}],redos:[{id:f.id,params:{range:{...a,startRow:o-(d-l+1),endRow:s-(d-l+1)},unitId:t,subUnitId:r}}]};let u=[],c=[],h=i.getAllFilterColumns(),m=o<=d&&o>=l;c.push({id:f.id,params:{range:a,unitId:t,subUnitId:r}});let p=Math.min(d,s)-Math.max(l,o)+1;if(p===s-o+1||m)u.push({id:_.id,params:{unitId:t,subUnitId:r}}),h.forEach(e=>{let[n,i]=e,a={unitId:t,subUnitId:r,col:n,criteria:{...i.serialize(),colId:n}};c.push({id:v.id,params:a})});else{let e=null==(n=this._univerInstanceService.getUniverSheetInstance(t))?void 0:n.getSheetBySheetId(r);if(!e)return this._handleNull();let i=[];for(let t=l;t<=d;t++)e.getRowFiltered(t)&&i.push(t);let c=Math.min(o,l),h=c+(s-o)-p+i.length,m={unitId:t,subUnitId:r,range:{...a,startRow:c,endRow:h}};u.push({id:f.id,params:m})}return{undos:en(c),redos:en(u)}}_handleMoveColsCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),o=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!o)return this._handleNull();let{startColumn:s,endColumn:l}=o,{fromRange:d,toRange:u}=e;if(d.endColumn<s&&u.startColumn<=s||d.startColumn>l&&u.endColumn>l)return this._handleNull();let c=[],h=[],m={};for(let e=s;e<=l;e++)m[e]={colIndex:e,filter:i.getFilterColumn(e)};(0,a.moveMatrixArray)(d.startColumn,d.endColumn-d.startColumn+1,u.startColumn,m);let p=o.startColumn,g=o.endColumn;s>=d.startColumn&&s<=d.endColumn&&u.startColumn>d.startColumn&&d.endColumn<l&&(p=d.endColumn+1),l>=d.startColumn&&l<=d.endColumn&&u.startColumn<d.startColumn&&d.startColumn>s&&(g=d.startColumn-1);let _=Object.keys(m).map(e=>Number(e)),I=_.find(e=>m[e].colIndex===g),S=_.find(e=>m[e].colIndex===p);if(_.forEach(e=>{var n,a;let{colIndex:o,filter:s}=m[e];if(s){if(e>=S&&e<=I){let a={unitId:t,subUnitId:r,col:e,criteria:{...s.serialize(),colId:e}},o={unitId:t,subUnitId:r,col:e,criteria:i.getFilterColumn(e)?{...null==(n=i.getFilterColumn(e))?void 0:n.serialize(),colId:e}:null};c.push({id:v.id,params:a}),h.push({id:v.id,params:o})}null!=(a=m[o])&&a.filter||(c.push({id:v.id,params:{unitId:t,subUnitId:r,col:o,criteria:null}}),h.push({id:v.id,params:{unitId:t,subUnitId:r,col:o,criteria:{...s.serialize(),colId:o}}}))}}),s!==S||l!==I){let e={unitId:t,subUnitId:r,range:{...o,startColumn:S,endColumn:I}};c.unshift({id:f.id,params:e}),h.unshift({id:f.id,params:{range:o,unitId:t,subUnitId:r}})}return{undos:h,redos:c}}_handleMoveRowsCommand(e,t,r){var n;let i=this._sheetsFilterService.getFilterModel(t,r),o=null!=(n=null==i?void 0:i.getRange())?n:null;if(!i||!o)return this._handleNull();let{startRow:s,endRow:l}=o,{fromRange:d,toRange:u}=e;if(d.endRow<s&&u.startRow<=s||d.startRow>l&&u.endRow>l)return this._handleNull();let c=[],h=[],m={};for(let e=s;e<=l;e++)m[e]={oldIndex:e};let p=l;l>=d.startRow&&l<=d.endRow&&u.startRow<d.startRow&&d.startRow>s&&(p=d.startRow-1),(0,a.moveMatrixArray)(d.startRow,d.endRow-d.startRow+1,u.startRow,m);let g=Object.keys(m).map(e=>Number(e)),v=g.find(e=>m[e].oldIndex===p),_=g.find(e=>m[e].oldIndex===s);if(s!==_||l!==v){let e={unitId:t,subUnitId:r,range:{...o,startRow:_,endRow:v}};c.push({id:f.id,params:e},{id:I.id,params:{unitId:t,subUnitId:r}}),h.push({id:f.id,params:{range:o,unitId:t,subUnitId:r}},{id:I.id,params:{unitId:t,subUnitId:r}})}return{redos:c,undos:h}}_handleMoveRangeCommand(e,t,r){let{fromRange:n,toRange:i}=e,o=this._sheetsFilterService.getFilterModel(t,r);if(!o)return this._handleNull();let s=o.getRange();if(!s)return this._handleNull();let l=[],d=[];if((0,a.Rectangle).contains(n,s)){let e=s.startRow-n.startRow,a=s.startColumn-n.startColumn,u={startRow:i.startRow+e,startColumn:i.startColumn+a,endRow:i.startRow+e+(s.endRow-s.startRow),endColumn:i.startColumn+a+(s.endColumn-s.startColumn)},c={id:_.id,params:{unitId:t,subUnitId:r}},h={id:f.id,params:{unitId:t,subUnitId:r,range:u}},m={id:f.id,params:{unitId:t,subUnitId:r,range:s}};l.push(c,h),d.push(c,m);let p=o.getAllFilterColumns(),g=i.startColumn-n.startColumn;p.forEach(e=>{let[n,i]=e;i&&(l.push({id:v.id,params:{unitId:t,subUnitId:r,col:n+g,criteria:{...i.serialize(),colId:n+g}}}),d.push({id:v.id,params:{unitId:t,subUnitId:r,col:n,criteria:{...i.serialize(),colId:n}}}))})}else if((0,a.Rectangle).intersects(i,s)){let e={...s,endRow:Math.max(s.endRow,i.endRow)};l.push({id:f.id,params:{unitId:t,subUnitId:r,range:e}}),d.push({id:f.id,params:{unitId:t,subUnitId:r,range:s}})}return{redos:l,undos:d}}_handleRemoveSheetCommand(e,t,r){let n=this._sheetsFilterService.getFilterModel(t,r);if(!n)return this._handleNull();let i=n.getRange();if(!i)return this._handleNull();let a=[],o=[];return n.getAllFilterColumns().forEach(([e,n])=>{o.push({id:v.id,params:{unitId:t,subUnitId:r,col:e,criteria:{...n.serialize(),colId:e}}})}),a.push({id:_.id,params:{unitId:t,subUnitId:r,range:i}}),o.unshift({id:f.id,params:{range:i,unitId:t,subUnitId:r}}),{undos:o,redos:a}}_handleCopySheetCommand(e,t,r){let n=this._sheetsFilterService.getFilterModel(e,t);if(!n)return this._handleNull();let i=n.getRange();if(!i)return this._handleNull();let a=[],o=[];return n.getAllFilterColumns().forEach(([t,n])=>{a.push({id:v.id,params:{unitId:e,subUnitId:r,col:t,criteria:{...n.serialize(),colId:t}}}),o.push({id:v.id,params:{unitId:e,subUnitId:r,col:t,criteria:null}})}),o.push({id:_.id,params:{unitId:e,subUnitId:r,range:i}}),a.unshift({id:f.id,params:{range:i,unitId:e,subUnitId:r}}),{undos:[],redos:a,preUndos:o,preRedos:[]}}_handleNull(){return{redos:[],undos:[]}}_initRowFilteredInterceptor(){this.disposeWithMe(this._sheetInterceptorService.intercept(c.INTERCEPTOR_POINT.ROW_FILTERED,{handler:/* @__PURE__ */p((e,t)=>{var r,n;return!!e||null!=(n=null==(r=this._sheetsFilterService.getFilterModel(t.unitId,t.subUnitId))?void 0:r.isRowFiltered(t.row))&&n},"handler")}))}moveCriteria(e,t,r,n){let i={unitId:e,subUnitId:t,criteria:null,col:-1},a=[],o=[],s=[],l=[];return r.forEach(e=>{let[t,r]=e;o.push({id:v.id,params:{...i,col:t}}),a.push({id:v.id,params:{...i,col:t,criteria:{...r.serialize(),colId:t}}})}),r.forEach(e=>{let[t,r]=e;l.push({id:v.id,params:{...i,col:t+n,criteria:{...r.serialize(),colId:t+n}}}),s.push({id:v.id,params:{...i,col:t+n,criteria:null}})}),{newRange:{redos:l,undos:s},oldRange:{redos:o,undos:a}}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((e,t)=>{var r,n;let{unitId:i,subUnitId:a}=e.params||{},o=this._sheetsFilterService.getFilterModel(i,a);if(!o)return;let s=Array.from(o.filteredOutRows).sort((e,t)=>e-t),l=[],d=!1;if(e.id===c.RemoveRowMutation.id){let{startRow:t,endRow:r}=e.params.range,n=s.filter(e=>e>=t&&e<=r);s.forEach(e=>{if(e<t)l.push(e);else if(d=!0,e<=r){let e=Math.max(t,l.length?l[l.length-1]+1:t);l.push(e)}else l.push(e-(r-t+1-n.length))})}if(e.id===c.InsertRowMutation.id){let{startRow:t,endRow:r}=e.params.range;s.forEach(e=>{e>=t?(d=!0,l.push(e+(r-t+1))):l.push(e)})}if(d&&(o.filteredOutRows=new Set(l)),e.id===c.SetRangeValuesMutation.id&&!(null!=t&&t.onlyLocal)){let t=this._getExtendRegion(i,a);if(t){let o=e.params.cellValue;if(o)for(let e=t.startColumn;e<=t.endColumn;e++){let s=null==(r=null==o?void 0:o[t.startRow])?void 0:r[e];if(s&&this._cellHasValue(s)){let e=null==(n=this._univerInstanceService.getUnit(i))?void 0:n.getSheetBySheetId(a);if(e){let r=(0,c.expandToContinuousRange)(t,{down:!0},e),n=this._sheetsFilterService.getFilterModel(i,a),o=n.getRange();n.setRange({...o,endRow:r.endRow}),this._registerRefRange(i,a)}}}}}}))}_getExtendRegion(e,t){var r;let n=this._sheetsFilterService.getFilterModel(e,t);if(!n)return null;let i=null==(r=this._univerInstanceService.getUnit(e))?void 0:r.getSheetBySheetId(t);if(!i)return null;let a=n.getRange();if(!a)return null;let o=i.getRowCount()-1,s=i.getRowManager();for(let e=a.endRow+1;e<=o;e++)if(s.getRowRawVisible(e))return{startRow:e,endRow:e,startColumn:a.startColumn,endColumn:a.endColumn};return null}_initErrorHandling(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{let t=e.params,r=(0,c.getSheetCommandTarget)(this._univerInstanceService);if(!r)return;let{subUnitId:n,unitId:i}=r,a=this._sheetsFilterService.getFilterModel(i,n);if(!a)return;let o=a.getRange();if(e.id===c.MoveRowsCommand.id&&t.fromRange.startRow<=o.startRow&&t.fromRange.endRow<o.endRow&&t.fromRange.endRow>=o.startRow)throw this._sheetsFilterService.setFilterErrorMsg("sheets-filter.msg.filter-header-forbidden"),Error("[SheetsFilterController]: Cannot move header row of filter")}))}_cellHasValue(e){let t=Object.values(e);return!(0===t.length||t.every(e=>null==e))}},p(ea,"SheetsFilterController"),ea);eu=el([ed(0,a.ICommandService),ed(1,(0,a.Inject)(c.SheetInterceptorService)),ed(2,(0,a.Inject)(et)),ed(3,a.IUniverInstanceService),ed(4,(0,a.Inject)(c.RefRangeService))],eu);let ec={};var eh,em=Object.defineProperty,ep=Object.getOwnPropertyDescriptor,eg=/* @__PURE__ */p((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ep(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&em(t,r,a),a},"__decorateClass"),ef=/* @__PURE__ */p((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let ev=(p(eh=class extends a.Plugin{constructor(e=ec,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("sheets-filter.config",n)}onStarting(){[[et],[eu]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(eu)}},"UniverSheetsFilterPlugin"),g(eh,"type",a.UniverInstanceType.UNIVER_SHEET),g(eh,"pluginName",ee),eh);ev=eg([ef(1,(0,a.Inject)(a.Injector)),ef(2,a.IConfigService)],ev)}),i("iGtRt",function(i,a){let o,s,l;e(i.exports,"SetSheetFilterRangeCommand",function(){return j}),e(i.exports,"RemoveSheetFilterCommand",function(){return V}),e(i.exports,"SetSheetsFilterCriteriaCommand",function(){return $}),e(i.exports,"ClearSheetsFilterCriteriaCommand",function(){return B});var d=n("7yNYd"),u=n("k2g5B"),c=n("gwMUy"),h=n("ejawP"),m=n("4XALk"),p=n("1UDbf"),g=n("fL2Ug"),f=n("5LPkb"),v=n("5K4WI"),_=n("arCqp"),I=n("lMvMU"),S=n("hciHF"),C=n("i54iF"),y=n("3yupB"),w=n("3rvNF"),b=n("c3hg1"),R=n("ezO1S"),E=n("1mjSk"),T=n("23cfA"),M=n("2jrJe"),O=n("gv2K9"),D=n("3e0Iz"),U=n("5gqvu"),k=n("97tPx"),P=Object.defineProperty,N=(e,t,r)=>t in e?P(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,x=(e,t)=>P(e,"name",{value:t,configurable:!0}),A=(e,t,r)=>N(e,"symbol"!=typeof t?t+"":t,r);let L="sheets-filter-ui.config",F={},j={id:"sheet.command.set-filter-range",type:d.CommandType.COMMAND,handler:/* @__PURE__ */x((e,t)=>{let r=e.get(c.SheetsFilterService),n=e.get(d.ICommandService),i=e.get(d.IUndoRedoService),a=e.get(d.IUniverInstanceService),{unitId:o,subUnitId:s,range:l}=t;if(!(0,h.getSheetCommandTarget)(a,t)||r.getFilterModel(o,s))return!1;if(l.endRow===l.startRow){let t=e.get(g.IMessageService,d.Quantity.OPTIONAL),r=e.get(d.LocaleService);return null==t||t.show({type:p.MessageType.Warning,content:r.t("sheets-filter.command.not-valid-filter-range")}),!1}let u={id:c.SetSheetsFilterRangeMutation.id,params:{unitId:o,subUnitId:s,range:l}},m=n.syncExecuteCommand(u.id,u.params);return m&&i.pushUndoRedo({unitID:o,undoMutations:[{id:c.RemoveSheetsFilterMutation.id,params:{unitId:o,subUnitId:s}}],redoMutations:[u]}),m},"handler")},V={id:"sheet.command.remove-sheet-filter",type:d.CommandType.COMMAND,handler:/* @__PURE__ */x((e,t)=>{let r=e.get(d.IUniverInstanceService),n=e.get(c.SheetsFilterService),i=e.get(d.ICommandService),a=e.get(d.IUndoRedoService),o=(0,h.getSheetCommandTarget)(r,t);if(!o)return!1;let{unitId:s,subUnitId:l}=o,u=n.getFilterModel(s,l);if(!u)return!1;let m=G(s,l,null==u?void 0:u.serialize()),p=i.syncExecuteCommand(c.RemoveSheetsFilterMutation.id,{unitId:s,subUnitId:l});return p&&a.pushUndoRedo({unitID:s,undoMutations:m,redoMutations:[{id:c.RemoveSheetsFilterMutation.id,params:{unitId:s,subUnitId:l}}]}),p},"handler")},H={id:"sheet.command.smart-toggle-filter",type:d.CommandType.COMMAND,handler:/* @__PURE__ */x(async e=>{let t=e.get(d.IUniverInstanceService),r=e.get(c.SheetsFilterService),n=e.get(d.ICommandService),i=t.getCurrentUnitForType(d.UniverInstanceType.UNIVER_SHEET),a=null==i?void 0:i.getActiveSheet();if(!a||!i)return!1;let o=i.getUnitId(),s=a.getSheetId();if(r.getFilterModel(o,s))return n.executeCommand(V.id,{unitId:o,subUnitId:s});let l=e.get(h.SheetsSelectionsService).getCurrentLastSelection();if(!l)return!1;let u=l.range,m=(0,h.isSingleCellSelection)(l)?(0,h.expandToContinuousRange)(u,{left:!0,right:!0,up:!0,down:!0},a):u;return n.executeCommand(j.id,{unitId:o,subUnitId:s,range:m})},"handler")},$={id:"sheet.command.set-filter-criteria",type:d.CommandType.COMMAND,handler:/* @__PURE__ */x(async(e,t)=>{let r=e.get(c.SheetsFilterService),n=e.get(d.ICommandService),i=e.get(d.IUndoRedoService),{unitId:a,subUnitId:o,col:s,criteria:l}=t,u=r.getFilterModel(a,o);if(!u)return!1;let h=u.getRange();if(!h||s<h.startColumn||s>h.endColumn)return!1;let m=u.getFilterColumn(s),p=K(a,o,s,m),g={id:c.SetSheetsFilterCriteriaMutation.id,params:{unitId:a,subUnitId:o,col:s,criteria:l}},f=n.syncExecuteCommand(g.id,g.params);return f&&i.pushUndoRedo({unitID:a,undoMutations:[p],redoMutations:[g]}),f},"handler")},B={id:"sheet.command.clear-filter-criteria",type:d.CommandType.COMMAND,handler:/* @__PURE__ */x((e,t)=>{let r=e.get(c.SheetsFilterService),n=e.get(d.IUndoRedoService),i=e.get(d.ICommandService),a=e.get(d.IUniverInstanceService),o=(0,h.getSheetCommandTarget)(a,t);if(!o)return!1;let{unitId:s,subUnitId:l}=o,u=r.getFilterModel(o.unitId,o.subUnitId);if(!u)return!1;let m=u.serialize(),p=z(s,l,m),g=Y(s,l,m);return!!(0,d.sequenceExecute)(g,i).result&&(n.pushUndoRedo({unitID:s,undoMutations:p,redoMutations:g}),!0)},"handler")},W={id:"sheet.command.re-calc-filter",type:d.CommandType.COMMAND,handler:/* @__PURE__ */x((e,t)=>{let r=e.get(c.SheetsFilterService),n=e.get(d.ICommandService),i=e.get(d.IUniverInstanceService),a=(0,h.getSheetCommandTarget)(i,t);if(!a)return!1;let{unitId:o,subUnitId:s}=a;return!!r.getFilterModel(a.unitId,a.subUnitId)&&n.executeCommand(c.ReCalcSheetsFilterMutation.id,{unitId:o,subUnitId:s})},"handler")};function G(e,t,r){let n=[],i={id:c.SetSheetsFilterRangeMutation.id,params:{unitId:e,subUnitId:t,range:r.ref}};return n.push(i),z(e,t,r).forEach(e=>n.push(e)),n}function z(e,t,r){var n;let i=[];return null==(n=r.filterColumns)||n.forEach(r=>{let n={id:c.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r.colId,criteria:r}};i.push(n)}),i}function Y(e,t,r){var n;let i=[];return null==(n=r.filterColumns)||n.forEach(r=>{let n={id:c.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r.colId,criteria:null}};i.push(n)}),i}function K(e,t,r,n){if(!n)return{id:c.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r,criteria:null}};let i=n.serialize();return{id:c.SetSheetsFilterCriteriaMutation.id,params:{unitId:e,subUnitId:t,col:r,criteria:i}}}x(G,"destructFilterModel"),x(z,"destructFilterCriteria"),x(Y,"generateRemoveCriteriaMutations"),x(K,"destructFilterColumn");var q,X=((o=X||{})[o.FIRST=0]="FIRST",o[o.SECOND=1]="SECOND",o),Q=((s=Q||{}).NONE="none",s.STARTS_WITH="startsWith",s.DOES_NOT_START_WITH="doesNotStartWith",s.ENDS_WITH="endsWith",s.DOES_NOT_END_WITH="doesNotEndWith",s.CONTAINS="contains",s.DOES_NOT_CONTAIN="doesNotContain",s.EQUALS="equals",s.NOT_EQUALS="notEquals",s.EMPTY="empty",s.NOT_EMPTY="notEmpty",s.BETWEEN="between",s.NOT_BETWEEN="notBetween",s.CUSTOM="custom",s);function Z(e){let{operator1:t,operator2:r,val1:n,val2:i}=e;if(t&&r)throw Error("Both operator1 and operator2 are set!");if(!t&&!r)throw Error("Neither operator1 and operator2 and both not set!");return t?[t,n]:[r,i]}function J(e){let t=[],r=[];for(let n of e)n.checked?t.push(n):r.push(n);return{checkedItems:t,uncheckedItems:r,checked:t.length,unchecked:r.length}}(e=>{function t(t){let r=e.ALL_CONDITIONS.find(e=>e.operator===t);if(!r)throw Error(`[SheetsFilter]: no condition item found for operator: ${t}`);return r}function r(t,r){for(let n of e.ALL_CONDITIONS.filter(e=>e.numOfParameters===r))if(0!==n.numOfParameters&&n.testMappingParams(t))return n;for(let r of e.ALL_CONDITIONS)if(r.testMappingParams(t))return r;throw Error("[SheetsFilter]: no condition item can be mapped from the filter map params!")}function n(t){let r=e.ALL_CONDITIONS.find(e=>e.operator===t);return(null==r?void 0:r.numOfParameters)===0?{operator1:r.operator}:r.getDefaultFormParams()}function i(e,t){return e.mapToFilterColumn(t)}function a(t){if(!t)return[e.NONE,{}];for(let r of e.ALL_CONDITIONS){let e=r.testMappingFilterColumn(t);if(e)return[r,e]}return[e.NONE,{}]}e.NONE={label:"sheets-filter.conditions.none",operator:Q.NONE,order:X.SECOND,numOfParameters:0,getDefaultFormParams:/* @__PURE__ */x(()=>{throw Error("[FilterConditionItems.NONE]: should not have initial form params!")},"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>e.operator1===Q.NONE,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(()=>null,"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>!e.customFilters&&!e.filters&&{},"testMappingFilterColumn")},e.EMPTY={label:"sheets-filter.conditions.empty",operator:Q.EMPTY,order:X.SECOND,numOfParameters:0,getDefaultFormParams:/* @__PURE__ */x(()=>{throw Error("[FilterConditionItems.EMPTY]: should not have initial form params!")},"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(({operator1:e})=>e===Q.EMPTY,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(()=>({customFilters:{customFilters:[{val:""}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return""===r.val&&void 0===r.operator&&{operator1:Q.EMPTY}},"testMappingFilterColumn")},e.NOT_EMPTY={label:"sheets-filter.conditions.not-empty",operator:Q.NOT_EMPTY,order:X.SECOND,numOfParameters:0,getDefaultFormParams:/* @__PURE__ */x(()=>{throw Error("[FilterConditionItems.NOT_EMPTY]: should not have initial form params!")},"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(({operator1:e})=>e===Q.NOT_EMPTY,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(()=>({customFilters:{customFilters:[{val:"",operator:c.CustomFilterOperator.NOT_EQUALS}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return" "===r.val&&r.operator===c.CustomFilterOperator.NOT_EQUALS&&{operator1:Q.NOT_EMPTY}},"testMappingFilterColumn")},e.TEXT_CONTAINS={label:"sheets-filter.conditions.text-contains",operator:Q.CONTAINS,order:X.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:Q.CONTAINS,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===Q.CONTAINS},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>{let{val1:t}=e;return""===t?null:{customFilters:{customFilters:[{val:`*${t}*`}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(!r.operator&&n.startsWith("*")&&n.endsWith("*"))&&{operator1:Q.CONTAINS,val1:n.slice(1,-1)}},"testMappingFilterColumn")},e.DOES_NOT_CONTAIN={label:"sheets-filter.conditions.does-not-contain",operator:Q.DOES_NOT_CONTAIN,order:X.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:Q.DOES_NOT_CONTAIN,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:`*${e.val1}*`,operator:c.CustomFilterOperator.NOT_EQUALS}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===Q.DOES_NOT_CONTAIN},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(r.operator===c.CustomFilterOperator.NOT_EQUALS&&n.startsWith("*")&&n.endsWith("*"))&&{operator1:Q.DOES_NOT_CONTAIN,val1:n.slice(1,-1)}},"testMappingFilterColumn")},e.STARTS_WITH={label:"sheets-filter.conditions.starts-with",operator:Q.STARTS_WITH,order:X.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:Q.STARTS_WITH,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:`${e.val1}*`}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===Q.STARTS_WITH},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(!r.operator&&n.endsWith("*"))&&!n.startsWith("*")&&{operator1:Q.STARTS_WITH,val1:n.slice(0,-1)}},"testMappingFilterColumn")},e.ENDS_WITH={label:"sheets-filter.conditions.ends-with",operator:Q.ENDS_WITH,order:X.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:Q.ENDS_WITH,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:`*${e.val1}`}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===Q.ENDS_WITH},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0],n=r.val.toString();return!!(!r.operator&&n.startsWith("*"))&&!n.endsWith("*")&&{operator1:Q.ENDS_WITH,val1:n.slice(1)}},"testMappingFilterColumn")},e.EQUALS={label:"sheets-filter.conditions.equals",operator:Q.EQUALS,order:X.FIRST,numOfParameters:1,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:Q.EQUALS,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===Q.EQUALS},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>{let{val1:t}=e;return""===t?null:{customFilters:{customFilters:[{val:t}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t,r,n;return(null==(r=null==(t=e.filters)?void 0:t.filters)?void 0:r.length)===1?{operator1:Q.EQUALS,val1:""}:(null==(n=e.customFilters)?void 0:n.customFilters.length)===1&&!e.customFilters.customFilters[0].operator&&{operator1:Q.EQUALS,val1:e.customFilters.customFilters[0].val.toString()}},"testMappingFilterColumn")},e.GREATER_THAN={label:"sheets-filter.conditions.greater-than",operator:c.CustomFilterOperator.GREATER_THAN,numOfParameters:1,order:X.FIRST,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:c.CustomFilterOperator.GREATER_THAN,val1:""}),"getDefaultFormParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:e.val1,operator:c.CustomFilterOperator.GREATER_THAN}]}}),"mapToFilterColumn"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===c.CustomFilterOperator.GREATER_THAN},"testMappingParams"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===c.CustomFilterOperator.GREATER_THAN&&{operator1:c.CustomFilterOperator.GREATER_THAN,val1:r.val.toString()}},"testMappingFilterColumn")},e.GREATER_THAN_OR_EQUAL={label:"sheets-filter.conditions.greater-than-or-equal",operator:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,numOfParameters:1,order:X.FIRST,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:e.val1,operator:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&{operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:r.val.toString()}},"testMappingFilterColumn")},e.LESS_THAN={label:"sheets-filter.conditions.less-than",operator:c.CustomFilterOperator.LESS_THAN,numOfParameters:1,order:X.FIRST,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:c.CustomFilterOperator.LESS_THAN,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===c.CustomFilterOperator.LESS_THAN},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:e.val1,operator:c.CustomFilterOperator.LESS_THAN}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===c.CustomFilterOperator.LESS_THAN&&{operator1:c.CustomFilterOperator.LESS_THAN,val1:r.val.toString()}},"testMappingFilterColumn")},e.LESS_THAN_OR_EQUAL={label:"sheets-filter.conditions.less-than-or-equal",operator:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,numOfParameters:1,order:X.FIRST,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===c.CustomFilterOperator.LESS_THAN_OR_EQUAL},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:e.val1,operator:c.CustomFilterOperator.LESS_THAN_OR_EQUAL}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===c.CustomFilterOperator.LESS_THAN_OR_EQUAL&&{operator1:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val1:r.val.toString()}},"testMappingFilterColumn")},e.EQUAL={label:"sheets-filter.conditions.equal",operator:c.CustomFilterOperator.EQUAL,numOfParameters:1,order:X.FIRST,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:c.CustomFilterOperator.EQUAL,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===c.CustomFilterOperator.EQUAL},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:e.val1,operator:c.CustomFilterOperator.EQUAL}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===c.CustomFilterOperator.EQUAL&&{operator1:c.CustomFilterOperator.EQUAL,val1:r.val.toString()}},"testMappingFilterColumn")},e.NOT_EQUAL={label:"sheets-filter.conditions.not-equal",operator:c.CustomFilterOperator.NOT_EQUALS,numOfParameters:1,order:X.FIRST,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:c.CustomFilterOperator.NOT_EQUALS,val1:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let[t]=Z(e);return t===c.CustomFilterOperator.NOT_EQUALS},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>({customFilters:{customFilters:[{val:e.val1,operator:c.CustomFilterOperator.NOT_EQUALS}]}}),"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==1)return!1;let r=e.customFilters.customFilters[0];return r.operator===c.CustomFilterOperator.NOT_EQUALS&&{operator1:c.CustomFilterOperator.NOT_EQUALS,val1:r.val.toString()}},"testMappingFilterColumn")},e.BETWEEN={label:"sheets-filter.conditions.between",operator:Q.BETWEEN,order:X.SECOND,numOfParameters:2,getDefaultFormParams:/* @__PURE__ */x(()=>({and:!0,operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:"",operator2:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let{and:t,operator1:r,operator2:n}=e;if(!t)return!1;let i=[r,n];return i.includes(c.CustomFilterOperator.GREATER_THAN_OR_EQUAL)&&i.includes(c.CustomFilterOperator.LESS_THAN_OR_EQUAL)},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>{let{val1:t,val2:r,operator1:n}=e,i=n===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL;return{customFilters:{and:d.BooleanNumber.TRUE,customFilters:[{val:i?t:r,operator:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL},{val:i?r:t,operator:c.CustomFilterOperator.LESS_THAN_OR_EQUAL}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==2)return!1;let[r,n]=e.customFilters.customFilters;return r.operator===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&n.operator===c.CustomFilterOperator.LESS_THAN_OR_EQUAL&&e.customFilters.and?{and:!0,operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:r.val.toString(),operator2:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:n.val.toString()}:n.operator===c.CustomFilterOperator.GREATER_THAN_OR_EQUAL&&r.operator===c.CustomFilterOperator.LESS_THAN_OR_EQUAL&&!!e.customFilters.and&&{and:!0,operator1:c.CustomFilterOperator.GREATER_THAN_OR_EQUAL,val1:n.val.toString(),operator2:c.CustomFilterOperator.LESS_THAN_OR_EQUAL,val2:r.val.toLocaleString()}},"testMappingFilterColumn")},e.NOT_BETWEEN={label:"sheets-filter.conditions.not-between",operator:Q.NOT_BETWEEN,order:X.SECOND,numOfParameters:2,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:c.CustomFilterOperator.LESS_THAN,val1:"",operator2:c.CustomFilterOperator.GREATER_THAN,val2:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(e=>{let{and:t,operator1:r,operator2:n}=e;if(t)return!1;let i=[r,n];return i.includes(c.CustomFilterOperator.GREATER_THAN)&&i.includes(c.CustomFilterOperator.LESS_THAN)},"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(e=>{let{val1:t,val2:r,operator1:n}=e,i=n===c.CustomFilterOperator.GREATER_THAN;return{customFilters:{customFilters:[{val:i?t:r,operator:c.CustomFilterOperator.GREATER_THAN},{val:i?r:t,operator:c.CustomFilterOperator.LESS_THAN}]}}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==2)return!1;let[r,n]=e.customFilters.customFilters;return r.operator!==c.CustomFilterOperator.LESS_THAN||n.operator!==c.CustomFilterOperator.GREATER_THAN||e.customFilters.and?n.operator===c.CustomFilterOperator.LESS_THAN&&r.operator===c.CustomFilterOperator.GREATER_THAN&&!e.customFilters.and&&{operator1:c.CustomFilterOperator.GREATER_THAN,val1:n.val.toString(),operator2:c.CustomFilterOperator.LESS_THAN,val2:r.val.toLocaleString()}:{operator1:c.CustomFilterOperator.LESS_THAN,val1:r.val.toString(),operator2:c.CustomFilterOperator.GREATER_THAN,val2:n.val.toString()}},"testMappingFilterColumn")},e.CUSTOM={label:"sheets-filter.conditions.custom",operator:Q.CUSTOM,order:X.SECOND,numOfParameters:2,getDefaultFormParams:/* @__PURE__ */x(()=>({operator1:Q.NONE,val1:"",operator2:Q.NONE,val2:""}),"getDefaultFormParams"),testMappingParams:/* @__PURE__ */x(()=>!0,"testMappingParams"),mapToFilterColumn:/* @__PURE__ */x(t=>{let{and:r,val1:n,val2:i,operator1:a,operator2:o}=t;function s(t,r){for(let n of e.ALL_CONDITIONS)if(n.operator===t)return n.mapToFilterColumn({val1:r,operator1:t})}x(s,"mapOperator");let l=!a||a===e.NONE.operator,u=!o||o===e.NONE.operator;if(l&&u)return e.NONE.mapToFilterColumn({});if(l)return s(o,i);if(u)return s(a,n);let c=s(a,n),h=s(o,i),m={customFilters:[c.customFilters.customFilters[0],h.customFilters.customFilters[0]]};return r&&(m.and=d.BooleanNumber.TRUE),{customFilters:m}},"mapToFilterColumn"),testMappingFilterColumn:/* @__PURE__ */x(e=>{var t;if((null==(t=e.customFilters)?void 0:t.customFilters.length)!==2)return!1;let r=e.customFilters.customFilters.map(e=>a({customFilters:{customFilters:[e]}})),n={operator1:r[0][0].operator,val1:r[0][1].val1,operator2:r[1][0].operator,val2:r[1][1].val1};return e.customFilters.and&&(n.and=!0),n},"testMappingFilterColumn")},e.ALL_CONDITIONS=[e.NONE,e.EMPTY,e.NOT_EMPTY,e.TEXT_CONTAINS,e.DOES_NOT_CONTAIN,e.STARTS_WITH,e.ENDS_WITH,e.EQUALS,e.GREATER_THAN,e.GREATER_THAN_OR_EQUAL,e.LESS_THAN,e.LESS_THAN_OR_EQUAL,e.EQUAL,e.NOT_EQUAL,e.BETWEEN,e.NOT_BETWEEN,e.CUSTOM],x(t,"getItemByOperator"),e.getItemByOperator=t,x(r,"testMappingParams"),e.testMappingParams=r,x(n,"getInitialFormParams"),e.getInitialFormParams=n,x(i,"mapToFilterColumn"),e.mapToFilterColumn=i,x(a,"testMappingFilterColumn"),e.testMappingFilterColumn=a})(q||(q={})),x(Z,"getOnlyOperatorAndVal"),x(J,"statisticFilterByValueItems");var ee=Object.defineProperty,et=Object.getOwnPropertyDescriptor,er=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?et(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ee(t,r,a),a},"__decorateClass$9"),en=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let ei="sheets-filter.generate-filter-values.service",ea=(0,d.createIdentifier)(ei),eo=(x(eS=class extends d.Disposable{constructor(e,t,r){super(),this._localeService=e,this._univerInstanceService=t,this._logService=r}async getFilterValues(e){var t;let{unitId:r,subUnitId:n,filteredOutRowsByOtherColumns:i,filters:a,blankChecked:o,iterateRange:s,alreadyChecked:l}=e,d=null==(t=this._univerInstanceService.getUnit(r))?void 0:t.getSheetBySheetId(n);return d?(this._logService.debug("[SheetsGenerateFilterValuesService]","getFilterValues for",{unitId:r,subUnitId:n}),es(a,o,this._localeService,s,d,new Set(l.map(String)),new Set(i))):[]}},"SheetsGenerateFilterValuesService"),eS);function es(e,t,r,n,i,a,o){let s=[],l={},u=0,c=0;for(let e of i.iterateByColumn(n,!1,!1)){let{row:r,rowSpan:n=1}=e,i=0;for(;i<n;){let h=r+i;if(o.has(h)){i++;continue}let m=null!=e&&e.value?(0,d.extractPureTextFromCell)(e.value):"";if(!m){c+=1,i+=n;continue}if(l[m])l[m].count++;else{let e={value:m,checked:a.size?a.has(m):!t,count:1,index:u,isEmpty:!1};l[m]=e,s.push(e)}i++}u++}if(c>0){let n={value:r.t("sheets-filter.panel.empty"),checked:!e||t,count:c,index:u,isEmpty:!0};s.push(n)}return s}eo=er([en(0,(0,d.Inject)(d.LocaleService)),en(1,d.IUniverInstanceService),en(2,d.ILogService)],eo),x(es,"getFilterByValueItems");var el=Object.defineProperty,ed=Object.getOwnPropertyDescriptor,eu=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ed(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&el(t,r,a),a},"__decorateClass$8"),ec=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8"),eh=((l=eh||{})[l.VALUES=0]="VALUES",l[l.CONDITIONS=1]="CONDITIONS",l);(0,d.createIdentifier)("sheets-filter-ui.sheets-filter-panel.service");let em=(x(eC=class extends d.Disposable{constructor(e,t){super(),A(this,"_filterBy$",new f.BehaviorSubject(0)),A(this,"filterBy$",this._filterBy$.asObservable()),A(this,"_filterByModel$",new w.ReplaySubject(1)),A(this,"filterByModel$",this._filterByModel$.asObservable()),A(this,"_filterByModel",null),A(this,"_hasCriteria$",new f.BehaviorSubject(!1)),A(this,"hasCriteria$",this._hasCriteria$.asObservable()),A(this,"_filterModel",null),A(this,"_col$",new f.BehaviorSubject(-1)),A(this,"col$",this._col$.asObservable()),A(this,"_filterHeaderListener",null),this._injector=e,this._refRangeService=t}get filterBy(){return this._filterBy$.getValue()}get filterByModel(){return this._filterByModel}set filterByModel(e){this._filterByModel=e,this._filterByModel$.next(e)}get filterModel(){return this._filterModel}get col(){return this._col$.getValue()}dispose(){this._filterBy$.complete(),this._filterByModel$.complete(),this._hasCriteria$.complete()}setupCol(e,t){this.terminate(),this._filterModel=e,this._col$.next(t);let r=e.getFilterColumn(t);if(r){let n=r.getColumnData();if(n.customFilters){this._hasCriteria$.next(!0),this._setupByConditions(e,t);return}if(n.filters){this._hasCriteria$.next(!0),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t);return}this._hasCriteria$.next(!1),this._setupByValues(e,t)}changeFilterBy(e){return!!this._filterModel&&-1!==this.col&&(0===e?this._setupByValues(this._filterModel,this.col):this._setupByConditions(this._filterModel,this.col),!0)}terminate(){return this._filterModel=null,this._col$.next(-1),this._disposeFilterHeaderChangeListener(),!0}_disposeFilterHeaderChangeListener(){var e;null==(e=this._filterHeaderListener)||e.dispose(),this._filterHeaderListener=null}_listenToFilterHeaderChange(e,t){this._disposeFilterHeaderChangeListener();let r=e.unitId,n=e.subUnitId,i=e.getRange(),a={startColumn:t,startRow:i.startRow,endRow:i.startRow,endColumn:t};this._filterHeaderListener=this._refRangeService.watchRange(r,n,a,(e,t)=>{if(t){let r=t.startColumn-e.startColumn;0!==r&&this._filterByModel.deltaCol(r)}else this.terminate()})}async _setupByValues(e,t){this._disposePreviousModel();let r=e.getRange();if(r.startRow===r.endRow)return!1;let n=await eg.fromFilterColumn(this._injector,e,t);return this.filterByModel=n,this._filterBy$.next(0),this._listenToFilterHeaderChange(e,t),!0}_setupByConditions(e,t){this._disposePreviousModel();let r=e.getRange();if(r.startRow===r.endRow)return!1;let n=ep.fromFilterColumn(this._injector,e,t,e.getFilterColumn(t));return this.filterByModel=n,this._filterBy$.next(1),this._listenToFilterHeaderChange(e,t),!0}_disposePreviousModel(){var e;null==(e=this._filterByModel)||e.dispose(),this.filterByModel=null}},"SheetsFilterPanelService"),eC);em=eu([ec(0,(0,d.Inject)(d.Injector)),ec(1,(0,d.Inject)(h.RefRangeService))],em);let ep=(x(ey=class extends d.Disposable{constructor(e,t,r,n,i){super(),A(this,"canApply$",(0,y.of)(!0)),A(this,"_conditionItem$"),A(this,"conditionItem$"),A(this,"_filterConditionFormParams$"),A(this,"filterConditionFormParams$"),this._filterModel=e,this.col=t,this._commandService=i,this._conditionItem$=new f.BehaviorSubject(r),this.conditionItem$=this._conditionItem$.asObservable(),this._filterConditionFormParams$=new f.BehaviorSubject(n),this.filterConditionFormParams$=this._filterConditionFormParams$.asObservable()}static fromFilterColumn(e,t,r,n){let[i,a]=q.testMappingFilterColumn(null==n?void 0:n.getColumnData());return e.createInstance(ep,t,r,i,a)}get conditionItem(){return this._conditionItem$.getValue()}get filterConditionFormParams(){return this._filterConditionFormParams$.getValue()}dispose(){super.dispose(),this._conditionItem$.complete(),this._filterConditionFormParams$.complete()}deltaCol(e){this.col+=e}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand($.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;let e=q.mapToFilterColumn(this.conditionItem,this.filterConditionFormParams);return this._commandService.executeCommand($.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:e})}onPrimaryConditionChange(e){let t=q.ALL_CONDITIONS.find(t=>t.operator===e);if(!t)throw Error(`[ByConditionsModel]: condition item not found for operator: ${e}!`);this._conditionItem$.next(t),this._filterConditionFormParams$.next(q.getInitialFormParams(e))}onConditionFormChange(e){let t={...this.filterConditionFormParams,...e};if(!0!==t.and&&delete t.and,"u">typeof e.and||"u">typeof e.operator1||"u">typeof e.operator2){let e=q.testMappingParams(t,this.conditionItem.numOfParameters);this._conditionItem$.next(e)}this._filterConditionFormParams$.next(t)}},"ByConditionsModel"),ey);ep=eu([ec(4,d.ICommandService)],ep);let eg=(x(ew=class extends d.Disposable{constructor(e,t,r,n){super(),A(this,"_rawFilterItems$"),A(this,"rawFilterItems$"),A(this,"filterItems$"),A(this,"_filterItems",[]),A(this,"canApply$"),A(this,"_manuallyUpdateFilterItems$"),A(this,"_searchString$"),A(this,"searchString$"),this._filterModel=e,this.col=t,this._commandService=n,this._searchString$=new f.BehaviorSubject(""),this.searchString$=this._searchString$.asObservable(),this._rawFilterItems$=new f.BehaviorSubject(r),this.rawFilterItems$=this._rawFilterItems$.asObservable(),this._manuallyUpdateFilterItems$=new E.Subject,this.filterItems$=(0,C.merge)((0,v.combineLatest)([this._searchString$.pipe((0,O.throttleTime)(500,void 0,{leading:!0,trailing:!0}),(0,R.startWith)(void 0)),this._rawFilterItems$]).pipe((0,S.map)(([e,t])=>{if(!e)return t;let r=e.toLowerCase().split(/\s+/).filter(e=>!!e);return t.filter(e=>{let t=e.value.toLowerCase();return r.some(e=>t.includes(e))})})),this._manuallyUpdateFilterItems$).pipe((0,b.shareReplay)(1)),this.canApply$=this.filterItems$.pipe((0,S.map)(e=>J(e).checked>0)),this.disposeWithMe(this.filterItems$.subscribe(e=>this._filterItems=e))}static async fromFilterColumn(e,t,r){var n;let i;let a=e.get(d.IUniverInstanceService),o=e.get(d.LocaleService),s=e.get(ea,d.Quantity.OPTIONAL),{unitId:l,subUnitId:u}=t,c=a.getUniverSheetInstance(l);if(!c)throw Error(`[ByValuesModel]: Workbook not found for filter model with unitId: ${l}!`);let h=null==c?void 0:c.getSheetBySheetId(u);if(!h)throw Error(`[ByValuesModel]: Worksheet not found for filter model with unitId: ${l} and subUnitId: ${u}!`);let m=t.getRange(),p=null==(n=t.getFilterColumn(r))?void 0:n.getColumnData().filters,g=new Set(null==p?void 0:p.filters),f=!!(p&&p.blank),v=t.getFilteredOutRowsExceptCol(r),_={...m,startRow:m.startRow+1,startColumn:r,endColumn:r};return i=s?await s.getFilterValues({unitId:l,subUnitId:u,filteredOutRowsByOtherColumns:Array.from(v),filters:!!p,blankChecked:f,iterateRange:_,alreadyChecked:Array.from(g)}):es(!!p,f,o,_,h,g,v),e.createInstance(eg,t,r,i)}get rawFilterItems(){return this._rawFilterItems$.getValue()}get filterItems(){return this._filterItems}dispose(){this._rawFilterItems$.complete(),this._searchString$.complete()}deltaCol(e){this.col+=e}setSearchString(e){this._searchString$.next(e)}onFilterCheckToggled(e,t){let r=this._filterItems.slice();r.find(t=>t.index===e.index).checked=t,this._manuallyUpdateFilterItems(r)}onFilterOnly(e){let t=this._filterItems.slice();t.forEach(t=>t.checked=t.index===e.index),this._manuallyUpdateFilterItems(t)}onCheckAllToggled(e){let t=this._filterItems.slice();t.forEach(t=>t.checked=e),this._manuallyUpdateFilterItems(t)}_manuallyUpdateFilterItems(e){this._manuallyUpdateFilterItems$.next(e)}clear(){return this._disposed?Promise.resolve(!1):this._commandService.executeCommand($.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null})}async apply(){if(this._disposed)return!1;let e=J(this._filterItems),{checked:t,checkedItems:r}=e,n=this.rawFilterItems,i=e.checked===n.length,a={colId:this.col};if(0===t)throw Error("[ByValuesModel]: no checked items!");if(i)return this._commandService.executeCommand($.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:null});{a.filters={};let e=r.filter(e=>!e.isEmpty);e.length>0&&(a.filters={filters:e.map(e=>e.value)}),e.length!==r.length&&(a.filters.blank=!0)}return this._commandService.executeCommand($.id,{unitId:this._filterModel.unitId,subUnitId:this._filterModel.subUnitId,col:this.col,criteria:a})}},"ByValuesModel"),ew);eg=eu([ec(3,d.ICommandService)],eg);let ef="FILTER_PANEL_OPENED",ev={id:"sheet.operation.open-filter-panel",type:d.CommandType.OPERATION,handler:/* @__PURE__ */x((e,t)=>{let r=e.get(d.IContextService),n=e.get(c.SheetsFilterService),i=e.get(em);e.get(d.ICommandService).syncExecuteCommand(m.SetCellEditVisibleOperation.id,{visible:!1});let{unitId:a,subUnitId:o,col:s}=t,l=n.getFilterModel(a,o);return!!l&&(i.setupCol(l,s),r.getContextValue(ef)||r.setContextValue(ef,!0),!0)},"handler")},e_={id:"sheet.operation.close-filter-panel",type:d.CommandType.OPERATION,handler:/* @__PURE__ */x(e=>{let t=e.get(d.IContextService),r=e.get(em),n=e.get(g.ILayoutService,d.Quantity.OPTIONAL);return!!t.getContextValue(ef)&&(t.setContextValue(ef,!1),null==n||n.focus(),r.terminate())},"handler")},eI={id:"sheet.operation.apply-filter",type:d.CommandType.OPERATION,handler:/* @__PURE__ */x((e,t)=>{let{filterBy:r}=t;return e.get(em).changeFilterBy(r)},"handler")};var eS,eC,ey,ew,eb,eR=Object.defineProperty,eE=Object.getOwnPropertyDescriptor,eT=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eE(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eR(t,r,a),a},"__decorateClass$7"),eM=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let eO=(x(eb=class extends d.Disposable{constructor(e,t,r,n,i,a){super(),this._sheetsFilterService=e,this._localeService=t,this._commandService=r,this._sheetPermissionInterceptorBaseController=n,this._injector=i,this._sheetsSelectionService=a,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{var t,r,n;if(e.id===H.id){let e;let n=this._injector.get(d.IUniverInstanceService),i=(0,h.getSheetCommandTarget)(n);if(!i)return;let{unitId:a,subUnitId:o,worksheet:s}=i,l=null==(t=this._sheetsFilterService.getFilterModel(a,o))?void 0:t.getRange();if(l)e=this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({rangeTypes:[h.RangeProtectionPermissionViewPoint],worksheetTypes:[h.WorksheetFilterPermission,h.WorksheetViewPermission]},[l]);else{let t=null==(r=this._sheetsSelectionService.getCurrentLastSelection())?void 0:r.range;if(t){let r={...t};r=t.startColumn===t.endColumn&&t.startRow===t.endRow?(0,h.expandToContinuousRange)(r,{left:!0,right:!0,up:!0,down:!0},s):r,e=this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({rangeTypes:[h.RangeProtectionPermissionViewPoint],worksheetTypes:[h.WorksheetViewPermission,h.WorksheetFilterPermission]},[r],a,o)}else e=this._sheetPermissionInterceptorBaseController.permissionCheckWithoutRange({rangeTypes:[h.RangeProtectionPermissionViewPoint],worksheetTypes:[h.WorksheetViewPermission,h.WorksheetFilterPermission]})}e||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.filterErr"))}if(e.id===ev.id){let t=e.params,{unitId:r,subUnitId:i}=t,a=null==(n=this._sheetsFilterService.getFilterModel(r,i))?void 0:n.getRange(),o=(0,d.Tools).deepClone(a);o&&(o.startColumn=t.col,o.endColumn=t.col,this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({rangeTypes:[h.RangeProtectionPermissionViewPoint],worksheetTypes:[h.WorksheetFilterPermission,h.WorksheetViewPermission]},[o])||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.filterErr")))}}))}},"SheetsFilterPermissionController"),eb);eO=eT([eM(0,(0,d.Inject)(c.SheetsFilterService)),eM(1,(0,d.Inject)(d.LocaleService)),eM(2,d.ICommandService),eM(3,(0,d.Inject)(m.SheetPermissionInterceptorBaseController)),eM(4,(0,d.Inject)(d.Injector)),eM(5,(0,d.Inject)(h.SheetsSelectionsService))],eO);var eD=function(){return(eD=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},eU=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},ek=(0,U.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=eU(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,U.useRef)("_".concat(eA()));return eP(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},eD({ref:t,className:s},o),a)});function eP(e,t,r,n,i){return(0,U.createElement)(e.tag,eD(eD({key:t},eN(e,r,i)),n),(ex(e,r).children||[]).map(function(n,a){return eP(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function eN(e,t,r){var n=eD({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function ex(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?eD(eD({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?eD(eD({},e),{attrs:eD(eD({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function eA(){return Math.random().toString(36).substring(2,8)}x(eP,"render"),x(eN,"replaceRuntimeIdsAndExtInAttrs"),x(ex,"replaceRuntimeIdsInDefs"),x(eA,"generateShortUuid"),ek.displayName="UniverIcon";var eL={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.32182 2.60967C2.98161 2.60967 2.79671 3.0074 3.01601 3.2675L6.85819 7.8246C6.94943 7.93282 6.99947 8.06981 6.99947 8.21136V12.7338C6.99947 12.898 7.0998 13.0455 7.2525 13.1058L8.73833 13.6928C9.00085 13.7965 9.28531 13.6031 9.28531 13.3208V8.21136C9.28531 8.06981 9.33535 7.93282 9.42659 7.8246L13.2688 3.2675C13.4881 3.0074 13.3032 2.60967 12.963 2.60967H3.32182ZM2.09858 4.04101C1.22139 3.0006 1.96097 1.40967 3.32182 1.40967H12.963C14.3238 1.40967 15.0634 3.0006 14.1862 4.04101L10.4853 8.43054V13.3208C10.4853 14.4498 9.34747 15.2237 8.29742 14.8089L6.81158 14.2219C6.20078 13.9806 5.79947 13.3905 5.79947 12.7338V8.43054L2.09858 4.04101Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eF=(0,U.forwardRef)(function(e,t){return(0,U.createElement)(ek,Object.assign({},e,{id:"filter-single",ref:t,icon:eL}))});eF.displayName="FilterSingle";let ej={sheetsFilterPanel:"univer-sheets-filter-panel",sheetsFilterPanelHeader:"univer-sheets-filter-panel-header",sheetsFilterPanelContent:"univer-sheets-filter-panel-content",sheetsFilterPanelValuesContainer:"univer-sheets-filter-panel-values-container",sheetsFilterPanelValuesList:"univer-sheets-filter-panel-values-list",sheetsFilterPanelValuesVirtual:"univer-sheets-filter-panel-values-virtual",sheetsFilterPanelValuesItem:"univer-sheets-filter-panel-values-item",sheetsFilterPanelValuesItemInner:"univer-sheets-filter-panel-values-item-inner",sheetsFilterPanelValuesItemCount:"univer-sheets-filter-panel-values-item-count",sheetsFilterPanelValuesItemExcludeButton:"univer-sheets-filter-panel-values-item-exclude-button",sheetsFilterPanelValuesItemText:"univer-sheets-filter-panel-values-item-text",sheetsFilterPanelConditionsContainer:"univer-sheets-filter-panel-conditions-container",sheetsFilterPanelConditionsContainerInner:"univer-sheets-filter-panel-conditions-container-inner",sheetsFilterPanelConditionsDesc:"univer-sheets-filter-panel-conditions-desc",sheetsFilterPanelFooter:"univer-sheets-filter-panel-footer",sheetsFilterPanelFooterPrimaryButtons:"univer-sheets-filter-panel-footer-primary-buttons"};function eV(e){let{model:r}=e,n=(0,d.useDependency)(d.LocaleService),i=(0,g.useObservable)(r.conditionItem$,void 0,!0),a=(0,g.useObservable)(r.filterConditionFormParams$,void 0,!0),{operator:o,numOfParameters:s}=i,{operator1:l,operator2:u,val1:c,val2:h,and:m}=a,f=m?"AND":"OR",v=(0,U.useCallback)(e=>{r.onConditionFormChange({and:"AND"===e})},[r]),_=eH(n),I=(0,U.useCallback)(e=>{r.onPrimaryConditionChange(e)},[r]),S=e$(n),C=(0,U.useCallback)(e=>{r.onConditionFormChange(e)},[r]),y=n.t("sheets-filter.panel.input-values-placeholder");function w(e,r,i){let a=1===q.getItemByOperator(e).numOfParameters;return /* @__PURE__ *//*@__PURE__*/t(U).createElement(/*@__PURE__*/t(U).Fragment,null,"operator2"===i&&/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.RadioGroup,{value:f,onChange:v},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Radio,{value:"AND"},n.t("sheets-filter.panel.and")),/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Radio,{value:"OR"},n.t("sheets-filter.panel.or"))),/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Select,{value:e,options:S,onChange:/* @__PURE__ */x(e=>C({[i]:e}),"onChange")}),a&&/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",null,/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Input,{value:r,placeholder:y,onChange:/* @__PURE__ */x(e=>C({["operator1"===i?"val1":"val2"]:e}),"onChange")})))}return x(w,"renderSecondaryCondition"),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelConditionsContainer},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Select,{value:o,options:_,onChange:I}),0!==q.getItemByOperator(o).numOfParameters?/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelConditionsContainerInner},s>=1&&w(l,null!=c?c:"","operator1"),s>=2&&w(u,null!=h?h:"","operator2"),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelConditionsDesc},n.t("sheets-filter.panel.?"),/* @__PURE__ *//*@__PURE__*/t(U).createElement("br",null),n.t("sheets-filter.panel.*"))):null)}function eH(e){let t=e.getCurrentLocale();return(0,U.useMemo)(()=>[{options:[{label:e.t(q.NONE.label),value:q.NONE.operator}]},{options:[{label:e.t(q.EMPTY.label),value:q.EMPTY.operator},{label:e.t(q.NOT_EMPTY.label),value:q.NOT_EMPTY.operator}]},{options:[{label:e.t(q.TEXT_CONTAINS.label),value:q.TEXT_CONTAINS.operator},{label:e.t(q.DOES_NOT_CONTAIN.label),value:q.DOES_NOT_CONTAIN.operator},{label:e.t(q.STARTS_WITH.label),value:q.STARTS_WITH.operator},{label:e.t(q.ENDS_WITH.label),value:q.ENDS_WITH.operator},{label:e.t(q.EQUALS.label),value:q.EQUALS.operator}]},{options:[{label:e.t(q.GREATER_THAN.label),value:q.GREATER_THAN.operator},{label:e.t(q.GREATER_THAN_OR_EQUAL.label),value:q.GREATER_THAN_OR_EQUAL.operator},{label:e.t(q.LESS_THAN.label),value:q.LESS_THAN.operator},{label:e.t(q.LESS_THAN_OR_EQUAL.label),value:q.LESS_THAN_OR_EQUAL.operator},{label:e.t(q.EQUAL.label),value:q.EQUAL.operator},{label:e.t(q.NOT_EQUAL.label),value:q.NOT_EQUAL.operator},{label:e.t(q.BETWEEN.label),value:q.BETWEEN.operator},{label:e.t(q.NOT_BETWEEN.label),value:q.NOT_BETWEEN.operator}]},{options:[{label:e.t(q.CUSTOM.label),value:q.CUSTOM.operator}]}],[t,e])}function e$(e){let t=e.getCurrentLocale();return(0,U.useMemo)(()=>q.ALL_CONDITIONS.filter(e=>2!==e.numOfParameters).map(t=>({label:e.t(t.label),value:t.operator})),[t,e])}function eB(){return(eB=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)({}).hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(null,arguments)}function eW(e){return(eW="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function eG(e,t){if("object"!=eW(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=eW(n))return n;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function ez(e){var t=eG(e,"string");return"symbol"==eW(t)?t:t+""}function eY(e,t,r){return(t=ez(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function eK(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function eq(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?eK(Object(r),!0).forEach(function(t){eY(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):eK(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function eX(e){if(Array.isArray(e))return e}function eQ(e,t){var r=null==e?null:"u">typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,a,o,s=[],l=!0,d=!1;try{if(a=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;l=!1}else for(;!(l=(n=a.call(r)).done)&&(s.push(n.value),s.length!==t);l=!0);}catch(e){d=!0,i=e}finally{try{if(!l&&null!=r.return&&(o=r.return(),Object(o)!==o))return}finally{if(d)throw i}}return s}}function eZ(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function eJ(e,t){if(e){if("string"==typeof e)return eZ(e,t);var r=({}).toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?eZ(e,t):void 0}}function e1(){throw TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function e0(e,t){return eX(e)||eQ(e,t)||eJ(e,t)||e1()}function e3(e,t){if(null==e)return{};var r={};for(var n in e)if(({}).hasOwnProperty.call(e,n)){if(t.indexOf(n)>=0)continue;r[n]=e[n]}return r}function e2(e,t){if(null==e)return{};var r,n,i=e3(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||({}).propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function e4(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}x(eV,"FilterByCondition"),x(eH,"usePrimaryOptions"),x(e$,"useSecondaryOptions"),x(eB,"_extends"),x(eW,"_typeof"),x(eG,"toPrimitive"),x(ez,"toPropertyKey"),x(eY,"_defineProperty"),x(eK,"ownKeys"),x(eq,"_objectSpread2"),x(eX,"_arrayWithHoles"),x(eQ,"_iterableToArrayLimit"),x(eZ,"_arrayLikeToArray"),x(eJ,"_unsupportedIterableToArray"),x(e1,"_nonIterableRest"),x(e0,"_slicedToArray"),x(e3,"_objectWithoutPropertiesLoose"),x(e2,"_objectWithoutProperties"),x(e4,"getDefaultExportFromCjs");var e6={exports:{}};(function(){var e={}.hasOwnProperty;function t(){for(var e="",t=0;t<arguments.length;t++){var i=arguments[t];i&&(e=n(e,r(i)))}return e}function r(r){if("string"==typeof r||"number"==typeof r)return r;if("object"!=typeof r)return"";if(Array.isArray(r))return t.apply(null,r);if(r.toString!==Object.prototype.toString&&!r.toString.toString().includes("[native code]"))return r.toString();var i="";for(var a in r)e.call(r,a)&&r[a]&&(i=n(i,a));return i}function n(e,t){return t?e?e+" "+t:e+t:e}x(t,"classNames"),x(r,"parseValue"),x(n,"appendClass"),e6.exports?(t.default=t,e6.exports=t):window.classNames=t})();let e9=/* @__PURE__ */e4(e6.exports);var e5,e8={exports:{}},e7={},te=Symbol.for("react.element"),tt=Symbol.for("react.portal"),tr=Symbol.for("react.fragment"),tn=Symbol.for("react.strict_mode"),ti=Symbol.for("react.profiler"),ta=Symbol.for("react.provider"),to=Symbol.for("react.context"),ts=Symbol.for("react.server_context"),tl=Symbol.for("react.forward_ref"),td=Symbol.for("react.suspense"),tu=Symbol.for("react.suspense_list"),tc=Symbol.for("react.memo"),th=Symbol.for("react.lazy"),tm=Symbol.for("react.offscreen");function tp(e){if("object"==typeof e&&null!==e){var t=e.$$typeof;switch(t){case te:switch(e=e.type){case tr:case ti:case tn:case td:case tu:return e;default:switch(e=e&&e.$$typeof){case ts:case to:case tl:case th:case tc:case ta:return e;default:return t}}case tt:return t}}}e5=Symbol.for("react.module.reference"),x(tp,"v"),e7.ContextConsumer=to,e7.ContextProvider=ta,e7.Element=te,e7.ForwardRef=tl,e7.Fragment=tr,e7.Lazy=th,e7.Memo=tc,e7.Portal=tt,e7.Profiler=ti,e7.StrictMode=tn,e7.Suspense=td,e7.SuspenseList=tu,e7.isAsyncMode=function(){return!1},e7.isConcurrentMode=function(){return!1},e7.isContextConsumer=function(e){return tp(e)===to},e7.isContextProvider=function(e){return tp(e)===ta},e7.isElement=function(e){return"object"==typeof e&&null!==e&&e.$$typeof===te},e7.isForwardRef=function(e){return tp(e)===tl},e7.isFragment=function(e){return tp(e)===tr},e7.isLazy=function(e){return tp(e)===th},e7.isMemo=function(e){return tp(e)===tc},e7.isPortal=function(e){return tp(e)===tt},e7.isProfiler=function(e){return tp(e)===ti},e7.isStrictMode=function(e){return tp(e)===tn},e7.isSuspense=function(e){return tp(e)===td},e7.isSuspenseList=function(e){return tp(e)===tu},e7.isValidElementType=function(e){return"string"==typeof e||"function"==typeof e||e===tr||e===ti||e===tn||e===td||e===tu||e===tm||"object"==typeof e&&null!==e&&(e.$$typeof===th||e.$$typeof===tc||e.$$typeof===ta||e.$$typeof===to||e.$$typeof===tl||e.$$typeof===e5||void 0!==e.getModuleId)},e7.typeOf=tp,e8.exports=e7;var tg=e8.exports;function tf(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=[];return /*@__PURE__*/t(U).Children.forEach(e,function(e){(null!=e||r.keepEmpty)&&(Array.isArray(e)?n=n.concat(tf(e)):tg.isFragment(e)&&e.props?n=n.concat(tf(e.props.children,r)):n.push(e))}),n}function tv(e){return e instanceof HTMLElement||e instanceof SVGElement}function t_(e){return e&&"object"===eW(e)&&tv(e.nativeElement)?e.nativeElement:tv(e)?e:null}function tI(e){var r;return t_(e)||(e instanceof /*@__PURE__*/t(U).Component?null===(r=/*@__PURE__*/t(k).findDOMNode)||void 0===r?void 0:r.call(/*@__PURE__*/t(k),e):null)}function tS(e,t,r){var n=U.useRef({});return(!("value"in n.current)||r(n.current.condition,t))&&(n.current.value=e(),n.current.condition=t),n.current.value}x(tf,"toArray"),x(tv,"isDOM"),x(t_,"getDOM"),x(tI,"findDOMNode"),x(tS,"useMemo");var tC=/* @__PURE__ */x(function(e,t){"function"==typeof e?e(t):"object"===eW(e)&&e&&"current"in e&&(e.current=t)},"fillRef"),ty=/* @__PURE__ */x(function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=t.filter(Boolean);return n.length<=1?n[0]:function(e){t.forEach(function(t){tC(t,e)})}},"composeRef"),tw=/* @__PURE__ */x(function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return tS(function(){return ty.apply(void 0,t)},t,function(e,t){return e.length!==t.length||e.every(function(e,r){return e!==t[r]})})},"useComposeRef"),tb=/* @__PURE__ */x(function(e){var t,r,n=tg.isMemo(e)?e.type.type:e.type;return!("function"==typeof n&&!(null!==(t=n.prototype)&&void 0!==t&&t.render)&&n.$$typeof!==tg.ForwardRef||"function"==typeof e&&!(null!==(r=e.prototype)&&void 0!==r&&r.render)&&e.$$typeof!==tg.ForwardRef)},"supportRef");x(function(e){return/* @__PURE__ */(0,U.isValidElement)(e)&&!tg.isFragment(e)},"isReactElement"),(0,U.version).split(".")[0];var tR=/* @__PURE__ */U.createContext(null);function tE(e){var t=e.children,r=e.onBatchResize,n=U.useRef(0),i=U.useRef([]),a=U.useContext(tR),o=U.useCallback(function(e,t,o){n.current+=1;var s=n.current;i.current.push({size:e,element:t,data:o}),Promise.resolve().then(function(){s===n.current&&(null==r||r(i.current),i.current=[])}),null==a||a(e,t,o)},[r,a]);return /* @__PURE__ */U.createElement(tR.Provider,{value:o},t)}x(tE,"Collection");var tT=function(){if("u">typeof Map)return Map;function e(e,t){var r=-1;return e.some(function(e,n){return e[0]===t&&(r=n,!0)}),r}return x(e,"getIndex"),function(){function t(){this.__entries__=[]}return x(t,"class_1"),Object.defineProperty(t.prototype,"size",{get:/* @__PURE__ */x(function(){return this.__entries__.length},"get"),enumerable:!0,configurable:!0}),t.prototype.get=function(t){var r=e(this.__entries__,t),n=this.__entries__[r];return n&&n[1]},t.prototype.set=function(t,r){var n=e(this.__entries__,t);~n?this.__entries__[n][1]=r:this.__entries__.push([t,r])},t.prototype.delete=function(t){var r=this.__entries__,n=e(r,t);~n&&r.splice(n,1)},t.prototype.has=function(t){return!!~e(this.__entries__,t)},t.prototype.clear=function(){this.__entries__.splice(0)},t.prototype.forEach=function(e,t){void 0===t&&(t=null);for(var r=0,n=this.__entries__;r<n.length;r++){var i=n[r];e.call(t,i[1],i[0])}},t}()}(),tM="u">typeof window&&"u">typeof document&&window.document===document,tO="u">typeof r&&r.Math===Math?r:"u">typeof self&&self.Math===Math?self:"u">typeof window&&window.Math===Math?window:Function("return this")(),tD="function"==typeof requestAnimationFrame?requestAnimationFrame.bind(tO):function(e){return setTimeout(function(){return e(Date.now())},1e3/60)};function tU(e,t){var r=!1,n=!1,i=0;function a(){r&&(r=!1,e()),n&&s()}function o(){tD(a)}function s(){var e=Date.now();if(r){if(e-i<2)return;n=!0}else r=!0,n=!1,setTimeout(o,t);i=e}return x(a,"resolvePending"),x(o,"timeoutCallback"),x(s,"proxy"),s}x(tU,"throttle");var tk=["top","right","bottom","left","width","height","size","weight"],tP="u">typeof MutationObserver,tN=function(){function e(){this.connected_=!1,this.mutationEventsAdded_=!1,this.mutationsObserver_=null,this.observers_=[],this.onTransitionEnd_=this.onTransitionEnd_.bind(this),this.refresh=tU(this.refresh.bind(this),20)}return x(e,"ResizeObserverController"),e.prototype.addObserver=function(e){~this.observers_.indexOf(e)||this.observers_.push(e),this.connected_||this.connect_()},e.prototype.removeObserver=function(e){var t=this.observers_,r=t.indexOf(e);~r&&t.splice(r,1),!t.length&&this.connected_&&this.disconnect_()},e.prototype.refresh=function(){this.updateObservers_()&&this.refresh()},e.prototype.updateObservers_=function(){var e=this.observers_.filter(function(e){return e.gatherActive(),e.hasActive()});return e.forEach(function(e){return e.broadcastActive()}),e.length>0},e.prototype.connect_=function(){!tM||this.connected_||(document.addEventListener("transitionend",this.onTransitionEnd_),window.addEventListener("resize",this.refresh),tP?(this.mutationsObserver_=new MutationObserver(this.refresh),this.mutationsObserver_.observe(document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})):(document.addEventListener("DOMSubtreeModified",this.refresh),this.mutationEventsAdded_=!0),this.connected_=!0)},e.prototype.disconnect_=function(){tM&&this.connected_&&(document.removeEventListener("transitionend",this.onTransitionEnd_),window.removeEventListener("resize",this.refresh),this.mutationsObserver_&&this.mutationsObserver_.disconnect(),this.mutationEventsAdded_&&document.removeEventListener("DOMSubtreeModified",this.refresh),this.mutationsObserver_=null,this.mutationEventsAdded_=!1,this.connected_=!1)},e.prototype.onTransitionEnd_=function(e){var t=e.propertyName,r=void 0===t?"":t;tk.some(function(e){return!!~r.indexOf(e)})&&this.refresh()},e.getInstance=function(){return this.instance_||(this.instance_=new e),this.instance_},e.instance_=null,e}(),tx=/* @__PURE__ */x(function(e,t){for(var r=0,n=Object.keys(t);r<n.length;r++){var i=n[r];Object.defineProperty(e,i,{value:t[i],enumerable:!1,writable:!1,configurable:!0})}return e},"defineConfigurable"),tA=/* @__PURE__ */x(function(e){return e&&e.ownerDocument&&e.ownerDocument.defaultView||tO},"getWindowOf"),tL=tY(0,0,0,0);function tF(e){return parseFloat(e)||0}function tj(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return t.reduce(function(t,r){return t+tF(e["border-"+r+"-width"])},0)}function tV(e){for(var t={},r=0,n=["top","right","bottom","left"];r<n.length;r++){var i=n[r],a=e["padding-"+i];t[i]=tF(a)}return t}function tH(e){var t=e.getBBox();return tY(0,0,t.width,t.height)}function t$(e){var t=e.clientWidth,r=e.clientHeight;if(!t&&!r)return tL;var n=tA(e).getComputedStyle(e),i=tV(n),a=i.left+i.right,o=i.top+i.bottom,s=tF(n.width),l=tF(n.height);if("border-box"===n.boxSizing&&(Math.round(s+a)!==t&&(s-=tj(n,"left","right")+a),Math.round(l+o)!==r&&(l-=tj(n,"top","bottom")+o)),!tW(e)){var d=Math.round(s+a)-t,u=Math.round(l+o)-r;1!==Math.abs(d)&&(s-=d),1!==Math.abs(u)&&(l-=u)}return tY(i.left,i.top,s,l)}x(tF,"toFloat"),x(tj,"getBordersSize"),x(tV,"getPaddings"),x(tH,"getSVGContentRect"),x(t$,"getHTMLElementContentRect");var tB="u">typeof SVGGraphicsElement?function(e){return e instanceof tA(e).SVGGraphicsElement}:function(e){return e instanceof tA(e).SVGElement&&"function"==typeof e.getBBox};function tW(e){return e===tA(e).document.documentElement}function tG(e){return tM?tB(e)?tH(e):t$(e):tL}function tz(e){var t=e.x,r=e.y,n=e.width,i=e.height,a=Object.create(("u">typeof DOMRectReadOnly?DOMRectReadOnly:Object).prototype);return tx(a,{x:t,y:r,width:n,height:i,top:r,right:t+n,bottom:i+r,left:t}),a}function tY(e,t,r,n){return{x:e,y:t,width:r,height:n}}x(tW,"isDocumentElement"),x(tG,"getContentRect"),x(tz,"createReadOnlyRect"),x(tY,"createRectInit");var tK=function(){function e(e){this.broadcastWidth=0,this.broadcastHeight=0,this.contentRect_=tY(0,0,0,0),this.target=e}return x(e,"ResizeObservation"),e.prototype.isActive=function(){var e=tG(this.target);return this.contentRect_=e,e.width!==this.broadcastWidth||e.height!==this.broadcastHeight},e.prototype.broadcastRect=function(){var e=this.contentRect_;return this.broadcastWidth=e.width,this.broadcastHeight=e.height,e},e}(),tq=function(){function e(e,t){tx(this,{target:e,contentRect:tz(t)})}return x(e,"ResizeObserverEntry"),e}(),tX=function(){function e(e,t,r){if(this.activeObservations_=[],this.observations_=new tT,"function"!=typeof e)throw TypeError("The callback provided as parameter 1 is not a function.");this.callback_=e,this.controller_=t,this.callbackCtx_=r}return x(e,"ResizeObserverSPI"),e.prototype.observe=function(e){if(!arguments.length)throw TypeError("1 argument required, but only 0 present.");if(!(typeof Element>"u"||!(Element instanceof Object))){if(!(e instanceof tA(e).Element))throw TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)||(t.set(e,new tK(e)),this.controller_.addObserver(this),this.controller_.refresh())}},e.prototype.unobserve=function(e){if(!arguments.length)throw TypeError("1 argument required, but only 0 present.");if(!(typeof Element>"u"||!(Element instanceof Object))){if(!(e instanceof tA(e).Element))throw TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)&&(t.delete(e),t.size||this.controller_.removeObserver(this))}},e.prototype.disconnect=function(){this.clearActive(),this.observations_.clear(),this.controller_.removeObserver(this)},e.prototype.gatherActive=function(){var e=this;this.clearActive(),this.observations_.forEach(function(t){t.isActive()&&e.activeObservations_.push(t)})},e.prototype.broadcastActive=function(){if(this.hasActive()){var e=this.callbackCtx_,t=this.activeObservations_.map(function(e){return new tq(e.target,e.broadcastRect())});this.callback_.call(e,t,e),this.clearActive()}},e.prototype.clearActive=function(){this.activeObservations_.splice(0)},e.prototype.hasActive=function(){return this.activeObservations_.length>0},e}(),tQ="u">typeof WeakMap?/* @__PURE__ */new WeakMap:new tT,tZ=function(){function e(t){if(!(this instanceof e))throw TypeError("Cannot call a class as a function.");if(!arguments.length)throw TypeError("1 argument required, but only 0 present.");var r=new tX(t,tN.getInstance(),this);tQ.set(this,r)}return x(e,"ResizeObserver"),e}();["observe","unobserve","disconnect"].forEach(function(e){tZ.prototype[e]=function(){var t;return(t=tQ.get(this))[e].apply(t,arguments)}});var tJ="u">typeof tO.ResizeObserver?tO.ResizeObserver:tZ,t1=/* @__PURE__ */new Map;function t0(e){e.forEach(function(e){var t,r=e.target;null===(t=t1.get(r))||void 0===t||t.forEach(function(e){return e(r)})})}x(t0,"onResize");var t3=new tJ(t0);function t2(e,t){t1.has(e)||(t1.set(e,/* @__PURE__ */new Set),t3.observe(e)),t1.get(e).add(t)}function t4(e,t){t1.has(e)&&(t1.get(e).delete(t),t1.get(e).size||(t3.unobserve(e),t1.delete(e)))}function t6(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function t9(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,ez(n.key),n)}}function t5(e,t,r){return t&&t9(e.prototype,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function t8(e,t){return(t8=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function t7(e,t){if("function"!=typeof t&&null!==t)throw TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&t8(e,t)}function re(e){return(re=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function rt(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch{}return(rt=/* @__PURE__ */x(function(){return!!e},"_isNativeReflectConstruct"))()}function rr(e){if(void 0===e)throw ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function rn(e,t){if(t&&("object"==eW(t)||"function"==typeof t))return t;if(void 0!==t)throw TypeError("Derived constructors may only return object or undefined");return rr(e)}function ri(e){var t=rt();return function(){var r,n=re(e);return r=t?Reflect.construct(n,arguments,re(this).constructor):n.apply(this,arguments),rn(this,r)}}x(t2,"observe"),x(t4,"unobserve"),x(t6,"_classCallCheck"),x(t9,"_defineProperties"),x(t5,"_createClass"),x(t8,"_setPrototypeOf"),x(t7,"_inherits"),x(re,"_getPrototypeOf"),x(rt,"_isNativeReflectConstruct"),x(rr,"_assertThisInitialized"),x(rn,"_possibleConstructorReturn"),x(ri,"_createSuper");var ra=/* @__PURE__ */function(e){t7(r,e);var t=ri(r);function r(){return t6(this,r),t.apply(this,arguments)}return x(r,"DomWrapper"),t5(r,[{key:"render",value:/* @__PURE__ */x(function(){return this.props.children},"render")}]),r}(U.Component);function ro(e,t){var r=e.children,n=e.disabled,i=U.useRef(null),a=U.useRef(null),o=U.useContext(tR),s="function"==typeof r,l=s?r(i):r,d=U.useRef({width:-1,height:-1,offsetWidth:-1,offsetHeight:-1}),u=!s&&/* @__PURE__ */U.isValidElement(l)&&tb(l),c=tw(u?l.ref:null,i),h=/* @__PURE__ */x(function(){var e;return tI(i.current)||(i.current&&"object"===eW(i.current)?tI(null===(e=i.current)||void 0===e?void 0:e.nativeElement):null)||tI(a.current)},"getDom2");U.useImperativeHandle(t,function(){return h()});var m=U.useRef(e);m.current=e;var p=U.useCallback(function(e){var t=m.current,r=t.onResize,n=t.data,i=e.getBoundingClientRect(),a=i.width,s=i.height,l=e.offsetWidth,u=e.offsetHeight,c=Math.floor(a),h=Math.floor(s);if(d.current.width!==c||d.current.height!==h||d.current.offsetWidth!==l||d.current.offsetHeight!==u){var p={width:c,height:h,offsetWidth:l,offsetHeight:u};d.current=p;var g=l===Math.round(a)?a:l,f=u===Math.round(s)?s:u,v=eq(eq({},p),{},{offsetWidth:g,offsetHeight:f});null==o||o(v,e,n),r&&Promise.resolve().then(function(){r(v,e)})}},[]);return U.useEffect(function(){var e=h();return e&&!n&&t2(e,p),function(){return t4(e,p)}},[i.current,n]),/* @__PURE__ */U.createElement(ra,{ref:a},u?/* @__PURE__ */U.cloneElement(l,{ref:c}):l)}x(ro,"SingleObserver");var rs=/* @__PURE__ */U.forwardRef(ro);function rl(e,t){var r=e.children;return("function"==typeof r?[r]:tf(r)).map(function(r,n){var i=(null==r?void 0:r.key)||"".concat("rc-observer-key","-").concat(n);return /* @__PURE__ */U.createElement(rs,eB({},e,{key:i,ref:0===n?t:void 0}),r)})}x(rl,"ResizeObserver");var rd=/* @__PURE__ */U.forwardRef(rl);function ru(e){var t=U.useRef();return t.current=e,U.useCallback(function(){for(var e,r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];return null===(e=t.current)||void 0===e?void 0:e.call.apply(e,[t].concat(n))},[])}function rc(){return!!("u">typeof window&&window.document&&window.document.createElement)}rd.Collection=tE,x(ru,"useEvent"),x(rc,"canUseDom");var rh=rc()?U.useLayoutEffect:U.useEffect,rm=/* @__PURE__ */x(function(e,t){var r=U.useRef(!0);rh(function(){return e(r.current)},t),rh(function(){return r.current=!1,function(){r.current=!0}},[])},"useLayoutEffect2"),rp=/* @__PURE__ */U.forwardRef(function(e,t){var r=e.height,n=e.offsetY,i=e.offsetX,a=e.children,o=e.prefixCls,s=e.onInnerResize,l=e.innerProps,d=e.rtl,u=e.extra,c={},h={display:"flex",flexDirection:"column"};return void 0!==n&&(c={height:r,position:"relative",overflow:"hidden"},h=eq(eq({},h),{},eY(eY(eY(eY(eY({transform:"translateY(".concat(n,"px)")},d?"marginRight":"marginLeft",-i),"position","absolute"),"left",0),"right",0),"top",0))),/* @__PURE__ */U.createElement("div",{style:c},/* @__PURE__ */U.createElement(rd,{onResize:/* @__PURE__ */x(function(e){e.offsetHeight&&s&&s()},"onResize")},/* @__PURE__ */U.createElement("div",eB({style:h,className:e9(eY({},"".concat(o,"-holder-inner"),o)),ref:t},l),a,u)))});function rg(e){var t=e.children,r=e.setRef,n=U.useCallback(function(e){r(e)},[]);return /* @__PURE__ */U.cloneElement(t,{ref:n})}function rf(e,t,r,n,i,a,o,s){var l=s.getKey;return e.slice(t,r+1).map(function(e,r){var s=o(e,t+r,{style:{width:n},offsetX:i}),d=l(e);return /* @__PURE__ */U.createElement(rg,{key:d,setRef:/* @__PURE__ */x(function(t){return a(e,t)},"setRef")},s)})}function rv(e,t,r){var n,i,a=e.length,o=t.length;if(0===a&&0===o)return null;a<o?(n=e,i=t):(n=t,i=e);var s={__EMPTY_ITEM__:!0};function l(e){return void 0!==e?r(e):s}x(l,"getItemKey");for(var d=null,u=1!==Math.abs(a-o),c=0;c<i.length;c+=1){var h=l(n[c]);if(h!==l(i[c])){d=c,u=u||h!==l(i[c+1]);break}}return null===d?null:{index:d,multiple:u}}function r_(e,t,r){var n=e0(U.useState(e),2),i=n[0],a=n[1],o=e0(U.useState(null),2),s=o[0],l=o[1];return U.useEffect(function(){var r=rv(i||[],e||[],t);(null==r?void 0:r.index)!==void 0&&l(e[r.index]),a(e)},[e]),[s]}rp.displayName="Filler",x(rg,"Item"),x(rf,"useChildren"),x(rv,"findListDiffIndex"),x(r_,"useDiffItem");var rI=/* @__PURE__ */x(function(e){return+setTimeout(e,16)},"raf2"),rS=/* @__PURE__ */x(function(e){return clearTimeout(e)},"caf2");"u">typeof window&&"requestAnimationFrame"in window&&(rI=/* @__PURE__ */x(function(e){return window.requestAnimationFrame(e)},"raf3"),rS=/* @__PURE__ */x(function(e){return window.cancelAnimationFrame(e)},"caf3"));var rC=0,ry=/* @__PURE__ */new Map;function rw(e){ry.delete(e)}x(rw,"cleanup");var rb=/* @__PURE__ */x(function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,r=rC+=1;function n(t){if(0===t)rw(r),e();else{var i=rI(function(){n(t-1)});ry.set(r,i)}}return x(n,"callRef"),n(t),r},"wrapperRaf2");rb.cancel=function(e){var t=ry.get(e);return rw(e),rS(t)};var rR=(typeof navigator>"u"?"undefined":eW(navigator))==="object"&&/Firefox/i.test(navigator.userAgent);let rE=/* @__PURE__ */x(function(e,t,r,n){var i=(0,U.useRef)(!1),a=(0,U.useRef)(null);function o(){clearTimeout(a.current),i.current=!0,a.current=setTimeout(function(){i.current=!1},50)}x(o,"lockScroll");var s=(0,U.useRef)({top:e,bottom:t,left:r,right:n});return s.current.top=e,s.current.bottom=t,s.current.left=r,s.current.right=n,function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=e?t<0&&s.current.left||t>0&&s.current.right:t<0&&s.current.top||t>0&&s.current.bottom;return r&&n?(clearTimeout(a.current),i.current=!1):(!n||i.current)&&o(),!i.current&&n}},"useOriginScroll");function rT(e,t,r,n,i,a,o){var s=(0,U.useRef)(0),l=(0,U.useRef)(null),d=(0,U.useRef)(null),u=(0,U.useRef)(!1),c=rE(t,r,n,i);function h(e,t){rb.cancel(l.current),s.current+=t,d.current=t,c(!1,t)||(rR||e.preventDefault(),l.current=rb(function(){var e=u.current?10:1;o(s.current*e),s.current=0}))}function m(e,t){o(t,!0),rR||e.preventDefault()}x(h,"onWheelY"),x(m,"onWheelX");var p=(0,U.useRef)(null),g=(0,U.useRef)(null);function f(t){if(e){rb.cancel(g.current),g.current=rb(function(){p.current=null},2);var r=t.deltaX,n=t.deltaY,i=t.shiftKey,o=r,s=n;("sx"===p.current||!p.current&&i&&n&&!r)&&(o=n,s=0,p.current="sx");var l=Math.abs(o),d=Math.abs(s);null===p.current&&(p.current=a&&l>d?"x":"y"),"y"===p.current?h(t,s):m(t,o)}}function v(t){e&&(u.current=t.detail===d.current)}return x(f,"onWheel"),x(v,"onFireFoxScroll"),[f,v]}function rM(e,t,r,n){var i=e0(U.useMemo(function(){return[/* @__PURE__ */new Map,[]]},[e,r.id,n]),2),a=i[0],o=i[1];return /* @__PURE__ */x(function(i){var s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i,l=a.get(i),d=a.get(s);if(void 0===l||void 0===d)for(var u=e.length,c=o.length;c<u;c+=1){var h,m=t(e[c]);a.set(m,c);var p=null!==(h=r.get(m))&&void 0!==h?h:n;if(o[c]=(o[c-1]||0)+p,m===i&&(l=c),m===s&&(d=c),void 0!==l&&void 0!==d)break}return{top:o[l-1]||0,bottom:o[d]}},"getSize")}x(rT,"useFrameWheel"),x(rM,"useGetSize");var rO=/* @__PURE__ */function(){function e(){t6(this,e),eY(this,"maps",void 0),eY(this,"id",0),this.maps=/* @__PURE__ */Object.create(null)}return x(e,"CacheMap"),t5(e,[{key:"set",value:/* @__PURE__ */x(function(e,t){this.maps[e]=t,this.id+=1},"set")},{key:"get",value:/* @__PURE__ */x(function(e){return this.maps[e]},"get")}]),e}();function rD(e,t,r){var n=e0(U.useState(0),2),i=n[0],a=n[1],o=(0,U.useRef)(/* @__PURE__ */new Map),s=(0,U.useRef)(new rO),l=(0,U.useRef)();function d(){rb.cancel(l.current)}function u(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];d();var t=/* @__PURE__ */x(function(){o.current.forEach(function(e,t){if(e&&e.offsetParent){var r=tI(e),n=r.offsetHeight;s.current.get(t)!==n&&s.current.set(t,r.offsetHeight)}}),a(function(e){return e+1})},"doCollect");e?t():l.current=rb(t)}function c(t,r){var n=e(t);o.current.get(n),r?(o.current.set(n,r),u()):o.current.delete(n)}return x(d,"cancelRaf"),x(u,"collectHeight"),x(c,"setInstanceRef"),(0,U.useEffect)(function(){return d},[]),[c,u,s.current,i]}x(rD,"useHeights");var rU=14/15;function rk(e,t,r){var n,i=(0,U.useRef)(!1),a=(0,U.useRef)(0),o=(0,U.useRef)(0),s=(0,U.useRef)(null),l=(0,U.useRef)(null),d=/* @__PURE__ */x(function(e){if(i.current){var t=Math.ceil(e.touches[0].pageX),n=Math.ceil(e.touches[0].pageY),s=a.current-t,d=o.current-n,u=Math.abs(s)>Math.abs(d);u?a.current=t:o.current=n,r(u,u?s:d)&&e.preventDefault(),clearInterval(l.current),l.current=setInterval(function(){u?s*=rU:d*=rU;var e=Math.floor(u?s:d);(!r(u,e,!0)||.1>=Math.abs(e))&&clearInterval(l.current)},16)}},"onTouchMove"),u=/* @__PURE__ */x(function(){i.current=!1,n()},"onTouchEnd"),c=/* @__PURE__ */x(function(e){n(),1!==e.touches.length||i.current||(i.current=!0,a.current=Math.ceil(e.touches[0].pageX),o.current=Math.ceil(e.touches[0].pageY),s.current=e.target,s.current.addEventListener("touchmove",d,{passive:!1}),s.current.addEventListener("touchend",u,{passive:!0}))},"onTouchStart");n=/* @__PURE__ */x(function(){s.current&&(s.current.removeEventListener("touchmove",d),s.current.removeEventListener("touchend",u))},"cleanUpEvents"),rm(function(){return e&&t.current.addEventListener("touchstart",c,{passive:!0}),function(){var e;null===(e=t.current)||void 0===e||e.removeEventListener("touchstart",c),n(),clearInterval(l.current)}},[e])}function rP(e,t,r,n,i,a,o,s){var l=U.useRef(),d=e0(U.useState(null),2),u=d[0],c=d[1];return rm(function(){if(u&&u.times<10){if(!e.current){c(function(e){return eq({},e)});return}a();var s=u.targetAlign,l=u.originAlign,d=u.index,h=u.offset,m=e.current.clientHeight,p=!1,g=s,f=null;if(m){for(var v=s||l,_=0,I=0,S=0,C=Math.min(t.length-1,d),y=0;y<=C;y+=1){var w=i(t[y]);I=_;var b=r.get(w);_=S=I+(void 0===b?n:b)}for(var R="top"===v?h:m-h,E=C;E>=0;E-=1){var T=i(t[E]),M=r.get(T);if(void 0===M){p=!0;break}if((R-=M)<=0)break}switch(v){case"top":f=I-h;break;case"bottom":f=S-m+h;break;default:var O=e.current.scrollTop;I<O?g="top":S>O+m&&(g="bottom")}null!==f&&o(f),f!==u.lastTop&&(p=!0)}p&&c(eq(eq({},u),{},{times:u.times+1,targetAlign:g,lastTop:f}))}},[u,e.current]),function(e){if(null==e){s();return}if(rb.cancel(l.current),"number"==typeof e)o(e);else if(e&&"object"===eW(e)){var r,n=e.align;r="index"in e?e.index:t.findIndex(function(t){return i(t)===e.key});var a=e.offset;c({times:0,index:r,offset:void 0===a?0:a,originAlign:n})}}}function rN(e,t){return("touches"in e?e.touches[0]:e)[t?"pageX":"pageY"]}x(rk,"useMobileTouchMove"),x(rP,"useScrollTo"),x(rN,"getPageXY");var rx=/* @__PURE__ */U.forwardRef(function(e,t){var r=e.prefixCls,n=e.rtl,i=e.scrollOffset,a=e.scrollRange,o=e.onStartMove,s=e.onStopMove,l=e.onScroll,d=e.horizontal,u=e.spinSize,c=e.containerSize,h=e.style,m=e.thumbStyle,p=e0(U.useState(!1),2),g=p[0],f=p[1],v=e0(U.useState(null),2),_=v[0],I=v[1],S=e0(U.useState(null),2),C=S[0],y=S[1],w=!n,b=U.useRef(),R=U.useRef(),E=e0(U.useState(!1),2),T=E[0],M=E[1],O=U.useRef(),D=/* @__PURE__ */x(function(){clearTimeout(O.current),M(!0),O.current=setTimeout(function(){M(!1)},3e3)},"delayHidden2"),k=a-c||0,P=c-u||0,N=U.useMemo(function(){return 0===i||0===k?0:i/k*P},[i,k,P]),A=/* @__PURE__ */x(function(e){e.stopPropagation(),e.preventDefault()},"onContainerMouseDown2"),L=U.useRef({top:N,dragging:g,pageY:_,startTop:C});L.current={top:N,dragging:g,pageY:_,startTop:C};var F=/* @__PURE__ */x(function(e){f(!0),I(rN(e,d)),y(L.current.top),o(),e.stopPropagation(),e.preventDefault()},"onThumbMouseDown2");U.useEffect(function(){var e=/* @__PURE__ */x(function(e){e.preventDefault()},"onScrollbarTouchStart2"),t=b.current,r=R.current;return t.addEventListener("touchstart",e,{passive:!1}),r.addEventListener("touchstart",F,{passive:!1}),function(){t.removeEventListener("touchstart",e),r.removeEventListener("touchstart",F)}},[]);var j=U.useRef();j.current=k;var V=U.useRef();V.current=P,U.useEffect(function(){if(g){var e,t=/* @__PURE__ */x(function(t){var r=L.current,n=r.dragging,i=r.pageY,a=r.startTop;rb.cancel(e);var o=b.current.getBoundingClientRect(),s=c/(d?o.width:o.height);if(n){var u=(rN(t,d)-i)*s,h=a;!w&&d?h-=u:h+=u;var m=j.current,p=V.current,g=Math.ceil((p?h/p:0)*m);g=Math.min(g=Math.max(g,0),m),e=rb(function(){l(g,d)})}},"onMouseMove2"),r=/* @__PURE__ */x(function(){f(!1),s()},"onMouseUp2");return window.addEventListener("mousemove",t,{passive:!0}),window.addEventListener("touchmove",t,{passive:!0}),window.addEventListener("mouseup",r,{passive:!0}),window.addEventListener("touchend",r,{passive:!0}),function(){window.removeEventListener("mousemove",t),window.removeEventListener("touchmove",t),window.removeEventListener("mouseup",r),window.removeEventListener("touchend",r),rb.cancel(e)}}},[g]),U.useEffect(function(){return D(),function(){clearTimeout(O.current)}},[i]),U.useImperativeHandle(t,function(){return{delayHidden:D}});var H="".concat(r,"-scrollbar"),$={position:"absolute",visibility:T?null:"hidden"},B={position:"absolute",background:"rgba(0, 0, 0, 0.5)",borderRadius:99,cursor:"pointer",userSelect:"none"};return d?($.height=8,$.left=0,$.right=0,$.bottom=0,B.height="100%",B.width=u,w?B.left=N:B.right=N):($.width=8,$.top=0,$.bottom=0,w?$.right=0:$.left=0,B.width="100%",B.height=u,B.top=N),/* @__PURE__ */U.createElement("div",{ref:b,className:e9(H,eY(eY(eY({},"".concat(H,"-horizontal"),d),"".concat(H,"-vertical"),!d),"".concat(H,"-visible"),T)),style:eq(eq({},$),h),onMouseDown:A,onMouseMove:D},/* @__PURE__ */U.createElement("div",{ref:R,className:e9("".concat(H,"-thumb"),eY({},"".concat(H,"-thumb-moving"),g)),style:eq(eq({},B),m),onMouseDown:F}))});function rA(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=e/t*e;return isNaN(r)&&(r=0),Math.floor(r=Math.max(r,20))}x(rA,"getSpinSize");var rL=["prefixCls","className","height","itemHeight","fullHeight","style","data","children","itemKey","virtual","direction","scrollWidth","component","onScroll","onVirtualScroll","onVisibleChange","innerProps","extraRender","styles"],rF=[],rj={overflowY:"auto",overflowAnchor:"none"};function rV(e,t){var r=e.prefixCls,n=void 0===r?"rc-virtual-list":r,i=e.className,a=e.height,o=e.itemHeight,s=e.fullHeight,l=e.style,d=e.data,u=e.children,c=e.itemKey,h=e.virtual,m=e.direction,p=e.scrollWidth,g=e.component,f=e.onScroll,v=e.onVirtualScroll,_=e.onVisibleChange,I=e.innerProps,S=e.extraRender,C=e.styles,y=e2(e,rL),w=U.useCallback(function(e){return"function"==typeof c?c(e):null==e?void 0:e[c]},[c]),b=e0(rD(w),4),R=b[0],E=b[1],T=b[2],M=b[3],O=!!(!1!==h&&a&&o),D=U.useMemo(function(){return Object.values(T.maps).reduce(function(e,t){return e+t},0)},[T.id,T.maps]),P=O&&d&&(Math.max(o*d.length,D)>a||!!p),N="rtl"===m,A=e9(n,eY({},"".concat(n,"-rtl"),N),i),L=d||rF,F=(0,U.useRef)(),j=(0,U.useRef)(),V=(0,U.useRef)(),H=e0((0,U.useState)(0),2),$=H[0],B=H[1],W=e0((0,U.useState)(0),2),G=W[0],z=W[1],Y=e0((0,U.useState)(!1),2),K=Y[0],q=Y[1],X=/* @__PURE__ */x(function(){q(!0)},"onScrollbarStartMove"),Q=/* @__PURE__ */x(function(){q(!1)},"onScrollbarStopMove");function Z(e){B(function(t){var r=ev("function"==typeof e?e(t):e);return F.current.scrollTop=r,r})}x(Z,"syncScrollTop");var J=(0,U.useRef)({start:0,end:L.length}),ee=(0,U.useRef)(),et=e0(r_(L,w),1)[0];ee.current=et;var er=U.useMemo(function(){if(!O)return{scrollHeight:void 0,start:0,end:L.length-1,offset:void 0};if(!P)return{scrollHeight:(null===(e=j.current)||void 0===e?void 0:e.offsetHeight)||0,start:0,end:L.length-1,offset:void 0};for(var e,t,r,n,i=0,s=L.length,l=0;l<s;l+=1){var d=w(L[l]),u=T.get(d),c=i+(void 0===u?o:u);c>=$&&void 0===t&&(t=l,r=i),c>$+a&&void 0===n&&(n=l),i=c}return void 0===t&&(t=0,r=0,n=Math.ceil(a/o)),void 0===n&&(n=L.length-1),{scrollHeight:i,start:t,end:n=Math.min(n+1,L.length-1),offset:r}},[P,O,$,L,M,a]),en=er.scrollHeight,ei=er.start,ea=er.end,eo=er.offset;J.current.start=ei,J.current.end=ea;var es=e0(U.useState({width:0,height:a}),2),el=es[0],ed=es[1],eu=/* @__PURE__ */x(function(e){ed({width:e.offsetWidth,height:e.offsetHeight})},"onHolderResize"),ec=(0,U.useRef)(),eh=(0,U.useRef)(),em=U.useMemo(function(){return rA(el.width,p)},[el.width,p]),ep=U.useMemo(function(){return rA(el.height,en)},[el.height,en]),eg=en-a,ef=(0,U.useRef)(eg);function ev(e){var t=e;return Number.isNaN(ef.current)||(t=Math.min(t,ef.current)),t=Math.max(t,0)}ef.current=eg,x(ev,"keepInRange");var e_=$<=0,eI=$>=eg,eS=G<=0,eC=G>=p,ey=rE(e_,eI,eS,eC),ew=/* @__PURE__ */x(function(){return{x:N?-G:G,y:$}},"getVirtualScrollInfo"),eb=(0,U.useRef)(ew()),eR=ru(function(e){if(v){var t=eq(eq({},ew()),e);(eb.current.x!==t.x||eb.current.y!==t.y)&&(v(t),eb.current=t)}});function eE(e,t){t?((0,k.flushSync)(function(){z(e)}),eR()):Z(e)}function eT(e){var t=e.currentTarget.scrollTop;t!==$&&Z(t),null==f||f(e),eR()}x(eE,"onScrollBar"),x(eT,"onFallbackScroll");var eM=/* @__PURE__ */x(function(e){var t=e,r=p?p-el.width:0;return Math.min(t=Math.max(t,0),r)},"keepInHorizontalRange"),eO=e0(rT(O,e_,eI,eS,eC,!!p,ru(function(e,t){t?((0,k.flushSync)(function(){z(function(t){return eM(t+(N?-e:e))})}),eR()):Z(function(t){return t+e})})),2),eD=eO[0],eU=eO[1];rk(O,F,function(e,t,r){return!ey(e,t,r)&&(eD({preventDefault:/* @__PURE__ */x(function(){},"preventDefault"),deltaX:e?t:0,deltaY:e?0:t}),!0)}),rm(function(){function e(e){O&&e.preventDefault()}x(e,"onMozMousePixelScroll");var t=F.current;return t.addEventListener("wheel",eD,{passive:!1}),t.addEventListener("DOMMouseScroll",eU,{passive:!0}),t.addEventListener("MozMousePixelScroll",e,{passive:!1}),function(){t.removeEventListener("wheel",eD),t.removeEventListener("DOMMouseScroll",eU),t.removeEventListener("MozMousePixelScroll",e)}},[O]),rm(function(){if(p){var e=eM(G);z(e),eR({x:e})}},[el.width,p]);var ek=/* @__PURE__ */x(function(){var e,t;null===(e=ec.current)||void 0===e||e.delayHidden(),null===(t=eh.current)||void 0===t||t.delayHidden()},"delayHideScrollBar"),eP=rP(F,L,T,o,w,function(){return E(!0)},Z,ek);U.useImperativeHandle(t,function(){return{nativeElement:V.current,getScrollInfo:ew,scrollTo:/* @__PURE__ */x(function(e){function t(e){return e&&"object"===eW(e)&&("left"in e||"top"in e)}x(t,"isPosScroll"),t(e)?(void 0!==e.left&&z(eM(e.left)),eP(e.top)):eP(e)},"scrollTo")}}),rm(function(){_&&_(L.slice(ei,ea+1),L)},[ei,ea,L]);var eN=rM(L,w,T,o),ex=null==S?void 0:S({start:ei,end:ea,virtual:P,offsetX:G,offsetY:eo,rtl:N,getSize:eN}),eA=rf(L,ei,ea,p,G,R,u,{getKey:w}),eL=null;a&&(eL=eq(eY({},void 0===s||s?"height":"maxHeight",a),rj),O&&(eL.overflowY="hidden",p&&(eL.overflowX="hidden"),K&&(eL.pointerEvents="none")));var eF={};return N&&(eF.dir="rtl"),/* @__PURE__ */U.createElement("div",eB({ref:V,style:eq(eq({},l),{},{position:"relative"}),className:A},eF,y),/* @__PURE__ */U.createElement(rd,{onResize:eu},/* @__PURE__ */U.createElement(void 0===g?"div":g,{className:"".concat(n,"-holder"),style:eL,ref:F,onScroll:eT,onMouseEnter:ek},/* @__PURE__ */U.createElement(rp,{prefixCls:n,height:en,offsetX:G,offsetY:eo,scrollWidth:p,onInnerResize:E,ref:j,innerProps:I,rtl:N,extra:ex},eA))),P&&en>a&&/* @__PURE__ */U.createElement(rx,{ref:ec,prefixCls:n,scrollOffset:$,scrollRange:en,rtl:N,onScroll:eE,onStartMove:X,onStopMove:Q,spinSize:ep,containerSize:el.height,style:null==C?void 0:C.verticalScrollBar,thumbStyle:null==C?void 0:C.verticalScrollBarThumb}),P&&p>el.width&&/* @__PURE__ */U.createElement(rx,{ref:eh,prefixCls:n,scrollOffset:G,scrollRange:p,rtl:N,onScroll:eE,onStartMove:X,onStopMove:Q,spinSize:em,containerSize:el.width,horizontal:!0,style:null==C?void 0:C.horizontalScrollBar,thumbStyle:null==C?void 0:C.horizontalScrollBarThumb}))}x(rV,"RawList");var rH=/* @__PURE__ */U.forwardRef(rV);function r$(e){let{model:r}=e,n=(0,d.useDependency)(d.LocaleService),i=(0,g.useObservable)(r.searchString$,"",!0),a=(0,g.useObservable)(r.filterItems$,void 0,!0),o=n.t("sheets-filter.panel.filter-only"),s=J(a),l=s.checked>0&&0===s.unchecked,u=s.checked>0&&s.unchecked>0,c=(0,U.useCallback)((e,t)=>{r.onFilterCheckToggled(e,t)},[r]),h=(0,U.useCallback)(e=>{r.onFilterOnly(e)},[r]),m=(0,U.useCallback)(()=>{r.onCheckAllToggled(!l)},[r,l]),f=(0,U.useCallback)(e=>{r.setSearchString(e)},[r]);return /* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelValuesContainer},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Input,{autoFocus:!0,value:i,placeholder:n.t("sheets-filter.panel.search-placeholder"),onChange:f}),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelValuesList},/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelValuesItem},/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelValuesItemInner},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Checkbox,{indeterminate:u,disabled:0===a.length,checked:l,onChange:m}),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:ej.sheetsFilterPanelValuesItemText},`${n.t("sheets-filter.panel.select-all")}`),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:ej.sheetsFilterPanelValuesItemCount},`(${s.checked}/${s.checked+s.unchecked})`))),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelValuesVirtual},/* @__PURE__ *//*@__PURE__*/t(U).createElement(rH,{style:{paddingRight:8},data:a,height:190,itemHeight:32,itemKey:/* @__PURE__ */x(e=>`${e.value}----${e.checked}`,"itemKey")},e=>/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelValuesItem},/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelValuesItemInner},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Checkbox,{checked:e.checked,onChange:/* @__PURE__ */x(()=>c(e,!e.checked),"onChange")}),/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Tooltip,{showIfEllipsis:!0,placement:"top",title:e.value},/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:ej.sheetsFilterPanelValuesItemText},e.value)),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:ej.sheetsFilterPanelValuesItemCount},`(${e.count})`),/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Button,{className:ej.sheetsFilterPanelValuesItemExcludeButton,size:"small",type:"link",onClick:/* @__PURE__ */x(()=>h(e),"onClick")},o)))))))}function rB(){var e;let r=(0,d.useDependency)(em),n=(0,d.useDependency)(d.LocaleService),i=(0,d.useDependency)(d.ICommandService),a=(0,g.useObservable)(r.filterBy$,void 0,!0),o=(0,g.useObservable)(r.filterByModel$,void 0,!1),s=(0,g.useObservable)(()=>(null==o?void 0:o.canApply$)||(0,y.of)(!1),void 0,!1,[o]),l=rW(n),u=!(0,g.useObservable)(r.hasCriteria$),h=(0,U.useCallback)(e=>{i.executeCommand(eI.id,{filterBy:e})},[i]),f=(0,U.useCallback)(async()=>{await (null==o?void 0:o.clear()),i.executeCommand(e_.id)},[o,i]),v=(0,U.useCallback)(()=>{i.executeCommand(e_.id)},[i]),_=(0,U.useCallback)(async()=>{await (null==o?void 0:o.apply()),i.executeCommand(e_.id)},[o,i]),I=null==(e=(0,d.useDependency)(c.SheetsFilterService).activeFilterModel)?void 0:e.getRange(),S=r.col,C=(0,g.useComponentsOfPart)(m.SheetsUIPart.FILTER_PANEL_EMBED_POINT);return /* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanel},/* @__PURE__ *//*@__PURE__*/t(U).createElement(g.ComponentContainer,{components:C,sharedProps:{range:I,colIndex:S,onClose:v}}),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelHeader},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Segmented,{value:a,options:l,onChange:/* @__PURE__ */x(e=>h(e),"onChange")})),o?/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelContent},a===eh.VALUES?/* @__PURE__ *//*@__PURE__*/t(U).createElement(r$,{model:o}):/* @__PURE__ *//*@__PURE__*/t(U).createElement(eV,{model:o})):/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{style:{flex:1}}),/* @__PURE__ *//*@__PURE__*/t(U).createElement("div",{className:ej.sheetsFilterPanelFooter},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Button,{type:"link",onClick:f,disabled:u},n.t("sheets-filter.panel.clear-filter")),/* @__PURE__ *//*@__PURE__*/t(U).createElement("span",{className:ej.sheetsFilterPanelFooterPrimaryButtons},/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Button,{type:"default",onClick:v},n.t("sheets-filter.panel.cancel")),/* @__PURE__ *//*@__PURE__*/t(U).createElement(p.Button,{disabled:!s,type:"primary",onClick:_},n.t("sheets-filter.panel.confirm")))))}function rW(e){let t=e.getCurrentLocale();return(0,U.useMemo)(()=>[{label:e.t("sheets-filter.panel.by-values"),value:eh.VALUES},{label:e.t("sheets-filter.panel.by-conditions"),value:eh.CONDITIONS}],[t,e])}rH.displayName="List",x(r$,"FilterByValue"),x(rB,"FilterPanel"),x(rW,"useFilterByOptions");let rG={id:H.id,binding:g.KeyCode.L|g.MetaKeys.CTRL_COMMAND|g.MetaKeys.SHIFT,description:"sheets-filter.shortcut.smart-toggle-filter",preconditions:m.whenSheetEditorFocused,group:"4_sheet-edit"},rz=new Path2D("M3.30363 3C2.79117 3 2.51457 3.60097 2.84788 3.99024L6.8 8.60593V12.5662C6.8 12.7184 6.8864 12.8575 7.02289 12.9249L8.76717 13.7863C8.96655 13.8847 9.2 13.7396 9.2 13.5173V8.60593L13.1521 3.99024C13.4854 3.60097 13.2088 3 12.6964 3H3.30363Z"),rY=class{static drawNoCriteria(e,t,r,n){e.save(),(0,D.Rect).drawWith(e,{radius:2,width:16,height:16,fill:n}),e.lineCap="square",e.strokeStyle=r,e.scale(t/16,t/16),e.beginPath(),e.lineWidth=1,e.lineCap="round",e.moveTo(3,4),e.lineTo(13,4),e.moveTo(4.5,8),e.lineTo(11.5,8),e.moveTo(6,12),e.lineTo(10,12),e.stroke(),e.restore()}static drawHasCriteria(e,t,r,n){e.save(),(0,D.Rect).drawWith(e,{radius:2,width:16,height:16,fill:n}),e.scale(t/16,t/16),e.fillStyle=r,e.fill(rz),e.restore()}};x(rY,"FilterButton");var rK=Object.defineProperty,rq=Object.getOwnPropertyDescriptor,rX=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?rq(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&rK(t,r,a),a},"__decorateClass$6"),rQ=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let rZ=(x(r4=class extends D.Shape{constructor(e,t,r,n,i){super(e,t),A(this,"_cellWidth",0),A(this,"_cellHeight",0),A(this,"_filterParams"),A(this,"_hovered",!1),this._contextService=r,this._commandService=n,this._themeService=i,this.setShapeProps(t),this.onPointerDown$.subscribeEvent(e=>this.onPointerDown(e)),this.onPointerEnter$.subscribeEvent(()=>this.onPointerEnter()),this.onPointerLeave$.subscribeEvent(()=>this.onPointerLeave())}setShapeProps(e){"u">typeof e.cellHeight&&(this._cellHeight=e.cellHeight),"u">typeof e.cellWidth&&(this._cellWidth=e.cellWidth),"u">typeof e.filterParams&&(this._filterParams=e.filterParams),this.transformByState({width:e.width,height:e.height})}_draw(e){let t=this._cellHeight,r=this._cellWidth;e.save();let n=new Path2D;n.rect(16-r,16-t,r,t),e.clip(n);let{hasCriteria:i}=this._filterParams,a=this._themeService.getCurrentTheme().primaryColor,o=this._hovered?this._themeService.getCurrentTheme().grey50:"rgba(255, 255, 255, 1.0)";i?rY.drawHasCriteria(e,16,a,o):rY.drawNoCriteria(e,16,a,o),e.restore()}onPointerDown(e){if(2===e.button)return;let{col:t,unitId:r,subUnitId:n}=this._filterParams;this._contextService.getContextValue(ef)||!this._commandService.hasCommand(ev.id)||setTimeout(()=>{this._commandService.executeCommand(ev.id,{unitId:r,subUnitId:n,col:t})},200)}onPointerEnter(){this._hovered=!0,this.makeDirty(!0)}onPointerLeave(){this._hovered=!1,this.makeDirty(!0)}},"SheetsFilterButtonShape"),r4);rZ=rX([rQ(2,d.IContextService),rQ(3,d.ICommandService),rQ(4,(0,d.Inject)(d.ThemeService))],rZ);var rJ=Object.defineProperty,r1=Object.getOwnPropertyDescriptor,r0=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?r1(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&rJ(t,r,a),a},"__decorateClass$5"),r3=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let r2=(r6=class extends d.RxDisposable{constructor(e,t,r,n,i,a,o,s){super(),A(this,"_filterRangeShape",null),A(this,"_buttonRenderDisposable",null),A(this,"_filterButtonShapes",[]),this._context=e,this._injector=t,this._sheetSkeletonManagerService=r,this._sheetsFilterService=n,this._themeService=i,this._sheetInterceptorService=a,this._commandService=o,this._selectionRenderService=s,this._initRenderer()}dispose(){super.dispose(),this._disposeRendering()}_initRenderer(){this._sheetSkeletonManagerService.currentSkeleton$.pipe((0,T.switchMap)(e=>{var t,r;if(!e)return(0,y.of)(null);let{unit:n,unitId:i}=this._context,a=(null==(t=n.getActiveSheet())?void 0:t.getSheetId())||"",o=null!=(r=this._sheetsFilterService.getFilterModel(i,a))?r:void 0,s=/* @__PURE__ */x(()=>({unitId:i,worksheetId:a,filterModel:o,range:null==o?void 0:o.getRange(),skeleton:e.skeleton}),"getParams");return(0,d.fromCallback)(this._commandService.onCommandExecuted.bind(this._commandService)).pipe((0,I.filter)(([e])=>{var t;return e.type===d.CommandType.MUTATION&&(null==(t=e.params)?void 0:t.unitId)===n.getUnitId()&&((0,c.FILTER_MUTATIONS).has(e.id)||e.id===h.SetRangeValuesMutation.id)}),(0,O.throttleTime)(20,void 0,{leading:!1,trailing:!0}),(0,S.map)(s),(0,R.startWith)(s()))}),(0,M.takeUntil)(this.dispose$)).subscribe(e=>{this._disposeRendering(),e&&e.range&&(this._renderRange(e.range,e.skeleton),this._renderButtons(e))})}_renderRange(e,t){let{scene:r}=this._context,{rangeWithCoord:n,style:i}=this._selectionRenderService.attachSelectionWithCoord({range:e,primary:null,style:null}),{rowHeaderWidth:a,columnHeaderHeight:o}=t,s=this._filterRangeShape=new m.SelectionShape(r,1e3,this._themeService,!0);s.update(n,a,o,{hasAutoFill:!1,fill:"rgba(0, 0, 0, 0.0)",...i}),s.setEvent(!1),r.makeDirty(!0)}_renderButtons(e){let{range:t,filterModel:r,unitId:n,skeleton:i,worksheetId:a}=e,{scene:o}=this._context;this._interceptCellContent(n,a,e.range);let{startColumn:s,endColumn:l,startRow:d}=t;for(let e=s;e<=l;e++){let t=`sheets-filter-button-${e}`,{startX:s,startY:l,endX:u,endY:c}=(0,m.getCoordByCell)(d,e,o,i),h=u-s,p=c-l;if(p<=1||h<=1)continue;let g=!!r.getFilterColumn(e),f={left:u-16-1,top:c-16-1,height:16,width:16,zIndex:5e3,cellHeight:p,cellWidth:h,filterParams:{unitId:n,subUnitId:a,col:e,hasCriteria:g}},v=this._injector.createInstance(rZ,t,f);this._filterButtonShapes.push(v)}o.addObjects(this._filterButtonShapes),o.makeDirty()}_interceptCellContent(e,t,r){let{startRow:n,startColumn:i,endColumn:a}=r;this._buttonRenderDisposable=this._sheetInterceptorService.intercept(h.INTERCEPTOR_POINT.CELL_CONTENT,{effect:d.InterceptorEffectEnum.Style,handler:/* @__PURE__ */x((r,o,s)=>{let{row:l,col:d,unitId:u,subUnitId:c}=o;return s(u!==e||c!==t||l!==n||d<i||d>a?r:{...r,fontRenderExtension:{...null==r?void 0:r.fontRenderExtension,rightOffset:16}})},"handler"),priority:10})}_disposeRendering(){var e,t;null==(e=this._filterRangeShape)||e.dispose(),this._filterButtonShapes.forEach(e=>e.dispose()),null==(t=this._buttonRenderDisposable)||t.dispose(),this._filterRangeShape=null,this._buttonRenderDisposable=null,this._filterButtonShapes=[]}},x(r6,"SheetsFilterRenderController"),r6);r2=r0([r3(1,(0,d.Inject)(d.Injector)),r3(2,(0,d.Inject)(m.SheetSkeletonManagerService)),r3(3,(0,d.Inject)(c.SheetsFilterService)),r3(4,(0,d.Inject)(d.ThemeService)),r3(5,(0,d.Inject)(h.SheetInterceptorService)),r3(6,d.ICommandService),r3(7,m.ISheetSelectionRenderService)],r2);var r4,r6,r9,r5=Object.defineProperty,r8=Object.getOwnPropertyDescriptor,r7=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?r8(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&r5(t,r,a),a},"__decorateClass$4"),ne=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let nt=(x(r9=class extends d.RxDisposable{constructor(e,t){super(),this._renderManagerService=e,this._sheetsRenderService=t,[(0,c.SetSheetsFilterRangeMutation),(0,c.SetSheetsFilterCriteriaMutation),(0,c.RemoveSheetsFilterMutation),(0,c.ReCalcSheetsFilterMutation)].forEach(e=>this.disposeWithMe(this._sheetsRenderService.registerSkeletonChangingMutations(e.id))),this.disposeWithMe(this._renderManagerService.registerRenderModule(d.UniverInstanceType.UNIVER_SHEET,[r2]))}},"SheetsFilterUIMobileController"),r9);function nr(e){let t=e.get(c.SheetsFilterService);return{id:H.id,type:g.MenuItemType.BUTTON_SELECTOR,icon:"FilterSingle",tooltip:"sheets-filter.toolbar.smart-toggle-filter-tooltip",hidden$:(0,g.getMenuHiddenObservable)(e,d.UniverInstanceType.UNIVER_SHEET),activated$:t.activeFilterModel$.pipe((0,S.map)(e=>!!e)),disabled$:(0,m.getObservableWithExclusiveRange$)(e,(0,m.getCurrentRangeDisable$)(e,{worksheetTypes:[h.WorksheetFilterPermission,h.WorksheetViewPermission],rangeTypes:[h.RangeProtectionPermissionViewPoint]}))}}function nn(e){let t=e.get(c.SheetsFilterService);return{id:B.id,type:g.MenuItemType.BUTTON,title:"sheets-filter.toolbar.clear-filter-criteria",hidden$:(0,g.getMenuHiddenObservable)(e,d.UniverInstanceType.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe((0,T.switchMap)(e=>{var t;return null!=(t=null==e?void 0:e.hasCriteria$.pipe((0,S.map)(e=>!e)))?t:(0,y.of)(!0)}))}}function ni(e){let t=e.get(c.SheetsFilterService);return{id:W.id,type:g.MenuItemType.BUTTON,title:"sheets-filter.toolbar.re-calc-filter-conditions",hidden$:(0,g.getMenuHiddenObservable)(e,d.UniverInstanceType.UNIVER_SHEET),disabled$:t.activeFilterModel$.pipe((0,T.switchMap)(e=>{var t;return null!=(t=null==e?void 0:e.hasCriteria$.pipe((0,S.map)(e=>!e)))?t:(0,y.of)(!0)}))}}nt=r7([ne(0,D.IRenderManagerService),ne(1,(0,d.Inject)(m.SheetsRenderService))],nt),x(nr,"SmartToggleFilterMenuItemFactory"),x(nn,"ClearFilterCriteriaMenuItemFactory"),x(ni,"ReCalcFilterMenuItemFactory");let na={[g.RibbonStartGroup.FORMULAS_INSERT]:{[H.id]:{order:10,menuItemFactory:nr,[B.id]:{order:0,menuItemFactory:nn},[W.id]:{order:1,menuItemFactory:ni}}}};var no=Object.defineProperty,ns=Object.getOwnPropertyDescriptor,nl=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ns(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&no(t,r,a),a},"__decorateClass$3"),nd=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let nu="FILTER_PANEL_POPUP",nc=(nE=class extends nt{constructor(e,t,r,n,i,a,o,s,l,d,u,c,h){super(h,c),A(this,"_popupDisposable"),this._injector=e,this._componentManager=t,this._sheetsFilterPanelService=r,this._sheetCanvasPopupService=n,this._sheetsFilterService=i,this._localeService=a,this._shortcutService=o,this._commandService=s,this._menuManagerService=l,this._contextService=d,this._messageService=u,this._initCommands(),this._initShortcuts(),this._initMenuItems(),this._initUI()}dispose(){super.dispose(),this._closeFilterPopup()}_initShortcuts(){[rG].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_initCommands(){[H,V,j,$,B,W,eI,ev,e_].forEach(e=>{this.disposeWithMe(this._commandService.registerCommand(e))})}_initMenuItems(){this._menuManagerService.mergeMenu(na)}_initUI(){this.disposeWithMe(this._componentManager.register(nu,rB)),this.disposeWithMe(this._componentManager.register("FilterSingle",eF)),this.disposeWithMe(this._contextService.subscribeContextValue$(ef).pipe((0,_.distinctUntilChanged)()).subscribe(e=>{e?this._openFilterPopup():this._closeFilterPopup()})),this.disposeWithMe(this._sheetsFilterService.errorMsg$.subscribe(e=>{e&&this._messageService.show({type:p.MessageType.Error,content:this._localeService.t(e)})}))}_openFilterPopup(){let e=this._sheetsFilterPanelService.filterModel;if(!e)throw Error("[SheetsFilterUIController]: no filter model when opening filter popup!");let t=e.getRange(),r=this._sheetsFilterPanelService.col,{startRow:n}=t;this._popupDisposable=this._sheetCanvasPopupService.attachPopupToCell(n,r,{componentKey:nu,direction:"horizontal",onClickOutside:/* @__PURE__ */x(()=>this._commandService.syncExecuteCommand(e_.id),"onClickOutside"),offset:[5,0]})}_closeFilterPopup(){var e;null==(e=this._popupDisposable)||e.dispose(),this._popupDisposable=null}},x(nE,"SheetsFilterUIDesktopController"),nE);nc=nl([nd(0,(0,d.Inject)(d.Injector)),nd(1,(0,d.Inject)(g.ComponentManager)),nd(2,(0,d.Inject)(em)),nd(3,(0,d.Inject)(m.SheetCanvasPopManagerService)),nd(4,(0,d.Inject)(c.SheetsFilterService)),nd(5,(0,d.Inject)(d.LocaleService)),nd(6,g.IShortcutService),nd(7,d.ICommandService),nd(8,g.IMenuManagerService),nd(9,d.IContextService),nd(10,g.IMessageService),nd(11,(0,d.Inject)(m.SheetsRenderService)),nd(12,D.IRenderManagerService)],nc);var nh=Object.defineProperty,nm=Object.getOwnPropertyDescriptor,np=/* @__PURE__ */x((e,t,r)=>t in e?nh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp$1"),ng=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nm(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nh(t,r,a),a},"__decorateClass$2"),nf=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2"),nv=/* @__PURE__ */x((e,t,r)=>np(e,"symbol"!=typeof t?t+"":t,r),"__publicField$1");let n_=(nT=class extends d.Plugin{constructor(e=F,t,r,n){super(),this._config=e,this._injector=t,this._configService=r,this._rpcChannelService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig(L,a)}onStarting(){[[em],[eO],[nc]].forEach(e=>this._injector.add(e)),this._config.useRemoteFilterValuesGenerator&&this._rpcChannelService&&this._injector.add([ea,{useFactory:/* @__PURE__ */x(()=>(0,u.toModule)(this._rpcChannelService.requestChannel(ei)),"useFactory")}])}onReady(){this._injector.get(eO)}onRendered(){this._injector.get(nc)}},x(nT,"UniverSheetsFilterUIPlugin"),nT);nv(n_,"type",d.UniverInstanceType.UNIVER_SHEET),nv(n_,"pluginName","SHEET_FILTER_UI_PLUGIN"),n_=ng([(0,d.DependentOn)(c.UniverSheetsFilterPlugin),nf(1,(0,d.Inject)(d.Injector)),nf(2,d.IConfigService),nf(3,(0,d.Optional)(u.IRPCChannelService))],n_);var nI=Object.defineProperty,nS=Object.getOwnPropertyDescriptor,nC=/* @__PURE__ */x((e,t,r)=>t in e?nI(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),ny=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nS(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nI(t,r,a),a},"__decorateClass$1"),nw=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1"),nb=/* @__PURE__ */x((e,t,r)=>nC(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let nR=(x(nM=class extends d.Plugin{constructor(e=F,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{menu:n,...i}=this._config;n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(L,i)}onStarting(){[[eO],[nt]].forEach(e=>this._injector.add(e))}onReady(){this._injector.get(eO)}onRendered(){this._injector.get(nt)}},"UniverSheetsFilterMobileUIPlugin"),nM);nb(nR,"type",d.UniverInstanceType.UNIVER_SHEET),nb(nR,"pluginName","SHEET_FILTER_UI_PLUGIN"),nR=ny([(0,d.DependentOn)(c.UniverSheetsFilterPlugin),nw(1,(0,d.Inject)(d.Injector)),nw(2,d.IConfigService)],nR);var nE,nT,nM,nO,nD=Object.defineProperty,nU=Object.getOwnPropertyDescriptor,nk=/* @__PURE__ */x((e,t,r,n)=>{for(var i,a=n>1?void 0:n?nU(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&nD(t,r,a),a},"__decorateClass"),nP=/* @__PURE__ */x((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let nN=(x(nO=class extends d.Plugin{constructor(e,t,r){super(),this._config=e,this._injector=t,this._rpcChannelService=r}onStarting(){[[ea,{useClass:eo}]].forEach(e=>this._injector.add(e))}onReady(){this._rpcChannelService.registerChannel(ei,(0,u.fromModule)(this._injector.get(ea)))}},"UniverSheetsFilterUIWorkerPlugin"),A(nO,"type",d.UniverInstanceType.UNIVER_SHEET),A(nO,"pluginName","SHEET_FILTER_UI_WORKER_PLUGIN"),nO);nk([nP(1,(0,d.Inject)(d.Injector)),nP(2,u.IRPCChannelService)],nN)}),i("5duFt",function(r,i){let a;e(r.exports,"SheetsHyperLinkResolverService",function(){return $}),e(r.exports,"AddHyperLinkCommand",function(){return el}),e(r.exports,"UpdateHyperLinkCommand",function(){return eu}),e(r.exports,"CancelHyperLinkCommand",function(){return eA});var o=n("7yNYd"),s=n("3Iaza"),l=n("4XALk"),d=n("1UDbf"),u=n("86b1c"),c=n("ejawP"),h=n("fL2Ug"),m=n("g6Cit"),p=n("3e0Iz"),g=n("5LPkb"),f=n("bXJOC"),v=n("arCqp"),_=n("lMvMU"),I=n("hciHF"),S=n("1O3Nt"),C=n("3yupB"),y=n("1mjSk"),w=n("23cfA"),b=n("7AR1b"),R=n("5gqvu"),E=n("kRRWY"),T=Object.defineProperty,M=(e,t,r)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,O=(e,t)=>T(e,"name",{value:t,configurable:!0}),D=(e,t,r)=>M(e,"symbol"!=typeof t?t+"":t,r);function U(e){return(0,o.Tools).isLegalUrl(e)}function k(e){return/^[a-zA-Z]+:\/\//.test(e)}function P(e){return/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(e)}function N(e){if(U(e)){let t;let r=k(e)?e:P(e)?`mailto://${e}`:`http://${e}`;try{t=new URL(r)}catch{return e}return t.hostname===location.hostname&&t.port===location.port&&t.protocol===location.protocol&&t.pathname===location.pathname&&t.hash&&!t.search?t.hash:r}return e}O(U,"isLegalLink"),O(k,"hasProtocol"),O(P,"isEmail"),O(N,"serializeUrl");let x="sheets-hyper-link-ui.config",A={};var L=Object.defineProperty,F=Object.getOwnPropertyDescriptor,j=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?F(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&L(t,r,a),a},"__decorateClass$c"),V=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$c");function H(e,t){let r=t.getMergeData(),n=t.getMaxColumns()-1,i=t.getMaxRows()-1;if(n<e.endColumn&&(e.endColumn=n),i<e.endRow&&(e.endRow=i),e.rangeType===o.RANGE_TYPE.COLUMN||o.RANGE_TYPE.ROW)return e;let a=[];return r.forEach(t=>{(0,o.Rectangle).intersects(e,t)&&a.push(t)}),(0,o.Rectangle).realUnion(e,...a)}O(H,"getContainRange");let $=(W=class{constructor(e,t,r,n,i,a){this._univerInstanceService=e,this._commandService=t,this._definedNamesService=r,this._messageService=n,this._localeService=i,this._configService=a}_getURLName(e){var t;let{gid:r,range:n,rangeid:i,unitid:a}=e,l=a?this._univerInstanceService.getUnit(a,o.UniverInstanceType.UNIVER_SHEET):this._univerInstanceService.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET),d={type:s.SheetHyperLinkType.INVALID,name:this._localeService.t("hyperLink.message.refError")};if(!l)return d;let c=r?l.getSheetBySheetId(r):l.getActiveSheet(),h=null!=(t=null==c?void 0:c.getName())?t:"";if(n){if(!c)return d;let e=(0,u.deserializeRangeWithSheet)(n).range;return(0,o.isValidRange)(e,c)&&n!==s.ERROR_RANGE?{type:s.SheetHyperLinkType.RANGE,name:(0,u.serializeRangeWithSheet)(h,e)}:d}if(i){let e=this._definedNamesService.getValueById(l.getUnitId(),i);return e?{type:s.SheetHyperLinkType.DEFINE_NAME,name:e.formulaOrRefString}:d}if(r){let e=l.getSheetBySheetId(r);return e?{type:s.SheetHyperLinkType.SHEET,name:e.getName()}:d}return d}navigateTo(e){let{gid:t,range:r,rangeid:n}=e,i=this._univerInstanceService.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(!i)return;let a=i.getUnitId();if(n){let e=this._definedNamesService.getValueById(a,n);if(!e)return;let{formulaOrRefString:t}=e,r=this._definedNamesService.getWorksheetByRef(a,t);if(!r){this._messageService.show({content:this._localeService.t("hyperLink.message.refError"),type:d.MessageType.Error});return}if(r.isSheetHidden()){this._messageService.show({content:this._localeService.t("hyperLink.message.hiddenSheet"),type:d.MessageType.Error});return}this.navigateToDefineName(a,n)}if(t){if(r){let e=(0,u.deserializeRangeWithSheet)(r);(0,o.isValidRange)(e.range)&&r!==s.ERROR_RANGE&&this.navigateToRange(a,t,e.range);return}this.navigateToSheetById(a,t)}}buildHyperLink(e,t,r){return`#${s.SheetHyperLinkType.SHEET}=${t}${r?`&${"string"==typeof r?s.SheetHyperLinkType.DEFINE_NAME:s.SheetHyperLinkType.RANGE}=${"string"==typeof r?r:(0,u.serializeRange)(r)}`:""}`}parseHyperLink(e){var t,r,n,i;if(!e.startsWith("#"))return{type:s.SheetHyperLinkType.URL,name:e,url:e,handler:/* @__PURE__ */O(()=>{this.navigateToOtherWebsite(e)},"handler"),searchObj:null};{let a=new URLSearchParams(e.slice(1)),o={gid:null!=(t=a.get("gid"))?t:"",range:null!=(r=a.get("range"))?r:"",rangeid:null!=(n=a.get("rangeid"))?n:"",unitid:null!=(i=a.get("unitid"))?i:""},s=this._getURLName(o);return{type:s.type,name:s.name,url:e,searchObj:o,handler:/* @__PURE__ */O(()=>{this.navigateTo(o)},"handler")}}}async navigateToRange(e,t,r){let n=await this.navigateToSheetById(e,t);if(n){let i=H(r,n);await this._commandService.executeCommand(c.SetSelectionsOperation.id,{unitId:e,subUnitId:t,selections:[{range:i}]}),await this._commandService.executeCommand(l.ScrollToRangeOperation.id,{range:i})}}async navigateToSheet(e,t){let r=this._univerInstanceService.getUnit(e,o.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;let n=r.getActiveSheet();if((null==n?void 0:n.getName())===t)return!0;let i=r.getSheetBySheetName(t);if(!i){this._messageService.show({content:this._localeService.t("hyperLink.message.noSheet"),type:d.MessageType.Error});return}let a=i.getSheetId();return r.getHiddenWorksheets().indexOf(a)>-1&&this._messageService.show({content:this._localeService.t("hyperLink.message.hiddenSheet"),type:d.MessageType.Error}),await this._commandService.executeCommand(c.SetWorksheetActiveOperation.id,{unitId:e,subUnitId:a})}async navigateToSheetById(e,t){let r=this._univerInstanceService.getUnit(e,o.UniverInstanceType.UNIVER_SHEET);if(!r)return!1;let n=r.getActiveSheet();if(!n)return!1;if(n.getSheetId()===t)return n;let i=r.getSheetBySheetId(t);return i?r.getHiddenWorksheets().indexOf(t)>-1?(this._messageService.show({content:this._localeService.t("hyperLink.message.hiddenSheet"),type:d.MessageType.Error}),!1):!!await this._commandService.executeCommand(c.SetWorksheetActiveOperation.id,{unitId:e,subUnitId:t})&&i:(this._messageService.show({content:this._localeService.t("hyperLink.message.noSheet"),type:d.MessageType.Error}),!1)}async navigateToDefineName(e,t){return this._definedNamesService.focusRange(e,t),!0}async navigateToOtherWebsite(e){var t;let r=this._configService.getConfig(x);if(null!=(t=null==r?void 0:r.urlHandler)&&t.navigateToOtherWebsite)return r.urlHandler.navigateToOtherWebsite(e);window.open(e,"_blank","noopener noreferrer")}},O(W,"SheetsHyperLinkResolverService"),W);$=j([V(0,o.IUniverInstanceService),V(1,o.ICommandService),V(2,u.IDefinedNamesService),V(3,h.IMessageService),V(4,(0,o.Inject)(o.LocaleService)),V(5,o.IConfigService)],$);let B="SHEET_HYPER_LINK_UI_PLUGIN";var W,G,z=Object.defineProperty,Y=Object.getOwnPropertyDescriptor,K=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?Y(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&z(t,r,a),a},"__decorateClass$b"),q=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$b");let X=(G=class extends o.Disposable{constructor(e,t,r,n){super(),D(this,"_plainTextFilter",/* @__PURE__ */new Set),D(this,"_copyInfo"),this._sheetClipboardService=e,this._hyperLinkModel=t,this._injector=r,this._resolverService=n,this._initCopyPaste(),this.disposeWithMe(()=>{this._plainTextFilter.clear()})}registerPlainTextFilter(e){this._plainTextFilter.add(e)}removePlainTextFilter(e){this._plainTextFilter.delete(e)}_filterPlainText(e){return Array.from(this._plainTextFilter).every(t=>t(e))}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:B,onBeforeCopy:/* @__PURE__ */O((e,t,r)=>this._collect(e,t,r),"onBeforeCopy"),onPasteCells:/* @__PURE__ */O((e,t,r,n)=>{let{copyType:i=l.COPY_TYPE.COPY,pasteType:a}=n,{range:o}=e||{},{range:s,unitId:d,subUnitId:u}=t;return this._generateMutations(s,{copyType:i,pasteType:a,copyRange:o,unitId:d,subUnitId:u})},"onPasteCells"),onPastePlainText:/* @__PURE__ */O((e,t)=>{let r=this._filterPlainText(t);if(U(t)&&r){let{range:t,unitId:r,subUnitId:n}=e,{ranges:[i],mapFunc:a}=(0,l.virtualizeDiscreteRanges)([t]),d=[],u=[];return(0,o.Range).foreach(i,(e,t)=>{let{row:i,col:o}=a(e,t),l=this._hyperLinkModel.getHyperLinkByLocation(r,n,i,o);l&&d.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:r,subUnitId:n,id:l.id}}),l&&u.push({id:s.AddHyperLinkMutation.id,params:{unitId:r,subUnitId:n,link:l}})}),{redos:d,undos:u}}return{undos:[],redos:[]}},"onPastePlainText"),priority:99})}_collect(e,t,r){let n=new o.ObjectMatrix;this._copyInfo={unitId:e,subUnitId:t,matrix:n};let i=this._injector.invoke(n=>(0,l.rangeToDiscreteRange)(r,n,e,t));if(!i)return;let{rows:a,cols:s}=i;a.forEach((r,i)=>{s.forEach((a,o)=>{var s;let l=this._hyperLinkModel.getHyperLinkByLocation(e,t,r,a);n.setValue(i,o,null!=(s=null==l?void 0:l.id)?s:"")})})}_generateMutations(e,t){if(!this._copyInfo||!this._copyInfo||!this._copyInfo.matrix.getSizeOf()||!t.copyRange||[(0,l.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_COL_WIDTH,(0,l.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_VALUE,(0,l.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMAT,(0,l.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMULA].includes(t.pasteType))return{redos:[],undos:[]};let{unitId:r,subUnitId:n}=this._copyInfo,i=[],a=[],{ranges:[d,u],mapFunc:c}=(0,l.virtualizeDiscreteRanges)([t.copyRange,e]);return(0,l.getRepeatRange)(d,u,!0).forEach(({startRange:e})=>{var l;null==(l=this._copyInfo)||l.matrix.forValue((l,d,u)=>{let h=(0,o.Rectangle).getPositionRange({startRow:l,endRow:l,startColumn:d,endColumn:d},e),m=this._hyperLinkModel.getHyperLink(r,n,u),{row:p,col:g}=c(h.startRow,h.startColumn),f=this._hyperLinkModel.getHyperLinkByLocation(t.unitId,t.subUnitId,p,g),v=(0,o.Tools).generateRandomId();f&&i.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,id:f.id}}),m&&(i.push({id:s.AddHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,link:{...m,id:v,row:p,column:g}}}),a.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,id:v}})),f&&a.push({id:s.AddHyperLinkMutation.id,params:{unitId:t.unitId,subUnitId:t.subUnitId,link:f}})})}),{redos:i,undos:a}}},O(G,"SheetsHyperLinkCopyPasteController"),G);X=K([q(0,l.ISheetClipboardService),q(1,(0,o.Inject)(s.HyperLinkModel)),q(2,(0,o.Inject)(o.Injector)),q(3,(0,o.Inject)($))],X);var Q=((a=Q||{}).EDITING="editing",a.VIEWING="viewing",a.ZEN_EDITOR="zen_mode",a),Z={exports:{}},J={},ee=/*@__PURE__*/t(R),et=Symbol.for("react.element"),er=Symbol.for("react.fragment"),en=Object.prototype.hasOwnProperty,ei=ee.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ea={key:!0,ref:!0,__self:!0,__source:!0};function eo(e,t,r){var n,i={},a=null,o=null;for(n in void 0!==r&&(a=""+r),void 0!==t.key&&(a=""+t.key),void 0!==t.ref&&(o=t.ref),t)en.call(t,n)&&!ea.hasOwnProperty(n)&&(i[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===i[n]&&(i[n]=t[n]);return{$$typeof:et,type:e,key:a,ref:o,props:i,_owner:ei.current}}O(eo,"q"),J.Fragment=er,J.jsx=eo,J.jsxs=eo,Z.exports=J;var es=Z.exports;let el={type:o.CommandType.COMMAND,id:"sheets.command.add-hyper-link",async handler(e,t){var r;let n;if(!t)return!1;let i=e.get(o.ICommandService),a=e.get(o.IUndoRedoService),d=e.get(p.IRenderManagerService),u=e.get(o.IUniverInstanceService),h=e.get(s.HyperLinkModel),m=e.get(l.IEditorBridgeService),{unitId:g,subUnitId:f,link:v}=t,_=u.getUnit(g,o.UniverInstanceType.UNIVER_SHEET),I=d.getRenderById(g);if(!I||!_)return!1;let S=null==_?void 0:_.getSheetBySheetId(f),C=null==(r=I.with(l.SheetSkeletonManagerService).getCurrent())?void 0:r.skeleton;if(!S||!C)return!1;let{payload:y,display:w,row:b,column:R,id:E}=v,T=S.getCell(b,R),M=C.getBlankCellDocumentModel(T),O=M.documentModel.getSnapshot(),D=(0,o.Tools).deepClone(O.body);if(!D||!(n=w?(0,o.BuildTextUtils).selection.replace({selection:{startOffset:0,endOffset:D.dataStream.length-2,collapsed:!0},body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${w}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{startIndex:0,endIndex:w.length+1,rangeType:o.CustomRangeType.HYPERLINK,rangeId:E,properties:{url:y}}]},doc:M.documentModel}):(0,o.BuildTextUtils).customRange.add({body:D,range:{startOffset:0,endOffset:D.dataStream.length-2,collapsed:!1},rangeId:E,rangeType:o.CustomRangeType.HYPERLINK,properties:{url:y,refId:E}})))return!1;let U=(0,o.TextX).apply(D,n.serialize()),k={p:{...O,body:U},t:o.CellValueType.STRING},P=await m.beforeSetRangeValue(_,S,b,R,k),N={unitId:g,subUnitId:f,cellValue:{[v.row]:{[v.column]:P}}},x={id:c.SetRangeValuesMutation.id,params:N},A=(0,c.SetRangeValuesUndoMutationFactory)(e,N),L={id:c.SetRangeValuesMutation.id,params:A},F=[x],j=[L],V=h.getHyperLinkByLocation(g,f,b,R);return V&&(F.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:g,subUnitId:f,id:V.id}}),j.push({id:s.AddHyperLinkMutation.id,params:{unitId:g,subUnitId:f,link:V}})),!!await (0,o.sequenceExecuteAsync)(F,i)&&(a.pushUndoRedo({redoMutations:F,undoMutations:j,unitID:g}),!0)}},ed={id:"sheets.command.add-rich-hyper-link",type:o.CommandType.COMMAND,handler:/* @__PURE__ */O(async(e,t)=>{if(!t)return!1;let{documentId:r,link:n}=t,i=e.get(o.ICommandService),a=(0,o.generateRandomId)(),{payload:s}=n,l=(0,m.addCustomRangeBySelectionFactory)(e,{unitId:r,rangeId:a,rangeType:o.CustomRangeType.HYPERLINK,properties:{url:s,refId:a}});return!!l&&i.syncExecuteCommand(l.id,l.params)},"handler")},eu={type:o.CommandType.COMMAND,id:"sheets.command.update-hyper-link",async handler(e,t){var r,n,i,a;if(!t)return!1;let d=e.get(o.ICommandService),u=e.get(o.IUndoRedoService),h=e.get(p.IRenderManagerService),g=e.get(o.IUniverInstanceService),f=e.get(s.HyperLinkModel),v=e.get(l.IEditorBridgeService),{unitId:_,subUnitId:I,payload:S,row:C,column:y,id:w}=t,b=g.getUnit(_,o.UniverInstanceType.UNIVER_SHEET),R=h.getRenderById(_);if(!R||!b)return!1;let E=null==b?void 0:b.getSheetBySheetId(I),T=null==(r=R.with(l.SheetSkeletonManagerService).getCurrent())?void 0:r.skeleton;if(!E||!T)return!1;let{payload:M,display:O=""}=S,D=E.getCell(C,y);if(!D)return!1;let U=T.getCellDocumentModelWithFormula(D);if(!(null!=U&&U.documentModel))return!1;let k=U.documentModel.getSnapshot(),P=null==(i=null==(n=k.body)?void 0:n.customRanges)?void 0:i.find(e=>e.rangeId===w);if(!P)return!1;let N=(0,o.generateRandomId)(),x=null==(a=(0,o.getBodySlice)(U.documentModel.getBody(),P.startIndex,P.endIndex+1).textRuns)?void 0:a[0];x&&(x.ed=O.length+1);let A=(0,m.replaceSelectionFactory)(e,{unitId:_,body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${O}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{rangeId:N,rangeType:o.CustomRangeType.HYPERLINK,startIndex:0,endIndex:O.length+1,properties:{url:M}}],textRuns:x?[x]:void 0},selection:{startOffset:P.startIndex,endOffset:P.endIndex+1,collapsed:!1},doc:U.documentModel});if(!A)return!1;let L=(0,o.TextX).apply((0,o.Tools).deepClone(k.body),A.textX.serialize()),F={p:{...k,body:L},t:o.CellValueType.STRING},j=await v.beforeSetRangeValue(b,E,C,y,F),V={id:c.SetRangeValuesMutation.id,params:{unitId:_,subUnitId:I,cellValue:{[C]:{[y]:j}}}},H=(0,c.SetRangeValuesUndoMutationFactory)(e,V.params),$={id:c.SetRangeValuesMutation.id,params:H},B=[V],W=[$],G=f.getHyperLinkByLocation(_,I,C,y);return G&&(B.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:_,subUnitId:I,id:G.id}}),W.push({id:s.AddHyperLinkMutation.id,params:{unitId:_,subUnitId:I,link:G}})),!!await (0,o.sequenceExecuteAsync)(B,d)&&(u.pushUndoRedo({redoMutations:B,undoMutations:W,unitID:_}),!0)}},ec={type:o.CommandType.COMMAND,id:"sheets.command.update-rich-hyper-link",handler:/* @__PURE__ */O((e,t)=>{var r,n,i,a;if(!t)return!1;let{documentId:s,payload:l,id:d}=t,u=e.get(o.IUniverInstanceService),c=e.get(o.ICommandService),h=u.getUnit(s,o.UniverInstanceType.UNIVER_DOC);if(!h)return!1;let p=null==(n=null==(r=h.getBody())?void 0:r.customRanges)?void 0:n.find(e=>e.rangeId===d);if(!p)return!1;let g=null!=(i=t.payload.display)?i:"",f=(0,o.generateRandomId)(),v=null==(a=(0,o.getBodySlice)(h.getBody(),p.startIndex,p.endIndex+1).textRuns)?void 0:a[0];v&&(v.ed=g.length+1);let _=(0,m.replaceSelectionFactory)(e,{unitId:s,body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${g}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{rangeId:f,rangeType:o.CustomRangeType.HYPERLINK,startIndex:0,endIndex:g.length+1,properties:{url:l.payload}}],textRuns:v?[v]:void 0},selection:{startOffset:p.startIndex,endOffset:p.endIndex+1,collapsed:!1},doc:h});return!!_&&c.syncExecuteCommand(_.id,_.params)},"handler")},eh=class extends o.Disposable{constructor(){super(...arguments),D(this,"_customHyperLinks",/* @__PURE__ */new Map)}isBuiltInLinkType(e){return e!==s.SheetHyperLinkType.URL}getOptions(){return Array.from(this._customHyperLinks.values()).map(({option:e})=>e)}findCustomHyperLink(e){return Array.from(this._customHyperLinks.values()).find(t=>t.match(e))}registerCustomHyperLink(e){this._customHyperLinks.set(e.type,e)}getCustomHyperLink(e){return this._customHyperLinks.get(e)}removeCustomHyperLink(e){let{_customHyperLinks:t}=this;t.delete(e)}dispose(){super.dispose(),this._customHyperLinks.clear()}};O(eh,"SheetsHyperLinkSidePanelService");let em={cellLinkEdit:"univer-cell-link-edit",cellLinkEditButtons:"univer-cell-link-edit-buttons"},ep=/* @__PURE__ */O(()=>{var e;let[t,r]=(0,R.useState)(""),[n,i]=(0,R.useState)(!1),[a,g]=(0,R.useState)(""),[f,v]=(0,R.useState)(!0),[_,I]=(0,R.useState)(s.SheetHyperLinkType.URL),[S,C]=(0,R.useState)(""),y=(0,o.useDependency)(o.LocaleService),w=(0,o.useDependency)(u.IDefinedNamesService),T=(0,o.useDependency)(l.IEditorBridgeService),M=(0,o.useDependency)(o.IUniverInstanceService),D=(0,o.useDependency)(ez),k=(0,h.useObservable)(D.currentEditing$),P=(0,o.useDependency)($),x=(0,o.useDependency)(o.ICommandService),A=(0,o.useDependency)(eh),L=(0,R.useMemo)(()=>A.getOptions(),[A]),F=(0,o.useDependency)(h.IZenZoneService),j=(0,o.useDependency)(p.IRenderManagerService),V=(0,o.useDependency)(l.IMarkSelectionService),H=(0,o.useDependency)(b.DocSelectionManagerService),B=(0,o.useDependency)(o.IContextService),W=(0,o.useDependency)(o.ThemeService),G=(0,o.useDependency)(b.DocSelectionManagerService),z=(0,R.useRef)({}),Y=(0,R.useMemo)(()=>{if(!A.isBuiltInLinkType(_))return A.getCustomHyperLink(_)},[A,_]),[K,q]=(0,R.useState)(!1),[X,Z]=(0,R.useState)(!1),J=(0,R.useRef)(!1),ee=M.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET),et=(null==ee?void 0:ee.getActiveSheet().getSheetId())||"";(0,R.useEffect)(()=>{Z(!1)},[et]),(0,R.useEffect)(()=>{var e,t,n,i,a,l,d,c,h,m,p,f,_,S,y,w,b;if((null==k?void 0:k.row)!==void 0&&void 0!==k.col){let R;let{label:E,customRange:T,row:O,col:D}=k;if(T)R={id:null!=(e=null==T?void 0:T.rangeId)?e:"",display:null!=E?E:"",payload:null!=(n=null==(t=null==T?void 0:T.properties)?void 0:t.url)?n:"",row:O,column:D};else if(k.type===Q.VIEWING){let e=M.getUnit(k.unitId),t=null==e?void 0:e.getSheetBySheetId(k.subUnitId),r=null==t?void 0:t.getCellRaw(k.row,k.col),n=null==(l=null==(a=null==(i=null==r?void 0:r.p)?void 0:i.body)?void 0:a.customRanges)?void 0:l.find(e=>{var t;return e.rangeType===o.CustomRangeType.HYPERLINK&&(null==(t=e.properties)?void 0:t.url)}),s=null==r?void 0:r.v;r&&(!(0,o.BuildTextUtils).transform.isEmptyDocument(null==(c=null==(d=r.p)?void 0:d.body)?void 0:c.dataStream)||s)&&v(!1),R={id:"",display:"",payload:null!=(m=null==(h=null==n?void 0:n.properties)?void 0:h.url)?m:"",row:O,column:D}}else{let e=M.getCurrentUnitForType(o.UniverInstanceType.UNIVER_DOC),t=H.getActiveTextRange(),r=null==e?void 0:e.getBody(),n=t&&r?(0,o.BuildTextUtils).selection.getInsertSelection(t,r):null,i=n&&(null==(f=(0,o.BuildTextUtils).customRange.getCustomRangesInterestsWithSelection(n,null!=(p=null==r?void 0:r.customRanges)?p:[]))?void 0:f[0]);v(!1),R={id:"",display:null!=E?E:"",payload:null!=(S=null==(_=null==i?void 0:i.properties)?void 0:_.url)?S:"",row:O,column:D}}r(R.id);let U=A.findCustomHyperLink(R);if(U){let e=U.convert(R);I(e.type),C(e.payload),g(e.display);return}g(R.display);let N=P.parseHyperLink(R.payload);switch(I(N.type===s.SheetHyperLinkType.INVALID?s.SheetHyperLinkType.RANGE:N.type),N.type){case s.SheetHyperLinkType.URL:C(N.url),N.url===R.display&&(J.current=!0);break;case s.SheetHyperLinkType.RANGE:{let e=N.searchObj,t=e.gid&&null!=(b=null==(w=null==(y=M.getUnit(k.unitId))?void 0:y.getSheetBySheetId(e.gid))?void 0:w.getName())?b:"",r=(0,u.serializeRangeWithSheet)(t,(0,u.deserializeRangeWithSheet)(e.range).range);C(r),r===R.display&&(J.current=!0);break}case s.SheetHyperLinkType.SHEET:C(N.searchObj.gid);break;case s.SheetHyperLinkType.DEFINE_NAME:C(N.searchObj.rangeid);break;default:C("")}}},[k,P,A,H,M]),(0,R.useEffect)(()=>{let e=null;if(k&&!k.customRangeId&&k.type===Q.VIEWING&&(0,o.Tools).isDefine(k.row)&&(0,o.Tools).isDefine(k.col)){let t=M.getUnit(k.unitId,o.UniverInstanceType.UNIVER_SHEET),r=null==t?void 0:t.getSheetBySheetId(k.subUnitId),n=null==r?void 0:r.getMergedCell(k.row,k.col),i=new(0,o.ColorKit)(W.getCurrentTheme().hyacinth500).toRgb();e=V.addShape({range:null!=n?n:{startColumn:k.col,endColumn:k.col,startRow:k.row,endRow:k.row},style:{hasAutoFill:!1,fill:`rgb(${i.r}, ${i.g}, ${i.b}, 0.12)`,strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null},[],-1)}return()=>{e&&V.removeShape(e)}},[k,V,W,M]),(0,R.useEffect)(()=>{_!==s.SheetHyperLinkType.RANGE||f||X||Z(!0)},[_,X,f,T]),(0,R.useEffect)(()=>{let e=(null==k?void 0:k.type)===Q.ZEN_EDITOR?j.getRenderById(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY):j.getRenderById(T.getCurrentEditorId()),t=new o.DisposableCollection;if(e){let r=e.with(m.DocSelectionRenderService);r.setReserveRangesStatus(!0),t.add(()=>{r.setReserveRangesStatus(!1)})}return()=>{T.disableForceKeepVisible(),t.dispose()}},[null==k?void 0:k.type,T,j]),(0,R.useEffect)(()=>(D.setIsKeepVisible(X),()=>{D.setIsKeepVisible(!1)}),[X,D]),(0,R.useEffect)(()=>()=>{F.temporaryHidden&&(F.show(),B.setContextValue(o.FOCUSING_SHEET,!1))},[B,F]);let er=[{label:y.t("hyperLink.form.link"),value:s.SheetHyperLinkType.URL},{label:y.t("hyperLink.form.range"),value:s.SheetHyperLinkType.RANGE},{label:y.t("hyperLink.form.worksheet"),value:s.SheetHyperLinkType.SHEET},{label:y.t("hyperLink.form.definedName"),value:s.SheetHyperLinkType.DEFINE_NAME},...L];if(!ee)return;let en=ee.getHiddenWorksheets(),ei=ee.getSheets().map(e=>({label:e.getName(),value:e.getSheetId()})).filter(e=>-1===en.indexOf(e.value)),ea=Object.values(null!=(e=w.getDefinedNameMap(ee.getUnitId()))?e:{}).map(e=>({label:e.name,value:e.id})),eo=/* @__PURE__ */O((e,t)=>{if(e===s.SheetHyperLinkType.URL)return N(t);if(e===s.SheetHyperLinkType.RANGE){let e=(0,u.deserializeRangeWithSheet)(t),r=ee.getSheetBySheetName(e.sheetName);if(r)return`#gid=${r.getSheetId()}&range=${(0,u.serializeRange)(e.range)}`}return`#${e}=${t}`},"formatUrl"),ep=(0,h.useEvent)(e=>{var t;let r=e.split(",").map(u.deserializeRangeWithSheet)[0];if(!r||!(0,o.isValidRange)(r.range))return;r.sheetName||(r.sheetName=(null==(t=ee.getActiveSheet())?void 0:t.getName())||"");let n=(0,u.serializeRangeToRefString)(r);C(n),n&&(J.current||!a)&&(g(n),J.current=!0)}),eg=/* @__PURE__ */O(async()=>{if(f&&!a||!S||_===s.SheetHyperLinkType.URL&&!U(S)){q(!0);return}if(k){if(t){let e=k.type===Q.ZEN_EDITOR||k.type===Q.EDITING?ec.id:eu.id;await x.executeCommand(e,{id:t,unitId:k.unitId,subUnitId:k.subUnitId,payload:{display:f?a:"",payload:eo(_,S)},row:k.row,column:k.col,documentId:k.type===Q.ZEN_EDITOR?o.DOCS_ZEN_EDITOR_UNIT_ID_KEY:T.getCurrentEditorId()})}else{let e=k.type===Q.ZEN_EDITOR||k.type===Q.EDITING?ed.id:el.id;await x.executeCommand(e,{unitId:k.unitId,subUnitId:k.subUnitId,link:{id:(0,o.generateRandomId)(),row:k.row,column:k.col,payload:eo(_,S),display:f?a:""},documentId:k.type===Q.ZEN_EDITOR?o.DOCS_ZEN_EDITOR_UNIT_ID_KEY:T.getCurrentEditorId()})}}(null==k?void 0:k.type)===Q.VIEWING&&(await x.executeCommand(c.SetWorksheetActiveOperation.id,{unitId:k.unitId,subUnitId:k.subUnitId}),await x.executeCommand(l.ScrollToRangeOperation.id,{range:{startRow:Math.max(k.row-1,0),endRow:k.row+1,startColumn:Math.max(k.col-1,0),endColumn:k.col+1}})),x.executeCommand(eQ.id)},"handleSubmit"),ef=/* @__PURE__ */O(e=>{var t;if(_!==s.SheetHyperLinkType.RANGE)return;let r=null==(t=z.current)?void 0:t.handleOutClick;r&&r(e,Z)},"handlePanelClick");return k?/* @__PURE__ */es.jsxs("div",{className:em.cellLinkEdit,style:{display:n?"none":"block"},onClick:ef,children:[f?/* @__PURE__ */es.jsx(d.FormLayout,{label:y.t("hyperLink.form.label"),error:K&&!a?y.t("hyperLink.form.inputError"):"",children:/* @__PURE__ */es.jsx(d.Input,{value:a,onChange:/* @__PURE__ */O(e=>{g(e),J.current=!1},"onChange"),placeholder:y.t("hyperLink.form.labelPlaceholder"),autoFocus:!0,onKeyDown:/* @__PURE__ */O(e=>{e.keyCode===h.KeyCode.ENTER&&eg()},"onKeyDown")})}):null,/* @__PURE__ */es.jsx(d.FormLayout,{label:y.t("hyperLink.form.type"),children:/* @__PURE__ */es.jsx(d.Select,{options:er,value:_,onChange:/* @__PURE__ */O(e=>{I(e),C("")},"onChange")})}),_===s.SheetHyperLinkType.URL&&/* @__PURE__ */es.jsx(d.FormLayout,{error:K?S?U(S)?"":y.t("hyperLink.form.linkError"):y.t("hyperLink.form.inputError"):"",children:/* @__PURE__ */es.jsx(d.Input,{value:S,onChange:/* @__PURE__ */O(e=>{C(e),e&&(J.current||!a||a===S)&&(g(e),J.current=!0)},"onChange"),placeholder:y.t("hyperLink.form.linkPlaceholder"),autoFocus:!0,onKeyDown:/* @__PURE__ */O(e=>{e.keyCode===h.KeyCode.ENTER&&eg()},"onKeyDown")})}),_===s.SheetHyperLinkType.RANGE&&/* @__PURE__ */es.jsx(d.FormLayout,{error:K&&!S?y.t("hyperLink.form.inputError"):"",children:/* @__PURE__ */es.jsx(E.RangeSelector,{unitId:ee.getUnitId(),subUnitId:et,isOnlyOneRange:!0,isSupportAcrossSheet:!0,initValue:S,onChange:ep,isFocus:X,onBlur:/* @__PURE__ */O(()=>{Z(!1)},"onBlur"),actions:z.current,onRangeSelectorDialogVisibleChange:/* @__PURE__ */O(async e=>{var t,r;if(e)k.type===Q.ZEN_EDITOR&&(F.hide(),B.setContextValue(o.FOCUSING_SHEET,!0)),k.type!==Q.VIEWING&&T.enableForceKeepVisible(),i(!0);else{if(await P.navigateToRange(k.unitId,k.subUnitId,{startRow:k.row,endRow:k.row,startColumn:k.col,endColumn:k.col}),k.type===Q.ZEN_EDITOR){await x.executeCommand(c.SetSelectionsOperation.id,{unitId:k.unitId,subUnitId:k.subUnitId,selections:[{range:{startRow:k.row,endRow:k.row,startColumn:k.col,endColumn:k.col}}]}),F.show(),B.setContextValue(o.FOCUSING_SHEET,!1);let e=null==(t=j.getRenderById(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY))?void 0:t.with(m.DocBackScrollRenderController),n=null==(r=G.getTextRanges({unitId:o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,subUnitId:o.DOCS_ZEN_EDITOR_UNIT_ID_KEY}))?void 0:r[0];e&&n&&(e.scrollToRange(n),G.refreshSelection({unitId:o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,subUnitId:o.DOCS_ZEN_EDITOR_UNIT_ID_KEY}))}T.disableForceKeepVisible(),i(!1)}},"onRangeSelectorDialogVisibleChange")})}),_===s.SheetHyperLinkType.SHEET&&/* @__PURE__ */es.jsx(d.FormLayout,{error:K&&!S?y.t("hyperLink.form.selectError"):"",children:/* @__PURE__ */es.jsx(d.Select,{options:ei,value:S,onChange:/* @__PURE__ */O(e=>{var t,r;C(e);let n=null==(t=ei.find(t=>t.value===e))?void 0:t.label,i=null==(r=ei.find(e=>e.value===S))?void 0:r.label;n&&(J.current||!a||a===i)&&(g(n),J.current=!0)},"onChange")})}),_===s.SheetHyperLinkType.DEFINE_NAME&&/* @__PURE__ */es.jsx(d.FormLayout,{error:K&&!S?y.t("hyperLink.form.selectError"):"",children:/* @__PURE__ */es.jsx(d.Select,{options:ea,value:S,onChange:/* @__PURE__ */O(e=>{var t,r;C(e);let n=null==(t=ea.find(t=>t.value===e))?void 0:t.label,i=null==(r=ea.find(e=>e.value===S))?void 0:r.label;n&&(J.current||!a||a===i)&&(g(n),J.current=!0)},"onChange")})}),(null==Y?void 0:Y.Form)&&/* @__PURE__ */es.jsx(Y.Form,{linkId:t,payload:S,display:a,showError:K,setByPayload:J,setDisplay:/* @__PURE__ */O(e=>{g(e),J.current=!0},"setDisplay"),setPayload:C}),/* @__PURE__ */es.jsxs("div",{className:em.cellLinkEditButtons,children:[/* @__PURE__ */es.jsx(d.Button,{onClick:/* @__PURE__ */O(()=>{k&&P.navigateToRange(k.unitId,k.subUnitId,{startRow:k.row,endRow:k.row,startColumn:k.col,endColumn:k.col}),x.executeCommand(eQ.id)},"onClick"),children:y.t("hyperLink.form.cancel")}),/* @__PURE__ */es.jsx(d.Button,{type:"primary",style:{marginLeft:8},onClick:/* @__PURE__ */O(async()=>{eg()},"onClick"),children:y.t("hyperLink.form.ok")})]})]}):null},"CellLinkEdit");ep.componentKey="univer.sheet.cell-link-edit";var eg=function(){return(eg=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},ef=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},ev=(0,R.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=ef(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,R.useRef)("_".concat(eC()));return e_(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},eg({ref:t,className:s},o),a)});function e_(e,t,r,n,i){return(0,R.createElement)(e.tag,eg(eg({key:t},eI(e,r,i)),n),(eS(e,r).children||[]).map(function(n,a){return e_(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function eI(e,t,r){var n=eg({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function eS(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?eg(eg({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?eg(eg({},e),{attrs:eg(eg({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function eC(){return Math.random().toString(36).substring(2,8)}O(e_,"render"),O(eI,"replaceRuntimeIdsAndExtInAttrs"),O(eS,"replaceRuntimeIdsInDefs"),O(eC,"generateShortUuid"),ev.displayName="UniverIcon";var ey={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.9999 1.12915C8.03875 1.12915 8.07673 1.13284 8.11352 1.13989H12.2599C13.6958 1.13989 14.8599 2.30395 14.8599 3.73989V7.88619C14.867 7.92301 14.8707 7.96102 14.8707 7.9999C14.8707 8.03878 14.867 8.0768 14.8599 8.11362V12.2599C14.8599 13.6958 13.6958 14.8599 12.2599 14.8599H8.11362C8.0768 14.867 8.03878 14.8707 7.9999 14.8707C7.96102 14.8707 7.92301 14.867 7.88619 14.8599H3.73989C2.30396 14.8599 1.13989 13.6958 1.13989 12.2599V8.11352C1.13284 8.07673 1.12915 8.03875 1.12915 7.9999C1.12915 7.96106 1.13284 7.92308 1.13989 7.88629V3.73989C1.13989 2.30396 2.30395 1.13989 3.73989 1.13989H7.88629C7.92308 1.13284 7.96106 1.12915 7.9999 1.12915ZM2.33989 8.5999V12.2599C2.33989 13.0331 2.9667 13.6599 3.73989 13.6599H7.3999V8.5999H2.33989ZM7.3999 7.3999H2.33989V3.73989C2.33989 2.9667 2.96669 2.33989 3.73989 2.33989H7.3999V7.3999ZM8.5999 8.5999V13.6599H12.2599C13.0331 13.6599 13.6599 13.0331 13.6599 12.2599V8.5999H8.5999ZM13.6599 7.3999H8.5999V2.33989H12.2599C13.0331 2.33989 13.6599 2.96669 13.6599 3.73989V7.3999Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ew=(0,R.forwardRef)(function(e,t){return(0,R.createElement)(ev,Object.assign({},e,{id:"all-border-single",ref:t,icon:ey}))});ew.displayName="AllBorderSingle";var eb={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M4.1302 12.4251C4.25802 13.7417 5.36779 14.7708 6.71792 14.7708H11.7179C13.1539 14.7708 14.3179 13.6067 14.3179 12.1708V6.1708C14.3179 4.78586 13.2351 3.65383 11.8698 3.57517C11.742 2.25858 10.6323 1.22949 9.28213 1.22949H4.28213C2.84619 1.22949 1.68213 2.39355 1.68213 3.82949V9.82949C1.68213 11.2144 2.76497 12.3465 4.1302 12.4251ZM10.6583 3.5708H6.71792C5.28198 3.5708 4.11792 4.73486 4.11792 6.1708V11.22C3.4221 11.1387 2.88213 10.5471 2.88213 9.82949V3.82949C2.88213 3.05629 3.50893 2.42949 4.28213 2.42949H9.28213C9.96695 2.42949 10.5369 2.92119 10.6583 3.5708ZM13.1179 6.1708C13.1179 5.3976 12.4911 4.7708 11.7179 4.7708H6.71792C5.94472 4.7708 5.31792 5.3976 5.31792 6.1708V12.1708C5.31792 12.944 5.94472 13.5708 6.71792 13.5708H11.7179C12.4911 13.5708 13.1179 12.944 13.1179 12.1708V6.1708Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eR=(0,R.forwardRef)(function(e,t){return(0,R.createElement)(ev,Object.assign({},e,{id:"copy-single",ref:t,icon:eb}))});eR.displayName="CopySingle";var eE={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.9564 2.91332C4.91407 1.87102 3.22413 1.87101 2.18182 2.91333L2.18182 2.91333C1.13953 3.95567 1.13952 5.6456 2.18182 6.68791L8.27777 12.7838C9.72408 14.2302 12.069 14.2302 13.5154 12.7839L13.0911 12.3596L13.5154 12.7839C14.9617 11.3375 14.9617 8.99257 13.5154 7.54626L8.39476 2.42566C8.16044 2.19134 7.78054 2.19134 7.54623 2.42566C7.31191 2.65997 7.31191 3.03987 7.54623 3.27419L12.6668 8.39479L13.0911 7.97052L12.6668 8.39479C13.6445 9.37247 13.6445 10.9576 12.6668 11.9353L13.0399 12.3084L12.6668 11.9353C11.6891 12.913 10.104 12.913 9.1263 11.9353L3.03035 5.83938C2.45668 5.26571 2.45667 4.33556 3.03036 3.76184C3.60403 3.18818 4.53416 3.18817 5.10788 3.76185C5.10788 3.76186 5.10788 3.76186 5.10789 3.76186L11.2038 9.8578L11.601 9.46061L11.2038 9.8578C11.3735 10.0275 11.3735 10.3026 11.2038 10.4723L11.2038 10.4723C11.0341 10.642 10.759 10.642 10.5893 10.4723L5.46874 5.35171C5.23442 5.1174 4.85452 5.1174 4.62021 5.35171C4.38589 5.58602 4.38589 5.96592 4.62021 6.20024L9.74078 11.3208C10.3791 11.9591 11.414 11.9591 12.0523 11.3208C12.0523 11.3208 12.0523 11.3208 12.0523 11.3208M12.0523 11.3208C12.6907 10.6825 12.6906 9.64757 12.0523 9.00927L5.95641 2.91333L5.9564 2.91332",fillRule:"evenodd",clipRule:"evenodd"}}]},eT=(0,R.forwardRef)(function(e,t){return(0,R.createElement)(ev,Object.assign({},e,{id:"link-single",ref:t,icon:eE}))});eT.displayName="LinkSingle";var eM={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.5935 3.47302C11.6354 2.51492 10.082 2.51492 9.12388 3.47302L7.83534 4.76157C7.60102 4.99588 7.22112 4.99588 6.98681 4.76157 6.75249 4.52725 6.75249 4.14735 6.98681 3.91304L8.27535 2.62449C9.70209 1.19776 12.0153 1.19776 13.442 2.62449 14.8688 4.05123 14.8688 6.36442 13.442 7.79116L12.1535 9.0797C11.9192 9.31402 11.5393 9.31402 11.3049 9.0797 11.0706 8.84539 11.0706 8.46549 11.3049 8.23117L12.5935 6.94263C13.5516 5.98452 13.5516 4.43113 12.5935 3.47302zM3.40637 12.6606C2.44827 11.7025 2.44827 10.1491 3.40637 9.19102L4.69492 7.90248C4.92923 7.66816 4.92923 7.28826 4.69492 7.05395 4.4606 6.81963 4.0807 6.81963 3.84639 7.05395L2.55784 8.34249C1.13111 9.76923 1.13111 12.0824 2.55784 13.5092 3.98458 14.9359 6.29777 14.9359 7.72451 13.5092L9.01305 12.2206C9.24737 11.9863 9.24737 11.6064 9.01305 11.3721 8.77874 11.1378 8.39884 11.1378 8.16452 11.3721L6.87598 12.6606C5.91787 13.6187 4.36448 13.6187 3.40637 12.6606zM3.5852 2.80332C3.35088 2.569 2.97098 2.569 2.73667 2.80332 2.50235 3.03763 2.50235 3.41753 2.73667 3.65185L12.4151 13.3302C12.6494 13.5646 13.0293 13.5646 13.2636 13.3302 13.4979 13.0959 13.4979 12.716 13.2636 12.4817L3.5852 2.80332z"}}]},eO=(0,R.forwardRef)(function(e,t){return(0,R.createElement)(ev,Object.assign({},e,{id:"unlink-single",ref:t,icon:eM}))});eO.displayName="UnlinkSingle";var eD={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.6551 1.98906C11.7476 1.08113 10.2757 1.08149 9.3686 1.98987L4.82542 6.53955C4.75087 6.61421 4.69336 6.70411 4.65682 6.80309L3.2461 10.625C3.16506 10.8446 3.21909 11.0912 3.3845 11.2568C3.54991 11.4224 3.79651 11.4767 4.01616 11.3959L7.85031 9.98517C7.94979 9.94856 8.04014 9.89077 8.11508 9.81579L12.6552 5.27327C13.5618 4.36621 13.5618 2.89607 12.6551 1.98906ZM10.2177 2.83779C10.6562 2.39869 11.3677 2.39851 11.8064 2.8374C12.2447 3.27584 12.2447 3.9865 11.8065 4.42497L7.3392 8.89457L4.82213 9.82068L5.74706 7.31487L10.2177 2.83779Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.79238 13.2999C1.46101 13.2999 1.19238 13.5685 1.19238 13.8999C1.19238 14.2313 1.46101 14.4999 1.79238 14.4999H14.4924C14.8238 14.4999 15.0924 14.2313 15.0924 13.8999C15.0924 13.5685 14.8238 13.2999 14.4924 13.2999H1.79238Z"}}]},eU=(0,R.forwardRef)(function(e,t){return(0,R.createElement)(ev,Object.assign({},e,{id:"write-single",ref:t,icon:eD}))});eU.displayName="WriteSingle";var ek={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"#35BD4B",d:"M3.4535 1.12549C2.7002 1.12549 2.08954 1.73615 2.08954 2.48945V13.5104C2.08954 14.2637 2.7002 14.8744 3.4535 14.8744H12.5465C13.2998 14.8744 13.9105 14.2637 13.9105 13.5104V5.0992L10.0091 1.12549H3.4535Z"}},{tag:"path",attrs:{fill:"#32A846",d:"M10.0075 1.12549L13.9104 5.09842H10.6742C10.306 5.09842 10.0075 4.79994 10.0075 4.43175V1.12549Z"}},{tag:"path",attrs:{fill:"#fff",d:"M7.8088 10.2949L6.3764 12.403C6.26259 12.5705 6.03455 12.614 5.86705 12.5002C5.69955 12.3864 5.65603 12.1584 5.76984 11.9909L7.3655 9.64252L5.94042 7.54519C5.82661 7.37769 5.87013 7.14964 6.03763 7.03583C6.20512 6.92202 6.43317 6.96555 6.54698 7.13304L7.8088 8.9901L9.07062 7.13304C9.18443 6.96555 9.41248 6.92202 9.57997 7.03583C9.74747 7.14964 9.79099 7.37769 9.67718 7.54519L8.2521 9.64252L9.84776 11.9909C9.96157 12.1584 9.91805 12.3864 9.75055 12.5002C9.58305 12.614 9.35501 12.5705 9.2412 12.403L7.8088 10.2949Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eP=(0,R.forwardRef)(function(e,t){return(0,R.createElement)(ev,Object.assign({},e,{id:"xlsx",ref:t,icon:ek}))});function eN(e){var t,r,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e){if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(r=eN(e[t]))&&(n&&(n+=" "),n+=r)}else for(r in e)e[r]&&(n&&(n+=" "),n+=r)}return n}function ex(){for(var e,t,r=0,n="",i=arguments.length;r<i;r++)(e=arguments[r])&&(t=eN(e))&&(n&&(n+=" "),n+=t);return n}eP.displayName="Xlsx",O(eN,"r"),O(ex,"clsx");let eA={type:o.CommandType.COMMAND,id:"sheets.command.cancel-hyper-link",handler(e,t){var r,n,i;if(!t)return!1;let a=e.get(o.ICommandService),d=e.get(o.IUndoRedoService),u=e.get(p.IRenderManagerService),h=e.get(o.IUniverInstanceService),m=e.get(s.HyperLinkModel),{unitId:g,subUnitId:f,row:v,column:_,id:I}=t,S=h.getUnit(g,o.UniverInstanceType.UNIVER_SHEET),C=u.getRenderById(g);if(!C||!S)return!1;let y=null==S?void 0:S.getSheetBySheetId(f),w=null==(r=C.with(l.SheetSkeletonManagerService).getCurrent())?void 0:r.skeleton;if(!y||!w)return!1;let b=y.getCell(v,_);if(!b)return!1;let R=w.getCellDocumentModelWithFormula(b);if(!(null!=R&&R.documentModel))return!1;let E=(0,o.Tools).deepClone(R.documentModel.getSnapshot());if(!(null==(i=null==(n=E.body)?void 0:n.customRanges)?void 0:i.find(e=>e.rangeId===I)))return!1;let T=(0,o.BuildTextUtils).customRange.delete(e,{documentDataModel:R.documentModel,rangeId:I});if(!T)return!1;let M=(0,o.TextX).apply(E.body,T.serialize()),O=[],D=[],U={unitId:g,subUnitId:f,cellValue:{[v]:{[_]:{p:{...E,body:M},t:o.CellValueType.STRING}}}};O.push({id:c.SetRangeValuesMutation.id,params:U});let k=(0,c.SetRangeValuesUndoMutationFactory)(e,U);D.push({id:c.SetRangeValuesMutation.id,params:k});let P=m.getHyperLinkByLocation(g,f,v,_);return P&&(O.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:g,subUnitId:f,id:I}}),D.push({id:s.AddHyperLinkMutation.id,params:{unitId:g,subUnitId:f,link:{...P}}})),!!(0,o.sequenceExecute)(O,a).result&&(d.pushUndoRedo({redoMutations:O,undoMutations:D,unitID:g}),!0)}},eL={type:o.CommandType.COMMAND,id:"sheets.command.cancel-rich-hyper-link",handler(e,t){var r,n;if(!t)return!1;let{id:i,documentId:a}=t,s=e.get(o.ICommandService),l=e.get(o.IUniverInstanceService).getUnit(a,o.UniverInstanceType.UNIVER_DOC),d=null==(n=null==(r=null==l?void 0:l.getBody())?void 0:r.customRanges)?void 0:n.find(e=>e.rangeId===i),u=null;d&&d.endIndex===l.getBody().dataStream.length-3&&(u={dataStream:" "});let c=(0,m.deleteCustomRangeFactory)(e,{unitId:a,rangeId:i,insert:u});return!!c&&s.syncExecuteCommand(c.id,c.params)}},eF={cellLink:"univer-cell-link",cellLinkType:"univer-cell-link-type",cellLinkContent:"univer-cell-link-content",cellLinkContentError:"univer-cell-link-content-error",cellLinkUrl:"univer-cell-link-url",cellLinkOperations:"univer-cell-link-operations",cellLinkOperation:"univer-cell-link-operation",cellLinkOperationError:"univer-cell-link-operation-error"},ej={[s.SheetHyperLinkType.URL]:/* @__PURE__ */es.jsx(eT,{}),[s.SheetHyperLinkType.SHEET]:/* @__PURE__ */es.jsx(eP,{}),[s.SheetHyperLinkType.RANGE]:/* @__PURE__ */es.jsx(ew,{}),[s.SheetHyperLinkType.DEFINE_NAME]:/* @__PURE__ */es.jsx(ew,{}),[s.SheetHyperLinkType.INVALID]:/* @__PURE__ */es.jsx(ew,{})},eV=/* @__PURE__ */O(()=>{var e,t;let r=(0,o.useDependency)(ez),n=(0,o.useDependency)(o.ICommandService),i=(0,o.useDependency)(h.IMessageService),a=(0,o.useDependency)(o.LocaleService),[u,c]=(0,R.useState)(null),m=(0,o.useDependency)($),p=(0,o.useDependency)(l.IEditorBridgeService),g=(0,o.useDependency)(h.IZenZoneService);if((0,o.useObservable)(g.visible$),(0,R.useEffect)(()=>{c(r.currentPopup);let e=r.currentPopup$.subscribe(e=>{c(e)});return()=>{e.unsubscribe()}},[r.currentPopup,r.currentPopup$]),!u)return null;let{unitId:f,subUnitId:v,customRange:_,row:I,col:S}=u;if(!(null!=(e=null==_?void 0:_.properties)&&e.url))return null;let C=m.parseHyperLink(null!=(t=_.properties.url)?t:""),y=C.type===s.SheetHyperLinkType.INVALID;return /* @__PURE__ */es.jsxs("div",{className:eF.cellLink,onClick:/* @__PURE__ */O(()=>r.hideCurrentPopup(),"onClick"),children:[/* @__PURE__ */es.jsxs("div",{className:ex(eF.cellLinkContent,{[eF.cellLinkContentError]:y}),onClick:/* @__PURE__ */O(()=>{g.visible||C.handler()},"onClick"),children:[/* @__PURE__ */es.jsx("div",{className:eF.cellLinkType,children:ej[C.type]}),/* @__PURE__ */es.jsx(d.Tooltip,{showIfEllipsis:!0,title:C.name,children:/* @__PURE__ */es.jsx("span",{className:eF.cellLinkUrl,children:C.name})})]}),/* @__PURE__ */es.jsxs("div",{className:eF.cellLinkOperations,children:[u.copyPermission&&/* @__PURE__ */es.jsx("div",{className:ex(eF.cellLinkOperation,{[eF.cellLinkOperationError]:y}),onClick:/* @__PURE__ */O(()=>{if(!y){if(C.type!==s.SheetHyperLinkType.URL){let e=new URL(window.location.href);e.hash=C.url.slice(1),navigator.clipboard.writeText(e.href)}else navigator.clipboard.writeText(C.url);i.show({content:a.t("hyperLink.message.coped"),type:d.MessageType.Info})}},"onClick"),children:/* @__PURE__ */es.jsx(d.Tooltip,{placement:"bottom",title:a.t("hyperLink.popup.copy"),children:/* @__PURE__ */es.jsx(eR,{})})}),u.editPermission&&/* @__PURE__ */es.jsxs(es.Fragment,{children:[/* @__PURE__ */es.jsx("div",{className:eF.cellLinkOperation,onClick:/* @__PURE__ */O(()=>{n.executeCommand(eX.id,{unitId:f,subUnitId:v,row:I,col:S,customRangeId:_.rangeId,type:u.type})},"onClick"),children:/* @__PURE__ */es.jsx(d.Tooltip,{placement:"bottom",title:a.t("hyperLink.popup.edit"),children:/* @__PURE__ */es.jsx(eU,{})})}),/* @__PURE__ */es.jsx("div",{className:eF.cellLinkOperation,onClick:/* @__PURE__ */O(()=>{let e=u.type===Q.EDITING||u.type===Q.ZEN_EDITOR?eL.id:eA.id;n.syncExecuteCommand(e,{unitId:f,subUnitId:v,id:_.rangeId,row:I,column:S,documentId:u.type===Q.ZEN_EDITOR?o.DOCS_ZEN_EDITOR_UNIT_ID_KEY:p.getCurrentEditorId()})&&r.hideCurrentPopup(void 0,!0)},"onClick"),children:/* @__PURE__ */es.jsx(d.Tooltip,{placement:"bottom",title:a.t("hyperLink.popup.cancel"),children:/* @__PURE__ */es.jsx(eO,{})})})]})]})]})},"CellLinkPopup");eV.componentKey="univer.sheet.cell-link-popup";var eH=Object.defineProperty,e$=Object.getOwnPropertyDescriptor,eB=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e$(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eH(t,r,a),a},"__decorateClass$a"),eW=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$a");let eG=/* @__PURE__ */O((e,t)=>{var r,n;return e.unitId===t.unitId&&e.subUnitId===t.subUnitId&&e.row===t.row&&e.col===t.col&&(null==(r=e.customRange)?void 0:r.rangeId)===(null==(n=t.customRange)?void 0:n.rangeId)&&e.type===t.type},"isEqualLink"),ez=(te=class extends o.Disposable{constructor(e,t,r,n,i,a,o,s,l){super(),D(this,"_currentPopup",null),D(this,"_currentPopup$",new y.Subject),D(this,"currentPopup$",this._currentPopup$.asObservable()),D(this,"_currentEditingPopup",null),D(this,"_currentEditing$",new g.BehaviorSubject(null)),D(this,"currentEditing$",this._currentEditing$.asObservable()),D(this,"_isKeepVisible",!1),this._sheetCanvasPopManagerService=e,this._injector=t,this._univerInstanceService=r,this._editorBridgeService=n,this._textSelectionManagerService=i,this._docCanvasPopManagerService=a,this._editorService=o,this._rangeSelectorService=s,this._zenZoneService=l,this.disposeWithMe(()=>{this.hideCurrentPopup(),this.endEditing(),this._currentEditing$.complete(),this._currentPopup$.complete()})}get currentPopup(){return this._currentPopup}get currentEditing(){return this._currentEditing$.getValue()}setIsKeepVisible(e){this._isKeepVisible=e}getIsKeepVisible(){return this._isKeepVisible}showPopup(e){let t;if(this._currentPopup&&eG(e,this._currentPopup)||(this.hideCurrentPopup(void 0,!0),e.type!==Q.ZEN_EDITOR&&this._zenZoneService.visible))return;let r=this._currentEditing$.getValue();if(r&&eG(e,r))return;let{unitId:n,subUnitId:i,row:a,col:s,customRangeRect:l,customRange:d}=e;if(!d)return;let u={componentKey:eV.componentKey,direction:"bottom",onClickOutside:/* @__PURE__ */O(()=>{this.hideCurrentPopup()},"onClickOutside"),onClick:/* @__PURE__ */O(()=>{this.hideCurrentPopup(e.type,!0)},"onClick")};(t=e.type===Q.EDITING?l&&this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(l,u):e.type===Q.ZEN_EDITOR?this._docCanvasPopManagerService.attachPopupToRange({startOffset:d.startIndex,endOffset:d.endIndex+1,collapsed:!1},u,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY):l&&this._sheetCanvasPopManagerService.attachPopupByPosition(l,u))&&(this._currentPopup={unitId:n,subUnitId:i,disposable:t,row:a,col:s,editPermission:!!e.editPermission,copyPermission:!!e.copyPermission,customRange:d,type:e.type},this._currentPopup$.next(this._currentPopup))}hideCurrentPopup(e,t){var r,n;this._currentPopup&&((!e||e===this._currentPopup.type)&&this._currentPopup.disposable.canDispose()||t)&&(null==(n=null==(r=this._currentPopup)?void 0:r.disposable)||n.dispose(),this._currentPopup=null,this._currentPopup$.next(null))}_getEditingRange(){var e,t,r;let n=this._editorBridgeService.isVisible().visible,i=this._editorBridgeService.getEditCellState();if(n&&i){let n=this._textSelectionManagerService.getActiveTextRange(),a=null==(e=i.documentLayoutObject.documentModel)?void 0:e.getBody();if(!a)return null;if(!n||n.collapsed)return{startOffset:0,endOffset:a.dataStream.length-2,collapsed:a.dataStream.length-2==0,label:(0,o.BuildTextUtils).transform.getPlainText(a.dataStream)};let s=(0,o.BuildTextUtils).customRange.getCustomRangesInterestsWithSelection(n,null!=(r=null==(t=a.customRanges)?void 0:t.filter(e=>e.rangeType===o.CustomRangeType.HYPERLINK))?r:[]),l=n.startOffset,d=n.endOffset;return s.forEach(e=>{l=Math.min(l,e.startIndex),d=Math.max(d,e.endIndex+1)}),{startOffset:l,endOffset:d,collapsed:l===d,label:(0,o.BuildTextUtils).transform.getPlainText(a.dataStream.slice(l,d))}}return null}get _editPopup(){return{componentKey:ep.componentKey,direction:"bottom",onClickOutside:/* @__PURE__ */O(()=>{this.getIsKeepVisible()||this.endEditing()},"onClickOutside"),onContextMenu:/* @__PURE__ */O(()=>{this.getIsKeepVisible()||this.endEditing()},"onContextMenu"),hiddenType:"hide"}}startAddEditing(e){var t,r,n,i,a;let{unitId:s,subUnitId:l,type:d}=e;if(d===Q.ZEN_EDITOR){let r=this._univerInstanceService.getUnit(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,o.UniverInstanceType.UNIVER_DOC);if(!r)return;let n=this._textSelectionManagerService.getActiveTextRange();if(!n)return;this._currentEditingPopup=this._docCanvasPopManagerService.attachPopupToRange(n,this._editPopup,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY);let i=null==(t=r.getBody())?void 0:t.dataStream.slice(n.startOffset,n.endOffset-1);this._currentEditing$.next({...e,label:i})}else if(d===Q.EDITING){let t=this._getEditingRange();t&&this._textSelectionManagerService.replaceTextRanges([{...t}]),this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToCell(e.row,e.col,this._editPopup,s,l),this._currentEditing$.next({...e,label:null!=(r=null==t?void 0:t.label)?r:""})}else{this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToCell(e.row,e.col,this._editPopup,s,l);let t=this._univerInstanceService.getUnit(s,o.UniverInstanceType.UNIVER_SHEET),r=null==t?void 0:t.getSheetBySheetId(l),d=null==r?void 0:r.getCellRaw(e.row,e.col);this._currentEditing$.next({...e,label:null!=d&&d.p?(0,o.BuildTextUtils).transform.getPlainText(null!=(i=null==(n=d.p.body)?void 0:n.dataStream)?i:""):(null!=(a=null==d?void 0:d.v)?a:"").toString()})}}startEditing(e){var t,r,n,i,a,s;let d,u;null==(t=this._currentEditingPopup)||t.dispose(),this.hideCurrentPopup(void 0,!0);let{unitId:c,subUnitId:h}=e;if(e.type===Q.ZEN_EDITOR){let t=this._univerInstanceService.getUnit(o.DOCS_ZEN_EDITOR_UNIT_ID_KEY,o.UniverInstanceType.UNIVER_DOC);if(u=(d=null==(n=null==(r=null==t?void 0:t.getBody())?void 0:r.customRanges)?void 0:n.find(t=>t.rangeId===e.customRangeId))?null==(i=null==t?void 0:t.getBody())?void 0:i.dataStream.slice(d.startIndex+1,d.endIndex):"",!d||!u)return;this._textSelectionManagerService.replaceTextRanges([{startOffset:d.startIndex,endOffset:d.endIndex+1}]),this._currentEditingPopup=this._docCanvasPopManagerService.attachPopupToRange({startOffset:d.startIndex,endOffset:d.endIndex,collapsed:!1},this._editPopup,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY)}else if(e.type===Q.EDITING){let t=(0,l.getEditingCustomRangePosition)(this._injector,e.unitId,e.subUnitId,e.row,e.col,e.customRangeId);if(!t||!(null!=(a=t.rects)&&a.length))return;d=t.customRange,u=t.label,this._textSelectionManagerService.replaceTextRanges([{startOffset:d.startIndex,endOffset:d.endIndex+1}]),this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupToAbsolutePosition(t.rects.pop(),this._editPopup,c,h)}else{let t=(0,l.getCustomRangePosition)(this._injector,e.unitId,e.subUnitId,e.row,e.col,e.customRangeId);if(!t||!(null!=(s=t.rects)&&s.length))return;d=t.customRange,u=t.label,this._currentEditingPopup=this._sheetCanvasPopManagerService.attachPopupByPosition(t.rects.pop(),this._editPopup,c,h)}this._currentEditing$.next({...e,customRange:d,label:u})}endEditing(e){var t;let r=this._currentEditing$.getValue();r&&(!e||e===r.type)&&(null==(t=this._currentEditingPopup)||t.dispose(),this._currentEditing$.next(null))}},O(te,"SheetsHyperLinkPopupService"),te);ez=eB([eW(0,(0,o.Inject)(l.SheetCanvasPopManagerService)),eW(1,(0,o.Inject)(o.Injector)),eW(2,o.IUniverInstanceService),eW(3,l.IEditorBridgeService),eW(4,(0,o.Inject)(b.DocSelectionManagerService)),eW(5,(0,o.Inject)(m.DocCanvasPopManagerService)),eW(6,m.IEditorService),eW(7,m.IRangeSelectorService),eW(8,h.IZenZoneService)],ez);let eY=/* @__PURE__ */O((e,t,r)=>{let n=e.getCell(t,r);if(null!=n&&n.f||null!=n&&n.si)return!0;let i=[o.DataValidationType.CHECKBOX,o.DataValidationType.LIST,o.DataValidationType.LIST_MULTIPLE];return!!(null!=n&&n.dataValidation&&i.includes(n.dataValidation.rule.type))},"getShouldDisableCellLink"),eK=/* @__PURE__ */O(e=>{let t=e.get(o.IUniverInstanceService).getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(!t)return!0;let r=t.getActiveSheet(),n=e.get(c.SheetsSelectionsService).getCurrentSelections();return!n.length||eY(r,n[0].range.startRow,n[0].range.startColumn)},"getShouldDisableCurrentCellLink"),eq=/* @__PURE__ */O(e=>{var t,r;let n=e.get(b.DocSelectionManagerService),i=e.get(o.IUniverInstanceService),a=n.getDocRanges();if(!a.length||a.length>1)return!0;let s=a[0],l=i.getCurrentUnitForType(o.UniverInstanceType.UNIVER_DOC);if(!l||!s||s.collapsed)return!0;let d=l.getSelfOrHeaderFooterModel(s.segmentId).getBody();if(!d)return!0;let u=null!=(t=null==d?void 0:d.paragraphs)?t:[];for(let e=0,t=u.length;e<t;e++){let t=u[e];if(s.startOffset<=t.startIndex&&s.endOffset>t.startIndex)return!0;if(t.startIndex>s.endOffset)break}return!(0,o.BuildTextUtils).customRange.getCustomRangesInterestsWithSelection(s,null!=(r=d.customRanges)?r:[]).every(e=>e.rangeType===o.CustomRangeType.HYPERLINK)},"shouldDisableAddLink"),eX={type:o.CommandType.OPERATION,id:"sheet.operation.open-hyper-link-edit-panel",handler(e,t){if(!t)return!1;let r=e.get(ez);return t.customRangeId?r.startEditing(t):r.startAddEditing(t),!0}},eQ={type:o.CommandType.OPERATION,id:"sheet.operation.close-hyper-link-popup",handler:e=>(e.get(ez).endEditing(),!0)},eZ={type:o.CommandType.OPERATION,id:"sheet.operation.insert-hyper-link",handler(e){var t;let r=e.get(o.IUniverInstanceService),n=(0,c.getSheetCommandTarget)(r),i=e.get(l.IEditorBridgeService);if(!n)return!1;let a=e.get(o.ICommandService),s=e.get(c.SheetsSelectionsService).getCurrentLastSelection();if(!s)return!1;let d=s.range.startRow,u=s.range.startColumn,h=i.isVisible(),m=(null==(t=r.getFocusedUnit())?void 0:t.getUnitId())===o.DOCS_ZEN_EDITOR_UNIT_ID_KEY;return a.executeCommand(eX.id,{unitId:n.unitId,subUnitId:n.subUnitId,row:d,col:u,type:m?Q.ZEN_EDITOR:h.visible?Q.EDITING:Q.VIEWING})}},eJ={type:o.CommandType.OPERATION,id:"sheet.operation.insert-hyper-link-toolbar",handler(e){if(eK(e))return!1;let t=e.get(o.ICommandService);return e.get(ez).currentEditing?t.executeCommand(eQ.id):t.executeCommand(eZ.id)}},e1=/* @__PURE__ */O((e,t=o.DOCS_ZEN_EDITOR_UNIT_ID_KEY)=>{var r;let n=e.get(o.IUniverInstanceService),i=null==(r=e.get(p.IRenderManagerService).getRenderById(t))?void 0:r.with(m.DocSelectionRenderService);return i?i.textSelectionInner$.pipe((0,I.map)(()=>{let t=e.get(l.IEditorBridgeService).getEditCellState();if(!t)return!0;let r=(0,c.getSheetCommandTarget)(n,{unitId:t.unitId,subUnitId:t.sheetId});return!!(!(null!=r&&r.worksheet)||eY(r.worksheet,t.row,t.column))||eq(e)})):(0,C.of)(!0)},"getEditingLinkDisable$"),e0=/* @__PURE__ */O(e=>{let t=(0,l.getCurrentRangeDisable$)(e,{workbookTypes:[c.WorkbookEditablePermission],worksheetTypes:[c.WorksheetEditPermission,c.WorksheetSetCellValuePermission,c.WorksheetInsertHyperlinkPermission],rangeTypes:[c.RangeProtectionPermissionEditPoint]},!0),r=e.get(o.IUniverInstanceService),n=e.get(c.SheetsSelectionsService),i=e.has(l.IEditorBridgeService)?e.get(l.IEditorBridgeService):null,a=r.focused$.pipe((0,_.filter)(e=>!!e),(0,I.map)(e=>r.getUnit(e,o.UniverInstanceType.UNIVER_SHEET)),(0,_.filter)(e=>!!e),(0,w.switchMap)(e=>e.activeSheet$),(0,w.switchMap)(e=>n.selectionMoveEnd$.pipe((0,I.map)(t=>e&&{selections:t,sheet:e}))),(0,I.map)(e=>{if(!e)return!0;let{selections:t,sheet:r}=e;if(!t.length||eY(r,t[0].range.startRow,t[0].range.startColumn))return!0}),(0,w.switchMap)(t=>t?(0,C.of)(!0):(i?i.visible$:(0,C.of)(null)).pipe((0,I.map)(e=>null!=e&&e.visible?o.DOCS_NORMAL_EDITOR_UNIT_ID_KEY:void 0)).pipe((0,w.switchMap)(t=>t?e1(e,t):(0,C.of)(!1)))));return t.pipe((0,v.distinctUntilChanged)(),(0,w.switchMap)(e=>a.pipe((0,I.map)(t=>e||t))))},"getLinkDisable$"),e3={commandId:eZ.id,type:h.MenuItemType.BUTTON,positions:[h.MenuPosition.CONTEXT_MENU],title:"hyperLink.menu.add",icon:"LinkSingle"},e2=/* @__PURE__ */O(e=>`${e}-zen-editor`,"genZenEditorMenuId"),e4=/* @__PURE__ */O(e=>({...e3,id:e3.commandId,hidden$:(0,h.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_SHEET),disabled$:e0(e)}),"insertLinkMenuFactory"),e6=/* @__PURE__ */O(e=>({...e3,id:e2(e3.commandId),hidden$:(0,h.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_DOC,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY),disabled$:e1(e)}),"zenEditorInsertLinkMenuFactory"),e9={tooltip:"hyperLink.form.addTitle",positions:h.MenuPosition.TOOLBAR_START,group:h.MenuGroup.TOOLBAR_OTHERS,commandId:eJ.id,type:h.MenuItemType.BUTTON,icon:"LinkSingle"},e5=/* @__PURE__ */O(e=>({...e9,id:e9.commandId,hidden$:(0,h.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_SHEET),disabled$:e0(e)}),"insertLinkMenuToolbarFactory"),e8=/* @__PURE__ */O(e=>({...e9,id:e2(e9.commandId),hidden$:(0,h.getMenuHiddenObservable)(e,o.UniverInstanceType.UNIVER_DOC,o.DOCS_ZEN_EDITOR_UNIT_ID_KEY),disabled$:e1(e)}),"zenEditorInsertLinkMenuToolbarFactory"),e7={id:eJ.id,binding:h.KeyCode.K|h.MetaKeys.CTRL_COMMAND,preconditions:l.whenSheetEditorFocused};var te,tt,tr=Object.defineProperty,tn=Object.getOwnPropertyDescriptor,ti=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tn(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tr(t,r,a),a},"__decorateClass$9"),ta=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let to=(tt=class extends o.Disposable{constructor(e,t){super(),this._autoFillService=e,this._hyperLinkModel=t,this._initAutoFill()}_initAutoFill(){let e=/* @__PURE__ */O(()=>({redos:[],undos:[]}),"noopReturnFunc"),t=/* @__PURE__ */O((e,t)=>{let{source:r,target:n,unitId:i,subUnitId:a}=e,d=(0,l.virtualizeDiscreteRanges)([r,n]),[u,c]=d.ranges,{mapFunc:h}=d,m={row:u.startRow,col:u.startColumn},p=(0,l.getAutoFillRepeatRange)(u,c),g=[],f=[];return p.forEach(e=>{let r=e.repeatStartCell,n=e.relativeRange,d={startRow:m.row,startColumn:m.col,endColumn:m.col,endRow:m.row},u={startRow:r.row,startColumn:r.col,endColumn:r.col,endRow:r.row};(0,o.Range).foreach(n,(e,r)=>{let n=(0,o.Rectangle).getPositionRange({startRow:e,startColumn:r,endColumn:r,endRow:e},d),{row:c,col:m}=h(n.startRow,n.startColumn),p=this._hyperLinkModel.getHyperLinkByLocation(i,a,c,m),v=(0,o.Rectangle).getPositionRange({startRow:e,startColumn:r,endColumn:r,endRow:e},u),{row:_,col:I}=h(v.startRow,v.startColumn),S=(0,o.Tools).generateRandomId(),C=this._hyperLinkModel.getHyperLinkByLocation(i,a,_,I);C&&g.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:C.id}}),(l.APPLY_TYPE.COPY===t||l.APPLY_TYPE.SERIES===t)&&p&&(g.push({id:s.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:{...p,id:S,row:_,column:I}}}),f.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:S}})),C&&f.push({id:s.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:C}})})}),{undos:f,redos:g}},"generalApplyFunc"),r={id:B,onFillData:/* @__PURE__ */O((r,n,i)=>i===l.APPLY_TYPE.COPY||i===l.APPLY_TYPE.ONLY_FORMAT||i===l.APPLY_TYPE.SERIES?t(r,i):e(),"onFillData")};this.disposeWithMe(this._autoFillService.addHook(r))}},O(tt,"SheetsHyperLinkAutoFillController"),tt);to=ti([ta(0,l.IAutoFillService),ta(1,(0,o.Inject)(s.HyperLinkModel))],to);var ts,tl=Object.defineProperty,td=Object.getOwnPropertyDescriptor,tu=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?td(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tl(t,r,a),a},"__decorateClass$8"),tc=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");let th=(O(ts=class extends o.Disposable{constructor(e,t,r){super(),this._localeService=e,this._commandService=t,this._sheetPermissionInterceptorBaseController=r,this._commandExecutedListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{e.id===e7.id&&(this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[c.WorkbookEditablePermission],rangeTypes:[c.RangeProtectionPermissionEditPoint],worksheetTypes:[c.WorksheetEditPermission,c.WorksheetSetCellValuePermission,c.WorksheetInsertHyperlinkPermission]})||this._sheetPermissionInterceptorBaseController.haveNotPermissionHandle(this._localeService.t("permission.dialog.hyperLinkErr")))}))}},"SheetsHyperLinkPermissionController"),ts);th=tu([tc(0,(0,o.Inject)(o.LocaleService)),tc(1,o.ICommandService),tc(2,(0,o.Inject)(l.SheetPermissionInterceptorBaseController))],th);var tm,tp=Object.defineProperty,tg=Object.getOwnPropertyDescriptor,tf=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tg(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tp(t,r,a),a},"__decorateClass$7"),tv=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let t_=(O(tm=class extends o.Disposable{constructor(e,t,r,n,i,a,o,s,l,d){super(),this._hoverManagerService=e,this._sheetsHyperLinkPopupService=t,this._renderManagerService=r,this._permissionService=n,this._sheetPermissionInterceptorBaseController=i,this._commandService=a,this._editorBridgeService=o,this._textSelectionManagerService=s,this._univerInstanceService=l,this._zenZoneService=d,this._initHoverListener(),this._initCommandListener(),this._initHoverEditingListener(),this._initTextSelectionListener(),this._initZenEditor()}_getLinkPermission(e){let{unitId:t,subUnitId:r,row:n,col:i}=e,a=this._univerInstanceService.getUnit(t,o.UniverInstanceType.UNIVER_SHEET);return(null==a?void 0:a.getSheetBySheetId(r))?{viewPermission:this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[c.WorkbookViewPermission],worksheetTypes:[c.WorksheetViewPermission],rangeTypes:[c.RangeProtectionPermissionViewPoint]},[{startRow:n,startColumn:i,endRow:n,endColumn:i}]),editPermission:this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[c.WorkbookEditablePermission],worksheetTypes:[c.WorksheetEditPermission,c.WorksheetInsertHyperlinkPermission],rangeTypes:[c.RangeProtectionPermissionEditPoint]},[{startRow:n,startColumn:i,endRow:n,endColumn:i}]),copyPermission:this._permissionService.composePermission([new c.WorkbookCopyPermission(t).id,new c.WorksheetCopyPermission(t,r).id]).every(e=>e.value)}:{viewPermission:!1,editPermission:!1,copyPermission:!1}}_initHoverListener(){this.disposeWithMe(this._hoverManagerService.currentRichText$.pipe((0,f.debounceTime)(200)).subscribe(e=>{var t;if(!e){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}let{unitId:r,subUnitId:n,row:i,col:a}=e,s=this._renderManagerService.getRenderById(r);if(!s)return;if(!s.with(l.HoverRenderController).active){this._sheetsHyperLinkPopupService.hideCurrentPopup(Q.VIEWING);return}let d=null==(t=null==s?void 0:s.with(l.SheetSkeletonManagerService).getWorksheetSkeleton(n))?void 0:t.skeleton,u=i,c=a;d&&d.overflowCache.forValue((e,t,r)=>{(0,o.Rectangle).contains(r,{startColumn:a,endColumn:a,startRow:i,endRow:i})&&(u=e,c=t)});let{viewPermission:h,editPermission:m,copyPermission:p}=this._getLinkPermission(e);if(!h||!e.customRange){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}this._sheetsHyperLinkPopupService.showPopup({row:u,col:c,editPermission:m,copyPermission:p,customRange:e.customRange,customRangeRect:e.rect,type:Q.VIEWING,unitId:r,subUnitId:n})}))}_initHoverEditingListener(){let e=null;this.disposeWithMe(this._editorBridgeService.currentEditCellState$.pipe((0,w.switchMap)(e=>this._editorBridgeService.visible$.pipe((0,I.map)(t=>({visible:t,state:e}))))).subscribe(({visible:t,state:r})=>{if(!r||r.editorUnitId!==o.DOCS_NORMAL_EDITOR_UNIT_ID_KEY)return;if(!t.visible){null==e||e.unsubscribe(),this._sheetsHyperLinkPopupService.hideCurrentPopup(Q.EDITING),this._sheetsHyperLinkPopupService.endEditing(Q.EDITING);return}let{editorUnitId:n,unitId:i,sheetId:a,row:s,column:d}=r,u=this._renderManagerService.getRenderById(n);if(!u)return;let{editPermission:c,viewPermission:h,copyPermission:p}=this._getLinkPermission({unitId:i,subUnitId:a,row:s,col:d}),g=u.with(m.DocEventManagerService);h&&(null==e||e.unsubscribe(),e=g.hoverCustomRanges$.pipe((0,f.debounceTime)(200)).subscribe(e=>{var t,r;let n=e.find(e=>e.range.rangeType===o.CustomRangeType.HYPERLINK);if(!n){this._sheetsHyperLinkPopupService.hideCurrentPopup();return}let h=n.rects[n.rects.length-1];if(!(null==(r=null==(t=this._renderManagerService.getRenderById(i))?void 0:t.with(l.SheetSkeletonManagerService).getWorksheetSkeleton(a))?void 0:r.skeleton)||!h)return;let m=u.engine.getCanvasElement().getBoundingClientRect();this._sheetsHyperLinkPopupService.showPopup({unitId:i,subUnitId:a,row:s,col:d,customRange:n.range,customRangeRect:{left:h.left+m.left,top:h.top+m.top,bottom:h.bottom+m.top,right:h.right+m.left},editPermission:c,copyPermission:p,type:Q.EDITING})}))})),this.disposeWithMe(()=>{null==e||e.unsubscribe()})}_initZenEditor(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e?(this._sheetsHyperLinkPopupService.hideCurrentPopup(Q.VIEWING),this._sheetsHyperLinkPopupService.hideCurrentPopup(Q.EDITING),this._sheetsHyperLinkPopupService.endEditing(Q.EDITING),this._sheetsHyperLinkPopupService.hideCurrentPopup(Q.VIEWING)):(this._sheetsHyperLinkPopupService.hideCurrentPopup(Q.ZEN_EDITOR),this._sheetsHyperLinkPopupService.endEditing(Q.ZEN_EDITOR))})),this.disposeWithMe(this._univerInstanceService.focused$.pipe((0,w.switchMap)(e=>{let t=e===o.DOCS_ZEN_EDITOR_UNIT_ID_KEY?this._renderManagerService.getRenderById(e):null;return t?t.with(m.DocEventManagerService).hoverCustomRanges$.pipe((0,f.debounceTime)(200)):new S.Observable(e=>{e.next(null)})})).subscribe(e=>{let t=null==e?void 0:e.find(e=>e.range.rangeType===o.CustomRangeType.HYPERLINK),r=this._editorBridgeService.getEditCellState();if(t&&r){let{unitId:e,sheetId:n,row:i,column:a}=r,{editPermission:o,viewPermission:s,copyPermission:l}=this._getLinkPermission({unitId:e,subUnitId:n,row:i,col:a});s&&this._sheetsHyperLinkPopupService.showPopup({type:Q.ZEN_EDITOR,unitId:e,subUnitId:n,row:i,col:a,customRange:t.range,editPermission:o,copyPermission:l})}else this._sheetsHyperLinkPopupService.hideCurrentPopup(Q.ZEN_EDITOR)}))}_initTextSelectionListener(){this.disposeWithMe(this._textSelectionManagerService.textSelection$.subscribe(e=>{e&&e.unitId===o.DOCS_NORMAL_EDITOR_UNIT_ID_KEY&&this._sheetsHyperLinkPopupService.endEditing(Q.EDITING)}))}_initCommandListener(){let e=[c.ClearSelectionContentCommand.id,c.ClearSelectionAllCommand.id,c.ClearSelectionFormatCommand.id];this.disposeWithMe(this._commandService.onCommandExecuted(t=>{e.includes(t.id)&&this._sheetsHyperLinkPopupService.hideCurrentPopup()}))}},"SheetsHyperLinkPopupController"),tm);t_=tf([tv(0,(0,o.Inject)(l.HoverManagerService)),tv(1,(0,o.Inject)(ez)),tv(2,(0,o.Inject)(p.IRenderManagerService)),tv(3,(0,o.Inject)(o.IPermissionService)),tv(4,(0,o.Inject)(l.SheetPermissionInterceptorBaseController)),tv(5,o.ICommandService),tv(6,l.IEditorBridgeService),tv(7,(0,o.Inject)(b.DocSelectionManagerService)),tv(8,o.IUniverInstanceService),tv(9,h.IZenZoneService)],t_);var tI,tS=Object.defineProperty,tC=Object.getOwnPropertyDescriptor,ty=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tC(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tS(t,r,a),a},"__decorateClass$6"),tw=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let tb=(tI=class extends o.Disposable{constructor(e,t,r){super(),this._sheetInterceptorService=e,this._univerInstanceService=t,this._hyperLinkModel=r,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */O(e=>{var t;if(e.id===c.RemoveSheetCommand.id){let r=e.params,n=r.unitId?this._univerInstanceService.getUnit(r.unitId):this._univerInstanceService.getCurrentUnitForType(o.UniverInstanceType.UNIVER_SHEET);if(!n)return{redos:[],undos:[]};let i=n.getUnitId(),a=r.subUnitId||(null==(t=n.getActiveSheet())?void 0:t.getSheetId());if(!a)return{redos:[],undos:[]};let l=this._hyperLinkModel.getSubUnit(i,a);return{redos:l.map(e=>({id:s.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:e.id}})),undos:l.map(e=>({id:s.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:e}}))}}return{redos:[],undos:[]}},"getMutations")}))}},O(tI,"SheetsHyperLinkRemoveSheetController"),tI);tb=ty([tw(0,(0,o.Inject)(c.SheetInterceptorService)),tw(1,o.IUniverInstanceService),tw(2,(0,o.Inject)(s.HyperLinkModel))],tb);var tR,tE=Object.defineProperty,tT=Object.getOwnPropertyDescriptor,tM=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tT(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tE(t,r,a),a},"__decorateClass$5"),tO=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let tD=(tR=class extends o.Disposable{constructor(e,t){super(),this._context=e,this._hyperLinkModel=t,this._initSkeletonChange()}_initSkeletonChange(){let e=/* @__PURE__ */O(()=>{var e;null==(e=this._context.mainComponent)||e.makeForceDirty()},"markSkeletonDirty");this.disposeWithMe(this._hyperLinkModel.linkUpdate$.pipe((0,f.debounceTime)(16)).subscribe(()=>{e()}))}},O(tR,"SheetsHyperLinkRenderController"),tR);tD=tM([tO(1,(0,o.Inject)(s.HyperLinkModel))],tD);let tU=(tk=class extends o.Disposable{constructor(e,t){super(),this._sheetInterceptorService=e,this._hyperLinkModel=t,this._initViewModelIntercept()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(c.INTERCEPTOR_POINT.CELL_CONTENT,{effect:o.InterceptorEffectEnum.Value,priority:100,handler:/* @__PURE__ */O((e,t,r)=>{let{row:n,col:i,unitId:a,subUnitId:o}=t,s=this._hyperLinkModel.getHyperLinkByLocation(a,o,n,i);return r(s?{...e,linkUrl:s.payload,linkId:s.id}:e)},"handler")}))}},O(tk,"SheetsHyperLinkRenderManagerController"),tk);tU=tM([tO(0,(0,o.Inject)(c.SheetInterceptorService)),tO(1,(0,o.Inject)(s.HyperLinkModel))],tU);var tk,tP,tN=Object.defineProperty,tx=Object.getOwnPropertyDescriptor,tA=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tx(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tN(t,r,a),a},"__decorateClass$4"),tL=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let tF=(tP=class extends o.Disposable{constructor(e,t,r){super(),D(this,"_refRangeMap",/* @__PURE__ */new Map),this._commandService=e,this._univerInstanceService=t,this._refRangeService=r,this._initWorkbookLoad(),this._initWorkbookUnload(),this._initSetRangesListener()}_enusreMap(e,t){let r=this._refRangeMap.get(e);r||(r=/* @__PURE__ */new Map,this._refRangeMap.set(e,r));let n=r.get(t);return n||(n=new o.ObjectMatrix,r.set(t,n)),n}_isLegalRangeUrl(e,t){var r,n,i;let a=this._univerInstanceService.getUnit(e,o.UniverInstanceType.UNIVER_SHEET);if(!a)return null;if(t&&t.startsWith("#")){let e=new URLSearchParams(t.slice(1)),l={gid:null!=(r=e.get("gid"))?r:"",range:null!=(n=e.get("range"))?n:"",rangeid:null!=(i=e.get("rangeid"))?i:""};if(l.range&&l.gid){let e=l.gid,t=a.getSheetBySheetId(e);if(!t)return null;let r=(0,u.deserializeRangeWithSheet)(l.range).range;if((0,o.isValidRange)(r,t)&&l.range!==s.ERROR_RANGE)return r}}return null}_registerRange(e,t,r,n,i){var a,l,d,c;let h=this._enusreMap(e,t);if(null!=(l=null==(a=i.body)?void 0:a.customRanges)&&l.some(t=>{var r;return t.rangeType===o.CustomRangeType.HYPERLINK&&this._isLegalRangeUrl(e,null==(r=t.properties)?void 0:r.url)})){let a=new o.DisposableCollection;null==(c=null==(d=i.body)?void 0:d.customRanges)||c.forEach(r=>{var n;if(r.rangeType===o.CustomRangeType.HYPERLINK){let i=null==(n=r.properties)?void 0:n.url,o=this._isLegalRangeUrl(e,i);o&&a.add(this._refRangeService.watchRange(e,t,o,(e,n)=>{r.properties.url=`#gid=${t}&range=${n?(0,u.serializeRange)(n):s.ERROR_RANGE}`}))}}),h.setValue(r,n,a)}}_initWorkbookLoad(){let e=/* @__PURE__ */O(e=>{let t=e.getUnitId();e.getSheets().forEach(e=>{let r=e.getSheetId(),n=this._enusreMap(t,r);e.getCellMatrix().forValue((e,i,a)=>{let o=n.getValue(e,i);o&&o.dispose(),a&&a.p&&this._registerRange(t,r,e,i,a.p)})})},"handleWorkbook");this._univerInstanceService.getAllUnitsForType(o.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this.disposeWithMe(this._univerInstanceService.unitAdded$.subscribe(t=>{t.type===o.UniverInstanceType.UNIVER_SHEET&&e(t)}))}_initWorkbookUnload(){this._univerInstanceService.unitDisposed$.subscribe(e=>{if(e.type===o.UniverInstanceType.UNIVER_SHEET){let t=e.getUnitId();e.getSheets().forEach(e=>{let r=e.getSheetId();this._enusreMap(t,r).forValue((e,t,r)=>{r&&r.dispose()})}),this._refRangeMap.delete(t)}})}_initSetRangesListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===c.SetRangeValuesMutation.id){let{unitId:t,subUnitId:r,cellValue:n}=e.params,i=this._enusreMap(t,r);n&&new(0,o.ObjectMatrix)(n).forValue((e,n,a)=>{let o=i.getValue(e,n);o&&o.dispose(),a&&a.p&&this._registerRange(t,r,e,n,a.p)})}}))}},O(tP,"SheetsHyperLinkRichTextRefRangeController"),tP);tF=tA([tL(0,o.ICommandService),tL(1,o.IUniverInstanceService),tL(2,(0,o.Inject)(c.RefRangeService))],tF);var tj,tV=Object.defineProperty,tH=Object.getOwnPropertyDescriptor,t$=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tH(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tV(t,r,a),a},"__decorateClass$3"),tB=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let tW=(tj=class extends o.Disposable{constructor(e,t,r,n,i,a){super(),this._sheetInterceptorService=e,this._hyperLinkModel=t,this._selectionManagerService=r,this._univerInstanceService=n,this._editorBridgeService=i,this._renderManagerService=a,this._initCommandInterceptor(),this._initAfterEditor()}_initCommandInterceptor(){this._initSetRangeValuesCommandInterceptor(),this._initClearSelectionCommandInterceptor()}_initSetRangeValuesCommandInterceptor(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */O(e=>{if(e.id===c.SetRangeValuesCommand.id){let t=e.params,{unitId:r,subUnitId:n}=t,i=[],a=[];return t.cellValue&&new(0,o.ObjectMatrix)(t.cellValue).forValue((e,t)=>{let o=this._hyperLinkModel.getHyperLinkByLocation(r,n,e,t);o&&(i.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:r,subUnitId:n,id:o.id}}),a.push({id:s.AddHyperLinkMutation.id,params:{unitId:r,subUnitId:n,link:o}}))}),{undos:a,redos:i}}return{redos:[],undos:[]}},"getMutations")}))}_initClearSelectionCommandInterceptor(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */O(e=>{if(e.id===c.ClearSelectionContentCommand.id||e.id===c.ClearSelectionAllCommand.id||e.id===c.ClearSelectionFormatCommand.id){let e=[],t=[],r=this._selectionManagerService.getCurrentLastSelection(),n=(0,c.getSheetCommandTarget)(this._univerInstanceService);if(r&&n){let{unitId:i,subUnitId:a}=n;(0,o.Range).foreach(r.range,(r,n)=>{let o=this._hyperLinkModel.getHyperLinkByLocation(i,a,r,n);o&&(e.push({id:s.RemoveHyperLinkMutation.id,params:{unitId:i,subUnitId:a,id:o.id}}),t.push({id:s.AddHyperLinkMutation.id,params:{unitId:i,subUnitId:a,link:o}}))})}return{redos:e,undos:t}}return{redos:[],undos:[]}},"getMutations")}))}_initAfterEditor(){this.disposeWithMe(this._editorBridgeService.interceptor.intercept(this._editorBridgeService.interceptor.getInterceptPoints().AFTER_CELL_EDIT,{handler:/* @__PURE__ */O((e,t,r)=>{if(!e||e.p)return r(e);if("string"==typeof e.v&&(0,o.Tools).isLegalUrl(e.v)&&" "!==e.v[e.v.length-1]){let{unitId:n,subUnitId:i}=t,a=this._renderManagerService.getRenderById(n),s=null==a?void 0:a.with(l.SheetSkeletonManagerService).getWorksheetSkeleton(i);if(!s)return r(e);let d=s.skeleton.getBlankCellDocumentModel(e);if(!d.documentModel)return r(e);let u=(0,o.BuildTextUtils).selection.replace({selection:{startOffset:0,endOffset:e.v.length,collapsed:!1},body:{dataStream:`${o.DataStreamTreeTokenType.CUSTOM_RANGE_START}${e.v}${o.DataStreamTreeTokenType.CUSTOM_RANGE_END}`,customRanges:[{startIndex:0,endIndex:e.v.length+1,rangeId:(0,o.generateRandomId)(),rangeType:o.CustomRangeType.HYPERLINK,properties:{url:e.v}}]},doc:d.documentModel});if(!u)return r(e);let c=d.documentModel.getBody();return(0,o.TextX).apply(c,u.serialize()),r({...e,p:{id:o.DOCS_NORMAL_EDITOR_UNIT_ID_KEY,body:c,documentStyle:{pageSize:{width:1/0,height:1/0}}}})}return r(e)},"handler")}))}},O(tj,"SheetHyperLinkSetRangeController"),tj);tW=t$([tB(0,(0,o.Inject)(c.SheetInterceptorService)),tB(1,(0,o.Inject)(s.HyperLinkModel)),tB(2,(0,o.Inject)(c.SheetsSelectionsService)),tB(3,o.IUniverInstanceService),tB(4,l.IEditorBridgeService),tB(5,p.IRenderManagerService)],tW);let tG={[h.RibbonStartGroup.OTHERS]:{[eJ.id]:{order:2,menuItemFactory:e5},[e2(eJ.id)]:{order:2,menuItemFactory:e8}},[h.ContextMenuPosition.MAIN_AREA]:{[h.ContextMenuGroup.OTHERS]:{order:1,[eJ.id]:{order:0,menuItemFactory:e4},[e2(eJ.id)]:{order:0,menuItemFactory:e6}}}};var tz,tY=Object.defineProperty,tK=Object.getOwnPropertyDescriptor,tq=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tK(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tY(t,r,a),a},"__decorateClass$2"),tX=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let tQ=(O(tz=class extends o.Disposable{constructor(e,t,r,n,i){super(),this._componentManager=e,this._commandService=t,this._menuManagerService=r,this._injector=n,this._shortcutService=i,this._initComponents(),this._initCommands(),this._initMenus(),this._initShortCut()}_initComponents(){[[eV,eV.componentKey],[ep,ep.componentKey],[eT,"LinkSingle"]].forEach(([e,t])=>{this._componentManager.register(t,e)})}_initCommands(){[eX,eQ,eZ,eJ,el,eu,eA,ec,eL,ed].forEach(e=>{this._commandService.registerCommand(e)})}_initMenus(){this._menuManagerService.mergeMenu(tG)}_initShortCut(){this._shortcutService.registerShortcut(e7)}},"SheetsHyperLinkUIController"),tz);tQ=tq([tX(0,(0,o.Inject)(h.ComponentManager)),tX(1,o.ICommandService),tX(2,h.IMenuManagerService),tX(3,(0,o.Inject)(o.Injector)),tX(4,(0,o.Inject)(h.IShortcutService))],tQ);var tZ,tJ=Object.defineProperty,t1=Object.getOwnPropertyDescriptor,t0=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?t1(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tJ(t,r,a),a},"__decorateClass$1"),t3=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let t2=(O(tZ=class extends o.Disposable{constructor(e){super(),this._resolverService=e,this._handleInitUrl()}_handleInitUrl(){let e=location.hash;e&&this._resolverService.parseHyperLink(e).handler()}},"SheetHyperLinkUrlController"),tZ);t2=t0([t3(0,(0,o.Inject)($))],t2);var t4,t6=Object.defineProperty,t9=Object.getOwnPropertyDescriptor,t5=/* @__PURE__ */O((e,t,r)=>t in e?t6(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),t8=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?t9(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&t6(t,r,a),a},"__decorateClass"),t7=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),re=/* @__PURE__ */O((e,t,r)=>t5(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let rt=(O(t4=class extends o.Plugin{constructor(e=A,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{menu:n,...i}=this._config;n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig(x,i)}onStarting(){[[$],[ez],[eh],[tb],[tU],[tW],[t_],[tQ],[to],[X],[th],[t2],[tF]].forEach(e=>this._injector.add(e)),this._injector.get(tU),this._injector.get(tF),this._injector.get(tW)}onReady(){this._injector.get(p.IRenderManagerService).registerRenderModule(o.UniverInstanceType.UNIVER_SHEET,[tD]),this._injector.get(to),this._injector.get(X),this._injector.get(tb),this._injector.get(tQ)}onRendered(){this._injector.get(th),this._injector.get(t2),this._injector.get(t_)}},"UniverSheetsHyperLinkUIPlugin"),t4);re(rt,"pluginName",B),re(rt,"type",o.UniverInstanceType.UNIVER_SHEET),t8([(0,o.DependentOn)(s.UniverSheetsHyperLinkPlugin,m.UniverDocsUIPlugin),t7(1,(0,o.Inject)(o.Injector)),t7(2,o.IConfigService)],rt)}),i("3Iaza",function(t,r){let i,a;e(t.exports,"HyperLinkModel",function(){return I}),e(t.exports,"SheetHyperLinkType",function(){return S}),e(t.exports,"AddHyperLinkMutation",function(){return y}),e(t.exports,"RemoveHyperLinkMutation",function(){return w}),e(t.exports,"ERROR_RANGE",function(){return T}),e(t.exports,"UniverSheetsHyperLinkPlugin",function(){return ee});var o,s=n("7yNYd"),l=n("1mjSk"),d=n("ejawP"),u=n("86b1c"),c=Object.defineProperty,h=(e,t,r)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,m=(e,t)=>c(e,"name",{value:t,configurable:!0}),p=(e,t,r)=>h(e,"symbol"!=typeof t?t+"":t,r),g=Object.defineProperty,f=Object.getOwnPropertyDescriptor,v=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?f(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&g(t,r,a),a},"__decorateClass$4"),_=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let I=(o=class extends s.Disposable{constructor(e){super(),p(this,"_linkUpdate$",new l.Subject),p(this,"linkUpdate$",this._linkUpdate$.asObservable()),p(this,"_linkMap",/* @__PURE__ */new Map),p(this,"_linkPositionMap",/* @__PURE__ */new Map),this._univerInstanceService=e,this.disposeWithMe({dispose:/* @__PURE__ */m(()=>{this._linkUpdate$.complete()},"dispose")})}_ensureMap(e,t){let r=this._linkMap.get(e);r||(r=/* @__PURE__ */new Map,this._linkMap.set(e,r));let n=r.get(t);n||(n=new s.ObjectMatrix,r.set(t,n));let i=this._linkPositionMap.get(e);i||(i=/* @__PURE__ */new Map,this._linkPositionMap.set(e,i));let a=i.get(t);return a||(a=/* @__PURE__ */new Map,i.set(t,a)),{matrix:n,positionMap:a}}addHyperLink(e,t,r){let{matrix:n,positionMap:i}=this._ensureMap(e,t);return n.setValue(r.row,r.column,r),i.set(r.id,{row:r.row,column:r.column,link:r}),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:r,type:"add"}),!0}updateHyperLink(e,t,r,n,i=!1){let{matrix:a,positionMap:o}=this._ensureMap(e,t),s=o.get(r);if(!s)return!0;let l=a.getValue(s.row,s.column);return l&&(Object.assign(l,n),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:{display:l.display,payload:l.payload},id:r,type:"update",silent:i})),!0}updateHyperLinkRef(e,t,r,n,i=!1){let{matrix:a,positionMap:o}=this._ensureMap(e,t),s=o.get(r);if(!s)return!0;let l=a.getValue(s.row,s.column);return l&&l.id===r?a.realDeleteValue(s.row,s.column):l=s.link,Object.assign(l,n),o.set(r,{...n,link:l}),a.setValue(n.row,n.column,l),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:n,id:r,type:"updateRef",silent:i}),!0}removeHyperLink(e,t,r){let{matrix:n,positionMap:i}=this._ensureMap(e,t),a=i.get(r);if(!a)return!1;i.delete(r);let o=n.getValue(a.row,a.column);return o&&o.id===r&&n.realDeleteValue(a.row,a.column),this._linkUpdate$.next({unitId:e,subUnitId:t,payload:a.link,type:"remove"}),!0}getHyperLink(e,t,r){let{matrix:n,positionMap:i}=this._ensureMap(e,t),a=i.get(r);if(a)return n.getValue(a.row,a.column)}getHyperLinkByLocation(e,t,r,n){let{matrix:i}=this._ensureMap(e,t);return i.getValue(r,n)}getHyperLinkByLocationSync(e,t,r,n){var i,a,o,l,d;let{matrix:u}=this._ensureMap(e,t),c=this._univerInstanceService.getUnit(e,s.UniverInstanceType.UNIVER_SHEET),h=null==(i=null==c?void 0:c.getSheetBySheetId(t))?void 0:i.getCellRaw(r,n),m=(null!=(d=null!=(l=null==h?void 0:h.v)?l:null==(o=null==(a=null==h?void 0:h.p)?void 0:a.body)?void 0:o.dataStream.slice(0,-2))?d:"").toString(),p=u.getValue(r,n);if(p)return{...p,display:m}}getSubUnit(e,t){let{matrix:r}=this._ensureMap(e,t),n=[];return r.forValue((e,t,r)=>{r&&n.push(r)}),n}getUnit(e){let t=this._linkMap.get(e);return t?Array.from(t.keys()).map(t=>{let r=this.getSubUnit(e,t);return{unitId:e,subUnitId:t,links:r}}):[]}deleteUnit(e){let t=this.getUnit(e);this._linkMap.delete(e),this._linkPositionMap.delete(e),this._linkUpdate$.next({type:"unload",unitId:e,unitLinks:t})}getAll(){return Array.from(this._linkMap.keys()).map(e=>this.getUnit(e))}},m(o,"HyperLinkModel"),o);I=v([_(0,s.IUniverInstanceService)],I);var S=((i=S||{}).SHEET="gid",i.RANGE="range",i.DEFINE_NAME="rangeid",i.INVALID="invalid",i.URL="url",i);let C={},y={type:s.CommandType.MUTATION,id:"sheets.mutation.add-hyper-link",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,link:a}=t;return r.addHyperLink(n,i,a)}},w={type:s.CommandType.MUTATION,id:"sheets.mutation.remove-hyper-link",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,id:a}=t;return r.removeHyperLink(n,i,a)}},b={type:s.CommandType.MUTATION,id:"sheets.mutation.update-hyper-link",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,payload:a,id:o}=t;return r.updateHyperLink(n,i,o,a,!1)}},R={type:s.CommandType.MUTATION,id:"sheets.mutation.update-hyper-link-ref",handler(e,t){if(!t)return!1;let r=e.get(I),{unitId:n,subUnitId:i,id:a,row:o,column:s,silent:l}=t;return r.updateHyperLinkRef(n,i,a,{row:o,column:s},l)}},E="SHEET_HYPER_LINK_PLUGIN",T="err";var M,O=Object.defineProperty,D=Object.getOwnPropertyDescriptor,U=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?D(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&O(t,r,a),a},"__decorateClass$3"),k=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let P=(M=class extends s.Disposable{constructor(e,t,r,n){super(),p(this,"_disposableMap",/* @__PURE__ */new Map),p(this,"_watchDisposableMap",/* @__PURE__ */new Map),p(this,"_rangeDisableMap",/* @__PURE__ */new Map),p(this,"_rangeWatcherMap",/* @__PURE__ */new Map),p(this,"_handlePositionChange",/* @__PURE__ */m((e,t,r,n,i)=>{let a={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};return n?{redos:[{id:R.id,params:{unitId:e,subUnitId:t,id:r.id,row:n.startRow,column:n.startColumn,silent:i}}],undos:[{id:R.id,params:{unitId:e,subUnitId:t,id:r.id,row:a.startRow,column:a.startColumn,silent:i}}]}:{redos:[{id:w.id,params:{unitId:e,subUnitId:t,id:r.id}}],undos:[{id:y.id,params:{unitId:e,subUnitId:t,link:r}}]}},"_handlePositionChange")),this._refRangeService=e,this._hyperLinkModel=t,this._selectionManagerService=r,this._commandService=n,this._initData(),this._initRefRange()}_registerPosition(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row},a=/* @__PURE__ */m(n=>{let a=(0,d.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests)(i,n,{selectionManagerService:this._selectionManagerService}),o=Array.isArray(a)?a[0]:a;return o&&o.startColumn===i.startColumn&&o.startRow===i.startRow?{undos:[],redos:[]}:this._handlePositionChange(e,t,r,o,!1)},"handleRefRangeChange");this._disposableMap.set(n,this._refRangeService.registerRefRange(i,a,e,t))}_watchPosition(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._watchDisposableMap.set(n,this._refRangeService.watchRange(e,t,i,(n,i)=>{let{redos:a}=this._handlePositionChange(e,t,r,i,!0);(0,s.sequenceExecuteAsync)(a,this._commandService,{onlyLocal:!0})},!0))}_unregisterPosition(e){let t=this._disposableMap.get(e);null==t||t.dispose(),this._disposableMap.delete(e)}_unwatchPosition(e){let t=this._watchDisposableMap.get(e);null==t||t.dispose(),this._watchDisposableMap.delete(e)}_registerRange(e,t,r,n=!1){var i,a,o;if(r.startsWith("#")){let l=new URLSearchParams(r.slice(1)),c={gid:null!=(i=l.get("gid"))?i:"",range:null!=(a=l.get("range"))?a:"",rangeid:null!=(o=l.get("rangeid"))?o:""};if(c.range&&c.gid){let i=c.gid,a=(0,u.deserializeRangeWithSheet)(c.range).range;if((0,s.isValidRange)(a)&&c.range!==T){let o=/* @__PURE__ */m(n=>{let o=(0,d.handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests)(a,n,{selectionManagerService:this._selectionManagerService});return o&&(0,u.serializeRange)(o)===(0,u.serializeRange)(a)?{redos:[],undos:[]}:{redos:[{id:b.id,params:{unitId:e,subUnitId:i,id:t,payload:{payload:`#gid=${i}&range=${o?(0,u.serializeRange)(o):"err"}`}}}],undos:[{id:b.id,params:{unitId:e,subUnitId:i,id:t,payload:{payload:r}}}]}},"handleRangeChange");this._rangeDisableMap.set(t,this._refRangeService.registerRefRange(a,o,e,i)),n||this._rangeWatcherMap.set(t,this._refRangeService.watchRange(e,i,a,(r,n)=>{this._hyperLinkModel.updateHyperLink(e,i,t,{payload:`#gid=${i}&range=${n?(0,u.serializeRange)(n):"err"}`},!0)},!0))}}}}_unregisterRange(e){let t=this._rangeDisableMap.get(e);null==t||t.dispose(),this._rangeDisableMap.delete(e)}_unwatchRange(e){let t=this._rangeWatcherMap.get(e);null==t||t.dispose(),this._rangeWatcherMap.delete(e)}_initData(){this._hyperLinkModel.getAll().forEach(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,links:n}=e;n.forEach(e=>{this._registerPosition(t,r,e),this._watchPosition(t,r,e),this._registerRange(t,e.id,e.payload)})})})}_initRefRange(){this.disposeWithMe(this._hyperLinkModel.linkUpdate$.subscribe(e=>{switch(e.type){case"add":this._registerPosition(e.unitId,e.subUnitId,e.payload),this._watchPosition(e.unitId,e.subUnitId,e.payload),this._registerRange(e.unitId,e.payload.id,e.payload.payload);break;case"remove":this._unregisterPosition(e.payload.id),this._unwatchPosition(e.payload.id),this._unregisterRange(e.payload.id),this._unwatchRange(e.payload.id);break;case"updateRef":{let{unitId:t,subUnitId:r,id:n,silent:i}=e,a=this._hyperLinkModel.getHyperLink(t,r,n);if(!a)return;this._unregisterPosition(n),this._registerPosition(t,r,a),i||(this._unwatchPosition(n),this._watchPosition(t,r,a));break}case"unload":{let{unitLinks:t}=e;t.forEach(e=>{let{links:t}=e;t.forEach(e=>{this._unregisterPosition(e.id),this._unwatchPosition(e.id),this._unregisterRange(e.id),this._unwatchRange(e.id)})});break}case"update":e.silent||this._unwatchRange(e.id),this._unregisterRange(e.id),this._registerRange(e.unitId,e.id,e.payload.payload,e.silent)}})),this.disposeWithMe((0,s.toDisposable)(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}},m(M,"SheetsHyperLinkRefRangeController"),M);P=U([k(0,(0,s.Inject)(d.RefRangeService)),k(1,(0,s.Inject)(I)),k(2,(0,s.Inject)(d.SheetsSelectionsService)),k(3,s.ICommandService)],P);var N,x=Object.defineProperty,A=Object.getOwnPropertyDescriptor,L=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?A(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&x(t,r,a),a},"__decorateClass$2"),F=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let j=(m(N=class extends s.Disposable{constructor(e){super(),this._commandService=e,this._registerCommands()}_registerCommands(){[y,b,w,R].forEach(e=>{this._commandService.registerCommand(e)})}},"SheetsHyperLinkController"),N);j=L([F(0,s.ICommandService)],j);var V,H=((a=H||{})[a.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",a[a.UNIVER_DOC=1]="UNIVER_DOC",a[a.UNIVER_SHEET=2]="UNIVER_SHEET",a[a.UNIVER_SLIDE=3]="UNIVER_SLIDE",a[a.UNIVER_PROJECT=4]="UNIVER_PROJECT",a[a.UNRECOGNIZED=-1]="UNRECOGNIZED",a),$=Object.defineProperty,B=Object.getOwnPropertyDescriptor,W=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?B(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&$(t,r,a),a},"__decorateClass$1"),G=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let z=(V=class extends s.Disposable{constructor(e,t){super(),this._resourceManagerService=e,this._hyperLinkModel=t,this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */m(e=>{let t=this._hyperLinkModel.getUnit(e),r={};return t?(t.forEach(e=>{r[e.subUnitId]=e.links.map(({display:e,...t})=>t)}),JSON.stringify(r)):""},"toJson"),t=/* @__PURE__ */m(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:E,businesses:[H.UNIVER_SHEET],toJson:/* @__PURE__ */m(t=>e(t),"toJson"),parseJson:/* @__PURE__ */m(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */m(e=>{this._hyperLinkModel.deleteUnit(e)},"onUnLoad"),onLoad:/* @__PURE__ */m(async(e,t)=>{Object.keys(t).forEach(r=>{t[r].forEach(t=>{this._hyperLinkModel.addHyperLink(e,r,t)})})},"onLoad")}))}},m(V,"SheetsHyperLinkResourceController"),V);z=W([G(0,s.IResourceManagerService),G(1,(0,s.Inject)(I))],z);var Y,K=Object.defineProperty,q=Object.getOwnPropertyDescriptor,X=/* @__PURE__ */m((e,t,r)=>t in e?K(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),Q=/* @__PURE__ */m((e,t,r,n)=>{for(var i,a=n>1?void 0:n?q(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&K(t,r,a),a},"__decorateClass"),Z=/* @__PURE__ */m((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),J=/* @__PURE__ */m((e,t,r)=>X(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let ee=(m(Y=class extends s.Plugin{constructor(e=C,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("sheets-hyper-link.config",n)}onStarting(){[[z],[j],[P],[I]].forEach(e=>{this._injector.add(e)}),this._injector.get(P),this._injector.get(z),this._injector.get(j)}},"UniverSheetsHyperLinkPlugin"),Y);J(ee,"pluginName",E),J(ee,"type",s.UniverInstanceType.UNIVER_SHEET),ee=Q([(0,s.DependentOn)(d.UniverSheetsPlugin),Z(1,(0,s.Inject)(s.Injector)),Z(2,s.IConfigService)],ee)}),i("25IRk",function(r,i){e(r.exports,"AddCommentCommand",function(){return n("9zRwE").AddCommentCommand}),e(r.exports,"DeleteCommentTreeCommand",function(){return n("9zRwE").DeleteCommentTreeCommand}),e(r.exports,"SheetsThreadCommentModel",function(){return n("eqDU2").SheetsThreadCommentModel});var a=n("7yNYd"),o=n("ejawP"),s=n("eqDU2"),l=n("1Dbxg"),d=n("4XALk"),u=n("fL2Ug"),c=n("5LPkb"),h=n("bXJOC"),m=n("hciHF"),p=n("3e0Iz"),g=n("5gqvu"),f=n("86b1c"),v=n("9zRwE"),_=Object.defineProperty,I=(e,t,r)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,S=(e,t)=>_(e,"name",{value:t,configurable:!0}),C=(e,t,r)=>I(e,"symbol"!=typeof t?t+"":t,r);let y="univer.sheet.thread-comment-modal",w="comment-single",b="SHEET_THREAD_COMMENT";var R,E=Object.defineProperty,T=Object.getOwnPropertyDescriptor,M=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?T(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&E(t,r,a),a},"__decorateClass$7"),O=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let D=(R=class extends a.Disposable{constructor(e,t){super(),C(this,"_lastPopup",null),C(this,"_activePopup"),C(this,"_activePopup$",new c.BehaviorSubject(null)),C(this,"activePopup$",this._activePopup$.asObservable()),this._canvasPopupManagerService=e,this._zenZoneService=t,this._initZenVisible(),this.disposeWithMe(()=>{this._activePopup$.complete()})}get activePopup(){return this._activePopup}_initZenVisible(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&this.hidePopup()}))}showPopup(e,t){var r;let{row:n,col:i,unitId:o,subUnitId:s}=e;if(this._activePopup&&n===this._activePopup.row&&i===this._activePopup.col&&o===this._activePopup.unitId&&s===(null==(r=this.activePopup)?void 0:r.subUnitId)){this._activePopup=e,this._activePopup$.next(e);return}if(this._lastPopup&&this._lastPopup.dispose(),this._zenZoneService.visible)return;this._activePopup=e,this._activePopup$.next(e);let l=this._canvasPopupManagerService.attachPopupToCell(n,i,{componentKey:y,onClickOutside:/* @__PURE__ */S(()=>{this.hidePopup()},"onClickOutside"),direction:"horizontal",excludeOutside:[...Array.from(document.querySelectorAll(".univer-thread-comment")),document.getElementById("thread-comment-add")].filter(Boolean)});if(!l)throw Error("[SheetsThreadCommentPopupService]: cannot show popup!");let d=new a.DisposableCollection;d.add(l),d.add({dispose:/* @__PURE__ */S(()=>{null==t||t()},"dispose")}),this._lastPopup=d}hidePopup(){this._activePopup&&(this._lastPopup&&this._lastPopup.dispose(),this._lastPopup=null,this._activePopup=null,this._activePopup$.next(null))}persistPopup(){this._activePopup&&this._activePopup.temp&&(this._activePopup={...this._activePopup,temp:!1},this._activePopup$.next(this._activePopup))}},S(R,"SheetsThreadCommentPopupService"),R);D=M([O(0,(0,a.Inject)(d.SheetCanvasPopManagerService)),O(1,u.IZenZoneService)],D);let U={type:a.CommandType.OPERATION,id:"sheets.operation.show-comment-modal",handler(e){var t;let r=e.get(o.SheetsSelectionsService),n=e.get(a.IUniverInstanceService),i=e.get(D),d=e.get(l.ThreadCommentPanelService),u=null==(t=r.getCurrentLastSelection())?void 0:t.primary,c=e.get(s.SheetsThreadCommentModel);if(!u)return!1;let h=(0,o.getSheetCommandTarget)(n);if(!h)return!1;let{workbook:m,worksheet:p,unitId:g,subUnitId:f}=h,v={workbook:m,worksheet:p,unitId:g,subUnitId:f,row:u.startRow,col:u.startColumn};i.showPopup(v);let _=c.getByLocation(g,f,u.startRow,u.startColumn);return _&&d.setActiveComment({unitId:g,subUnitId:f,commentId:_,trigger:"context-menu"}),!0}},k={};var P,N=Object.defineProperty,x=Object.getOwnPropertyDescriptor,A=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?x(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&N(t,r,a),a},"__decorateClass$6"),L=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let F=(P=class extends a.Disposable{constructor(e,t,r,n){super(),this._sheetInterceptorService=e,this._sheetsThreadCommentModel=t,this._univerInstanceService=r,this._renderManagerService=n,this._initViewModelIntercept(),this._initSkeletonChange()}_initViewModelIntercept(){this.disposeWithMe(this._sheetInterceptorService.intercept(o.INTERCEPTOR_POINT.CELL_CONTENT,{effect:a.InterceptorEffectEnum.Style,handler:/* @__PURE__ */S((e,t,r)=>{let{row:n,col:i,unitId:a,subUnitId:o}=t;return r(this._sheetsThreadCommentModel.showCommentMarker(a,o,n,i)?{...e,markers:{...null==e?void 0:e.markers,tr:{color:"#FFBD37",size:6}}}:e)},"handler"),priority:100}))}_initSkeletonChange(){let e=/* @__PURE__ */S(()=>{var e;let t=this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET);if(!t)return;let r=t.getUnitId(),n=this._renderManagerService.getRenderById(r);null==(e=null==n?void 0:n.mainComponent)||e.makeForceDirty()},"markSkeletonDirty");this.disposeWithMe(this._sheetsThreadCommentModel.commentUpdate$.pipe((0,h.debounceTime)(16)).subscribe(()=>{e()}))}},S(P,"SheetsThreadCommentRenderController"),P);F=A([L(0,(0,a.Inject)(o.SheetInterceptorService)),L(1,(0,a.Inject)(s.SheetsThreadCommentModel)),L(2,a.IUniverInstanceService),L(3,p.IRenderManagerService)],F);var j=function(){return(j=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},V=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},H=(0,g.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=V(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,g.useRef)("_".concat(G()));return $(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},j({ref:t,className:s},o),a)});function $(e,t,r,n,i){return(0,g.createElement)(e.tag,j(j({key:t},B(e,r,i)),n),(W(e,r).children||[]).map(function(n,a){return $(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function B(e,t,r){var n=j({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function W(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?j(j({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?j(j({},e),{attrs:j(j({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function G(){return Math.random().toString(36).substring(2,8)}S($,"render"),S(B,"replaceRuntimeIdsAndExtInAttrs"),S(W,"replaceRuntimeIdsInDefs"),S(G,"generateShortUuid"),H.displayName="UniverIcon";var z={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521C5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345ZM8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521C8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345ZM11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521C11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.83725 6.78345C6.22188 6.78345 6.53368 7.10742 6.53368 7.50706V8.41159C6.53368 8.81123 6.22188 9.13521 5.83725 9.13521 5.45263 9.13521 5.14082 8.81123 5.14082 8.41159V7.50706C5.14082 7.10742 5.45263 6.78345 5.83725 6.78345zM8.73904 6.78345C9.12366 6.78345 9.43546 7.10742 9.43546 7.50706V8.41159C9.43546 8.81123 9.12366 9.13521 8.73904 9.13521 8.35441 9.13521 8.04261 8.81123 8.04261 8.41159V7.50706C8.04261 7.10742 8.35441 6.78345 8.73904 6.78345zM11.6408 6.78345C12.0254 6.78345 12.3372 7.10742 12.3372 7.50706V8.41159C12.3372 8.81123 12.0254 9.13521 11.6408 9.13521 11.2562 9.13521 10.9444 8.81123 10.9444 8.41159V7.50706C10.9444 7.10742 11.2562 6.78345 11.6408 6.78345z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.84351 3.41861C1.84351 3.01861 2.15531 2.69434 2.53993 2.69434H14.9381C15.3228 2.69434 15.6346 3.01861 15.6346 3.41861V12.4611C15.6346 12.8612 15.3228 13.1854 14.9381 13.1854H8.82117L6.06643 14.6179C5.85054 14.7301 5.59416 14.7181 5.38884 14.5862C5.18352 14.4542 5.05855 14.2211 5.05855 13.9701V13.1854H2.53993C2.15531 13.1854 1.84351 12.8612 1.84351 12.4611L1.84351 3.41861ZM6.45141 12.7982L8.34531 12.0135C8.44201 11.9632 8.54864 11.9371 8.65676 11.9371H14.2417C14.3522 11.9371 14.4417 11.8475 14.4417 11.7371V4.14271C14.4417 4.03225 14.3522 3.94271 14.2417 3.94271H3.23636C3.12591 3.94271 3.03636 4.03225 3.03636 4.14271L3.03636 11.7371C3.03636 11.8475 3.12591 11.9371 3.23636 11.9371L5.75498 11.9371C6.1396 11.9371 6.45141 12.0611 6.45141 12.4611V12.7982Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Y=(0,g.forwardRef)(function(e,t){return(0,g.createElement)(H,Object.assign({},e,{id:"comment-single",ref:t,icon:z}))});Y.displayName="CommentSingle";let K=/* @__PURE__ */S(()=>{let e=(0,a.useDependency)(a.IUniverInstanceService),r=(0,a.useDependency)(D),n=(0,u.useObservable)(r.activePopup$),i=(0,a.useDependency)(s.SheetsThreadCommentModel);if((0,u.useObservable)(i.commentUpdate$),!n)return null;let{row:o,col:d,unitId:c,subUnitId:h,trigger:m}=n,p=i.getByLocation(c,h,o,d),f=`${(0,a.Tools).chatAtABC(d)}${o+1}`,v=/* @__PURE__ */S(()=>{r.hidePopup()},"onClose"),_=/* @__PURE__ */S(t=>{var r,n,i;return null!=(i=null==(n=null==(r=e.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET))?void 0:r.getSheetBySheetId(t))?void 0:n.getName())?i:""},"getSubUnitName");return /* @__PURE__ *//*@__PURE__*/t(g).createElement(l.ThreadCommentTree,{onClick:/* @__PURE__ */S(()=>{r.persistPopup()},"onClick"),prefix:"cell",id:p,unitId:c,subUnitId:h,type:a.UniverInstanceType.UNIVER_SHEET,refStr:f,onClose:v,getSubUnitName:_,autoFocus:"context-menu"===m})},"SheetsThreadCommentCell"),q=/* @__PURE__ */S(()=>{var e;let r=(0,a.useDependency)(d.IMarkSelectionService),n=(0,a.useDependency)(a.IUniverInstanceService),i=(0,a.useDependency)(D),o=n.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET),s=o.getUnitId(),c=(0,a.useDependency)(a.ICommandService),h=(0,g.useMemo)(()=>o.activeSheet$.pipe((0,m.map)(e=>null==e?void 0:e.getSheetId())),[o.activeSheet$]),p=(0,u.useObservable)(h,null==(e=o.getActiveSheet())?void 0:e.getSheetId()),v=(0,g.useRef)(),_=(0,a.useDependency)(l.ThreadCommentPanelService),I=(0,u.useObservable)(_.activeCommentId$),C=(0,u.useObservable)(_.panelVisible$,_.panelVisible),y=(0,g.useCallback)(e=>{let t=o.getSheets(),r={};t.forEach((e,t)=>{r[e.getSheetId()]=t});let n=/* @__PURE__ */S(e=>e.map(e=>{var t;let n=(0,f.singleReferenceToGrid)(e.ref),i=[null!=(t=r[e.subUnitId])?t:0,n.row,n.column];return{...e,p:i}}).sort((e,t)=>e.p[0]===t.p[0]?e.p[1]===t.p[1]?e.p[2]-t.p[2]:e.p[1]-t.p[1]:e.p[0]-t.p[0]),"sort");return[...n(e.filter(e=>!e.resolved)),...n(e.filter(e=>e.resolved))]},[o]),w=(0,g.useCallback)(e=>{var t;if(e.unitId===s&&e.subUnitId===p&&!e.resolved){let{row:n,column:i}=(0,f.singleReferenceToGrid)(e.ref),a=o.getSheetBySheetId(e.subUnitId),s=null!=(t=null==a?void 0:a.getMergedCell(n,i))?t:{startColumn:i,endColumn:i,startRow:n,endRow:n};if(!Number.isNaN(n)&&!Number.isNaN(i))return r.addShape({range:s,style:{hasAutoFill:!1,fill:"rgb(255, 189, 55, 0.35)",strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null})}},[r,p,s]),b=/* @__PURE__ */S(e=>{var t,r;return null!=(r=null==(t=o.getSheetBySheetId(e))?void 0:t.getName())?r:""},"getSubUnitName"),R=/* @__PURE__ */S(()=>{c.executeCommand(U.id)},"handleAdd"),E=/* @__PURE__ */S(e=>{I&&I.unitId===e.unitId&&I.subUnitId===e.subUnitId&&I.commentId===e.id||(v.current&&(r.removeShape(v.current),v.current=null),v.current=w(e))},"handleHover"),T=/* @__PURE__ */S(()=>{v.current&&(r.removeShape(v.current),v.current=null)},"handleLeave"),M=/* @__PURE__ */S((e,t)=>{t&&i.hidePopup()},"handleResolve");return(0,g.useEffect)(()=>{!C&&v.current&&r.removeShape(v.current)},[r,C]),/* @__PURE__ *//*@__PURE__*/t(g).createElement(l.ThreadCommentPanel,{unitId:s,subUnitId$:h,type:a.UniverInstanceType.UNIVER_SHEET,onAdd:R,getSubUnitName:b,onResolve:M,sortComments:y,onItemEnter:E,onItemLeave:T,onDeleteComment:/* @__PURE__ */S(()=>(T(),!0),"onDeleteComment")})},"SheetsThreadCommentPanel"),X=/* @__PURE__ */S(e=>({id:U.id,type:u.MenuItemType.BUTTON,icon:w,title:"sheetThreadComment.menu.addComment",hidden$:(0,u.getMenuHiddenObservable)(e,a.UniverInstanceType.UNIVER_SHEET),disabled$:(0,d.getCurrentRangeDisable$)(e,{workbookTypes:[o.WorkbookCommentPermission],worksheetTypes:[o.WorksheetViewPermission],rangeTypes:[o.RangeProtectionPermissionViewPoint]})}),"threadCommentMenuFactory"),Q=/* @__PURE__ */S(e=>({id:l.ToggleSheetCommentPanelOperation.id,type:u.MenuItemType.BUTTON,icon:w,tooltip:"sheetThreadComment.menu.commentManagement",disabled$:(0,d.getCurrentRangeDisable$)(e,{workbookTypes:[o.WorkbookCommentPermission],worksheetTypes:[o.WorksheetViewPermission],rangeTypes:[o.RangeProtectionPermissionViewPoint]}),hidden$:(0,u.getMenuHiddenObservable)(e,a.UniverInstanceType.UNIVER_SHEET)}),"threadPanelMenuFactory"),Z={id:U.id,binding:u.KeyCode.M|u.MetaKeys.CTRL_COMMAND|u.MetaKeys.ALT,preconditions:d.whenSheetEditorFocused},J={[u.RibbonStartGroup.OTHERS]:{[l.ToggleSheetCommentPanelOperation.id]:{order:1,menuItemFactory:Q}},[u.ContextMenuPosition.MAIN_AREA]:{[u.ContextMenuGroup.OTHERS]:{[U.id]:{order:0,menuItemFactory:X}}}};var ee,et=Object.defineProperty,er=Object.getOwnPropertyDescriptor,en=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?er(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&et(t,r,a),a},"__decorateClass$5"),ei=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let ea=(S(ee=class extends a.Disposable{constructor(e,t,r){super(),this._menuManagerService=e,this._componentManager=t,this._shortcutService=r,this._initMenu(),this._initShortcut(),this._initComponent()}_initShortcut(){this._shortcutService.registerShortcut(Z)}_initMenu(){this._menuManagerService.mergeMenu(J)}_initComponent(){[[y,K],[(0,l.THREAD_COMMENT_PANEL),q],[w,Y]].forEach(([e,t])=>{this._componentManager.register(e,t)})}},"SheetsThreadCommentController"),ee);ea=en([ei(0,u.IMenuManagerService),ei(1,(0,a.Inject)(u.ComponentManager)),ei(2,u.IShortcutService)],ea);var eo=Object.defineProperty,es=Object.getOwnPropertyDescriptor,el=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?es(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eo(t,r,a),a},"__decorateClass$4"),ed=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let eu=/* @__PURE__ */S((e,t,r)=>{let n=(0,f.singleReferenceToGrid)(e),i=r.row-t.row,a=r.column-t.column,o={startColumn:n.column+a,startRow:n.row+i,endColumn:n.column+a,endRow:n.row+i};return(0,f.serializeRange)(o)},"transformRef"),ec=(eh=class extends a.Disposable{constructor(e,t,r){super(),C(this,"_copyInfo"),this._sheetClipboardService=e,this._sheetsThreadCommentModel=t,this._threadCommentDataSourceService=r,this._initClipboardHook()}_initClipboardHook(){this.disposeWithMe(this._sheetClipboardService.addClipboardHook({id:b,onBeforeCopy:/* @__PURE__ */S((e,t,r)=>{this._copyInfo={unitId:e,subUnitId:t,range:r}},"onBeforeCopy"),onPasteCells:/* @__PURE__ */S((e,t,r,n)=>{let{unitId:i,subUnitId:o,range:s}=t,l={row:s.rows[0],column:s.cols[0]};if(n.copyType===d.COPY_TYPE.CUT&&this._copyInfo){let{range:e,unitId:t,subUnitId:r}=this._copyInfo,n={row:e.startRow,column:e.startColumn};if(!(i===t&&o===r)){let s=[];(0,a.Range).foreach(e,(e,n)=>{let i=this._sheetsThreadCommentModel.getAllByLocation(t,r,e,n);this._threadCommentDataSourceService.syncUpdateMutationToColla?i.forEach(e=>{s.push(e)}):i.forEach(({children:e,...t})=>{t.parentId||s.push(t)})});let d=[],u=[],c=[],h=[],m=/* @__PURE__ */S(e=>{d.unshift({id:v.DeleteCommentMutation.id,params:{unitId:t,subUnitId:r,commentId:e.id}}),c.push({id:v.AddCommentMutation.id,params:{unitId:i,subUnitId:o,comment:{...e,ref:eu(e.ref,n,l),unitId:i,subUnitId:o},sync:!0}}),u.push({id:v.AddCommentMutation.id,params:{unitId:t,subUnitId:r,comment:e,sync:!0}}),h.unshift({id:v.DeleteCommentMutation.id,params:{unitId:i,subUnitId:o,commentId:e.id}})},"handleCommentItem");return s.forEach(e=>{m(e)}),{redos:[...d,...c],undos:[...h,...u]}}}return{redos:[],undos:[]}},"onPasteCells")}))}},S(eh,"SheetsThreadCommentCopyPasteController"),eh);ec=el([ed(0,(0,a.Inject)(d.ISheetClipboardService)),ed(1,(0,a.Inject)(s.SheetsThreadCommentModel)),ed(2,v.IThreadCommentDataSourceService)],ec);var eh,em,ep=Object.defineProperty,eg=Object.getOwnPropertyDescriptor,ef=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eg(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ep(t,r,a),a},"__decorateClass$3"),ev=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let e_=(S(em=class extends a.Disposable{constructor(e,t,r,n){super(),this._hoverManagerService=e,this._sheetsThreadCommentPopupService=t,this._sheetsThreadCommentModel=r,this._sheetPermissionInterceptorBaseController=n,this._initHoverEvent()}_initHoverEvent(){this.disposeWithMe(this._hoverManagerService.currentCell$.pipe((0,h.debounceTime)(100)).subscribe(e=>{let t=this._sheetsThreadCommentPopupService.activePopup;if(e&&(t&&t.temp||!t)){let{location:r}=e,{unitId:n,subUnitId:i,row:a,col:s}=r,l=this._sheetsThreadCommentModel.getByLocation(n,i,a,s);if(l){if(!this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[o.WorkbookCommentPermission],worksheetTypes:[o.WorksheetViewPermission],rangeTypes:[o.RangeProtectionPermissionViewPoint]},[{startRow:a,startColumn:s,endRow:a,endColumn:s}]))return;let e=this._sheetsThreadCommentModel.getComment(n,i,l);e&&!e.resolved&&this._sheetsThreadCommentPopupService.showPopup({unitId:n,subUnitId:i,row:a,col:s,commentId:l,temp:!0})}else t&&this._sheetsThreadCommentPopupService.hidePopup()}}))}},"SheetsThreadCommentHoverController"),em);e_=ef([ev(0,(0,a.Inject)(d.HoverManagerService)),ev(1,(0,a.Inject)(D)),ev(2,(0,a.Inject)(s.SheetsThreadCommentModel)),ev(3,(0,a.Inject)(d.SheetPermissionInterceptorBaseController))],e_);var eI,eS=Object.defineProperty,eC=Object.getOwnPropertyDescriptor,ey=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eC(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eS(t,r,a),a},"__decorateClass$2"),ew=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let eb=(S(eI=class extends a.Disposable{constructor(e,t,r,n,i,a,o,s,l,d){super(),C(this,"_isSwitchToCommenting",!1),C(this,"_selectionShapeInfo",null),this._commandService=e,this._sheetsThreadCommentPopupService=t,this._sheetsThreadCommentModel=r,this._threadCommentPanelService=n,this._univerInstanceService=i,this._sheetPermissionInterceptorBaseController=a,this._markSelectionService=o,this._sheetSelectionService=s,this._editorBridgeService=l,this._renderManagerService=d,this._initCommandListener(),this._initPanelListener(),this._initMarkSelection(),this._initSelectionUpdateListener(),this._initEditorBridge()}_handleSelectionChange(e,t,r){var n,i,o;let s=null==(n=e[0])?void 0:n.range,u=this._renderManagerService.getRenderById(t),c=null==(i=null==u?void 0:u.with(d.SheetSkeletonManagerService).getWorksheetSkeleton(r))?void 0:i.skeleton;if(!c||!s)return;let h=c.getCellByIndex(s.startRow,s.startColumn);if(((null!=(o=s.rangeType)?o:a.RANGE_TYPE.NORMAL)!==a.RANGE_TYPE.NORMAL||s.endColumn-s.startColumn>0||s.endRow-s.startRow>0)&&!((h.isMerged||h.isMergedMainCell)&&(0,a.Rectangle).equals(h.mergeInfo,s))){this._threadCommentPanelService.activeCommentId&&this._commandService.executeCommand(l.SetActiveCommentOperation.id);return}let m=h.actualRow,p=h.actualColumn;if(!this._sheetsThreadCommentModel.showCommentMarker(t,r,m,p)){this._threadCommentPanelService.activeCommentId&&this._commandService.executeCommand(l.SetActiveCommentOperation.id);return}let g=this._sheetsThreadCommentModel.getByLocation(t,r,m,p);g&&this._commandService.executeCommand(l.SetActiveCommentOperation.id,{unitId:t,subUnitId:r,commentId:g})}_initSelectionUpdateListener(){this.disposeWithMe(this._sheetSelectionService.selectionMoveEnd$.subscribe(e=>{if(this._isSwitchToCommenting)return;let t=this._sheetSelectionService.currentSelectionParam;t&&this._handleSelectionChange(e,t.unitId,t.sheetId)}))}_initEditorBridge(){this.disposeWithMe(this._editorBridgeService.visible$.subscribe(e=>{e.visible&&this._sheetsThreadCommentPopupService.hidePopup()}))}_initCommandListener(){this._commandService.onCommandExecuted(e=>{if(e.id===v.DeleteCommentMutation.id){let t=e.params,r=this._sheetsThreadCommentPopupService.activePopup;if(!r)return;let{unitId:n,subUnitId:i,commentId:a}=r;t.unitId===n&&t.subUnitId===i&&t.commentId===a&&this._sheetsThreadCommentPopupService.hidePopup()}})}_initPanelListener(){this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.subscribe(async e=>{var t;if(e){let{unitId:r,subUnitId:n,commentId:i,trigger:s}=e,l=this._sheetsThreadCommentModel.getComment(r,n,i);if(!l||l.resolved)return;let u=this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET);if(!u||u.getUnitId()!==r)return;this._isSwitchToCommenting=!0,(null==(t=u.getActiveSheet())?void 0:t.getSheetId())!==n&&await this._commandService.executeCommand(o.SetWorksheetActiveOperation.id,{unitId:r,subUnitId:n}),this._isSwitchToCommenting=!1;let c=(0,f.singleReferenceToGrid)(l.ref),{row:h,column:m}=c;if(!this._sheetPermissionInterceptorBaseController.permissionCheckWithRanges({workbookTypes:[o.WorkbookCommentPermission],worksheetTypes:[o.WorksheetViewPermission],rangeTypes:[o.RangeProtectionPermissionViewPoint]},[{startRow:h,startColumn:m,endRow:h,endColumn:m}])||(await this._commandService.executeCommand(d.ScrollToRangeOperation.id,{range:{startRow:Math.max(c.row-1,0),endRow:c.row+1,startColumn:Math.max(c.column-1,0),endColumn:c.column+1}}),this._editorBridgeService.isVisible().visible))return;this._sheetsThreadCommentPopupService.showPopup({unitId:r,subUnitId:n,row:c.row,col:c.column,commentId:l.id,trigger:s})}else this._sheetsThreadCommentPopupService.hidePopup()}))}_initMarkSelection(){this.disposeWithMe(this._threadCommentPanelService.activeCommentId$.pipe((0,h.debounceTime)(100)).subscribe(e=>{var t,r;if(!e){this._selectionShapeInfo&&(this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId),this._selectionShapeInfo=null);return}let{unitId:n,subUnitId:i,commentId:o}=e;this._selectionShapeInfo&&(this._markSelectionService.removeShape(this._selectionShapeInfo.shapeId),this._selectionShapeInfo=null);let s=this._sheetsThreadCommentModel.getComment(n,i,o);if(!s)return;let{row:l,column:d}=(0,f.singleReferenceToGrid)(s.ref);if(Number.isNaN(l)||Number.isNaN(d))return null;let u=null==(t=this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET))?void 0:t.getSheetBySheetId(i),c=null!=(r=null==u?void 0:u.getMergedCell(l,d))?r:{startColumn:d,endColumn:d,startRow:l,endRow:l},h=this._markSelectionService.addShape({range:c,style:{hasAutoFill:!1,fill:"rgb(255, 189, 55, 0.35)",strokeWidth:1,stroke:"#FFBD37",widgets:{}},primary:null},[],-1);h&&(this._selectionShapeInfo={...e,shapeId:h})}))}},"SheetsThreadCommentPopupController"),eI);eb=ey([ew(0,a.ICommandService),ew(1,(0,a.Inject)(D)),ew(2,(0,a.Inject)(s.SheetsThreadCommentModel)),ew(3,(0,a.Inject)(l.ThreadCommentPanelService)),ew(4,a.IUniverInstanceService),ew(5,(0,a.Inject)(d.SheetPermissionInterceptorBaseController)),ew(6,d.IMarkSelectionService),ew(7,(0,a.Inject)(o.SheetsSelectionsService)),ew(8,d.IEditorBridgeService),ew(9,p.IRenderManagerService)],eb);var eR,eE=Object.defineProperty,eT=Object.getOwnPropertyDescriptor,eM=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eT(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eE(t,r,a),a},"__decorateClass$1"),eO=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let eD=(eR=class extends a.Disposable{constructor(e,t,r,n){super(),this._sheetInterceptorService=e,this._univerInstanceService=t,this._threadCommentModel=r,this._threadCommentDataSourceService=n,this._initSheetChange()}_initSheetChange(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */S(e=>{var t;if(e.id===o.RemoveSheetCommand.id){let r=e.params,n=r.unitId?this._univerInstanceService.getUnit(r.unitId):this._univerInstanceService.getCurrentUnitForType(a.UniverInstanceType.UNIVER_SHEET);if(!n)return{redos:[],undos:[]};let i=n.getUnitId(),o=r.subUnitId||(null==(t=n.getActiveSheet())?void 0:t.getSheetId());if(!o)return{redos:[],undos:[]};let s=Array.from(this._threadCommentModel.ensureMap(i,o).values()).filter(e=>!e.parentId),l=s.map(e=>e.id),d=this._threadCommentDataSourceService.syncUpdateMutationToColla;return{redos:l.map(e=>({id:v.DeleteCommentMutation.id,params:{unitId:i,subUnitId:o,commentId:e}})),undos:s.map(({children:e,...t})=>({id:v.AddCommentMutation.id,params:{unitId:i,subUnitId:o,comment:{...t,children:d?e:void 0},sync:!d}}))}}return{redos:[],undos:[]}},"getMutations")}))}},S(eR,"ThreadCommentRemoveSheetsController"),eR);eD=eM([eO(0,(0,a.Inject)(o.SheetInterceptorService)),eO(1,a.IUniverInstanceService),eO(2,(0,a.Inject)(v.ThreadCommentModel)),eO(3,v.IThreadCommentDataSourceService)],eD);var eU,ek=Object.defineProperty,eP=Object.getOwnPropertyDescriptor,eN=/* @__PURE__ */S((e,t,r)=>t in e?ek(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),ex=/* @__PURE__ */S((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eP(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ek(t,r,a),a},"__decorateClass"),eA=/* @__PURE__ */S((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),eL=/* @__PURE__ */S((e,t,r)=>eN(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let eF=(S(eU=class extends a.Plugin{constructor(e=k,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig("sheets-thread-comment.config",a)}onStarting(){[[ea],[F],[ec],[e_],[eD],[eb],[D]].forEach(e=>{this._injector.add(e)}),[U].forEach(e=>{this._commandService.registerCommand(e)}),this._injector.get(ea)}onReady(){this._injector.get(F),this._injector.get(eD)}onRendered(){this._injector.get(ec),this._injector.get(e_),this._injector.get(eb)}},"UniverSheetsThreadCommentPlugin"),eU);eL(eF,"pluginName",b),eL(eF,"type",a.UniverInstanceType.UNIVER_SHEET),ex([(0,a.DependentOn)(l.UniverThreadCommentUIPlugin,s.UniverSheetsThreadCommentBasePlugin),eA(1,(0,a.Inject)(a.Injector)),eA(2,(0,a.Inject)(a.ICommandService)),eA(3,a.IConfigService)],eF)}),i("eqDU2",function(t,r){e(t.exports,"SheetsThreadCommentModel",function(){return _}),e(t.exports,"UniverSheetsThreadCommentBasePlugin",function(){return k});var i,a=n("7yNYd"),o=n("86b1c"),s=n("ejawP"),l=n("9zRwE"),d=n("1mjSk"),u=Object.defineProperty,c=(e,t,r)=>t in e?u(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,h=(e,t)=>u(e,"name",{value:t,configurable:!0}),m=(e,t,r)=>c(e,"symbol"!=typeof t?t+"":t,r),p=Object.defineProperty,g=Object.getOwnPropertyDescriptor,f=/* @__PURE__ */h((e,t,r,n)=>{for(var i,a=n>1?void 0:n?g(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&p(t,r,a),a},"__decorateClass$2"),v=/* @__PURE__ */h((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let _=(h(i=class extends a.Disposable{constructor(e,t){super(),m(this,"_matrixMap",/* @__PURE__ */new Map),m(this,"_locationMap",/* @__PURE__ */new Map),m(this,"_commentUpdate$",new d.Subject),m(this,"commentUpdate$",this._commentUpdate$.asObservable()),this._threadCommentModel=e,this._univerInstanceService=t,this._init(),this.disposeWithMe(()=>{this._commentUpdate$.complete()})}_init(){this._initData(),this._initUpdateTransform()}_ensureCommentMatrix(e,t){let r=this._matrixMap.get(e);r||(r=/* @__PURE__ */new Map,this._matrixMap.set(e,r));let n=r.get(t);return n||(n=new a.ObjectMatrix,r.set(t,n)),n}_ensureCommentLocationMap(e,t){let r=this._locationMap.get(e);r||(r=/* @__PURE__ */new Map,this._locationMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}_addCommentToMatrix(e,t,r,n){var i;let a=null!=(i=e.getValue(t,r))?i:/* @__PURE__ */new Set;a.add(n),e.setValue(t,r,a)}_deleteCommentFromMatrix(e,t,r,n){if(t>=0&&r>=0){let i=e.getValue(t,r);i&&i.has(n)&&(i.delete(n),0===i.size&&e.realDeleteValue(t,r))}}_ensure(e,t){return{matrix:this._ensureCommentMatrix(e,t),locationMap:this._ensureCommentLocationMap(e,t)}}_initData(){for(let e of this._threadCommentModel.getAll())for(let t of e.threads){let{unitId:e,subUnitId:r,root:n}=t;this._addComment(e,r,n)}}_addComment(e,t,r){let n=(0,o.singleReferenceToGrid)(r.ref),i=r.parentId,{row:a,column:s}=n,l=r.id,{matrix:d,locationMap:u}=this._ensure(e,t);!i&&a>=0&&s>=0&&(this._addCommentToMatrix(d,a,s,l),u.set(l,{row:a,column:s})),i||this._commentUpdate$.next({unitId:e,subUnitId:t,payload:r,type:"add",isRoot:!i,...n})}_initUpdateTransform(){this.disposeWithMe(this._threadCommentModel.commentUpdate$.subscribe(e=>{let{unitId:t,subUnitId:r}=e;try{if(this._univerInstanceService.getUnitType(t)!==a.UniverInstanceType.UNIVER_SHEET)return}catch{}let{matrix:n,locationMap:i}=this._ensure(t,r);switch(e.type){case"add":this._addComment(e.unitId,e.subUnitId,e.payload);break;case"delete":{let{isRoot:t,comment:r}=e.payload;if(t){let t=(0,o.singleReferenceToGrid)(r.ref),{row:i,column:a}=t;this._deleteCommentFromMatrix(n,i,a,r.id),this._commentUpdate$.next({...e,...t})}break}case"update":{let{commentId:n}=e.payload,i=this._threadCommentModel.getComment(t,r,n);if(!i)return;let a=(0,o.singleReferenceToGrid)(i.ref);this._commentUpdate$.next({...e,...a});break}case"updateRef":{let t=(0,o.singleReferenceToGrid)(e.payload.ref),{commentId:r}=e.payload,a=i.get(r);if(!a)return;let{row:s,column:l}=a;this._deleteCommentFromMatrix(n,s,l,r),i.delete(r),t.row>=0&&t.column>=0&&(this._addCommentToMatrix(n,t.row,t.column,r),i.set(r,{row:t.row,column:t.column})),this._commentUpdate$.next({...e,...t});break}case"resolve":{let{unitId:t,subUnitId:r,payload:n}=e,{locationMap:i}=this._ensure(t,r),a=i.get(n.commentId);a&&this._commentUpdate$.next({...e,...a})}}}))}getByLocation(e,t,r,n){var i;return null==(i=this.getAllByLocation(e,t,r,n).filter(e=>!e.resolved)[0])?void 0:i.id}getAllByLocation(e,t,r,n){let i=this._ensureCommentMatrix(e,t).getValue(r,n);return i?Array.from(i).map(r=>this.getComment(e,t,r)).filter(Boolean):[]}getComment(e,t,r){return this._threadCommentModel.getComment(e,t,r)}getCommentWithChildren(e,t,r,n){let i=this.getByLocation(e,t,r,n);if(!i)return;let a=this.getComment(e,t,i);if(a)return this._threadCommentModel.getThread(e,t,a.threadId)}showCommentMarker(e,t,r,n){let i=this.getByLocation(e,t,r,n);if(!i)return!1;let a=this.getComment(e,t,i);return!!(a&&!a.resolved)}getSubUnitAll(e,t){return this._threadCommentModel.getUnit(e).filter(e=>e.subUnitId===t).map(e=>e.root)}},"SheetsThreadCommentModel"),i);_=f([v(0,(0,a.Inject)(l.ThreadCommentModel)),v(1,a.IUniverInstanceService)],_);var I,S=Object.defineProperty,C=Object.getOwnPropertyDescriptor,y=/* @__PURE__ */h((e,t,r,n)=>{for(var i,a=n>1?void 0:n?C(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&S(t,r,a),a},"__decorateClass$1"),w=/* @__PURE__ */h((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let b=(I=class extends a.Disposable{constructor(e,t,r,n,i){super(),m(this,"_disposableMap",/* @__PURE__ */new Map),m(this,"_watcherMap",/* @__PURE__ */new Map),m(this,"_handleRangeChange",/* @__PURE__ */h((e,t,r,n,i)=>{let a=r.id,s={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};return n?{redos:[{id:l.UpdateCommentRefMutation.id,params:{unitId:e,subUnitId:t,payload:{ref:(0,o.serializeRange)(n),commentId:a},silent:i}}],undos:[{id:l.UpdateCommentRefMutation.id,params:{unitId:e,subUnitId:t,payload:{ref:(0,o.serializeRange)(s),commentId:a},silent:i}}]}:{redos:[{id:l.DeleteCommentMutation.id,params:{unitId:e,subUnitId:t,commentId:a}}],undos:[{id:l.AddCommentMutation.id,params:{unitId:e,subUnitId:t,comment:r,sync:!0}}]}},"_handleRangeChange")),this._refRangeService=e,this._sheetsThreadCommentModel=t,this._threadCommentModel=r,this._selectionManagerService=n,this._commandService=i,this._initData(),this._initRefRange()}_getIdWithUnitId(e,t,r){return`${e}-${t}-${r}`}_register(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._disposableMap.set(this._getIdWithUnitId(e,t,n),this._refRangeService.registerRefRange(i,n=>{let a=(0,s.handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests)(i,n,{selectionManagerService:this._selectionManagerService}),o=Array.isArray(a)?a[0]:a;return o&&o.startColumn===i.startColumn&&o.startRow===i.startRow?{undos:[],redos:[]}:this._handleRangeChange(e,t,r,o,!1)},e,t))}_watch(e,t,r){let n=r.id,i={startColumn:r.column,endColumn:r.column,startRow:r.row,endRow:r.row};this._watcherMap.set(this._getIdWithUnitId(e,t,n),this._refRangeService.watchRange(e,t,i,(n,i)=>{let{redos:o}=this._handleRangeChange(e,t,r,i,!0);(0,a.sequenceExecuteAsync)(o,this._commandService,{onlyLocal:!0})},!0))}_unwatch(e,t,r){var n;let i=this._getIdWithUnitId(e,t,r);null==(n=this._watcherMap.get(i))||n.dispose(),this._watcherMap.delete(i)}_unregister(e,t,r){var n;let i=this._getIdWithUnitId(e,t,r);null==(n=this._disposableMap.get(i))||n.dispose(),this._disposableMap.delete(i)}_initData(){for(let e of this._threadCommentModel.getAll())for(let t of e.threads){let{unitId:e,subUnitId:r,root:n}=t,i=(0,o.singleReferenceToGrid)(n.ref),a={...n,...i};this._register(e,r,a),this._watch(e,r,a)}}_initRefRange(){this.disposeWithMe(this._sheetsThreadCommentModel.commentUpdate$.subscribe(e=>{let{unitId:t,subUnitId:r}=e;switch(e.type){case"add":{if(e.payload.parentId)return;let t={...e.payload,row:e.row,column:e.column};this._register(e.unitId,e.subUnitId,t),this._watch(e.unitId,e.subUnitId,t);break}case"delete":this._unregister(t,r,e.payload.commentId),this._unwatch(t,r,e.payload.commentId);break;case"updateRef":{let n=this._sheetsThreadCommentModel.getComment(t,r,e.payload.commentId);if(!n)return;this._unregister(t,r,e.payload.commentId);let i={...n,row:e.row,column:e.column};e.silent||(this._unwatch(t,r,e.payload.commentId),this._watch(t,r,i)),this._register(e.unitId,e.subUnitId,i)}}})),this.disposeWithMe((0,a.toDisposable)(()=>{this._disposableMap.forEach(e=>{e.dispose()}),this._disposableMap.clear()}))}},h(I,"SheetsThreadCommentRefRangeController"),I);b=y([w(0,(0,a.Inject)(s.RefRangeService)),w(1,(0,a.Inject)(_)),w(2,(0,a.Inject)(l.ThreadCommentModel)),w(3,(0,a.Inject)(s.SheetsSelectionsService)),w(4,a.ICommandService)],b);var R,E=Object.defineProperty,T=Object.getOwnPropertyDescriptor,M=/* @__PURE__ */h((e,t,r)=>t in e?E(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),O=/* @__PURE__ */h((e,t,r,n)=>{for(var i,a=n>1?void 0:n?T(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&E(t,r,a),a},"__decorateClass"),D=/* @__PURE__ */h((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),U=/* @__PURE__ */h((e,t,r)=>M(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let k=(h(R=class extends a.Plugin{constructor(e,t,r){super(),this._injector=t,this._commandService=r}onStarting(){[[_],[b]].forEach(e=>{this._injector.add(e)}),this._injector.get(b)}},"UniverSheetsThreadCommentBasePlugin"),R);U(k,"pluginName","SHEET_THREAD_COMMENT_BASE_PLUGIN"),U(k,"type",a.UniverInstanceType.UNIVER_SHEET),k=O([(0,a.DependentOn)(l.UniverThreadCommentPlugin),D(1,(0,a.Inject)(a.Injector)),D(2,(0,a.Inject)(a.ICommandService))],k)}),i("9zRwE",function(t,r){let i;e(t.exports,"IThreadCommentDataSourceService",function(){return h}),e(t.exports,"ThreadCommentModel",function(){return _}),e(t.exports,"AddCommentMutation",function(){return T}),e(t.exports,"UpdateCommentRefMutation",function(){return O}),e(t.exports,"DeleteCommentMutation",function(){return U}),e(t.exports,"AddCommentCommand",function(){return k}),e(t.exports,"UpdateCommentCommand",function(){return P}),e(t.exports,"ResolveCommentCommand",function(){return N}),e(t.exports,"DeleteCommentCommand",function(){return x}),e(t.exports,"DeleteCommentTreeCommand",function(){return A}),e(t.exports,"UniverThreadCommentPlugin",function(){return B});var a=n("7yNYd"),o=n("1mjSk"),s=Object.defineProperty,l=(e,t,r)=>t in e?s(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,d=(e,t)=>s(e,"name",{value:t,configurable:!0}),u=(e,t,r)=>l(e,"symbol"!=typeof t?t+"":t,r);let c=class extends a.Disposable{constructor(){super(),u(this,"_dataSource",null),u(this,"syncUpdateMutationToColla",!0)}set dataSource(e){this._dataSource=e}get dataSource(){return this._dataSource}async getThreadComment(e,t,r){return this._dataSource?(await this._dataSource.listComments(e,t,[r]))[0]:null}async addComment(e){var t;return this._dataSource?this._dataSource.addComment(e):{...e,threadId:null!=(t=e.threadId)?t:e.id}}async updateComment(e){return!this._dataSource||this._dataSource.updateComment(e)}async resolveComment(e){return!this._dataSource||this._dataSource.resolveComment(e)}async deleteComment(e,t,r,n){return!this._dataSource||this._dataSource.deleteComment(e,t,r,n)}async listThreadComments(e,t,r){return!!this.dataSource&&this.dataSource.listComments(e,t,r)}saveToSnapshot(e,t){if(this._dataSource){let t={};return Object.keys(e).forEach(r=>{let n=e[r];t[r]=n.map(this.dataSource.saveCommentToSnapshot)}),t}return e}};d(c,"ThreadCommentDataSourceService");let h=(0,a.createIdentifier)("univer.thread-comment.data-source-service");var m,p=Object.defineProperty,g=Object.getOwnPropertyDescriptor,f=/* @__PURE__ */d((e,t,r,n)=>{for(var i,a=n>1?void 0:n?g(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&p(t,r,a),a},"__decorateClass$2"),v=/* @__PURE__ */d((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let _=(m=class extends a.Disposable{constructor(e,t){super(),u(this,"_commentsMap",/* @__PURE__ */new Map),u(this,"_threadMap",/* @__PURE__ */new Map),u(this,"_commentUpdate$",new o.Subject),u(this,"commentUpdate$",this._commentUpdate$.asObservable()),u(this,"_tasks",[]),this._dataSourceService=e,this._lifecycleService=t,this.disposeWithMe(()=>{this._commentUpdate$.complete()}),this.disposeWithMe(this._lifecycleService.lifecycle$.subscribe(e=>{let t=/* @__PURE__ */new Map;e===a.LifecycleStages.Rendered&&(this._tasks.forEach(({unitId:e,subUnitId:r,threadIds:n})=>{let i=t.get(e);i||(i=/* @__PURE__ */new Map,t.set(e,i));let a=i.get(r);for(let e of(a||(a=/* @__PURE__ */new Set,i.set(r,a)),n))a.add(e)}),this._tasks=[],t.forEach((e,t)=>{e.forEach((e,r)=>{this.syncThreadComments(t,r,Array.from(e))})}))}))}_ensureCommentMap(e,t){let r=this._commentsMap.get(e);r||(r=/* @__PURE__ */new Map,this._commentsMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}ensureMap(e,t){return this._ensureCommentMap(e,t)}_ensureThreadMap(e,t){let r=this._threadMap.get(e);r||(r=/* @__PURE__ */new Map,this._threadMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}_replaceComment(e,t,r){let n=this._ensureCommentMap(e,t),i=n.get(r.id);if(i){let{children:a,...o}=r,s={...o,ref:i.ref};n.set(r.id,s),null==a||a.forEach(e=>{n.set(e.id,{...e,ref:""})}),this._commentUpdate$.next({unitId:e,subUnitId:t,type:"syncUpdate",payload:s}),!!r.resolved!=!!i.resolved&&this._commentUpdate$.next({unitId:e,subUnitId:t,type:"resolve",payload:{commentId:r.id,resolved:!!r.resolved}})}}async syncThreadComments(e,t,r){if(this._lifecycleService.stage<a.LifecycleStages.Rendered){this._tasks.push({unitId:e,subUnitId:t,threadIds:r});return}let n=this._ensureThreadMap(e,t),i=this._ensureCommentMap(e,t),o=await this._dataSourceService.listThreadComments(e,t,r);if(!o)return;let s=new Set(r);o.forEach(r=>{this._replaceComment(e,t,r),s.delete(r.threadId)}),s.forEach(e=>{n.delete(e),i.forEach((t,r)=>{t.threadId===e&&i.delete(r)})})}addComment(e,t,r,n){let i=this._ensureCommentMap(e,t),{parentId:a,children:o=[],...s}=r,l={...s,parentId:a===r.id?void 0:a},u=/* @__PURE__ */d(r=>{i.set(r.id,r),this._commentUpdate$.next({unitId:e,subUnitId:t,type:"add",payload:r,isRoot:!r.parentId})},"addCommentItem");u(l);let c=this._ensureThreadMap(e,t);if(!l.parentId)for(let e of(c.set(l.threadId,l),o))u(e);return n&&this.syncThreadComments(e,t,[l.threadId]),!0}updateComment(e,t,r,n){let i=this._ensureCommentMap(e,t).get(r.commentId);return i&&(i.updated=!0,i.text=r.text,i.attachments=r.attachments,i.updateT=r.updateT,this._commentUpdate$.next({unitId:e,subUnitId:t,type:"update",payload:r,silent:n})),!0}updateCommentRef(e,t,r,n){let i=this._ensureCommentMap(e,t).get(r.commentId);return!!i&&(i.ref=r.ref,this._commentUpdate$.next({unitId:e,subUnitId:t,type:"updateRef",payload:r,silent:n,threadId:i.threadId}),!0)}resolveComment(e,t,r,n){let i=this._ensureCommentMap(e,t).get(r);return!!i&&(i.resolved=n,this._commentUpdate$.next({unitId:e,subUnitId:t,type:"resolve",payload:{commentId:r,resolved:n}}),!0)}getComment(e,t,r){return this._ensureCommentMap(e,t).get(r)}getRootComment(e,t,r){return this._ensureThreadMap(e,t).get(r)}getThread(e,t,r){let n;let i=Array.from(this._ensureCommentMap(e,t).values()).filter(e=>e.threadId===r),a=[],o=/* @__PURE__ */new Set;for(let e of i)e.parentId?a.push(e):n=e,o.add(e.personId);if(n)return{root:n,children:a,relativeUsers:o,unitId:e,subUnitId:t,threadId:r}}getCommentWithChildren(e,t,r){let n=this.getComment(e,t,r);if(n)return this.getThread(e,t,n.threadId)}_deleteComment(e,t,r){let n=this._ensureCommentMap(e,t),i=n.get(r);i&&(n.delete(r),this._commentUpdate$.next({unitId:e,subUnitId:t,type:"delete",payload:{commentId:r,isRoot:!i.parentId,comment:i}}))}deleteThread(e,t,r){this._ensureThreadMap(e,t).delete(r),this._ensureCommentMap(e,t).forEach(n=>{n.threadId===r&&this._deleteComment(e,t,n.id)})}deleteComment(e,t,r){let n=this._ensureCommentMap(e,t).get(r);return n&&(n.parentId?this._deleteComment(e,t,r):this.deleteThread(e,t,n.threadId)),!0}deleteUnit(e){let t=this._commentsMap.get(e);t&&t.forEach((t,r)=>{t.forEach(t=>{this.deleteComment(e,r,t.id)})})}getUnit(e){let t=this._threadMap.get(e);if(!t)return[];let r=[];return t.forEach((t,n)=>{t.forEach((t,i)=>{let a=this.getThread(e,n,i);a&&r.push(a)})}),r}getAll(){let e=[];return this._commentsMap.forEach((t,r)=>{e.push({unitId:r,threads:this.getUnit(r)})}),e}},d(m,"ThreadCommentModel"),m);_=f([v(0,(0,a.Inject)(h)),v(1,(0,a.Inject)(a.LifecycleService))],_);var I=((i=I||{})[i.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",i[i.UNIVER_DOC=1]="UNIVER_DOC",i[i.UNIVER_SHEET=2]="UNIVER_SHEET",i[i.UNIVER_SLIDE=3]="UNIVER_SLIDE",i[i.UNIVER_PROJECT=4]="UNIVER_PROJECT",i[i.UNRECOGNIZED=-1]="UNRECOGNIZED",i);let S="UNIVER_THREAD_COMMENT_PLUGIN";var C,y=Object.defineProperty,w=Object.getOwnPropertyDescriptor,b=/* @__PURE__ */d((e,t,r,n)=>{for(var i,a=n>1?void 0:n?w(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&y(t,r,a),a},"__decorateClass$1"),R=/* @__PURE__ */d((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let E=(C=class extends a.Disposable{constructor(e,t,r){super(),this._resourceManagerService=e,this._threadCommentModel=t,this._threadCommentDataSourceService=r,this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */d(e=>{let t=this._threadCommentModel.getUnit(e),r={};return t?(t.forEach(e=>{var t;let n=null!=(t=r[e.subUnitId])?t:[];n.push({...e.root,children:e.children}),r[e.unitId]=n}),JSON.stringify(this._threadCommentDataSourceService.saveToSnapshot(r,e))):""},"toJson"),t=/* @__PURE__ */d(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:`SHEET_${S}`,businesses:[I.UNIVER_SHEET,I.UNIVER_DOC],toJson:/* @__PURE__ */d(t=>e(t),"toJson"),parseJson:/* @__PURE__ */d(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */d(e=>{this._threadCommentModel.deleteUnit(e)},"onUnLoad"),onLoad:/* @__PURE__ */d(async(e,t)=>{Object.keys(t).forEach(r=>{let n=t[r];n.forEach(t=>{this._threadCommentModel.addComment(e,r,t)}),this._threadCommentModel.syncThreadComments(e,r,n.map(e=>e.threadId))})},"onLoad")}))}},d(C,"ThreadCommentResourceController"),C);E=b([R(0,a.IResourceManagerService),R(1,(0,a.Inject)(_)),R(2,h)],E);let T={id:"thread-comment.mutation.add-comment",type:a.CommandType.MUTATION,handler(e,t,r){if(!t)return!1;let n=e.get(_),{unitId:i,subUnitId:a,comment:o,sync:s}=t,l=s||(null==r?void 0:r.fromChangeset)&&!o.parentId;return n.addComment(i,a,o,l)}},M={id:"thread-comment.mutation.update-comment",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(_),{unitId:n,subUnitId:i,payload:a,silent:o}=t;return r.updateComment(n,i,a,o)}},O={id:"thread-comment.mutation.update-comment-ref",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(_),{unitId:n,subUnitId:i,payload:a,silent:o}=t;return r.updateCommentRef(n,i,a,o)}},D={id:"thread-comment.mutation.resolve-comment",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(_),{unitId:n,subUnitId:i,resolved:a,commentId:o}=t;return r.resolveComment(n,i,o,a)}},U={id:"thread-comment.mutation.delete-comment",type:a.CommandType.MUTATION,handler(e,t){if(!t)return!1;let r=e.get(_),{unitId:n,subUnitId:i,commentId:a}=t;return r.deleteComment(n,i,a)}},k={id:"thread-comment.command.add-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let r=e.get(a.ICommandService),n=e.get(h),{comment:i}=t,o=await n.addComment(i),s=n.syncUpdateMutationToColla,l=!i.parentId,d={id:T.id,params:{...t,comment:o}};return l?await r.executeCommand(d.id,d.params):r.executeCommand(d.id,d.params,{onlyLocal:!s})}},P={id:"thread-comment.command.update-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,payload:i}=t,o=e.get(a.ICommandService),s=e.get(_),l=e.get(h),d=l.syncUpdateMutationToColla,u=s.getComment(r,n,i.commentId);if(!u)return!1;let{children:c,...m}=u;if(!await l.updateComment({...m,...i}))return!1;let p={id:M.id,params:t};return o.executeCommand(p.id,p.params,{onlyLocal:!d}),!0}},N={id:"thread-comment.command.resolve-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let{unitId:r,subUnitId:n,resolved:i,commentId:o}=t,s=e.get(h),l=e.get(_).getComment(r,n,o),d=s.syncUpdateMutationToColla;return!!(l&&await s.resolveComment({...l,resolved:i}))&&e.get(a.ICommandService).executeCommand(D.id,t,{onlyLocal:!d})}},x={id:"thread-comment.command.delete-comment",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let r=e.get(_),n=e.get(h),i=e.get(a.ICommandService),{unitId:o,subUnitId:s,commentId:l}=t,d=n.syncUpdateMutationToColla,u=r.getComment(o,s,l);if(!u||!await n.deleteComment(o,s,u.threadId,l))return!1;let c={id:U.id,params:t};return i.executeCommand(c.id,c.params,{onlyLocal:!d})}},A={id:"thread-comment.command.delete-comment-tree",type:a.CommandType.COMMAND,async handler(e,t){if(!t)return!1;let r=e.get(_),n=e.get(a.ICommandService),i=e.get(h),{unitId:o,subUnitId:s,commentId:l}=t,d=r.getCommentWithChildren(o,s,l);return!!(d&&await i.deleteComment(o,s,d.root.threadId,l))&&await n.executeCommand(U.id,{unitId:o,subUnitId:s,commentId:d.root.id})}},L={};var F,j=Object.defineProperty,V=Object.getOwnPropertyDescriptor,H=/* @__PURE__ */d((e,t,r,n)=>{for(var i,a=n>1?void 0:n?V(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&j(t,r,a),a},"__decorateClass"),$=/* @__PURE__ */d((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let B=(d(F=class extends a.Plugin{constructor(e=L,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{...i}=this._config;this._configService.setConfig("thread-comment.config",i)}onStarting(){var e;(0,a.mergeOverrideWithDependencies)([[h,{useClass:c}],[_],[E]],null==(e=this._config)?void 0:e.overrides).forEach(e=>{this._injector.add(e)}),[k,P,x,N,A,T,M,O,U,D].forEach(e=>{this._commandService.registerCommand(e)}),this._injector.get(E)}},"UniverThreadCommentPlugin"),u(F,"pluginName",S),u(F,"type",a.UniverInstanceType.UNIVER_UNKNOWN),F);B=H([$(1,(0,a.Inject)(a.Injector)),$(2,a.ICommandService),$(3,a.IConfigService)],B)}),i("1Dbxg",function(i,a){e(i.exports,"getDT",function(){return b}),e(i.exports,"ThreadCommentPanelService",function(){return U}),e(i.exports,"THREAD_COMMENT_PANEL",function(){return k}),e(i.exports,"ToggleSheetCommentPanelOperation",function(){return P}),e(i.exports,"SetActiveCommentOperation",function(){return N}),e(i.exports,"IThreadCommentMentionDataService",function(){return L}),e(i.exports,"UniverThreadCommentUIPlugin",function(){return G}),e(i.exports,"ThreadCommentTree",function(){return eb}),e(i.exports,"ThreadCommentPanel",function(){return eE});var o=n("7yNYd"),s=n("9zRwE"),l=n("fL2Ug"),d=n("5LPkb"),u=n("bXJOC"),c=n("lMvMU"),h=n("1UDbf"),m=n("5gqvu"),p=n("7AR1b"),g=n("g6Cit"),f=n("3e0Iz"),v=Object.defineProperty,_=(e,t,r)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t)=>v(e,"name",{value:t,configurable:!0}),S=(e,t,r)=>_(e,"symbol"!=typeof t?t+"":t,r);function C(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}"u">typeof globalThis?globalThis:"u">typeof window?window:"u">typeof r||"u">typeof self&&self,I(C,"getDefaultExportFromCjs");var y={exports:{}};R=function(){var e="millisecond",t="second",r="minute",n="hour",i="week",a="month",o="quarter",s="year",l="date",d="Invalid Date",u=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,c=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,h={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:/* @__PURE__ */I(function(e){var t=["th","st","nd","rd"],r=e%100;return"["+e+(t[(r-20)%10]||t[r]||"th")+"]"},"ordinal")},m=/* @__PURE__ */I(function(e,t,r){var n=String(e);return!n||n.length>=t?e:""+Array(t+1-n.length).join(r)+e},"m"),p={s:m,z:/* @__PURE__ */I(function(e){var t=-e.utcOffset(),r=Math.abs(t);return(t<=0?"+":"-")+m(Math.floor(r/60),2,"0")+":"+m(r%60,2,"0")},"z"),m:/* @__PURE__ */I(function e(t,r){if(t.date()<r.date())return-e(r,t);var n=12*(r.year()-t.year())+(r.month()-t.month()),i=t.clone().add(n,a),o=r-i<0,s=t.clone().add(n+(o?-1:1),a);return+(-(n+(r-i)/(o?i-s:s-i))||0)},"t"),a:/* @__PURE__ */I(function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},"a"),p:/* @__PURE__ */I(function(d){return({M:a,y:s,w:i,d:"day",D:l,h:n,m:r,s:t,ms:e,Q:o})[d]||String(d||"").toLowerCase().replace(/s$/,"")},"p"),u:/* @__PURE__ */I(function(e){return void 0===e},"u")},g="en",f={};f[g]=h;var v="$isDayjsObject",_=/* @__PURE__ */I(function(e){return e instanceof y||!(!e||!e[v])},"S"),S=/* @__PURE__ */I(function e(t,r,n){var i;if(!t)return g;if("string"==typeof t){var a=t.toLowerCase();f[a]&&(i=a),r&&(f[a]=r,i=a);var o=t.split("-");if(!i&&o.length>1)return e(o[0])}else{var s=t.name;f[s]=t,i=s}return!n&&i&&(g=i),i||!n&&g},"t"),C=/* @__PURE__ */I(function(e,t){if(_(e))return e.clone();var r="object"==typeof t?t:{};return r.date=e,r.args=arguments,new y(r)},"O");p.l=S,p.i=_,p.w=function(e,t){return C(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var y=function(){function h(e){this.$L=S(e.locale,null,!0),this.parse(e),this.$x=this.$x||e.x||{},this[v]=!0}I(h,"M");var m=h.prototype;return m.parse=function(e){this.$d=function(e){var t=e.date,r=e.utc;if(null===t)return /* @__PURE__ */new Date(NaN);if(p.u(t))return /* @__PURE__ */new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var n=t.match(u);if(n){var i=n[2]-1||0,a=(n[7]||"0").substring(0,3);return r?new Date(Date.UTC(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,a)):new Date(n[1],i,n[3]||1,n[4]||0,n[5]||0,n[6]||0,a)}}return new Date(t)}(e),this.init()},m.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},m.$utils=function(){return p},m.isValid=function(){return this.$d.toString()!==d},m.isSame=function(e,t){var r=C(e);return this.startOf(t)<=r&&r<=this.endOf(t)},m.isAfter=function(e,t){return C(e)<this.startOf(t)},m.isBefore=function(e,t){return this.endOf(t)<C(e)},m.$g=function(e,t,r){return p.u(e)?this[t]:this.set(r,e)},m.unix=function(){return Math.floor(this.valueOf()/1e3)},m.valueOf=function(){return this.$d.getTime()},m.startOf=function(e,o){var d=this,u=!!p.u(o)||o,c=p.p(e),h=/* @__PURE__ */I(function(e,t){var r=p.w(d.$u?Date.UTC(d.$y,t,e):new Date(d.$y,t,e),d);return u?r:r.endOf("day")},"l"),m=/* @__PURE__ */I(function(e,t){return p.w(d.toDate()[e].apply(d.toDate("s"),(u?[0,0,0,0]:[23,59,59,999]).slice(t)),d)},"$"),g=this.$W,f=this.$M,v=this.$D,_="set"+(this.$u?"UTC":"");switch(c){case s:return u?h(1,0):h(31,11);case a:return u?h(1,f):h(0,f+1);case i:var S=this.$locale().weekStart||0,C=(g<S?g+7:g)-S;return h(u?v-C:v+(6-C),f);case"day":case l:return m(_+"Hours",0);case n:return m(_+"Minutes",1);case r:return m(_+"Seconds",2);case t:return m(_+"Milliseconds",3);default:return this.clone()}},m.endOf=function(e){return this.startOf(e,!1)},m.$set=function(i,o){var d,u=p.p(i),c="set"+(this.$u?"UTC":""),h=((d={}).day=c+"Date",d[l]=c+"Date",d[a]=c+"Month",d[s]=c+"FullYear",d[n]=c+"Hours",d[r]=c+"Minutes",d[t]=c+"Seconds",d[e]=c+"Milliseconds",d)[u],m="day"===u?this.$D+(o-this.$W):o;if(u===a||u===s){var g=this.clone().set(l,1);g.$d[h](m),g.init(),this.$d=g.set(l,Math.min(this.$D,g.daysInMonth())).$d}else h&&this.$d[h](m);return this.init(),this},m.set=function(e,t){return this.clone().$set(e,t)},m.get=function(e){return this[p.p(e)]()},m.add=function(e,o){var l,d=this;e=Number(e);var u=p.p(o),c=/* @__PURE__ */I(function(t){var r=C(d);return p.w(r.date(r.date()+Math.round(t*e)),d)},"y");if(u===a)return this.set(a,this.$M+e);if(u===s)return this.set(s,this.$y+e);if("day"===u)return c(1);if(u===i)return c(7);var h=((l={})[r]=6e4,l[n]=36e5,l[t]=1e3,l)[u]||1,m=this.$d.getTime()+e*h;return p.w(m,this)},m.subtract=function(e,t){return this.add(-1*e,t)},m.format=function(e){var t=this,r=this.$locale();if(!this.isValid())return r.invalidDate||d;var n=e||"YYYY-MM-DDTHH:mm:ssZ",i=p.z(this),a=this.$H,o=this.$m,s=this.$M,l=r.weekdays,u=r.months,h=r.meridiem,m=/* @__PURE__ */I(function(e,r,i,a){return e&&(e[r]||e(t,n))||i[r].slice(0,a)},"h"),g=/* @__PURE__ */I(function(e){return p.s(a%12||12,e,"0")},"d"),f=h||function(e,t,r){var n=e<12?"AM":"PM";return r?n.toLowerCase():n};return n.replace(c,function(e,n){return n||function(e){switch(e){case"YY":return String(t.$y).slice(-2);case"YYYY":return p.s(t.$y,4,"0");case"M":return s+1;case"MM":return p.s(s+1,2,"0");case"MMM":return m(r.monthsShort,s,u,3);case"MMMM":return m(u,s);case"D":return t.$D;case"DD":return p.s(t.$D,2,"0");case"d":return String(t.$W);case"dd":return m(r.weekdaysMin,t.$W,l,2);case"ddd":return m(r.weekdaysShort,t.$W,l,3);case"dddd":return l[t.$W];case"H":return String(a);case"HH":return p.s(a,2,"0");case"h":return g(1);case"hh":return g(2);case"a":return f(a,o,!0);case"A":return f(a,o,!1);case"m":return String(o);case"mm":return p.s(o,2,"0");case"s":return String(t.$s);case"ss":return p.s(t.$s,2,"0");case"SSS":return p.s(t.$ms,3,"0");case"Z":return i}return null}(e)||i.replace(":","")})},m.utcOffset=function(){return-(15*Math.round(this.$d.getTimezoneOffset()/15))},m.diff=function(e,l,d){var u,c=this,h=p.p(l),m=C(e),g=(m.utcOffset()-this.utcOffset())*6e4,f=this-m,v=/* @__PURE__ */I(function(){return p.m(c,m)},"D");switch(h){case s:u=v()/12;break;case a:u=v();break;case o:u=v()/3;break;case i:u=(f-g)/6048e5;break;case"day":u=(f-g)/864e5;break;case n:u=f/36e5;break;case r:u=f/6e4;break;case t:u=f/1e3;break;default:u=f}return d?u:p.a(u)},m.daysInMonth=function(){return this.endOf(a).$D},m.$locale=function(){return f[this.$L]},m.locale=function(e,t){if(!e)return this.$L;var r=this.clone(),n=S(e,t,!0);return n&&(r.$L=n),r},m.clone=function(){return p.w(this.$d,this)},m.toDate=function(){return new Date(this.valueOf())},m.toJSON=function(){return this.isValid()?this.toISOString():null},m.toISOString=function(){return this.$d.toISOString()},m.toString=function(){return this.$d.toUTCString()},h}(),w=y.prototype;return C.prototype=w,[["$ms",e],["$s",t],["$m",r],["$H",n],["$W","day"],["$M",a],["$y",s],["$D",l]].forEach(function(e){w[e[1]]=function(t){return this.$g(t,e[0],e[1])}}),C.extend=function(e,t){return e.$i||(e(t,y,C),e.$i=!0),C},C.locale=S,C.isDayjs=_,C.unix=function(e){return C(1e3*e)},C.en=f[g],C.Ls=f,C.p={},C},y.exports=R();let w=/* @__PURE__ */C(y.exports);function b(){return w().format("YYYY/MM/DD HH:mm")}I(b,"getDT");var R,E,T=Object.defineProperty,M=Object.getOwnPropertyDescriptor,O=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?M(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&T(t,r,a),a},"__decorateClass$1"),D=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let U=(I(E=class extends o.Disposable{constructor(e,t){super(),S(this,"_panelVisible",!1),S(this,"_panelVisible$",new d.BehaviorSubject(!1)),S(this,"_activeCommentId"),S(this,"_activeCommentId$",new d.BehaviorSubject(void 0)),S(this,"panelVisible$",this._panelVisible$.asObservable()),S(this,"activeCommentId$",this._activeCommentId$.asObservable()),this._sidebarService=e,this._univerInstanceService=t,this._init(),this.disposeWithMe(()=>{this._activeCommentId$.complete(),this._panelVisible$.complete()})}_init(){this.disposeWithMe(this._sidebarService.sidebarOptions$.subscribe(e=>{e.visible||this.setPanelVisible(!1)})),this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(o.UniverInstanceType.UNIVER_SHEET).pipe((0,c.filter)(e=>!e)).subscribe(()=>{this._sidebarService.close()}))}get panelVisible(){return this._panelVisible}get activeCommentId(){return this._activeCommentId}setPanelVisible(e){this._panelVisible=e,this._panelVisible$.next(e)}setActiveComment(e){this._activeCommentId=e,this._activeCommentId$.next(e)}},"ThreadCommentPanelService"),E);U=O([D(0,(0,o.Inject)(l.ISidebarService)),D(1,o.IUniverInstanceService)],U);let k="thread-comment-panel",P={id:"thread-comment-ui.operation.toggle-panel",type:o.CommandType.OPERATION,handler(e){let t=e.get(l.ISidebarService),r=e.get(U);return r.panelVisible?(t.close(),r.setPanelVisible(!1)):(t.open({header:{title:"threadCommentUI.panel.title"},children:{label:k},width:330}),r.setPanelVisible(!0)),!0}},N={id:"thread-comment-ui.operation.set-active-comment",type:o.CommandType.OPERATION,handler:(e,t)=>(e.get(U).setActiveComment(t),!0)},x={},A=class{constructor(){S(this,"dataSource"),S(this,"renderSuggestion"),S(this,"trigger","@")}async getMentions(e,t,r){return this.dataSource?this.dataSource.getMentions(e,t,r):[]}};I(A,"ThreadCommentMentionDataService");let L=(0,o.createIdentifier)("thread-comment.mention-data.service");var F,j=Object.defineProperty,V=Object.getOwnPropertyDescriptor,H=/* @__PURE__ */I((e,t,r)=>t in e?j(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),$=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?V(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&j(t,r,a),a},"__decorateClass"),B=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),W=/* @__PURE__ */I((e,t,r)=>H(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let G=(I(F=class extends o.Plugin{constructor(e=x,t,r,n){super(),this._config=e,this._injector=t,this._commandService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig("thread-comment-ui.config",a)}onStarting(){var e;(0,o.mergeOverrideWithDependencies)([[U],[L,{useClass:A}]],null==(e=this._config)?void 0:e.overrides).forEach(e=>{this._injector.add(e)}),[P,N].forEach(e=>{this._commandService.registerCommand(e)})}},"UniverThreadCommentUIPlugin"),F);W(G,"pluginName","UNIVER_THREAD_COMMENT_UI_PLUGIN"),W(G,"type",o.UniverInstanceType.UNIVER_UNKNOWN),G=$([(0,o.DependentOn)(s.UniverThreadCommentPlugin),B(1,(0,o.Inject)(o.Injector)),B(2,o.ICommandService),B(3,o.IConfigService)],G);var z=function(){return(z=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},Y=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},K=(0,m.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=Y(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,m.useRef)("_".concat(Z()));return q(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},z({ref:t,className:s},o),a)});function q(e,t,r,n,i){return(0,m.createElement)(e.tag,z(z({key:t},X(e,r,i)),n),(Q(e,r).children||[]).map(function(n,a){return q(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function X(e,t,r){var n=z({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function Q(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?z(z({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?z(z({},e),{attrs:z(z({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function Z(){return Math.random().toString(36).substring(2,8)}I(q,"render"),I(X,"replaceRuntimeIdsAndExtInAttrs"),I(Q,"replaceRuntimeIdsInDefs"),I(Z,"generateShortUuid"),K.displayName="UniverIcon";var J={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993.866699 5.9313.866699H10.069C10.4004.866699 10.669 1.13533 10.669 1.4667 10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667zM1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443 14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443zM6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928 9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171 10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778 9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539 9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263 6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539 5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778 6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},ee=(0,m.forwardRef)(function(e,t){return(0,m.createElement)(K,Object.assign({},e,{id:"delete-single",ref:t,icon:J}))});ee.displayName="DeleteSingle";var et={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},er=(0,m.forwardRef)(function(e,t){return(0,m.createElement)(K,Object.assign({},e,{id:"increase-single",ref:t,icon:et}))});er.displayName="IncreaseSingle";var en={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3 9C3.55228 9 4 8.55228 4 8 4 7.44772 3.55228 7 3 7 2.44772 7 2 7.44772 2 8 2 8.55228 2.44772 9 3 9zM8 9C8.55228 9 9 8.55228 9 8 9 7.44772 8.55228 7 8 7 7.44772 7 7 7.44772 7 8 7 8.55228 7.44772 9 8 9zM13 9C13.5523 9 14 8.55228 14 8 14 7.44772 13.5523 7 13 7 12.4477 7 12 7.44772 12 8 12 8.55228 12.4477 9 13 9z"}}]},ei=(0,m.forwardRef)(function(e,t){return(0,m.createElement)(K,Object.assign({},e,{id:"more-horizontal-single",ref:t,icon:en}))});ei.displayName="MoreHorizontalSingle";var ea={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{stroke:"currentColor",d:"M7.48389 10.3267V12.1905C7.48389 12.7428 7.9316 13.1905 8.48389 13.1905H11.2216L12.2955 14.2644L13.3695 13.1905H14.1593C14.7116 13.1905 15.1593 12.7428 15.1593 12.1905V8.46289C15.1593 7.91061 14.7116 7.46289 14.1593 7.46289H12.2955",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M0.840332 3.73535C0.840332 2.63078 1.73576 1.73535 2.84033 1.73535H10.2955C11.4001 1.73535 12.2955 2.63078 12.2955 3.73535V8.32676C12.2955 9.43132 11.4001 10.3268 10.2955 10.3268H5.6014L4.1695 11.7587L3.05978 10.3268H2.84033C1.73576 10.3268 0.840332 9.43133 0.840332 8.32676V3.73535Z",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M6.41016 6.1311H6.76813M8.91626 6.1311H9.27424M3.90454 6.1311H4.26252",strokeLinecap:"round",strokeWidth:1.2}}]},eo=(0,m.forwardRef)(function(e,t){return(0,m.createElement)(K,Object.assign({},e,{id:"reply-to-comment-single",ref:t,icon:ea}))});eo.displayName="ReplyToCommentSingle";var es={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6106 15.4036C12.4766 15.4036 15.6106 12.2696 15.6106 8.40356C15.6106 4.53757 12.4766 1.40356 8.6106 1.40356C4.7446 1.40356 1.6106 4.53757 1.6106 8.40356C1.6106 12.2696 4.7446 15.4036 8.6106 15.4036ZM12.3351 6.82773C12.5694 6.59342 12.5694 6.21352 12.3351 5.9792C12.1007 5.74489 11.7208 5.74489 11.4865 5.9792L7.91079 9.55494L6.33506 7.9792C6.10074 7.74489 5.72084 7.74489 5.48653 7.9792C5.25221 8.21352 5.25221 8.59342 5.48653 8.82773L7.48653 10.8277C7.72084 11.062 8.10074 11.062 8.33506 10.8277L12.3351 6.82773Z",fillRule:"evenodd",clipRule:"evenodd"}}]},el=(0,m.forwardRef)(function(e,t){return(0,m.createElement)(K,Object.assign({},e,{id:"resolved-single",ref:t,icon:es}))});el.displayName="ResolvedSingle";var ed={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 17",width:"1em",height:"1em"},children:[{tag:"circle",attrs:{cx:8.73,cy:8.4,r:6.4,stroke:"currentColor",strokeWidth:1.2}},{tag:"path",attrs:{stroke:"currentColor",d:"M6.02637 8.40356L8.02637 10.4036L12.0264 6.40356",strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.2}}]},eu=(0,m.forwardRef)(function(e,t){return(0,m.createElement)(K,Object.assign({},e,{id:"solve-single",ref:t,icon:ed}))});function ec(e){var t,r,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e){if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(r=ec(e[t]))&&(n&&(n+=" "),n+=r)}else for(r in e)e[r]&&(n&&(n+=" "),n+=r)}return n}function eh(){for(var e,t,r=0,n="",i=arguments.length;r<i;r++)(e=arguments[r])&&(t=ec(e))&&(n&&(n+=" "),n+=t);return n}eu.displayName="SolveSingle",I(ec,"r"),I(eh,"clsx");let em={threadCommentEditorButtons:"univer-thread-comment-editor-buttons",threadCommentEditorSuggestion:"univer-thread-comment-editor-suggestion",threadCommentEditorSuggestionActive:"univer-thread-comment-editor-suggestionActive",threadCommentEditorSuggestionIcon:"univer-thread-comment-editor-suggestion-icon"},ep=/* @__PURE__ */I(e=>{let t=/@\[(.*?)\]\((.*?)\)|(\w+)/g,r,n=0,i=[];for(;null!==(r=t.exec(e));)r.index>n&&i.push({type:"text",content:e.substring(n,r.index)}),r[1]&&r[2]?i.push({type:"mention",content:{label:r[1],id:r[2]}}):r[3]&&i.push({type:"text",content:r[3]}),n=t.lastIndex;return n<e.length&&i.push({type:"text",content:e.substring(n)}),i},"parseMentions"),eg=/* @__PURE__ */I(e=>e.map(e=>"mention"===e.type?`@[${e.content.label}](${e.content.id})`:e.content).join(""),"transformTextNode2Text"),ef=/* @__PURE__ */I(e=>{let{dataStream:t,customRanges:r}=e,n=t.length-2,i=[],a=0;return null==r||r.forEach(e=>{a<e.startIndex&&i.push({type:"text",content:t.slice(a,e.startIndex)}),i.push({type:"mention",content:{label:t.slice(e.startIndex,e.endIndex).slice(1,-1),id:e.rangeId}}),a=e.endIndex}),i.push({type:"text",content:t.slice(a,n)}),i},"transformDocument2TextNodes"),ev=/* @__PURE__ */I(e=>{let t="",r=[];return e.forEach(e=>{switch(e.type){case"text":t+=e.content;break;case"mention":{let n=t.length,i=(t+=`${e.content.label}`).length;r.push({rangeId:e.content.id,rangeType:o.CustomRangeType.MENTION,startIndex:n,endIndex:i})}}}),{textRuns:[],paragraphs:[{startIndex:(t+=`
\r`).length-2,paragraphStyle:{}}],sectionBreaks:[{startIndex:t.length-1}],dataStream:t,customRanges:r}},"transformTextNodes2Document"),e_=/* @__PURE__ */I(e=>({display:e.label,id:`${e.id}`,raw:e}),"transformMention"),eI=/* @__PURE__ */I((e,r,n,i,a)=>{var o,s;let l=null==(o=e.raw)?void 0:o.icon;return /* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:em.threadCommentEditorSuggestion},l?/* @__PURE__ *//*@__PURE__*/t(m).createElement("img",{className:em.threadCommentEditorSuggestionIcon,src:l}):null,/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",null,null!=(s=e.display)?s:e.id))},"defaultRenderSuggestion"),eS=(0,m.forwardRef)((e,r)=>{var n,i;let{comment:a,onSave:s,id:l,onCancel:d,autoFocus:u,unitId:c,subUnitId:v}=e,_=(0,o.useDependency)(L),S=(0,o.useDependency)(o.ICommandService),C=(0,o.useDependency)(o.LocaleService),[y,w]=(0,m.useState)({...a}),[b,R]=(0,m.useState)(!1),E=(0,m.useRef)(null),T=(0,o.useDependency)(p.DocSelectionManagerService),M=null==(n=(0,o.useDependency)(f.IRenderManagerService).getCurrentTypeOfRenderer(o.UniverInstanceType.UNIVER_DOC))?void 0:n.with(g.DocSelectionRenderService);(0,m.useImperativeHandle)(r,()=>({reply(e){var t;w({...a,text:e,attachments:[]}),null==(t=E.current)||t.inputElement.focus()}}));let O=/* @__PURE__ */I(()=>{var e;y.text&&(null==s||s({...y,text:y.text}),R(!1),w({text:void 0}),null==(e=E.current)||e.inputElement.blur())},"handleSave");return /* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:em.threadCommentEditor,onClick:/* @__PURE__ */I(e=>e.preventDefault(),"onClick")},/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Mentions,{ref:E,autoFocus:u,style:{width:"100%"},placeholder:C.t("threadCommentUI.editor.placeholder"),value:null!=y&&y.text?eg(ef(y.text)):"",onChange:/* @__PURE__ */I(e=>{e.target.value||w({...a,text:void 0}),null==w||w({...a,text:ev(ep(e.target.value))})},"onChange"),onFocus:/* @__PURE__ */I(()=>{let e=T.getActiveTextRange();e&&e.collapsed&&(null==M||M.removeAllRanges()),null==M||M.blur(),R(!0)},"onFocus")},/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Mention,{key:_.trigger,trigger:_.trigger,data:/* @__PURE__ */I((e,t)=>_.getMentions(e,c,v).then(e=>e.map(e_)).then(t),"data"),displayTransform:/* @__PURE__ */I((e,t)=>`@${t} `,"displayTransform"),renderSuggestion:null!=(i=_.renderSuggestion)?i:eI})),b?/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:em.threadCommentEditorButtons},/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Button,{style:{marginRight:12},onClick:/* @__PURE__ */I(()=>{null==d||d(),R(!1),w({text:void 0}),S.executeCommand(N.id)},"onClick")},C.t("threadCommentUI.editor.cancel")),/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Button,{type:"primary",disabled:!y.text,onClick:O},C.t(l?"threadCommentUI.editor.save":"threadCommentUI.editor.reply"))):null)}),eC={threadComment:"univer-thread-comment",threadCommentActive:"univer-thread-comment-active",threadCommentContent:"univer-thread-comment-content",threadCommentHighlight:"univer-thread-comment-highlight",threadCommentIconContainer:"univer-thread-comment-icon-container",threadCommentIcon:"univer-thread-comment-icon",threadCommentTitle:"univer-thread-comment-title",threadCommentTitlePosition:"univer-thread-comment-title-position",threadCommentTitleHighlight:"univer-thread-comment-title-highlight",threadCommentTitlePositionText:"univer-thread-comment-title-position-text",threadCommentUsername:"univer-thread-comment-username",threadCommentItem:"univer-thread-comment-item",threadCommentItemHead:"univer-thread-comment-item-head",threadCommentItemTitle:"univer-thread-comment-item-title",threadCommentItemTime:"univer-thread-comment-item-time",threadCommentItemContent:"univer-thread-comment-item-content",threadCommentItemAt:"univer-thread-comment-item-at"},ey="__mock__",ew=/* @__PURE__ */I(e=>{let{item:r,unitId:n,subUnitId:i,editing:a,onEditingChange:d,onReply:u,resolved:c,isRoot:p,onClose:g,onDeleteComment:f}=e,v=(0,o.useDependency)(o.ICommandService),_=(0,o.useDependency)(o.LocaleService),S=(0,o.useDependency)(o.UserManagerService),C=S.getUser(r.personId),y=(0,l.useObservable)(S.currentUser$),w=(null==y?void 0:y.userID)===r.personId,b=r.id===ey,[R,E]=(0,m.useState)(!1),T=/* @__PURE__ */I(()=>{(null==f?void 0:f(r))!==!1&&(v.executeCommand(p?s.DeleteCommentTreeCommand.id:s.DeleteCommentCommand.id,{unitId:n,subUnitId:i,commentId:r.id}),p&&(null==g||g()))},"handleDeleteItem");return /* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentItem,onMouseLeave:/* @__PURE__ */I(()=>E(!1),"onMouseLeave"),onMouseEnter:/* @__PURE__ */I(()=>E(!0),"onMouseEnter")},/* @__PURE__ *//*@__PURE__*/t(m).createElement("img",{className:eC.threadCommentItemHead,src:null==C?void 0:C.avatar}),/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentItemTitle},/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentUsername},(null==C?void 0:C.name)||" "),/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",null,b||c?null:R?/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentIcon,onClick:/* @__PURE__ */I(()=>u(C),"onClick")},/* @__PURE__ *//*@__PURE__*/t(m).createElement(eo,null)):null,!w||b||c?null:/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Dropdown,{overlay:/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Menu,null,/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.MenuItem,{key:"edit",onClick:/* @__PURE__ */I(()=>null==d?void 0:d(!0),"onClick")},_.t("threadCommentUI.item.edit")),/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.MenuItem,{key:"delete",onClick:T},_.t("threadCommentUI.item.delete")))},/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentIcon},/* @__PURE__ *//*@__PURE__*/t(m).createElement(ei,null))))),/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentItemTime},r.dT),a?/* @__PURE__ *//*@__PURE__*/t(m).createElement(eS,{id:r.id,comment:r,onCancel:/* @__PURE__ */I(()=>null==d?void 0:d(!1),"onCancel"),autoFocus:!0,unitId:n,subUnitId:i,onSave:/* @__PURE__ */I(({text:e,attachments:t})=>{null==d||d(!1),v.executeCommand(s.UpdateCommentCommand.id,{unitId:n,subUnitId:i,payload:{commentId:r.id,text:e,attachments:t}})},"onSave")}):/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentItemContent},ef(r.text).map((e,r)=>"mention"===e.type?/* @__PURE__ *//*@__PURE__*/t(m).createElement("a",{className:eC.threadCommentItemAt,key:r},"@",e.content.label," "):e.content)))},"ThreadCommentItem"),eb=/* @__PURE__ */I(e=>{var r,n,i;let{id:a,unitId:d,subUnitId:c,refStr:p,showEdit:g=!0,onClick:f,showHighlight:v,onClose:_,getSubUnitName:S,prefix:C,autoFocus:y,onMouseEnter:w,onMouseLeave:R,onAddComment:E,onDeleteComment:T,onResolve:M}=e,O=(0,o.useDependency)(s.ThreadCommentModel),[D,U]=(0,m.useState)(!1),[k,P]=(0,m.useState)(""),x=(0,m.useMemo)(()=>O.commentUpdate$.pipe((0,u.debounceTime)(16)),[O]);(0,l.useObservable)(x);let A=a?O.getCommentWithChildren(d,c,a):null,L=(0,o.useDependency)(o.ICommandService),F=(0,o.useDependency)(o.UserManagerService),j=null==A?void 0:A.root.resolved,V=(0,l.useObservable)(F.currentUser$),H=(0,m.useRef)(null),$=[...A?[A.root]:[{id:ey,text:{dataStream:`
\r`},personId:null!=(r=null==V?void 0:V.userID)?r:"",ref:null!=p?p:"",dT:"",unitId:d,subUnitId:c,threadId:""}],...null!=(n=null==A?void 0:A.children)?n:[]],B=(0,m.useRef)(null),W=/* @__PURE__ */I(e=>{e.stopPropagation(),j?L.executeCommand(N.id,{unitId:d,subUnitId:c,commentId:a}):L.executeCommand(N.id),L.executeCommand(s.ResolveCommentCommand.id,{unitId:d,subUnitId:c,commentId:a,resolved:!j}),null==M||M(!j)},"handleResolve"),G=/* @__PURE__ */I(e=>{e.stopPropagation(),L.executeCommand(N.id),null!=A&&A.root&&(null==T?void 0:T(A.root))===!1||(L.executeCommand(s.DeleteCommentTreeCommand.id,{unitId:d,subUnitId:c,commentId:a}),null==_||_())},"handleDeleteRoot");(0,m.useEffect)(()=>null==R?void 0:R(),[]);let z=S(null!=(i=null==A?void 0:A.root.subUnitId)?i:c),Y=`${p||(null==A?void 0:A.root.ref)||""}${z?" · ":""}${z}`;return /* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eh(eC.threadComment,{[eC.threadCommentActive]:!j&&(v||D||"cell"===C)}),onClick:f,id:`${C}-${d}-${c}-${a}`,onMouseEnter:/* @__PURE__ */I(()=>{null==w||w(),U(!0)},"onMouseEnter"),onMouseLeave:/* @__PURE__ */I(()=>{null==R||R(),U(!1)},"onMouseLeave")},!j&&v?/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentHighlight}):null,/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentTitle},/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentTitlePosition},/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentTitleHighlight}),/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Tooltip,{showIfEllipsis:!0,title:Y},/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentTitlePositionText},Y))),A?/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentIconContainer},/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{onClick:W,className:eC.threadCommentIcon,style:{color:j?"rgb(var(--green-500))":""}},j?/* @__PURE__ *//*@__PURE__*/t(m).createElement(el,null):/* @__PURE__ *//*@__PURE__*/t(m).createElement(eu,null)),(null==V?void 0:V.userID)===A.root.personId?/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentIcon,onClick:G},/* @__PURE__ *//*@__PURE__*/t(m).createElement(ee,null)):null):null),/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eC.threadCommentContent,ref:B},$.map(e=>/* @__PURE__ *//*@__PURE__*/t(m).createElement(ew,{onClose:_,unitId:d,subUnitId:c,item:e,key:e.id,isRoot:e.id===(null==A?void 0:A.root.id),editing:k===e.id,resolved:null==A?void 0:A.root.resolved,onEditingChange:/* @__PURE__ */I(t=>{P(t?e.id:"")},"onEditingChange"),onReply:/* @__PURE__ */I(e=>{e&&requestAnimationFrame(()=>{var t;null==(t=H.current)||t.reply(ev([{type:"mention",content:{id:e.userID,label:e.name}}]))})},"onReply"),onAddComment:E,onDeleteComment:T}))),!g||k||j?null:/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",null,/* @__PURE__ *//*@__PURE__*/t(m).createElement(eS,{key:`${y}`,ref:H,unitId:d,subUnitId:c,onSave:/* @__PURE__ */I(async({text:e,attachments:t})=>{let r={text:e,attachments:t,dT:b(),id:(0,o.generateRandomId)(),ref:p,personId:null==V?void 0:V.userID,parentId:null==A?void 0:A.root.id,unitId:d,subUnitId:c,threadId:null==A?void 0:A.root.threadId};(null==E?void 0:E(r))!==!1&&(await L.executeCommand(s.AddCommentCommand.id,{unitId:d,subUnitId:c,comment:r}),B.current&&(B.current.scrollTop=B.current.scrollHeight))},"onSave"),autoFocus:y||!A,onCancel:/* @__PURE__ */I(()=>{A||null==_||_()},"onCancel")})))},"ThreadCommentTree"),eR={threadCommentPanel:"univer-thread-comment-panel",threadCommentPanelForms:"univer-thread-comment-panel-forms",threadCommentPanelEmpty:"univer-thread-comment-panel-empty",threadCommentPanelAdd:"univer-thread-comment-panel-add",threadCommentPanelSolved:"univer-thread-comment-panel-solved"},eE=/* @__PURE__ */I(e=>{let{unitId:r,subUnitId$:n,type:i,onAdd:a,getSubUnitName:d,onResolve:u,sortComments:c,onItemLeave:p,onItemEnter:g,disableAdd:f,tempComment:v,onAddComment:_,onDeleteComment:S,showComments:C}=e,[y,w]=(0,m.useState)("all"),[b,R]=(0,m.useState)("all"),E=(0,o.useDependency)(o.LocaleService),T=(0,o.useDependency)(o.UserManagerService),M=(0,o.useDependency)(s.ThreadCommentModel),[O,D]=(0,m.useState)(()=>M.getUnit(r)),k=(0,o.useDependency)(U),P=(0,l.useObservable)(k.activeCommentId$),x=(0,l.useObservable)(M.commentUpdate$),A=(0,o.useDependency)(o.ICommandService),L=(0,l.useObservable)(n),F=(0,m.useRef)(!0),j="panel",V=(0,l.useObservable)(T.currentUser$),H=(0,m.useMemo)(()=>{var e;let t="all"===y?O:null!=(e=O.filter(e=>e.subUnitId===L))?e:[],r=null!=c?c:e=>e,n=t.map(e=>{var t;return{...e.root,children:null!=(t=e.children)?t:[],users:e.relativeUsers}});if(!C)return r(n);{let e=/* @__PURE__ */new Map;return n.forEach(t=>{e.set(t.id,t)}),[...C,""].map(t=>e.get(t)).filter(Boolean)}},[C,y,O,c,L]),$=(0,m.useMemo)(()=>[...H.filter(e=>!e.resolved),...H.filter(e=>e.resolved)],[H]),B=(0,m.useMemo)(()=>"resolved"===b?$.filter(e=>e.resolved):"unsolved"===b?$.filter(e=>!e.resolved):"concern_me"===b&&null!=V&&V.userID?$.filter(e=>null==e?void 0:e.users.has(V.userID)):$,[$,null==V?void 0:V.userID,b]),W=v?[v,...B]:B,G=W.filter(e=>!e.resolved),z=W.filter(e=>e.resolved),Y="all"!==b||"all"!==y,K=/* @__PURE__ */I(()=>{R("all"),w("all")},"onReset");(0,m.useEffect)(()=>{r&&D(M.getUnit(r))},[r,M,x]),(0,m.useEffect)(()=>{var e;if(!P)return;if(!F.current){F.current=!0;return}let{unitId:t,subUnitId:r,commentId:n}=P,i=`${j}-${t}-${r}-${n}`;null==(e=document.getElementById(i))||e.scrollIntoView({block:"center"})},[P]);let q=/* @__PURE__ */I(e=>/* @__PURE__ *//*@__PURE__*/t(m).createElement(eb,{prefix:j,getSubUnitName:d,key:e.id,id:e.id,unitId:e.unitId,subUnitId:e.subUnitId,refStr:e.ref,type:i,showEdit:(null==P?void 0:P.commentId)===e.id,showHighlight:(null==P?void 0:P.commentId)===e.id,onClick:/* @__PURE__ */I(()=>{F.current=!1,e.resolved?A.executeCommand(N.id):A.executeCommand(N.id,{unitId:e.unitId,subUnitId:e.subUnitId,commentId:e.id,temp:!1})},"onClick"),onMouseEnter:/* @__PURE__ */I(()=>null==g?void 0:g(e),"onMouseEnter"),onMouseLeave:/* @__PURE__ */I(()=>null==p?void 0:p(e),"onMouseLeave"),onAddComment:_,onDeleteComment:S,onResolve:/* @__PURE__ */I(t=>null==u?void 0:u(e.id,t),"onResolve")}),"renderComment");return /* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eR.threadCommentPanel},/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eR.threadCommentPanelForms},i===o.UniverInstanceType.UNIVER_SHEET?/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Select,{borderless:!0,value:y,onChange:/* @__PURE__ */I(e=>w(e),"onChange"),options:[{value:"current",label:E.t("threadCommentUI.filter.sheet.current")},{value:"all",label:E.t("threadCommentUI.filter.sheet.all")}]}):null,/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Select,{borderless:!0,value:b,onChange:/* @__PURE__ */I(e=>R(e),"onChange"),options:[{value:"all",label:E.t("threadCommentUI.filter.status.all")},{value:"resolved",label:E.t("threadCommentUI.filter.status.resolved")},{value:"unsolved",label:E.t("threadCommentUI.filter.status.unsolved")},{value:"concern_me",label:E.t("threadCommentUI.filter.status.concernMe")}]})),G.map(q),z.length?/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eR.threadCommentPanelSolved},"已解决"):null,z.map(q),W.length?null:/* @__PURE__ *//*@__PURE__*/t(m).createElement("div",{className:eR.threadCommentPanelEmpty},Y?E.t("threadCommentUI.panel.filterEmpty"):E.t("threadCommentUI.panel.empty"),Y?/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Button,{onClick:K,type:"link"},E.t("threadCommentUI.panel.reset")):/* @__PURE__ *//*@__PURE__*/t(m).createElement(h.Button,{id:"thread-comment-add",className:eR.threadCommentPanelAdd,type:"primary",onClick:a,disabled:f},/* @__PURE__ *//*@__PURE__*/t(m).createElement(er,null),E.t("threadCommentUI.panel.addComment"))))},"ThreadCommentPanel")}),i("2KoFD",function(r,i){e(r.exports,"SheetCanvasFloatDomManagerService",function(){return th});var a,o,s,l=n("7yNYd"),d=n("28sqy"),u=n("dvwwo"),c=n("3e0Iz"),h=n("fPi1a"),m=n("4XALk"),p=n("fL2Ug"),g=n("5LPkb"),f=n("5K4WI"),v=n("arCqp"),_=n("lMvMU"),I=n("hciHF"),S=n("1mjSk"),C=n("23cfA"),y=n("9z4na"),w=n("2jrJe"),b=n("ejawP"),R=n("5gqvu"),E=n("1UDbf"),T=Object.defineProperty,M=(e,t,r)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,O=(e,t)=>T(e,"name",{value:t,configurable:!0}),D=(e,t,r)=>M(e,"symbol"!=typeof t?t+"":t,r);let U={},k={id:"sheet.operation.clear-drawing-transformer",type:l.CommandType.MUTATION,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(c.IRenderManagerService);return t.forEach(e=>{var t,n;null==(n=null==(t=r.getRenderById(e))?void 0:t.scene.getTransformer())||n.debounceRefreshControls()}),!0},"handler")},P={id:"sheet.command.remove-sheet-image",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(l.ICommandService),n=e.get(l.IUndoRedoService),i=e.get(h.ISheetDrawingService);if(!t)return!1;let{drawings:a}=t,o=[];a.forEach(e=>{let{unitId:t}=e;o.push(t)});let{unitId:s,subUnitId:d,undo:u,redo:c,objects:m}=i.getBatchRemoveOp(a);return!!r.syncExecuteCommand(h.SetDrawingApplyMutation.id,{unitId:s,subUnitId:d,op:c,objects:m,type:h.DrawingApplyType.REMOVE})&&(n.pushUndoRedo({unitID:s,undoMutations:[{id:h.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:u,objects:m,type:h.DrawingApplyType.INSERT}},{id:k.id,params:o}],redoMutations:[{id:h.SetDrawingApplyMutation.id,params:{unitId:s,subUnitId:d,op:c,objects:m,type:h.DrawingApplyType.REMOVE}},{id:k.id,params:o}]}),!0)},"handler")},N="COMPONENT_SHEET_DRAWING_PANEL",x={id:"sidebar.operation.sheet-image",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O(async(e,t)=>{let r=e.get(p.ISidebarService),n=e.get(l.LocaleService),i=e.get(l.IUniverInstanceService),a=e.get(d.IDrawingManagerService);return!!(0,b.getSheetCommandTarget)(i)&&("open"===t.value?r.open({header:{title:n.t("sheetImage.panel.title")},children:{label:N},onClose:/* @__PURE__ */O(()=>{a.focusDrawing(null)},"onClose"),width:360}):r.close(),!0)},"handler")},A={id:"sheet.operation.edit-sheet-image",type:l.CommandType.OPERATION,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(d.IDrawingManagerService),n=e.get(l.ICommandService);return null!=t&&(r.focusDrawing([t]),n.executeCommand(x.id,{value:"open"}),!0)},"handler")},L=/* @__PURE__ */O(()=>{let e=(0,l.useDependency)(d.IImageIoService),r=(0,l.useDependency)(l.LocaleService),[n,i]=/*@__PURE__*/t(R).useState(0);return(0,R.useEffect)(()=>{let t=e.change$.subscribe(e=>{i(e)});return()=>{t.unsubscribe()}},[e]),/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{style:{display:n>0?"block":"none"},className:"univer-upload-loading"},/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:"univer-upload-loading-body"},/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:"univer-upload-loading-body-animation"}),/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:"univer-upload-loading-body-text"},`${r.t("uploadLoading.loading")}: ${n}`)))},"UploadLoading");var F,j=Object.defineProperty,V=Object.getOwnPropertyDescriptor,H=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?V(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&j(t,r,a),a},"__decorateClass$9"),$=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$9");let B=(O(F=class extends l.RxDisposable{constructor(e,t,r,n,i,a,o){super(),D(this,"_initImagePopupMenu",/* @__PURE__ */new Set),this._injector=e,this._drawingManagerService=t,this._canvasPopManagerService=r,this._renderManagerService=n,this._univerInstanceService=i,this._contextService=a,this._uiPartsService=o,this._init()}_init(){this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe((0,w.takeUntil)(this.dispose$)).subscribe(e=>this._create(e)),this._univerInstanceService.getTypeOfUnitDisposed$(l.UniverInstanceType.UNIVER_SHEET).pipe((0,w.takeUntil)(this.dispose$)).subscribe(e=>this._dispose(e)),this._univerInstanceService.getAllUnitsForType(l.UniverInstanceType.UNIVER_SHEET).forEach(e=>this._create(e)),this._uiPartsService.registerComponent(p.BuiltInUIPart.CONTENT,()=>(0,l.connectInjector)(L,this._injector))}_dispose(e){let t=e.getUnitId();this._renderManagerService.removeRender(t)}_create(e){if(!e)return;let t=e.getUnitId();this._renderManagerService.has(t)&&!this._initImagePopupMenu.has(t)&&(this._popupMenuListener(t),this._initImagePopupMenu.add(t))}_hasCropObject(e){for(let t of e.getAllObjectsByOrder())if(t instanceof u.ImageCropperObject)return!0;return!1}_popupMenuListener(e){var t;let r;let n=null==(t=this._renderManagerService.getRenderById(e))?void 0:t.scene;if(!n)return;let i=n.getTransformerByCreate();i&&(this.disposeWithMe((0,l.toDisposable)(i.createControl$.subscribe(()=>{if(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._hasCropObject(n))return;let e=i.getSelectedObjectMap();if(e.size>1){null==r||r.dispose();return}let t=e.values().next().value;if(!t)return;let a=t.oKey,o=this._drawingManagerService.getDrawingOKey(a);if(!o)return;let{unitId:s,subUnitId:d,drawingId:c,drawingType:h}=o;null==r||r.dispose(),r=this.disposeWithMe(this._canvasPopManagerService.attachPopupToObject(t,{componentKey:u.COMPONENT_IMAGE_POPUP_MENU,direction:"horizontal",offset:[2,0],extraProps:{menuItems:this._getImageMenuItems(s,d,c,h)}})),this._drawingManagerService.focusDrawing([{unitId:s,subUnitId:d,drawingId:c}])}))),this.disposeWithMe(i.clearControl$.subscribe(()=>{null==r||r.dispose(),this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._drawingManagerService.focusDrawing(null)})),this.disposeWithMe(i.changing$.subscribe(()=>{null==r||r.dispose()})))}_getImageMenuItems(e,t,r,n){return[{label:"image-popup.edit",index:0,commandId:A.id,commandParams:{unitId:e,subUnitId:t,drawingId:r},disable:n===d.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.delete",index:1,commandId:P.id,commandParams:{unitId:e,drawings:[{unitId:e,subUnitId:t,drawingId:r}]},disable:!1},{label:"image-popup.crop",index:2,commandId:u.OpenImageCropOperation.id,commandParams:{unitId:e,subUnitId:t,drawingId:r},disable:n===d.DrawingTypeEnum.DRAWING_DOM},{label:"image-popup.reset",index:3,commandId:u.ImageResetSizeOperation.id,commandParams:[{unitId:e,subUnitId:t,drawingId:r}],disable:n===d.DrawingTypeEnum.DRAWING_DOM}]}},"DrawingPopupMenuController"),F);function W(e,t,r){let{from:n,to:i,flipY:a=!1,flipX:o=!1,angle:s=0,skewX:l=0,skewY:d=0}=e,{column:u,columnOffset:h,row:p,rowOffset:g}=n,{column:f,columnOffset:v,row:_,rowOffset:I}=i,S=r.getCurrentSkeleton(),C=(0,m.attachRangeWithCoord)(S,{startColumn:u,endColumn:u,startRow:p,endRow:p});if(null==C)return;let y=(0,m.attachRangeWithCoord)(S,{startColumn:f,endColumn:f,startRow:_,endRow:_});if(null==y)return;let{startX:w,startY:b}=C,{startX:R,startY:E}=y,T=(0,c.precisionTo)(w+h,1),M=(0,c.precisionTo)(b+g,1),O=(0,c.precisionTo)(R+v-T,1),D=(0,c.precisionTo)(E+I-M,1);C.startX===y.endX&&(O=0),C.startY===y.endY&&(D=0);let U=S.rowHeaderWidth+S.columnTotalWidth,k=S.columnHeaderHeight+S.rowTotalHeight;return T+O>U&&(T=U-O),M+D>k&&(M=k-D),{flipY:a,flipX:o,angle:s,skewX:l,skewY:d,left:T,top:M,width:O,height:D}}function G(e,t){let{left:r=0,top:n=0,width:i=0,height:a=0,flipY:o=!1,flipX:s=!1,angle:l=0,skewX:d=0,skewY:u=0}=e,h=t.getSelectionCellByPosition(r,n);if(null==h)return;let m={column:h.actualColumn,columnOffset:(0,c.precisionTo)(r-h.startX,1),row:h.actualRow,rowOffset:(0,c.precisionTo)(n-h.startY,1)},p=t.getSelectionCellByPosition(r+i,n+a);if(null!=p)return{flipY:o,flipX:s,angle:l,skewX:d,skewY:u,from:m,to:{column:p.actualColumn,columnOffset:(0,c.precisionTo)(r+i-p.startX,1),row:p.actualRow,rowOffset:(0,c.precisionTo)(n+a-p.startY,1)}}}B=H([$(0,(0,l.Inject)(l.Injector)),$(1,d.IDrawingManagerService),$(2,(0,l.Inject)(m.SheetCanvasPopManagerService)),$(3,c.IRenderManagerService),$(4,l.IUniverInstanceService),$(5,l.IContextService),$(6,(0,l.Inject)(p.IUIPartsService))],B),O(W,"drawingPositionToTransform"),O(G,"transformToDrawingPosition");var z,Y=Object.defineProperty,K=Object.getOwnPropertyDescriptor,q=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?K(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&Y(t,r,a),a},"__decorateClass$8"),X=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$8");let Q=(O(z=class extends l.Disposable{constructor(e,t,r,n,i){super(),this._context=e,this._sheetDrawingService=t,this._drawingManagerService=r,this._sheetSelectionRenderService=n,this._sheetSkeletonManagerService=i,this._init()}_init(){this._drawingInitializeListener()}_drawingInitializeListener(){this._sheetDrawingService.initializeNotification(this._context.unitId);let e=this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId);for(let t in e){let r=e[t];for(let e in r.data){let t=r.data[e];t.transform=W(t.sheetTransform,this._sheetSelectionRenderService,this._sheetSkeletonManagerService)}}this._drawingManagerService.registerDrawingData(this._context.unitId,this._sheetDrawingService.getDrawingDataForUnit(this._context.unitId)),this._drawingManagerService.initializeNotification(this._context.unitId)}},"SheetsDrawingRenderController"),z);Q=q([X(1,h.ISheetDrawingService),X(2,d.IDrawingManagerService),X(3,(0,l.Inject)(m.ISheetSelectionRenderService)),X(4,(0,l.Inject)(m.SheetSkeletonManagerService))],Q);var Z=function(){return(Z=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},J=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},ee=(0,R.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=J(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,R.useRef)("_".concat(ei()));return et(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},Z({ref:t,className:s},o),a)});function et(e,t,r,n,i){return(0,R.createElement)(e.tag,Z(Z({key:t},er(e,r,i)),n),(en(e,r).children||[]).map(function(n,a){return et(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function er(e,t,r){var n=Z({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function en(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?Z(Z({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?Z(Z({},e),{attrs:Z(Z({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function ei(){return Math.random().toString(36).substring(2,8)}O(et,"render"),O(er,"replaceRuntimeIdsAndExtInAttrs"),O(en,"replaceRuntimeIdsInDefs"),O(ei,"generateShortUuid"),ee.displayName="UniverIcon";var ea={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M2.2498 3.65005C2.2498 2.87685 2.87661 2.25005 3.64981 2.25005H7.9998C8.33118 2.25005 8.5998 1.98142 8.5998 1.65005C8.5998 1.31868 8.33118 1.05005 7.9998 1.05005H3.64981C2.21387 1.05005 1.0498 2.21411 1.0498 3.65005V12.35C1.0498 13.786 2.21386 14.95 3.6498 14.95H12.3498C13.7857 14.95 14.9498 13.786 14.9498 12.3501V8.00005C14.9498 7.66868 14.6812 7.40005 14.3498 7.40005C14.0184 7.40005 13.7498 7.66868 13.7498 8.00005V9.23974L12.2385 8.1063C11.7252 7.72129 11.0068 7.7723 10.5531 8.22605L9.00869 9.77041L6.73916 7.8251C6.24387 7.40055 5.5095 7.41278 5.02864 7.85359L2.2498 10.4009V3.65005ZM2.2498 12.0287V12.35C2.2498 13.1232 2.87661 13.75 3.6498 13.75H12.3498C13.123 13.75 13.7498 13.1232 13.7498 12.3501V10.7397L11.5186 9.06631C11.4829 9.03956 11.433 9.04314 11.4016 9.07458L9.92249 10.5537L11.1015 11.5642C11.3531 11.7799 11.3822 12.1587 11.1666 12.4103C10.9509 12.6619 10.5721 12.691 10.3205 12.4753L5.9582 8.7362C5.92384 8.70674 5.87288 8.70758 5.83952 8.73816L2.2498 12.0287Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M11.8097 1.14783C12.1411 1.14783 12.4097 1.41646 12.4097 1.74783V3.297H14.1541C14.4855 3.297 14.7541 3.56563 14.7541 3.897C14.7541 4.22837 14.4855 4.497 14.1541 4.497H12.4097V6.24167C12.4097 6.57304 12.1411 6.84167 11.8097 6.84167C11.4783 6.84167 11.2097 6.57304 11.2097 6.24167V4.497H9.6603C9.32893 4.497 9.0603 4.22837 9.0603 3.897C9.0603 3.56563 9.32893 3.297 9.6603 3.297H11.2097V1.74783C11.2097 1.41646 11.4783 1.14783 11.8097 1.14783Z"}}]},eo=(0,R.forwardRef)(function(e,t){return(0,R.createElement)(ee,Object.assign({},e,{id:"add-image-single",ref:t,icon:ea}))});eo.displayName="AddImageSingle";let es={id:"sheet.command.delete-drawing",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O(e=>{let t=e.get(l.ICommandService),r=e.get(h.ISheetDrawingService).getFocusDrawings();if(0===r.length)return!1;let n=r[0].unitId,i=r.map(e=>{let{unitId:t,subUnitId:r,drawingId:n,drawingType:i}=e;return{unitId:t,subUnitId:r,drawingId:n,drawingType:i}});return t.executeCommand(P.id,{unitId:n,drawings:i})},"handler")};function el(e){let t=[];return e.forEach(e=>{let{parent:r,children:n}=e,{unitId:i,subUnitId:a,drawingId:o}=r,s=(0,c.getGroupState)(0,0,n.map(e=>e.transform||{})),l=n.map(e=>{let t=e.transform||{left:0,top:0},{unitId:r,subUnitId:n,drawingId:i}=e;return{unitId:r,subUnitId:n,drawingId:i,transform:{...t,left:t.left-s.left,top:t.top-s.top},groupId:o}}),u={unitId:i,subUnitId:a,drawingId:o,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:s};t.push({parent:u,children:l})}),t}function ed(e){let t=[];return e.forEach(e=>{let{parent:r,children:n}=e,{unitId:i,subUnitId:a,drawingId:o,transform:s={width:0,height:0}}=r;if(null==s)return;let l=n.map(e=>{let{transform:t}=e,{unitId:r,subUnitId:n,drawingId:i}=e;return{unitId:r,subUnitId:n,drawingId:i,transform:(0,c.transformObjectOutOfGroup)(t||{},s,s.width||0,s.height||0),groupId:void 0}}),u={unitId:i,subUnitId:a,drawingId:o,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:{left:0,top:0}};t.push({parent:u,children:l})}),t}O(el,"ungroupToGroup"),O(ed,"groupToUngroup");let eu={id:"sheet.command.group-sheet-image",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(l.ICommandService),n=e.get(l.IUndoRedoService),i=e.get(h.ISheetDrawingService);if(!t)return!1;let a=[];t.forEach(({parent:e,children:t})=>{a.push(e.unitId),t.forEach(e=>{a.push(e.unitId)})});let{unitId:o,subUnitId:s,undo:d,redo:u,objects:c}=i.getGroupDrawingOp(t);return!!r.syncExecuteCommand(h.SetDrawingApplyMutation.id,{op:u,unitId:o,subUnitId:s,objects:c,type:h.DrawingApplyType.GROUP})&&(n.pushUndoRedo({unitID:o,undoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:d,unitId:o,subUnitId:s,objects:ed(c),type:h.DrawingApplyType.UNGROUP}},{id:k.id,params:a}],redoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:u,unitId:o,subUnitId:s,objects:c,type:h.DrawingApplyType.GROUP}},{id:k.id,params:a}]}),!0)},"handler")},ec={id:"sheet.command.insert-sheet-image",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(l.ICommandService),n=e.get(l.IUndoRedoService),i=e.get(h.ISheetDrawingService);if(!t)return!1;let a=t.drawings,o=a.map(e=>e.unitId),{unitId:s,subUnitId:d,undo:u,redo:c,objects:m}=i.getBatchAddOp(a);return!!r.syncExecuteCommand(h.SetDrawingApplyMutation.id,{op:c,unitId:s,subUnitId:d,objects:m,type:h.DrawingApplyType.INSERT})&&(n.pushUndoRedo({unitID:s,undoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:u,unitId:s,subUnitId:d,objects:m,type:h.DrawingApplyType.REMOVE}},{id:k.id,params:o}],redoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:c,unitId:s,subUnitId:d,objects:m,type:h.DrawingApplyType.INSERT}},{id:k.id,params:o}]}),!0)},"handler")},eh={id:"sheet.command.set-drawing-arrange",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O((e,t)=>{let r;let n=e.get(l.ICommandService),i=e.get(l.IUndoRedoService);if(!t)return!1;let a=e.get(h.ISheetDrawingService),{unitId:o,subUnitId:s,drawingIds:u,arrangeType:c}=t,m={unitId:o,subUnitId:s,drawingIds:u};if(c===d.ArrangeTypeEnum.forward?r=a.getForwardDrawingsOp(m):c===d.ArrangeTypeEnum.backward?r=a.getBackwardDrawingOp(m):c===d.ArrangeTypeEnum.front?r=a.getFrontDrawingsOp(m):c===d.ArrangeTypeEnum.back&&(r=a.getBackDrawingsOp(m)),null==r)return!1;let{objects:p,redo:g,undo:f}=r;return!!n.syncExecuteCommand(h.SetDrawingApplyMutation.id,{op:g,unitId:o,subUnitId:s,objects:p,type:h.DrawingApplyType.ARRANGE})&&(i.pushUndoRedo({unitID:o,undoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:f,unitId:o,subUnitId:s,objects:p,type:h.DrawingApplyType.ARRANGE}}],redoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:g,unitId:o,subUnitId:s,objects:p,type:h.DrawingApplyType.ARRANGE}}]}),!0)},"handler")},em={id:"sheet.command.set-sheet-image",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(l.ICommandService),n=e.get(l.IUndoRedoService),i=e.get(h.ISheetDrawingService);if(!t)return!1;let{drawings:a}=t,{unitId:o,subUnitId:s,undo:d,redo:u,objects:c}=i.getBatchUpdateOp(a);return!!r.syncExecuteCommand(h.SetDrawingApplyMutation.id,{unitId:o,subUnitId:s,op:u,objects:c,type:h.DrawingApplyType.UPDATE})&&(n.pushUndoRedo({unitID:o,undoMutations:[{id:h.SetDrawingApplyMutation.id,params:{unitId:o,subUnitId:s,op:d,objects:c,type:h.DrawingApplyType.UPDATE}},{id:k.id,params:[o]}],redoMutations:[{id:h.SetDrawingApplyMutation.id,params:{unitId:o,subUnitId:s,op:u,objects:c,type:h.DrawingApplyType.UPDATE}},{id:k.id,params:[o]}]}),!0)},"handler")},ep={id:"sheet.command.ungroup-sheet-image",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(l.ICommandService),n=e.get(l.IUndoRedoService),i=e.get(h.ISheetDrawingService);if(!t)return!1;let a=[];t.forEach(({parent:e,children:t})=>{a.push(e.unitId),t.forEach(e=>{a.push(e.unitId)})});let{unitId:o,subUnitId:s,undo:d,redo:u,objects:c}=i.getUngroupDrawingOp(t);return!!r.syncExecuteCommand(h.SetDrawingApplyMutation.id,{op:u,unitId:o,subUnitId:s,objects:c,type:h.DrawingApplyType.UNGROUP})&&(n.pushUndoRedo({unitID:o,undoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:d,unitId:o,subUnitId:s,objects:el(c),type:h.DrawingApplyType.GROUP}},{id:k.id,params:a}],redoMutations:[{id:h.SetDrawingApplyMutation.id,params:{op:u,unitId:o,subUnitId:s,objects:c,type:h.DrawingApplyType.UNGROUP}},{id:k.id,params:a}]}),!0)},"handler")};var eg,ef=Object.defineProperty,ev=Object.getOwnPropertyDescriptor,e_=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ev(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ef(t,r,a),a},"__decorateClass$7"),eI=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$7");let eS=(O(eg=class extends l.Disposable{constructor(e,t,r,n,i,a,o,s,l,d,u,c){super(),D(this,"_workbookSelections"),this._context=e,this._skeletonManagerService=t,this._commandService=r,this._selectionRenderService=n,this._imageIoService=i,this._fileOpenerService=a,this._sheetDrawingService=o,this._drawingManagerService=s,this._contextService=l,this._messageService=d,this._localeService=u,this._workbookSelections=c.getWorkbookSelections(this._context.unitId),this._updateImageListener(),this._updateOrderListener(),this._groupDrawingListener(),this._focusDrawingListener()}async insertFloatImage(){let e=await this._fileOpenerService.openFile({multiple:!0,accept:(0,d.DRAWING_IMAGE_ALLOW_IMAGE_LIST).map(e=>`.${e.replace("image/","")}`).join(",")}),t=e.length;return t>d.DRAWING_IMAGE_COUNT_LIMIT?(this._messageService.show({type:E.MessageType.Error,content:this._localeService.t("update-status.exceedMaxCount",String(d.DRAWING_IMAGE_COUNT_LIMIT))}),!1):0!==t&&(e.forEach(async e=>await this._insertFloatImage(e)),!0)}async _insertFloatImage(e){let t;try{t=await this._imageIoService.saveImage(e)}catch(t){let e=t.message;e===d.ImageUploadStatusType.ERROR_EXCEED_SIZE?this._messageService.show({type:E.MessageType.Error,content:this._localeService.t("update-status.exceedMaxSize",String(d.DRAWING_IMAGE_ALLOW_SIZE/1048576))}):e===d.ImageUploadStatusType.ERROR_IMAGE_TYPE?this._messageService.show({type:E.MessageType.Error,content:this._localeService.t("update-status.invalidImageType")}):e===d.ImageUploadStatusType.ERROR_IMAGE&&this._messageService.show({type:E.MessageType.Error,content:this._localeService.t("update-status.invalidImage")})}if(null==t)return;let{unitId:r,subUnitId:n}=this._getUnitInfo(),{imageId:i,imageSourceType:a,source:o,base64Cache:s}=t,{width:l,height:u,image:c}=await (0,d.getImageSize)(s||""),{width:h,height:m}=this._context.scene;this._imageIoService.addImageSourceCache(o,a,c);let p=1;(l>d.DRAWING_IMAGE_WIDTH_LIMIT||u>d.DRAWING_IMAGE_HEIGHT_LIMIT)&&(p=Math.max(d.DRAWING_IMAGE_WIDTH_LIMIT/l,d.DRAWING_IMAGE_HEIGHT_LIMIT/u));let g=this._getImagePosition(l*p,u*p,h,m);if(null==g)return;let f={unitId:r,subUnitId:n,drawingId:i,drawingType:d.DrawingTypeEnum.DRAWING_IMAGE,imageSourceType:a,source:o,transform:W(g,this._selectionRenderService,this._skeletonManagerService),sheetTransform:g};this._commandService.executeCommand(ec.id,{unitId:r,drawings:[f]})}_getUnitInfo(){let e=this._context.unit,t=e.getActiveSheet();return{unitId:e.getUnitId(),subUnitId:t.getSheetId()}}_getImagePosition(e,t,r,n){let i=this._workbookSelections.getCurrentSelections(),a={startRow:0,endRow:0,startColumn:0,endColumn:0};i&&i.length>0&&(a=i[i.length-1].range);let o=(0,m.attachRangeWithCoord)(this._skeletonManagerService.getCurrent().skeleton,a);if(null==o)return;let{startColumn:s,startRow:l,startX:d,startY:u}=o,c=!1;if(d+e>r&&((d=r-e)<0&&(d=0,e=r),c=!0),u+t>n&&((u=n-t)<0&&(u=0,t=n),c=!0),c){let e=this._selectionRenderService.getSelectionCellByPosition(d,u);if(null==e)return;d=e.startX,u=e.startY,s=e.actualColumn,l=e.actualRow}let h={column:s,columnOffset:0,row:l,rowOffset:0},p=this._selectionRenderService.getSelectionCellByPosition(d+e,u+t);if(null!=p)return{from:h,to:{column:p.actualColumn,columnOffset:d+e-p.startX,row:p.actualRow,rowOffset:u+t-p.startY}}}_updateOrderListener(){this._drawingManagerService.featurePluginOrderUpdate$.subscribe(e=>{let{unitId:t,subUnitId:r,drawingIds:n,arrangeType:i}=e;this._commandService.executeCommand(eh.id,{unitId:t,subUnitId:r,drawingIds:n,arrangeType:i})})}_updateImageListener(){this._drawingManagerService.featurePluginUpdate$.subscribe(e=>{let t=[];0!==e.length&&(e.forEach(e=>{let{unitId:r,subUnitId:n,drawingId:i,drawingType:a,transform:o}=e;if(null==o)return;let s=this._sheetDrawingService.getDrawingByParam({unitId:r,subUnitId:n,drawingId:i});if(null==s||s.unitId!==this._context.unitId)return;let l=G({...s.transform,...o},this._selectionRenderService);if(null==l)return;let d={...e,transform:{...s.transform,...o,...W(l,this._selectionRenderService,this._skeletonManagerService)},sheetTransform:{...l}};t.push(d)}),t.length>0&&this._commandService.executeCommand(em.id,{unitId:e[0].unitId,drawings:t}))})}_groupDrawingListener(){this._drawingManagerService.featurePluginGroupUpdate$.subscribe(e=>{this._commandService.executeCommand(eu.id,e);let{unitId:t,subUnitId:r,drawingId:n}=e[0].parent;this._drawingManagerService.focusDrawing([{unitId:t,subUnitId:r,drawingId:n}])}),this._drawingManagerService.featurePluginUngroupUpdate$.subscribe(e=>{this._commandService.executeCommand(ep.id,e)})}_focusDrawingListener(){this.disposeWithMe(this._drawingManagerService.focus$.subscribe(e=>{null==e||0===e.length?(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!1),this._sheetDrawingService.focusDrawing([])):(this._contextService.setContextValue(l.FOCUSING_COMMON_DRAWINGS,!0),this._sheetDrawingService.focusDrawing(e))}))}},"SheetDrawingUpdateController"),eg);eS=e_([eI(1,(0,l.Inject)(m.SheetSkeletonManagerService)),eI(2,l.ICommandService),eI(3,m.ISheetSelectionRenderService),eI(4,d.IImageIoService),eI(5,p.ILocalFileService),eI(6,h.ISheetDrawingService),eI(7,d.IDrawingManagerService),eI(8,l.IContextService),eI(9,p.IMessageService),eI(10,(0,l.Inject)(l.LocaleService)),eI(11,(0,l.Inject)(b.SheetsSelectionsService))],eS);let eC={id:"sheet.command.insert-float-image",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O(e=>{var t,r;return null!=(r=null==(t=e.get(c.IRenderManagerService).getCurrentTypeOfRenderer(l.UniverInstanceType.UNIVER_SHEET))?void 0:t.with(eS).insertFloatImage())&&r},"handler")},ey={id:"sheet.command.move-drawing",type:l.CommandType.COMMAND,handler:/* @__PURE__ */O((e,t)=>{let r=e.get(l.ICommandService),n=e.get(h.ISheetDrawingService),i=e.get(m.ISheetSelectionRenderService),{direction:a}=t,o=n.getFocusDrawings();if(0===o.length)return!1;let s=o[0].unitId,d=o.map(e=>{let{transform:t}=e;if(null==t)return null;let r={...t},{left:n=0,top:o=0}=t;return a===l.Direction.UP?r.top=o-1:a===l.Direction.DOWN?r.top=o+1:a===l.Direction.LEFT?r.left=n-1:a===l.Direction.RIGHT&&(r.left=n+1),{...e,transform:r,sheetTransform:G(r,i)}}).filter(e=>null!=e);return!!r.syncExecuteCommand(em.id,{unitId:s,drawings:d})&&(r.syncExecuteCommand(k.id,[s]),!0)},"handler")},ew="addition-and-subtraction-single",eb="sheet.menu.image";function eR(e){return{id:eb,type:p.MenuItemType.SUBITEMS,icon:ew,tooltip:"sheetImage.title",hidden$:(0,p.getMenuHiddenObservable)(e,l.UniverInstanceType.UNIVER_SHEET),disabled$:(0,m.getCurrentRangeDisable$)(e,{workbookTypes:[b.WorkbookEditablePermission],worksheetTypes:[b.WorksheetEditPermission],rangeTypes:[b.RangeProtectionPermissionEditPoint]})}}function eE(e){return{id:eC.id,title:"sheetImage.upload.float",type:p.MenuItemType.BUTTON,hidden$:(0,p.getMenuHiddenObservable)(e,l.UniverInstanceType.UNIVER_SHEET)}}O(eR,"ImageMenuFactory"),O(eE,"UploadFloatImageMenuFactory");let eT={imageCommonPanel:"univer-image-common-panel",imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelColumn:"univer-image-common-panel-column"};function eM(e){var t,r,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e){if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(r=eM(e[t]))&&(n&&(n+=" "),n+=r)}else for(r in e)e[r]&&(n&&(n+=" "),n+=r)}return n}function eO(){for(var e,t,r=0,n="",i=arguments.length;r<i;r++)(e=arguments[r])&&(t=eM(e))&&(n&&(n+=" "),n+=t);return n}O(eM,"r"),O(eO,"clsx");let eD=/* @__PURE__ */O(e=>{var r;let n=(0,l.useDependency)(l.ICommandService),i=(0,l.useDependency)(l.LocaleService),a=(0,l.useDependency)(d.IDrawingManagerService),o=(0,l.useDependency)(c.IRenderManagerService),{drawings:s}=e,u=s[0];if(null==u)return;let{unitId:m}=u,p=o.getRenderById(m),g=null==p?void 0:p.scene;if(null==g)return;let f=g.getTransformerByCreate(),[v,_]=(0,R.useState)(!0),I=null!=(r=u.anchorType)?r:h.SheetDrawingAnchorType.Position,[S,C]=(0,R.useState)(I);function y(e,t){let r=[];return e.forEach(e=>{let{oKey:n}=e,i=t.getDrawingOKey(n);if(null==i)return r.push(null),!0;let{unitId:a,subUnitId:o,drawingId:s,drawingType:l,anchorType:d,sheetTransform:u}=i;r.push({unitId:a,subUnitId:o,drawingId:s,anchorType:d,sheetTransform:u,drawingType:l})}),r}function w(e){C(e);let t=a.getFocusDrawings();if(0===t.length)return;let r=t.map(t=>({unitId:t.unitId,subUnitId:t.subUnitId,drawingId:t.drawingId,anchorType:e}));n.executeCommand(em.id,{unitId:t[0].unitId,drawings:r})}O(y,"getUpdateParams"),(0,R.useEffect)(()=>{let e=f.clearControl$.subscribe(e=>{!0===e&&_(!1)}),t=f.changeStart$.subscribe(e=>{var t;let{objects:r}=e,n=y(r,a);0===n.length?_(!1):n.length>=1&&(_(!0),C((null==(t=n[0])?void 0:t.anchorType)||h.SheetDrawingAnchorType.Position))});return()=>{t.unsubscribe(),e.unsubscribe()}},[]),O(w,"handleChange");let b=/* @__PURE__ */O(e=>e?"block":"none","gridDisplay");return /* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:eO(eT.imageCommonPanelGrid,eT.imageCommonPanelBorder),style:{display:b(v)}},/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:eT.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:eO(eT.imageCommonPanelColumn,eT.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",null,i.t("drawing-anchor.title")))),/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:eO(eT.imageCommonPanelRow)},/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:eO(eT.imageCommonPanelColumn)},/* @__PURE__ *//*@__PURE__*/t(R).createElement(E.RadioGroup,{value:S,onChange:w,direction:"vertical"},/* @__PURE__ *//*@__PURE__*/t(R).createElement(E.Radio,{value:h.SheetDrawingAnchorType.Both},i.t("drawing-anchor.both")),/* @__PURE__ *//*@__PURE__*/t(R).createElement(E.Radio,{value:h.SheetDrawingAnchorType.Position},i.t("drawing-anchor.position")),/* @__PURE__ *//*@__PURE__*/t(R).createElement(E.Radio,{value:h.SheetDrawingAnchorType.None},i.t("drawing-anchor.none"))))))},"SheetDrawingAnchor"),eU=/* @__PURE__ */O(()=>{let e=(0,l.useDependency)(d.IDrawingManagerService),r=e.getFocusDrawings(),[n,i]=(0,R.useState)(r);return(0,R.useEffect)(()=>{let t=e.focus$.subscribe(e=>{i(e)});return()=>{t.unsubscribe()}},[]),!!(null!=n&&n.length)&&/* @__PURE__ *//*@__PURE__*/t(R).createElement("div",{className:eT.imageCommonPanel},/* @__PURE__ *//*@__PURE__*/t(R).createElement(u.DrawingCommonPanel,{drawings:n}),/* @__PURE__ *//*@__PURE__*/t(R).createElement(eD,{drawings:n}))},"SheetDrawingPanel"),ek={[p.RibbonStartGroup.FORMULAS_INSERT]:{[eb]:{order:3,menuItemFactory:eR,[eC.id]:{order:0,menuItemFactory:eE}}}};function eP(e){return!e.getContextValue(l.FOCUSING_FX_BAR_EDITOR)&&!e.getContextValue(l.EDITOR_ACTIVATED)&&e.getContextValue(l.FOCUSING_COMMON_DRAWINGS)}O(eP,"whenSheetDrawingFocused");let eN={id:ey.id,description:"shortcut.sheet.drawing-move-down",group:"4_sheet-drawing-view",binding:p.KeyCode.ARROW_DOWN,priority:100,preconditions:eP,staticParameters:{direction:l.Direction.DOWN}},ex={id:ey.id,description:"shortcut.sheet.drawing-move-up",group:"4_sheet-drawing-view",binding:p.KeyCode.ARROW_UP,priority:100,preconditions:eP,staticParameters:{direction:l.Direction.UP}},eA={id:ey.id,description:"shortcut.sheet.drawing-move-left",group:"4_sheet-drawing-view",binding:p.KeyCode.ARROW_LEFT,priority:100,preconditions:eP,staticParameters:{direction:l.Direction.LEFT}},eL={id:ey.id,description:"shortcut.sheet.drawing-move-right",group:"4_sheet-drawing-view",binding:p.KeyCode.ARROW_RIGHT,priority:100,preconditions:eP,staticParameters:{direction:l.Direction.RIGHT}},eF={id:es.id,description:"shortcut.sheet.drawing-delete",group:"4_sheet-drawing-view",preconditions:eP,binding:p.KeyCode.DELETE,mac:p.KeyCode.BACKSPACE};var ej,eV=Object.defineProperty,eH=Object.getOwnPropertyDescriptor,e$=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eH(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eV(t,r,a),a},"__decorateClass$6"),eB=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$6");let eW=(O(ej=class extends l.Disposable{constructor(e,t,r,n){super(),this._componentManager=e,this._menuManagerService=t,this._commandService=r,this._shortcutService=n,this._init()}_initCustomComponents(){let e=this._componentManager;this.disposeWithMe(e.register(ew,eo)),this.disposeWithMe(e.register(N,eU))}_initMenus(){this._menuManagerService.mergeMenu(ek)}_initCommands(){[eC,ec,P,em,x,k,A,eu,ep,ey,es,eh].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_initShortcuts(){[eN,ex,eA,eL,eF].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_init(){this._initCommands(),this._initCustomComponents(),this._initMenus(),this._initShortcuts()}},"SheetDrawingUIController"),ej);eW=e$([eB(0,(0,l.Inject)(p.ComponentManager)),eB(1,p.IMenuManagerService),eB(2,l.ICommandService),eB(3,p.IShortcutService)],eW);var eG,ez=Object.defineProperty,eY=Object.getOwnPropertyDescriptor,eK=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eY(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ez(t,r,a),a},"__decorateClass$5"),eq=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let eX=(eG=class extends l.Disposable{constructor(e,t,r){super(),D(this,"_copyInfo"),this._sheetClipboardService=e,this._renderManagerService=t,this._sheetDrawingService=r,this._initCopyPaste()}_initCopyPaste(){this._sheetClipboardService.addClipboardHook({id:"SHEET_IMAGE_UI_PLUGIN",onBeforeCopy:/* @__PURE__ */O((e,t,r)=>this._collect(e,t,r),"onBeforeCopy"),onPasteCells:/* @__PURE__ */O((e,t,r,n)=>{let{copyType:i=m.COPY_TYPE.COPY,pasteType:a}=n,{range:o}=e||{},{range:s,unitId:l,subUnitId:d}=t;return this._generateMutations(s,{copyType:i,pasteType:a,copyRange:o,unitId:l,subUnitId:d})},"onPasteCells"),onPastePlainText:/* @__PURE__ */O((e,t)=>({undos:[],redos:[]}),"onPastePlainText")})}_collect(e,t,r){var n;let i=null==(n=this._renderManagerService.getRenderById(e))?void 0:n.with(m.SheetSkeletonManagerService);if(!i)return;let a=i.attachRangeWithCoord(r);if(!a)return;let{startX:o,endX:s,startY:l,endY:d}=a,u=this._sheetDrawingService.getDrawingData(e,t),c=[];Object.keys(u).forEach(e=>{let t=u[e],{transform:r}=t;if(t.anchorType!==h.SheetDrawingAnchorType.Both||!r)return;let{left:n=0,top:i=0,width:a=0,height:m=0}=r,{drawingStartX:p,drawingEndX:g,drawingStartY:f,drawingEndY:v}={drawingStartX:n,drawingEndX:n+a,drawingStartY:i,drawingEndY:i+m};o<=p&&g<=s&&l<=f&&v<=d&&c.push(t)}),c.length&&(this._copyInfo={drawings:c,unitId:e,subUnitId:t})}_generateMutations(e,t){var r;if(!this._copyInfo||[(0,m.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_COL_WIDTH,(0,m.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_VALUE,(0,m.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMAT,(0,m.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMULA].includes(t.pasteType))return{redos:[],undos:[]};let{copyRange:n}=t;if(!n)return{redos:[],undos:[]};let{drawings:i,unitId:a,subUnitId:o}=this._copyInfo,{ranges:[s,d],mapFunc:u}=(0,m.virtualizeDiscreteRanges)([n,e]),{row:c,col:p}=u(s.startRow,s.startColumn),{row:g,col:f}=u(d.startRow,d.startColumn),v=null==(r=this._renderManagerService.getRenderById(a))?void 0:r.with(m.SheetSkeletonManagerService);if(!v)return{redos:[],undos:[]};let _=v.attachRangeWithCoord({startRow:c,endRow:c,startColumn:p,endColumn:p}),I=v.attachRangeWithCoord({startRow:g,endRow:g,startColumn:f,endColumn:f});if(!_||!I)return{redos:[],undos:[]};let S=[],C=[],y=I.startX-_.startX,w=I.startY-_.startY,b=g-c,R=f-p,E=t.copyType===m.COPY_TYPE.CUT,{_sheetDrawingService:T}=this;return i.forEach(e=>{let{transform:t,sheetTransform:r}=e;if(!t)return;let n={...e,unitId:a,subUnitId:o,drawingId:E?e.drawingId:(0,l.Tools).generateRandomId(),transform:{...t,left:t.left+y,top:t.top+w},sheetTransform:{to:{...r.to,row:r.to.row+b,column:r.to.column+R},from:{...r.from,row:r.from.row+b,column:r.from.column+R}}};if(E){let{undo:e,redo:t,objects:r}=T.getBatchUpdateOp([n]);S.push({id:h.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:o,type:h.DrawingApplyType.UPDATE,op:t,objects:r}}),C.push({id:h.SetDrawingApplyMutation.id,params:{unitId:a,subUnitId:o,type:h.DrawingApplyType.UPDATE,op:e,objects:r}})}else{let{undo:e,redo:t,objects:r}=T.getBatchAddOp([n]);S.push({id:h.SetDrawingApplyMutation.id,params:{op:t,unitId:a,subUnitId:o,objects:r,type:h.DrawingApplyType.INSERT}}),C.push({id:h.SetDrawingApplyMutation.id,params:{op:e,unitId:a,subUnitId:o,objects:r,type:h.DrawingApplyType.REMOVE}})}}),{redos:S,undos:C}}},O(eG,"SheetsDrawingCopyPasteController"),eG);eX=eK([eq(0,m.ISheetClipboardService),eq(1,c.IRenderManagerService),eq(2,h.ISheetDrawingService)],eX);var eQ,eZ=Object.defineProperty,eJ=Object.getOwnPropertyDescriptor,e1=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eJ(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eZ(t,r,a),a},"__decorateClass$4"),e0=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let e3=(eQ=class extends l.Disposable{constructor(e,t,r,n,i){super(),this._drawingManagerService=e,this._renderManagerService=t,this._permissionService=r,this._univerInstanceService=n,this._userManagerService=i,this._initDrawingVisible(),this._initDrawingEditable(),this._initViewPermissionChange(),this._initEditPermissionChange()}_initDrawingVisible(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,f.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{if(!e){this._drawingManagerService.setDrawingVisible(!1);return}e.activeSheet$.subscribe(t=>{if(!t){this._drawingManagerService.setDrawingVisible(!1);return}let r=e.getUnitId(),n=t.getSheetId();if(this._permissionService.composePermission([new b.WorkbookViewPermission(r).id,new b.WorksheetViewPermission(r,n).id]).every(e=>e.value))this._drawingManagerService.setDrawingVisible(!0);else{this._drawingManagerService.setDrawingVisible(!1);let r=e.getUnitId(),n=t.getSheetId(),i=Object.values(this._drawingManagerService.getDrawingData(r,n)),a=this._renderManagerService.getRenderById(r),o=null==a?void 0:a.scene;if(null==o)return;o.getAllObjectsByOrder().forEach(e=>{e.classType===c.RENDER_CLASS_TYPE.IMAGE&&i.some(t=>e.oKey.includes(t.drawingId))&&o.removeObject(e)})}})}))}_initDrawingEditable(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,f.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{if(!e){this._drawingManagerService.setDrawingEditable(!1);return}e.activeSheet$.subscribe(t=>{if(!t){this._drawingManagerService.setDrawingEditable(!1);return}let r=e.getUnitId(),n=t.getSheetId();if(this._permissionService.composePermission([new b.WorkbookEditablePermission(r).id,new b.WorksheetEditPermission(r,n).id]).every(e=>e.value))this._drawingManagerService.setDrawingEditable(!0);else{this._drawingManagerService.setDrawingEditable(!1);let r=e.getUnitId(),n=t.getSheetId(),i=Object.values(this._drawingManagerService.getDrawingData(r,n)),a=this._renderManagerService.getRenderById(r),o=null==a?void 0:a.scene;if(null==o)return;o.getAllObjectsByOrder().forEach(e=>{e.classType===c.RENDER_CLASS_TYPE.IMAGE&&i.some(t=>e.oKey.includes(t.drawingId))&&o.detachTransformerFrom(e)})}})}))}_initViewPermissionChange(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,f.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{e&&e.activeSheet$.subscribe(t=>{var r;if(!t)return;let n=e.getUnitId(),i=t.getSheetId(),a=!0,o=this._renderManagerService.getRenderById(n),s=null==o?void 0:o.scene;if(null==s)return;let l=s.getTransformerByCreate(),d=this._permissionService.composePermission$([new b.WorkbookViewPermission(n).id,new b.WorksheetViewPermission(n,i).id]).pipe((0,I.map)(e=>e.every(e=>e.value)));null==d||d.pipe((0,_.filter)(e=>e!==a),(0,v.distinctUntilChanged)()).subscribe({next:/* @__PURE__ */O(e=>{a=e,this._drawingManagerService.setDrawingVisible(e);let t=s.getAllObjectsByOrder(),r=Object.values(this._drawingManagerService.getDrawingData(n,i));e?this._drawingManagerService.addNotification(r):(t.forEach(e=>{e.classType===c.RENDER_CLASS_TYPE.IMAGE&&r.some(t=>e.oKey.includes(t.drawingId))&&s.removeObject(e)}),l.clearSelectedObjects())},"next")}),null==(r=this._permissionService.getPermissionPoint$(new b.WorksheetViewPermission(n,i).id))||r.pipe((0,_.filter)(e=>e.value!==a),(0,v.distinctUntilChanged)()).subscribe({complete:/* @__PURE__ */O(()=>{a=!0,this._drawingManagerService.setDrawingVisible(!0);let e=Object.values(this._drawingManagerService.getDrawingData(n,i));this._drawingManagerService.addNotification(e)},"complete")})})}))}_initEditPermissionChange(){let e=this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET);this.disposeWithMe((0,f.combineLatest)([e,this._userManagerService.currentUser$]).subscribe(([e,t])=>{e&&e.activeSheet$.subscribe(t=>{var r;if(!t)return;let n=e.getUnitId(),i=t.getSheetId(),a=!0,o=this._renderManagerService.getRenderById(n),s=null==o?void 0:o.scene;if(null==s)return;let l=s.getTransformerByCreate(),d=this._permissionService.composePermission$([new b.WorkbookEditablePermission(n).id,new b.WorksheetEditPermission(n,i).id]).pipe((0,I.map)(e=>e.every(e=>e.value)));null==d||d.pipe((0,_.filter)(e=>e!==a),(0,v.distinctUntilChanged)()).subscribe({next:/* @__PURE__ */O(e=>{a=e,this._drawingManagerService.setDrawingEditable(e);let t=s.getAllObjectsByOrder(),r=Object.values(this._drawingManagerService.getDrawingData(n,i));e?(t.forEach(e=>{e.classType===c.RENDER_CLASS_TYPE.IMAGE&&r.some(t=>e.oKey.includes(t.drawingId))&&s.attachTransformerTo(e)}),this._drawingManagerService.addNotification(r)):(t.forEach(e=>{e.classType===c.RENDER_CLASS_TYPE.IMAGE&&r.some(t=>e.oKey.includes(t.drawingId))&&s.detachTransformerFrom(e)}),l.clearSelectedObjects())},"next")}),null==(r=this._permissionService.getPermissionPoint$(new b.WorksheetEditPermission(n,i).id))||r.pipe((0,_.filter)(e=>e.value!==a),(0,v.distinctUntilChanged)()).subscribe({complete:/* @__PURE__ */O(()=>{a=!0;let r=e.getUnitId(),n=t.getSheetId(),i=Object.values(this._drawingManagerService.getDrawingData(r,n)),o=this._renderManagerService.getRenderById(r),s=null==o?void 0:o.scene;null!=s&&(this._drawingManagerService.setDrawingEditable(!0),s.getAllObjectsByOrder().forEach(e=>{e.classType===c.RENDER_CLASS_TYPE.IMAGE&&i.some(t=>e.oKey.includes(t.drawingId))&&s.detachTransformerFrom(e)}))},"complete")})})}))}},O(eQ,"SheetDrawingPermissionController"),eQ);e3=e1([e0(0,d.IDrawingManagerService),e0(1,c.IRenderManagerService),e0(2,l.IPermissionService),e0(3,l.IUniverInstanceService),e0(4,(0,l.Inject)(l.UserManagerService))],e3);var e2,e4=Object.defineProperty,e6=Object.getOwnPropertyDescriptor,e9=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?e6(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e4(t,r,a),a},"__decorateClass$3"),e5=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let e8=(e2=class extends l.Disposable{constructor(e,t,r,n){super(),this._sheetPrintInterceptorService=e,this._drawingRenderService=t,this._drawingManagerService=r,this._renderManagerService=n,this._initPrinting()}_initPrinting(){this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_COMPONENT_COLLECT,{handler:/* @__PURE__ */O((e,t,r)=>{let{unitId:n,scene:i,subUnitId:a}=t,o=this._drawingManagerService.getDrawingDataForUnit(n),s=null==o?void 0:o[a];return s&&s.order.forEach(e=>{this._drawingRenderService.renderDrawing(s.data[e],i)}),r()},"handler")})),this.disposeWithMe(this._sheetPrintInterceptorService.interceptor.intercept(this._sheetPrintInterceptorService.interceptor.getInterceptPoints().PRINTING_RANGE,{handler:/* @__PURE__ */O((e,t,r)=>{let{unitId:n,subUnitId:i}=t,a=this._renderManagerService.getRenderById(n);if(!a)return r(e);let o=a.with(m.SheetSkeletonManagerService).getWorksheetSkeleton(i);if(!o)return r(e);let s=this._drawingManagerService.getDrawingDataForUnit(n),u=null==s?void 0:s[t.subUnitId];if(!u)return r(e);let{scaleX:c,scaleY:h}=a.scene,p=e?{...e}:{startColumn:0,endColumn:0,endRow:0,startRow:0},g=u.order.map(e=>u.data[e]).filter(e=>e.drawingType!==d.DrawingTypeEnum.DRAWING_DOM);return g.length?(g.forEach(e=>{if(!e.groupId&&e.transform&&(0,l.Tools).isDefine(e.transform.left)&&(0,l.Tools).isDefine(e.transform.top)&&(0,l.Tools).isDefine(e.transform.width)&&(0,l.Tools).isDefine(e.transform.height)){let t=o.skeleton.getCellPositionByOffset(e.transform.left,e.transform.top,c,h,{x:0,y:0}),r=o.skeleton.getCellPositionByOffset(e.transform.left+e.transform.width,e.transform.top+e.transform.height,c,h,{x:0,y:0});t.column<p.startColumn&&(p.startColumn=t.column),t.row<p.startRow&&(p.startRow=t.row),p.endRow<r.row&&(p.endRow=r.row),p.endColumn<r.column&&(p.endColumn=r.column)}}),r(p)):r(e)},"handler")}))}},O(e2,"SheetDrawingPrintingController"),e2);e8=e9([e5(0,(0,l.Inject)(m.SheetPrintInterceptorService)),e5(1,(0,l.Inject)(u.DrawingRenderService)),e5(2,d.IDrawingManagerService),e5(3,c.IRenderManagerService)],e8);var e7=Object.defineProperty,te=Object.getOwnPropertyDescriptor,tt=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?te(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&e7(t,r,a),a},"__decorateClass$2"),tr=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let tn=[b.InsertRowCommand.id,b.InsertColCommand.id,b.RemoveRowCommand.id,b.RemoveColCommand.id,b.DeleteRangeMoveLeftCommand.id,b.DeleteRangeMoveUpCommand.id,b.InsertRangeMoveDownCommand.id,b.InsertRangeMoveRightCommand.id,b.DeltaRowHeightCommand.id,b.SetRowHeightCommand.id,b.DeltaColumnWidthCommand.id,b.SetColWidthCommand.id,b.SetRowHiddenCommand.id,b.SetSpecificRowsVisibleCommand.id,b.SetSpecificColsVisibleCommand.id,b.SetColHiddenCommand.id,b.MoveColsCommand.id,b.MoveRowsCommand.id,b.MoveRangeCommand.id],ti=[b.SetRowVisibleMutation.id,b.SetRowHiddenMutation.id,b.SetColVisibleMutation.id,b.SetColHiddenMutation.id,b.SetWorksheetRowHeightMutation.id,b.SetWorksheetColWidthMutation.id],ta=(a=class extends l.Disposable{constructor(e,t,r,n,i,a,o,s,l){super(),this._context=e,this._renderManagerService=t,this._commandService=r,this._selectionRenderService=n,this._skeletonManagerService=i,this._sheetInterceptorService=a,this._sheetDrawingService=o,this._drawingManagerService=s,this._univerInstanceService=l,this._sheetInterceptorListener(),this._commandListener(),this._sheetRefreshListener()}_sheetInterceptorListener(){this.disposeWithMe(this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */O(e=>{if(!tn.includes(e.id)||null==e.params)return{redos:[],undos:[]};let t=e.id;if(t===b.InsertRowCommand.id)return this._moveRowInterceptor(e.params,"insert");if([(0,b.MoveColsCommand).id,(0,b.MoveRowsCommand).id,(0,b.MoveRangeCommand).id].includes(t))return this._moveRangeInterceptor(e.params);if(t===b.InsertColCommand.id)return this._moveColInterceptor(e.params,"insert");if(t===b.RemoveRowCommand.id)return this._moveRowInterceptor(e.params,"remove");if(t===b.RemoveColCommand.id)return this._moveColInterceptor(e.params,"remove");if(t===b.DeleteRangeMoveLeftCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,0)}if(t===b.DeleteRangeMoveUpCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,1)}if(t===b.InsertRangeMoveDownCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,2)}if(t===b.InsertRangeMoveRightCommand.id){let{range:t}=e.params;return this._getRangeMoveUndo(t,3)}if(t===b.SetRowHiddenCommand.id||t===b.SetSpecificRowsVisibleCommand.id){let{unitId:t,subUnitId:r,ranges:n}=e.params;return this._getDrawingUndoForRowVisible(t,r,n)}if(t===b.SetSpecificColsVisibleCommand.id||t===b.SetColHiddenCommand.id){let{unitId:t,subUnitId:r,ranges:n}=e.params;return this._getDrawingUndoForColVisible(t,r,n)}if(t===b.DeltaRowHeightCommand.id||t===b.SetRowHeightCommand.id||t===b.DeltaColumnWidthCommand.id||t===b.SetColWidthCommand.id){let{unitId:r,subUnitId:n,ranges:i}=e.params,a=t===b.DeltaRowHeightCommand.id||t===b.SetRowHeightCommand.id;return this._getDrawingUndoForRowAndColSize(r,n,i,a)}return{redos:[],undos:[]}},"getMutations")}))}_getRangeMoveUndo(e,t){let r=(0,b.getSheetCommandTarget)(this._univerInstanceService);if(null==r)return{redos:[],undos:[]};let n=r.unitId,i=r.subUnitId,a=[],o=[],s=this._sheetDrawingService.getDrawingData(n,i),l=[],d=[];if(Object.keys(s).forEach(r=>{let n=s[r],{updateDrawings:i,deleteDrawings:a}=this._getUpdateOrDeleteDrawings(e,t,n);l.push(...i),d.push(...a)}),0===l.length&&0===d.length)return{redos:[],undos:[]};if(l.length>0){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(l);a.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:r,type:h.DrawingApplyType.UPDATE}}),o.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:e,objects:r,type:h.DrawingApplyType.UPDATE}})}if(d.length>0){let e=this._sheetDrawingService.getBatchRemoveOp(d),t=e.undo,r=e.redo,s=e.objects;a.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:r,objects:s,type:h.DrawingApplyType.REMOVE}}),o.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:s,type:h.DrawingApplyType.INSERT}})}return a.push({id:k.id,params:[n]}),o.push({id:k.id,params:[n]}),{redos:a,undos:o}}_getUpdateOrDeleteDrawings(e,t,r){let n=[],i=[],{sheetTransform:a,anchorType:o=h.SheetDrawingAnchorType.Position,transform:s,unitId:l,subUnitId:d,drawingId:u}=r,{from:c,to:m}=a,{row:p,column:g}=c,{row:f,column:v}=m;if(null==a||null==s)return{updateDrawings:n,deleteDrawings:i};let{startRow:_,endRow:I,startColumn:S,endColumn:C}=e,y=null,w=null;if(0===t&&p>=_&&f<=I){if(g>=S&&v<=C)i.push({unitId:l,subUnitId:d,drawingId:u});else{let e=this._shrinkCol(a,s,S,C,o);y=null==e?void 0:e.newSheetTransform,w=null==e?void 0:e.newTransform}}else if(1===t&&g>=S&&v<=C){if(p>=_&&f<=I)i.push({unitId:l,subUnitId:d,drawingId:u});else{let e=this._shrinkRow(a,s,_,I,o);y=null==e?void 0:e.newSheetTransform,w=null==e?void 0:e.newTransform}}else if(2===t){let e=this._expandRow(a,s,_,I,o);y=null==e?void 0:e.newSheetTransform,w=null==e?void 0:e.newTransform}else if(3===t){let e=this._expandCol(a,s,S,C,o);y=null==e?void 0:e.newSheetTransform,w=null==e?void 0:e.newTransform}if(null!=y&&null!=w){let e=W(y,this._selectionRenderService,this._skeletonManagerService);n.push({...r,sheetTransform:y,transform:e})}return{updateDrawings:n,deleteDrawings:i}}_remainDrawingSize(e,t,r){let n=G({...e},this._selectionRenderService);null!=n&&t.push({...r,sheetTransform:n})}_getDrawingUndoForColVisible(e,t,r){let n=this._drawingManagerService.getDrawingData(e,t),i=[],a=[];if(Object.keys(n).forEach(e=>{let t=n[e],{sheetTransform:o,transform:s,anchorType:l=h.SheetDrawingAnchorType.Position}=t;if(l===h.SheetDrawingAnchorType.None)this._remainDrawingSize(s,i,t);else{let{from:e,to:n}=o,{row:d,column:u}=e,{row:c,column:m}=n;for(let o=0;o<r.length;o++){let{startRow:d,endRow:c,startColumn:p,endColumn:g}=r[o];if(m<p)continue;if(l===h.SheetDrawingAnchorType.Position){let r=null,a=null;if(u>=p&&u<=g){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:u,endColumn:g,startRow:e.row,endRow:n.row});if(null==t)return;a={...s,left:t.startX}}if(null!=a&&null!=(r=G(a,this._selectionRenderService))&&null!=a){i.push({...t,sheetTransform:r,transform:a});break}this._remainDrawingSize(s,i,t);continue}if(u>=p&&m<=g)continue;let f=null,v=null;if(u>=p&&u<=g){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:u,endColumn:g,startRow:e.row,endRow:n.row});if(null==t)return;v={...s,left:(null==t?void 0:t.startX)||0,width:((null==s?void 0:s.width)||0)-t.endX+t.startX}}else if(m>=p&&m<=g){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:p,endColumn:m,startRow:e.row,endRow:n.row});if(null==t)return;v={...s,left:t.startX-((null==s?void 0:s.width)||0)}}else{let r=this._skeletonManagerService.attachRangeWithCoord({startColumn:p,endColumn:g,startRow:e.row,endRow:n.row});if(null==r)return;if(null!=(f=G(v={...s,width:((null==s?void 0:s.width)||0)-r.endX+r.startX},this._selectionRenderService))&&null!=v){a.push({...t,sheetTransform:f,transform:v});break}}if(null!=v&&(f=G(v,this._selectionRenderService)),null!=v&&null!=f){i.push({...t,sheetTransform:f,transform:v});break}this._remainDrawingSize(s,i,t)}}}),0===i.length&&0===a.length)return{redos:[],undos:[]};let{redos:o,undos:s}=this._createUndoAndRedoMutation(e,t,i),l=[],d=[];if(a.length>0){let{redos:r,undos:n}=this._createUndoAndRedoMutation(e,t,a);l.push(...r),d.push(...n)}return{redos:o,undos:s,preRedos:l,preUndos:d}}_createUndoAndRedoMutation(e,t,r){let{undo:n,redo:i,objects:a}=this._sheetDrawingService.getBatchUpdateOp(r);return{redos:[{id:h.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:i,objects:a,type:h.DrawingApplyType.UPDATE}},{id:k.id,params:[e]}],undos:[{id:h.SetDrawingApplyMutation.id,params:{unitId:e,subUnitId:t,op:n,objects:a,type:h.DrawingApplyType.UPDATE}},{id:k.id,params:[e]}]}}_getDrawingUndoForRowVisible(e,t,r){let n=this._drawingManagerService.getDrawingData(e,t),i=[],a=[];if(Object.keys(n).forEach(e=>{let t=n[e],{sheetTransform:o,transform:s,anchorType:l=h.SheetDrawingAnchorType.Position}=t;if(l===h.SheetDrawingAnchorType.None)this._remainDrawingSize(s,i,t);else{let{from:e,to:n}=o,{row:d,column:u}=e,{row:c,column:m}=n;for(let o=0;o<r.length;o++){let{startRow:u,endRow:m,startColumn:p,endColumn:g}=r[o];if(c<u)continue;if(l===h.SheetDrawingAnchorType.Position){let r=null,a=null;if(d>=u&&d<=m){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:d,endRow:m});if(null==t)return;a={...s,top:t.startY}}if(null!=a&&null!=(r=G(a,this._selectionRenderService))&&null!=a){i.push({...t,sheetTransform:r,transform:a});break}this._remainDrawingSize(s,i,t);continue}if(d>=u&&c<=m)continue;let f=null,v=null;if(d>=u&&d<=m){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:d,endRow:m});if(null==t)return;v={...s,top:(null==t?void 0:t.startY)||0,height:((null==s?void 0:s.height)||0)-t.endY+t.startY}}else if(c>=u&&c<=m){let t=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:u,endRow:c});if(null==t)return;v={...s,top:t.startY-((null==s?void 0:s.height)||0)}}else{let r=this._skeletonManagerService.attachRangeWithCoord({startColumn:e.column,endColumn:n.column,startRow:u,endRow:m});if(null==r)return;if(null!=(f=G(v={...s,height:((null==s?void 0:s.height)||0)-r.endY+r.startY},this._selectionRenderService))&&null!=v){a.push({...t,sheetTransform:f,transform:v});break}}if(null!=v&&(f=G(v,this._selectionRenderService)),null!=v&&null!=f){i.push({...t,sheetTransform:f,transform:v});break}this._remainDrawingSize(s,i,t)}}}),0===i.length&&0===a.length)return{redos:[],undos:[]};let{redos:o,undos:s}=this._createUndoAndRedoMutation(e,t,i),l=[],d=[];if(a.length>0){let{redos:r,undos:n}=this._createUndoAndRedoMutation(e,t,a);l.push(...r),d.push(...n)}return{redos:o,undos:s,preRedos:l,preUndos:d}}_getDrawingUndoForRowAndColSize(e,t,r,n){let i=this._drawingManagerService.getDrawingData(e,t),a=[];return Object.keys(i).forEach(e=>{let t=i[e],{sheetTransform:n,transform:o,anchorType:s=h.SheetDrawingAnchorType.Position}=t;if(s===h.SheetDrawingAnchorType.None)this._remainDrawingSize(o,a,t);else{let{from:e,to:i}=n,{row:l,column:d}=e,{row:u,column:c}=i;for(let e=0;e<r.length;e++){let{startRow:i,endRow:m,startColumn:p,endColumn:g}=r[e];if(u<i||c<p)continue;if(s===h.SheetDrawingAnchorType.Position&&(l<=i&&u>=m||d<=p&&c>=g)){this._remainDrawingSize(o,a,t);continue}let f=W({...n},this._selectionRenderService,this._skeletonManagerService);if(null!=f){a.push({...t,transform:f});break}}}}),0===a.length?{redos:[],undos:[]}:this._createUndoAndRedoMutation(e,t,a)}_getUnitIdAndSubUnitId(e,t){let r,n;if("insert"===t)r=e.unitId,n=e.subUnitId;else{let e=(0,b.getSheetCommandTarget)(this._univerInstanceService);if(null==e)return;r=e.unitId,n=e.subUnitId}return{unitId:r,subUnitId:n}}_moveRangeInterceptor(e){var t,r;let{toRange:n,fromRange:i}=e,a=(0,b.getSheetCommandTarget)(this._univerInstanceService);if(!a)return{redos:[],undos:[]};let{unitId:o,subUnitId:s}=a,l=null==(r=null==(t=this._renderManagerService.getRenderById(o))?void 0:t.with(m.SheetSkeletonManagerService))?void 0:r.getCurrentSkeleton();if(!l)return{redos:[],undos:[]};let d=(0,m.attachRangeWithCoord)(l,i);if(!d)return{redos:[],undos:[]};let{startX:u,endX:c,startY:p,endY:g}=d,f=this._sheetDrawingService.getDrawingData(o,s),v=[];Object.keys(f).forEach(e=>{let t=f[e];if(t.anchorType!==h.SheetDrawingAnchorType.Both)return;let{transform:r}=t;if(!r)return;let{left:n=0,top:i=0,width:a=0,height:o=0}=r,{drawingStartX:s,drawingEndX:l,drawingStartY:d,drawingEndY:m}={drawingStartX:n,drawingEndX:n+a,drawingStartY:i,drawingEndY:i+o};u<=s&&l<=c&&p<=d&&m<=g&&v.push(t)});let _=[],I=[],S=n.startRow-i.startRow,C=n.startColumn-i.startColumn,y=v.map(e=>{let t=e.sheetTransform,r={to:{...t.to,row:t.to.row+S,column:t.to.column+C},from:{...t.from,row:t.from.row+S,column:t.from.column+C}},n=W(r,this._selectionRenderService,this._skeletonManagerService);return{unitId:o,subUnitId:s,drawingId:e.drawingId,transform:n,sheetTransform:r}});if(y.length){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(y);_.push({id:h.SetDrawingApplyMutation.id,params:{unitId:o,subUnitId:s,op:t,objects:r,type:h.DrawingApplyType.UPDATE}}),I.push({id:h.SetDrawingApplyMutation.id,params:{unitId:o,subUnitId:s,op:e,objects:r,type:h.DrawingApplyType.UPDATE}})}return{redos:_,undos:I}}_moveRowInterceptor(e,t){let r=this._getUnitIdAndSubUnitId(e,t);if(null==r)return{redos:[],undos:[]};let{unitId:n,subUnitId:i}=r,{range:a}=e,o=a.startRow,s=a.endRow,l=[],d=[],u=this._sheetDrawingService.getDrawingData(n,i),c=[],m=[];if(Object.keys(u).forEach(e=>{let r,a;let{sheetTransform:l,transform:d,anchorType:p=h.SheetDrawingAnchorType.Position}=u[e];if(null==l||null==d)return;if("insert"===t){let e=this._expandRow(l,d,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}else{let{from:t,to:u}=l,{row:c}=t,{row:g}=u;if(p===h.SheetDrawingAnchorType.Both&&c>=o&&g<=s)m.push({unitId:n,subUnitId:i,drawingId:e});else{let e=this._shrinkRow(l,d,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}}if(!r||!a)return;let g={unitId:n,subUnitId:i,drawingId:e,transform:a,sheetTransform:r};c.push(g)}),0===c.length&&0===m.length)return{redos:[],undos:[]};if(c.length>0){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(c);l.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:r,type:h.DrawingApplyType.UPDATE}}),d.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:e,objects:r,type:h.DrawingApplyType.UPDATE}})}if(m.length>0){let e=this._sheetDrawingService.getBatchRemoveOp(m),t=e.undo,r=e.redo,a=e.objects;l.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:r,objects:a,type:h.DrawingApplyType.REMOVE}}),d.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:a,type:h.DrawingApplyType.INSERT}})}return l.push({id:k.id,params:[n]}),d.push({id:k.id,params:[n]}),{redos:l,undos:d}}_moveColInterceptor(e,t){let r=this._getUnitIdAndSubUnitId(e,t);if(null==r)return{redos:[],undos:[]};let{unitId:n,subUnitId:i}=r,{range:a}=e,o=a.startColumn,s=a.endColumn,l=[],d=[],u=this._sheetDrawingService.getDrawingData(n,i),c=[],m=[];if(Object.keys(u).forEach(e=>{let r,a;let{sheetTransform:l,transform:d,anchorType:p=h.SheetDrawingAnchorType.Position}=u[e];if(null==l||null==d)return;if("insert"===t){let e=this._expandCol(l,d,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}else{let{from:t,to:u}=l,{column:c}=t,{column:g}=u;if(p===h.SheetDrawingAnchorType.Both&&c>=o&&g<=s)m.push({unitId:n,subUnitId:i,drawingId:e});else{let e=this._shrinkCol(l,d,o,s,p);r=null==e?void 0:e.newSheetTransform,a=null==e?void 0:e.newTransform}}if(!r||!a)return;let g={unitId:n,subUnitId:i,drawingId:e,transform:a,sheetTransform:r};c.push(g)}),0===c.length&&0===m.length)return{redos:[],undos:[]};if(c.length>0){let{undo:e,redo:t,objects:r}=this._sheetDrawingService.getBatchUpdateOp(c);l.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:r,type:h.DrawingApplyType.UPDATE}}),d.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:e,objects:r,type:h.DrawingApplyType.UPDATE}})}if(m.length>0){let e=this._sheetDrawingService.getBatchRemoveOp(m),t=e.undo,r=e.redo,a=e.objects;l.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:r,objects:a,type:h.DrawingApplyType.REMOVE}}),d.push({id:h.SetDrawingApplyMutation.id,params:{unitId:n,subUnitId:i,op:t,objects:a,type:h.DrawingApplyType.INSERT}})}return l.push({id:k.id,params:[n]}),d.push({id:k.id,params:[n]}),{redos:l,undos:d}}_expandCol(e,t,r,n,i=h.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{column:l}=o,{column:d}=s;if(i===h.SheetDrawingAnchorType.None)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};let u=null,c=null;if(l>=r){let e=this._skeletonManagerService.attachRangeWithCoord({startColumn:r,endColumn:n,startRow:o.row,endRow:s.row});if(null==e)return;u=G(c={...t,left:(t.left||0)+e.endX-e.startX},this._selectionRenderService)}else if(d>=n){if(i!==h.SheetDrawingAnchorType.Both)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};c=W(u={from:{...o},to:{...s,column:d+a}},this._selectionRenderService,this._skeletonManagerService)}return null!=u&&null!=c?{newSheetTransform:u,newTransform:c}:null}_shrinkCol(e,t,r,n,i=h.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{column:l}=o,{column:d}=s;if(i===h.SheetDrawingAnchorType.None)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};let u=null,c=null;if(l>n)c=W(u={from:{...o,column:l-a},to:{...s,column:d-a}},this._selectionRenderService,this._skeletonManagerService);else{if(l>=r&&d<=n)return null;if(l<r&&d>n){if(i!==h.SheetDrawingAnchorType.Both)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};c=W(u={from:{...o},to:{...s,column:d-a}},this._selectionRenderService,this._skeletonManagerService)}else if(l>=r&&l<=n){if(l===r)c={...t,left:(t.left||0)-e.from.columnOffset};else{let n=this._skeletonManagerService.attachRangeWithCoord({startColumn:r,endColumn:l-1,startRow:o.row,endRow:s.row});if(null==n)return;c={...t,left:(t.left||0)-n.endX+n.startX-e.from.columnOffset}}u=G(c,this._selectionRenderService)}else if(d>=r&&d<=n&&i===h.SheetDrawingAnchorType.Both){let e=this._skeletonManagerService.attachRangeWithCoord({startColumn:r-1,endColumn:r-1,startRow:o.row,endRow:s.row});if(null==e)return;c=W(u={from:{...o},to:{...s,column:r-1,columnOffset:e.endX-e.startX}},this._selectionRenderService,this._skeletonManagerService)}}return null!=u&&null!=c?{newSheetTransform:u,newTransform:c}:null}_expandRow(e,t,r,n,i=h.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{row:l}=o,{row:d}=s;if(i===h.SheetDrawingAnchorType.None)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};let u=null,c=null;if(l>=r){let e=this._skeletonManagerService.attachRangeWithCoord({startRow:r,endRow:n,startColumn:o.column,endColumn:s.column});if(null==e)return;u=G(c={...t,top:(t.top||0)+e.endY-e.startY},this._selectionRenderService)}else if(d>=n){if(i!==h.SheetDrawingAnchorType.Both)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};c=W(u={from:{...o},to:{...s,row:d+a}},this._selectionRenderService,this._skeletonManagerService)}return null!=u&&null!=c?{newSheetTransform:u,newTransform:c}:null}_shrinkRow(e,t,r,n,i=h.SheetDrawingAnchorType.Position){let a=n-r+1,{from:o,to:s}=e,{row:l}=o,{row:d}=s;if(i===h.SheetDrawingAnchorType.None)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};let u=null,c=null;if(l>n)c=W(u={from:{...o,row:l-a},to:{...s,row:d-a}},this._selectionRenderService,this._skeletonManagerService);else{if(l>=r&&d<=n)return null;if(l<r&&d>n){if(i!==h.SheetDrawingAnchorType.Both)return{newSheetTransform:G({...t},this._selectionRenderService),newTransform:t};c=W(u={from:{...o},to:{...s,row:d-a}},this._selectionRenderService,this._skeletonManagerService)}else if(l>=r&&l<=n){if(l===r)c={...t,top:(t.top||0)-e.from.rowOffset};else{let n=this._skeletonManagerService.attachRangeWithCoord({startRow:r,endRow:l-1,startColumn:o.column,endColumn:s.column});if(null==n)return;c={...t,top:(t.top||0)-n.endY+n.startY-e.from.rowOffset}}u=G(c,this._selectionRenderService)}else if(d>=r&&d<=n&&i===h.SheetDrawingAnchorType.Both){let e=this._skeletonManagerService.attachRangeWithCoord({startColumn:o.column,endColumn:o.column,startRow:r-1,endRow:r-1});if(null==e)return;c=W(u={from:{...o},to:{...s,row:r-1,rowOffset:e.endY-e.startY}},this._selectionRenderService,this._skeletonManagerService)}}return null!=u&&null!=c?{newSheetTransform:u,newTransform:c}:null}_commandListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{e.id===b.SetWorksheetActiveOperation.id&&setTimeout(()=>{let{unitId:t,subUnitId:r}=e.params,n=this._drawingManagerService.drawingManagerData,i=[],a=[];Object.keys(n).forEach(e=>{let o=n[e];null!=o&&Object.keys(o).forEach(n=>{let s=o[n].data;null!=s&&Object.keys(s).forEach(o=>{if(e===t&&n===r){let e=s[o];e.transform=W(e.sheetTransform,this._selectionRenderService,this._skeletonManagerService),i.push(s[o])}else a.push(s[o])})})}),this._drawingManagerService.removeNotification(a),this._drawingManagerService.addNotification(i)},0)}))}_sheetRefreshListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{ti.includes(e.id)&&requestIdleCallback(()=>{let{unitId:t,subUnitId:r,ranges:n}=e.params;this._refreshDrawingTransform(t,r,n)})}))}_refreshDrawingTransform(e,t,r){let n=this._drawingManagerService.getDrawingData(e,t),i=[];Object.keys(n).forEach(e=>{let t=n[e],{sheetTransform:a,transform:o,anchorType:s=h.SheetDrawingAnchorType.Position}=t;if(s===h.SheetDrawingAnchorType.None)return!0;let{from:d,to:u}=a,{row:c,column:m}=d,{row:p,column:g}=u;for(let e=0;e<r.length;e++){let{startRow:n,endRow:d,startColumn:u,endColumn:f}=r[e];if((0,l.Rectangle).intersects({startRow:n,endRow:d,startColumn:u,endColumn:f},{startRow:c,endRow:p,startColumn:m,endColumn:g})||c>d||m>f){let e=s===h.SheetDrawingAnchorType.Position,r=W(a,this._selectionRenderService,this._skeletonManagerService);i.push({...t,transform:{...r,width:e?null==o?void 0:o.width:null==r?void 0:r.width,height:e?null==o?void 0:o.height:null==r?void 0:r.height}});break}}}),0!==i.length&&(this._drawingManagerService.refreshTransform(i),this._commandService.syncExecuteCommand(k.id,[e]))}},O(a,"SheetDrawingTransformAffectedController"),a);ta=tt([tr(1,c.IRenderManagerService),tr(2,l.ICommandService),tr(3,m.ISheetSelectionRenderService),tr(4,(0,l.Inject)(m.SheetSkeletonManagerService)),tr(5,(0,l.Inject)(b.SheetInterceptorService)),tr(6,h.ISheetDrawingService),tr(7,d.IDrawingManagerService),tr(8,l.IUniverInstanceService)],ta);var to=Object.defineProperty,ts=Object.getOwnPropertyDescriptor,tl=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ts(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&to(t,r,a),a},"__decorateClass$1"),td=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");function tu(e,t,r,n){let i,a,o,s;let{scaleX:l,scaleY:d}=t.getAncestorScale(),u=t.getViewport(c.SHEET_VIEWPORT_KEY.VIEW_MAIN),h={left:!0,top:!0};if(!u)return{...e,absolute:h};let{left:m,right:p,top:g,bottom:f}=e,{startColumn:v,startRow:_,xSplit:I,ySplit:S}=n.getFreeze(),C=r.getNoMergeCellPositionByIndexWithNoHeader(_-S,v-I),y=r.getNoMergeCellPositionByIndexWithNoHeader(_,v),{rowHeaderWidth:w,columnHeaderHeight:b}=r,R=y.startX-C.startX,E=y.startY-C.startY,{top:T,left:M,viewportScrollX:O,viewportScrollY:D}=u;return m<M?(h.left=!0,i=(R+w+(m-M))*l,a=Math.max(Math.min((R+w+(p-M))*l,(R+w)*l),(p-O)*l)):(h.left=!1,i=Math.max((m-O)*l,(R+w)*l),a=Math.max((p-O)*l,(R+w)*l)),g<T?(h.top=!0,o=(E+b+(g-T))*d,s=Math.max(Math.min((E+b+(p-T))*d,(E+b)*d),(f-D)*d)):(h.top=!1,o=Math.max((g-D)*d,(E+b)*d),s=Math.max((f-D)*d,(E+b)*d)),{left:i,right:a,top:o,bottom:s,absolute:h}}O(tu,"transformBound2DOMBound");let tc=/* @__PURE__ */O((e,t,r,n)=>{let{scene:i}=t,{left:a,top:o,width:s,height:l,angle:d}=e,u=tu({left:a,right:a+s,top:o,bottom:o+l},i,r,n),{scaleX:c,scaleY:h}=i.getAncestorScale();return{startX:u.left,endX:u.right,startY:u.top,endY:u.bottom,rotate:d,width:s*c,height:l*h,absolute:u.absolute}},"calcPosition"),th=(o=class extends l.Disposable{constructor(e,t,r,n,i,a,o){super(),D(this,"_domLayerMap",/* @__PURE__ */new Map),D(this,"_domLayerInfoMap",/* @__PURE__ */new Map),D(this,"_transformChange$",new S.Subject),D(this,"transformChange$",this._transformChange$.asObservable()),D(this,"_add$",new S.Subject),D(this,"add$",this._add$.asObservable()),D(this,"_remove$",new S.Subject),D(this,"remove$",this._remove$.asObservable()),D(this,"_hooks",[]),this._renderManagerService=e,this._univerInstanceService=t,this._commandService=r,this._drawingManagerService=n,this._canvasFloatDomService=i,this._sheetDrawingService=a,this._lifecycleService=o,this._drawingAddListener(),this._featureUpdateListener(),this._deleteListener(),this._bindScrollEvent()}_bindScrollEvent(){this._lifecycleService.lifecycle$.pipe((0,_.filter)(e=>e===l.LifecycleStages.Rendered),(0,y.take)(1)).subscribe(()=>{this._scrollUpdateListener()})}_ensureMap(e,t){let r=this._domLayerMap.get(e);r||(r=/* @__PURE__ */new Map,this._domLayerMap.set(e,r));let n=r.get(t);return n||(n=/* @__PURE__ */new Map,r.set(t,n)),n}getFloatDomInfo(e){return this._domLayerInfoMap.get(e)}_getSceneAndTransformerByDrawingSearch(e){if(null==e)return;let t=this._renderManagerService.getRenderById(e),r=null==t?void 0:t.scene;if(null==t||null==r)return null;let n=r.getTransformerByCreate(),i=t.engine.getCanvasElement();return{scene:r,transformer:n,renderObject:t,canvas:i}}_getFloatDomProps(e){let t;return this._hooks.forEach(r=>{t=r.onGetFloatDomProps(e)}),t}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{e.forEach(e=>{var t,r,n;let{unitId:i,subUnitId:a,drawingId:o}=e,s=(0,b.getSheetCommandTarget)(this._univerInstanceService,{unitId:i,subUnitId:a}),u=this._drawingManagerService.getDrawingByParam(e);if(!u||!s)return;let h=null==(t=this._renderManagerService.getRenderById(i))?void 0:t.with(m.SheetSkeletonManagerService).getWorksheetSkeleton(a);if(!h)return;let{transform:p,drawingType:f,data:v}=u;if(f!==d.DrawingTypeEnum.DRAWING_DOM&&f!==d.DrawingTypeEnum.DRAWING_CHART)return;let _=this._getSceneAndTransformerByDrawingSearch(i);if(null==_)return;let{scene:I,canvas:S}=_;if(null==p)return!0;let{left:C,top:y,width:w,height:R,angle:E,flipX:T,flipY:M,skewX:D,skewY:U}=p,k=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:i,subUnitId:a,drawingId:o}),P=I.getObject(k);if(null!=P){P.transformByState({left:C,top:y,width:w,height:R,angle:E,flipX:T,flipY:M,skewX:D,skewY:U});return}let N={left:C,top:y,width:w,height:R,zIndex:this._drawingManagerService.getDrawingOrder(i,a).length-1},x=f===d.DrawingTypeEnum.DRAWING_CHART;x&&(N.fill="white",N.rotateEnabled=!1,v&&v.border&&(N.stroke=v.border),N.paintFirst="stroke",N.strokeWidth=1,N.borderEnabled=!1);let A=new c.Rect(k,N);x&&A.setObjectType(c.ObjectType.CHART),I.addObject(A,c.DRAWING_OBJECT_LAYER_INDEX),!1!==u.allowTransform&&I.attachTransformerTo(A);let L=this._ensureMap(i,a),F=new l.DisposableCollection,j=tc(A,_.renderObject,h.skeleton,s.worksheet),V=new g.BehaviorSubject(j);this._canvasFloatDomService.addFloatDom({position$:V,id:o,componentKey:u.componentKey,onPointerDown:/* @__PURE__ */O(e=>{S.dispatchEvent(new PointerEvent(e.type,e))},"onPointerDown"),onPointerMove:/* @__PURE__ */O(e=>{S.dispatchEvent(new PointerEvent(e.type,e))},"onPointerMove"),onPointerUp:/* @__PURE__ */O(e=>{S.dispatchEvent(new PointerEvent(e.type,e))},"onPointerUp"),onWheel:/* @__PURE__ */O(e=>{S.dispatchEvent(new WheelEvent(e.type,e))},"onWheel"),props:null!=(n=null==(r=L.get(o))?void 0:r.props)?n:this._getFloatDomProps(o),data:v,unitId:i});let H=A.onTransformChange$.subscribeEvent(()=>{let e=tc(A,_.renderObject,h.skeleton,s.worksheet);V.next(e)});F.add(()=>{this._canvasFloatDomService.removeFloatDom(o)}),H&&F.add(H),this._domLayerInfoMap.set(o,{dispose:F,rect:A,position$:V,unitId:i,subUnitId:a}),L.set(o,{...L.get(o)})})})),this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),a=this._getSceneAndTransformerByDrawingSearch(t);if(null==a)return;let{transformer:o,scene:s}=a,l=s.getObject(i);null!=l&&l.oKey&&o.clearControlByIds([null==l?void 0:l.oKey])})}))}_scrollUpdateListener(){let e=/* @__PURE__ */O((e,t)=>{var r;let n=this._getSceneAndTransformerByDrawingSearch(e),i=Array.from(this._ensureMap(e,t).keys()),a=(0,b.getSheetCommandTarget)(this._univerInstanceService,{unitId:e,subUnitId:t}),o=null==(r=this._renderManagerService.getRenderById(e))?void 0:r.with(m.SheetSkeletonManagerService).getWorksheetSkeleton(t);n&&a&&o&&i.forEach(e=>{let t=this._domLayerInfoMap.get(e);if(t){let e=tc(t.rect,n.renderObject,o.skeleton,a.worksheet);t.position$.next(e)}})},"updateSheet");this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(l.UniverInstanceType.UNIVER_SHEET).pipe((0,_.filter)(e=>!!e),(0,I.map)(e=>{let t=this._renderManagerService.getRenderById(e.getUnitId());return t?{render:t,unitId:e.getUnitId(),subUnitId:e.getActiveSheet().getSheetId()}:null}),(0,_.filter)(e=>!!e),(0,C.switchMap)(e=>(0,l.fromEventSubject)(e.render.scene.getViewport(m.VIEWPORT_KEY.VIEW_MAIN).onScrollAfter$).pipe((0,I.map)(()=>({unitId:e.unitId,subUnitId:e.subUnitId}))))).subscribe(({unitId:t,subUnitId:r})=>{e(t,r)})),this.disposeWithMe(this._commandService.onCommandExecuted(t=>{var r,n;if(t.id===m.SetZoomRatioOperation.id){let{unitId:i}=t.params;Array.from(null!=(n=null==(r=this._domLayerMap.get(i))?void 0:r.keys())?n:[]).forEach(t=>{e(i,t)})}else if(t.id===b.SetFrozenMutation.id){let{unitId:r,subUnitId:n}=t.params;e(r,n)}}))}_getPosition(e,t){var r;let{startX:n,endX:i,startY:a,endY:o}=e,s=null==(r=this._renderManagerService.getRenderById(t))?void 0:r.with(m.ISheetSelectionRenderService);if(null==s)return;let l=s.getSelectionCellByPosition(n,a);if(null==l)return;let d={column:l.actualColumn,columnOffset:n-l.startX,row:l.actualRow,rowOffset:a-l.startY},u=s.getSelectionCellByPosition(i,o);if(null!=u)return{from:d,to:{column:u.actualColumn,columnOffset:i-u.startX,row:u.actualRow,rowOffset:o-u.startY}}}_featureUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(e=>{e.forEach(e=>{let t=this._drawingManagerService.getDrawingByParam(e);if(!t||t.drawingType!==d.DrawingTypeEnum.DRAWING_DOM&&t.drawingType!==d.DrawingTypeEnum.DRAWING_CHART)return;let r={...t.transform};this._transformChange$.next({id:e.drawingId,value:r})})}))}_deleteListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(e=>{this._removeDom(e.drawingId)})}))}updateFloatDomProps(e,t,r,n){let i=this._domLayerInfoMap.get(r),a=this._getSceneAndTransformerByDrawingSearch(e);if(i&&a){let{scene:i}=a,o=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:e,subUnitId:t,drawingId:r}),s=i.getObject(o);s&&s instanceof c.Rect&&s.setProps(n)}}addFloatDomToPosition(e,t,r=!0){let n=(0,b.getSheetCommandTarget)(this._univerInstanceService,{unitId:e.unitId,subUnitId:e.subUnitId});if(!n)throw Error("cannot find current target!");let{unitId:i,subUnitId:a}=n,{initPosition:o,componentKey:s,data:u,allowTransform:c=!0}=e,h=null!=t?t:(0,l.generateRandomId)(),m=this._getPosition(o,i);if(null==m)return;this._ensureMap(i,a).set(h,e);let p={unitId:i,subUnitId:a,drawingId:h,drawingType:e.type||d.DrawingTypeEnum.DRAWING_DOM,componentKey:s,sheetTransform:m,transform:{left:o.startX,top:o.startY,width:o.endX-o.startX,height:o.endY-o.startY},data:u,allowTransform:c};return r&&this._commandService.executeCommand(ec.id,{unitId:i,drawings:[p]}),this._add$.next({unitId:i,subUnitId:a,id:h}),{id:h,dispose:/* @__PURE__ */O(()=>{this._removeDom(h,!0)},"dispose"),sheetDrawingParam:p}}_removeDom(e,t=!1){let r=this._domLayerInfoMap.get(e);if(!r)return;let{unitId:n,subUnitId:i}=r;this._domLayerInfoMap.delete(e),r.dispose.dispose();let a=this._getSceneAndTransformerByDrawingSearch(n);if(a&&a.scene.removeObject(r.rect),t){this._ensureMap(n,i).delete(e);let t=this._drawingManagerService.getDrawingByParam({unitId:n,subUnitId:i,drawingId:e});if(!t)return;let{redo:r,objects:a}=this._sheetDrawingService.getBatchRemoveOp([t]);this._commandService.syncExecuteCommand(h.SetDrawingApplyMutation.id,{unitId:n,subUnitId:i,op:r,objects:a,type:h.DrawingApplyType.REMOVE})}}addHook(e){return this._hooks.push(e),{dispose:/* @__PURE__ */O(()=>{let t=this._hooks.findIndex(t=>t===e);this._hooks.splice(t,1)},"dispose")}}},O(o,"SheetCanvasFloatDomManagerService"),o);th=tl([td(0,(0,l.Inject)(c.IRenderManagerService)),td(1,l.IUniverInstanceService),td(2,(0,l.Inject)(l.ICommandService)),td(3,d.IDrawingManagerService),td(4,(0,l.Inject)(p.CanvasFloatDomService)),td(5,h.ISheetDrawingService),td(6,(0,l.Inject)(l.LifecycleService))],th);var tm=Object.defineProperty,tp=Object.getOwnPropertyDescriptor,tg=/* @__PURE__ */O((e,t,r)=>t in e?tm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),tf=/* @__PURE__ */O((e,t,r,n)=>{for(var i,a=n>1?void 0:n?tp(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&tm(t,r,a),a},"__decorateClass"),tv=/* @__PURE__ */O((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),t_=/* @__PURE__ */O((e,t,r)=>tg(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let tI=(O(s=class extends l.Plugin{constructor(e=U,t,r,n){super(),this._config=e,this._injector=t,this._renderManagerService=r,this._configService=n;let{menu:i,...a}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig("sheets-drawing-ui.config",a)}onStarting(){(0,l.registerDependencies)(this._injector,[[th],[eW],[B],[e8],[e3],[eX]]),(0,l.touchDependencies)(this._injector,[[th]])}onReady(){(0,l.touchDependencies)(this._injector,[[eX]])}onRendered(){this._registerRenderModules(),(0,l.touchDependencies)(this._injector,[[e3],[e8],[eW]])}onSteady(){this._injector.get(B)}_registerRenderModules(){[[eS],[ta],[Q]].forEach(e=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(l.UniverInstanceType.UNIVER_SHEET,e))})}},"UniverSheetsDrawingUIPlugin"),s);t_(tI,"type",l.UniverInstanceType.UNIVER_SHEET),t_(tI,"pluginName","SHEET_IMAGE_UI_PLUGIN"),tf([(0,l.DependentOn)(d.UniverDrawingPlugin,u.UniverDrawingUIPlugin,h.UniverSheetsDrawingPlugin),tv(1,(0,l.Inject)(l.Injector)),tv(2,c.IRenderManagerService),tv(3,l.IConfigService)],tI)}),i("28sqy",function(t,i){let a,o,s,l;e(t.exports,"DRAWING_IMAGE_WIDTH_LIMIT",function(){return I}),e(t.exports,"DRAWING_IMAGE_HEIGHT_LIMIT",function(){return S}),e(t.exports,"DRAWING_IMAGE_COUNT_LIMIT",function(){return C}),e(t.exports,"DRAWING_IMAGE_ALLOW_SIZE",function(){return y}),e(t.exports,"DRAWING_IMAGE_ALLOW_IMAGE_LIST",function(){return w}),e(t.exports,"UnitDrawingService",function(){return K}),e(t.exports,"getDrawingShapeKeyByDrawingSearch",function(){return X}),e(t.exports,"getImageSize",function(){return Q}),e(t.exports,"ImageSourceType",function(){return Z}),e(t.exports,"ImageUploadStatusType",function(){return J}),e(t.exports,"IImageIoService",function(){return ee}),e(t.exports,"ArrangeTypeEnum",function(){return er}),e(t.exports,"DrawingTypeEnum",function(){return en}),e(t.exports,"IDrawingManagerService",function(){return ei}),e(t.exports,"UniverDrawingPlugin",function(){return eu});var d,u,c,h,m=n("7yNYd"),p=n("1mjSk"),g=Object.defineProperty,f=(e,t,r)=>t in e?g(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,v=(e,t)=>g(e,"name",{value:t,configurable:!0}),_=(e,t,r)=>f(e,"symbol"!=typeof t?t+"":t,r);let I=500,S=500,C=10,y=5242880,w=["image/png","image/jpeg","image/jpg","image/gif","image/bmp"];var b="u">typeof globalThis?globalThis:"u">typeof window?window:"u">typeof r?r:"u">typeof self?self:{},R={},E={},T={};function M(e,t){if(Array.isArray(t))return!1;for(let r in e)if(!D(e[r],t[r]))return!1;for(let r in t)if(void 0===e[r])return!1;return!0}function O(e,t){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!D(e[r],t[r]))return!1;return!0}function D(e,t){return e===t||null!==e&&null!==t&&"object"==typeof e&&"object"==typeof t&&(Array.isArray(e)?O(e,t):M(e,t))}Object.defineProperty(T,"__esModule",{value:!0}),v(M,"eqObj"),v(O,"eqArr"),v(D,"deepEqual"),T.default=D;var U={};function k(e){if(null===e)return null;if(Array.isArray(e))return e.map(k);if("object"!=typeof e)return e;{let t={};for(let r in e)t[r]=k(e[r]);return t}}Object.defineProperty(U,"__esModule",{value:!0}),v(k,"deepClone"),U.default=k;var P={};!function(e){function t(e,t){if(!e)throw Error(t)}Object.defineProperty(e,"__esModule",{value:!0}),e.eachChildOf=e.advancer=e.readCursor=e.writeCursor=e.WriteCursor=e.ReadCursor=e.isValidPathItem=void 0,v(t,"assert");let r=/* @__PURE__ */v(e=>null!=e&&"object"==typeof e&&!Array.isArray(e),"isObject"),n=/* @__PURE__ */v((e,t)=>typeof e==typeof t?e>t:"string"==typeof e&&"number"==typeof t,"isGreaterKey");function i(e,t){for(let r in e)t.write(r,e[r])}v(i,"copyAll"),e.isValidPathItem=e=>"number"==typeof e||"string"==typeof e&&"__proto__"!==e;let a=class{constructor(e=null){this.parents=[],this.indexes=[],this.lcIdx=-1,this.idx=-1,this.container=e}ascend(){t(this.parents.length===this.indexes.length/2),0===this.idx?this.parents.length?(this.lcIdx=this.indexes.pop(),this.container=this.parents.pop(),this.idx=this.indexes.pop()):(this.lcIdx=0,this.idx=-1):(t(this.idx>0),this.idx--,r(this.container[this.idx])&&this.idx--)}getPath(){let e=[],t=this.container,n=this.parents.length-1,i=this.idx;for(;i>=0;)e.unshift(t[i]),0===i?(i=this.indexes[2*n],t=this.parents[n--]):i-=r(t[i-1])?2:1;return e}};v(a,"Cursor");let o=a,s=class e extends o{get(){return this.container?this.container.slice(this.idx+1):null}getKey(){return t(null!=this.container,"Invalid call to getKey before cursor descended"),this.container[this.idx]}getComponent(){let e;return this.container&&this.container.length>this.idx+1&&r(e=this.container[this.idx+1])?e:null}descendFirst(){let e=this.idx+1;if(!this.container||e>=this.container.length||r(this.container[e])&&e+1>=this.container.length)return!1;r(this.container[e])&&e++;let t=this.container[e];return Array.isArray(t)?(this.indexes.push(this.idx),this.parents.push(this.container),this.indexes.push(e),this.idx=0,this.container=t):this.idx=e,!0}nextSibling(){if(t(this.parents.length===this.indexes.length/2),this.idx>0||0===this.parents.length)return!1;let e=this.indexes[this.indexes.length-1]+1,r=this.parents[this.parents.length-1];return!(e>=r.length)&&(t(!isNaN(e)),this.indexes[this.indexes.length-1]=e,this.container=r[e],!0)}_init(e,t,r,n){this.container=e,this.idx=t,this.parents=r.slice(),this.indexes=n.slice()}clone(){let t=new e;return t._init(this.container,this.idx,this.parents,this.indexes),t}*[Symbol.iterator](){if(this.descendFirst()){do yield this.getKey();while(this.nextSibling())this.ascend()}}traverse(e,t){let r=this.getComponent();for(let n of(r&&t(r,e),this))e&&e.descend(n),this.traverse(e,t),e&&e.ascend()}eachPick(e,t){this.traverse(e,(e,r)=>{null!=e.p&&t(e.p,r)})}eachDrop(e,t){this.traverse(e,(e,r)=>{null!=e.d&&t(e.d,r)})}};v(s,"ReadCursor"),e.ReadCursor=s;let l=class extends o{constructor(e=null){super(e),this.pendingDescent=[],this._op=e}flushDescent(){t(this.parents.length===this.indexes.length/2),null===this.container&&(this._op=this.container=[]);for(let e=0;e<this.pendingDescent.length;e++){let i=this.pendingDescent[e],a=this.idx+1;if(a<this.container.length&&r(this.container[a])&&a++,t(a===this.container.length||!r(this.container[a])),a===this.container.length)this.container.push(i),this.idx=a;else if(this.container[a]===i)this.idx=a;else{if(!Array.isArray(this.container[a])){let e=this.container.splice(a,this.container.length-a);this.container.push(e),this.lcIdx>-1&&(this.lcIdx=a)}for(this.indexes.push(this.idx),this.parents.push(this.container),-1!==this.lcIdx&&(t(n(i,this.container[this.lcIdx][0])),a=this.lcIdx+1,this.lcIdx=-1);a<this.container.length&&n(i,this.container[a][0]);)a++;if(this.indexes.push(a),this.idx=0,a<this.container.length&&this.container[a][0]===i)this.container=this.container[a];else{let e=[i];this.container.splice(a,0,e),this.container=e}}}this.pendingDescent.length=0}reset(){this.lcIdx=-1}getComponent(){this.flushDescent();let e=this.idx+1;if(e<this.container.length&&r(this.container[e]))return this.container[e];{let t={};return this.container.splice(e,0,t),t}}write(e,r){let n=this.getComponent();t(null==n[e]||n[e]===r,"Internal consistency error: Overwritten component. File a bug"),n[e]=r}get(){return this._op}descend(t){if(!e.isValidPathItem(t))throw Error("Invalid JSON key");this.pendingDescent.push(t)}descendPath(e){return this.pendingDescent.push(...e),this}ascend(){this.pendingDescent.length?this.pendingDescent.pop():super.ascend()}mergeTree(e,r=i){if(null===e)return;if(t(Array.isArray(e)),e===this._op)throw Error("Cannot merge into my own tree");let n=this.lcIdx,a=this.parents.length,o=0;for(let t=0;t<e.length;t++){let n=e[t];"string"==typeof n||"number"==typeof n?(o++,this.descend(n)):Array.isArray(n)?this.mergeTree(n,r):"object"==typeof n&&r(n,this)}for(;o--;)this.ascend();this.lcIdx=this.parents.length===a?n:-1}at(e,t){this.descendPath(e),t(this);for(let t=0;t<e.length;t++)this.ascend();return this}writeAtPath(e,t,r){return this.at(e,()=>this.write(t,r)),this.reset(),this}writeMove(e,t,r=0){return this.writeAtPath(e,"p",r).writeAtPath(t,"d",r)}getPath(){let e=super.getPath();return e.push(...this.pendingDescent),e}};function d(e,t,r){let i,a;function o(i){let o;for(;a;){let s=o=e.getKey();if(null!=i){let r=!1;if(t&&"number"==typeof s&&(o=t(s,e.getComponent()))<0&&(o=~o,r=!0),n(o,i))return null;if(o===i&&!r)return e}r&&"number"==typeof o&&r(o,e.getComponent()),a=e.nextSibling()}return null}return a=i=!!e&&e.descendFirst(),v(o,"adv"),o.end=()=>{i&&e.ascend()},o}function u(e,t,r){let i,a,o,s;for(i=a=e&&e.descendFirst(),o=s=t&&t.descendFirst();i||o;){let a=i?e.getKey():null,s=o?t.getKey():null;null!==a&&null!==s&&(n(s,a)?s=null:a!==s&&(a=null)),r(null==a?s:a,null!=a?e:null,null!=s?t:null),null!=a&&i&&(i=e.nextSibling()),null!=s&&o&&(o=t.nextSibling())}a&&e.ascend(),s&&t.ascend()}v(l,"WriteCursor"),e.WriteCursor=l,e.writeCursor=()=>new l,e.readCursor=e=>new s(e),v(d,"advancer"),e.advancer=d,v(u,"eachChildOf"),e.eachChildOf=u}(P);var N={};Object.defineProperty(N,"__esModule",{value:!0}),N.ConflictType=void 0,(x=N.ConflictType||(N.ConflictType={}))[x.RM_UNEXPECTED_CONTENT=1]="RM_UNEXPECTED_CONTENT",x[x.DROP_COLLISION=2]="DROP_COLLISION",x[x.BLACKHOLE=3]="BLACKHOLE";var x,A,L={},F={};function j(){return A||(A=1,Object.defineProperty(F,"__esModule",{value:!0}),F.uniToStrPos=F.strPosToUni=void 0,F.strPosToUni=(e,t=e.length)=>{let r=0,n=0;for(;n<t;n++){let t=e.charCodeAt(n);t>=55296&&t<=57343&&(r++,n++)}if(n!==t)throw Error("Invalid offset - splits unicode bytes");return n-r},F.uniToStrPos=(e,t)=>{let r=0;for(;t>0;t--){let t=e.charCodeAt(r);r+=t>=55296&&t<=57343?2:1}return r}),F}v(j,"requireUnicount");var V,H={};function $(){return V||(V=1,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.uniSlice=e.dlen=e.eachOp=void 0;let t=j(),r=/* @__PURE__ */v(t=>{if(!Array.isArray(t))throw Error("Op must be an array of components");let r=null;for(let n=0;n<t.length;n++){let i=t[n];switch(typeof i){case"object":if("number"!=typeof i.d&&"string"!=typeof i.d)throw Error("Delete must be number or string");if(0>=e.dlen(i.d))throw Error("Deletes must not be empty");break;case"string":if(!(i.length>0))throw Error("Inserts cannot be empty");break;case"number":if(!(i>0))throw Error("Skip components must be >0");if("number"==typeof r)throw Error("Adjacent skip components should be combined")}r=i}if("number"==typeof r)throw Error("Op has a trailing skip")},"checkOp");function n(r,n){let i=0,a=0;for(let o=0;o<r.length;o++){let s=r[o];switch(n(s,i,a),typeof s){case"object":i+=e.dlen(s.d);break;case"string":a+=t.strPosToUni(s);break;case"number":i+=s,a+=s}}}function i(e,t){let r=[],i=s(r);return n(e,(e,r,n)=>{i(t(e,r,n))}),c(r)}v(n,"eachOp"),e.eachOp=n,v(i,"mapOp");let a=/* @__PURE__ */v(e=>e,"id"),o=/* @__PURE__ */v(e=>i(e,a),"normalize");e.dlen=e=>"number"==typeof e?e:t.strPosToUni(e);let s=/* @__PURE__ */v(t=>r=>{if(!(!r||0===r.d||""===r.d)){if(0===t.length)t.push(r);else if(typeof r==typeof t[t.length-1]){if("object"==typeof r){let n=t[t.length-1];n.d="string"==typeof n.d&&"string"==typeof r.d?n.d+r.d:e.dlen(n.d)+e.dlen(r.d)}else t[t.length-1]+=r}else t.push(r)}},"makeAppend"),l=/* @__PURE__ */v(e=>"number"==typeof e?e:"string"==typeof e?t.strPosToUni(e):"number"==typeof e.d?e.d:t.strPosToUni(e.d),"componentLength");e.uniSlice=(e,r,n)=>{let i=t.uniToStrPos(e,r),a=null==n?1/0:t.uniToStrPos(e,n);return e.slice(i,a)};let d=/* @__PURE__ */v((t,r,n)=>"number"==typeof t?null==n?t-r:Math.min(t,n)-r:e.uniSlice(t,r,n),"dslice"),u=/* @__PURE__ */v(r=>{let n=0,i=0;return{take:/* @__PURE__ */v((a,o)=>{let s;if(n===r.length)return -1===a?null:a;let l=r[n];if("number"==typeof l)return -1===a||l-i<=a?(s=l-i,++n,i=0,s):(i+=a,a);if("string"==typeof l){if(-1===a||"i"===o||t.strPosToUni(l.slice(i))<=a)return s=l.slice(i),++n,i=0,s;{let e=i+t.uniToStrPos(l.slice(i),a);return s=l.slice(i,e),i=e,s}}if(-1===a||"d"===o||e.dlen(l.d)-i<=a)return s={d:d(l.d,i)},++n,i=0,s;{let e=d(l.d,i,i+a);return i+=a,{d:e}}},"take"),peek:/* @__PURE__ */v(()=>r[n],"peek")}},"makeTake"),c=/* @__PURE__ */v(e=>(e.length>0&&"number"==typeof e[e.length-1]&&e.pop(),e),"trim");function h(n,i,a){let o;if("left"!==a&&"right"!==a)throw Error("side ("+a+") must be 'left' or 'right'");r(n),r(i);let d=[],h=s(d),{take:m,peek:p}=u(n);for(let r=0;r<i.length;r++){let n,o;let s=i[r];switch(typeof s){case"number":for(n=s;n>0;)h(o=m(n,"i")),"string"!=typeof o&&(n-=l(o));break;case"string":"left"===a&&"string"==typeof p()&&h(m(-1)),h(t.strPosToUni(s));break;case"object":for(n=e.dlen(s.d);n>0;)switch(typeof(o=m(n,"i"))){case"number":n-=o;break;case"string":h(o);break;case"object":n-=e.dlen(o.d)}}}for(;o=m(-1);)h(o);return c(d)}function m(n,i){let a;r(n),r(i);let o=[],h=s(o),{take:m}=u(n);for(let r=0;r<i.length;r++){let n,a;let o=i[r];switch(typeof o){case"number":for(n=o;n>0;)h(a=m(n,"d")),"object"!=typeof a&&(n-=l(a));break;case"string":h(o);break;case"object":n=e.dlen(o.d);let s=0;for(;s<n;)switch(typeof(a=m(n-s,"d"))){case"number":h({d:d(o.d,s,s+a)}),s+=a;break;case"string":s+=t.strPosToUni(a);break;case"object":h(a)}}}for(;a=m(-1);)h(a);return c(o)}v(h,"transform"),v(m,"compose");let p=/* @__PURE__ */v((r,n)=>{let i=0;for(let a=0;a<n.length&&r>i;a++){let o=n[a];switch(typeof o){case"number":i+=o;break;case"string":let s=t.strPosToUni(o);i+=s,r+=s;break;case"object":r-=Math.min(e.dlen(o.d),r-i)}}return r},"transformPosition"),g=/* @__PURE__ */v((e,t)=>"number"==typeof e?p(e,t):e.map(e=>p(e,t)),"transformSelection");function f(e,t,r){return i(e,(e,n)=>"object"==typeof e&&"number"==typeof e.d?{d:r.slice(t,n,n+e.d)}:e)}function _(e){return i(e,e=>{switch(typeof e){case"object":if("number"==typeof e.d)throw Error("Cannot invert text op: Deleted characters missing from operation. makeInvertible must be called first.");return e.d;case"string":return{d:e};case"number":return e}})}function I(e){return i(e,e=>"object"==typeof e&&"string"==typeof e.d?{d:t.strPosToUni(e.d)}:e)}function S(e){let t=!0;return n(e,e=>{"object"==typeof e&&"number"==typeof e.d&&(t=!1)}),t}function C(t){return{name:"text-unicode",uri:"http://sharejs.org/types/text-unicode",trim:c,normalize:o,checkOp:r,create(e=""){if("string"!=typeof e)throw Error("Initial data must be a string");return t.create(e)},apply(n,i){r(i);let a=t.builder(n);for(let t=0;t<i.length;t++){let r=i[t];switch(typeof r){case"number":a.skip(r);break;case"string":a.append(r);break;case"object":a.del(e.dlen(r.d))}}return a.build()},transform:h,compose:m,transformPosition:p,transformSelection:g,isInvertible:S,makeInvertible:(e,r)=>f(e,r,t),stripInvertible:I,invert:_,invertWithDoc:(e,r)=>_(f(e,r,t)),isNoop:/* @__PURE__ */v(e=>0===e.length,"isNoop")}}v(f,"makeInvertible"),v(_,"invert"),v(I,"stripInvertible"),v(S,"isInvertible"),v(C,"makeType"),e.default=C}(H)),H}v($,"requireType");var B,W={};function G(){if(B)return W;B=1,Object.defineProperty(W,"__esModule",{value:!0});let e=$(),t=j();function r(r,n){return{get:r,getLength:()=>r().length,insert:(e,i,a)=>n([t.strPosToUni(r(),e),i],a),remove:(e,i,a)=>n([t.strPosToUni(r(),e),{d:i}],a),_onOp(t){e.eachOp(t,(t,r,n)=>{switch(typeof t){case"string":this.onInsert&&this.onInsert(n,t);break;case"object":let i=e.dlen(t.d);this.onRemove&&this.onRemove(n,i)}})},onInsert:null,onRemove:null}}return v(r,"api$1"),W.default=r,r.provides={text:!0},W}function z(){return c||(c=1,function(e){var t=b&&b.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:/* @__PURE__ */v(function(){return t[r]},"get")})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),r=b&&b.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=b&&b.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var i in e)Object.hasOwnProperty.call(e,i)&&t(n,e,i);return r(n,e),n},i=b&&b.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.type=e.remove=e.insert=void 0;let a=j(),o=n($()),s=i(G()),l={create:e=>e,toString:e=>e,builder(e){if("string"!=typeof e)throw Error("Invalid document snapshot: "+e);let t=[];return{skip(r){let n=a.uniToStrPos(e,r);if(n>e.length)throw Error("The op is too long for this document");t.push(e.slice(0,n)),e=e.slice(n)},append(e){t.push(e)},del(t){e=e.slice(a.uniToStrPos(e,t))},build:()=>t.join("")+e}},slice:o.uniSlice},d=Object.assign(Object.assign({},o.default(l)),{api:s.default});e.type=d,e.insert=(e,t)=>0===t.length?[]:0===e?[t]:[e,t],e.remove=(e,t)=>0===o.dlen(t)?[]:0===e?[{d:t}]:[e,{d:t}];var u=$();Object.defineProperty(e,"makeType",{enumerable:!0,get:/* @__PURE__ */v(function(){return u.default},"get")})}(L)),L}v(G,"requireApi"),v(z,"requireDist"),function(e){var t=b&&b.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.editOp=e.replaceOp=e.insertOp=e.moveOp=e.removeOp=e.type=void 0,t(T);let r=t(U);function n(e,t){if(!e)throw Error(t)}v(n,"assert"),e.type={name:"json1",uri:"http://sharejs.org/types/JSONv1",readCursor:P.readCursor,writeCursor:P.writeCursor,create:/* @__PURE__ */v(e=>e,"create"),isNoop:/* @__PURE__ */v(e=>null==e,"isNoop"),setDebug(e){},registerSubtype:p,checkValidOp:w,normalize:R,apply:E,transformPosition:M,compose:O,tryTransform:F,transform:V,makeInvertible:x,invert:D,invertWithDoc:A,RM_UNEXPECTED_CONTENT:N.ConflictType.RM_UNEXPECTED_CONTENT,DROP_COLLISION:N.ConflictType.DROP_COLLISION,BLACKHOLE:N.ConflictType.BLACKHOLE,transformNoConflict:/* @__PURE__ */v((e,t,r)=>B(()=>!0,e,t,r),"transformNoConflict"),typeAllowingConflictsPred:/* @__PURE__ */v(t=>Object.assign(Object.assign({},e.type),{transform:/* @__PURE__ */v((e,r,n)=>B(t,e,r,n),"transform")}),"typeAllowingConflictsPred")};let i=/* @__PURE__ */v(e=>e?e.getComponent():null,"getComponent");function a(e){return e&&"object"==typeof e&&!Array.isArray(e)}v(a,"isObject");let o=/* @__PURE__ */v(e=>Array.isArray(e)?e.slice():null!==e&&"object"==typeof e?Object.assign({},e):e,"shallowClone"),s=/* @__PURE__ */v(e=>e&&(null!=e.p||void 0!==e.r),"hasPick"),l=/* @__PURE__ */v(e=>e&&(null!=e.d||void 0!==e.i),"hasDrop");function d(e,t){return n(null!=e),"number"==typeof t?(n(Array.isArray(e),"Invalid key - child is not an array"),(e=e.slice()).splice(t,1)):(n(a(e),"Invalid key - child is not an object"),delete(e=Object.assign({},e))[t]),e}function u(e,t,r){return"number"==typeof t?(n(null!=e,"Container is missing for key"),n(Array.isArray(e),"Cannot use numerical key for object container"),n(e.length>=t,"Cannot insert into out of bounds index"),e.splice(t,0,r)):(n(a(e),"Cannot insert into missing item"),n(void 0===e[t],"Trying to overwrite value at key. Your op needs to remove it first"),e[t]=r),r}v(d,"removeChild"),v(u,"insertChildMut"),e.removeOp=(e,t=!0)=>P.writeCursor().writeAtPath(e,"r",t).get(),e.moveOp=(e,t)=>P.writeCursor().writeMove(e,t).get(),e.insertOp=(e,t)=>P.writeCursor().writeAtPath(e,"i",t).get(),e.replaceOp=(e,t,r)=>P.writeCursor().at(e,e=>{e.write("r",t),e.write("i",r)}).get(),e.editOp=(e,t,r,n=!1)=>P.writeCursor().at(e,e=>S(e,t,r,n)).get();let c=/* @__PURE__ */v((e,t)=>null!=e&&("number"==typeof t?Array.isArray(e):"object"==typeof e),"isValidKey"),h=/* @__PURE__ */v((e,t)=>c(e,t)?e[t]:void 0,"maybeGetChild"),m={};function p(e){let t=e.type?e.type:e;t.name&&(m[t.name]=t),t.uri&&(m[t.uri]=t)}v(p,"registerSubtype");let g=/* @__PURE__ */v(e=>{let t=m[e];if(t)return t;throw Error("Missing type: "+e)},"typeOrThrow");p(z());let f=/* @__PURE__ */v((e,t)=>e+t,"add");p({name:"number",apply:f,compose:f,invert:/* @__PURE__ */v(e=>-e,"invert"),transform:/* @__PURE__ */v(e=>e,"transform")});let _=/* @__PURE__ */v(e=>null==e?null:e.et?g(e.et):e.es?m["text-unicode"]:null!=e.ena?m.number:null,"getEditType"),I=/* @__PURE__ */v(e=>e.es?e.es:null!=e.ena?e.ena:e.e,"getEdit"),S=/* @__PURE__ */v((e,t,r,n=!1)=>{let[i,a]="string"==typeof t?[g(t),t]:[t,t.name];!n&&i.isNoop&&i.isNoop(r)||("number"===a?e.write("ena",r):"text-unicode"===a?e.write("es",r):(e.write("et",a),e.write("e",r)))},"writeEdit");function C(e){n("number"==typeof e),n(e>=0),n(e===(0|e))}function y(e){"number"==typeof e?C(e):n("string"==typeof e)}function w(e){if(null===e)return;let t=/* @__PURE__ */new Set,r=/* @__PURE__ */new Set,i=/* @__PURE__ */v(e=>{let i=!0,a=!1;for(let o in e){let s=e[o];if(i=!1,n("p"===o||"r"===o||"d"===o||"i"===o||"e"===o||"es"===o||"ena"===o||"et"===o,"Invalid component item '"+o+"'"),"p"===o)C(s),n(!t.has(s)),t.add(s),n(void 0===e.r);else if("d"===o)C(s),n(!r.has(s)),r.add(s),n(void 0===e.i);else if("e"===o||"es"===o||"ena"===o){n(!a),a=!0;let t=_(e);n(t,"Missing type in edit"),t.checkValidOp&&t.checkValidOp(I(e))}}n(!i)},"checkComponent"),a=/* @__PURE__ */v((e,t,r)=>{if(!Array.isArray(e))throw Error("Op must be null or a list");if(0===e.length)throw Error("Empty descent");t||y(e[0]);let o=1,s=0,l=0;for(let t=0;t<e.length;t++){let r=e[t];if(n(null!=r),Array.isArray(r)){let e=a(r,!1);if(s){let t=typeof l,r=typeof e;t===r?n(l<e,"descent keys are not in order"):n("number"===t&&"string"===r)}l=e,s++,o=3}else"object"==typeof r?(n(1===o,`Prev not scalar - instead ${o}`),i(r),o=2):(n(3!==o),y(r),n(P.isValidPathItem(r),"Invalid path key"),o=1)}return n(1!==s,"Operation makes multiple descents. Remove some []"),n(2===o||3===o),e[0]},"checkDescent");a(e,!0),n(t.size===r.size,"Mismatched picks and drops in op");for(let e=0;e<t.size;e++)n(t.has(e)),n(r.has(e))}function R(e){let t=0,r=[],n=P.writeCursor();return n.mergeTree(e,(e,n)=>{var i;let a=_(e);if(a){let t=I(e);S(n,a,a.normalize?a.normalize(t):t)}for(let a of["r","p","i","d"])if(void 0!==e[a]){let o="p"===a||"d"===a?(null==r[i=e[a]]&&(r[i]=t++),r[i]):e[a];n.write(a,o)}}),n.get()}function E(e,t){if(w(t),null===t)return e;let r=[];return /* @__PURE__ */v(function e(t,i){let a=t,s=0,l={root:t},d=0,m=l,p="root";function g(){for(;d<s;d++){let e=i[d];"object"!=typeof e&&(n(c(m,p)),m=m[p]=o(m[p]),p=e)}}for(v(g,"mut");s<i.length;s++){let t=i[s];if(Array.isArray(t)){let r=e(a,t);r!==a&&void 0!==r&&(g(),a=m[p]=r)}else if("object"==typeof t){null!=t.d?(g(),a=u(m,p,r[t.d])):void 0!==t.i&&(g(),a=u(m,p,t.i));let e=_(t);if(e)g(),a=m[p]=e.apply(a,I(t));else if(void 0!==t.e)throw Error("Subtype "+t.et+" undefined")}else a=h(a,t)}return l.root},"drop")(e=/* @__PURE__ */v(function e(t,i){var a,l;let u=[],c=0;for(;c<i.length;c++){let e=i[c];if(Array.isArray(e))break;"object"!=typeof e&&(u.push(t),t=h(t,e))}for(let r=i.length-1;r>=c;r--)t=e(t,i[r]);for(--c;c>=0;c--){let e=i[c];if("object"!=typeof e){let r=u.pop();t=t===h(r,e)?r:void 0===t?d(r,e):(l=t,(a=o(a=r))[e]=l,a)}else s(e)&&(n(void 0!==t,"Cannot pick up or remove undefined"),null!=e.p&&(r[e.p]=t),t=void 0)}return t},"pick")(e,t),t)}function M(e,t){e=e.slice(),w(t);let r=P.readCursor(t),n,a,o=!1,d=[];for(let t=0;;t++){let i=e[t],l=r.getComponent();if(l&&(void 0!==l.r?o=!0:null!=l.p&&(o=!1,n=l.p,a=t)),t>=e.length)break;let u=0,c=P.advancer(r,void 0,(e,t)=>{s(t)&&u++});d.unshift(c);let h=c(i);if("number"==typeof i&&(e[t]-=u),!h)break}if(d.forEach(e=>e.end()),o)return null;let u=/* @__PURE__ */v(()=>{let t=0;if(null!=n){let n=r.getPath();t=n.length,e=n.concat(e.slice(a))}for(;t<e.length;t++){let n=e[t],a=i(r),o=_(a);if(o){let r=I(a);o.transformPosition&&(e[t]=o.transformPosition(e[t],r));break}let s=0,d=P.advancer(r,(e,t)=>l(t)?~(e-s):e-s,(e,t)=>{l(t)&&s++})(n);if("number"==typeof n&&(e[t]+=s),!d)break}},"handleDrop");return null!=n?r.eachDrop(null,e=>{e===n&&u()}):u(),e}function O(e,t){if(w(e),w(t),null==e)return t;if(null==t)return e;let r=P.readCursor(e),n=P.readCursor(t),i=P.writeCursor(),a=[],o=[],s=[],l=[],d=[],u=[],c=/* @__PURE__ */new Set;r.traverse(null,e=>{null!=e.p&&(s[e.p]=r.clone())}),n.traverse(null,e=>{null!=e.d&&(l[e.d]=n.clone())});let h=P.writeCursor();return /* @__PURE__ */r.clone(),n.clone(),i.reset(),i.mergeTree(h.get()),i.reset(),i.get(),a.map(e=>e.get()),o.map(e=>e.get()),r.traverse(i,(e,t)=>{let r=e.p;if(null!=r){let e=d[r];null!=e&&t.write("p",e);let n=a[r];n&&n.get(),n&&t.mergeTree(n.get())}else void 0!==e.r&&t.write("r",e.r)}),i.reset(),i.get(),n.traverse(i,(e,t)=>{let r=e.d;if(null!=r){let e=u[r];null!=e&&t.write("d",e);let n=o[r];n&&t.mergeTree(n.get())}else void 0!==e.i&&t.write("i",e.i);let n=_(e);n&&!c.has(e)&&S(t,n,I(e))}),i.get()}function D(e){let t;if(null==e)return null;let r=new P.ReadCursor(e),n=new P.WriteCursor,i=[];return /* @__PURE__ */t&&(n.reset(),/* @__PURE__ */r.clone(),i.length&&(n.reset(),r.traverse(n,(e,t)=>{let r=e.p;if(null!=r){let e=i[r];e&&e.get(),e&&t.mergeTree(e.get())}}))),n.get()}v(C,"checkNonNegInteger"),v(y,"checkScalar"),v(w,"checkValidOp"),v(R,"normalize"),v(E,"apply"),v(M,"transformPosition"),v(O,"compose"),v(D,"invert");let k=/* @__PURE__ */v((e,t)=>e.some(e=>"object"==typeof e&&(Array.isArray(e)?k(e,t):t(e))),"anyComponent");function x(e,t){if(null==e||!k(e,e=>{var t;return void 0!==e.r||(null===(t=_(e))||void 0===t?void 0:t.makeInvertible)!=null}))return e;let i=new P.ReadCursor(e),a=new P.WriteCursor,s=!1,l=[],u=[],c=/* @__PURE__ */v((e,t,i)=>{let a=e.getComponent(),m=!1;if(a){null!=a.d&&t.write("d",a.d),void 0!==a.i&&t.write("i",a.i);let r=a.p;if(null!=r&&(l[r]=e.clone(),n(void 0!==i,"Operation picks up at an invalid key"),u[r]=i,t.write("p",a.p)),void 0!==a.r&&void 0===i)throw Error("Invalid doc / op in makeInvertible: removed item missing from doc");let o=_(a);o&&(o.makeInvertible?s=!0:S(t,o,I(a),!0))}let p=0;for(let r of e){t.descend(r);let n="number"==typeof r?r-p:r,a=h(i,n),s=c(e,t,a);a!==s&&(m||(m=!0,i=o(i)),void 0===s?(i=d(i,n),"number"==typeof r&&p++):i[n]=s),t.ascend()}return a&&(void 0!==a.r?(t.write("r",r.default(i)),i=void 0):null!=a.p&&(i=void 0)),i},"traversePick");return c(i,a,t),a.get(),s&&(a.reset(),/* @__PURE__ */i.clone()),a.get()}function A(e,t){return D(x(e,t))}v(x,"makeInvertible"),v(A,"invertWithDoc");let L=/* @__PURE__ */v(e=>{if(null==e)return null;let t=e.slice();for(let r=0;r<e.length;r++){let e=t[r];Array.isArray(e)&&(t[r]=L(e))}return t},"shallowCloneOp");function F(e,t,r){n("left"===r||"right"===r,"Direction must be left or right");let i="left"===r?0:1;if(null==t)return{ok:!0,result:e};w(e),w(t);let a=null,o=[],s=[],l=[],d=[],u=[],c=[],h=[],m=[],p=[],g=[],f=P.readCursor(e),_=P.readCursor(t),I=P.writeCursor();if(/* @__PURE__ *//* @__PURE__ */_.clone(),d.map(e=>e&&e.get()),a)return{ok:!1,conflict:a};c.map(e=>!!e),/* @__PURE__ */_.clone(),I.reset();let S=[];if(/* @__PURE__ */f.clone(),_.clone(),a)return{ok:!1,conflict:a};I.reset();let C=/* @__PURE__ */v((e,t,r)=>e.traverse(t,(t,n)=>{null!=t.d&&r(t.d,e,n)}),"eachDrop");(u.length||h.length)&&(C(_,I,(e,t,r)=>{u[e]&&!c[e]&&r.write("r",!0),h[e]&&r.mergeTree(h[e].get())}),I.reset());let y=[],b=[];if((m.length||u.length)&&!a){let e=P.readCursor(L(I.get()));if(C(e,null,(e,t)=>{y[e]=t.clone()}),m.forEach(e=>{e&&C(P.readCursor(e.get()),null,(e,t)=>{y[e]=t.clone()})}),/* @__PURE__ */e.clone(),I.reset(),a)return{ok:!1,conflict:a};if(I.get(),b.length){let e=b.map(e=>e?e.get():null);if(C(P.readCursor(L(I.get())),I,(t,r,n)=>{let i=e[t];i&&(n.mergeTree(i),e[t]=null)}),e.find(e=>e)){let t=P.writeCursor(),r=P.writeCursor(),n=0,c=0;e.forEach(e=>{null!=e&&C(P.readCursor(e),null,e=>{let a=S[e];t.writeMove(o[a].getPath(),s[a].getPath(),n++);let h=g[a];h&&h.forEach(e=>{u[e]||1!==i&&null!=p[e]||r.writeMove(l[e].getPath(),d[e].getPath(),c++)})})}),a={type:N.ConflictType.BLACKHOLE,op1:t.get(),op2:r.get()}}}}return a?{ok:!1,conflict:a}:{ok:!0,result:I.get()}}v(F,"tryTransform");let j=/* @__PURE__ */v(e=>{let t=Error("Transform detected write conflict");throw t.conflict=e,t.type=t.name="writeConflict",t},"throwConflictErr");function V(e,t,r){let n=F(e,t,r);if(n.ok)return n.result;j(n.conflict)}v(V,"transform");let H=/* @__PURE__ */v(e=>{let t=P.writeCursor();return P.readCursor(e).traverse(t,(e,t)=>{(l(e)||_(e))&&t.write("r",!0)}),t.get()},"opThatRemovesDE"),$=/* @__PURE__ */v((e,t)=>{let{type:r,op1:n,op2:i}=e;switch(r){case N.ConflictType.DROP_COLLISION:return"left"===t?[null,H(i)]:[H(n),null];case N.ConflictType.RM_UNEXPECTED_CONTENT:let a=!1;return P.readCursor(n).traverse(null,e=>{void 0!==e.r&&(a=!0)}),a?[null,H(i)]:[H(n),null];case N.ConflictType.BLACKHOLE:return[H(n),H(i)];default:throw Error("Unrecognised conflict: "+r)}},"resolveConflict");function B(e,t,r,n){let i=null;for(;;){let a=F(t,r,n);if(a.ok)return O(i,a.result);{let{conflict:o}=a;e(o)||j(o);let[s,l]=$(o,n);t=O(R(t),s),r=O(R(r),l),i=O(i,l)}}}v(B,"transformWithConflictsPred")}(E),d=b&&b.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:/* @__PURE__ */v(function(){return t[r]},"get")})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),u=b&&b.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||d(t,e,r)},Object.defineProperty(R,"__esModule",{value:!0}),u(E,R),Object.defineProperty(R,"ReadCursor",{enumerable:!0,get:/* @__PURE__ */v(function(){return P.ReadCursor},"get")}),Object.defineProperty(R,"WriteCursor",{enumerable:!0,get:/* @__PURE__ */v(function(){return P.WriteCursor},"get")}),Object.defineProperty(R,"ConflictType",{enumerable:!0,get:/* @__PURE__ */v(function(){return N.ConflictType},"get")});let Y=class{constructor(){_(this,"drawingManagerData",{}),_(this,"_oldDrawingManagerData",{}),_(this,"_focusDrawings",[]),_(this,"_remove$",new p.Subject),_(this,"remove$",this._remove$.asObservable()),_(this,"_add$",new p.Subject),_(this,"add$",this._add$.asObservable()),_(this,"_update$",new p.Subject),_(this,"update$",this._update$.asObservable()),_(this,"_order$",new p.Subject),_(this,"order$",this._order$.asObservable()),_(this,"_group$",new p.Subject),_(this,"group$",this._group$.asObservable()),_(this,"_ungroup$",new p.Subject),_(this,"ungroup$",this._ungroup$.asObservable()),_(this,"_refreshTransform$",new p.Subject),_(this,"refreshTransform$",this._refreshTransform$.asObservable()),_(this,"_visible$",new p.Subject),_(this,"visible$",this._visible$.asObservable()),_(this,"_focus$",new p.Subject),_(this,"focus$",this._focus$.asObservable()),_(this,"_featurePluginUpdate$",new p.Subject),_(this,"featurePluginUpdate$",this._featurePluginUpdate$.asObservable()),_(this,"_featurePluginAdd$",new p.Subject),_(this,"featurePluginAdd$",this._featurePluginAdd$.asObservable()),_(this,"_featurePluginRemove$",new p.Subject),_(this,"featurePluginRemove$",this._featurePluginRemove$.asObservable()),_(this,"_featurePluginOrderUpdate$",new p.Subject),_(this,"featurePluginOrderUpdate$",this._featurePluginOrderUpdate$.asObservable()),_(this,"_featurePluginGroupUpdate$",new p.Subject),_(this,"featurePluginGroupUpdate$",this._featurePluginGroupUpdate$.asObservable()),_(this,"_featurePluginUngroupUpdate$",new p.Subject),_(this,"featurePluginUngroupUpdate$",this._featurePluginUngroupUpdate$.asObservable()),_(this,"_visible",!0),_(this,"_editable",!0)}dispose(){this._remove$.complete(),this._add$.complete(),this._update$.complete(),this._order$.complete(),this._focus$.complete(),this._featurePluginUpdate$.complete(),this._featurePluginAdd$.complete(),this._featurePluginRemove$.complete(),this._featurePluginOrderUpdate$.complete(),this.drawingManagerData={},this._oldDrawingManagerData={}}visibleNotification(e){this._visible$.next(e)}refreshTransform(e){e.forEach(e=>{let t=this._getCurrentBySearch(e);null!=t&&(t.transform=e.transform,t.transforms=e.transforms,t.isMultiTransform=e.isMultiTransform)}),this.refreshTransformNotification(e)}getDrawingDataForUnit(e){return this.drawingManagerData[e]||{}}removeDrawingDataForUnit(e){let t=this.drawingManagerData[e];if(null==t)return;delete this.drawingManagerData[e];let r=[];Object.keys(t).forEach(n=>{let i=t[n];(null==i?void 0:i.data)!=null&&Object.keys(i.data).forEach(t=>{r.push({unitId:e,subUnitId:n,drawingId:t})})}),r.length>0&&this.removeNotification(r)}registerDrawingData(e,t){this.drawingManagerData[e]=t}initializeNotification(e){let t=[],r=this.drawingManagerData[e];null!=r&&(Object.keys(r).forEach(n=>{this._establishDrawingMap(e,n);let i=r[n];Object.keys(i.data).forEach(r=>{let a=i.data[r];a.unitId=e,a.subUnitId=n,t.push(a)})}),t.length>0&&this.addNotification(t))}getDrawingData(e,t){return this._getDrawingData(e,t)}setDrawingData(e,t,r){this.drawingManagerData[e][t].data=r}getBatchAddOp(e){let t=[],r=[],n=[];e.forEach(e=>{let{op:i,invertOp:a}=this._addByParam(e);t.push({unitId:e.unitId,subUnitId:e.subUnitId,drawingId:e.drawingId}),r.push(i),n.push(a)});let i=r.reduce(R.type.compose,null),a=n.reduce(R.type.compose,null),{unitId:o,subUnitId:s}=e[0];return{undo:a,redo:i,unitId:o,subUnitId:s,objects:t}}getBatchRemoveOp(e){let t=[],r=[];e.forEach(e=>{let{op:n,invertOp:i}=this._removeByParam(e);t.unshift(n),r.push(i)});let n=t.reduce(R.type.compose,null),i=r.reduce(R.type.compose,null),{unitId:a,subUnitId:o}=e[0];return{undo:i,redo:n,unitId:a,subUnitId:o,objects:e}}getBatchUpdateOp(e){let t=[],r=[],n=[];e.forEach(e=>{let{op:i,invertOp:a}=this._updateByParam(e);t.push({unitId:e.unitId,subUnitId:e.subUnitId,drawingId:e.drawingId}),r.push(i),n.push(a)});let i=r.reduce(R.type.compose,null),a=n.reduce(R.type.compose,null),{unitId:o,subUnitId:s}=e[0];return{undo:a,redo:i,unitId:o,subUnitId:s,objects:t}}removeNotification(e){this._remove$.next(e)}addNotification(e){this._add$.next(e)}updateNotification(e){this._update$.next(e)}orderNotification(e){this._order$.next(e)}groupUpdateNotification(e){this._group$.next(e)}ungroupUpdateNotification(e){this._ungroup$.next(e)}refreshTransformNotification(e){this._refreshTransform$.next(e)}getGroupDrawingOp(e){let t=[],{unitId:r,subUnitId:n}=e[0].parent;e.forEach(e=>{t.push(this._getGroupDrawingOp(e))});let i=t.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(i,this.drawingManagerData),redo:i,unitId:r,subUnitId:n,objects:e}}getUngroupDrawingOp(e){let t=[],{unitId:r,subUnitId:n}=e[0].parent;e.forEach(e=>{t.push(this._getUngroupDrawingOp(e))});let i=t.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(i,this.drawingManagerData),redo:i,unitId:r,subUnitId:n,objects:e}}getDrawingsByGroup(e){let{unitId:t,subUnitId:r,drawingId:n}=e;if(null==this.getDrawingByParam({unitId:t,subUnitId:r,drawingId:n}))return[];let i=this._getDrawingData(t,r),a=[];return Object.keys(i).forEach(e=>{let t=i[e];t.groupId===n&&a.push(t)}),a}_getGroupDrawingOp(e){let{parent:t,children:r}=e,{unitId:n,subUnitId:i,drawingId:a}=t,o=[];o.push(R.insertOp([n,i,"data",a],t));let s=Number.NEGATIVE_INFINITY;return r.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._hasDrawingOrder({unitId:t,subUnitId:r,drawingId:n});s=Math.max(s,i),o.push(...this._getUpdateParamCompareOp(e,this.getDrawingByParam({unitId:t,subUnitId:r,drawingId:n})))}),s===Number.NEGATIVE_INFINITY&&(s=this._getDrawingOrder(n,i).length),o.push(R.insertOp([n,i,"order",s],a)),o.reduce(R.type.compose,null)}_getUngroupDrawingOp(e){let{parent:t,children:r}=e,{unitId:n,subUnitId:i,drawingId:a}=t,o=[];return r.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e;o.push(...this._getUpdateParamCompareOp(e,this.getDrawingByParam({unitId:t,subUnitId:r,drawingId:n})))}),o.push(R.removeOp([n,i,"data",a],!0)),o.push(R.removeOp([n,i,"order",this._getDrawingOrder(n,i).indexOf(a)],!0)),o.reduce(R.type.compose,null)}applyJson1(e,t,r){this._establishDrawingMap(e,t),this._oldDrawingManagerData={...this.drawingManagerData},this.drawingManagerData=R.type.apply(this.drawingManagerData,r)}featurePluginUpdateNotification(e){this._featurePluginUpdate$.next(e)}featurePluginOrderUpdateNotification(e){this._featurePluginOrderUpdate$.next(e)}featurePluginAddNotification(e){this._featurePluginAdd$.next(e)}featurePluginRemoveNotification(e){this._featurePluginRemove$.next(e)}featurePluginGroupUpdateNotification(e){this._featurePluginGroupUpdate$.next(e)}featurePluginUngroupUpdateNotification(e){this._featurePluginUngroupUpdate$.next(e)}getDrawingByParam(e){return this._getCurrentBySearch(e)}getOldDrawingByParam(e){return this._getOldBySearch(e)}getDrawingOKey(e){let[t,r,n]=e.split("#-#");return this._getCurrentBySearch({unitId:t,subUnitId:r,drawingId:n})}focusDrawing(e){if(null==e){this._focusDrawings=[],this._focus$.next([]);return}let t=[];e.forEach(e=>{var r;let{unitId:n,subUnitId:i,drawingId:a}=e,o=null==(r=this._getDrawingData(n,i))?void 0:r[a];null!=o&&t.push(o)}),t.length>0&&(this._focusDrawings=t,this._focus$.next(t))}getFocusDrawings(){let e=[];return this._focusDrawings.forEach(t=>{var r;let{unitId:n,subUnitId:i,drawingId:a}=t,o=null==(r=this._getDrawingData(n,i))?void 0:r[a];null!=o&&e.push(o)}),e}getDrawingOrder(e,t){return this._getDrawingOrder(e,t)}setDrawingOrder(e,t,r){this.drawingManagerData[e][t].order=r}orderUpdateNotification(e){this._order$.next(e)}getForwardDrawingsOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=[],a=this.getDrawingOrder(t,r),o=[...n];n.forEach(e=>{let n=this._hasDrawingOrder({unitId:t,subUnitId:r,drawingId:e});if(-1===n||n===a.length-1)return;let s=R.moveOp([t,r,"order",n],[t,r,"order",n+1]);i.push(s),o.includes(a[n+1])||o.push(a[n+1])});let s=i.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(s,this.drawingManagerData),redo:s,unitId:t,subUnitId:r,objects:{...e,drawingIds:o}}}getBackwardDrawingOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=[],a=this.getDrawingOrder(t,r),o=[...n];n.forEach(e=>{let n=this._hasDrawingOrder({unitId:t,subUnitId:r,drawingId:e});if(-1===n||0===n)return;let s=R.moveOp([t,r,"order",n],[t,r,"order",n-1]);i.push(s),o.includes(a[n-1])||o.push(a[n-1])});let s=i.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(s,this.drawingManagerData),redo:s,unitId:t,subUnitId:r,objects:{...e,drawingIds:o}}}getFrontDrawingsOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=this._getOrderFromSearchParams(t,r,n),a=[...n],o=this.getDrawingOrder(t,r),s=[];i.forEach(e=>{let{drawingId:n}=e,i=this._getDrawingCount(t,r)-1,l=R.moveOp([t,r,"order",this._getDrawingOrder(t,r).indexOf(n)],[t,r,"order",i]);s.push(l),a.includes(o[i])||a.push(o[i])});let l=s.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(l,this.drawingManagerData),redo:l,unitId:t,subUnitId:r,objects:{...e,drawingIds:a}}}getBackDrawingsOp(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=this._getOrderFromSearchParams(t,r,n,!0),a=[...n],o=this.getDrawingOrder(t,r),s=[];i.forEach(e=>{let{drawingId:n}=e,i=R.moveOp([t,r,"order",this._getDrawingOrder(t,r).indexOf(n)],[t,r,"order",0]);s.push(i),a.includes(o[0])||a.push(o[0])});let l=s.reduce(R.type.compose,null);return{undo:R.type.invertWithDoc(l,this.drawingManagerData),redo:l,unitId:t,subUnitId:r,objects:{...e,drawingIds:a}}}_getDrawingCount(e,t){return this.getDrawingOrder(e,t).length||0}_getOrderFromSearchParams(e,t,r,n=!1){return r.map(r=>{let n=this._hasDrawingOrder({unitId:e,subUnitId:t,drawingId:r});return{drawingId:r,zIndex:n}}).sort(!1===n?m.sortRules:m.sortRulesByDesc)}_hasDrawingOrder(e){if(null==e)return -1;let{unitId:t,subUnitId:r,drawingId:n}=e;return this._establishDrawingMap(t,r),this._getDrawingOrder(t,r).indexOf(n)}_getCurrentBySearch(e){var t,r,n;if(null==e)return;let{unitId:i,subUnitId:a,drawingId:o}=e;return null==(n=null==(r=null==(t=this.drawingManagerData[i])?void 0:t[a])?void 0:r.data)?void 0:n[o]}_getOldBySearch(e){var t,r,n;if(null==e)return;let{unitId:i,subUnitId:a,drawingId:o}=e;return null==(n=null==(r=null==(t=this._oldDrawingManagerData[i])?void 0:t[a])?void 0:r.data)?void 0:n[o]}_establishDrawingMap(e,t,r){var n;return this.drawingManagerData[e]||(this.drawingManagerData[e]={}),this.drawingManagerData[e][t]||(this.drawingManagerData[e][t]={data:{},order:[]}),null==r?null:null==(n=this.drawingManagerData[e][t].data)?void 0:n[r]}_addByParam(e){let{unitId:t,subUnitId:r,drawingId:n}=e;this._establishDrawingMap(t,r,n);let i=[R.insertOp([t,r,"data",n],e),R.insertOp([t,r,"order",this._getDrawingOrder(t,r).length],n)].reduce(R.type.compose,null),a=R.type.invertWithDoc(i,this.drawingManagerData);return{op:i,invertOp:a}}_removeByParam(e){if(null==e)return{op:[],invertOp:[]};let{unitId:t,subUnitId:r,drawingId:n}=e;if(null==this._establishDrawingMap(t,r,n))return{op:[],invertOp:[]};let i=[R.removeOp([t,r,"data",n],!0),R.removeOp([t,r,"order",this._getDrawingOrder(t,r).indexOf(n)],!0)].reduce(R.type.compose,null),a=R.type.invertWithDoc(i,this.drawingManagerData);return{op:i,invertOp:a}}_updateByParam(e){let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._establishDrawingMap(t,r,n);if(null==i)return{op:[],invertOp:[]};let a=this._getUpdateParamCompareOp(e,i).reduce(R.type.compose,null),o=R.type.invertWithDoc(a,this.drawingManagerData);return{op:a,invertOp:o}}_getUpdateParamCompareOp(e,t){let{unitId:r,subUnitId:n,drawingId:i}=e,a=[];return Object.keys(e).forEach(o=>{let s=e[o],l=t[o];l!==s&&a.push(R.replaceOp([r,n,"data",i,o],l,s))}),a}_getDrawingData(e,t){var r,n;return(null==(n=null==(r=this.drawingManagerData[e])?void 0:r[t])?void 0:n.data)||{}}_getDrawingOrder(e,t){var r,n;return(null==(n=null==(r=this.drawingManagerData[e])?void 0:r[t])?void 0:n.order)||[]}getDrawingVisible(){return this._visible}getDrawingEditable(){return this._editable}setDrawingVisible(e){this._visible=e}setDrawingEditable(e){this._editable=e}};v(Y,"UnitDrawingService");let K=Y,q=class extends K{};function X({unitId:e,subUnitId:t,drawingId:r},n){return"number"==typeof n?`${e}#-#${t}#-#${r}#-#${n}`:`${e}#-#${t}#-#${r}`}v(q,"DrawingManagerService"),v(X,"getDrawingShapeKeyByDrawingSearch");let Q=/* @__PURE__ */v(async e=>new Promise((t,r)=>{let n=new Image;n.src=e,n.onload=()=>{t({width:n.width,height:n.height,image:n})},n.onerror=e=>{r(e)}}),"getImageSize");var Z=((a=Z||{}).URL="URL",a.UUID="UUID",a.BASE64="BASE64",a),J=((o=J||{}).SUCCUSS="0",o.ERROR_EXCEED_SIZE="1",o.ERROR_IMAGE_TYPE="2",o.ERROR_UPLOAD_COUNT_LIMIT="3",o.ERROR_IMAGE="4",o);let ee=(0,m.createIdentifier)("core.image-io.service"),et=class{constructor(){_(this,"_waitCount",0),_(this,"_change$",new p.Subject),_(this,"change$",this._change$),_(this,"_imageSourceCache",/* @__PURE__ */new Map)}setWaitCount(e){this._waitCount=e,this._change$.next(e)}getImageSourceCache(e,t){if(t===Z.BASE64){let t=new Image;return t.src=e,t}return this._imageSourceCache.get(e)}addImageSourceCache(e,t,r){t===Z.BASE64||null==r||this._imageSourceCache.set(e,r)}async getImage(e){return Promise.resolve(e)}async saveImage(e){return new Promise((t,r)=>{if(!w.includes(e.type)){r(Error(J.ERROR_IMAGE_TYPE)),this._decreaseWaiting();return}if(e.size>y){r(Error(J.ERROR_EXCEED_SIZE)),this._decreaseWaiting();return}let n=new FileReader;n.readAsDataURL(e),n.onload=e=>{var n;let i=null==(n=e.target)?void 0:n.result;if(null==i){r(Error(J.ERROR_IMAGE)),this._decreaseWaiting();return}t({imageId:(0,m.Tools).generateRandomId(6),imageSourceType:Z.BASE64,source:i,base64Cache:i,status:J.SUCCUSS}),this._decreaseWaiting()}})}_decreaseWaiting(){this._waitCount-=1,this._change$.next(this._waitCount)}};v(et,"ImageIoService");var er=((s=er||{})[s.forward=0]="forward",s[s.backward=1]="backward",s[s.front=2]="front",s[s.back=3]="back",s),en=((l=en||{})[l.UNRECOGNIZED=-1]="UNRECOGNIZED",l[l.DRAWING_IMAGE=0]="DRAWING_IMAGE",l[l.DRAWING_SHAPE=1]="DRAWING_SHAPE",l[l.DRAWING_CHART=2]="DRAWING_CHART",l[l.DRAWING_TABLE=3]="DRAWING_TABLE",l[l.DRAWING_SMART_ART=4]="DRAWING_SMART_ART",l[l.DRAWING_VIDEO=5]="DRAWING_VIDEO",l[l.DRAWING_GROUP=6]="DRAWING_GROUP",l[l.DRAWING_UNIT=7]="DRAWING_UNIT",l[l.DRAWING_DOM=8]="DRAWING_DOM",l);let ei=(0,m.createIdentifier)("univer.drawing-manager.service"),ea={};var eo=Object.defineProperty,es=Object.getOwnPropertyDescriptor,el=/* @__PURE__ */v((e,t,r,n)=>{for(var i,a=n>1?void 0:n?es(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eo(t,r,a),a},"__decorateClass"),ed=/* @__PURE__ */v((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let eu=(v(h=class extends m.Plugin{constructor(e=ea,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("drawing.config",n)}onStarting(){this._initDependencies()}_initDependencies(){var e;(0,m.mergeOverrideWithDependencies)([[ee,{useClass:et}],[ei,{useClass:q}]],null==(e=this._config)?void 0:e.override).forEach(e=>this._injector.add(e))}},"UniverDrawingPlugin"),_(h,"pluginName","UNIVER_DRAWING_PLUGIN"),h);eu=el([ed(1,(0,m.Inject)(m.Injector)),ed(2,m.IConfigService)],eu)}),i("dvwwo",function(r,i){let a,o;e(r.exports,"DrawingRenderService",function(){return M}),e(r.exports,"OpenImageCropOperation",function(){return ec}),e(r.exports,"DrawingCommonPanel",function(){return ef}),e(r.exports,"COMPONENT_IMAGE_POPUP_MENU",function(){return eI}),e(r.exports,"ImageResetSizeOperation",function(){return eC}),e(r.exports,"ImageCropperObject",function(){return eL}),e(r.exports,"UniverDrawingUIPlugin",function(){return eJ});var s,l,d=n("28sqy"),u=n("3e0Iz"),c=n("7yNYd"),h=n("5gqvu"),m=n("1UDbf"),p=n("fL2Ug"),g=n("lMvMU"),f=n("23cfA"),v=Object.defineProperty,_=(e,t,r)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,I=(e,t)=>v(e,"name",{value:t,configurable:!0}),S=(e,t,r)=>_(e,"symbol"!=typeof t?t+"":t,r);function C(e,t,r,n){let i=n.getDrawingByParam(e);if(null==i)return;let a=(0,d.getDrawingShapeKeyByDrawingSearch)(e),o=r.getObject(a);if(o&&!(o instanceof u.Group))return;if(null!=o){o.addObject(t);return}let s=new u.Group(a);r.addObject(s,u.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(s),s.addObject(t);let{transform:l}=i;l&&s.transformByState({left:l.left,top:l.top,angle:l.angle})}function y(e,t){var r;let n;let i=t?e.getUnit(t):e.getFocusedUnit();if(null==i)return;let a=i.getUnitId();return i.type===c.UniverInstanceType.UNIVER_SHEET?n=null==(r=i.getActiveSheet())?void 0:r.getSheetId():(i.type===c.UniverInstanceType.UNIVER_DOC||i.type===c.UniverInstanceType.UNIVER_SLIDE)&&(n=a),{unitId:a,subUnitId:n,current:i}}I(C,"insertGroupObject"),I(y,"getCurrentUnitInfo");var w,b=Object.defineProperty,R=Object.getOwnPropertyDescriptor,E=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?R(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&b(t,r,a),a},"__decorateClass$5"),T=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$5");let M=(I(w=class{constructor(e,t){this._drawingManagerService=e,this._imageIoService=t}async renderImages(e,t){let{transform:r,drawingType:n,source:i,imageSourceType:a,srcRect:o,prstGeom:s,groupId:l,unitId:c,subUnitId:h,drawingId:m,isMultiTransform:p,transforms:g}=e;if(n!==d.DrawingTypeEnum.DRAWING_IMAGE||!this._drawingManagerService.getDrawingVisible()||null==r)return;let f=p&&g?g:[r],v=[];for(let e of f){let{left:r,top:n,width:g,height:_,angle:I,flipX:S,flipY:y,skewX:w,skewY:b}=e,R=f.indexOf(e),E=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:c,subUnitId:h,drawingId:m},p?R:void 0),T=t.getObject(E);if(null!=T){T.transformByState({left:r,top:n,width:g,height:_,angle:I,flipX:S,flipY:y,skewX:w,skewY:b});continue}let M=this._drawingManagerService.getDrawingOrder(c,h),O=M.indexOf(m),D={...e,zIndex:-1===O?M.length-1:O},U=this._imageIoService.getImageSourceCache(i,a),k=!1;if(null!=U)D.image=U;else{if(a===d.ImageSourceType.UUID)try{D.url=await this._imageIoService.getImage(i)}catch(e){console.error(e);continue}else D.url=i;k=!0}if(t.getObject(E))continue;D.printable=!0;let P=new u.Image(E,D);if(k&&this._imageIoService.addImageSourceCache(i,a,P.getNative()),!this._drawingManagerService.getDrawingVisible())continue;let N=t.addObject(P,u.DRAWING_OBJECT_LAYER_INDEX);this._drawingManagerService.getDrawingEditable()&&N.attachTransformerTo(P),l&&C({drawingId:l,unitId:c,subUnitId:h},P,t,this._drawingManagerService),null!=s&&P.setPrstGeom(s),null!=o&&P.setSrcRect(o),v.push(P)}return v}renderDrawing(e,t){let r=this._drawingManagerService.getDrawingByParam(e);if(null!=r&&r.drawingType===d.DrawingTypeEnum.DRAWING_IMAGE)return this.renderImages(r,t)}},"DrawingRenderService"),w);function O(e,t){let r=[];return e.forEach(e=>{let{oKey:n,left:i,top:a,height:o,width:s,angle:l}=e,u=t.getDrawingOKey(n);if(null==u)return r.push(null),!0;let{unitId:c,subUnitId:h,drawingId:m,drawingType:p}=u,g={unitId:c,subUnitId:h,drawingId:m,drawingType:p,transform:{left:i,top:a,height:o,width:s,angle:l}};p===d.DrawingTypeEnum.DRAWING_IMAGE&&(g.srcRect=e.srcRect),r.push(g)}),r}function D(e){var t,r,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e){if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(r=D(e[t]))&&(n&&(n+=" "),n+=r)}else for(r in e)e[r]&&(n&&(n+=" "),n+=r)}return n}function U(){for(var e,t,r=0,n="",i=arguments.length;r<i;r++)(e=arguments[r])&&(t=D(e))&&(n&&(n+=" "),n+=t);return n}M=E([T(0,d.IDrawingManagerService),T(1,d.IImageIoService)],M),I(O,"getUpdateParams"),I(D,"r"),I(U,"clsx");var k=((a=k||{}).default="0",a.left="1",a.center="2",a.right="3",a.top="4",a.middle="5",a.bottom="6",a.horizon="7",a.vertical="8",a);let P={id:"sheet.operation.set-image-align",type:c.CommandType.OPERATION,handler:/* @__PURE__ */I((e,t)=>!0,"handler")},N={imageCommonPanelGrid:"univer-image-common-panel-grid",imageCommonPanelBorder:"univer-image-common-panel-border",imageCommonPanelTitle:"univer-image-common-panel-title",imageCommonPanelRow:"univer-image-common-panel-row",imageCommonPanelRowVertical:"univer-image-common-panel-row-vertical",imageCommonPanelColumn:"univer-image-common-panel-column",imageCommonPanelColumnCenter:"univer-image-common-panel-column-center",imageCommonPanelInline:"univer-image-common-panel-inline",imageCommonPanelSpan2:"univer-image-common-panel-span2",imageCommonPanelSpan3:"univer-image-common-panel-span3",imageCommonPanelInput:"univer-image-common-panel-input"},x=/* @__PURE__ */I(e=>{let r=(0,c.useDependency)(c.ICommandService),n=(0,c.useDependency)(c.LocaleService),{alignShow:i}=e,[a,o]=(0,h.useState)(k.default),s=[{label:n.t("image-panel.align.default"),value:k.default},{options:[{label:n.t("image-panel.align.left"),value:k.left},{label:n.t("image-panel.align.center"),value:k.center},{label:n.t("image-panel.align.right"),value:k.right}]},{options:[{label:n.t("image-panel.align.top"),value:k.top},{label:n.t("image-panel.align.middle"),value:k.middle},{label:n.t("image-panel.align.bottom"),value:k.bottom}]},{options:[{label:n.t("image-panel.align.horizon"),value:k.horizon},{label:n.t("image-panel.align.vertical"),value:k.vertical}]}];function l(e){o(e),r.executeCommand(P.id,{alignType:e})}I(l,"handleAlignChange");let d=/* @__PURE__ */I(e=>e?"block":"none","gridDisplay");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelGrid,N.imageCommonPanelBorder),style:{display:d(i)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,n.t("image-panel.align.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Select,{value:a,options:s,onChange:l}))))},"DrawingAlign");var A=function(){return(A=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},L=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&0>t.indexOf(n)&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,n=Object.getOwnPropertySymbols(e);i<n.length;i++)0>t.indexOf(n[i])&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]]);return r},F=(0,h.forwardRef)(function(e,t){var r=e.icon,n=e.id,i=e.className,a=e.extend,o=L(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(n," ").concat(i||"").trim(),l=(0,h.useRef)("_".concat($()));return j(r,"".concat(n),{defIds:r.defIds,idSuffix:l.current},A({ref:t,className:s},o),a)});function j(e,t,r,n,i){return(0,h.createElement)(e.tag,A(A({key:t},V(e,r,i)),n),(H(e,r).children||[]).map(function(n,a){return j(n,"".concat(t,"-").concat(e.tag,"-").concat(a),r,void 0,i)}))}function V(e,t,r){var n=A({},e.attrs);null!=r&&r.colorChannel1&&"colorChannel1"===n.fill&&(n.fill=r.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&n["xlink:href"]&&(n["xlink:href"]=n["xlink:href"]+t.idSuffix),Object.entries(n).forEach(function(e){var r=e[0],i=e[1];"string"==typeof i&&(n[r]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),n}function H(e,t){var r,n=t.defIds;return n&&0!==n.length&&"defs"===e.tag&&!(null===(r=e.children)||void 0===r)&&r.length?A(A({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&n&&n.indexOf(e.attrs.id)>-1?A(A({},e),{attrs:A(A({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function $(){return Math.random().toString(36).substring(2,8)}I(j,"render"),I(V,"replaceRuntimeIdsAndExtInAttrs"),I(H,"replaceRuntimeIdsInDefs"),I($,"generateShortUuid"),F.displayName="UniverIcon";var B={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"colorChannel1",d:"M11.0363 12.2367V14.0367C11.0363 14.3681 11.3049 14.6367 11.6363 14.6367C11.9676 14.6367 12.2363 14.3681 12.2363 14.0367V12.2367H14.0364C14.3677 12.2367 14.6364 11.9681 14.6364 11.6367C14.6364 11.3054 14.3677 11.0367 14.0364 11.0367H12.2363V9.23672C12.2363 8.90535 11.9676 8.63672 11.6363 8.63672C11.3049 8.63672 11.0363 8.90535 11.0363 9.23672V11.0367H9.23635C8.90498 11.0367 8.63635 11.3054 8.63635 11.6367C8.63635 11.9681 8.90498 12.2367 9.23635 12.2367H11.0363Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.56365 1.36377C1.90091 1.36377 1.36365 1.90103 1.36365 2.56377V6.16377C1.36365 6.82651 1.90091 7.36377 2.56365 7.36377H6.16365C6.82639 7.36377 7.36365 6.82651 7.36365 6.16377V2.56377C7.36365 1.90103 6.82639 1.36377 6.16365 1.36377H2.56365zM6.16365 2.56377H2.56365L2.56365 6.16377H6.16365V2.56377zM2.56365 8.63647C1.90091 8.63647 1.36365 9.17373 1.36365 9.83647V13.4365C1.36365 14.0992 1.90091 14.6365 2.56365 14.6365H6.16365C6.82639 14.6365 7.36365 14.0992 7.36365 13.4365V9.83647C7.36365 9.17373 6.82639 8.63647 6.16365 8.63647H2.56365zM6.16365 9.83647H2.56365L2.56365 13.4365H6.16365V9.83647zM9.83635 7.36377C9.17361 7.36377 8.63635 6.82651 8.63635 6.16377V2.56377C8.63635 1.90103 9.17361 1.36377 9.83635 1.36377H13.4364C14.0991 1.36377 14.6364 1.90103 14.6364 2.56377V6.16377C14.6364 6.82651 14.0991 7.36377 13.4364 7.36377H9.83635zM9.83635 6.16377V2.56377L13.4364 2.56377V6.16377H9.83635z",fillRule:"evenodd",clipRule:"evenodd"}}]},W=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"autofill",ref:t,icon:B}))});W.displayName="Autofill";var G={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.0045 4.4334C14.8881 4.4334 15.6045 3.71705 15.6045 2.8334 15.6045 1.94974 14.8881 1.2334 14.0045 1.2334H3.70449C2.82084 1.2334 2.10449 1.94974 2.10449 2.8334 2.10449 3.71705 2.82084 4.4334 3.70449 4.4334H14.0045zM14.4045 2.8334C14.4045 3.05431 14.2254 3.2334 14.0045 3.2334H3.70449C3.48358 3.2334 3.30449 3.05431 3.30449 2.8334 3.30449 2.61248 3.48358 2.4334 3.70449 2.4334H14.0045C14.2254 2.4334 14.4045 2.61249 14.4045 2.8334zM14.1544 8.5999C15.038 8.5999 15.7544 7.88356 15.7544 6.9999 15.7544 6.11625 15.038 5.3999 14.1544 5.3999H3.85439C2.97074 5.3999 2.25439 6.11625 2.25439 6.9999 2.25439 7.88356 2.97074 8.5999 3.85439 8.5999H14.1544zM14.5544 6.9999C14.5544 7.22082 14.3753 7.3999 14.1544 7.3999H3.85439C3.63348 7.3999 3.45439 7.22082 3.45439 6.9999 3.45439 6.77899 3.63348 6.5999 3.85439 6.5999H14.1544C14.3753 6.5999 14.5544 6.77899 14.5544 6.9999z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M8.57975 14.5902L6.58023 12.5907C6.34591 12.3564 6.34591 11.9765 6.58023 11.7421 6.81454 11.5078 7.19444 11.5078 7.42876 11.7421L8.40449 12.7179V10.1664C8.40449 9.83504 8.67312 9.56641 9.00449 9.56641 9.33586 9.56641 9.60449 9.83504 9.60449 10.1664V12.7179L10.5802 11.7421C10.8145 11.5078 11.1944 11.5078 11.4288 11.7421 11.6631 11.9765 11.6631 12.3564 11.4288 12.5907L9.42923 14.5902M8.57975 14.5902C8.58121 14.5917 8.58268 14.5931 8.58416 14.5946 8.64077 14.6502 8.70566 14.6923 8.77482 14.7209 8.84557 14.7502 8.92314 14.7664 9.00449 14.7664 9.08585 14.7664 9.16342 14.7502 9.23416 14.7209 9.30332 14.6923 9.36821 14.6502 9.42482 14.5946"}}]},z=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"bottom-single",ref:t,icon:G}))});z.displayName="BottomSingle";var Y={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.97705 7.51296C5.97705 7.18159 6.24568 6.91296 6.57705 6.91296H8.48632C8.81769 6.91296 9.08632 7.18159 9.08632 7.51296 9.08632 7.84433 8.81769 8.11296 8.48632 8.11296H6.57705C6.24568 8.11296 5.97705 7.84433 5.97705 7.51296zM6.57705 9.41028C6.24568 9.41028 5.97705 9.67891 5.97705 10.0103 5.97705 10.3416 6.24568 10.6103 6.57705 10.6103H10.8199C11.1512 10.6103 11.4199 10.3416 11.4199 10.0103 11.4199 9.67891 11.1512 9.41028 10.8199 9.41028H6.57705z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.51074 2.37063C3.51074 1.48697 4.22709 0.77063 5.11074 0.77063H9.80318L9.81294 0.770708C9.97168 0.768161 10.1311 0.82824 10.2511 0.95055L14.4317 5.21408C14.5165 5.30049 14.5697 5.406 14.5917 5.51645C14.6041 5.5644 14.6106 5.61467 14.6106 5.66648V11.6406C14.6106 12.5243 13.8943 13.2406 13.0106 13.2406H5.11074C4.22709 13.2406 3.51074 12.5243 3.51074 11.6406V2.37063ZM10.4032 4.66648V2.81964L12.6063 5.06648H10.8032C10.5823 5.06648 10.4032 4.88739 10.4032 4.66648ZM5.11074 1.97063C4.88983 1.97063 4.71074 2.14972 4.71074 2.37063V11.6406C4.71074 11.8615 4.88983 12.0406 5.11074 12.0406H13.0106C13.2316 12.0406 13.4106 11.8615 13.4106 11.6406V6.26648H10.8032C9.91953 6.26648 9.20318 5.55013 9.20318 4.66648V1.97063H5.11074Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M2.58916 6.6741C2.58916 6.34273 2.32053 6.0741 1.98916 6.0741C1.65779 6.0741 1.38916 6.34273 1.38916 6.6741V12.6294C1.38916 14.0653 2.55322 15.2294 3.98916 15.2294H9.41408C9.74545 15.2294 10.0141 14.9607 10.0141 14.6294C10.0141 14.298 9.74545 14.0294 9.41408 14.0294H3.98916C3.21596 14.0294 2.58916 13.4026 2.58916 12.6294V6.6741Z"}}]},K=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"create-copy-single",ref:t,icon:Y}))});K.displayName="CreateCopySingle";var q={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.38125 1.16211C6.49759 1.16211 5.78125 1.87845 5.78125 2.76211V5.6377H2.87783C1.99418 5.6377 1.27783 6.35404 1.27783 7.2377V13.2377C1.27783 14.1214 1.99418 14.8377 2.87783 14.8377H8.87783C9.76149 14.8377 10.4778 14.1214 10.4778 13.2377V10.3621H13.3813C14.2649 10.3621 14.9813 9.64577 14.9813 8.76211V2.76211C14.9813 1.87845 14.2649 1.16211 13.3813 1.16211H7.38125ZM10.4778 9.16211H13.3813C13.6022 9.16211 13.7812 8.98302 13.7812 8.76211V2.76211C13.7812 2.5412 13.6022 2.36211 13.3813 2.36211H7.38125C7.16034 2.36211 6.98125 2.5412 6.98125 2.76211V5.6377H8.87783C9.76149 5.6377 10.4778 6.35404 10.4778 7.2377V9.16211ZM6.98125 6.8377H8.87783C9.09875 6.8377 9.27783 7.01678 9.27783 7.2377V9.16211H7.38125C7.16034 9.16211 6.98125 8.98302 6.98125 8.76211V6.8377ZM5.78125 6.8377V8.76211C5.78125 9.64577 6.49759 10.3621 7.38125 10.3621H9.27783V13.2377C9.27783 13.4586 9.09875 13.6377 8.87783 13.6377H2.87783C2.65692 13.6377 2.47783 13.4586 2.47783 13.2377V7.2377C2.47783 7.01678 2.65692 6.8377 2.87783 6.8377H5.78125Z",fillRule:"evenodd",clipRule:"evenodd"}}]},X=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"group-single",ref:t,icon:q}))});X.displayName="GroupSingle";var Q={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M11.3536 6.14645C11.5488 6.34171 11.5488 6.65829 11.3536 6.85355L8.35355 9.85355C8.15829 10.0488 7.84171 10.0488 7.64645 9.85355L4.64645 6.85355C4.45118 6.65829 4.45118 6.34171 4.64645 6.14645C4.84171 5.95118 5.15829 5.95118 5.35355 6.14645L8 8.79289L10.6464 6.14645C10.8417 5.95118 11.1583 5.95118 11.3536 6.14645Z",fillRule:"evenodd",clipRule:"evenodd"}}]},Z=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"more-down-single",ref:t,icon:Q}))});Z.displayName="MoreDownSingle";var J={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 2.96401C1.25 3.84767 1.96634 4.56401 2.85 4.56401H13.15C14.0337 4.56401 14.75 3.84767 14.75 2.96401C14.75 2.08036 14.0337 1.36401 13.15 1.36401H2.85C1.96635 1.36401 1.25 2.08036 1.25 2.96401ZM2.85 3.36401C2.62909 3.36401 2.45 3.18493 2.45 2.96401C2.45 2.7431 2.62909 2.56401 2.85 2.56401H13.15C13.3709 2.56401 13.55 2.7431 13.55 2.96401C13.55 3.18493 13.3709 3.36401 13.15 3.36401H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 11.6118C5.80995 11.3774 6.18985 11.3774 6.42417 11.6118L7.3999 12.5875V6.36951C7.3999 6.03814 7.66853 5.76951 7.9999 5.76951C8.33127 5.76951 8.5999 6.03814 8.5999 6.36951V12.5875L9.57564 11.6118C9.80995 11.3774 10.1899 11.3774 10.4242 11.6118C10.6585 11.8461 10.6585 12.226 10.4242 12.4603L8.4324 14.452C8.32324 14.5655 8.16982 14.6362 7.9999 14.6362C7.82998 14.6362 7.67655 14.5655 7.56739 14.452L5.57564 12.4603C5.34132 12.226 5.34132 11.8461 5.57564 11.6118Z"}}]},ee=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"move-down-single",ref:t,icon:J}))});ee.displayName="MoveDownSingle";var et={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M1.25 13.036C1.25 12.1523 1.96634 11.436 2.85 11.436H13.15C14.0337 11.436 14.75 12.1523 14.75 13.036C14.75 13.9196 14.0337 14.636 13.15 14.636H2.85C1.96635 14.636 1.25 13.9196 1.25 13.036ZM2.85 12.636C2.62909 12.636 2.45 12.8151 2.45 13.036C2.45 13.2569 2.62909 13.436 2.85 13.436H13.15C13.3709 13.436 13.55 13.2569 13.55 13.036C13.55 12.8151 13.3709 12.636 13.15 12.636H2.85Z",fillRule:"evenodd",clipRule:"evenodd"}},{tag:"path",attrs:{fill:"currentColor",d:"M5.57564 4.38825C5.80995 4.62256 6.18985 4.62256 6.42417 4.38825L7.3999 3.41251V9.63049C7.3999 9.96186 7.66853 10.2305 7.9999 10.2305C8.33127 10.2305 8.5999 9.96186 8.5999 9.63049V3.41251L9.57564 4.38825C9.80995 4.62256 10.1899 4.62256 10.4242 4.38825C10.6585 4.15393 10.6585 3.77403 10.4242 3.53972L8.4324 1.54796C8.32324 1.43445 8.16982 1.36382 7.9999 1.36382C7.82998 1.36382 7.67655 1.43446 7.56739 1.54797L5.57564 3.53972C5.34132 3.77403 5.34132 4.15393 5.57564 4.38825Z"}}]},er=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"move-up-single",ref:t,icon:et}))});er.displayName="MoveUpSingle";var en={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.82994 1.40913C7.88746 1.35161 7.95376 1.30821 8.02453 1.27893C8.09527 1.24959 8.17285 1.2334 8.2542 1.2334C8.33555 1.2334 8.41313 1.24959 8.48387 1.27893C8.55464 1.30821 8.62094 1.35161 8.67846 1.40913L10.6785 3.40913C10.9128 3.64345 10.9128 4.02335 10.6785 4.25766C10.4441 4.49198 10.0642 4.49198 9.82994 4.25766L8.8542 3.28193V5.8334C8.8542 6.16477 8.58557 6.4334 8.2542 6.4334C7.92283 6.4334 7.6542 6.16477 7.6542 5.8334V3.28193L6.67846 4.25766C6.44415 4.49198 6.06425 4.49198 5.82994 4.25766C5.59562 4.02335 5.59562 3.64345 5.82994 3.40913L7.82994 1.40913Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1.50439 9C1.50439 8.11634 2.22074 7.4 3.10439 7.4H13.4044C14.288 7.4 15.0044 8.11634 15.0044 9 15.0044 9.88366 14.2881 10.6 13.4044 10.6H3.1044C2.22074 10.6 1.50439 9.88366 1.50439 9zM3.10439 8.6C2.88348 8.6 2.70439 8.77909 2.70439 9 2.70439 9.22091 2.88348 9.4 3.1044 9.4H13.4044C13.6253 9.4 13.8044 9.22091 13.8044 9 13.8044 8.77909 13.6253 8.6 13.4044 8.6H3.10439zM1.6543 13.1665C1.6543 12.2828 2.37064 11.5665 3.2543 11.5665H13.5543C14.438 11.5665 15.1543 12.2828 15.1543 13.1665 15.1543 14.0502 14.438 14.7665 13.5543 14.7665H3.2543C2.37064 14.7665 1.6543 14.0502 1.6543 13.1665zM3.2543 12.7665C3.03338 12.7665 2.8543 12.9456 2.8543 13.1665 2.8543 13.3874 3.03338 13.5665 3.2543 13.5665H13.5543C13.7752 13.5665 13.9543 13.3874 13.9543 13.1665 13.9543 12.9456 13.7752 12.7665 13.5543 12.7665H3.2543z",fillRule:"evenodd",clipRule:"evenodd"}}]},ei=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"topmost-single",ref:t,icon:en}))});ei.displayName="TopmostSingle";var ea={tag:"svg",attrs:{fill:"none",viewBox:"0 0 17 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M7.46855 2.83731C7.46855 2.61639 7.64764 2.4373 7.86855 2.4373H13.8603C14.0812 2.4373 14.2603 2.61639 14.2603 2.8373V9.5049C14.2603 9.72581 14.0812 9.90489 13.8603 9.90489H12.866C12.5346 9.90489 12.266 10.1735 12.266 10.5049C12.266 10.8363 12.5346 11.1049 12.866 11.1049H13.8603C14.7439 11.1049 15.4603 10.3886 15.4603 9.5049V2.8373C15.4603 1.95365 14.7439 1.2373 13.8603 1.2373H7.86855C6.9849 1.2373 6.26855 1.95365 6.26855 2.83731V3.48688C6.26855 3.81825 6.53718 4.08688 6.86855 4.08688C7.19993 4.08688 7.46855 3.81825 7.46855 3.48688V2.83731Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M3.19888 5.56299C2.31522 5.56299 1.59888 6.27933 1.59888 7.16299V13.163C1.59888 14.0466 2.31522 14.763 3.19888 14.763H9.19888C10.0825 14.763 10.7989 14.0466 10.7989 13.163V7.16299C10.7989 6.27933 10.0825 5.56299 9.19888 5.56299H3.19888ZM2.79888 7.16299C2.79888 6.94207 2.97796 6.76299 3.19888 6.76299H9.19888C9.41979 6.76299 9.59888 6.94207 9.59888 7.16299V13.163C9.59888 13.3839 9.41979 13.563 9.19888 13.563H3.19888C2.97796 13.563 2.79888 13.3839 2.79888 13.163V7.16299Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eo=(0,h.forwardRef)(function(e,t){return(0,h.createElement)(F,Object.assign({},e,{id:"ungroup-single",ref:t,icon:ea}))});eo.displayName="UngroupSingle";let es=/* @__PURE__ */I(e=>{let{arrangeShow:r,drawings:n}=e,i=(0,c.useDependency)(c.LocaleService),a=(0,c.useDependency)(d.IDrawingManagerService),o=/* @__PURE__ */I(e=>e?"block":"none","gridDisplay"),[s,l]=(0,h.useState)(n);(0,h.useEffect)(()=>{let e=a.focus$.subscribe(e=>{l(e)});return()=>{e.unsubscribe()}},[]);let u=/* @__PURE__ */I(e=>{let t=s[0].unitId,r=s[0].subUnitId,n=s.map(e=>e.drawingId);a.featurePluginOrderUpdateNotification({unitId:t,subUnitId:r,drawingIds:n,arrangeType:e})},"onArrangeBtnClick");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelGrid,style:{display:o(r)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,i.t("image-panel.arrange.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */I(()=>{u(d.ArrangeTypeEnum.forward)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:N.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(er,null),i.t("image-panel.arrange.forward")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */I(()=>{u(d.ArrangeTypeEnum.backward)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:N.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(ee,null),i.t("image-panel.arrange.backward"))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */I(()=>{u(d.ArrangeTypeEnum.front)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:N.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(ei,null),i.t("image-panel.arrange.front")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */I(()=>{u(d.ArrangeTypeEnum.back)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:N.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(z,null),i.t("image-panel.arrange.back"))))))},"DrawingArrange"),el=/* @__PURE__ */I(e=>{let r=(0,c.useDependency)(c.LocaleService),n=(0,c.useDependency)(u.IRenderManagerService),i=(0,c.useDependency)(d.IDrawingManagerService),{hasGroup:a,drawings:o}=e,[s,l]=(0,h.useState)(!1),[p,g]=(0,h.useState)(!0),[f,v]=(0,h.useState)(!0),_=/* @__PURE__ */I(e=>e?"block":"none","gridDisplay"),S=/* @__PURE__ */I(()=>{let e=i.getFocusDrawings(),{unitId:t,subUnitId:r}=e[0],n=(0,c.Tools).generateRandomId(10),a=(0,u.getGroupState)(0,0,e.map(e=>e.transform||{})),o={unitId:t,subUnitId:r,drawingId:n,drawingType:d.DrawingTypeEnum.DRAWING_GROUP,transform:a},s=e.map(e=>{let t=e.transform||{left:0,top:0},{unitId:r,subUnitId:i,drawingId:o}=e;return{unitId:r,subUnitId:i,drawingId:o,transform:{...t,left:t.left-a.left,top:t.top-a.top},groupId:n}});i.featurePluginGroupUpdateNotification([{parent:o,children:s}])},"onGroupBtnClick"),C=/* @__PURE__ */I(e=>{if(e.drawingType!==d.DrawingTypeEnum.DRAWING_GROUP)return;let{unitId:t,subUnitId:r,drawingId:n,transform:a={width:0,height:0}}=e;if(null==a)return;let o=i.getDrawingsByGroup({unitId:t,subUnitId:r,drawingId:n});if(0!==o.length)return{parent:e,children:o.map(e=>{let{transform:t}=e,{unitId:r,subUnitId:n,drawingId:i}=e,o=(0,u.transformObjectOutOfGroup)(t||{},a,a.width||0,a.height||0);return{unitId:r,subUnitId:n,drawingId:i,transform:{...t,...o},groupId:void 0}})}},"ungroup"),y=/* @__PURE__ */I(()=>{let e=i.getFocusDrawings().map(e=>C(e)).filter(e=>null!=e);0!==e.length&&i.featurePluginUngroupUpdateNotification(e)},"onUngroupBtnClick");return(0,h.useEffect)(()=>{let e=o[0];if(null==e)return;let{unitId:t}=e,r=n.getRenderById(t),a=null==r?void 0:r.scene;if(null==a)return;let s=a.getTransformerByCreate(),u=s.clearControl$.subscribe(e=>{!0===e&&l(!1)}),c=s.changeStart$.subscribe(e=>{let{objects:t}=e,r=O(t,i),n=r.filter(e=>(null==e?void 0:e.drawingType)===d.DrawingTypeEnum.DRAWING_GROUP),a=!1,o=!1;r.length>1&&(a=!0),n.length>0&&(o=!0),l(a||o),g(a),v(o)});return()=>{c.unsubscribe(),u.unsubscribe()}},[]),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelGrid,N.imageCommonPanelBorder),style:{display:_(!0===a&&s)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,r.t("image-panel.group.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2,N.imageCommonPanelColumnCenter)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */I(()=>{S()},"onClick"),style:{display:_(p)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:N.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(X,null),r.t("image-panel.group.group")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2,N.imageCommonPanelColumnCenter)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */I(()=>{y()},"onClick"),style:{display:_(f)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:N.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(eo,null),r.t("image-panel.group.unGroup"))))))},"DrawingGroup"),ed=[-3600,3600],eu=/* @__PURE__ */I(e=>{var r;let n=(0,c.useDependency)(c.LocaleService),i=(0,c.useDependency)(d.IDrawingManagerService),a=(0,c.useDependency)(u.IRenderManagerService),{drawings:o,transformShow:s}=e,l=o[0];if(null==l)return;let p=l.transform;if(null==p)return;let{unitId:g,subUnitId:f,drawingId:v,drawingType:_}=l,S=a.getRenderById(g),C=null==S?void 0:S.scene;if(null==C)return;let y=null==(r=C.getEngine())?void 0:r.activeScene;if(null==y)return;let w=C.getTransformerByCreate(),{width:b=0,height:R=0,left:E=0,top:T=0,angle:M=0}=p,[D,k]=(0,h.useState)(b),[P,x]=(0,h.useState)(R),[A,L]=(0,h.useState)(E),[F,j]=(0,h.useState)(T),[V,H]=(0,h.useState)(M),[$,B]=(0,h.useState)(w.keepRatio),W=/* @__PURE__ */I((e,t,r,n)=>{let{width:i,height:a}=y,{ancestorLeft:o,ancestorTop:s}=C,l=e,d=t,u=r,c=n;return e+o<0&&(l=-o),t+s<0&&(d=-s),(u=i-l-o)<20&&(u=20),(c=a-d-s)<20&&(c=20),e+u+o>i&&(l=i-r-o),t+c+s>a&&(d=a-n-s),{limitLeft:l,limitTop:d,limitWidth:u,limitHeight:c}},"checkMoveBoundary"),G=/* @__PURE__ */I(e=>{let{objects:t}=e,r=O(t,i);if(1!==r.length)return;let n=r[0];if(null==n)return;let{transform:a}=n;if(null==a)return;let{width:o,height:s,left:l,top:d,angle:u}=a;null!=o&&k(o),null!=s&&x(s),null!=l&&L(l),null!=d&&j(d),null!=u&&H(u)},"changeObs");(0,h.useEffect)(()=>{let e=[w.changeStart$.subscribe(e=>{G(e)}),w.changing$.subscribe(e=>{G(e)}),w.changeEnd$.subscribe(e=>{G(e)}),i.focus$.subscribe(e=>{if(1!==e.length)return;let t=i.getDrawingByParam(e[0]);if(null==t)return;let r=t.transform;if(null==r)return;let{width:n,height:a,left:o,top:s,angle:l}=r;null!=n&&k(n),null!=a&&x(a),null!=o&&L(o),null!=s&&j(s),null!=l&&H(l)})];return()=>{e.forEach(e=>e.unsubscribe())}},[]);let z=(0,c.debounce)(e=>{if(null==e)return;let{limitWidth:t,limitHeight:r}=W(A,F,e=Math.max(e,20),P),n={unitId:g,subUnitId:f,drawingId:v,drawingType:_,transform:{width:e=Math.min(e,t)}};if($){let t=e/D*P;if((t=Math.max(t,20))>r)return;x(t),n.transform.height=t}k(e),i.featurePluginUpdateNotification([n]),w.refreshControls().changeNotification()},300),Y=(0,c.debounce)(e=>{if(null==e)return;let{limitHeight:t,limitWidth:r}=W(A,F,D,e=Math.max(e,20)),n={unitId:g,subUnitId:f,drawingId:v,drawingType:_,transform:{height:e=Math.min(e,t)}};if($){let t=e/P*D;if((t=Math.max(t,20))>r)return;k(t),n.transform.width=t}x(e),i.featurePluginUpdateNotification([n]),w.refreshControls().changeNotification()},300),K=(0,c.debounce)(e=>{if(null==e)return;let{limitLeft:t}=W(e,F,D,P),r={unitId:g,subUnitId:f,drawingId:v,drawingType:_,transform:{left:e=t}};L(e),i.featurePluginUpdateNotification([r]),w.refreshControls().changeNotification()},300),q=(0,c.debounce)(e=>{if(null==e)return;let{limitTop:t}=W(A,e,D,P),r={unitId:g,subUnitId:f,drawingId:v,drawingType:_,transform:{top:e=t}};j(e),i.featurePluginUpdateNotification([r]),w.refreshControls().changeNotification()},300),X=/* @__PURE__ */I(e=>{if(null==e)return;let[t,r]=ed;e<t&&(e=t),e>r&&(e=r);let n={unitId:g,subUnitId:f,drawingId:v,drawingType:_,transform:{angle:e}};H(e),i.featurePluginUpdateNotification([n]),w.refreshControls().changeNotification()},"handleRotationChange"),Q=/* @__PURE__ */I(e=>{B(e),w.keepRatio=e},"handleLockRatioChange"),Z=/* @__PURE__ */I(e=>e?"block":"none","gridDisplay");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelGrid,N.imageCommonPanelBorder),style:{display:Z(s)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,n.t("image-panel.transform.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},n.t("image-panel.transform.width"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:D,onChange:/* @__PURE__ */I(e=>{z(e)},"onChange"),className:N.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},n.t("image-panel.transform.height"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:P,onChange:/* @__PURE__ */I(e=>{Y(e)},"onChange"),className:N.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},n.t("image-panel.transform.lock"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelRow,N.imageCommonPanelRowVertical)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Checkbox,{checked:$,onChange:Q})))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},n.t("image-panel.transform.x"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:A,onChange:/* @__PURE__ */I(e=>{K(e)},"onChange"),className:N.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},n.t("image-panel.transform.y"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:F,onChange:/* @__PURE__ */I(e=>{q(e)},"onChange"),className:N.imageCommonPanelInput}))))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan3)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("label",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},n.t("image-panel.transform.rotate"))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelColumn},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.InputNumber,{precision:1,value:V,onChange:X,className:N.imageCommonPanelInput})))))))},"DrawingTransform"),ec={id:"sheet.operation.open-image-crop",type:c.CommandType.OPERATION,handler:/* @__PURE__ */I((e,t)=>!0,"handler")},eh={id:"sheet.operation.close-image-crop",type:c.CommandType.OPERATION,handler:/* @__PURE__ */I((e,t)=>!0,"handler")};var em=((o=em||{}).FREE="0",o.R1_1="1",o.R16_9="2",o.R9_16="3",o.R5_4="4",o.R4_5="5",o.R4_3="6",o.R3_4="7",o.R3_2="8",o.R2_3="9",o);let ep={id:"sheet.operation.Auto-image-crop",type:c.CommandType.OPERATION,handler:/* @__PURE__ */I((e,t)=>!0,"handler")},eg=/* @__PURE__ */I(e=>{let r=(0,c.useDependency)(c.ICommandService),n=(0,c.useDependency)(c.LocaleService),{drawings:i,cropperShow:a}=e;if(null==i[0])return;let[o,s]=(0,h.useState)(em.FREE),l=(0,h.useRef)(!1),d=[{label:n.t("image-panel.crop.mode"),value:em.FREE},{label:"1:1",value:em.R1_1},{label:"16:9",value:em.R16_9},{label:"9:16",value:em.R9_16},{label:"5:4",value:em.R5_4},{label:"4:5",value:em.R4_5},{label:"4:3",value:em.R4_3},{label:"3:4",value:em.R3_4},{label:"3:2",value:em.R3_2},{label:"2:3",value:em.R2_3}];function u(e){s(e),l.current&&r.executeCommand(ep.id,{cropType:e})}(0,h.useEffect)(()=>{let e=r.onCommandExecuted(e=>{if(e.id===eh.id){let t=e.params;null!=t&&t.isAuto||(l.current=!1)}});return()=>{null==e||e.dispose()}},[]),I(u,"handleCropChange");let p=/* @__PURE__ */I(e=>e?"block":"none","gridDisplay"),g=/* @__PURE__ */I(e=>{r.executeCommand(ep.id,{cropType:e}),l.current=!0},"onCropperBtnClick");return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelGrid,N.imageCommonPanelBorder),style:{display:p(a)}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:N.imageCommonPanelRow},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelTitle)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,n.t("image-panel.crop.title")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelRow,N.imageCommonPanelRowVertical)},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Button,{size:"small",onClick:/* @__PURE__ */I(()=>{g(o)},"onClick")},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:N.imageCommonPanelInline},/* @__PURE__ *//*@__PURE__*/t(h).createElement(K,null),n.t("image-panel.crop.start")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(N.imageCommonPanelColumn,N.imageCommonPanelSpan2)},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Select,{value:o,options:d,onChange:u}))))},"ImageCropper"),ef=/* @__PURE__ */I(e=>{let r=(0,c.useDependency)(d.IDrawingManagerService),n=(0,c.useDependency)(u.IRenderManagerService),i=(0,c.useDependency)(c.LocaleService),{drawings:a,hasArrange:o=!0,hasTransform:s=!0,hasAlign:l=!0,hasCropper:m=!0,hasGroup:p=!0}=e,g=a[0];if(null==g)return;let{unitId:f}=g,v=n.getRenderById(f),_=null==v?void 0:v.scene;if(null==_)return;let I=_.getTransformerByCreate(),[S,C]=(0,h.useState)(!0),[y,w]=(0,h.useState)(!0),[b,R]=(0,h.useState)(!1),[E,T]=(0,h.useState)(!0),[M,D]=(0,h.useState)(!1);return(0,h.useEffect)(()=>{let e=I.clearControl$.subscribe(e=>{!0===e&&(C(!1),w(!1),R(!1),T(!1),D(!0))}),t=I.changeStart$.subscribe(e=>{let{objects:t}=e,n=O(t,r);0===n.length?(C(!1),w(!1),R(!1),T(!1),D(!0)):(1===n.length?(C(!0),w(!0),R(!1),T(!0)):(C(!0),w(!1),R(!0),T(!1)),D(!1))}),n=r.focus$.subscribe(e=>{0===e.length?(C(!1),w(!1),R(!1),T(!1),D(!0)):(1===e.length?(C(!0),w(!0),R(!1),T(!0)):(C(!0),w(!1),R(!0),T(!1)),D(!1))});return()=>{t.unsubscribe(),e.unsubscribe(),n.unsubscribe()}},[]),/* @__PURE__ *//*@__PURE__*/t(h).createElement(/*@__PURE__*/t(h).Fragment,null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{style:{display:!0===M?"block":"none",height:"100%"}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100%",top:"50%",marginTop:"-100px"}},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",null,i.t("image-panel.null")))),/* @__PURE__ *//*@__PURE__*/t(h).createElement(es,{arrangeShow:!0===o&&S,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(eu,{transformShow:!0===s&&y,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(x,{alignShow:!0===l&&b,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(eg,{cropperShow:!0===m&&E,drawings:a}),/* @__PURE__ *//*@__PURE__*/t(h).createElement(el,{hasGroup:p,drawings:a}))},"DrawingCommonPanel"),ev={imagePopupMenu:"univer-image-popup-menu",imagePopupMenuItem:"univer-image-popup-menu-item",imagePopupMenuItemTitle:"univer-image-popup-menu-item-title",btnContainer:"univer-btn-container",btnContainerExpand:"univer-btn-container-expand"},e_=/* @__PURE__ */I(e=>{var r,n;let i=null==(n=null==(r=e.popup)?void 0:r.extraProps)?void 0:n.menuItems;if(!i)return null;let a=(0,c.useDependency)(c.ICommandService),o=(0,c.useDependency)(c.LocaleService),[s,l]=(0,h.useState)(!1),[d,u]=(0,h.useState)(!1),p=/* @__PURE__ */I(()=>{u(!0)},"handleMouseEnter"),g=/* @__PURE__ */I(()=>{u(!1)},"handleMouseLeave"),f=/* @__PURE__ */I(e=>{l(e)},"onVisibleChange"),v=/* @__PURE__ */I(e=>{a.executeCommand(e.commandId,e.commandParams),l(!1)},"handleClick"),_=s||d,S=i.filter(e=>!e.disable);return /* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{onMouseEnter:p,onMouseLeave:g},/* @__PURE__ *//*@__PURE__*/t(h).createElement(m.Dropdown,{placement:"bottomLeft",trigger:["click"],overlay:/* @__PURE__ *//*@__PURE__*/t(h).createElement("ul",{className:ev.imagePopupMenu},S.map(e=>/* @__PURE__ *//*@__PURE__*/t(h).createElement("li",{key:e.index,onClick:/* @__PURE__ */I(()=>v(e),"onClick"),className:ev.imagePopupMenuItem},/* @__PURE__ *//*@__PURE__*/t(h).createElement("span",{className:ev.imagePopupMenuItemTitle},o.t(e.label))))),visible:s,onVisibleChange:f},/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",{className:U(ev.btnContainer,{[ev.btnContainerExpand]:s})},/* @__PURE__ *//*@__PURE__*/t(h).createElement(W,{style:{color:"#35322B"},extend:{colorChannel1:"rgb(var(--green-700, #409f11))"}}),_&&/* @__PURE__ *//*@__PURE__*/t(h).createElement(Z,{style:{color:"#CCCCCC",fontSize:"8px",marginLeft:"8px"}}))))},"ImagePopupMenu"),eI="COMPONENT_IMAGE_POPUP_MENU",eS={},eC={id:"sheet.operation.image-reset-size",type:c.CommandType.OPERATION,handler:/* @__PURE__ */I((e,t)=>!0,"handler")},ey="COMPONENT_IMAGE_VIEWER",ew=/* @__PURE__ */I(e=>{let{src:r}=e;return r?/* @__PURE__ *//*@__PURE__*/t(h).createElement("div",null,/* @__PURE__ *//*@__PURE__*/t(h).createElement("img",{src:r,alt:"Univer Image Viewer",style:{width:"100%",height:"100%",position:"relative"}})):null},"ImageViewer");var eb,eR=Object.defineProperty,eE=Object.getOwnPropertyDescriptor,eT=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eE(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eR(t,r,a),a},"__decorateClass$4"),eM=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$4");let eO=(I(eb=class extends c.Disposable{constructor(e,t){super(),this._componentManager=e,this._commandService=t,this._init()}_initCustomComponents(){let e=this._componentManager;this.disposeWithMe(e.register(eI,e_)),this.disposeWithMe(e.register(ey,ew))}_initCommands(){[ec,eh,eC,P,ep].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_init(){this._initCommands(),this._initCustomComponents()}},"DrawingUIController"),eb);eO=eT([eM(0,(0,c.Inject)(p.ComponentManager)),eM(1,c.ICommandService)],eO);var eD,eU=Object.defineProperty,ek=Object.getOwnPropertyDescriptor,eP=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?ek(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eU(t,r,a),a},"__decorateClass$3"),eN=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$3");let ex=(I(eD=class extends c.Disposable{constructor(e,t,r,n){super(),S(this,"_sceneListenerOnDrawingMap",/* @__PURE__ */new WeakSet),this._currentUniverService=e,this._commandService=t,this._renderManagerService=r,this._drawingManagerService=n,this._initialize()}dispose(){super.dispose()}_initialize(){this._recoveryImages(),this._drawingAddListener(),this._drawingRemoveListener(),this._drawingUpdateListener(),this._commandExecutedListener(),this._drawingArrangeListener(),this._drawingGroupListener(),this._drawingRefreshListener(),this._drawingVisibleListener()}_recoveryImages(){let e=this._drawingManagerService.drawingManagerData,t=y(this._currentUniverService);if(null==t)return;let{unitId:r,subUnitId:n}=t;Object.keys(e).forEach(t=>{Object.keys(e[t]).forEach(i=>{let a=e[t][i].data;null==a||t!==r||i!==n||Object.keys(a).forEach(e=>{a[e]&&this._insertDrawing([{unitId:t,subUnitId:i,drawingId:e}])})})})}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===P.id){let t=e.params;null!=t&&this._drawingAlign(t)}}))}_drawingGroupListener(){this.disposeWithMe(this._drawingManagerService.group$.subscribe(e=>{this._groupDrawings(e)})),this.disposeWithMe(this._drawingManagerService.ungroup$.subscribe(e=>{this._ungroupDrawings(e)}))}_getSceneAndTransformerByDrawingSearch(e){if(null==e)return;let t=this._renderManagerService.getRenderById(e),r=null==t?void 0:t.scene;if(null==r)return null;let n=r.getTransformerByCreate();return{scene:r,transformer:n}}_groupDrawings(e){e.forEach(e=>{this._groupDrawing(e)})}_groupDrawing(e){let{parent:t,children:r}=e,{unitId:n,subUnitId:i,drawingId:a}=t,o=this._getSceneAndTransformerByDrawingSearch(t.unitId);if(null==o)return;let{scene:s,transformer:l}=o;this._commandService.syncExecuteCommand(eh.id);let c=[];if(r.forEach(e=>{let t=(0,d.getDrawingShapeKeyByDrawingSearch)(e),r=s.getObjectIncludeInGroup(t);if(null==r||c.includes(r))return;c.push(r);let{transform:n}=e;null!=n&&(r.classType===u.RENDER_CLASS_TYPE.GROUP?r.transformByState({left:n.left,top:n.top}):r.transformByState(n))}),0===c.length)return;let h=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:n,subUnitId:i,drawingId:a}),m=new u.Group(h);s.addObject(m,u.DRAWING_OBJECT_LAYER_INDEX).attachTransformerTo(m),m.addObjects(...c),t.transform&&m.transformByState({left:t.transform.left,top:t.transform.top}),l.clearSelectedObjects(),l.setSelectedControl(m)}_ungroupDrawings(e){e.forEach(e=>{this._ungroupDrawing(e)})}_ungroupDrawing(e){let{parent:t,children:r}=e,n=this._getSceneAndTransformerByDrawingSearch(t.unitId);if(null==n)return;let{scene:i,transformer:a}=n;r.forEach(e=>{let t=(0,d.getDrawingShapeKeyByDrawingSearch)(e),r=i.getObjectIncludeInGroup(t);if(null==r)return!0;if(null==r)return;let{transform:n}=e;null!=n&&(r.classType===u.RENDER_CLASS_TYPE.GROUP?r.transformByState({left:n.left,top:n.top}):r.transformByState(n))});let o=(0,d.getDrawingShapeKeyByDrawingSearch)(t),s=i.getObject(o),{width:l,height:c}=s;s.getObjects().forEach(e=>{s.removeSelfObjectAndTransform(e.oKey,l,c)}),s.dispose(),a.clearSelectedObjects()}_drawingAlign(e){let{alignType:t}=e,r=this._drawingManagerService.getFocusDrawings();if(t===k.default)return;let n=[],i=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY,l=0;r.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:d,drawingType:u}=e,c=this._drawingManagerService.getDrawingByParam({unitId:t,subUnitId:r,drawingId:d});if(null==c||null==c.transform)return;n.push({unitId:t,subUnitId:r,drawingId:d,drawingType:u,transform:c.transform});let{left:h=0,top:m=0,width:p=0,height:g=0}=c.transform;i=Math.min(i,h),a=Math.min(a,m),o=Math.max(o,h+p),s=Math.max(s,m+g),l++}),0!==l&&(this._sortDrawingTransform(n,t),this._applyAlignType(n,t,i,a,o,s,l))}_applyAlignType(e,t,r,n,i,a,o){let s=Math.round((i-r)/o*10)/10,l=Math.round((a-n)/o*10)/10,d=[],u=this._getSceneAndTransformerByDrawingSearch(e[0].unitId);if(null==u)return;let{scene:c,transformer:h}=u;e.forEach((e,o)=>{let{unitId:u,subUnitId:c,drawingId:h,transform:m,drawingType:p}=e,{left:g=0,top:f=0,width:v=0,height:_=0}=m,I=g,S=f;switch(t){case k.left:I=r;break;case k.center:I=r+(i-r)/2-v/2;break;case k.right:I=i-v;break;case k.top:S=n;break;case k.middle:S=n+(a-n)/2-_/2;break;case k.bottom:S=a-_;break;case k.horizon:I=r+s*o;break;case k.vertical:S=n+l*o}(I!==g||S!==f)&&d.push({unitId:u,subUnitId:c,drawingId:h,drawingType:p,transform:{left:I,top:S}})}),this._drawingManagerService.featurePluginUpdateNotification(d),h.refreshControls().changeNotification()}_sortDrawingTransform(e,t){e.sort((e,r)=>{let n=e.transform,i=r.transform,{left:a=0,top:o=0,width:s=0,height:l=0}=n,{left:d=0,top:u=0,width:c=0,height:h=0}=i;switch(t){case k.left:return a-d;case k.center:return a+s/2-(d+c/2);case k.right:return a+s-(d+c);case k.top:return o-u;case k.middle:return o+l/2-(u+h/2);case k.bottom:return o+l-(u+h);case k.horizon:return a+s/2-(d+c/2);case k.vertical:return o+l/2-(u+h/2);default:return 0}})}_drawingArrangeListener(){this.disposeWithMe(this._drawingManagerService.order$.subscribe(e=>{this._drawingArrange(e)}))}_drawingArrange(e){let{unitId:t,subUnitId:r,drawingIds:n}=e,i=this._getSceneAndTransformerByDrawingSearch(t);if(null==i)return;let{scene:a}=i;n.forEach(e=>{let n=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:e}),i=a.fuzzyMathObjects(n,!0);if(null==i||0===i.length)return;let o=this._drawingManagerService.getDrawingOrder(t,r).indexOf(e);for(let e of i)e.setProps({zIndex:o}),e.makeDirty()})}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{this._insertDrawing(e)}))}_insertDrawing(e){let t=[];e.forEach(e=>{let{unitId:r}=e;if(null==this._drawingManagerService.getDrawingByParam(e))return;let n=this._getSceneAndTransformerByDrawingSearch(r);if(null==n)return;let{scene:i}=n;t.includes(i)||t.push(i)}),t.forEach(e=>{this._sceneListenerOnDrawingMap.has(e)||(this._addListenerOnDrawing(e),this._sceneListenerOnDrawingMap.add(e))})}_drawingRemoveListener(){this.disposeWithMe(this._drawingManagerService.remove$.subscribe(e=>{e.forEach(e=>{var t;let{unitId:r,subUnitId:n,drawingId:i}=e,a=this._getSceneAndTransformerByDrawingSearch(r);if(null==a)return;let{scene:o}=a,s=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:r,subUnitId:n,drawingId:i}),l=o.fuzzyMathObjects(s,!0);if(l.length>0){for(let e of l)e.dispose();null==(t=o.getTransformer())||t.clearSelectedObjects()}})}))}_drawingUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._drawingManagerService.getDrawingByParam(e);if(null==i)return;let{transform:a,drawingType:o}=i,s=this._getSceneAndTransformerByDrawingSearch(t);if(null==s)return;let{scene:l,transformer:u}=s;if(null==a)return!0;let{left:c=0,top:h=0,width:m=0,height:p=0,angle:g=0,flipX:f=!1,flipY:v=!1,skewX:_=0,skewY:I=0}=a,S=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),C=l.getObject(S);if(null==C)return!0;C.transformByState({left:c,top:h,width:m,height:p,angle:g,flipX:f,flipY:v,skewX:_,skewY:I})})}))}_drawingRefreshListener(){this.disposeWithMe(this._drawingManagerService.refreshTransform$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._getSceneAndTransformerByDrawingSearch(t);if(null==i)return;let a=this._drawingManagerService.getDrawingByParam(e);if(null==a)return;let{transform:o}=a,{scene:s}=i,l=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),u=s.getObject(l);if(null==u||null==o)return!0;let{left:c=0,top:h=0,width:m=0,height:p=0,angle:g=0,flipX:f=!1,flipY:v=!1,skewX:_=0,skewY:I=0}=o;u.transformByState({left:c,top:h,width:m,height:p,angle:g,flipX:f,flipY:v,skewX:_,skewY:I})})}))}_drawingVisibleListener(){this.disposeWithMe(this._drawingManagerService.visible$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n,visible:i}=e,a=this._getSceneAndTransformerByDrawingSearch(t);if(null==a)return;let{scene:o}=a,s=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),l=o.getObject(s);if(null==l)return!0;i?l.show():l.hide()})}))}_filterUpdateParams(e,t){return e.filter((e,r)=>{if(null==e)return!1;let{transform:n}=e;return(0,c.checkIfMove)(n,null==t?void 0:t[r])})}_addListenerOnDrawing(e){let t=e.getTransformerByCreate(),r=null;this.disposeWithMe((0,c.toDisposable)(t.changeStart$.subscribe(e=>{let{objects:t}=e,n=Array.from(t.values()),i=[];r=n.map(e=>{let{left:t,top:r,height:n,width:a,angle:o,oKey:s,isInGroup:l}=e,d=this._drawingManagerService.getDrawingOKey(s);if(l||e instanceof u.Group){let t=e.ancestorGroup;if(null==t&&e instanceof u.Group&&(t=e),null==t)return null;let r=this._drawingManagerService.getDrawingOKey(t.oKey);if(r){let{unitId:e,subUnitId:n,drawingId:a}=r;i.push({unitId:e,subUnitId:n,drawingId:a});let{left:o,top:s,height:l,width:d,angle:u}=t;return{left:o,top:s,height:l,width:d,angle:u}}}else if(null!=d){let{unitId:e,subUnitId:s,drawingId:l}=d;return i.push({unitId:e,subUnitId:s,drawingId:l}),{left:t,top:r,height:n,width:a,angle:o}}return null}).filter(e=>null!=e),i.length>0?this._drawingManagerService.focusDrawing(i):this._drawingManagerService.focusDrawing(null)}))),this.disposeWithMe((0,c.toDisposable)(t.changeEnd$.subscribe(e=>{let{objects:t}=e,n=this._filterUpdateParams(O(t,this._drawingManagerService),r);n.length>0&&this._drawingManagerService.featurePluginUpdateNotification(n)})))}},"DrawingUpdateController"),eD);ex=eP([eN(0,c.IUniverInstanceService),eN(1,c.ICommandService),eN(2,u.IRenderManagerService),eN(3,d.IDrawingManagerService)],ex);let eA=class extends u.Shape{constructor(e,t){null==t&&(t={}),t.transformerConfig={keepRatio:!1,isCropper:!0,anchorFill:"rgb(0, 0, 0)",anchorStroke:"rgb(255, 255, 255)",anchorSize:24},super(e,t),S(this,"_srcRect"),S(this,"_prstGeom"),S(this,"_applyTransform"),S(this,"_dragPadding",8),S(this,"_cacheCanvas"),null!=t&&t.srcRect&&(this._srcRect=t.srcRect),null!=t&&t.prstGeom&&(this._prstGeom=t.prstGeom),null!=t&&t.applyTransform&&(this._applyTransform=t.applyTransform),null!=t&&t.dragPadding&&(this._dragPadding=t.dragPadding),this._applyProps()}refreshSrcRect(e,t){this._srcRect=e,this._applyTransform=t,this._applyProps()}get srcRect(){return this._srcRect}dispose(){var e;super.dispose(),null==(e=this._cacheCanvas)||e.dispose(),this._srcRect=null}isHit(e){let t=this.getInverseCoord(e);return t.x>=-this.strokeWidth/2&&t.x<=this.width+this.strokeWidth/2&&t.y>=-this.strokeWidth/2&&t.y<=this.height+this.strokeWidth/2&&!this._inSurround(t)}_inSurround(e){let t=this._dragPadding;return e.x>=t-this.strokeWidth/2&&e.x<=this.width+this.strokeWidth/2-t&&e.y>=t-this.strokeWidth/2&&e.y<=this.height+this.strokeWidth/2-t}render(e,t){return this.visible&&(e.save(),this._draw(e),e.restore()),this.makeDirty(!1),this}_draw(e){var t,r;let{width:n,height:i}=this.getScene().getEngine();this._initialCacheCanvas(),null==(t=this._cacheCanvas)||t.clear();let a=null==(r=this._cacheCanvas)?void 0:r.getContext();null!=a&&(a.save(),(0,u.Rect).drawWith(a,{left:0,top:0,width:n,height:i,fill:"rgba(0, 0, 0, 0.5)"}),a.setTransform(e.getTransform()),this._clipForApplyObject(a),this._applyCache(e),a.restore())}_clipForApplyObject(e){let t=0;if(null!=this._prstGeom&&(t=1),e.globalCompositeOperation="destination-out",e.beginPath(),0===t){let t=this.transform.getMatrix();e.transform(t[0],t[1],t[2],t[3],t[4],t[5]),e.rect(0,0,this.width,this.height),e.fill()}}_applyProps(){if(null==this._applyTransform)return;let e=0,t=0,r=0,n=0,{left:i=0,top:a=0,width:o=0,height:s=0,angle:l}=this._applyTransform;if(null!=this._srcRect){let{left:i=0,top:a=0,right:o=0,bottom:s=0}=this._srcRect;e=i,t=a,r=o,n=s}let d=i+e,u=a+t;this.transformByState({left:d,top:u,width:i+o-r-d,height:a+s-n-u,angle:l})}_applyCache(e){if(!e||null==this._cacheCanvas)return;let t=this._cacheCanvas.getContext();t.save(),e.save(),e.setTransform(1,0,0,1,0,0),t.setTransform(1,0,0,1,0,0),e.drawImage(this._cacheCanvas.getCanvasEle(),0,0),e.restore(),t.restore()}_initialCacheCanvas(){if(null!=this._cacheCanvas)return;let e=this.getScene();if(null==e)return;this._cacheCanvas=new u.Canvas;let t=e.getEngine();this._cacheCanvas.setSize(t.width,t.height),t.onTransformChange$.subscribeEvent(()=>{var e;null==(e=this._cacheCanvas)||e.setSize(t.width,t.height),this.makeDirty(!0)})}};I(eA,"ImageCropperObject");let eL=eA;var eF,ej=Object.defineProperty,eV=Object.getOwnPropertyDescriptor,eH=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eV(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&ej(t,r,a),a},"__decorateClass$2"),e$=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$2");let eB=(I(eF=class extends c.Disposable{constructor(e,t,r,n,i,a){super(),S(this,"_sceneListenerOnImageMap",/* @__PURE__ */new WeakSet),this._commandService=e,this._drawingManagerService=t,this._renderManagerService=r,this._univerInstanceService=n,this._messageService=i,this._localeService=a,this._init()}_init(){this._initOpenCrop(),this._initCloseCrop(),this._initAutoCrop()}_initAutoCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==ep.id)return;let t=e.params;if(null==t)return;let{cropType:r}=t,n=this._drawingManagerService.getFocusDrawings();if(1!==n.length)return;let{unitId:i,subUnitId:a,drawingId:o}=n[0],s=this._renderManagerService.getRenderById(i),l=null==s?void 0:s.scene;if(null==l)return!0;null!=this._searchCropObject(l)&&this._commandService.syncExecuteCommand(eh.id,{isAuto:!0});let c=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:i,subUnitId:a,drawingId:o}),h=l.getObject(c);if(!(h instanceof u.Image)){this._messageService.show({type:m.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}null!=h&&(this._updateCropperObject(r,h),this._commandService.executeCommand(ec.id,{unitId:i,subUnitId:a,drawingId:o}))}))}_calculateSrcRectByRatio(e,t,r,n,i,a){let o=i/a,s=r,l=n;r/n>o?s=n*o:l=r/o;let d=(r-s)/2,c=(n-l)/2;return{left:(0,u.precisionTo)(d,1),top:(0,u.precisionTo)(c,1),right:(0,u.precisionTo)(r-(d+s),1),bottom:(0,u.precisionTo)(n-(c+l),1)}}_updateCropperObject(e,t){let r;let{left:n,top:i,width:a,height:o}=t.calculateTransformWithSrcRect();switch(e){case em.R1_1:r=this._calculateSrcRectByRatio(n,i,a,o,1,1);break;case em.R16_9:r=this._calculateSrcRectByRatio(n,i,a,o,16,9);break;case em.R9_16:r=this._calculateSrcRectByRatio(n,i,a,o,9,16);break;case em.R5_4:r=this._calculateSrcRectByRatio(n,i,a,o,5,4);break;case em.R4_5:r=this._calculateSrcRectByRatio(n,i,a,o,4,5);break;case em.R4_3:r=this._calculateSrcRectByRatio(n,i,a,o,4,3);break;case em.R3_4:r=this._calculateSrcRectByRatio(n,i,a,o,3,4);break;case em.R3_2:r=this._calculateSrcRectByRatio(n,i,a,o,3,2);break;case em.R2_3:r=this._calculateSrcRectByRatio(n,i,a,o,2,3);case em.FREE:}if(null==r)return;t.setSrcRect(r);let{left:s=0,top:l=0,bottom:d=0,right:u=0}=r;t.transformByStateCloseCropper({left:n+s,top:i+l,width:a-u-s,height:o-d-l})}_initOpenCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==ec.id)return;let t=e.params;if(null==t)return;let{unitId:r,subUnitId:n,drawingId:i}=t,a=this._renderManagerService.getRenderById(r),o=null==a?void 0:a.scene;if(null==o)return!0;if(this._sceneListenerOnImageMap.has(o)||(this._addListenerOnImage(o),this._sceneListenerOnImageMap.add(o)),null==this._drawingManagerService.getDrawingByParam({unitId:r,subUnitId:n,drawingId:i}))return;let s=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:r,subUnitId:n,drawingId:i}),l=o.getObject(s);if(null==l)return;if(!(l instanceof u.Image)){this._messageService.show({type:m.MessageType.Error,content:this._localeService.t("image-cropper.error")});return}let c=o.getTransformer();null==c||c.clearControls();let h=new eL(`${s}-crop`,{srcRect:l.srcRect,prstGeom:l.prstGeom,applyTransform:l.calculateTransformWithSrcRect()});o.addObject(h,l.getLayerIndex()+1).attachTransformerTo(h),null==c||c.createControlForCopper(h),this._addHoverForImageCopper(h),l.openRenderByCropper(),null==c||c.refreshControls(),h.makeDirty(!0),this._drawingManagerService.focusDrawing([{unitId:r,subUnitId:n,drawingId:i}])}))}_searchCropObject(e){for(let t of e.getAllObjectsByOrder())if(t instanceof eL)return t}_initCloseCrop(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==eh.id)return;let t=this._univerInstanceService.getFocusedUnit();if(null==t)return;let r=t.getUnitId(),n=this._renderManagerService.getRenderById(r),i=null==n?void 0:n.scene;if(null==i)return!0;let a=this._searchCropObject(i);if(null==a)return;let o=this._getApplyObjectByCropObject(a);if(null==o)return;let s=i.getTransformerByCreate();s.detachFrom(a),s.clearCopperControl();let l=this._getSrcRectByTransformState(o,a),d=this._drawingManagerService.getDrawingOKey(o.oKey);if(null!=d){let{left:e,top:t,height:r,width:n}=a;this._drawingManagerService.featurePluginUpdateNotification([{...d,transform:{...d.transform,left:e,top:t,height:r,width:n},srcRect:l.srcRectAngle}])}o.setSrcRect({...l.srcRectAngle}),o.closeRenderByCropper(),o.makeDirty(!0),null==a||a.dispose()}));let e=this._univerInstanceService.getCurrentTypeOfUnit$(c.UniverInstanceType.UNIVER_SHEET).pipe((0,g.filter)(e=>!!e),(0,f.switchMap)(e=>e.activeSheet$));this.disposeWithMe(e.subscribe(()=>{this._commandService.syncExecuteCommand(eh.id)}))}_getApplyObjectByCropObject(e){let t=e.oKey,r=t.slice(0,t.length-5),n=e.getScene();if(!n)return null;let i=n.getObject(r);return null==i?null:i}_addListenerOnImage(e){let t=e.getTransformerByCreate(),r=null;this.disposeWithMe(t.changeStart$.subscribe(e=>{let{objects:n}=e,i=n.values().next().value;if(null==i||!(i instanceof eL))return;let{left:a,top:o,height:s,width:l,angle:d}=i;r={left:a,top:o,height:s,width:l,angle:d},t.clearCopperControl()})),this.disposeWithMe(t.changeEnd$.subscribe(e=>{let{objects:n}=e,i=n.values().next().value;if(null==i||!(i instanceof eL))return;let{left:a,top:o,height:s,width:l,angle:d}=i;if(!(0,c.checkIfMove)({left:a,top:o,height:s,width:l,angle:d},r))return;let u=this._getApplyObjectByCropObject(i);if(null==u)return;let h=this._getSrcRectByTransformState(u,i);i.refreshSrcRect(h.srcRect,u.getState()),t.createControlForCopper(i)})),this._endCropListener(e)}_addHoverForImageCopper(e){this.disposeWithMe(e.onPointerEnter$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.MOVE})),this.disposeWithMe(e.onPointerLeave$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.DEFAULT}))}_endCropListener(e){let t=e.getTransformerByCreate();this.disposeWithMe(t.clearControl$.subscribe(e=>{!0===e&&this._commandService.syncExecuteCommand(eh.id)}))}_getSrcRectByTransformState(e,t){let{left:r,top:n,height:i,width:a,strokeWidth:o,angle:s}=t,{left:l,top:d,width:c,height:h,angle:m,strokeWidth:p}=e,g=r-l,f=n-d,v={left:g,top:f,right:c-g-a,bottom:h-f-i},_={...v};if(0!==m){let e=new u.Vector2(r+a/2,n+i/2),t=new u.Vector2(c/2+l,h/2+d),o=new u.Vector2(l,d);o.rotateByPoint((0,u.degToRad)(m),t);let s=o.clone();s.rotateByPoint((0,u.degToRad)(-m),e);let p=r-s.x,g=n-s.y;_.left=p,_.top=g,_.right=c-p-a,_.bottom=h-g-i}return{srcRect:v,srcRectAngle:_}}},"ImageCropperController"),eF);eB=eH([e$(0,c.ICommandService),e$(1,d.IDrawingManagerService),e$(2,u.IRenderManagerService),e$(3,c.IUniverInstanceService),e$(4,p.IMessageService),e$(5,(0,c.Inject)(c.LocaleService))],eB);var eW=Object.defineProperty,eG=Object.getOwnPropertyDescriptor,ez=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eG(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eW(t,r,a),a},"__decorateClass$1"),eY=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let eK=(s=class extends c.Disposable{constructor(e,t,r,n,i,a,o){super(),this._commandService=e,this._renderManagerService=t,this._drawingManagerService=r,this._dialogService=n,this._imageIoService=i,this._currentUniverService=a,this._drawingRenderService=o,this._initialize()}dispose(){super.dispose()}_initialize(){this._drawingAddListener(),this._commandExecutedListener(),this._imageUpdateListener()}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id===eC.id){let t=e.params;null!=t&&this._resetImageSize(t)}}))}_getSceneAndTransformerByDrawingSearch(e){if(null==e)return;let t=this._renderManagerService.getRenderById(e),r=null==t?void 0:t.scene;if(null==r)return null;let n=r.getTransformerByCreate();return{scene:r,transformer:n}}_resetImageSize(e){let t=[],r=[];e.forEach(e=>{let{unitId:n,subUnitId:i,drawingId:a}=e,o=this._getSceneAndTransformerByDrawingSearch(n);if(null==o)return;let{scene:s}=o,l=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:n,subUnitId:i,drawingId:a}),u=s.getObject(l);if(null==u)return!0;let c=this._drawingManagerService.getDrawingByParam(e);if(null==c)return!0;if(c.drawingType!==d.DrawingTypeEnum.DRAWING_IMAGE)return;u.resetSize();let{width:h,height:m}=u.getNativeSize();!1===r.includes(s)&&r.push(s),t.push({...c,transform:{...c.transform,height:m,width:h,angle:0},srcRect:null,prstGeom:null})}),this._drawingManagerService.featurePluginUpdateNotification(t),r.forEach(e=>{e.getTransformerByCreate().refreshControls().changeNotification()}),this._drawingManagerService.focusDrawing(e)}_drawingAddListener(){this.disposeWithMe(this._drawingManagerService.add$.subscribe(e=>{this._insertImages(e)}))}_insertImages(e){e.forEach(async e=>{var t;let{unitId:r,subUnitId:n,drawingId:i}=e,a=this._getSceneAndTransformerByDrawingSearch(r),o=null==(t=y(this._currentUniverService,r))?void 0:t.subUnitId;if(null==a||o!==n)return;let s=this._drawingManagerService.getDrawingByParam(e);if(null==s)return;let l=await this._drawingRenderService.renderImages(s,a.scene);if(!(null==l||0===l.length))for(let e of l)this._addHoverForImage(e),this._addDialogForImage(e)})}_imageUpdateListener(){this.disposeWithMe(this._drawingManagerService.update$.subscribe(e=>{e.forEach(e=>{let{unitId:t,subUnitId:r,drawingId:n}=e,i=this._drawingManagerService.getDrawingByParam(e);if(null==i)return;let{transform:a,drawingType:o,srcRect:s,prstGeom:l,source:u,imageSourceType:c}=i;if(o!==d.DrawingTypeEnum.DRAWING_IMAGE)return;let h=this._getSceneAndTransformerByDrawingSearch(t);if(null==h)return;let{scene:m,transformer:p}=h;if(null==a)return!0;let g=(0,d.getDrawingShapeKeyByDrawingSearch)({unitId:t,subUnitId:r,drawingId:n}),f=m.getObject(g);if(null==f)return!0;f.setSrcRect(s),f.setPrstGeom(l)})}))}_addHoverForImage(e){this.disposeWithMe((0,c.toDisposable)(e.onPointerEnter$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.GRAB}))),this.disposeWithMe((0,c.toDisposable)(e.onPointerLeave$.subscribeEvent(()=>{e.cursor=u.CURSOR_TYPE.DEFAULT})))}_addDialogForImage(e){this.disposeWithMe((0,c.toDisposable)(e.onDblclick$.subscribeEvent(()=>{var t;let r=`${e.oKey}-viewer-dialog`,n=e.getNativeSize(),i=window.innerWidth-50,a=window.innerHeight-50,o=this._adjustImageSize(n.width,n.height,i,a),s=this._dialogService.open({width:o.width,id:r,style:{margin:"0",top:"50%",left:"50%",transform:"translate(-50%, -50%)"},children:{label:{name:ey,props:{src:null==(t=e.getNative())?void 0:t.src,width:o.width,height:o.height}}},destroyOnClose:!0,draggable:!1,onClose:/* @__PURE__ */I(()=>{this._dialogService.close(r),s.dispose()},"onClose")})})))}_adjustImageSize(e,t,r,n){if(e<=r&&t<=n)return{width:e,height:t};let i=Math.min(r/e,n/t);return{width:Math.floor(e*i),height:Math.floor(t*i)}}},I(s,"ImageUpdateController"),s);eK=ez([eY(0,c.ICommandService),eY(1,u.IRenderManagerService),eY(2,d.IDrawingManagerService),eY(3,p.IDialogService),eY(4,d.IImageIoService),eY(5,c.IUniverInstanceService),eY(6,(0,c.Inject)(M))],eK);var eq=Object.defineProperty,eX=Object.getOwnPropertyDescriptor,eQ=/* @__PURE__ */I((e,t,r,n)=>{for(var i,a=n>1?void 0:n?eX(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&eq(t,r,a),a},"__decorateClass"),eZ=/* @__PURE__ */I((e,t)=>(r,n)=>t(r,n,e),"__decorateParam");let eJ=(I(l=class extends c.Plugin{constructor(e=eS,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{menu:n,...i}=this._config;n&&this._configService.setConfig("menu",n,{merge:!0}),this._configService.setConfig("drawing-ui.config",i)}onStarting(){this._initDependencies()}onRendered(){this._injector.get(ex),this._injector.get(eO),this._injector.get(eB),this._injector.get(eK)}_initDependencies(){[[M],[ex],[eO],[eB],[eK]].forEach(e=>this._injector.add(e))}},"UniverDrawingUIPlugin"),S(l,"pluginName","UNIVER_DRAWING_UI_PLUGIN"),l);eJ=eQ([eZ(1,(0,c.Inject)(c.Injector)),eZ(2,c.IConfigService)],eJ)}),i("fPi1a",function(t,r){let i,a;e(t.exports,"SheetDrawingAnchorType",function(){return c}),e(t.exports,"ISheetDrawingService",function(){return m}),e(t.exports,"DrawingApplyType",function(){return p}),e(t.exports,"SetDrawingApplyMutation",function(){return g}),e(t.exports,"UniverSheetsDrawingPlugin",function(){return D});var o=n("7yNYd"),s=n("28sqy"),l=Object.defineProperty,d=(e,t)=>l(e,"name",{value:t,configurable:!0});let u={};var c=((i=c||{}).Position="0",i.Both="1",i.None="2",i);let h=class extends s.UnitDrawingService{};d(h,"SheetDrawingService");let m=(0,o.createIdentifier)("sheets-drawing.sheet-drawing.service");var p=((a=p||{})[a.INSERT=0]="INSERT",a[a.REMOVE=1]="REMOVE",a[a.UPDATE=2]="UPDATE",a[a.ARRANGE=3]="ARRANGE",a[a.GROUP=4]="GROUP",a[a.UNGROUP=5]="UNGROUP",a);let g={id:"sheet.mutation.set-drawing-apply",type:o.CommandType.MUTATION,handler:/* @__PURE__ */d((e,t)=>{let r=e.get(s.IDrawingManagerService),n=e.get(m),{op:i,unitId:a,subUnitId:o,type:l,objects:d}=t;switch(r.applyJson1(a,o,i),n.applyJson1(a,o,i),l){case 0:r.addNotification(d),n.addNotification(d);break;case 1:r.removeNotification(d),n.removeNotification(d);break;case 2:r.updateNotification(d),n.updateNotification(d);break;case 3:r.orderNotification(d),n.orderNotification(d);break;case 4:r.groupUpdateNotification(d);break;case 5:r.ungroupUpdateNotification(d)}return!0},"handler")};var f=Object.defineProperty,v=Object.getOwnPropertyDescriptor,_=/* @__PURE__ */d((e,t,r,n)=>{for(var i,a=n>1?void 0:n?v(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&f(t,r,a),a},"__decorateClass$1"),I=/* @__PURE__ */d((e,t)=>(r,n)=>t(r,n,e),"__decorateParam$1");let S="SHEET_DRAWING_PLUGIN",C=(y=class extends o.Disposable{constructor(e,t,r,n){super(),this._commandService=e,this._sheetDrawingService=t,this._drawingManagerService=r,this._resourceManagerService=n,this._initSnapshot(),this.disposeWithMe(this._commandService.registerCommand(g))}_initSnapshot(){let e=/* @__PURE__ */d((e,t)=>{let r=t||this._sheetDrawingService.getDrawingDataForUnit(e);return r?JSON.stringify(r):""},"toJson"),t=/* @__PURE__ */d(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:S,businesses:[o.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */d((t,r)=>e(t,r),"toJson"),parseJson:/* @__PURE__ */d(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */d(e=>{this._sheetDrawingService.removeDrawingDataForUnit(e),this._drawingManagerService.removeDrawingDataForUnit(e)},"onUnLoad"),onLoad:/* @__PURE__ */d((e,t)=>{this._sheetDrawingService.registerDrawingData(e,t),this._drawingManagerService.registerDrawingData(e,t)},"onLoad")}))}},d(y,"SheetsDrawingLoadController"),y);C=_([I(0,o.ICommandService),I(1,m),I(2,s.IDrawingManagerService),I(3,o.IResourceManagerService)],C);var y,w,b=Object.defineProperty,R=Object.getOwnPropertyDescriptor,E=/* @__PURE__ */d((e,t,r)=>t in e?b(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,"__defNormalProp"),T=/* @__PURE__ */d((e,t,r,n)=>{for(var i,a=n>1?void 0:n?R(t,r):t,o=e.length-1;o>=0;o--)(i=e[o])&&(a=(n?i(t,r,a):i(a))||a);return n&&a&&b(t,r,a),a},"__decorateClass"),M=/* @__PURE__ */d((e,t)=>(r,n)=>t(r,n,e),"__decorateParam"),O=/* @__PURE__ */d((e,t,r)=>E(e,"symbol"!=typeof t?t+"":t,r),"__publicField");let D=(d(w=class extends o.Plugin{constructor(e=u,t,r){super(),this._config=e,this._injector=t,this._configService=r;let{...n}=this._config;this._configService.setConfig("sheets-drawing.config",n)}onStarting(){[[C],[m,{useClass:h}]].forEach(e=>this._injector.add(e)),this._injector.get(C)}},"UniverSheetsDrawingPlugin"),w);O(D,"pluginName",S),O(D,"type",o.UniverInstanceType.UNIVER_SHEET),D=T([(0,o.DependentOn)(s.UniverDrawingPlugin),M(1,(0,o.Inject)(o.Injector)),M(2,o.IConfigService)],D)});
//# sourceMappingURL=es.883cfa33.js.map
