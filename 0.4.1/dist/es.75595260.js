function e(e,t,n,r){Object.defineProperty(e,t,{get:n,set:r,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire26fc,n=t.register;n("kRRWY",function(n,r){e(n.exports,"RangeSelector",function(){return e2}),e(n.exports,"UniverSheetsFormulaUIPlugin",function(){return nO});var i=t("7yNYd"),o=t("4XALk"),l=t("86b1c"),s=t("dLBA8"),a=t("arCqp"),u=t("8WNAB"),c=t("lMvMU"),d=t("hciHF"),h=t("i54iF"),g=t("1O3Nt"),m=t("3yupB"),S=t("1mjSk"),f=t("23cfA"),p=t("gv2K9"),v=t("g6Cit"),_=t("ejawP"),C=t("bRzks"),R=t("fL2Ug"),I=t("5gqvu"),y=t("1UDbf"),E=t("3e0Iz"),b=t("7AR1b"),p=t("gv2K9"),T=Object.defineProperty,N=(e,t,n)=>t in e?T(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,M=(e,t)=>T(e,"name",{value:t,configurable:!0}),x=(e,t,n)=>N(e,"symbol"!=typeof t?t+"":t,n);let A={id:"sheet.command.paste-formula",type:i.CommandType.COMMAND,handler:/* @__PURE__ */M(async e=>e.get(i.ICommandService).executeCommand(o.SheetPasteCommand.id,{value:o.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA}),"handler")},O={id:"formula-ui.operation.select-editor-formula",type:i.CommandType.OPERATION,handler:/* @__PURE__ */M((e,t)=>!0,"handler")};var F=Object.defineProperty,w=Object.getOwnPropertyDescriptor,P=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?w(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&F(t,n,o),o},"__decorateClass$9"),D=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$9");let k=(0,i.createIdentifier)("formula-ui.prompt-service"),L=(M(eA=class{constructor(e){x(this,"_search$",new S.Subject),x(this,"_help$",new S.Subject),x(this,"_navigate$",new S.Subject),x(this,"_accept$",new S.Subject),x(this,"_acceptFormulaName$",new S.Subject),x(this,"search$",this._search$.asObservable()),x(this,"help$",this._help$.asObservable()),x(this,"navigate$",this._navigate$.asObservable()),x(this,"accept$",this._accept$.asObservable()),x(this,"acceptFormulaName$",this._acceptFormulaName$.asObservable()),x(this,"_searching",!1),x(this,"_helping",!1),x(this,"_sequenceNodes",[]),x(this,"_isLockedOnSelectionChangeRefString",!1),x(this,"_isLockedOnSelectionInsertRefString",!1),this._contextService=e}dispose(){this._search$.complete(),this._help$.complete(),this._navigate$.complete(),this._accept$.complete(),this._acceptFormulaName$.complete(),this._sequenceNodes=[]}search(e){this._contextService.setContextValue("FORMULA_PROMPT_ACTIVATED",e.visible),this._searching=e.visible,this._search$.next(e)}isSearching(){return this._searching}help(e){this._helping=e.visible,this._help$.next(e)}isHelping(){return this._helping}navigate(e){this._navigate$.next(e)}accept(e){this._accept$.next(e)}acceptFormulaName(e){this._acceptFormulaName$.next(e)}getSequenceNodes(){return[...this._sequenceNodes]}setSequenceNodes(e){this._sequenceNodes=e}clearSequenceNodes(){this._sequenceNodes=[]}getCurrentSequenceNode(e){return this._sequenceNodes[this.getCurrentSequenceNodeIndex(e)]}getCurrentSequenceNodeByIndex(e){return this._sequenceNodes[e]}getCurrentSequenceNodeIndex(e){let t=0,n=this._sequenceNodes[0];for(let r=0,i=this._sequenceNodes.length;r<i;r++){let i=this._sequenceNodes[r];if("string"==typeof i)t++;else{let{endIndex:e}=i;t=e}if(e<=t)return"string"==typeof n&&0!==e?r+1:r}return this._sequenceNodes.length}updateSequenceRef(e,t){let n=this._sequenceNodes[e];if("string"==typeof n||n.nodeType!==l.sequenceNodeType.REFERENCE)return;let r=t.length-n.token.length,i={...n};i.token=t,i.endIndex+=r,this._sequenceNodes[e]=i;for(let t=e+1,n=this._sequenceNodes.length;t<n;t++){let e=this._sequenceNodes[t];if("string"==typeof e)continue;let n={...e};n.startIndex+=r,n.endIndex+=r,this._sequenceNodes[t]=n}}insertSequenceRef(e,t){let n=t.length,r=this.getCurrentSequenceNodeIndex(e);this._sequenceNodes.splice(r,0,{token:t,startIndex:e,endIndex:e+n-1,nodeType:l.sequenceNodeType.REFERENCE});for(let e=r+1,t=this._sequenceNodes.length;e<t;e++){let t=this._sequenceNodes[e];if("string"==typeof t)continue;let r={...t};r.startIndex+=n,r.endIndex+=n,this._sequenceNodes[e]=r}}insertSequenceString(e,t){let n=this.getCurrentSequenceNodeIndex(e),r=t.split("");this._sequenceNodes.splice(n,0,...r);let i=r.length;for(let e=n+i,t=this._sequenceNodes.length;e<t;e++){let t=this._sequenceNodes[e];if("string"==typeof t)continue;let n={...t};n.startIndex+=i,n.endIndex+=i,this._sequenceNodes[e]=n}}enableLockedSelectionChange(){this._isLockedOnSelectionChangeRefString=!0}disableLockedSelectionChange(){this._isLockedOnSelectionChangeRefString=!1}isLockedSelectionChange(){return this._isLockedOnSelectionChangeRefString}enableLockedSelectionInsert(){this._isLockedOnSelectionInsertRefString=!0}disableLockedSelectionInsert(){this._isLockedOnSelectionInsertRefString=!1}isLockedSelectionInsert(){return this._isLockedOnSelectionInsertRefString}},"FormulaPromptService"),eA);L=P([D(0,i.IContextService)],L);let U={id:"formula-ui.operation.help-function",type:i.CommandType.OPERATION,handler:/* @__PURE__ */M(async(e,t)=>(e.get(k).help(t),!0),"handler")},j={id:"formula-ui.operation.insert-function",type:i.CommandType.OPERATION,handler:/* @__PURE__ */M(async(e,t)=>{var n,r;let o=e.get(_.SheetsSelectionsService),s=e.get(v.IEditorService),a=o.getCurrentSelections();if(!a||!a.length)return!1;let u=(0,_.getSheetCommandTarget)(e.get(i.IUniverInstanceService));if(!u)return!1;let{worksheet:c,unitId:d,subUnitId:h}=u,g=c.getCellMatrix(),{value:m}=t,S=e.get(i.ICommandService),f=[],p=null,R=0,I=0,y="";if(1===a.length&&(H(a[0].range)||q(a[0].range))){let{range:e,primary:t}=a[0],i=null!=(n=null==t?void 0:t.actualRow)?n:e.startRow,o=null!=(r=null==t?void 0:t.actualColumn)?r:e.startColumn;p=e,R=i,I=o;let s=B(g,i,o);s&&(y=(0,l.serializeRange)(s))}else a.some(e=>{var t,n;let{range:r,primary:i}=e,o=null!=(t=null==i?void 0:i.actualRow)?t:r.startRow,s=null!=(n=null==i?void 0:i.actualColumn)?n:r.startColumn,a=B(g,o,s);if(!a)return p=r,R=o,I=s,!0;let u=(0,l.serializeRange)(a),c=`=${m}(${u})`;return f.push({range:r,primary:{row:o,column:s},formula:c}),!1});if(p){let e=(0,_.getCellAtRowCol)(R,I,c),t={range:(0,i.Rectangle).clone(p),primary:{startRow:e.startRow,startColumn:e.startColumn,endRow:e.endRow,endColumn:e.endColumn,actualRow:R,actualColumn:I,isMerged:e.isMerged,isMergedMainCell:e.startRow===R&&e.startColumn===I}};await S.executeCommand(_.SetSelectionsOperation.id,{unitId:d,subUnitId:h,selections:[t]}),setTimeout(()=>{s.setFormula(`=${m}(${y}`)},0)}return 0!==f.length&&S.executeCommand(C.InsertFunctionCommand.id,{list:f})},"handler")};function B(e,t,n){let r=W(e,t,n);if(r!==t)return{startRow:r,endRow:t-1,startColumn:n,endColumn:n};let i=$(e,t,n);return i!==n?{startRow:t,endRow:t,startColumn:i,endColumn:n-1}:null}function W(e,t,n){let r=!1;if(0===t)return t;for(let i=t-1;i>=0;i--){let t=e.getValue(i,n);if(V(t)&&!r){if(0===i)return 0;r=!0}else{if(r&&!V(t))return i+1;if(r&&0===i)return 0}}return t}function $(e,t,n){let r=!1;if(0===n)return n;for(let i=n-1;i>=0;i--){let n=e.getValue(t,i);if(V(n)&&!r){if(0===i)return 0;r=!0}else{if(r&&!V(n))return i+1;if(r&&0===i)return 0}}return n}function V(e){if(null!=e&&e.p){let t=null==e?void 0:e.p.body;if(null==t)return!1;let n=t.dataStream,r=n.substring(n.length-2,n.length)===i.DEFAULT_EMPTY_DOCUMENT_VALUE?n.substring(0,n.length-2):n;return(0,i.isRealNum)(r)}return e&&(e.t===i.CellValueType.NUMBER||(0,i.getCellValueType)(e)===i.CellValueType.NUMBER)}function H(e){return e.startRow===e.endRow&&e.startColumn===e.endColumn}function q(e){return e.startRow!==e.endRow&&e.startColumn!==e.endColumn}M(B,"findRefRange"),M(W,"findStartRow"),M($,"findStartColumn"),M(V,"isNumberCell"),M(H,"isSingleCell"),M(q,"isMultiRowsColumnsRange");let K="SHEET_FORMULA_UI_PLUGIN",z=`${K}_MORE_FUNCTIONS_COMPONENT`,G={id:"formula-ui.operation.more-functions",type:i.CommandType.OPERATION,handler:/* @__PURE__ */M(async e=>(e.get(R.ISidebarService).open({header:{title:"formula.insert.tooltip"},children:{label:z}}),!0),"handler")},Y={id:"formula-ui.operation.change-ref-to-absolute",type:i.CommandType.OPERATION,handler:/* @__PURE__ */M(async e=>!0,"handler")},Z={id:"formula-ui.operation.search-function",type:i.CommandType.OPERATION,handler:/* @__PURE__ */M(async(e,t)=>(e.get(k).search(t),!0),"handler")};var X={exports:{}},Q={},J=I&&I.__esModule?I.default:I,ee=Symbol.for("react.element"),et=Symbol.for("react.fragment"),en=Object.prototype.hasOwnProperty,er=J.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,ei={key:!0,ref:!0,__self:!0,__source:!0};function eo(e,t,n){var r,i={},o=null,l=null;for(r in void 0!==n&&(o=""+n),void 0!==t.key&&(o=""+t.key),void 0!==t.ref&&(l=t.ref),t)en.call(t,r)&&!ei.hasOwnProperty(r)&&(i[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===i[r]&&(i[r]=t[r]);return{$$typeof:ee,type:e,key:o,ref:l,props:i,_owner:er.current}}M(eo,"q"),Q.Fragment=et,Q.jsx=eo,Q.jsxs=eo,X.exports=Q;var el=X.exports,es=function(){return(es=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},ea=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&0>t.indexOf(r)&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols)for(var i=0,r=Object.getOwnPropertySymbols(e);i<r.length;i++)0>t.indexOf(r[i])&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]]);return n},eu=(0,I.forwardRef)(function(e,t){var n=e.icon,r=e.id,i=e.className,o=e.extend,l=ea(e,["icon","id","className","extend"]),s="univerjs-icon univerjs-icon-".concat(r," ").concat(i||"").trim(),a=(0,I.useRef)("_".concat(eg()));return ec(n,"".concat(r),{defIds:n.defIds,idSuffix:a.current},es({ref:t,className:s},l),o)});function ec(e,t,n,r,i){return(0,I.createElement)(e.tag,es(es({key:t},ed(e,n,i)),r),(eh(e,n).children||[]).map(function(r,o){return ec(r,"".concat(t,"-").concat(e.tag,"-").concat(o),n,void 0,i)}))}function ed(e,t,n){var r=es({},e.attrs);null!=n&&n.colorChannel1&&"colorChannel1"===r.fill&&(r.fill=n.colorChannel1);var i=t.defIds;return i&&0!==i.length&&("use"===e.tag&&r["xlink:href"]&&(r["xlink:href"]=r["xlink:href"]+t.idSuffix),Object.entries(r).forEach(function(e){var n=e[0],i=e[1];"string"==typeof i&&(r[n]=i.replace(/url\(#(.*)\)/,"url(#$1".concat(t.idSuffix,")")))})),r}function eh(e,t){var n,r=t.defIds;return r&&0!==r.length&&"defs"===e.tag&&!(null===(n=e.children)||void 0===n)&&n.length?es(es({},e),{children:e.children.map(function(e){return"string"==typeof e.attrs.id&&r&&r.indexOf(e.attrs.id)>-1?es(es({},e),{attrs:es(es({},e.attrs),{id:e.attrs.id+t.idSuffix})}):e})}):e}function eg(){return Math.random().toString(36).substring(2,8)}M(ec,"render"),M(ed,"replaceRuntimeIdsAndExtInAttrs"),M(eh,"replaceRuntimeIdsInDefs"),M(eg,"generateShortUuid"),eu.displayName="UniverIcon";var em={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M14.1544 3.75557C14.3887 3.98988 14.3887 4.36978 14.1544 4.6041L6.51409 12.2444C6.40157 12.3569 6.24896 12.4201 6.08983 12.4201C5.9307 12.4201 5.77808 12.3569 5.66556 12.2444L1.84541 8.42425C1.6111 8.18993 1.6111 7.81003 1.84541 7.57572C2.07973 7.34141 2.45963 7.34141 2.69394 7.57572L6.08983 10.9716L13.3059 3.75557C13.5402 3.52126 13.9201 3.52126 14.1544 3.75557Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eS=(0,I.forwardRef)(function(e,t){return(0,I.createElement)(eu,Object.assign({},e,{id:"check-mark-single",ref:t,icon:em}))});eS.displayName="CheckMarkSingle";var ef={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M3.71274 2.86421C3.47843 2.6299 3.09853 2.6299 2.86421 2.86421C2.6299 3.09853 2.6299 3.47843 2.86421 3.71274L7.15154 8.00007L2.86421 12.2874C2.6299 12.5217 2.6299 12.9016 2.86421 13.1359C3.09853 13.3702 3.47843 13.3702 3.71274 13.1359L8.00007 8.84859L12.2874 13.1359C12.5217 13.3702 12.9016 13.3702 13.1359 13.1359C13.3702 12.9016 13.3702 12.5217 13.1359 12.2874L8.84859 8.00007L13.1359 3.71274C13.3702 3.47843 13.3702 3.09853 13.1359 2.86421C12.9016 2.6299 12.5217 2.6299 12.2874 2.86421L8.00007 7.15154L3.71274 2.86421Z"}}]},ep=(0,I.forwardRef)(function(e,t){return(0,I.createElement)(eu,Object.assign({},e,{id:"close-single",ref:t,icon:ef}))});ep.displayName="CloseSingle";var ev={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.3313 1.4667C5.3313 1.13533 5.59993.866699 5.9313.866699H10.069C10.4004.866699 10.669 1.13533 10.669 1.4667 10.669 1.79807 10.4004 2.0667 10.069 2.0667H5.9313C5.59993 2.0667 5.3313 1.79807 5.3313 1.4667zM1.09985 3.64443C1.09985 3.31306 1.36848 3.04443 1.69985 3.04443H14.2999C14.6312 3.04443 14.8999 3.31306 14.8999 3.64443 14.8999 3.9758 14.6312 4.24443 14.2999 4.24443H1.69985C1.36848 4.24443 1.09985 3.9758 1.09985 3.64443zM6.12398 8.30171C6.35829 8.0674 6.73819 8.0674 6.97251 8.30171L8.00007 9.32928 9.02764 8.30171C9.26195 8.0674 9.64185 8.0674 9.87617 8.30171 10.1105 8.53603 10.1105 8.91593 9.87617 9.15024L8.8486 10.1778 9.87617 11.2054C10.1105 11.4397 10.1105 11.8196 9.87617 12.0539 9.64185 12.2882 9.26195 12.2882 9.02764 12.0539L8.00007 11.0263 6.97251 12.0539C6.73819 12.2882 6.35829 12.2882 6.12398 12.0539 5.88966 11.8196 5.88966 11.4397 6.12398 11.2054L7.15154 10.1778 6.12398 9.15024C5.88966 8.91593 5.88966 8.53603 6.12398 8.30171z"}},{tag:"path",attrs:{fill:"currentColor",d:"M4.75332 5.22217C3.86966 5.22217 3.15332 5.93851 3.15332 6.82217V12.5331C3.15332 13.9691 4.31738 15.1332 5.75332 15.1332H10.2465C11.6825 15.1332 12.8465 13.9691 12.8465 12.5331V6.82217C12.8465 5.93851 12.1302 5.22217 11.2465 5.22217H4.75332ZM4.35332 6.82217C4.35332 6.60125 4.53241 6.42217 4.75332 6.42217H11.2465C11.4674 6.42217 11.6465 6.60125 11.6465 6.82217V12.5331C11.6465 13.3063 11.0197 13.9332 10.2465 13.9332H5.75332C4.98012 13.9332 4.35332 13.3063 4.35332 12.5331V6.82217Z",fillRule:"evenodd",clipRule:"evenodd"}}]},e_=(0,I.forwardRef)(function(e,t){return(0,I.createElement)(eu,Object.assign({},e,{id:"delete-single",ref:t,icon:ev}))});e_.displayName="DeleteSingle";var eC={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.75 5.32495C8.75 5.73916 8.41421 6.07495 8 6.07495 7.58579 6.07495 7.25 5.73916 7.25 5.32495 7.25 4.91074 7.58579 4.57495 8 4.57495 8.41421 4.57495 8.75 4.91074 8.75 5.32495zM8.5999 7.52505C8.5999 7.19368 8.33127 6.92505 7.9999 6.92505 7.66853 6.92505 7.3999 7.19368 7.3999 7.52505V11.425C7.3999 11.7564 7.66853 12.025 7.9999 12.025 8.33127 12.025 8.5999 11.7564 8.5999 11.425V7.52505z"}},{tag:"path",attrs:{fill:"currentColor",d:"M0.899902 8.00002C0.899902 4.0788 4.07868 0.900024 7.9999 0.900024C11.9211 0.900024 15.0999 4.0788 15.0999 8.00002C15.0999 11.9212 11.9211 15.1 7.9999 15.1C4.07868 15.1 0.899902 11.9212 0.899902 8.00002ZM7.9999 2.10002C4.74142 2.10002 2.0999 4.74154 2.0999 8.00002C2.0999 11.2585 4.74142 13.9 7.9999 13.9C11.2584 13.9 13.8999 11.2585 13.8999 8.00002C13.8999 4.74154 11.2584 2.10002 7.9999 2.10002Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eR=(0,I.forwardRef)(function(e,t){return(0,I.createElement)(eu,Object.assign({},e,{id:"details-single",ref:t,icon:eC}))});eR.displayName="DetailsSingle";var eI={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M8.6 1.99991C8.60001 1.66854 8.33138 1.39991 8.00001 1.3999C7.66864 1.3999 7.40001 1.66853 7.4 1.9999L7.39996 7.3999H1.9999C1.66853 7.3999 1.3999 7.66853 1.3999 7.9999C1.3999 8.33127 1.66853 8.5999 1.9999 8.5999H7.39995L7.3999 13.9999C7.3999 14.3313 7.66853 14.5999 7.9999 14.5999C8.33127 14.5999 8.5999 14.3313 8.5999 13.9999L8.59995 8.5999H13.9999C14.3313 8.5999 14.5999 8.33127 14.5999 7.9999C14.5999 7.66853 14.3313 7.3999 13.9999 7.3999H8.59996L8.6 1.99991Z"}}]},ey=(0,I.forwardRef)(function(e,t){return(0,I.createElement)(eu,Object.assign({},e,{id:"increase-single",ref:t,icon:eI}))});ey.displayName="IncreaseSingle";var eE={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M5.90913 3.57564C6.14345 3.34132 6.52335 3.34132 6.75766 3.57564L10.7577 7.57564C10.992 7.80995 10.992 8.18985 10.7577 8.42417L6.75766 12.4242C6.52335 12.6585 6.14345 12.6585 5.90913 12.4242C5.67482 12.1899 5.67482 11.81 5.90913 11.5756L9.48487 7.9999L5.90913 4.42417C5.67482 4.18985 5.67482 3.80995 5.90913 3.57564Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eb=(0,I.forwardRef)(function(e,t){return(0,I.createElement)(eu,Object.assign({},e,{id:"more-single",ref:t,icon:eE}))});eb.displayName="MoreSingle";var eT={tag:"svg",attrs:{fill:"none",viewBox:"0 0 16 16",width:"1em",height:"1em"},children:[{tag:"path",attrs:{fill:"currentColor",d:"M12.6185 12.4423C12.5907 12.2749 12.7773 12.15 12.9343 12.2308L15.4242 13.5126C15.6102 13.6084 15.5544 13.8745 15.3439 13.8955L14.2456 14.184L13.4521 15.1286C13.3495 15.2939 13.085 15.2463 13.0534 15.0568L12.6185 12.4423Z"}},{tag:"path",attrs:{fill:"currentColor",d:"M1 3.6C1 2.16406 2.16406 1 3.6 1H12.3C13.7359 1 14.9 2.16406 14.9 3.6V5.81156C14.9003 5.81881 14.9004 5.82609 14.9004 5.8334C14.9004 5.84071 14.9003 5.84799 14.9 5.85524V10.045C14.9003 10.0522 14.9004 10.0595 14.9004 10.0668C14.9004 10.3982 14.6318 10.6668 14.3004 10.6668H11.1668C10.8907 10.6668 10.6668 10.8907 10.6668 11.1668V14.3C10.6668 14.6314 10.3982 14.9 10.0668 14.9L10.05 14.8998L3.6 14.9C2.16406 14.9 1 13.7359 1 12.3V3.6ZM13.2 5.2334C13.4761 5.2334 13.7 5.00954 13.7 4.7334V3.6C13.7 2.8268 13.0732 2.2 12.3 2.2H11.1668C10.8907 2.2 10.6668 2.42386 10.6668 2.7V4.7334C10.6668 5.00954 10.8907 5.2334 11.1668 5.2334H13.2ZM10.6668 6.9334C10.6668 6.65726 10.8907 6.4334 11.1668 6.4334H13.2C13.4761 6.4334 13.7 6.65726 13.7 6.9334V8.9668C13.7 9.24294 13.4761 9.4668 13.2 9.4668H11.1668C10.8907 9.4668 10.6668 9.24294 10.6668 8.9668V6.9334ZM8.9668 5.2334C9.24294 5.2334 9.4668 5.00954 9.4668 4.7334V2.7C9.4668 2.42386 9.24294 2.2 8.9668 2.2H6.9334C6.65726 2.2 6.4334 2.42386 6.4334 2.7V4.7334C6.4334 5.00954 6.65726 5.2334 6.9334 5.2334L8.9668 5.2334ZM6.4334 6.9334C6.4334 6.65726 6.65726 6.4334 6.9334 6.4334L8.9668 6.4334C9.24294 6.4334 9.4668 6.65726 9.4668 6.9334V8.9668C9.4668 9.24294 9.24294 9.4668 8.9668 9.4668L6.9334 9.4668C6.65726 9.4668 6.4334 9.24294 6.4334 8.9668V6.9334ZM4.7334 5.2334C5.00954 5.2334 5.2334 5.00954 5.2334 4.7334V2.7C5.2334 2.42386 5.00954 2.2 4.7334 2.2H3.6C2.8268 2.2 2.2 2.8268 2.2 3.6V4.7334C2.2 5.00954 2.42386 5.2334 2.7 5.2334H4.7334ZM2.2 6.9334C2.2 6.65726 2.42386 6.4334 2.7 6.4334H4.7334C5.00954 6.4334 5.2334 6.65725 5.2334 6.9334V8.9668C5.2334 9.24294 5.00954 9.4668 4.7334 9.4668H2.7C2.42386 9.4668 2.2 9.24294 2.2 8.9668V6.9334ZM5.2334 11.1668C5.2334 10.8907 5.00954 10.6668 4.7334 10.6668H2.7C2.42386 10.6668 2.2 10.8907 2.2 11.1668V12.3C2.2 13.0732 2.8268 13.7 3.6 13.7H4.7334C5.00954 13.7 5.2334 13.4761 5.2334 13.2V11.1668ZM9.4668 11.1668C9.4668 10.8907 9.24294 10.6668 8.9668 10.6668H6.9334C6.65726 10.6668 6.4334 10.8907 6.4334 11.1668V13.2C6.4334 13.4761 6.65726 13.7 6.9334 13.7H8.9668C9.24294 13.7 9.4668 13.4761 9.4668 13.2V11.1668Z",fillRule:"evenodd",clipRule:"evenodd"}}]},eN=(0,I.forwardRef)(function(e,t){return(0,I.createElement)(eu,Object.assign({},e,{id:"select-range-single",ref:t,icon:eT}))});function eM(e){var t,n,r="";if("string"==typeof e||"number"==typeof e)r+=e;else if("object"==typeof e){if(Array.isArray(e)){var i=e.length;for(t=0;t<i;t++)e[t]&&(n=eM(e[t]))&&(r&&(r+=" "),r+=n)}else for(n in e)e[n]&&(r&&(r+=" "),r+=n)}return r}function ex(){for(var e,t,n=0,r="",i=arguments.length;n<i;n++)(e=arguments[n])&&(t=eM(e))&&(r&&(r+=" "),r+=t);return r}eN.displayName="SelectRangeSingle",M(eM,"r"),M(ex,"clsx");var eA,eO,eF=Object.defineProperty,ew=Object.getOwnPropertyDescriptor,eP=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?ew(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&eF(t,n,o),o},"__decorateClass$8"),eD=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$8");let ek=(M(eO=class extends o.BaseSelectionRenderService{constructor(e,t,n,r,i,o){super(t,n,r,i),x(this,"_workbookSelections"),x(this,"_eventDisposables"),this._context=e,this._refSelectionsService=o,this._workbookSelections=this._refSelectionsService.getWorkbookSelections(this._context.unitId),this._initSelectionChangeListener(),this._initSkeletonChangeListener(),this._initUserActionSyncListener(),this._setSelectionStyle(eL(this._themeService)),this._remainLastEnabled=!0}getLocation(){return this._skeleton.getLocation()}setRemainLastEnabled(e){this._remainLastEnabled=e}setSkipLastEnabled(e){this._skipLastEnabled=e}clearLastSelection(){let e=this._selectionControls[this._selectionControls.length-1];e&&(e.dispose(),this._selectionControls.pop())}enableSelectionChanging(){return this._disableSelectionChanging(),this._eventDisposables=this._initCanvasEventListeners(),(0,i.toDisposable)(()=>this._disableSelectionChanging())}_disableSelectionChanging(){var e;null==(e=this._eventDisposables)||e.dispose(),this._eventDisposables=null}_initCanvasEventListeners(){let{spreadsheetRowHeader:e,spreadsheetColumnHeader:t,spreadsheet:n,spreadsheetLeftTopPlaceholder:r}=this._getSheetObject(),{scene:l}=this._context,s=new i.DisposableCollection;return s.add(null==n?void 0:n.onPointerDown$.subscribeEvent((e,t)=>{this._onPointerDown(e,n.zIndex+1,i.RANGE_TYPE.NORMAL,this._getActiveViewport(e)),2!==e.button&&t.stopPropagation()})),s.add(null==e?void 0:e.onPointerDown$.subscribeEvent((e,t)=>{let r=this._sheetSkeletonManagerService.getCurrent().skeleton,{row:s}=(0,o.getCoordByOffset)(e.offsetX,e.offsetY,l,r);(0,o.checkInHeaderRanges)(this._workbookSelections.getCurrentSelections(),s,i.RANGE_TYPE.ROW)||(this._onPointerDown(e,(n.zIndex||1)+1,i.RANGE_TYPE.ROW,this._getActiveViewport(e),E.ScrollTimerType.Y),2!==e.button&&t.stopPropagation())})),s.add(null==t?void 0:t.onPointerDown$.subscribeEvent((e,t)=>{let r=this._sheetSkeletonManagerService.getCurrent().skeleton,{column:s}=(0,o.getCoordByOffset)(e.offsetX,e.offsetY,l,r);(0,o.checkInHeaderRanges)(this._workbookSelections.getCurrentSelections(),s,i.RANGE_TYPE.COLUMN)||(this._onPointerDown(e,(n.zIndex||1)+1,i.RANGE_TYPE.COLUMN,this._getActiveViewport(e),E.ScrollTimerType.X),2!==e.button&&t.stopPropagation())})),s.add(null==r?void 0:r.onPointerDown$.subscribeEvent((e,t)=>{this._reset();let n=this._sheetSkeletonManagerService.getCurrent().skeleton,r=(0,o.getAllSelection)(n),i=this.attachSelectionWithCoord(r);this._addSelectionControlBySelectionData(i),this._selectionMoveStart$.next(this.getSelectionDataWithStyle());let s=l.onPointerUp$.subscribeEvent(()=>{s.unsubscribe(),this._selectionMoveEnd$.next(this.getSelectionDataWithStyle())});2!==e.button&&t.stopPropagation()})),s}_initUserActionSyncListener(){this.disposeWithMe(this.selectionMoveStart$.subscribe(e=>{this._updateSelections(e,_.SelectionMoveType.MOVE_START)})),this.disposeWithMe(this.selectionMoving$.subscribe(e=>{this._updateSelections(e,_.SelectionMoveType.MOVING)})),this.disposeWithMe(this.selectionMoveEnd$.subscribe(e=>{this._updateSelections(e,_.SelectionMoveType.MOVE_END)}))}_updateSelections(e,t){let n=this._context.unit.getActiveSheet().getSheetId();0!==e.length&&this._workbookSelections.setSelections(n,e.map(e=>(0,_.convertSelectionDataToRange)(e)),t)}_initSelectionChangeListener(){this.disposeWithMe((0,h.merge)(this._workbookSelections.selectionMoveEnd$,this._workbookSelections.selectionSet$).subscribe(e=>{for(let t of(this._reset(),e)){let e=this.attachSelectionWithCoord(t);this._addSelectionControlBySelectionData(e)}}))}_initSkeletonChangeListener(){this.disposeWithMe(this._sheetSkeletonManagerService.currentSkeleton$.subscribe(e=>{if(!e)return;let{skeleton:t}=e,{scene:n}=this._context,r=n.getViewport(E.SHEET_VIEWPORT_KEY.VIEW_MAIN);this._skeleton&&this._skeleton.worksheet.getSheetId()!==t.worksheet.getSheetId()&&this._reset(),this._changeRuntime(t,n,r);let i=this._workbookSelections.getCurrentSelections();this._refreshSelectionControl(i||[])}))}_refreshSelectionControl(e){let t=e.map(e=>(0,o.attachSelectionWithCoord)(e,this._skeleton));this.updateControlForCurrentByRangeData(t)}_getActiveViewport(e){let t=this._getSheetObject();return null==t?void 0:t.scene.getActiveViewportByCoord((0,E.Vector2).FromArray([e.offsetX,e.offsetY]))}_getSheetObject(){return(0,o.getSheetObject)(this._context.unit,this._context)}},"RefSelectionsRenderService"),eO);function eL(e){let t=(0,_.getNormalSelectionStyle)(e);return t.hasAutoFill=!1,t.hasRowHeader=!1,t.hasColumnHeader=!1,t.widgets={tl:!0,tc:!0,tr:!0,ml:!0,mr:!0,bl:!0,bc:!0,br:!0},t}ek=eP([eD(1,(0,i.Inject)(i.Injector)),eD(2,(0,i.Inject)(i.ThemeService)),eD(3,R.IShortcutService),eD(4,(0,i.Inject)(o.SheetSkeletonManagerService)),eD(5,_.IRefSelectionsService)],ek),M(eL,"getDefaultRefSelectionStyle");let eU=/* @__PURE__ */M((e,t,n)=>{let r=(0,i.useDependency)(E.IRenderManagerService).getRenderById(e),o=null==r?void 0:r.with(ek);(0,I.useEffect)(()=>{if(n&&o){let e=n.input$.subscribe(e=>{e.content===l.matchToken.COMMA?o.setSkipLastEnabled(!0):o.setSkipLastEnabled(!1)});return()=>{e.unsubscribe()}}},[n,o]),(0,I.useEffect)(()=>{o&&(t.endsWith(l.matchToken.COMMA)||o.setSkipLastEnabled(!1))},[t,o])},"useEditorInput"),ej=/* @__PURE__ */M(e=>{let t=(0,i.useDependency)(l.LexerTreeBuilder),[n,r]=(0,I.useState)([]);return(0,I.useEffect)(()=>{var n;r(null!=(n=t.sequenceNodesBuilder(e))?n:[])},[e]),{sequenceNodes:n,sequenceNodesSet:r}},"useFormulaToken");function eB(e,t,n,r){let s=(0,i.useDependency)(i.IUniverInstanceService),a=(0,i.useDependency)(i.ThemeService),u=(0,i.useDependency)(_.IRefSelectionsService),c=(0,i.useDependency)(E.IRenderManagerService).getRenderById(t),d=null==c?void 0:c.with(ek),h=null==c?void 0:c.with(o.SheetSkeletonManagerService),[g,m]=(0,I.useState)([]);(0,I.useEffect)(()=>{let n=s.getUnit(t),i=null==n?void 0:n.getActiveSheet(),o=[];if(!n||!i||!e){m(o);return}let u=null==i?void 0:i.getSheetId(),c=/* @__PURE__ */M(e=>{var t;return null==(t=null==n?void 0:n.getSheetBySheetName(e))?void 0:t.getSheetId()},"getSheetIdByName");for(let e=0,n=r.length;e<n;e++){let{themeColor:n,token:s,refIndex:d}=r[e],{unitId:h,sheetName:g,range:m}=(0,l.deserializeRangeWithSheet)(s);if(h&&t!==h)continue;let S=c(g);if(S&&S!==u)continue;let f=(0,_.setEndForRange)(m,i.getRowCount(),i.getColumnCount());o.push({range:f,primary:void 0,style:eH(a,n,d.toString())})}m(o)},[t,n,r,e]),(0,I.useEffect)(()=>{let e=null==h?void 0:h.getCurrentSkeleton();if(e){let t=(null==d?void 0:d.getSelectionControls())||[];t.length===g.length?t.forEach((t,n)=>{let r=g[n],i=e.getCellByIndex(r.range.startRow,r.range.startColumn);t.updateRange((0,o.attachRangeWithCoord)(e,r.range),i),t.updateStyle(r.style)}):u.setSelections(g)}},[g,h]),(0,I.useEffect)(()=>()=>{u.setSelections([])},[])}function eW(e,t){let n=(0,i.useDependency)(v.IEditorService),r=(0,i.useDependency)(C.IDescriptionService),o=e$(),[l,s]=(0,I.useState)([]);return(0,I.useEffect)(()=>{let i=n.getEditor(e);if(!i)return;let l=i.getDocumentData();if(!l||!l.body)return;let a={dataStream:"",...l.body};if(null==t||0===t.length)a.textRuns=[],a.dataStream=`\r
`,s([]);else{let{textRuns:e,refSelections:n}=eV(r,o,t);a.textRuns=e;let i=t.reduce((e,t)=>"string"==typeof t?`${e}${t}`:`${e}${t.token}`,"");a.dataStream=`${i}\r
`,s(n)}let u=i.getSelectionRanges(),c={...l,body:a};i.setDocumentData(c,u)},[e,t,o]),l}function e$(){let e=(0,i.useDependency)(i.ThemeService).getCurrentTheme();return(0,I.useMemo)(()=>({formulaRefColors:[e.loopColor1,e.loopColor2,e.loopColor3,e.loopColor4,e.loopColor5,e.loopColor6,e.loopColor7,e.loopColor8,e.loopColor9,e.loopColor10,e.loopColor11,e.loopColor12],numberColor:e.hyacinth700,stringColor:e.verdancy800}),[e])}function eV(e,t,n){let{formulaRefColors:r,numberColor:i,stringColor:o}=t,s=[],a=[],u=/* @__PURE__ */new Map,c=0;for(let t=0,d=n.length;t<d;t++){let d=n[t];if("string"==typeof d){let e=s[s.length-1],t=e?e.ed:0,n=t+d.length;s.push({st:t,ed:n});continue}if(e.hasDefinedNameDescription(d.token.trim()))continue;let{startIndex:h,endIndex:g,nodeType:m,token:S}=d,f="";if(m===l.sequenceNodeType.REFERENCE){if(u.has(S))f=u.get(S);else{let e=c%r.length;f=r[e],u.set(S,f),c++}a.push({refIndex:t,themeColor:f,token:S})}else m===l.sequenceNodeType.NUMBER?f=i:(m===l.sequenceNodeType.STRING||m===l.sequenceNodeType.ARRAY)&&(f=o);f&&f.length>0&&s.push({st:h,ed:g+1,ts:{cl:{rgb:f}}})}return{textRuns:s,refSelections:a}}function eH(e,t,n){let r=e.getCurrentTheme(),o=new(0,i.ColorKit)(t).setAlpha(.05).toRgbString();return{id:n,strokeWidth:1,stroke:t,fill:o,widgets:{tl:!0,tc:!0,tr:!0,ml:!0,mr:!0,bl:!0,bc:!0,br:!0},widgetSize:6,widgetStrokeWidth:1,widgetStroke:r.colorWhite,hasAutoFill:!1,hasRowHeader:!1,hasColumnHeader:!1}}M(eB,"useSheetHighlight"),M(eW,"useDocHight"),M(e$,"useColor"),M(eV,"buildTextRuns"),M(eH,"getFormulaRefSelectionStyle$1");let eq=/* @__PURE__ */M((e,t,n)=>{let r=(0,i.useDependency)(E.IRenderManagerService),l=(0,i.useDependency)(i.IUniverInstanceService),s=(0,i.useDependency)(i.IContextService),a=(0,i.useDependency)(o.IEditorBridgeService),u=(0,i.useDependency)(_.SheetsSelectionsService),c=(0,i.useDependency)(R.IContextMenuService),d=r.getRenderById(t),h=null==d?void 0:d.with(ek);(0,I.useEffect)(()=>{if(e){let e=null==h?void 0:h.enableSelectionChanging();return s.setContextValue(_.DISABLE_NORMAL_SELECTIONS,!0),a.enableForceKeepVisible(),()=>{null==e||e.dispose(),s.setContextValue(_.DISABLE_NORMAL_SELECTIONS,!1),a.disableForceKeepVisible()}}},[e]),(0,I.useLayoutEffect)(()=>{if(e){let e=l.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),t=null==e?void 0:e.getActiveSheet(),n=[...u.getCurrentSelections()];return()=>{let e=l.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),r=null==e?void 0:e.getActiveSheet();r&&r===t&&u.setSelections(n)}}},[e]),(0,I.useEffect)(()=>{if(e)return c.disable(),()=>{c.enable()}},[e]),(0,I.useEffect)(()=>{e&&(null==h||h.setSkipLastEnabled(!1))},[e]),(0,I.useEffect)(()=>{n?null==h||h.setRemainLastEnabled(!1):null==h||h.setRemainLastEnabled(!0)},[n])},"useRefactorEffect"),eK=/* @__PURE__ */M(e=>{let t=/* @__PURE__ */M(()=>{if(e){let{scene:t,mainComponent:n}=e.render,r=e.render.with(b.DocSkeletonManagerService),{width:i,height:o}=e.getBoundingClientRect();r.getViewModel().getDataModel().updateDocumentDataPageSize(1/0),t.transformByState({width:i,height:o}),null==n||n.resize(i,o)}},"resize"),n=(0,I.useMemo)(()=>(0,i.debounce)(()=>{var t;if(!e)return;let n=e.render.with(b.DocSkeletonManagerService).getSkeleton(),{scene:r,mainComponent:i}=e.render,o=r.getViewport(v.VIEWPORT_KEY.VIEW_MAIN),{actualWidth:l}=n.getActualSize(),{width:s,height:a}=e.getBoundingClientRect(),u=null==o?void 0:o.getScrollBar(),c=Math.max(l,s);r.transformByState({width:c,height:a}),null==i||i.resize(c,a),l>s?null==u?o&&new E.ScrollBar(o,{barSize:8,enableVertical:!1}):null==o||o.resetCanvasSizeAndUpdateScroll():(u=null,null==o||o.scrollToBarPos({x:0,y:0}),null==(t=null==o?void 0:o.getScrollBar())||t.dispose())},30),[e]);return(0,I.useEffect)(()=>{if(e){let e=setTimeout(()=>{t(),n()},500);return()=>{clearTimeout(e)}}},[e]),(0,I.useEffect)(()=>{if(e){let t=e.input$.subscribe(()=>{n()});return()=>{t.unsubscribe()}}},[e]),{resize:t,checkScrollBar:n}},"useResize"),ez=/* @__PURE__ */M(e=>"string"==typeof e&&e===l.matchToken.COMMA,"isComma"),eG=/* @__PURE__ */M(e=>{if("object"==typeof e)return e.nodeType===l.sequenceNodeType.REFERENCE},"isReference"),eY=/* @__PURE__ */M(e=>e.filter(e=>ez(e)||eG(e)),"filterReferenceNode"),eZ=/* @__PURE__ */M(e=>{if(e.endColumn<e.startColumn){let t=e.endColumn;e.endColumn=e.startColumn,e.startColumn=t}if(e.endRow<e.startRow){let t=e.endRow;e.endRow=e.startRow,e.startRow=t}return e},"rangePreProcess"),eX=/* @__PURE__ */M(e=>e.map(e=>"string"==typeof e?e:e.token).join(""),"sequenceNodeToText");function eQ(e,t,n){var r,i;return(null==(i=null==(r=e.getUnit(t))?void 0:r.getSheetBySheetId(n))?void 0:i.getName())||""}M(eQ,"getSheetNameById");let eJ=/* @__PURE__ */M((e,t=!1)=>t?e.map(e=>""!==e.sheetName?(0,l.serializeRangeWithSheet)(e.sheetName,e.range):(0,l.serializeRange)(e.range)):e.map(e=>(0,l.serializeRange)(e.range)),"unitRangesToText"),e0=/* @__PURE__ */M((e,t,n,r,o,s,u)=>{let c=(0,i.useDependency)(E.IRenderManagerService),h=(0,i.useDependency)(i.IUniverInstanceService),g=(0,I.useRef)(!1),m=(0,I.useMemo)(()=>(0,i.debounce)(()=>{g.current=!1},300),[]),S=/* @__PURE__ */M(()=>{g.current=!0,m()},"setIsScaling"),f=c.getRenderById(t),v=null==f?void 0:f.with(ek),_=(0,I.useRef)([]),C=(0,I.useMemo)(()=>{let e=eY(r),t=_.current;return e.length===t.length?(t.splice(0),t.push(...e),t):e},[r]);_.current=C,(0,I.useEffect)(()=>{if(e&&v){let e=!0,n=/* @__PURE__ */M(n=>{var r;if(e){e=!1;return}let i=[...n],a=h.getUnit(t),c=(null==(r=null==a?void 0:a.getActiveSheet())?void 0:r.getName())||"",d=C.map((e,n)=>{if("string"==typeof e){if(!C[n-1])return null;let t=C[n+1];return ez(e)&&(ez(t)||n===C.length-1)?null:e}if(e.nodeType===l.sequenceNodeType.REFERENCE){let n=(0,l.deserializeRangeWithSheet)(e.token);n.unitId=""===n.unitId?t:n.unitId,n.sheetName=""===n.sheetName?c:n.sheetName;let{unitId:r,sheetName:a}=n;if(s&&(r!==t||c!==a))return null;if(r===t&&c===a){let n=i.shift();if(n&&eQ(h,t,n.rangeWithCoord.sheetId||"")===a){let t={...e};return eZ(n.rangeWithCoord),o?t.token=(0,l.serializeRangeWithSheet)(c,n.rangeWithCoord):t.token=(0,l.serializeRange)(n.rangeWithCoord),t}}return e}return null}).filter(e=>!!e),m=eJ(i.map(e=>{var t,n,r;return{range:e.rangeWithCoord,unitId:null!=(t=e.rangeWithCoord.unitId)?t:"",sheetName:eQ(h,null!=(n=e.rangeWithCoord.unitId)?n:"",null!=(r=e.rangeWithCoord.sheetId)?r:"")}}),o).join(l.matchToken.COMMA),S=eX(d),f=`${S}${S&&m?l.matchToken.COMMA:""}${m}`;u(f,g.current?-1:f.length)},"handleSelectionsChange"),r=v.selectionMoveEnd$.subscribe(e=>{n(e)}),i=v.selectionMoving$.pipe((0,p.throttleTime)(50)).subscribe(e=>{n(e)});return()=>{r.unsubscribe(),i.unsubscribe()}}},[e,C,v,o,s]),(0,I.useEffect)(()=>{if(e&&v){let e=new i.DisposableCollection,n=/* @__PURE__ */M((e,n)=>{var r;let i=0,s=0,a=!1,c=h.getUnit(t),d=(null==(r=null==c?void 0:c.getActiveSheet())?void 0:r.getName())||"";u(eX(C.map(r=>{if("string"==typeof r)return a||(s+=r.length),r;if(r.nodeType===l.sequenceNodeType.REFERENCE){a||(s+=r.token.length);let u=(0,l.deserializeRangeWithSheet)(e);if(u.unitId=""===u.unitId?t:u.unitId,u.sheetName=""===u.sheetName?d:u.sheetName,i===n){a=!0;let t={...r,token:e};return o?t.token=(0,l.serializeRangeWithSheet)(u.sheetName,u.range):t.token=(0,l.serializeRange)(u.range),i++,t}return i++,r}return r})),s||-1)},"handleSequenceNodeReplace"),r=0,s=v.selectionMoveEnd$.subscribe(()=>{r=setTimeout(()=>{v.getSelectionControls().forEach((t,r)=>{e.add(t.selectionScaling$.subscribe(e=>{n((0,l.serializeRange)(e),r),S()})),e.add(t.selectionMoving$.pipe((0,d.map)(e=>(0,l.serializeRange)(e)),(0,a.distinctUntilChanged)()).subscribe(e=>{n(e,r),S()}))})},30)});return()=>{s.unsubscribe(),e.dispose(),clearTimeout(r)}}},[e,v,C])},"useSheetSelectionChange"),e1=/* @__PURE__ */M(e=>!e.some(e=>{if("string"==typeof e){if(e!==l.matchToken.COMMA)return!0}else if(e.nodeType!==l.sequenceNodeType.REFERENCE)return!0;return!1}),"verifyRange"),e9=/* @__PURE__ */M((e,t)=>{let n=(0,I.useRef)(!0);(0,I.useEffect)(()=>{let e=setTimeout(()=>{n.current=!1},500);return()=>{clearTimeout(e)}}),(0,I.useEffect)(()=>{!n.current&&e&&e(e1(t),eX(t))},[t,e])},"useVerify"),e3={sheetRangeSelectorTextWrap:"univer-sheet-range-selector-text-wrap",sheetRangeSelectorPlaceholder:"univer-sheet-range-selector-placeholder",sheetRangeSelectorError:"univer-sheet-range-selector-error",sheetRangeSelectorErrorWrap:"univer-sheet-range-selector-error-wrap",sheetRangeSelectorText:"univer-sheet-range-selector-text",sheetRangeSelectorActive:"univer-sheet-range-selector-active",sheetRangeSelectorIcon:"univer-sheet-range-selector-icon",sheetRangeSelectorDialogItem:"univer-sheet-range-selector-dialog-item",sheetRangeSelectorDialogItemDelete:"univer-sheet-range-selector-dialog-item-delete"},e6=/* @__PURE__ */M(()=>{},"noopFunction");function e2(e){let{initValue:t,unitId:n,subUnitId:r,errorText:s,placeholder:a,actions:u,onChange:c=e6,onVerify:d=e6,onRangeSelectorDialogVisibleChange:h=e6,onBlur:g=e6,isFocus:m=!0,isOnlyOneRange:S=!1,isSupportAcrossSheet:f=!1}=e,p=(0,i.useDependency)(v.IEditorService),C=(0,i.useDependency)(i.LocaleService),R=(0,i.useDependency)(i.ICommandService),E=(0,i.useDependency)(l.LexerTreeBuilder),b=(0,I.useRef)(null),[T,N]=(0,I.useState)(!1),[x,A]=(0,I.useState)(m),O=(0,I.useMemo)(()=>(0,i.createInternalEditorID)(`${o.RANGE_SELECTOR_SYMBOLS}-${(0,i.generateRandomId)(4)}`),[]),[F,w]=(0,I.useState)(),P=(0,I.useRef)(null),[D,k]=(0,I.useState)(()=>"string"==typeof t?t:eJ(t,f).join(l.matchToken.COMMA));u&&(u.handleOutClick=(e,t)=>{b.current&&t(b.current.contains(e.target))});let L=(0,I.useMemo)(()=>D.split(l.matchToken.COMMA).filter(e=>!!e).map(e=>(0,l.deserializeRangeWithSheet)(e)),[D]),U=(0,I.useMemo)(()=>void 0!==s,[s]),j=(0,I.useMemo)(()=>(0,i.debounce)(e=>{let t=E.sequenceNodesBuilder(e);t?e1(t)&&c(eX(t.map(e=>{if("string"==typeof e)return e;if(e.nodeType===l.sequenceNodeType.REFERENCE){let t=(0,l.deserializeRangeWithSheet)(e.token);t.range=eZ(t.range),f||(t.sheetName="",t.unitId=""),e.token=eJ([t],f)[0]}return e}))):k("")},30),[f]),B=/* @__PURE__ */M(e=>{let t=eJ(e,f).join(l.matchToken.COMMA);k(t),c(t),N(!1),h(!1)},"handleConfirm"),W=/* @__PURE__ */M(()=>{N(!1),h(!1)},"handleClose"),$=/* @__PURE__ */M(()=>{U||(N(!0),h(!0))},"handleOpenModal"),V=(0,I.useMemo)(()=>{let e=0;return()=>{clearTimeout(e),F&&(e=setTimeout(()=>{F.focus()},30))}},[F]),{checkScrollBar:H}=eK(F),q=(0,I.useMemo)(()=>(e,t)=>{k(e),c(e),V(),-1!==t&&setTimeout(()=>{let e={startOffset:t,endOffset:t};null==F||F.setSelectionRanges([e]);let n=null==F?void 0:F.render.with(v.DocBackScrollRenderController);null==n||n.scrollToRange({...e,collapsed:!0})},50),H()},[F]),{sequenceNodes:K,sequenceNodesSet:z}=ej(D);return eB(!T&&x,n,r,eW(O,K)),e0(!T&&x,n,r,K,f,S,q),eq(!T&&x,n,S),eU(n,D,F),e9(d,K),(0,I.useEffect)(()=>{if(F){let e=F.input$.subscribe(e=>{var t,n;let r=(null!=(n=null==(t=e.data.body)?void 0:t.dataStream)?n:"").replaceAll(/\n|\r/g,"").replaceAll(/,{2,}/g,",").replaceAll(/(^,)/g,"");k(r),j(r)});return()=>{e.unsubscribe()}}},[F]),(0,I.useEffect)(()=>{let e=R.beforeCommandExecuted(e=>{e.id!==_.SetWorksheetActiveOperation.id||f||(A(!1),g(),z(e=>[...e]))}),t=R.onCommandExecuted(e=>{e.id===o.SetCellEditVisibleOperation.id&&(N(!1),h(!1),A(!1),g())});return()=>{e.dispose(),t.dispose()}},[f]),(0,I.useEffect)(()=>{A(m)},[m]),(0,I.useEffect)(()=>{if(F&&T){F.blur();let e=F.focus$.subscribe(()=>{F.blur()});return()=>{e.unsubscribe()}}},[F,T]),(0,I.useLayoutEffect)(()=>{let e;return P.current&&(e=p.register({autofocus:!0,editorUnitId:O,isSingle:!0,initialSnapshot:{id:O,body:{dataStream:`\r
`},documentStyle:{}}},P.current),w(p.getEditor(O))),()=>{null==e||e.dispose()}},[P.current]),/* @__PURE__ */el.jsxs("div",{className:e3.sheetRangeSelector,ref:b,children:[/* @__PURE__ */el.jsxs("div",{className:ex(e3.sheetRangeSelectorTextWrap,{[e3.sheetRangeSelectorActive]:x&&!U,[e3.sheetRangeSelectorError]:U}),children:[/* @__PURE__ */el.jsx("div",{className:e3.sheetRangeSelectorText,ref:P}),/* @__PURE__ */el.jsx(y.Tooltip,{title:C.t("rangeSelector.buttonTooltip"),placement:"bottom",children:/* @__PURE__ */el.jsx(eN,{className:e3.sheetRangeSelectorIcon,onClick:$})}),void 0!==s?/* @__PURE__ */el.jsx("div",{className:e3.sheetRangeSelectorErrorWrap,children:s}):null,void 0===a||D?null:/* @__PURE__ */el.jsx("div",{className:e3.sheetRangeSelectorPlaceholder,children:a})]}),T&&/* @__PURE__ */el.jsx(e4,{handleConfirm:B,handleClose:W,unitId:n,subUnitId:r,initValue:L,visible:T,isOnlyOneRange:S,isSupportAcrossSheet:f})]})}function e4(e){let{handleConfirm:t,handleClose:n,visible:r,initValue:o,unitId:s,subUnitId:a,isOnlyOneRange:u,isSupportAcrossSheet:c}=e,d=(0,i.useDependency)(i.LocaleService),h=(0,i.useDependency)(C.IDescriptionService),g=(0,i.useDependency)(l.LexerTreeBuilder),m=(0,i.useDependency)(E.IRenderManagerService).getRenderById(s),S=null==m?void 0:m.with(ek),[f,p]=(0,I.useState)(()=>{if(u){let e=o[0];return e?eJ([e],c):[""]}return eJ(o,c)}),[v,_]=(0,I.useState)(()=>f.length-1),R=e$(),{sequenceNodes:b,sequenceNodesSet:T}=ej((0,I.useMemo)(()=>f.join(l.matchToken.COMMA),[f])),N=(0,I.useMemo)(()=>eV(h,R,b).refSelections,[b]),x=/* @__PURE__ */M(()=>{T([]),setTimeout(()=>{n()},30)},"handleClose"),A=/* @__PURE__ */M((e,t)=>{t?null==S||S.setSkipLastEnabled(!1):null==S||S.setSkipLastEnabled(!0),p(n=>{let r=[...n];return r[e]=t,r})},"handleRangeInput"),O=/* @__PURE__ */M(e=>{null==S||S.setSkipLastEnabled(!1),p(t=>{if(1===t.length)return t;let n=[];return t.forEach((t,r)=>{e!==r&&n.push(t)}),n})},"handleRangeRemove"),F=/* @__PURE__ */M(()=>{null==S||S.setSkipLastEnabled(!0),p(e=>(e.push(""),_(e.length-1),[...e]))},"handleRangeAdd"),w=(0,I.useCallback)(e=>{var t;null==S||S.setSkipLastEnabled(!1);let n=e.split(l.matchToken.COMMA).filter(e=>!!e);p(u?[null!=(t=n[0])?t:""]:n)},[v,u]);return eB(r,s,a,N),e0(v>=0,s,a,b,c,u,w),eq(v>=0,s,u),(0,I.useEffect)(()=>{0!==f.length&&(1!==f.length||f[0])||null==S||S.setSkipLastEnabled(!0)},[f]),/* @__PURE__ */el.jsx(y.Dialog,{width:"328px",visible:r,title:d.t("rangeSelector.title"),draggable:!0,closeIcon:/* @__PURE__ */el.jsx(ep,{}),footer:/* @__PURE__ */el.jsxs("footer",{children:[/* @__PURE__ */el.jsx(y.Button,{onClick:x,children:d.t("rangeSelector.cancel")}),/* @__PURE__ */el.jsx(y.Button,{style:{marginLeft:10},onClick:/* @__PURE__ */M(()=>t(f.filter(e=>{let t=g.sequenceNodesBuilder(e);return t&&1===t.length&&"string"!=typeof t[0]&&t[0].nodeType===l.sequenceNodeType.REFERENCE}).map(e=>(0,l.deserializeRangeWithSheet)(e)).map(e=>({...e,range:eZ(e.range)}))),"onClick"),type:"primary",children:d.t("rangeSelector.confirm")})]}),onClose:x,children:/* @__PURE__ */el.jsxs("div",{className:e3.sheetRangeSelectorDialog,children:[f.map((e,t)=>/* @__PURE__ */el.jsxs("div",{className:e3.sheetRangeSelectorDialogItem,children:[/* @__PURE__ */el.jsx(y.Input,{affixWrapperStyle:{width:"100%"},placeholder:d.t("rangeSelector.placeHolder"),onFocus:/* @__PURE__ */M(()=>_(t),"onFocus"),value:e,onChange:/* @__PURE__ */M(e=>A(t,e),"onChange")},`input_${t}`),f.length>1&&!u&&/* @__PURE__ */el.jsx(e_,{className:e3.sheetRangeSelectorDialogItemDelete,onClick:/* @__PURE__ */M(()=>O(t),"onClick")})]},t)),!u&&/* @__PURE__ */el.jsx("div",{children:/* @__PURE__ */el.jsxs(y.Button,{type:"link",size:"small",onClick:F,children:[/* @__PURE__ */el.jsx(ey,{}),/* @__PURE__ */el.jsx("span",{children:d.t("rangeSelector.addAnotherRange")})]})})]})})}M(e2,"RangeSelector"),M(e4,"RangeSelectorDialog");let e5={};function e8(e){return e.getContextValue(i.FOCUSING_DOC)&&e.getContextValue(i.FOCUSING_UNIVER_EDITOR)&&e.getContextValue(i.FOCUSING_UNIVER_EDITOR_STANDALONE_SINGLE_MODE)}function e7(e,t=!1){return(t||(0,i.isFormulaString)(null==e?void 0:e.f)||(0,i.isFormulaId)(null==e?void 0:e.si))&&"string"==typeof(null==e?void 0:e.v)&&(0,l.ERROR_TYPE_SET).has(e.v)?e.v:null}M(e8,"whenEditorStandalone"),M(e7,"extractFormulaError");var te=Object.defineProperty,tt=Object.getOwnPropertyDescriptor,tn=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?tt(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&te(t,n,o),o},"__decorateClass$7"),tr=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$7");let ti="SHEET_FORMULA_ALERT",to={[l.ErrorType.DIV_BY_ZERO]:"divByZero",[l.ErrorType.NAME]:"name",[l.ErrorType.VALUE]:"value",[l.ErrorType.NUM]:"num",[l.ErrorType.NA]:"na",[l.ErrorType.CYCLE]:"cycle",[l.ErrorType.REF]:"ref",[l.ErrorType.SPILL]:"spill",[l.ErrorType.CALC]:"calc",[l.ErrorType.ERROR]:"error",[l.ErrorType.CONNECT]:"connect",[l.ErrorType.NULL]:"null"},tl=(M(ts=class extends i.Disposable{constructor(e,t,n,r,i,o){super(),this._context=e,this._hoverManagerService=t,this._cellAlertManagerService=n,this._localeService=r,this._formulaDataModel=i,this._zenZoneService=o,this._init()}_init(){this._initCellAlertPopup(),this._initZenService()}_initCellAlertPopup(){this.disposeWithMe(this._hoverManagerService.currentCell$.subscribe(e=>{var t,n,r,l,s;if(e){let a=this._context.unit.getActiveSheet();if(!a)return;let u=a.getCell(e.location.row,e.location.col),c=null==(l=null==(r=null==(n=null==(t=this._formulaDataModel.getArrayFormulaCellData())?void 0:t[e.location.unitId])?void 0:n[e.location.subUnitId])?void 0:r[e.location.row])?void 0:l[e.location.col];if((0,i.isICellData)(u)){let t=e7(u,!!c);if(!t)return;let n=this._cellAlertManagerService.currentAlert.get(ti),r=null==(s=null==n?void 0:n.alert)?void 0:s.location;if(r&&r.row===e.location.row&&r.col===e.location.col&&r.subUnitId===e.location.subUnitId&&r.unitId===e.location.unitId)return;this._cellAlertManagerService.showAlert({type:o.CellAlertType.ERROR,title:this._localeService.t("formula.error.title"),message:this._localeService.t(`formula.error.${to[t]}`),location:e.location,width:200,height:74,key:ti});return}}this._cellAlertManagerService.removeAlert(ti)}))}_initZenService(){this.disposeWithMe(this._zenZoneService.visible$.subscribe(e=>{e&&this._cellAlertManagerService.removeAlert(ti)}))}},"FormulaAlertRenderController"),ts);tl=tn([tr(1,(0,i.Inject)(o.HoverManagerService)),tr(2,(0,i.Inject)(o.CellAlertManagerService)),tr(3,(0,i.Inject)(i.LocaleService)),tr(4,(0,i.Inject)(l.FormulaDataModel)),tr(5,R.IZenZoneService)],tl);var ts,ta,tu=Object.defineProperty,tc=Object.getOwnPropertyDescriptor,td=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?tc(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&tu(t,n,o),o},"__decorateClass$6"),th=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$6");let tg=(ta=class extends i.Disposable{constructor(e,t){super(),this._autoFillService=e,this._lexerTreeBuilder=t,this._registerAutoFill()}_registerAutoFill(){let e={type:o.DATA_TYPE.FORMULA,priority:1001,match:/* @__PURE__ */M(e=>(0,i.isFormulaString)(null==e?void 0:e.f)||(0,i.isFormulaId)(null==e?void 0:e.si),"match"),isContinue:/* @__PURE__ */M((e,t)=>e.type===o.DATA_TYPE.FORMULA,"isContinue"),applyFunctions:{[o.APPLY_TYPE.COPY]:(e,t,n,r)=>{let{data:i,index:o}=e;return this._fillCopyFormula(i,t,n,o,r)}}};this._autoFillService.registerRule(e)}_fillCopyFormula(e,t,n,r,o){var l,s;let a=tS(o),u=[],c=/* @__PURE__ */new Map;for(let r=1;r<=t;r++){let t=(r-1)%e.length,o=(0,i.Tools).deepClone(e[t]);if(o){let r=(null==(l=e[t])?void 0:l.f)||"",d=(null==(s=e[t])?void 0:s.si)||"",h=(0,i.isFormulaString)(r);if((0,i.isFormulaId)(d))o.si=d,o.f=null,o.v=null,o.p=null,o.t=null,n===i.Direction.DOWN||n===i.Direction.RIGHT?u.push(o):u.unshift(o);else if(h){let e=c.get(t);if(e)o.si=e,o.f=null,o.v=null,o.p=null,o.t=null;else{e=(0,i.Tools).generateRandomId(6),c.set(t,e);let{offsetX:l,offsetY:s}=tm(a,n),u=this._lexerTreeBuilder.moveFormulaRefOffset(r,l,s);o.si=e,o.f=u,o.v=null,o.p=null,o.t=null}n===i.Direction.DOWN||n===i.Direction.RIGHT?u.push(o):u.unshift(o)}}}return u}},M(ta,"FormulaAutoFillController"),ta);function tm(e,t){let n=0,r=0;switch(t){case i.Direction.UP:r=-e;break;case i.Direction.RIGHT:n=e;break;case i.Direction.DOWN:r=e;break;case i.Direction.LEFT:n=-e}return{offsetX:n,offsetY:r}}function tS(e){let t=0;for(let n in e)e[n].forEach(e=>{t+=e.data.length});return t}tg=td([th(0,o.IAutoFillService),th(1,(0,i.Inject)(l.LexerTreeBuilder))],tg),M(tm,"directionToOffset"),M(tS,"getDataLength");var tf=Object.defineProperty,tp=Object.getOwnPropertyDescriptor,tv=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?tp(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&tf(t,n,o),o},"__decorateClass$5"),t_=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$5");let tC=(tM=class extends i.Disposable{constructor(e,t,n,r,i){super(),this._currentUniverSheet=e,this._lexerTreeBuilder=t,this._sheetClipboardService=n,this._injector=r,this._formulaDataModel=i,this._initialize()}_initialize(){this._registerClipboardHook()}_registerClipboardHook(){this.disposeWithMe(this._sheetClipboardService.addClipboardHook(this._pasteFormulaHook())),this.disposeWithMe(this._sheetClipboardService.addClipboardHook(this._pasteWithFormulaHook()))}_pasteFormulaHook(){return{id:o.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA,priority:10,specialPasteInfo:{label:"specialPaste.formula"},onPasteCells:/* @__PURE__ */M((e,t,n,r)=>this._onPasteCells(e,t,n,r,!0),"onPasteCells")}}_pasteWithFormulaHook(){return{id:"default-paste-formula",priority:10,onPasteCells:/* @__PURE__ */M((e,t,n,r)=>this._onPasteCells(e,t,n,r,!1),"onPasteCells")}}_onPasteCells(e,t,n,r,l){var s;if([(0,o.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_FORMAT,(0,o.PREDEFINED_HOOK_NAME).SPECIAL_PASTE_COL_WIDTH].includes(r.pasteType))return{undos:[],redos:[]};let a=this._currentUniverSheet.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),u=t.unitId||a.getUnitId(),c=t.subUnitId||(null==(s=a.getActiveSheet())?void 0:s.getSheetId());if(!u||!c)return{undos:[],redos:[]};let d=t.range,h={copyType:r.copyType||o.COPY_TYPE.COPY,copyRange:null==e?void 0:e.range,pasteType:r.pasteType};return this._injector.invoke(t=>tR(u,c,d,n,t,h,this._lexerTreeBuilder,this._formulaDataModel,l,e))}},M(tM,"FormulaClipboardController"),tM);function tR(e,t,n,r,i,o,l,s,a=!1,u){let c=[],d=[],h=tI(e,t,n,r,o,l,s,u),g={unitId:e,subUnitId:t,cellValue:h.getData()};c.push({id:_.SetRangeValuesMutation.id,params:g});let m=(0,_.SetRangeValuesUndoMutationFactory)(i,g);return d.push({id:_.SetRangeValuesMutation.id,params:m}),{undos:d,redos:c}}function tI(e,t,n,r,i,l,s,a){return a?i.pasteType===o.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_VALUE?tE(e,t,n,r,s,a):i.pasteType===o.PREDEFINED_HOOK_NAME.SPECIAL_PASTE_FORMULA?tb(e,t,n,r,l,s,a):tT(e,t,n,r,l,s,a):ty(e,t,n,r,s)}function ty(e,t,n,r,o){var l,s;let a=new i.ObjectMatrix,u=null==(s=null==(l=o.getFormulaData())?void 0:l[e])?void 0:s[t];return r.forValue((e,t,r)=>{var o;let l=n.rows[e],s=n.cols[t],c={};(0,i.isFormulaString)(r.v)?(c.v=null,c.f=`${r.v}`,c.si=null,c.p=null,a.setValue(l,s,c)):null!=(o=null==u?void 0:u[l])&&o[s]&&(c.v=r.v,c.f=null,c.si=null,c.p=null,a.setValue(l,s,c))}),a}function tE(e,t,n,r,o,l){var s,a,u,c;let d=new i.ObjectMatrix,h=null==(a=null==(s=o.getArrayFormulaCellData())?void 0:s[l.unitId])?void 0:a[l.subUnitId],g=null==(c=null==(u=o.getFormulaData())?void 0:u[e])?void 0:c[t];return r.forValue((e,t,r)=>{var o,s;let a=l.range.rows[e%l.range.rows.length],u=l.range.cols[t%l.range.cols.length],c=n.rows[e],m=n.cols[t],S={};if((0,i.isFormulaString)(r.f)||(0,i.isFormulaId)(r.si))S.v=r.v,S.f=null,S.si=null,S.p=null,d.setValue(c,m,S);else if(null!=(o=null==h?void 0:h[a])&&o[u]){let e=h[a][u];S.v=e.v,S.f=null,S.si=null,S.p=null,d.setValue(c,m,S)}else if(null!=(s=null==g?void 0:g[c])&&s[m]){if(S.v=r.v,S.f=null,S.si=null,S.p=null,r.p){let e=tN(r);e&&(S.v=e)}d.setValue(c,m,S)}}),d}function tb(e,t,n,r,o,l,s){let a=new i.ObjectMatrix,u=/* @__PURE__ */new Map;return r.forValue((r,c,d)=>{let h=n.rows[r],g=n.cols[c],m={};if((0,i.isFormulaId)(d.si)){if(s.unitId!==e||s.subUnitId!==t){let e=l.getFormulaStringByCell(s.range.rows[r%s.range.rows.length],s.range.cols[c%s.range.cols.length],s.subUnitId,s.unitId),t=n.cols[c]-s.range.cols[c%s.range.cols.length],i=n.rows[r]-s.range.rows[r%s.range.rows.length],a=o.moveFormulaRefOffset(e||"",t,i);m.si=null,m.f=a}else m.si=d.si,m.f=null;m.v=null,m.p=null,a.setValue(h,g,m)}else if((0,i.isFormulaString)(d.f)){let e=`${r%s.range.rows.length}_${c%s.range.cols.length}`,t=u.get(e);if(t)m.si=t,m.f=null;else{t=(0,i.Tools).generateRandomId(6),u.set(e,t);let l=n.cols[c]-s.range.cols[c%s.range.cols.length],a=n.rows[r]-s.range.rows[r%s.range.rows.length],h=o.moveFormulaRefOffset(d.f||"",l,a);m.si=t,m.f=h}m.v=null,m.p=null,a.setValue(h,g,m)}else{if(m.v=d.v,m.f=null,m.si=null,m.p=null,d.p){let e=tN(d);e&&(m.v=e)}a.setValue(h,g,m)}}),a}function tT(e,t,n,r,o,l,s){var a,u;let c=new i.ObjectMatrix,d=/* @__PURE__ */new Map,h=null==(u=null==(a=l.getFormulaData())?void 0:a[e])?void 0:u[t];return r.forValue((r,a,u)=>{var g;let m=n.rows[r],S=n.cols[a],f={};if((0,i.isFormulaId)(u.si)){if(s.unitId!==e||s.subUnitId!==t){let e=l.getFormulaStringByCell(s.range.rows[r%s.range.rows.length],s.range.cols[a%s.range.cols.length],s.subUnitId,s.unitId),t=n.cols[a]-s.range.cols[a%s.range.cols.length],i=n.rows[r]-s.range.rows[r%s.range.rows.length],u=o.moveFormulaRefOffset(e||"",t,i);f.si=null,f.f=u}else f.si=u.si,f.f=null;f.v=null,f.p=null,c.setValue(m,S,f)}else if((0,i.isFormulaString)(u.f)){let e=`${r%s.range.rows.length}_${a%s.range.cols.length}`,t=d.get(e);if(t)f.si=t,f.f=null;else{t=(0,i.Tools).generateRandomId(6),d.set(e,t);let l=n.cols[a]-s.range.cols[a%s.range.cols.length],c=n.rows[r]-s.range.rows[r%s.range.rows.length],h=o.moveFormulaRefOffset(u.f||"",l,c);f.si=t,f.f=h}f.v=null,f.p=null,c.setValue(m,S,f)}else null!=(g=null==h?void 0:h[m])&&g[S]&&(f.v=u.v,f.f=null,f.si=null,f.p=u.p,c.setValue(m,S,f))}),c}function tN(e){if(null!=e&&e.p){let t=null==e?void 0:e.p.body;if(null==t)return;let n=t.dataStream;return n.substring(n.length-2,n.length)===i.DEFAULT_EMPTY_DOCUMENT_VALUE?n.substring(0,n.length-2):n}}tC=tv([t_(0,i.IUniverInstanceService),t_(1,(0,i.Inject)(l.LexerTreeBuilder)),t_(2,o.ISheetClipboardService),t_(3,(0,i.Inject)(i.Injector)),t_(4,(0,i.Inject)(l.FormulaDataModel))],tC),M(tR,"getSetCellFormulaMutations"),M(tI,"getValueMatrix"),M(ty,"getValueMatrixOfPasteFromIsNull"),M(tE,"getSpecialPasteValueValueMatrix"),M(tb,"getSpecialPasteFormulaValueMatrix"),M(tT,"getDefaultPasteValueMatrix"),M(tN,"getCellRichText");var tM,tx,tA=Object.defineProperty,tO=Object.getOwnPropertyDescriptor,tF=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?tO(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&tA(t,n,o),o},"__decorateClass$4"),tw=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$4");let tP=(tx=class extends i.Disposable{constructor(e,t,n,r,i,o,l,s){super(),x(this,"_previousShape"),x(this,"_skeleton"),this._context=e,this._editorBridgeService=t,this._formulaDataModel=n,this._themeService=r,this._renderManagerService=i,this._sheetSkeletonManagerService=o,this._commandService=l,this._logService=s,this._initSkeletonChangeListener(),this._initInterceptorEditorStart(),this._commandExecutedListener()}_initSkeletonChangeListener(){this.disposeWithMe(this._sheetSkeletonManagerService.currentSkeleton$.subscribe(e=>{var t,n;if(null==e)this._logService.debug("[FormulaEditorShowController]: should not receive currentSkeleton$ as null!");else{let{skeleton:r}=e,i=null==(n=null==(t=this._skeleton)?void 0:t.worksheet)?void 0:n.getSheetId();if(this._changeRuntime(r),i!==r.worksheet.getSheetId())this._removeArrayFormulaRangeShape();else{let{unitId:t,sheetId:n}=e;this._updateArrayFormulaRangeShape(t,n)}}}))}_changeRuntime(e){this._skeleton=e}_initInterceptorEditorStart(){this.disposeWithMe((0,i.toDisposable)(this._editorBridgeService.interceptor.intercept(this._editorBridgeService.interceptor.getInterceptPoints().BEFORE_CELL_EDIT,{handler:/* @__PURE__ */M((e,t,n)=>{var r,i,o,l;let{row:s,col:a,unitId:u,subUnitId:c,worksheet:d}=t,h=this._formulaDataModel.getArrayFormulaRange(),g=this._formulaDataModel.getArrayFormulaCellData();if(this._removeArrayFormulaRangeShape(),null==e)return n(e);let m=null,S=this._formulaDataModel.getFormulaStringByCell(s,a,c,u);if(null!==S&&(m={f:S}),null!=e.v&&""!==e.v&&(null==(o=null==(i=null==(r=g[u])?void 0:r[c])?void 0:i[s])?void 0:o[a])==null)return m?{...e,...m}:n(e);let f=null==(l=null==h?void 0:h[u])?void 0:l[c];return null!=f&&(m=this._displayArrayFormulaRangeShape(f,s,a,u,c,d,m)),m?{...e,...m}:n(e)},"handler")})))}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted((e,t)=>{(e.id===l.SetFormulaCalculationResultMutation.id||e.id===l.SetArrayFormulaDataMutation.id&&t&&t.remove)&&this._removeArrayFormulaRangeShape()})),this.disposeWithMe(this._commandService.beforeCommandExecuted(e=>{_.SetWorksheetRowAutoHeightMutation.id===e.id&&requestIdleCallback(()=>{let{unitId:t,subUnitId:n,rowsAutoHeightInfo:r}=e.params;this._refreshArrayFormulaRangeShapeByRow(t,n,r)})}))}_displayArrayFormulaRangeShape(e,t,n,r,o,s,a){return new(0,i.ObjectMatrix)(e).forValue((e,i,u)=>{if(null==u)return!0;let{startRow:c,startColumn:d,endRow:h,endColumn:g}=u;if(e===t&&i===n)return this._createArrayFormulaRangeShape(u,r),!1;if(t>=c&&t<=h&&n>=d&&n<=g){let t=s.getCell(c,d);if((null==t?void 0:t.v)===l.ErrorType.SPILL)return;let n=this._formulaDataModel.getFormulaDataItem(e,i,o,r);return null==n||null==n.f||(null==a&&(a={f:n.f,isInArrayFormulaRange:!0}),this._createArrayFormulaRangeShape(u,r),!1)}}),a}_createArrayFormulaRangeShape(e,t){let n=this._themeService.getCurrentTheme(),r=new(0,i.ColorKit)(n.colorWhite).setAlpha(0).toString(),l={strokeWidth:1,stroke:n.hyacinth700,fill:r,widgets:{},hasAutoFill:!1,hasRowHeader:!1,hasColumnHeader:!1},s=this._renderManagerService.getRenderById(t);if(!s)return;let{scene:a}=s,{rangeWithCoord:u,primaryWithCoord:c}=s.with(o.ISheetSelectionRenderService).attachSelectionWithCoord({range:e,primary:null,style:l}),d=this._sheetSkeletonManagerService.getCurrentSkeleton();if(!a||!d)return;let{rowHeaderWidth:h,columnHeaderHeight:g}=d,m=new o.SelectionShape(a,o.SELECTION_SHAPE_DEPTH.FORMULA_EDITOR_SHOW,this._themeService,!1);m.update(u,h,g,l,c),m.setEvent(!1),this._previousShape=m}_removeArrayFormulaRangeShape(){null!=this._previousShape&&(this._previousShape.dispose(),this._previousShape=null)}_refreshArrayFormulaRangeShape(e,t){if(this._previousShape){let{startRow:t,endRow:n,startColumn:r,endColumn:i}=this._previousShape.getRange();this._removeArrayFormulaRangeShape(),this._createArrayFormulaRangeShape({startRow:t,endRow:n,startColumn:r,endColumn:i},e)}}_checkCurrentSheet(e,t){let n=this._sheetSkeletonManagerService.getCurrentSkeleton();if(!n)return!1;let r=n.worksheet;return!!r&&r.unitId===e&&r.getSheetId()===t}_updateArrayFormulaRangeShape(e,t){this._checkCurrentSheet(e,t)&&this._previousShape&&this._refreshArrayFormulaRangeShape(e)}_refreshArrayFormulaRangeShapeByRow(e,t,n){if(!this._checkCurrentSheet(e,t)||!this._previousShape)return;let{startRow:r,endRow:i,startColumn:o,endColumn:l}=this._previousShape.getRange();for(let t=0;t<n.length;t++){let{row:s}=n[t];if(r>=s){let t={startRow:r,endRow:i,startColumn:o,endColumn:l};this._refreshArrayFormulaRangeShape(e,t);break}}}},M(tx,"FormulaEditorShowController"),tx);tP=tF([tw(1,(0,i.Inject)(o.IEditorBridgeService)),tw(2,(0,i.Inject)(l.FormulaDataModel)),tw(3,(0,i.Inject)(i.ThemeService)),tw(4,E.IRenderManagerService),tw(5,(0,i.Inject)(o.SheetSkeletonManagerService)),tw(6,i.ICommandService),tw(7,i.ILogService)],tP);var tD=Object.defineProperty,tk=Object.getOwnPropertyDescriptor,tL=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?tk(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&tD(t,n,o),o},"__decorateClass$3"),tU=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$3");let tj={tl:{size:6,color:"#409f11"}},tB=(nu=class extends i.RxDisposable{constructor(e,t){super(),this._sheetInterceptorService=e,this._formulaDataModel=t,this.disposeWithMe(this._sheetInterceptorService.intercept(_.INTERCEPTOR_POINT.CELL_CONTENT,{effect:i.InterceptorEffectEnum.Style,handler:/* @__PURE__ */M((e,t,n)=>{var r,i,o,l;return n(e7(e,!!(null==(l=null==(o=null==(i=null==(r=this._formulaDataModel.getArrayFormulaCellData())?void 0:r[t.unitId])?void 0:i[t.subUnitId])?void 0:o[t.row])?void 0:l[t.col]))?{...e,markers:{...null==e?void 0:e.markers,...tj}}:e)},"handler"),priority:10}))}},M(nu,"FormulaRenderManagerController"),nu);function tW(){let e=(0,i.useDependency)(C.TriggerCalculationController),t=(0,i.useDependency)(i.ICommandService),n=(0,i.useObservable)(e.progress$),r=(0,I.useCallback)(()=>{t.executeCommand(l.SetFormulaCalculationStopMutation.id)},[t]),o=(0,I.useCallback)(()=>{e.clearProgress()},[e]);return /* @__PURE__ */el.jsx(R.ProgressBar,{progress:n,onTerminate:r,onClearProgress:o})}function t$(e,t){return Object.keys(e).filter(e=>isNaN(Number(e))&&"DefinedName"!==e).map(n=>({label:t.t(`formula.functionType.${n.toLocaleLowerCase()}`),value:`${e[n]}`}))}function tV(e){return e.require||e.repeat?e.require&&!e.repeat?e.name:!e.require&&e.repeat?`[${e.name},...]`:e.require&&e.repeat?`${e.name},...`:void 0:`[${e.name}]`}tB=tL([tU(0,(0,i.Inject)(_.SheetInterceptorService)),tU(1,(0,i.Inject)(l.FormulaDataModel))],tB),M(tW,"FormulaProgressBar"),M(t$,"getFunctionTypeValues"),M(tV,"generateParam");let tH=/* @__PURE__ */M((e,t=100)=>{(0,I.useEffect)(()=>{let n=null,r=/* @__PURE__ */M(()=>{null===n&&(n=window.setTimeout(()=>{e(),n=null},t))},"throttledCallback");return window.addEventListener("scroll",r),window.addEventListener("resize",r),()=>{null!==n&&clearTimeout(n),window.removeEventListener("scroll",r),window.removeEventListener("resize",r)}},[e,t])},"useResizeScrollObserver"),tq={formulaHelpFunction:"univer-formula-help-function",formulaHelpFunctionTitle:"univer-formula-help-function-title",formulaHelpFunctionTitleIcons:"univer-formula-help-function-title-icons",formulaHelpFunctionTitleIcon:"univer-formula-help-function-title-icon",formulaHelpFunctionContent:"univer-formula-help-function-content",formulaHelpFunctionContentInner:"univer-formula-help-function-content-inner",formulaHelpFunctionContentParams:"univer-formula-help-function-content-params",formulaHelpFunctionContentParamsTitle:"univer-formula-help-function-content-params-title",formulaHelpFunctionContentParamsDetail:"univer-formula-help-function-content-params-detail",formulaHelpFunctionActive:"univer-formula-help-function-active",formulaHelpDecorator:"univer-formula-help-decorator",formulaHelpParam:"univer-formula-help-param",formulaHelpParamPrefix:"univer-formula-help-param-prefix",formulaHelpParamItem:"univer-formula-help-param-item",formulaHelpParamActive:"univer-formula-help-param-active"};function tK(){let[e,t]=(0,I.useState)(!1),[n,r]=(0,I.useState)(!0),[o,l]=(0,I.useState)(!0),[s,a]=(0,I.useState)(0),[u,c]=(0,I.useState)([0,0]),[d,h]=(0,I.useState)({left:0,top:0}),[g,m]=(0,I.useState)(null),S=(0,i.useDependency)(k),f=(0,i.useDependency)(i.LocaleService),_=f.t("formula.prompt.required"),C=f.t("formula.prompt.optional"),E=(0,i.useDependency)(i.IUniverInstanceService),b=(0,i.useDependency)(v.IEditorService),T=(0,i.useDependency)(R.ISidebarService),N=(0,i.useInjector)();function x(){if(!o)return;let e=A();if(null==e)return;let{left:t,top:n,height:r}=e;c([t,n+r])}function A(){let e=E.getCurrentUniverDocInstance();if(!e)return;let t=e.getUnitId();if(!b.isEditor(t))return;let n=b.getEditor(t);return null==n?void 0:n.getBoundingClientRect()}function O(e){a(e)}function F(){l(!o),N.get(R.ILayoutService).focus()}return tH(x),(0,I.useEffect)(()=>{let e=S.help$.subscribe(e=>{let{visible:n,paramIndex:r,functionInfo:i}=e;if(!n){t(n);return}let o=A();if(null==o)return;let{left:l,top:s,height:u}=o;""===i.description&&0===i.functionParameter.length||(c([l,s+u]),a(r),m(i),h({left:l,top:s}),t(n))}),n=T.scrollEvent$.pipe((0,p.throttleTime)(100)).subscribe(x);return()=>{null==e||e.unsubscribe(),n.unsubscribe()}},[]),M(x,"updatePosition"),M(A,"getPosition"),M(O,"handleSwitchActive"),M(F,"handleClose"),/* @__PURE__ */el.jsx(el.Fragment,{children:o?/* @__PURE__ */el.jsx(y.Popup,{visible:e,offset:u,children:g?/* @__PURE__ */el.jsxs("div",{className:tq.formulaHelpFunction,children:[/* @__PURE__ */el.jsxs("div",{className:tq.formulaHelpFunctionTitle,children:[/* @__PURE__ */el.jsx(tG,{prefix:g.functionName,value:g.functionParameter,active:s,onClick:O}),/* @__PURE__ */el.jsxs("div",{className:tq.formulaHelpFunctionTitleIcons,children:[/* @__PURE__ */el.jsx("div",{className:tq.formulaHelpFunctionTitleIcon,style:{transform:n?"rotateZ(-90deg)":"rotateZ(90deg)"},onClick:/* @__PURE__ */M(()=>r(!n),"onClick"),children:/* @__PURE__ */el.jsx(eb,{})}),/* @__PURE__ */el.jsx("div",{className:tq.formulaHelpFunctionTitleIcon,onClick:F,children:/* @__PURE__ */el.jsx(ep,{})})]})]}),/* @__PURE__ */el.jsx("div",{className:tq.formulaHelpFunctionContent,style:{height:n?"unset":0,padding:n?"revert-layer":0},children:/* @__PURE__ */el.jsxs("div",{className:tq.formulaHelpFunctionContentInner,children:[/* @__PURE__ */el.jsx(tz,{title:f.t("formula.prompt.helpExample"),value:`${g.functionName}(${g.functionParameter.map(e=>e.example).join(",")})`}),/* @__PURE__ */el.jsx(tz,{title:f.t("formula.prompt.helpAbstract"),value:g.description}),g&&g.functionParameter&&g.functionParameter.map((e,t)=>/* @__PURE__ */el.jsx(tz,{className:s===t?tq.formulaHelpFunctionActive:"",title:e.name,value:`${e.require?_:C} ${e.detail}`},t))]})})]}):/* @__PURE__ */el.jsx(el.Fragment,{})}):e?/* @__PURE__ */el.jsx("div",{className:tq.formulaHelpDecorator,onClick:/* @__PURE__ */M(()=>l(!o),"onClick"),style:{left:d.left-24,top:d.top},children:/* @__PURE__ */el.jsx(eR,{})}):/* @__PURE__ */el.jsx(el.Fragment,{})})}M(tK,"HelpFunction");let tz=/* @__PURE__ */M(e=>/* @__PURE__ */el.jsxs("div",{className:tq.formulaHelpFunctionContentParams,children:[/* @__PURE__ */el.jsx("div",{className:`${tq.formulaHelpFunctionContentParamsTitle} ${e.className}`,children:e.title}),/* @__PURE__ */el.jsx("div",{className:tq.formulaHelpFunctionContentParamsDetail,children:e.value})]}),"Params"),tG=/* @__PURE__ */M(e=>{let{prefix:t,value:n,active:r,onClick:i}=e;return /* @__PURE__ */el.jsxs("div",{className:tq.formulaHelpParam,children:[/* @__PURE__ */el.jsxs("span",{className:tq.formulaHelpParamPrefix,children:[t,"("]}),n&&n.map((e,t)=>/* @__PURE__ */el.jsxs("span",{className:tq.formulaHelpParamItem,children:[/* @__PURE__ */el.jsx("span",{className:r===t?tq.formulaHelpFunctionActive:tq.formulaHelpParamActive,onClick:/* @__PURE__ */M(()=>i(t),"onClick"),children:tV(e)}),t===n.length-1?"":","]},t)),")"]})},"Help"),tY={formulaSearchFunction:"univer-formula-search-function",formulaSearchFunctionItem:"univer-formula-search-function-item",formulaSearchFunctionItemName:"univer-formula-search-function-item-name",formulaSearchFunctionItemNameLight:"univer-formula-search-function-item-name-light",formulaSearchFunctionItemDesc:"univer-formula-search-function-item-desc",formulaSearchFunctionItemActive:"univer-formula-search-function-item-active"};function tZ(){let[e,t]=(0,I.useState)(!1),[n,r]=(0,I.useState)(0),[o,l]=(0,I.useState)([0,0]),[s,a]=(0,I.useState)([]),[u,c]=(0,I.useState)(""),d=(0,I.useRef)(null),h=(0,i.useDependency)(k),g=(0,i.useDependency)(i.IUniverInstanceService),m=(0,i.useDependency)(v.IEditorService);function S(){let e=g.getCurrentUniverDocInstance().getUnitId();if(!m.isEditor(e))return;let t=m.getEditor(e);return null==t?void 0:t.getBoundingClientRect()}function f(e){r(e)}function p(){r(-1)}function _(e){var t;let n=null==(t=d.current)?void 0:t.querySelectorAll(`.${tY.formulaSearchFunctionItem}`)[e];if(!n)return;let r=n.parentNode;if(!r)return;let i=r.getBoundingClientRect().top,o=r.offsetHeight,l=n.getBoundingClientRect(),s=l.top,a=l.height;if(s>=0&&s>i&&s-i+a<=o)return;let u=n.offsetTop-(o-a)/2;r.scrollTo({top:u,behavior:"smooth"})}return(0,I.useEffect)(()=>{let e=[],n=0,o=h.search$.subscribe(i=>{let{visible:o,searchText:s,searchList:u}=i;if(!o){t(o);return}let d=S();if(null==d)return;let{left:h,top:g,height:m}=d;c(s),a(u),e=u,l([h,g+m]),t(o),r(0),n=0}),s=h.navigate$.subscribe(t=>{let{direction:o}=t;if(o===i.Direction.UP){let t=n-1;r(t=t<0?e.length-1:t),n=t}else if(o===i.Direction.DOWN){let t=n+1;r(t=t>=e.length?0:t),n=t}_(n)}),u=h.accept$.subscribe(t=>{let r=e[n].name;h.acceptFormulaName(r)});return()=>{null==o||o.unsubscribe(),null==s||s.unsubscribe(),null==u||u.unsubscribe()}},[]),M(S,"getPosition"),M(f,"handleLiMouseEnter"),M(p,"handleLiMouseLeave"),M(_,"scrollToVisible"),s.length>0&&/* @__PURE__ */el.jsx(y.Popup,{visible:e,offset:o,children:/* @__PURE__ */el.jsx("ul",{className:tY.formulaSearchFunction,ref:d,children:s.map((e,t)=>/* @__PURE__ */el.jsxs("li",{className:n===t?`${tY.formulaSearchFunctionItem} ${tY.formulaSearchFunctionItemActive}`:tY.formulaSearchFunctionItem,onMouseEnter:/* @__PURE__ */M(()=>f(t),"onMouseEnter"),onMouseLeave:p,onClick:/* @__PURE__ */M(()=>h.acceptFormulaName(e.name),"onClick"),children:[/* @__PURE__ */el.jsxs("span",{className:tY.formulaSearchFunctionItemName,children:[/* @__PURE__ */el.jsx("span",{className:tY.formulaSearchFunctionItemNameLight,children:e.name.substring(0,u.length)}),/* @__PURE__ */el.jsx("span",{children:e.name.slice(u.length)})]}),/* @__PURE__ */el.jsx("span",{className:tY.formulaSearchFunctionItemDesc,children:e.desc})]},t))})})}function tX(){return /* @__PURE__ */el.jsxs(el.Fragment,{children:[/* @__PURE__ */el.jsx(tZ,{}),/* @__PURE__ */el.jsx(tK,{})]})}function tQ(e){let{prefix:t,value:n}=e;return /* @__PURE__ */el.jsxs("div",{children:[/* @__PURE__ */el.jsxs("span",{children:[t,"("]}),n&&n.map((e,t)=>/* @__PURE__ */el.jsxs("span",{children:[/* @__PURE__ */el.jsx("span",{children:tV(e)}),t===n.length-1?"":","]},t)),")"]})}function tJ(e){let{className:t,value:n,title:r}=e;return /* @__PURE__ */el.jsxs("div",{className:"univer-formula-function-params",children:[/* @__PURE__ */el.jsx("div",{className:`univer-formula-function-params-title ${t}`,children:r}),/* @__PURE__ */el.jsx("div",{className:"univer-formula-function-params-detail",children:n})]})}M(tZ,"SearchFunction"),M(tX,"RenderFormulaPromptContent"),M(tQ,"FunctionHelp"),M(tJ,"FunctionParams");let t0={formulaInputParamsList:"univer-formula-input-params-list",formulaInputParamsListItemName:"univer-formula-input-params-list-item-name",formulaInputParamsListItemSelector:"univer-formula-input-params-list-item-selector"};function t1(e){let{functionInfo:t,onChange:n}=e;if(!t)return null;(0,I.useState)([]);let[r,i]=(0,I.useState)(t.functionParameter),[o,l]=(0,I.useState)(-1);return /* @__PURE__ */el.jsxs("div",{className:t0.formulaInputParams,children:[/* @__PURE__ */el.jsx("div",{className:t0.formulaInputParamsList,children:r.map((e,t)=>/* @__PURE__ */el.jsxs("div",{children:[/* @__PURE__ */el.jsx("div",{className:t0.formulaInputParamsListItemName,children:e.name}),/* @__PURE__ */el.jsx("div",{className:t0.formulaInputParamsListItemSelector})]},t))}),/* @__PURE__ */el.jsx("div",{className:t0.formulaInputParamsInfo,children:/* @__PURE__ */el.jsx(tJ,{title:-1===o?/* @__PURE__ */el.jsx(tQ,{prefix:t.functionName,value:r}):r[o].name,value:-1===o?t.description:r[o].detail})})]})}M(t1,"InputParams");let t9={formulaSelectFunctionSelect:"univer-formula-select-function-select",formulaSelectFunctionResult:"univer-formula-select-function-result",formulaSelectFunctionResultItem:"univer-formula-select-function-result-item",formulaSelectFunctionResultItemNameLight:"univer-formula-select-function-result-item-name-light",formulaSelectFunctionResultItemSelected:"univer-formula-select-function-result-item-selected",formulaSelectFunctionResultItemActive:"univer-formula-select-function-result-item-active",formulaSelectFunctionContent:"univer-formula-select-function-content"};function t3(e){let{onChange:t}=e,[n,r]=(0,I.useState)(""),[o,s]=(0,I.useState)([]),[a,u]=(0,I.useState)(0),[c,d]=(0,I.useState)("-1"),[h,g]=(0,I.useState)(0),[m,S]=(0,I.useState)(null),f=(0,i.useDependency)(C.IDescriptionService),p=(0,i.useDependency)(i.LocaleService),v=(0,i.useDependency)(R.ISidebarService),_=(0,i.useObservable)(v.sidebarOptions$),E=t$(l.FunctionType,p);E.unshift({label:p.t("formula.moreFunctions.allFunctions"),value:"-1"});let b=p.t("formula.prompt.required"),T=p.t("formula.prompt.optional");(0,I.useEffect)(()=>{A("-1")},[]),(0,I.useEffect)(()=>{x(0)},[o]),(0,I.useEffect)(()=>{null!=_&&_.visible&&(r(""),s([]),u(0),d("-1"),g(0),S(null),A("-1"))},[_]);let N=/* @__PURE__ */M(e=>{if(""===n.trim())return e;let t=RegExp(`(${n.toLocaleUpperCase()})`);return e.split(t).filter(Boolean).map((e,n)=>e.match(t)?/* @__PURE__ */el.jsx("span",{className:t9.formulaSelectFunctionResultItemNameLight,children:e},n):e)},"highlightSearchText"),x=/* @__PURE__ */M(e=>{if(0===o.length){S(null);return}g(e);let n=f.getFunctionInfo(o[e].name);if(!n){S(null);return}S(n),t(n)},"setCurrentFunctionInfo");function A(e){d(e),s(f.getSearchListByType(+e))}function O(e){r(e),s(f.getSearchListByName(e))}function F(e){if(e.stopPropagation(),"ArrowDown"===e.key){let e=a+1;u(e===o.length?0:e)}else if("ArrowUp"===e.key){let e=a-1;u(-1===e?o.length-1:e)}else"Enter"===e.key&&x(a)}M(A,"handleSelectChange"),M(O,"handleSearchInputChange"),M(F,"handleSelectListKeyDown");let w=/* @__PURE__ */M(e=>{u(e)},"handleLiMouseEnter"),P=/* @__PURE__ */M(()=>{u(-1)},"handleLiMouseLeave");return /* @__PURE__ */el.jsxs("div",{children:[/* @__PURE__ */el.jsxs("div",{className:t9.formulaSelectFunctionSelect,children:[/* @__PURE__ */el.jsx(y.Select,{value:c,options:E,onChange:A}),/* @__PURE__ */el.jsx(y.Input,{placeholder:p.t("formula.moreFunctions.searchFunctionPlaceholder"),onKeyDown:F,value:n,onChange:O,size:"large",allowClear:!0})]}),/* @__PURE__ */el.jsx("ul",{className:t9.formulaSelectFunctionResult,onKeyDown:F,tabIndex:-1,children:o.map(({name:e},t)=>/* @__PURE__ */el.jsxs("li",{className:a===t?`${t9.formulaSelectFunctionResultItem} ${t9.formulaSelectFunctionResultItemActive}`:t9.formulaSelectFunctionResultItem,onMouseEnter:/* @__PURE__ */M(()=>w(t),"onMouseEnter"),onMouseLeave:P,onClick:/* @__PURE__ */M(()=>x(t),"onClick"),children:[h===t&&/* @__PURE__ */el.jsx(eS,{className:t9.formulaSelectFunctionResultItemSelected}),/* @__PURE__ */el.jsx("span",{className:t9.formulaSelectFunctionResultItemName,children:N(e)})]},t))}),m&&/* @__PURE__ */el.jsxs("div",{className:t9.formulaSelectFunctionContent,children:[/* @__PURE__ */el.jsx(tJ,{title:m.functionName,value:m.description}),/* @__PURE__ */el.jsx(tJ,{title:p.t("formula.moreFunctions.syntax"),value:/* @__PURE__ */el.jsx(tQ,{prefix:m.functionName,value:m.functionParameter})}),/* @__PURE__ */el.jsx(tJ,{title:p.t("formula.prompt.helpExample"),value:`${m.functionName}(${m.functionParameter.map(e=>e.example).join(",")})`}),m.functionParameter&&m.functionParameter.map((e,t)=>/* @__PURE__ */el.jsx(tJ,{title:e.name,value:`${e.require?b:T} ${e.detail}`},t))]})]})}function t6(){let e=(0,o.useActiveWorkbook)(),[t,n]=(0,I.useState)(!0),[r,l]=(0,I.useState)(!1),[s,a]=(0,I.useState)(null),u=(0,i.useDependency)(i.LocaleService),c=(0,i.useDependency)(v.IEditorService);function d(){n(!t),l(!r)}function h(){c.setFormula(`=${null==s?void 0:s.functionName}(`)}return M(d,"handleClickNextPrev"),M(h,"handleConfirm"),/* @__PURE__ */el.jsxs("div",{className:"univer-formula-more-functions",children:[t&&/* @__PURE__ */el.jsx(t3,{onChange:a}),r&&/* @__PURE__ */el.jsx(t1,{functionInfo:s,onChange:/* @__PURE__ */M(()=>{},"onChange")}),/* @__PURE__ */el.jsxs("div",{className:"univer-formula-more-functions-operation",children:[r&&/* @__PURE__ */el.jsx(y.Button,{type:"primary",size:"small",onClick:d,children:u.t("formula.moreFunctions.next")}),r&&/* @__PURE__ */el.jsx(y.Button,{size:"small",onClick:d,children:u.t("formula.moreFunctions.prev")}),t&&!!e&&/* @__PURE__ */el.jsx(y.Button,{type:"primary",size:"small",onClick:h,children:u.t("formula.moreFunctions.confirm")})]})]})}function t2(e){return{id:j.id,icon:"FunctionSingle",tooltip:"formula.insert.tooltip",type:R.MenuItemType.SELECTOR,selections:[{label:"SUM",value:"SUM",icon:"SumSingle"},{label:"AVERAGE",value:"AVERAGE",icon:"AvgSingle"},{label:"COUNT",value:"COUNT",icon:"CntSingle"},{label:"MAX",value:"MAX",icon:"MaxSingle"},{label:"MIN",value:"MIN",icon:"MinSingle"}],hidden$:(0,R.getMenuHiddenObservable)(e,i.UniverInstanceType.UNIVER_SHEET),disabled$:(0,o.getCurrentRangeDisable$)(e,{workbookTypes:[_.WorkbookEditablePermission],worksheetTypes:[_.WorksheetEditPermission,_.WorksheetSetCellValuePermission],rangeTypes:[_.RangeProtectionPermissionEditPoint]})}}function t4(e){return{id:G.id,title:"formula.insert.more",type:R.MenuItemType.BUTTON}}function t5(e){return e.get(i.IUniverInstanceService).getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_SHEET).pipe((0,f.switchMap)(t=>t&&e.get(R.IClipboardInterfaceService)?new g.Observable(t=>t.next(!e.get(R.IClipboardInterfaceService).supportClipboard)):(0,m.of)(!0)))}function t8(e){return{id:A.id,type:R.MenuItemType.BUTTON,title:"formula.operation.pasteFormula",disabled$:t5(e).pipe((0,s.combineLatestWith)((0,o.getCurrentRangeDisable$)(e,{workbookTypes:[_.WorkbookEditablePermission],rangeTypes:[_.RangeProtectionPermissionEditPoint],worksheetTypes:[_.WorksheetSetCellValuePermission,_.WorksheetEditPermission]})),(0,d.map)(([e,t])=>e||t))}}M(t3,"SelectFunction"),M(t6,"MoreFunctions"),M(t2,"InsertFunctionMenuItemFactory"),M(t4,"MoreFunctionsMenuItemFactory"),M(t5,"menuClipboardDisabledObservable"),M(t8,"PasteFormulaMenuItemFactory");let t7={[R.RibbonStartGroup.FORMULAS_INSERT]:{[j.id]:{order:1,menuItemFactory:t2,[G.id]:{order:1,menuItemFactory:t4}}},[o.PASTE_SPECIAL_MENU_ID]:{[A.id]:{order:4,menuItemFactory:t8}}},ne="meta_key_ctrl_And_Shift",nt=[R.KeyCode.ARROW_DOWN,R.KeyCode.ARROW_UP,R.KeyCode.ARROW_LEFT,R.KeyCode.ARROW_RIGHT],nn=[...nt,R.KeyCode.ENTER,R.KeyCode.TAB,R.KeyCode.ESC];function nr(){let e=[];for(let t of nn)e.push({id:O.id,binding:t,preconditions:/* @__PURE__ */M(e=>(0,o.whenFormulaEditorActivated)(e),"preconditions"),staticParameters:{eventType:E.DeviceInputEventType.Keyboard,keycode:t}});return e}function ni(){let e=[];for(let t of nt)e.push({id:O.id,binding:t|R.MetaKeys.SHIFT,preconditions:/* @__PURE__ */M(e=>(0,o.whenFormulaEditorActivated)(e),"preconditions"),staticParameters:{eventType:E.DeviceInputEventType.Keyboard,keycode:t,metaKey:R.MetaKeys.SHIFT}});return e}function no(){let e=[];for(let t of nt)e.push({id:O.id,binding:t|R.MetaKeys.CTRL_COMMAND,preconditions:/* @__PURE__ */M(e=>(0,o.whenFormulaEditorActivated)(e),"preconditions"),staticParameters:{eventType:E.DeviceInputEventType.Keyboard,keycode:t,metaKey:R.MetaKeys.CTRL_COMMAND}});return e}function nl(){let e=[];for(let t of nt)e.push({id:O.id,binding:t|R.MetaKeys.SHIFT|R.MetaKeys.CTRL_COMMAND,preconditions:/* @__PURE__ */M(e=>(0,o.whenFormulaEditorActivated)(e),"preconditions"),staticParameters:{eventType:E.DeviceInputEventType.Keyboard,keycode:t,metaKey:ne}});return e}M(nr,"promptSelectionShortcutItem"),M(ni,"promptSelectionShortcutItemShift"),M(no,"promptSelectionShortcutItemCtrl"),M(nl,"promptSelectionShortcutItemCtrlAndShift");let ns={id:Y.id,binding:R.KeyCode.F4,preconditions:/* @__PURE__ */M(e=>(0,o.whenFormulaEditorActivated)(e),"preconditions")};function na(){let e=[];for(let t of[R.KeyCode.ENTER,R.KeyCode.TAB,R.KeyCode.ARROW_DOWN,R.KeyCode.ARROW_UP])e.push({id:O.id,binding:t,preconditions:/* @__PURE__ */M(e=>e8(e),"preconditions"),staticParameters:{eventType:E.DeviceInputEventType.Keyboard,keycode:t,isSingleEditor:!0}});return e}M(na,"singleEditorPromptSelectionShortcutItem");var nu,nc,nd=Object.defineProperty,nh=Object.getOwnPropertyDescriptor,ng=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?nh(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&nd(t,n,o),o},"__decorateClass$2"),nm=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$2");let nS=(M(nc=class extends i.Disposable{constructor(e,t,n,r,i,o,l){super(),this._injector=e,this._menuManagerService=t,this._commandService=n,this._shortcutService=r,this._uiPartsService=i,this._renderManagerService=o,this._componentManager=l,this._initialize()}_initialize(){this._registerCommands(),this._registerMenus(),this._registerShortcuts(),this._registerComponents(),this._registerRenderModules()}_registerMenus(){this._menuManagerService.mergeMenu(t7)}_registerCommands(){[A,j,G,Z,U,O,Y].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e)))}_registerShortcuts(){[...nr(),...ni(),...no(),...nl(),...na(),ns].forEach(e=>{this.disposeWithMe(this._shortcutService.registerShortcut(e))})}_registerComponents(){this.disposeWithMe(this._uiPartsService.registerComponent(R.BuiltInUIPart.CONTENT,()=>(0,i.connectInjector)(tX,this._injector))),this.disposeWithMe(this._uiPartsService.registerComponent(o.SheetsUIPart.FORMULA_AUX,()=>(0,i.connectInjector)(tW,this._injector))),this._componentManager.register(z,t6)}_registerRenderModules(){this.disposeWithMe(this._renderManagerService.registerRenderModule(i.UniverInstanceType.UNIVER_SHEET,[tP]))}},"FormulaUIController"),nc);function nf(e,t,n){let r=e.getCurrentTheme(),o=new(0,i.ColorKit)(t).setAlpha(.05).toRgbString();return{id:n,strokeWidth:1,stroke:t,fill:o,widgets:{tl:!0,tc:!0,tr:!0,ml:!0,mr:!0,bl:!0,bc:!0,br:!0},widgetSize:6,widgetStrokeWidth:1,widgetStroke:r.colorWhite,hasAutoFill:!1,hasRowHeader:!1,hasColumnHeader:!1}}nS=ng([nm(0,(0,i.Inject)(i.Injector)),nm(1,R.IMenuManagerService),nm(2,i.ICommandService),nm(3,R.IShortcutService),nm(4,R.IUIPartsService),nm(5,E.IRenderManagerService),nm(6,(0,i.Inject)(R.ComponentManager))],nS),M(nf,"getFormulaRefSelectionStyle");var np=Object.defineProperty,nv=Object.getOwnPropertyDescriptor,n_=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?nv(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&np(t,n,o),o},"__decorateClass$1"),nC=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$1");let nR=[i.DOCS_FORMULA_BAR_EDITOR_UNIT_ID_KEY,i.DOCS_NORMAL_EDITOR_UNIT_ID_KEY],nI=(M(ny=class extends i.Disposable{constructor(e,t,n,r,i,o,l,s,a,u,c,d,h,g,m){super(),x(this,"_listenInputCache",/* @__PURE__ */new Set),x(this,"_formulaRefColors",[]),x(this,"_previousSequenceNodes"),x(this,"_previousRangesCount",0),x(this,"_previousInsertRefStringIndex"),x(this,"_currentInsertRefStringIndex",-1),x(this,"_arrowMoveActionState",0),x(this,"_isSelectionMovingRefSelections",[]),x(this,"_stringColor",""),x(this,"_numberColor",""),x(this,"_insertSelections",[]),x(this,"_inputPanelState",0),x(this,"_userCursorMove",!1),x(this,"_previousEditorUnitId"),x(this,"_existsSequenceNode",!1),x(this,"_currentlyWorkingRefRenderer",null),x(this,"_selectionsChangeDisposables"),x(this,"_isSelectingMode",!1),this._commandService=e,this._contextService=t,this._editorBridgeService=n,this._formulaPromptService=r,this._lexerTreeBuilder=i,this._renderManagerService=o,this._themeService=l,this._sheetsSelectionsService=s,this._refSelectionsService=a,this._univerInstanceService=u,this._descriptionService=c,this._docSelectionManagerService=d,this._contextMenuService=h,this._editorService=g,this._layoutService=m,this._initialize()}get _selectionRenderService(){return this._renderManagerService.getRenderById(this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET).getUnitId()).with(ek)}get _allSelectionRenderServices(){return this._renderManagerService.getAllRenderersOfType(i.UniverInstanceType.UNIVER_SHEET).map(e=>e.with(ek))}dispose(){this._formulaRefColors=[],this._resetTemp()}_resetTemp(){this._previousSequenceNodes=null,this._previousInsertRefStringIndex=null,this._isSelectionMovingRefSelections=[],this._previousRangesCount=0,this._currentInsertRefStringIndex=-1}_initialize(){this._initialCursorSync(),this._initAcceptFormula(),this._initialFormulaTheme(),this._initSelectionsEndListener(),this._closeRangePromptWhenEditorInvisible(),this._initialEditorInputChange(),this._commandExecutedListener(),this._cursorStateListener(),this._inputFormulaListener(),this._userMouseListener(),this._initialChangeEditor()}_initialFormulaTheme(){let e=this._themeService.getCurrentTheme();this._formulaRefColors=[e.loopColor1,e.loopColor2,e.loopColor3,e.loopColor4,e.loopColor5,e.loopColor6,e.loopColor7,e.loopColor8,e.loopColor9,e.loopColor10,e.loopColor11,e.loopColor12],this._numberColor=e.hyacinth700,this._stringColor=e.verdancy800}_initialCursorSync(){this.disposeWithMe(this._docSelectionManagerService.textSelection$.pipe((0,c.filter)(e=>!(0,o.isRangeSelector)(e.unitId))).subscribe(e=>{var t;if((null==e?void 0:e.unitId)==null)return;let n=this._editorService.getEditor(e.unitId);if(!n||n.onlyInputContent()||n.isSheetEditor()&&!this._isFormulaEditorActivated()||n.params.scrollBar)return;let r=n.onlyInputRange();(null==(t=null==e?void 0:e.options)||!t.fromSelection)&&(this._quitSelectingMode(),this._contextSwitch(),this._checkShouldEnterSelectingMode(r),this._formulaPromptService.isLockedSelectionChange()||(this._highlightFormula(),r||this._changeFunctionPanelState()))}))}_initialEditorInputChange(){let e=[R.KeyCode.ARROW_DOWN,R.KeyCode.ARROW_UP,R.KeyCode.ARROW_LEFT,R.KeyCode.ARROW_RIGHT,R.KeyCode.CTRL,R.KeyCode.SHIFT];this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_DOC).subscribe(t=>{var n;let r=null==t?void 0:t.getUnitId();if(null==r||(0,o.isRangeSelector)(r)||this._listenInputCache.has(r)||null==this._editorService.getEditor(r))return;let i=null==(n=this._renderManagerService.getRenderById(r))?void 0:n.with(v.DocSelectionRenderService);i&&this.disposeWithMe(i.onInputBefore$.subscribe(t=>{this._previousSequenceNodes=null,this._previousInsertRefStringIndex=null,this._selectionRenderService.setSkipLastEnabled(!0);let n=null==t?void 0:t.event;n&&(e.includes(n.which)?this._inputPanelState=2:(1!==this._arrowMoveActionState&&(this._arrowMoveActionState=2),this._inputPanelState=1),n.which!==R.KeyCode.F4&&(this._userCursorMove=!1))})),this._listenInputCache.add(r)})}_closeRangePromptWhenEditorInvisible(){this.disposeWithMe(this._editorBridgeService.afterVisible$.pipe((0,u.distinctUntilKeyChanged)("visible")).subscribe(e=>{e.visible||this._closeRangePrompt()})),this.disposeWithMe(this._contextService.subscribeContextValue$(i.FORMULA_EDITOR_ACTIVATED).pipe((0,a.distinctUntilChanged)()).subscribe(e=>{e||this._closeRangePrompt()}))}_initialChangeEditor(){this.disposeWithMe(this._univerInstanceService.getCurrentTypeOfUnit$(i.UniverInstanceType.UNIVER_DOC).subscribe(e=>{if(null==e)return;let t=e.getUnitId();(0,o.isRangeSelector)(t)||!this._editorService.isEditor(t)||this._previousEditorUnitId===t||this._editorService.isSheetEditor(t)||(this._closeRangePrompt(t),this._previousEditorUnitId=t)})),this.disposeWithMe(this._editorService.closeRangePrompt$.subscribe(()=>{this._editorService.getSpreadsheetFocusState()&&this._formulaPromptService.isLockedSelectionInsert()||this._closeRangePrompt()}))}_closeRangePrompt(e){this._insertSelections=[],this._refSelectionsService.clear(),e&&this._editorService.isSheetEditor(e)&&this._updateEditorModel(`\r
`,[]),this._contextService.setContextValue(i.FOCUSING_EDITOR_INPUT_FORMULA,!1),this._contextService.setContextValue(_.DISABLE_NORMAL_SELECTIONS,!1),this._contextService.setContextValue(R.UNI_DISABLE_CHANGING_FOCUS_KEY,!1),this._quitSelectingMode(),this._resetTemp(),this._hideFunctionPanel()}_initSelectionsEndListener(){let e=new i.DisposableCollection;this.disposeWithMe(this._refSelectionsService.selectionMoveEnd$.subscribe(t=>{e.dispose(),0!==t.length&&this._allSelectionRenderServices.map(e=>e.getSelectionControls()).flat().forEach(t=>{t.disableHelperSelection(),e.add(t.selectionMoving$.subscribe(e=>this._onSelectionControlChange(e,t))),e.add(t.selectionScaling$.subscribe(e=>this._onSelectionControlChange(e,t))),e.add(t.selectionMoved$.subscribe(()=>this._formulaPromptService.disableLockedSelectionChange())),e.add(t.selectionScaled$.subscribe(()=>this._formulaPromptService.disableLockedSelectionChange()))})}))}_updateSelecting(e,t=!1){if(0!==e.length&&!(this._editorService.selectionChangingState()&&!this._formulaPromptService.isLockedSelectionInsert())&&(this._insertControlSelections(e),t)){let t=e[e.length-1];this._insertControlSelectionReplace(t)}}_enableRefSelectionsRenderService(){let e=this._selectionsChangeDisposables=new i.DisposableCollection;this._allSelectionRenderServices.forEach(t=>{e.add(t.enableSelectionChanging()),e.add(t.selectionMoving$.subscribe(e=>{this._updateSelecting(e.map(e=>(0,_.convertSelectionDataToRange)(e)))})),e.add(t.selectionMoveStart$.subscribe(e=>{let n=this._checkClearingLastSelection(t);this._currentlyWorkingRefRenderer=t,this._updateSelecting(e.map(e=>(0,_.convertSelectionDataToRange)(e)),n)}))})}_checkClearingLastSelection(e){return!this._currentlyWorkingRefRenderer||this._currentlyWorkingRefRenderer===e||(this._currentlyWorkingRefRenderer.clearLastSelection(),!1)}_disposeSelectionsChangeListeners(){var e;null==(e=this._selectionsChangeDisposables)||e.dispose(),this._selectionsChangeDisposables=null}_insertControlSelections(e){let t=e[e.length-1];if(this._resetSequenceNodes(e.length),(e.length===this._previousRangesCount||0===this._previousRangesCount)&&null!=this._previousSequenceNodes)this._insertControlSelectionReplace(t);else{let n=this._formulaPromptService.getSequenceNodes(),r=this._getCurrentChar();0===n.length&&this._currentInsertRefStringIndex>0&&(this._currentInsertRefStringIndex=-1),this._previousInsertRefStringIndex=this._currentInsertRefStringIndex,!(0,l.matchRefDrawToken)(r)&&this._focusIsOnlyRange(e.length)&&(this._formulaPromptService.insertSequenceString(this._currentInsertRefStringIndex,l.matchToken.COMMA),n=this._formulaPromptService.getSequenceNodes(),this._previousInsertRefStringIndex+=1),this._previousSequenceNodes=(0,i.Tools).deepClone(n),this._formulaPromptService.setSequenceNodes(n);let o=this._generateRefString(t);this._formulaPromptService.insertSequenceRef(this._previousInsertRefStringIndex,o),this._selectionRenderService.setSkipLastEnabled(!1)}this._arrowMoveActionState=2,this._previousRangesCount=e.length}_initAcceptFormula(){this.disposeWithMe(this._formulaPromptService.acceptFormulaName$.subscribe(e=>{let t=this._docSelectionManagerService.getActiveTextRange();if(null==t){this._hideFunctionPanel();return}let{startOffset:n}=t,r=this._formulaPromptService.getSequenceNodes(),i=this._formulaPromptService.getCurrentSequenceNodeIndex(n-2),o=r[i];if(null==o||"string"==typeof o){this._hideFunctionPanel();return}let s=e.length-o.token.length,a={...o};a.token=e,a.endIndex+=s,r[i]=a;let u=this._descriptionService.hasDefinedNameDescription(e),c=this._descriptionService.isFormulaDefinedName(e),d=e.length+1,h=!u||c;h&&r.splice(i+1,0,l.matchToken.OPEN_BRACKET);for(let e=i+2,t=r.length;e<t;e++){let t=r[e];if("string"==typeof t)continue;let n={...t};n.startIndex+=d,n.endIndex+=d,r[e]=n}let g=a.endIndex+1;h&&(g+=1),this._syncToEditor(r,g,void 0,!0,!1)}))}_changeFunctionPanelState(){let e=this._docSelectionManagerService.getActiveTextRange();if(null==e){this._hideFunctionPanel();return}let{startOffset:t}=e,n=this._formulaPromptService.getCurrentSequenceNode(t-2);if(null==n){this._hideFunctionPanel();return}if("string"!=typeof n&&n.nodeType===l.sequenceNodeType.FUNCTION&&!this._descriptionService.hasDefinedNameDescription(n.token.trim())){let e=n.token.toUpperCase();if(1===this._inputPanelState){let t=this._descriptionService.getSearchListByNameFirstLetter(e);if(this._hideFunctionPanel(),null==t||0===t.length)return;this._commandService.executeCommand(Z.id,{visible:!0,searchText:e,searchList:t})}else this._changeHelpFunctionPanelState(e,-1);return}let r=this._getCurrentBodyDataStreamAndOffset(),i=this._lexerTreeBuilder.getFunctionAndParameter((null==r?void 0:r.dataStream)||"",t-1+((null==r?void 0:r.offset)||0));if(!i){this._hideFunctionPanel();return}let{functionName:o,paramIndex:s}=i;this._changeHelpFunctionPanelState(o.toUpperCase(),s)}_changeHelpFunctionPanelState(e,t){let n=this._descriptionService.getFunctionInfo(e);this._hideFunctionPanel(),null!=n&&this._commandService.executeCommand(U.id,{visible:!0,paramIndex:t,functionInfo:n})}_hideFunctionPanel(){this._commandService.executeCommand(Z.id,{visible:!1,searchText:""}),this._commandService.executeCommand(U.id,{visible:!1,paramIndex:-1})}_checkShouldEnterSelectingMode(e=!1){if(e){this._enterSelectingMode();return}let t=this._getCurrentChar(),n=this._getCurrentDataStream();(null==n?void 0:n.substring(0,1))==="="&&t&&(0,l.matchRefDrawToken)(t)?this._enterSelectingMode():this._quitSelectingMode()}_getCurrentChar(){let e=this._docSelectionManagerService.getActiveTextRange();if(null==e)return;let{startOffset:t}=e,n=this._getCurrentBodyDataStreamAndOffset();return null==n||null==t?void 0:n.dataStream[t-1+n.offset]}_getCurrentDataStream(){let e=this._getCurrentBodyDataStreamAndOffset();return null==e?void 0:e.dataStream}_enterSelectingMode(){this._isSelectingMode||(this._editorBridgeService.enableForceKeepVisible(),this._contextMenuService.disable(),this._formulaPromptService.enableLockedSelectionInsert(),this._selectionRenderService.setRemainLastEnabled(!0),this._enableRefSelectionsRenderService(),this._currentlyWorkingRefRenderer=null,1!==this._arrowMoveActionState&&(this._arrowMoveActionState=2),this._isSelectingMode=!0)}_quitSelectingMode(){this._isSelectingMode&&(this._editorBridgeService.disableForceKeepVisible(),this._contextMenuService.enable(),this._formulaPromptService.disableLockedSelectionInsert(),this._currentInsertRefStringIndex=-1,this._disposeSelectionsChangeListeners(),2===this._arrowMoveActionState&&(this._arrowMoveActionState=4),this._isSelectingMode=!1)}_getCurrentBodyDataStreamAndOffset(){var e,t;let n=this._univerInstanceService.getCurrentUniverDocInstance();if(!(null!=n&&n.getBody()))return;let r=n.getUnitId(),i=this._editorService.getEditor(r),o=null!=(t=null==(e=n.getBody())?void 0:e.dataStream)?t:"";return i&&i.onlyInputRange()?{dataStream:l.compareToken.EQUALS+o,offset:1}:{dataStream:o,offset:0}}_getFormulaAndCellEditorBody(e){return e.map(e=>{let t=this._univerInstanceService.getUniverDocInstance(e);return null==t?void 0:t.getBody()})}_editorModelUnitIds(){let e=this._univerInstanceService.getCurrentUniverDocInstance().getUnitId();return this._editorService.isEditor(e)&&!this._editorService.isSheetEditor(e)?[e]:nR}_contextSwitch(){let e=this._getCurrentBodyDataStreamAndOffset();if(e&&(0,i.isFormulaString)(e.dataStream)){this._contextService.setContextValue(i.FOCUSING_EDITOR_INPUT_FORMULA,!0),this._contextService.setContextValue(_.DISABLE_NORMAL_SELECTIONS,!0),this._contextService.setContextValue(R.UNI_DISABLE_CHANGING_FOCUS_KEY,!0);let t=this._lexerTreeBuilder.sequenceNodesBuilder(e.dataStream)||[];this._formulaPromptService.setSequenceNodes(t);let n=this._docSelectionManagerService.getActiveTextRange();if(null==n)return;let{startOffset:r}=n;this._currentInsertRefStringIndex=r-1+e.offset;return}this._contextService.setContextValue(i.FOCUSING_EDITOR_INPUT_FORMULA,!1),this._contextService.setContextValue(_.DISABLE_NORMAL_SELECTIONS,!1),this._contextService.setContextValue(R.UNI_DISABLE_CHANGING_FOCUS_KEY,!1),this._formulaPromptService.disableLockedSelectionChange(),this._formulaPromptService.disableLockedSelectionInsert(),this._formulaPromptService.clearSequenceNodes(),this._hideFunctionPanel()}_getContextState(){return this._contextService.getContextValue(i.FOCUSING_EDITOR_INPUT_FORMULA)}_highlightFormula(){if(!1===this._getContextState())return;let e=this._formulaPromptService.getSequenceNodes(),t=this._editorModelUnitIds(),n=this._getFormulaAndCellEditorBody(t).filter(e=>!!e);if(this._refSelectionsService.clear(),null==e||0===e.length)this._existsSequenceNode=!1,n.forEach(e=>e.textRuns=[]);else{this._existsSequenceNode=!0;let{textRuns:t,refSelections:r}=this._buildTextRuns(e);n.forEach(e=>e.textRuns=t),this._allSelectionRenderServices.forEach(e=>this._refreshSelectionForReference(e,r))}this._refreshFormulaAndCellEditor(t)}_buildTextRuns(e){var t;let n=[],r=[],i=/* @__PURE__ */new Map,o=0,s=(null==(t=this._getCurrentBodyDataStreamAndOffset())?void 0:t.offset)||0;for(let t=0,a=e.length;t<a;t++){let a=e[t];if("string"==typeof a||this._descriptionService.hasDefinedNameDescription(a.token.trim()))continue;let{startIndex:u,endIndex:c,nodeType:d,token:h}=a,g="";if(d===l.sequenceNodeType.REFERENCE){if(i.has(h))g=i.get(h);else{let e=o%this._formulaRefColors.length;g=this._formulaRefColors[e],i.set(h,g),o++}r.push({refIndex:t,themeColor:g,token:h})}else d===l.sequenceNodeType.NUMBER?g=this._numberColor:d===l.sequenceNodeType.STRING?g=this._stringColor:d===l.sequenceNodeType.ARRAY&&(g=this._stringColor);g&&g.length>0&&n.push({st:u+1-s,ed:c+2-s,ts:{cl:{rgb:g}}})}return{textRuns:n,refSelections:r}}_exceedCurrentRange(e,t,n){let{startRow:r,startColumn:i}=e;return r>t-1||i>n-1}_refreshSelectionForReference(e,t){let{unitId:n,sheetId:r}=this._editorBridgeService.getEditCellState(),{unitId:o,sheetId:s}=this._getCurrentUnitIdAndSheetId(),a=r===s,u=this._univerInstanceService.getUniverSheetInstance(n).getSheetBySheetId(r),c=null,d=[];for(let e=0,o=t.length;e<o;e++){let{themeColor:o,token:h,refIndex:g}=t[e],{unitId:m,sheetName:S,range:f}=(0,l.deserializeRangeWithSheet)(h),p=(0,_.setEndForRange)(f,u.getRowCount(),u.getColumnCount());if(null!=m&&m.length>0&&n!==m)continue;let v=this._getSheetIdByName(n,S.trim());if(!a&&v!==s||a&&0!==S.length&&v!==r||this._exceedCurrentRange(p,u.getRowCount(),u.getColumnCount()))continue;let C=this._getPrimary(p,o,g);if(C){c=C;continue}let R=(0,_.getPrimaryForRange)(p,u);(0,i.Rectangle).equals(R,p)||p.startRow!==p.endRow||p.startColumn!==p.endColumn||(p.startRow=R.startRow,p.endRow=R.endRow,p.startColumn=R.startColumn,p.endColumn=R.endColumn),d.push({range:p,primary:R,style:nf(this._themeService,o,g.toString())})}c&&d.push(c),d.length&&this._refSelectionsService.addSelections(n,r,d)}_getPrimary(e,t,n){var r;let i=null==(r=this._insertSelections.find(t=>{let{startRow:n,startColumn:r,endRow:i,endColumn:o}=t.range;return n===e.startRow&&r===e.startColumn&&i===e.endRow&&o===e.endColumn||n===e.startRow&&r===e.startColumn&&e.startRow===e.endRow&&e.startColumn===e.endColumn}))?void 0:r.primary;if(null==i)return;let{isMerged:o,isMergedMainCell:l,startRow:s,endRow:a,startColumn:u,endColumn:c}=i;return(o||l)&&s===e.startRow&&u===e.startColumn&&e.startRow===e.endRow&&e.startColumn===e.endColumn&&(e.endRow=a,e.endColumn=c),{range:e,primary:i,style:nf(this._themeService,t,n.toString())}}_getSheetIdByName(e,t){var n;let r=this._univerInstanceService.getUniverSheetInstance(e);return null==(n=null==r?void 0:r.getSheetBySheetName((0,l.normalizeSheetName)(t)))?void 0:n.getSheetId()}_getSheetNameById(e,t){var n;let r=this._univerInstanceService.getUniverSheetInstance(e);return(null==(n=null==r?void 0:r.getSheetBySheetId(t))?void 0:n.getName())||""}_getCurrentUnitIdAndSheetId(){var e,t;let n=this._univerInstanceService.getCurrentUnitForType(i.UniverInstanceType.UNIVER_SHEET),r=n.getActiveSheet(),l=null==(t=null==(e=this._renderManagerService.getRenderById(n.getUnitId()))?void 0:e.with(o.SheetSkeletonManagerService))?void 0:t.getCurrentSkeleton();return{unitId:n.getUnitId(),sheetId:(null==r?void 0:r.getSheetId())||"",skeleton:l}}_getEditorOpenedForSheet(){let e=this._univerInstanceService.getCurrentUniverDocInstance().getUnitId(),t=this._editorService.getEditor(e);return t?{openUnitId:t.getOpenForSheetUnitId(),openSheetId:t.getOpenForSheetSubUnitId()}:{openUnitId:null,openSheetId:null}}_generateRefString(e){let t="",n="",{unitId:r,sheetId:i}=e.range,{openUnitId:o,openSheetId:s}=this._getEditorOpenedForSheet();r!==o&&r&&(t=r),i!==s&&r&&i&&(n=this._getSheetNameById(r,i));let{range:a,primary:u}=e,{startRow:c,endRow:d,startColumn:h,endColumn:g}=a,{startAbsoluteRefType:m,endAbsoluteRefType:S,rangeType:f}=a;if(u){let{isMerged:e,isMergedMainCell:t,startRow:n,endRow:r,startColumn:i,endColumn:o}=u;(e||t)&&n===c&&i===h&&r===d&&o===g&&(c=n,h=i,d=n,g=i)}return(0,l.serializeRangeToRefString)({sheetName:n,unitId:t,range:{startRow:c,endRow:d,startColumn:h,endColumn:g,rangeType:f,startAbsoluteRefType:m,endAbsoluteRefType:S}})}_syncToEditor(e,t,n,r=!0,i=!0){let o=(0,l.generateStringWithSequence)(e),{textRuns:s,refSelections:a}=this._buildTextRuns(e);this._isSelectionMovingRefSelections=a,this._allSelectionRenderServices.forEach(e=>this._updateRefSelectionStyle(e,this._isSelectionMovingRefSelections));let u=this._docSelectionManagerService.getActiveTextRange();if(null==u)return;this._currentInsertRefStringIndex=t,null==n&&(n=this._univerInstanceService.getCurrentUniverDocInstance().getUnitId()),this._fitEditorSize();let c=this._editorService.getEditor(n);null!=c&&c.isSingleChoice()?(o=o.split(",")[0],this._selectionRenderService.setSingleSelectionEnabled(!0)):this._selectionRenderService.setSingleSelectionEnabled(!1);let d=o,h=1;c&&c.onlyInputRange()||(d=`${l.compareToken.EQUALS}${o}`,h=0);let{collapsed:g,style:m}=u;r?this._commandService.executeCommand(v.ReplaceContentCommand.id,{unitId:n,body:{dataStream:d,textRuns:s},textRanges:[{startOffset:t+1-h,endOffset:t+1-h,collapsed:g,style:m}],segmentId:null,options:{fromSelection:i}}):this._updateEditorModel(`${d}\r
`,s),this._docSelectionManagerService.replaceTextRanges([{startOffset:t+1-h,endOffset:t+1-h,style:m}],!0,{fromSelection:i}),this._layoutService.focus()}_fitEditorSize(){let e=this._univerInstanceService.getCurrentUniverDocInstance().getUnitId();this._editorService.isEditor(e)&&!this._editorService.isSheetEditor(e)||this._commandService.executeCommand(R.SetEditorResizeOperation.id,{unitId:e})}_updateEditorModel(e,t){var n;let r=this._univerInstanceService.getCurrentUniverDocInstance(),i=r.getUnitId();if(!this._editorService.isEditor(i))return;let o=null==(n=this._renderManagerService.getRenderById(i))?void 0:n.with(b.DocSkeletonManagerService).getViewModel();if(null==o||null==r)return;let l=null==r?void 0:r.getSnapshot();null!=l&&(l.body={dataStream:e,textRuns:t},o.reset(r))}_insertControlSelectionReplace(e){null==this._previousSequenceNodes&&(this._previousSequenceNodes=this._formulaPromptService.getSequenceNodes()),null==this._previousInsertRefStringIndex&&(this._previousInsertRefStringIndex=this._currentInsertRefStringIndex);let t=(0,i.Tools).deepClone(this._previousSequenceNodes);if(null==t)return;let n=this._generateRefString(e);this._formulaPromptService.setSequenceNodes(t),this._formulaPromptService.insertSequenceRef(this._previousInsertRefStringIndex,n),this._syncToEditor(t,this._previousInsertRefStringIndex+n.length);let r=this._selectionRenderService.getSelectionDataWithStyle();this._insertSelections=[],r.forEach(e=>{let t=(0,_.convertSelectionDataToRange)(e);this._insertSelections.push(t)})}_focusIsOnlyRange(e){let t=this._editorService.getFocusEditor();return!t||!t.onlyInputRange()||!!this._existsSequenceNode||e>1||null!=this._previousSequenceNodes&&this._previousSequenceNodes.length>0||(null!=this._previousInsertRefStringIndex&&(this._previousInsertRefStringIndex+=1),!1)}_resetSequenceNodes(e){let t=this._editorService.getFocusEditor();t&&t.onlyInputRange()&&(e>1||this._existsSequenceNode&&(this._formulaPromptService.clearSequenceNodes(),this._previousRangesCount=0,this._existsSequenceNode=!1))}_updateRefSelectionStyle(e,t){let n=e.getSelectionControls(),[r,o]=e.getLocation(),s=/* @__PURE__ */new Set;for(let e=0,a=t.length;e<a;e++){let{refIndex:a,themeColor:u,token:c}=t[e],{unitId:d,sheetName:h,range:g}=(0,l.deserializeRangeWithSheet)(c);if(!d&&d.length>0&&r!==d)continue;let m=this._getSheetIdByName(r,h.trim());if(m&&m!==o)continue;let S=n.find(e=>{let{startRow:t,startColumn:n,endRow:r,endColumn:o,rangeType:l}=e.getRange();return l===i.RANGE_TYPE.COLUMN&&n===g.startColumn&&o===g.endColumn||l===i.RANGE_TYPE.ROW&&t===g.startRow&&r===g.endRow||t===g.startRow&&n===g.startColumn&&r===g.endRow&&o===g.endColumn||t===g.startRow&&n===g.startColumn&&g.startRow===g.endRow&&g.startColumn===g.endColumn});if(S){let e=nf(this._themeService,u,a.toString());S.updateStyle(e),s.add(S)}}}_onSelectionControlChange(e,t){var n;let{skeleton:r}=this._getCurrentUnitIdAndSheetId();this._formulaPromptService.enableLockedSelectionChange();let o=null==(n=t.currentStyle)?void 0:n.id;if(!o||!(0,i.Tools).isStringNumber(o))return;let{startRow:s,endRow:a,startColumn:u,endColumn:c}=e,d=r?r.worksheet.getCellInfoInMergeData(s,u):{actualRow:s,actualColumn:u,isMergedMainCell:!1,isMerged:!1,endRow:s,endColumn:u,startRow:s,startColumn:u};if(d){let{isMerged:e,isMergedMainCell:t,startRow:n,endRow:r,startColumn:i,endColumn:o}=d;(e||t)&&n===s&&i===u&&r===a&&o===c&&(s=n,u=i,a=n,c=i)}let h=Number(o),g=this._formulaPromptService.getCurrentSequenceNodeByIndex(h);if(!g)return;let m={startAbsoluteRefType:i.AbsoluteRefType.NONE};if("string"!=typeof g){let e=g.token;null==(m=(0,l.getAbsoluteRefTypeWitString)(e)).endAbsoluteRefType&&(m.endAbsoluteRefType=m.startAbsoluteRefType)}let S=null==r?void 0:r.worksheet.getUnitId(),f=null==r?void 0:r.worksheet.getSheetId(),p=this._generateRefString({range:{startRow:Math.min(s,a),endRow:Math.max(s,a),startColumn:Math.min(u,c),endColumn:Math.max(u,c),...m,sheetId:f,unitId:S},primary:d,style:null});this._formulaPromptService.updateSequenceRef(h,p);let v=this._formulaPromptService.getSequenceNodes(),_=v[h];"string"!=typeof _&&(this._syncToEditor(v,_.endIndex+1),t.update(e,void 0,void 0,void 0,this._selectionRenderService.attachPrimaryWithCoord(d)))}_refreshFormulaAndCellEditor(e){var t;for(let n of e){let e=(0,o.getEditorObject)(n,this._renderManagerService),r=null==e?void 0:e.document;null!=r&&(null==(t=r.getSkeleton())||t.calculate(),r.makeDirty())}}_cursorStateListener(){let e=this._getEditorObject();if(null==e)return;let{mainComponent:t}=e;t&&this.disposeWithMe(t.onPointerDown$.subscribeEvent(()=>{this._arrowMoveActionState=1,this._inputPanelState=3}))}_pressEnter(e){let{keycode:t,isSingleEditor:n=!1}=e;if(this._formulaPromptService.isSearching()){this._formulaPromptService.accept(!0);return}!0!==n&&this._editorBridgeService.changeVisible({visible:!1,eventType:E.DeviceInputEventType.Keyboard,keycode:t,unitId:""})}_pressTab(e){let{keycode:t,isSingleEditor:n=!1}=e;if(this._formulaPromptService.isSearching()){this._formulaPromptService.accept(!0);return}!0!==n&&this._editorBridgeService.changeVisible({visible:!1,eventType:E.DeviceInputEventType.Keyboard,keycode:t,unitId:""})}_pressEsc(e){let{keycode:t}=e,n=this._editorService.getFocusEditor();n&&(null==n?void 0:n.isSheetEditor())!==!0||this._editorBridgeService.changeVisible({visible:!1,eventType:E.DeviceInputEventType.Keyboard,keycode:t,unitId:""})}_pressArrowKey(e){let{keycode:t,metaKey:n}=e,r=i.Direction.DOWN;t===R.KeyCode.ARROW_DOWN?r=i.Direction.DOWN:t===R.KeyCode.ARROW_UP?r=i.Direction.UP:t===R.KeyCode.ARROW_LEFT?r=i.Direction.LEFT:t===R.KeyCode.ARROW_RIGHT&&(r=i.Direction.RIGHT),n===R.MetaKeys.CTRL_COMMAND?this._commandService.executeCommand(o.MoveSelectionCommand.id,{direction:r,jumpOver:o.JumpOver.moveGap}):n===R.MetaKeys.SHIFT?this._commandService.executeCommand(o.ExpandSelectionCommand.id,{direction:r}):n===ne?this._commandService.executeCommand(o.ExpandSelectionCommand.id,{direction:r,jumpOver:o.JumpOver.moveGap}):this._commandService.executeCommand(o.MoveSelectionCommand.id,{direction:r})}_commandExecutedListener(){let e=[O.id];this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===Y.id)this._changeRefString();else if(e.includes(t.id)){let e=t.params,{keycode:n,isSingleEditor:r=!1}=e;if(n===R.KeyCode.ENTER){this._pressEnter(e);return}if(n===R.KeyCode.TAB){this._pressTab(e);return}if(n===R.KeyCode.ESC){this._pressEsc(e);return}if(this._formulaPromptService.isSearching()){if(n===R.KeyCode.ARROW_DOWN){this._formulaPromptService.navigate({direction:i.Direction.DOWN});return}if(n===R.KeyCode.ARROW_UP){this._formulaPromptService.navigate({direction:i.Direction.UP});return}}if(!0===r)return;if(1===this._arrowMoveActionState){this._moveInEditor(n);return}if(4===this._arrowMoveActionState){this._editorBridgeService.changeVisible({visible:!1,eventType:E.DeviceInputEventType.Keyboard,keycode:n,unitId:""});return}if(2===this._arrowMoveActionState&&(this._arrowMoveActionState=3),0===this._refSelectionsService.getCurrentSelections().length){let e=this._sheetsSelectionsService.getCurrentLastSelection();if(null!=e){let t=(0,i.Tools).deepClone(e);this._refSelectionsService.addSelections([t])}}this._pressArrowKey(e);let o=this._refSelectionsService.getCurrentSelections(),l=o[o.length-1];this._insertControlSelectionReplace(l),this._highlightFormula()}}))}_moveInEditor(e){if(null==e)return;let t=i.Direction.LEFT;e===R.KeyCode.ARROW_DOWN?t=i.Direction.DOWN:e===R.KeyCode.ARROW_UP?t=i.Direction.UP:e===R.KeyCode.ARROW_RIGHT&&(t=i.Direction.RIGHT),this._commandService.executeCommand(v.MoveCursorOperation.id,{direction:t})}_userMouseListener(){let e=this._getEditorObject();if(null==e)return;let{mainComponent:t}=e;t&&this.disposeWithMe(null==t?void 0:t.onPointerDown$.subscribeEvent(()=>{this._userCursorMove=!0}))}_inputFormulaListener(){this.disposeWithMe(this._editorService.inputFormula$.subscribe(e=>{let{formulaString:t,editorUnitId:n}=e;if(t.substring(0,1)!==l.compareToken.EQUALS)return;let{unitId:r}=this._getCurrentUnitIdAndSheetId();!1===this._editorBridgeService.isVisible().visible&&this._editorBridgeService.changeVisible({visible:!0,eventType:E.DeviceInputEventType.Dblclick,unitId:r});let i=this._lexerTreeBuilder.sequenceNodesBuilder(t)||[];this._formulaPromptService.setSequenceNodes(i),this._syncToEditor(i,t.length-1,n,!0,!1)}))}_changeRefString(){let e=this._docSelectionManagerService.getActiveTextRange();if(null==e)return;let{startOffset:t}=e,n=t-2,r=this._formulaPromptService.getCurrentSequenceNodeIndex(n),i=this._formulaPromptService.getCurrentSequenceNodeByIndex(r);if(null==i||"string"==typeof i||i.nodeType!==l.sequenceNodeType.REFERENCE)return;let o=i.token.split("!"),s=i.token;o.length>1&&(s=o[o.length-1]);let a="";for(let e=0,t=o.length;e<t-1;e++)a+=o[e];let u=s;if(s.indexOf(l.matchToken.COLON)>-1){if(this._userCursorMove){let e=s.split(l.matchToken.COLON),t=e[0],r=e[1];u=n-i.startIndex<=t.length?this._changeSingleRef(t)+l.matchToken.COLON+r:t+l.matchToken.COLON+this._changeSingleRef(r)}else u=this._changeRangeRef(s)}else u=this._changeSingleRef(s);let c=(u=a+u).length-i.token.length;this._formulaPromptService.updateSequenceRef(r,u),this._syncToEditor(this._formulaPromptService.getSequenceNodes(),n+c+1)}_changeRangeRef(e){let t=(0,l.deserializeRangeWithSheet)(e).range;return t.startAbsoluteRefType===i.AbsoluteRefType.NONE||null==t.startAbsoluteRefType?(t.startAbsoluteRefType=i.AbsoluteRefType.ALL,t.endAbsoluteRefType=i.AbsoluteRefType.ALL):(t.startAbsoluteRefType=i.AbsoluteRefType.NONE,t.endAbsoluteRefType=i.AbsoluteRefType.NONE),(0,l.serializeRange)(t)}_changeSingleRef(e){let t=(0,l.deserializeRangeWithSheet)(e).range,n=t.startAbsoluteRefType;return n===i.AbsoluteRefType.NONE||null==n?(t.startAbsoluteRefType=i.AbsoluteRefType.ALL,t.endAbsoluteRefType=i.AbsoluteRefType.ALL):n===i.AbsoluteRefType.ALL?(t.startAbsoluteRefType=i.AbsoluteRefType.ROW,t.endAbsoluteRefType=i.AbsoluteRefType.ROW):n===i.AbsoluteRefType.ROW?(t.startAbsoluteRefType=i.AbsoluteRefType.COLUMN,t.endAbsoluteRefType=i.AbsoluteRefType.COLUMN):(t.startAbsoluteRefType=i.AbsoluteRefType.NONE,t.endAbsoluteRefType=i.AbsoluteRefType.NONE),(0,l.serializeRange)(t)}_getEditorObject(){let e=this._univerInstanceService.getCurrentUniverDocInstance().getUnitId(),t=this._editorService.getEditor(e);return null==t?void 0:t.render}_isFormulaEditorActivated(){return!0===this._editorBridgeService.isVisible().visible||this._contextService.getContextValue(i.FORMULA_EDITOR_ACTIVATED)}_isSheetOrFormulaEditor(e){return e.isSheetEditor()||e.isFormulaEditor()}},"PromptController"),ny);nI=n_([nC(0,i.ICommandService),nC(1,i.IContextService),nC(2,(0,i.Inject)(o.IEditorBridgeService)),nC(3,(0,i.Inject)(k)),nC(4,(0,i.Inject)(l.LexerTreeBuilder)),nC(5,E.IRenderManagerService),nC(6,(0,i.Inject)(i.ThemeService)),nC(7,(0,i.Inject)(_.SheetsSelectionsService)),nC(8,_.IRefSelectionsService),nC(9,i.IUniverInstanceService),nC(10,(0,i.Inject)(C.IDescriptionService)),nC(11,(0,i.Inject)(b.DocSelectionManagerService)),nC(12,R.IContextMenuService),nC(13,v.IEditorService),nC(14,R.ILayoutService)],nI);var ny,nE,nb=Object.defineProperty,nT=Object.getOwnPropertyDescriptor,nN=/* @__PURE__ */M((e,t,n)=>t in e?nb(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,"__defNormalProp"),nM=/* @__PURE__ */M((e,t,n,r)=>{for(var i,o=r>1?void 0:r?nT(t,n):t,l=e.length-1;l>=0;l--)(i=e[l])&&(o=(r?i(t,n,o):i(o))||o);return r&&o&&nb(t,n,o),o},"__decorateClass"),nx=/* @__PURE__ */M((e,t)=>(n,r)=>t(n,r,e),"__decorateParam"),nA=/* @__PURE__ */M((e,t,n)=>nN(e,"symbol"!=typeof t?t+"":t,n),"__publicField");let nO=(M(nE=class extends i.Plugin{constructor(e=e5,t,n,r){super(),this._config=e,this._injector=t,this._renderManagerService=n,this._configService=r;let{menu:i,...o}=this._config;i&&this._configService.setConfig("menu",i,{merge:!0}),this._configService.setConfig("sheets-formula.base.config",o)}onStarting(){let e=this._injector;[[k,{useClass:L}],[nS],[tg],[tC],[tP],[tB],[nI]].forEach(t=>e.add(t))}onReady(){this._injector.get(nS)}onRendered(){[[ek],[tl]].forEach(e=>{this.disposeWithMe(this._renderManagerService.registerRenderModule(i.UniverInstanceType.UNIVER_SHEET,e))}),this._injector.get(tC),this._injector.get(tB),this._injector.get(R.ComponentManager).register(o.RANGE_SELECTOR_COMPONENT_KEY,e2)}onSteady(){this._injector.get(tg),this._injector.get(nI)}},"UniverSheetsFormulaUIPlugin"),nE);nA(nO,"pluginName",K),nA(nO,"type",i.UniverInstanceType.UNIVER_SHEET),nO=nM([(0,i.DependentOn)(l.UniverFormulaEnginePlugin,C.UniverSheetsFormulaPlugin),nx(1,(0,i.Inject)(i.Injector)),nx(2,E.IRenderManagerService),nx(3,i.IConfigService)],nO)}),n("8WNAB",function(n,r){e(n.exports,"distinctUntilKeyChanged",function(){return o});var i=t("arCqp");function o(e,t){return(0,i.distinctUntilChanged)(function(n,r){return t?t(n[e],r[e]):n[e]===r[e]})}});
//# sourceMappingURL=es.75595260.js.map
