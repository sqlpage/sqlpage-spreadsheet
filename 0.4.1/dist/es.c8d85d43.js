function e(e,t,n,r){Object.defineProperty(e,t,{get:n,set:r,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire26fc,n=t.register;n("ejawP",function(n,r){let o,i,s,a,l,u;e(n.exports,"RangeProtectionRuleModel",function(){return k}),e(n.exports,"AddRangeProtectionMutation",function(){return N}),e(n.exports,"DeleteRangeProtectionMutation",function(){return x}),e(n.exports,"AddRangeProtectionCommand",function(){return O}),e(n.exports,"SelectionMoveType",function(){return W}),e(n.exports,"SheetsSelectionsService",function(){return j}),e(n.exports,"DISABLE_NORMAL_SELECTIONS",function(){return H}),e(n.exports,"INTERCEPTOR_POINT",function(){return F}),e(n.exports,"InterceptCellContentPriority",function(){return q}),e(n.exports,"SheetInterceptorService",function(){return X}),e(n.exports,"SetRangeValuesUndoMutationFactory",function(){return em}),e(n.exports,"SetRangeValuesMutation",function(){return eg}),e(n.exports,"generateNullCellValue",function(){return eR}),e(n.exports,"ClearSelectionAllCommand",function(){return ev}),e(n.exports,"ClearSelectionContentCommand",function(){return eS}),e(n.exports,"ClearSelectionFormatCommand",function(){return ew}),e(n.exports,"InsertSheetMutation",function(){return ey}),e(n.exports,"getSheetCommandTarget",function(){return eU}),e(n.exports,"RemoveSheetMutation",function(){return eT}),e(n.exports,"CopySheetCommand",function(){return ek}),e(n.exports,"MoveRangeMutation",function(){return eN}),e(n.exports,"IRefSelectionsService",function(){return eV}),e(n.exports,"RefSelectionsService",function(){return e$}),e(n.exports,"getSelectionsService",function(){return eW}),e(n.exports,"SetSelectionsOperation",function(){return ej}),e(n.exports,"alignToMergedCellsBorders",function(){return eL}),e(n.exports,"getCellAtRowCol",function(){return eB}),e(n.exports,"setEndForRange",function(){return eH}),e(n.exports,"getPrimaryForRange",function(){return eF}),e(n.exports,"isSingleCellSelection",function(){return eq}),e(n.exports,"copyRangeStyles",function(){return eY}),e(n.exports,"MoveRangeCommand",function(){return eK}),e(n.exports,"UnitAction",function(){return eQ}),e(n.exports,"UnitObject",function(){return e0}),e(n.exports,"RangeProtectionPermissionEditPoint",function(){return e2}),e(n.exports,"RangeProtectionPermissionViewPoint",function(){return e3}),e(n.exports,"WorkbookCommentPermission",function(){return e6}),e(n.exports,"WorkbookCopyPermission",function(){return e8}),e(n.exports,"WorkbookCreateProtectPermission",function(){return tt}),e(n.exports,"WorkbookCreateSheetPermission",function(){return tr}),e(n.exports,"WorkbookDeleteSheetPermission",function(){return ti}),e(n.exports,"WorkbookEditablePermission",function(){return tl}),e(n.exports,"WorkbookHideSheetPermission",function(){return tc}),e(n.exports,"WorkbookManageCollaboratorPermission",function(){return tm}),e(n.exports,"WorkbookMoveSheetPermission",function(){return tp}),e(n.exports,"WorkbookRenameSheetPermission",function(){return tf}),e(n.exports,"WorkbookViewPermission",function(){return tw}),e(n.exports,"WorksheetCopyPermission",function(){return tM}),e(n.exports,"WorksheetDeleteColumnPermission",function(){return t_}),e(n.exports,"WorksheetDeleteProtectionPermission",function(){return tT}),e(n.exports,"WorksheetDeleteRowPermission",function(){return tx}),e(n.exports,"WorksheetEditPermission",function(){return tO}),e(n.exports,"WorksheetFilterPermission",function(){return tA}),e(n.exports,"WorksheetInsertColumnPermission",function(){return t$}),e(n.exports,"WorksheetInsertHyperlinkPermission",function(){return tj}),e(n.exports,"WorksheetInsertRowPermission",function(){return tB}),e(n.exports,"WorksheetManageCollaboratorPermission",function(){return tF}),e(n.exports,"WorksheetSetCellStylePermission",function(){return tz}),e(n.exports,"WorksheetSetCellValuePermission",function(){return tJ}),e(n.exports,"WorksheetSetColumnStylePermission",function(){return tX}),e(n.exports,"WorksheetSetRowStylePermission",function(){return tQ}),e(n.exports,"WorksheetViewPermission",function(){return t2}),e(n.exports,"SetRangeValuesCommand",function(){return t5}),e(n.exports,"DeleteRangeMoveLeftCommand",function(){return t7}),e(n.exports,"DeleteRangeMoveUpCommand",function(){return t9}),e(n.exports,"DeleteRangeProtectionCommand",function(){return ne}),e(n.exports,"InsertDefinedNameCommand",function(){return nt}),e(n.exports,"InsertRowMutation",function(){return nr}),e(n.exports,"InsertColMutation",function(){return ni}),e(n.exports,"RemoveRowMutation",function(){return na}),e(n.exports,"RemoveColMutation",function(){return nu}),e(n.exports,"InsertRangeMoveDownCommand",function(){return nd}),e(n.exports,"InsertRangeMoveRightCommand",function(){return nh}),e(n.exports,"InsertRowCommand",function(){return ng}),e(n.exports,"InsertRowBeforeCommand",function(){return np}),e(n.exports,"InsertRowAfterCommand",function(){return nI}),e(n.exports,"InsertColCommand",function(){return nR}),e(n.exports,"InsertColBeforeCommand",function(){return nf}),e(n.exports,"InsertColAfterCommand",function(){return nv}),e(n.exports,"InsertSheetCommand",function(){return nS}),e(n.exports,"MoveRowsMutation",function(){return nb}),e(n.exports,"MoveColsMutation",function(){return nM}),e(n.exports,"MoveRowsCommand",function(){return nT}),e(n.exports,"MoveColsCommand",function(){return nx}),e(n.exports,"RemoveDefinedNameCommand",function(){return nO}),e(n.exports,"RemoveRowCommand",function(){return nP}),e(n.exports,"RemoveColCommand",function(){return nV}),e(n.exports,"RemoveSheetCommand",function(){return n$}),e(n.exports,"AddMergeUndoMutationFactory",function(){return nW}),e(n.exports,"AddWorksheetMergeMutation",function(){return nj}),e(n.exports,"RemoveMergeUndoMutationFactory",function(){return nL}),e(n.exports,"RemoveWorksheetMergeMutation",function(){return nB}),e(n.exports,"RemoveWorksheetMergeCommand",function(){return nH}),e(n.exports,"ReorderRangeMutation",function(){return nq}),e(n.exports,"BorderStyleManagerService",function(){return nK}),e(n.exports,"SetBorderCommand",function(){return n4}),e(n.exports,"SetBorderBasicCommand",function(){return n9}),e(n.exports,"SetColDataCommand",function(){return ro}),e(n.exports,"SetColHiddenMutation",function(){return rs}),e(n.exports,"SetColVisibleMutation",function(){return rl}),e(n.exports,"SetSpecificColsVisibleCommand",function(){return ru}),e(n.exports,"SetSelectedColsVisibleCommand",function(){return rd}),e(n.exports,"SetColHiddenCommand",function(){return rc}),e(n.exports,"SetDefinedNameCommand",function(){return rp}),e(n.exports,"SetFrozenMutationFactory",function(){return rI}),e(n.exports,"SetFrozenMutation",function(){return rC}),e(n.exports,"SetFrozenCommand",function(){return rR}),e(n.exports,"SetRangeProtectionMutation",function(){return rv}),e(n.exports,"SetRowDataCommand",function(){return ry}),e(n.exports,"SetRowVisibleMutation",function(){return rU}),e(n.exports,"SetRowHiddenMutation",function(){return rE}),e(n.exports,"SetSpecificRowsVisibleCommand",function(){return rT}),e(n.exports,"SetSelectedRowsVisibleCommand",function(){return rk}),e(n.exports,"SetRowHiddenCommand",function(){return rx}),e(n.exports,"SetStyleCommand",function(){return rP}),e(n.exports,"SetBoldCommand",function(){return rA}),e(n.exports,"SetItalicCommand",function(){return rV}),e(n.exports,"SetUnderlineCommand",function(){return r$}),e(n.exports,"SetStrikeThroughCommand",function(){return rW}),e(n.exports,"SetFontFamilyCommand",function(){return rj}),e(n.exports,"SetFontSizeCommand",function(){return rL}),e(n.exports,"SetTextColorCommand",function(){return rB}),e(n.exports,"ResetTextColorCommand",function(){return rH}),e(n.exports,"SetBackgroundColorCommand",function(){return rF}),e(n.exports,"ResetBackgroundColorCommand",function(){return rG}),e(n.exports,"SetVerticalTextAlignCommand",function(){return rq}),e(n.exports,"SetHorizontalTextAlignCommand",function(){return rz}),e(n.exports,"SetTextWrapCommand",function(){return rY}),e(n.exports,"SetTextRotationCommand",function(){return rJ}),e(n.exports,"SetTabColorMutation",function(){return rX}),e(n.exports,"SetTabColorCommand",function(){return rZ}),e(n.exports,"SetWorksheetActiveOperation",function(){return r1}),e(n.exports,"SetWorksheetActivateCommand",function(){return r2}),e(n.exports,"SetWorksheetColWidthMutation",function(){return r3}),e(n.exports,"DeltaColumnWidthCommand",function(){return r4}),e(n.exports,"SetColWidthCommand",function(){return r6}),e(n.exports,"SetWorksheetHideMutation",function(){return r9}),e(n.exports,"SetWorksheetHideCommand",function(){return oe}),e(n.exports,"SetWorksheetNameMutation",function(){return on}),e(n.exports,"SetWorksheetNameCommand",function(){return or}),e(n.exports,"SetWorksheetOrderMutation",function(){return oi}),e(n.exports,"SetWorksheetOrderCommand",function(){return os}),e(n.exports,"getAllRangePermissionPoint",function(){return ou}),e(n.exports,"baseProtectionActions",function(){return od}),e(n.exports,"getAllWorkbookPermissionPoint",function(){return oc}),e(n.exports,"defaultWorkbookPermissionPoints",function(){return oh}),e(n.exports,"getAllWorksheetPermissionPoint",function(){return om}),e(n.exports,"getAllWorksheetPermissionPointByPointPanel",function(){return og}),e(n.exports,"defaultWorksheetPermissionPoint",function(){return op}),e(n.exports,"WorksheetProtectionPointModel",function(){return oC}),e(n.exports,"WorksheetProtectionRuleModel",function(){return of}),e(n.exports,"SetWorksheetPermissionPointsMutation",function(){return oM}),e(n.exports,"SetWorksheetPermissionPointsCommand",function(){return oU}),e(n.exports,"SetWorksheetRowAutoHeightMutationFactory",function(){return oT}),e(n.exports,"SetWorksheetRowHeightMutation",function(){return ok}),e(n.exports,"SetWorksheetRowIsAutoHeightMutation",function(){return ox}),e(n.exports,"SetWorksheetRowAutoHeightMutation",function(){return oN}),e(n.exports,"DeltaRowHeightCommand",function(){return oO}),e(n.exports,"SetRowHeightCommand",function(){return oD}),e(n.exports,"SetWorksheetRowIsAutoHeightCommand",function(){return oP}),e(n.exports,"SetWorksheetShowCommand",function(){return oA}),e(n.exports,"ToggleCellCheckboxCommand",function(){return oV}),e(n.exports,"ToggleGridlinesMutation",function(){return o$}),e(n.exports,"ToggleGridlinesCommand",function(){return oW}),e(n.exports,"AddWorksheetProtectionMutation",function(){return oj}),e(n.exports,"DeleteWorksheetProtectionMutation",function(){return oL}),e(n.exports,"rangeMerge",function(){return oY}),e(n.exports,"INumfmtService",function(){return oJ}),e(n.exports,"factorySetNumfmtUndoMutation",function(){return oK}),e(n.exports,"transformCellsToRange",function(){return o0}),e(n.exports,"SetNumfmtMutation",function(){return oX}),e(n.exports,"RemoveNumfmtMutation",function(){return oZ}),e(n.exports,"factoryRemoveNumfmtUndoMutation",function(){return oQ}),e(n.exports,"SetWorksheetProtectionMutation",function(){return o5}),e(n.exports,"ScrollToCellOperation",function(){return o3}),e(n.exports,"MAX_CELL_PER_SHEET_KEY",function(){return o6}),e(n.exports,"EffectRefRangId",function(){return iR}),e(n.exports,"handleMoveRows",function(){return iM}),e(n.exports,"handleMoveCols",function(){return iE}),e(n.exports,"handleMoveRange",function(){return ik}),e(n.exports,"handleIRemoveCol",function(){return iO}),e(n.exports,"handleIRemoveRow",function(){return iD}),e(n.exports,"handleInsertRow",function(){return i$}),e(n.exports,"handleInsertCol",function(){return iW}),e(n.exports,"handleInsertRangeMoveDown",function(){return ij}),e(n.exports,"handleInsertRangeMoveRight",function(){return iB}),e(n.exports,"handleDeleteRangeMoveLeft",function(){return iF}),e(n.exports,"handleDeleteRangeMoveUp",function(){return iq}),e(n.exports,"runRefRangeMutations",function(){return iJ}),e(n.exports,"handleDefaultRangeChangeWithEffectRefCommands",function(){return iK}),e(n.exports,"handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests",function(){return iX}),e(n.exports,"handleCommonDefaultRangeChangeWithEffectRefCommands",function(){return iZ}),e(n.exports,"handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests",function(){return iQ}),e(n.exports,"RefRangeService",function(){return st}),e(n.exports,"getAddMergeMutationRangeByType",function(){return sm}),e(n.exports,"MERGE_CELL_INTERCEPTOR_CHECK",function(){return sg}),e(n.exports,"MergeCellController",function(){return sp}),e(n.exports,"RangeProtectionCache",function(){return sN}),e(n.exports,"IExclusiveRangeService",function(){return sW}),e(n.exports,"UniverSheetsPlugin",function(){return au}),e(n.exports,"COMMAND_LISTENER_SKELETON_CHANGE",function(){return ad}),e(n.exports,"COMMAND_LISTENER_VALUE_CHANGE",function(){return ac}),e(n.exports,"SELECTION_CONTROL_BORDER_BUFFER_WIDTH",function(){return ah}),e(n.exports,"SELECTION_CONTROL_BORDER_BUFFER_COLOR",function(){return am}),e(n.exports,"getNormalSelectionStyle",function(){return ag}),e(n.exports,"convertSelectionDataToRange",function(){return ap}),e(n.exports,"transformCellDataToSelectionData",function(){return aC}),e(n.exports,"AddMergeRedoSelectionsOperationFactory",function(){return aR}),e(n.exports,"AddMergeUndoSelectionsOperationFactory",function(){return af}),e(n.exports,"expandToContinuousRange",function(){return a_}),e(n.exports,"AddWorksheetMergeCommand",function(){return aN}),e(n.exports,"AddWorksheetMergeAllCommand",function(){return aO}),e(n.exports,"AddWorksheetMergeVerticalCommand",function(){return aD}),e(n.exports,"AddWorksheetMergeHorizontalCommand",function(){return aP}),e(n.exports,"addMergeCellsUtil",function(){return aA}),e(n.exports,"SetWorksheetDefaultStyleCommand",function(){return aV});var d,c=t("7yNYd"),h=t("86b1c"),m=t("k2g5B"),g=t("5LPkb"),p=t("lMvMU"),I=t("bDEN0"),C=t("hciHF"),R=t("i54iF"),f=t("3yupB"),v=t("c3hg1"),S=t("1mjSk"),w=t("23cfA"),b=t("2jrJe"),y=t("2BOVU"),p=t("lMvMU"),C=t("hciHF"),b=t("2jrJe"),M=Object.defineProperty,U=(e,t,n)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,_=(e,t)=>M(e,"name",{value:t,configurable:!0}),E=(e,t,n)=>U(e,"symbol"!=typeof t?t+"":t,n);let T=class{constructor(){E(this,"_model",/* @__PURE__ */new Map),E(this,"_ruleChange",new S.Subject),E(this,"ruleChange$",this._ruleChange.asObservable()),E(this,"_ruleRefresh",new S.Subject),E(this,"ruleRefresh$",this._ruleRefresh.asObservable()),E(this,"_rangeRuleInitStateChange",new g.BehaviorSubject(!1)),E(this,"rangeRuleInitStateChange$",this._rangeRuleInitStateChange.asObservable())}ruleRefresh(e){this._ruleRefresh.next(e)}getRangeRuleInitState(){return this._rangeRuleInitStateChange.value}changeRuleInitState(e){this._rangeRuleInitStateChange.next(e)}addRule(e,t,n){this._ensureRuleMap(e,t).set(n.id,n),this._ruleChange.next({unitId:e,subUnitId:t,rule:n,type:"add"})}deleteRule(e,t,n){var r,o,i,s;let a=null==(o=null==(r=this._model.get(e))?void 0:r.get(t))?void 0:o.get(n);a&&(null==(s=null==(i=this._model.get(e))?void 0:i.get(t))||s.delete(n),this._ruleChange.next({unitId:e,subUnitId:t,rule:a,type:"delete"}))}setRule(e,t,n,r){var o,i;let s=this.getRule(e,t,n);s&&(null==(i=null==(o=this._model.get(e))?void 0:o.get(t))||i.set(n,r),this._ruleChange.next({unitId:e,subUnitId:t,oldRule:s,rule:r,type:"set"}))}getRule(e,t,n){var r,o;return null==(o=null==(r=this._model.get(e))?void 0:r.get(t))?void 0:o.get(n)}getSubunitRuleList(e,t){var n;return[...((null==(n=this._model.get(e))?void 0:n.get(t))||/* @__PURE__ */new Map).values()]}getSubunitRuleListLength(e,t){var n;let r=null==(n=this._model.get(e))?void 0:n.get(t);return r?r.size:0}_ensureRuleMap(e,t){let n=this._model.get(e);n||(n=/* @__PURE__ */new Map,this._model.set(e,n));let r=n.get(t);return r||(r=/* @__PURE__ */new Map,n.set(t,r)),r}toObject(){let e={};return[...this._model.keys()].forEach(t=>{let n=this._model.get(t),r=[...n.keys()];e[t]={},r.forEach(r=>{let o=n.get(r);e[t][r]=[...o.values()]})}),e}fromObject(e){let t=/* @__PURE__ */new Map;Object.keys(e).forEach(n=>{let r=e[n],o=/* @__PURE__ */new Map;Object.keys(r).forEach(e=>{let t=r[e].reduce((e,t)=>(e.set(t.id,t),e),/* @__PURE__ */new Map);o.set(e,t)}),t.set(n,o)}),this._model=t}deleteUnitModel(e){this._model.delete(e)}createRuleId(e,t){let n=(0,c.Tools).generateRandomId(4),r=this._ensureRuleMap(e,t);for(;r.has(n);)n=(0,c.Tools).generateRandomId(4);return n}getTargetByPermissionId(e,t){let n=this._model.get(e);if(!n)return null;for(let[r,o]of n)for(let n of o.values())if(n.permissionId===t)return[e,r];return null}};_(T,"RangeProtectionRuleModel");let k=T,x={id:"sheet.mutation.delete-range-protection",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ruleIds:o}=t,i=e.get(k);return o.forEach(e=>{i.deleteRule(n,r,e)}),!0},"handler")},N=(/* @__PURE__ */e=>{let t={...e,ruleIds:e.rules.map(e=>e.id)};return{id:x.id,params:t}},{id:"sheet.mutation.add-range-protection",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rules:o}=t,i=e.get(k);return o.forEach(e=>{i.addRule(n,r,e)}),!0},"handler")}),O={type:c.CommandType.COMMAND,id:"sheet.command.add-range-protection",async handler(e,t){if(!t)return!1;let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=e.get(k),{rule:i,permissionId:s}=t,{unitId:a,subUnitId:l,ranges:u,name:d,description:h}=i,m=[{ranges:u,permissionId:s,id:o.createRuleId(a,l),name:d,description:h,unitType:i.unitType,unitId:a,subUnitId:l}];if(await n.executeCommand(N.id,{unitId:a,subUnitId:l,rules:m})){let e=[{id:N.id,params:{unitId:a,subUnitId:l,rules:m}}],t=[{id:x.id,params:{unitId:a,subUnitId:l,ruleIds:m.map(e=>e.id)}}];r.pushUndoRedo({unitID:a,redoMutations:e,undoMutations:t})}return!0}};var D,P=Object.defineProperty,A=Object.getOwnPropertyDescriptor,V=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?A(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&P(t,n,i),i},"__decorateClass$g"),$=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$g"),W=((o=W||{})[o.MOVE_START=0]="MOVE_START",o[o.MOVING=1]="MOVING",o[o.MOVE_END=2]="MOVE_END",o[o.ONLY_SET=3]="ONLY_SET",o);let j=(_(D=class extends c.RxDisposable{constructor(e){super(),E(this,"selectionMoveStart$"),E(this,"selectionMoving$"),E(this,"selectionMoveEnd$"),E(this,"_workbookSelections",/* @__PURE__ */new Map),this._instanceSrv=e,this._init()}get _currentSelectionPos(){let e=this._instanceSrv.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!e)return null;let t=e.getActiveSheet();return{unitId:e.getUnitId(),sheetId:t.getSheetId()}}get currentSelectionParam(){return this._currentSelectionPos}_init(){let e=this._instanceSrv.getCurrentTypeOfUnit$(c.UniverInstanceType.UNIVER_SHEET).pipe((0,v.shareReplay)(1),(0,b.takeUntil)(this.dispose$));this.selectionMoveStart$=e.pipe((0,w.switchMap)(e=>e?this._ensureWorkbookSelection(e.getUnitId()).selectionMoveStart$:(0,f.of)())),this.selectionMoving$=e.pipe((0,w.switchMap)(e=>e?this._ensureWorkbookSelection(e.getUnitId()).selectionMoving$:(0,f.of)())),this.selectionMoveEnd$=e.pipe((0,w.switchMap)(e=>e?this._ensureWorkbookSelection(e.getUnitId()).selectionMoveEnd$:(0,f.of)([]))),this._instanceSrv.getTypeOfUnitDisposed$(c.UniverInstanceType.UNIVER_SHEET).pipe((0,b.takeUntil)(this.dispose$)).subscribe(e=>{this._removeWorkbookSelection(e.getUnitId())})}clear(){this._workbookSelections.forEach(e=>e.clear())}getCurrentSelections(){return this._getCurrentSelections()}getCurrentLastSelection(){let e=this._getCurrentSelections();return null==e?void 0:e[e.length-1]}addSelections(e,t,n){if("string"==typeof e){this._ensureWorkbookSelection(e).addSelections(t,n);return}let r=this._currentSelectionPos;if(!r)throw Error("[SheetsSelectionsService]: cannot find current selection position!");let{unitId:o,sheetId:i}=r;this._ensureWorkbookSelection(o).addSelections(i,e)}setSelections(e,t,n,r){if("string"==typeof e){this._ensureWorkbookSelection(e).setSelections(t,n,null!=r?r:2);return}let o=this._currentSelectionPos;if(!o)throw Error("[SheetsSelectionsService]: cannot find current selection position!");let{unitId:i,sheetId:s}=o;this._ensureWorkbookSelection(i).setSelections(s,null!=e?e:n,null!=t?t:2)}clearCurrentSelections(){this._getCurrentSelections().splice(0)}isOverlapping(){let e=this.getCurrentSelections();return null!=e&&e.some(({range:t},n)=>e.some(({range:e},r)=>n!==r&&t.startRow<=e.endRow&&t.endRow>=e.startRow&&t.startColumn<=e.endColumn&&t.endColumn>=e.startColumn))}_getCurrentSelections(){let e=this._currentSelectionPos;if(!e)return[];let{unitId:t,sheetId:n}=e;return this._ensureWorkbookSelection(t).getSelectionOfWorksheet(n)}getWorkbookSelections(e){return this._ensureWorkbookSelection(e)}_ensureWorkbookSelection(e){let t=this._workbookSelections.get(e);if(!t){let n=this._instanceSrv.getUnit(e);if(!n)throw Error(`[SheetsSelectionsService]: cannot resolve unit with id "${e}"!`);t=new B(n),this._workbookSelections.set(e,t)}return t}_removeWorkbookSelection(e){this._workbookSelections.delete(e)}},"SheetsSelectionsService"),D);j=V([$(0,c.IUniverInstanceService)],j);let L=class extends c.Disposable{constructor(e){super(),E(this,"_selectionMoveStart$",new S.Subject),E(this,"selectionMoveStart$",this._selectionMoveStart$.asObservable()),E(this,"_selectionMoving$",new S.Subject),E(this,"selectionMoving$",this._selectionMoving$.asObservable()),E(this,"_selectionMoveEnd$",new g.BehaviorSubject([])),E(this,"selectionMoveEnd$",this._selectionMoveEnd$.asObservable()),E(this,"_selectionSet$",new g.BehaviorSubject([])),E(this,"selectionSet$",this._selectionSet$.asObservable()),E(this,"_beforeSelectionMoveEnd$",new g.BehaviorSubject([])),E(this,"beforeSelectionMoveEnd$",this._beforeSelectionMoveEnd$.asObservable()),E(this,"_worksheetSelections",/* @__PURE__ */new Map),this._workbook=e}dispose(){super.dispose(),this._beforeSelectionMoveEnd$.complete(),this._selectionMoveEnd$.complete(),this._selectionMoving$.complete(),this._selectionMoveStart$.complete()}clear(){this._worksheetSelections.clear(),this._emitOnEnd([])}addSelections(e,t){let n=this._ensureSheetSelection(e);n.push(...t),this._emitOnEnd(n)}setSelections(e,t=[],n){switch(this._ensureSheetSelection(e).length=0,this._ensureSheetSelection(e).push(...t),n){case 0:this._selectionMoveStart$.next(t);break;case 1:this._selectionMoving$.next(t);break;case 2:default:this._emitOnEnd(t);break;case 3:this._selectionSet$.next(t)}}getCurrentSelections(){return this._getCurrentSelections()}getSelectionOfWorksheet(e){return this._worksheetSelections.has(e)?this._worksheetSelections.get(e):[]}_getCurrentSelections(){return this.getSelectionOfWorksheet(this._workbook.getActiveSheet().getSheetId())}getCurrentLastSelection(){let e=this._getCurrentSelections();return e[e.length-1]}_ensureSheetSelection(e){let t=this._worksheetSelections.get(e);return t||(t=[],this._worksheetSelections.set(e,t)),t}_emitOnEnd(e){this._beforeSelectionMoveEnd$.next(e),this._selectionMoveEnd$.next(e)}};_(L,"WorkbookSelections");let B=L,H="DISABLE_NORMAL_SELECTIONS",F={CELL_CONTENT:(0,c.createInterceptorKey)("CELL_CONTENT"),ROW_FILTERED:(0,c.createInterceptorKey)("ROW_FILTERED")};var G,q=((i=q||{})[i.DATA_VALIDATION=9]="DATA_VALIDATION",i[i.NUMFMT=10]="NUMFMT",i),z=Object.defineProperty,Y=Object.getOwnPropertyDescriptor,J=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?Y(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&z(t,n,i),i},"__decorateClass$f"),K=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$f");let X=(G=class extends c.Disposable{constructor(e){super(),E(this,"_interceptorsByName",/* @__PURE__ */new Map),E(this,"_commandInterceptors",[]),E(this,"_rangeInterceptors",[]),E(this,"_beforeCommandInterceptor",[]),E(this,"_workbookDisposables",/* @__PURE__ */new Map),E(this,"_worksheetDisposables",/* @__PURE__ */new Map),this._univerInstanceService=e,this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(c.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{this._interceptWorkbook(e)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(c.UniverInstanceType.UNIVER_SHEET).subscribe(e=>this._disposeWorkbookInterceptor(e))),this.intercept(F.CELL_CONTENT,{priority:-1,effect:c.InterceptorEffectEnum.Style|c.InterceptorEffectEnum.Value,handler(e,t){let n=t.worksheet.getCellRaw(t.row,t.col);return e?{...n,...e}:n}})}dispose(){super.dispose(),this._workbookDisposables.forEach(e=>e.dispose()),this._workbookDisposables.clear(),this._worksheetDisposables.clear()}interceptCommand(e){if(this._commandInterceptors.includes(e))throw Error("[SheetInterceptorService]: Interceptor already exists!");return this._commandInterceptors.push(e),this._commandInterceptors.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)}),this.disposeWithMe((0,c.toDisposable)(()=>(0,c.remove)(this._commandInterceptors,e)))}interceptBeforeCommand(e){if(this._beforeCommandInterceptor.includes(e))throw Error("[SheetInterceptorService]: Interceptor already exists!");return this._beforeCommandInterceptor.push(e),this._beforeCommandInterceptor.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)}),this.disposeWithMe((0,c.toDisposable)(()=>(0,c.remove)(this._beforeCommandInterceptor,e)))}async beforeCommandExecute(e){return(await Promise.all(this._beforeCommandInterceptor.map(t=>t.performCheck(e)))).every(e=>e)}interceptRanges(e){if(this._rangeInterceptors.includes(e))throw Error("[SheetInterceptorService]: Interceptor already exists!");return this._rangeInterceptors.push(e),this._rangeInterceptors.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)}),this.disposeWithMe((0,c.toDisposable)(()=>(0,c.remove)(this._rangeInterceptors,e)))}onCommandExecute(e){let t=this._commandInterceptors.map(t=>t.getMutations(e));return{preUndos:t.map(e=>{var t;return null!=(t=e.preUndos)?t:[]}).flat(),undos:t.map(e=>e.undos).flat(),preRedos:t.map(e=>{var t;return null!=(t=e.preRedos)?t:[]}).flat(),redos:t.map(e=>e.redos).flat()}}generateMutationsByRanges(e){let t=this._rangeInterceptors.map(t=>t.getMutations(e));return{preUndos:t.map(e=>{var t;return null!=(t=e.preUndos)?t:[]}).flat(),undos:t.map(e=>e.undos).flat(),preRedos:t.map(e=>{var t;return null!=(t=e.preRedos)?t:[]}).flat(),redos:t.map(e=>e.redos).flat()}}intercept(e,t){this._interceptorsByName.has(e)||this._interceptorsByName.set(e,[]);let n=this._interceptorsByName.get(e);n.push(t);let r=n.sort((e,t)=>{var n,r;return(null!=(n=t.priority)?n:0)-(null!=(r=e.priority)?r:0)});return e===F.CELL_CONTENT?(this._interceptorsByName.set(`${e}-${c.InterceptorEffectEnum.Style|c.InterceptorEffectEnum.Value}`,r),this._interceptorsByName.set(`${e}-${c.InterceptorEffectEnum.Style}`,r.filter(e=>((e.effect||3)&c.InterceptorEffectEnum.Style)>0)),this._interceptorsByName.set(`${e}-${c.InterceptorEffectEnum.Value}`,r.filter(e=>((e.effect||3)&c.InterceptorEffectEnum.Value)>0))):this._interceptorsByName.set(e,r),this.disposeWithMe((0,c.toDisposable)(()=>(0,c.remove)(this._interceptorsByName.get(e),t)))}fetchThroughInterceptors(e,t){let n=void 0===t?e:`${e}-${t}`,r=this._interceptorsByName.get(n);return(0,c.composeInterceptors)(r||[])}_interceptWorkbook(e){let t=new c.DisposableCollection,n=e.getUnitId(),r=this,o=/* @__PURE__ */_(t=>{let o=t.getSheetId();t.__interceptViewModel(i=>{let s=new c.DisposableCollection;r._worksheetDisposables.set(Z(n,t),s),s.add(i.registerCellContentInterceptor({getCell(i,s,a){let l=t.getCellRaw(i,s);return r.fetchThroughInterceptors(F.CELL_CONTENT,a)(l,{unitId:n,subUnitId:o,row:i,col:s,worksheet:t,workbook:e,rawData:l})}})),s.add(i.registerRowFilteredInterceptor({getRowFiltered:i=>!!r.fetchThroughInterceptors(F.ROW_FILTERED)(!1,{unitId:n,subUnitId:o,row:i,workbook:e,worksheet:t})}))})},"interceptViewModel");e.getSheets().forEach(e=>o(e)),t.add(e.sheetCreated$.subscribe(e=>o(e))),t.add((0,c.toDisposable)(()=>e.getSheets().forEach(e=>this._disposeSheetInterceptor(n,e)))),t.add(e.sheetDisposed$.subscribe(e=>this._disposeSheetInterceptor(n,e))),this._workbookDisposables.set(n,t)}_disposeWorkbookInterceptor(e){let t=e.getUnitId(),n=this._workbookDisposables.get(t);n&&(n.dispose(),this._workbookDisposables.delete(t))}_disposeSheetInterceptor(e,t){let n=Z(e,t),r=this._worksheetDisposables.get(n);r&&(r.dispose(),this._worksheetDisposables.delete(n))}},_(G,"SheetInterceptorService"),G);function Z(e,t){return`${e}|${t.getSheetId()}`}function Q(e,t,n){var r;let o=e.getStyleByCell(t);null==o&&delete t.s,"string"==typeof n.s&&(n.s=e.get(n.s));let i=en(o,n.s?n.s:null);i&&(0,c.Tools).removeNull(i),(0,c.Tools).isEmptyObject(i)?delete t.s:t.s=e.setValue(i);let s=n.v?`${n.v}\r
`:"";!n.p&&t.p&&(s&&s!==(null==(r=t.p.body)?void 0:r.dataStream)?delete t.p:eo(t.p,n.s?n.s:null))}function ee(e,t){if(!t||!Object.keys(t).length)return e;let n=e||{};for(let e in t)"bd"===e?n[e]=et(n[e]||{},t[e]):e in n||(n[e]=null);return n}function et(e,t){if(!t||!Object.keys(t).length)return e;for(let n in t)n in e||(e[n]=null);return e}function en(e,t,n=!1){if(null===t)return t;if(void 0===t)return e;let r=(0,c.Tools).deepClone(e)||{};for(let e in t)n&&["bd","tr","td","ht","vt","tb","pd","bg"].includes(e)||(e in r&&"bd"===e?r[e]=Object.assign(r[e],t[e]):r[e]=t[e]);return"cl"in r&&("ul"in r&&r.ul&&(r.ul.cl=r.cl),"ol"in r&&r.ol&&(r.ol.cl=r.cl),"st"in r&&r.st&&(r.st.cl=r.cl)),r}function er(e,t){return e.some(e=>e.startIndex===t)?er(e,t+1):t}function eo(e,t){var n;if(null==e.body)return;Array.isArray(e.body.textRuns)||(e.body.textRuns=[]);let r=0,o=[],i=(null==(n=e.body)?void 0:n.paragraphs)||[];for(let n of e.body.textRuns){let{st:e,ed:s,ts:a={}}=n;if(r<e){let n={st:r,ed:e},i=en({},t,!0);i&&(0,c.Tools).removeNull(i),(0,c.Tools).isEmptyObject(i)||(n.ts=i),o.push(n)}let l=en(a,t,!0);l&&(0,c.Tools).removeNull(l),(0,c.Tools).isEmptyObject(l)?delete n.ts:n.ts=l,o.push(n),r=er(i,s)}let s=e.body.dataStream.endsWith(`\r
`)?e.body.dataStream.length-2:e.body.dataStream.length;if(r<s){let e={st:r,ed:s},n=en({},t,!0);n&&(0,c.Tools).removeNull(n),(0,c.Tools).isEmptyObject(n)||(e.ts=n),o.push(e)}e.body.textRuns=(0,c.normalizeTextRuns)(o)}function ei(e,t,n){if(t.t)return t.t;if(null===t.v)return null;let r=e.getStyleByCell(t),o=e.getStyleByCell(n);if(n.t===c.CellValueType.FORCE_STRING){if(!el(o)&&void 0!==t.v){if((0,c.isRealNum)(t.v))return c.CellValueType.NUMBER;if((0,c.isBooleanString)(`${t.v}`))return c.CellValueType.BOOLEAN}return c.CellValueType.FORCE_STRING}return ea(r)?el(r)?c.CellValueType.STRING:es(t,n):el(o)?c.CellValueType.STRING:es(t,n)}function es(e,t){return void 0!==e.v?eu(e.v,e.t):eu(t.v,t.t)}function ea(e){var t;return!!(null!=(t=null==e?void 0:e.n)&&t.pattern)}function el(e){var t;return(null==(t=null==e?void 0:e.n)?void 0:t.pattern)===y.DEFAULT_TEXT_FORMAT}function eu(e,t){return null===e?null:"string"==typeof e?(0,c.isRealNum)(e)?(0==+e||1==+e)&&t===c.CellValueType.BOOLEAN?c.CellValueType.BOOLEAN:c.CellValueType.NUMBER:(0,c.isBooleanString)(e)?c.CellValueType.BOOLEAN:c.CellValueType.STRING:"number"==typeof e?(0===e||1===e)&&t===c.CellValueType.BOOLEAN?c.CellValueType.BOOLEAN:c.CellValueType.NUMBER:"boolean"==typeof e?c.CellValueType.BOOLEAN:c.CellValueType.FORCE_STRING}function ed(e,t){return e===c.CellValueType.NUMBER?Number(t.v):e===c.CellValueType.BOOLEAN?ec(t.v)?1:0:e===c.CellValueType.STRING||e===c.CellValueType.FORCE_STRING?`${t.v}`:t.v}function ec(e){if("string"==typeof e){if("TRUE"===e.toUpperCase())return!0;if("FALSE"===e.toUpperCase())return!1;if((0,c.isSafeNumeric)(e)){if(0===Number(e))return!1;if(1===Number(e))return!0}}if("number"==typeof e){if(0===e)return!1;if(1===e)return!0}return"boolean"==typeof e?e:null}function eh(e){return null==e?null:(void 0===e.f&&(e.f=null),void 0===e.si&&(e.si=null),void 0===e.p&&(e.p=null),void 0===e.v&&(e.v=null),void 0===e.t&&(e.t=null),void 0===e.s&&(e.s=null),void 0===e.custom&&(e.custom=null),e)}X=J([K(0,c.IUniverInstanceService)],X),_(Z,"getWorksheetDisposableID"),_(Q,"handleStyle"),_(ee,"transformStyle"),_(et,"transformBorders"),_(en,"mergeStyle"),_(er,"skipParagraphs"),_(eo,"mergeRichTextStyle"),_(ei,"getCellType"),_(es,"checkCellValueTypeByValue"),_(ea,"hasNumberFormat"),_(el,"isTextFormat"),_(eu,"checkCellValueType"),_(ed,"getCellValue"),_(ec,"extractBooleanValue"),_(eh,"setNull");let em=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,cellValue:o}=t,i=e.get(c.IUniverInstanceService).getUniverSheetInstance(n);if(null==i)throw Error("workbook is null error!");let s=i.getSheetBySheetId(r);if(null==s)throw Error("worksheet is null error!");let a=s.getCellMatrix(),l=i.getStyles(),u=new c.ObjectMatrix;return new(0,c.ObjectMatrix)(o).forValue((e,t,n)=>{let r=(0,c.Tools).deepClone(null==a?void 0:a.getValue(e,t))||{},o=l.getStyleByCell(r),i=l.getStyleByCell(n);r.s=ee(o,i),u.setValue(e,t,eh(r))}),{...t,options:{},cellValue:u.getMatrix()}},"SetRangeValuesUndoMutationFactory"),eg={id:"sheet.mutation.set-range-values",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{cellValue:n,subUnitId:r,unitId:o}=t,i=e.get(c.IUniverInstanceService).getUnit(o);if(!i)return!1;let s=i.getSheetBySheetId(r);if(!s)return!1;let a=s.getCellMatrix(),l=i.getStyles();return new(0,c.ObjectMatrix)(n).forValue((e,t,n)=>{if(n){let r=a.getValue(e,t)||{},o=ei(l,n,r);void 0!==n.f&&(r.f=n.f),void 0!==n.si&&(r.si=n.si),void 0!==n.p&&(r.p=n.p),void 0!==n.v&&(r.v=ed(o,n)),void 0!==r.v&&(r.t=o,r.v=ed(o,r)),void 0!==n.s&&Q(l,r,n),void 0!==n.custom&&(r.custom=n.custom),a.setValue(e,t,(0,c.Tools).removeNull(r))}else null==a||a.setValue(e,t,{})}),!0},"handler")},ep=/* @__PURE__ */_((e,t,n="")=>e.reduce((e,r)=>{let o=r&&r[t];return"string"!=typeof o?console.warn(r,`${t} is not string`):o?(e[o]||(e[o]=[]),e[o].push(r)):e[n].push(r),e},{}),"groupByKey"),eI=/* @__PURE__ */_((e=0)=>{let t=e;return /* @__PURE__ */_(function(){return t++},"getKey")},"createUniqueKey");function eC(e){let t=new c.ObjectMatrix;return e.forEach(e=>{let{startRow:n,startColumn:r,endRow:o,endColumn:i}=e;for(let e=n;e<=o;e++)for(let n=r;n<=i;n++)t.setValue(e,n,null)}),t.clone()}function eR(e){let t=new c.ObjectMatrix;return e.forEach(e=>{let{startRow:n,startColumn:r,endRow:o,endColumn:i}=e;for(let e=n;e<=o;e++)for(let n=r;n<=i;n++)t.setValue(e,n,{v:null,p:null,f:null,si:null,custom:null})}),t.clone()}function ef(e){let t=new c.ObjectMatrix;return e.forEach(e=>{let{startRow:n,startColumn:r,endRow:o,endColumn:i}=e;for(let e=n;e<=o;e++)for(let n=r;n<=i;n++)t.setValue(e,n,{s:null})}),t.clone()}_(eC,"generateNullCell"),_(eR,"generateNullCellValue"),_(ef,"generateNullCellStyle");let ev={id:"sheet.command.clear-selection-all",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(c.IUniverInstanceService),r=e.get(c.ICommandService),o=e.get(j),i=e.get(c.IUndoRedoService),s=e.get(X),a=n.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getUnitId(),u=a.getActiveSheet();if(!u)return!1;let d=u.getSheetId(),h=null==(t=o.getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=h&&h.length))return!1;let m=[],g=[],p={subUnitId:d,unitId:l,cellValue:eC(h)},I=em(e,p);m.push({id:eg.id,params:p}),g.push({id:eg.id,params:I});let C=s.onCommandExecute({id:ev.id});return m.push(...C.redos),g.unshift(...C.undos),!!(0,c.sequenceExecute)(m,r)&&(i.pushUndoRedo({unitID:l,undoMutations:g,redoMutations:m}),!0)},"handler")},eS={id:"sheet.command.clear-selection-content",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(c.IUniverInstanceService),r=e.get(c.ICommandService),o=e.get(j),i=e.get(c.IUndoRedoService),s=e.get(X),a=n.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getUnitId(),u=a.getActiveSheet();if(!u)return!1;let d=u.getSheetId(),h=null==(t=o.getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=h&&h.length))return!1;let m={subUnitId:d,unitId:l,cellValue:eR(h)},g=em(e,m),p=s.onCommandExecute({id:eS.id}),I=[{id:eg.id,params:m},...p.redos],C=[...p.undos,{id:eg.id,params:g}];return!!(0,c.sequenceExecute)(I,r).result&&(i.pushUndoRedo({unitID:l,undoMutations:C,redoMutations:I}),!0)},"handler")},ew={id:"sheet.command.clear-selection-format",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(c.IUniverInstanceService),r=e.get(c.ICommandService),o=e.get(j),i=e.get(c.IUndoRedoService),s=e.get(X),a=n.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getUnitId(),u=a.getActiveSheet();if(!u)return!1;let d=u.getSheetId(),h=null==(t=o.getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=h&&h.length))return!1;let m=[],g=[],p={subUnitId:d,unitId:l,cellValue:ef(h)},I=em(e,p);m.push({id:eg.id,params:p}),g.push({id:eg.id,params:I});let C=s.onCommandExecute({id:ew.id});return m.push(...C.redos),g.unshift(...C.undos),!!(0,c.sequenceExecute)(m,r)&&(i.pushUndoRedo({unitID:l,undoMutations:g,redoMutations:m}),!0)},"handler")},eb=/* @__PURE__ */_((e,t)=>({subUnitId:t.sheet.id,unitId:t.unitId,subUnitName:t.sheet.name}),"InsertSheetUndoMutationFactory"),ey={id:"sheet.mutation.insert-sheet",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService),{sheet:r,index:o,unitId:i}=t,s=n.getUniverSheetInstance(i);return!!s&&s.addWorksheet(r.id,o,r)},"handler")};function eM(e,t){let{unitId:n}=t,r=n?e.getUniverSheetInstance(n):e.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);return r?{workbook:r,unitId:r.getUnitId()}:null}function eU(e,t={}){let{unitId:n,subUnitId:r}=t,o=n?e.getUniverSheetInstance(n):e.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!o)return null;let i=r?o.getSheetBySheetId(r):o.getActiveSheet(!0);return i?{worksheet:i,workbook:o,unitId:o.getUnitId(),subUnitId:i.getSheetId()}:null}function e_(e,t){let{unitId:n,subUnitId:r}=t,o=e.getUniverSheetInstance(n);if(!o)return null;let i=o.getSheetBySheetId(r);return i?{worksheet:i,workbook:o}:null}_(eM,"getSheetCommandTargetWorkbook"),_(eU,"getSheetCommandTarget"),_(e_,"getSheetMutationTarget");let eE=/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService),{subUnitId:r,unitId:o}=t,i=e_(n,t);if(!i)throw Error("[RemoveSheetUndoMutationFactory]: Worksheet is null error!");let{workbook:s,worksheet:a}=i,l=a.getConfig();return{index:s.getConfig().sheetOrder.findIndex(e=>e===r),sheet:l,unitId:o}},"RemoveSheetUndoMutationFactory"),eT={id:"sheet.mutation.remove-sheet",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService),{subUnitId:r,unitId:o}=t,i=n.getUniverSheetInstance(o);return!!i&&i.removeSheet(r)},"handler")},ek={type:c.CommandType.COMMAND,id:"sheet.command.copy-sheet",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(c.IUniverInstanceService),a=e.get(X),l=e.get(c.LocaleService),u=eU(s,t);if(!u)return!1;let{workbook:d,worksheet:h,unitId:m,subUnitId:g}=u,p=(0,c.Tools).deepClone(h.getConfig());p.name=ex(d,l,p.name),p.id=(0,c.Tools).generateRandomId();let I={index:d.getSheetIndex(h)+1,sheet:p,unitId:m},C=eb(e,I),R=a.onCommandExecute({id:ek.id,params:{unitId:m,subUnitId:g,targetSubUnitId:p.id}}),f=[...null!=(n=R.preRedos)?n:[],{id:ey.id,params:I},...R.redos],v=[...null!=(r=R.preUndos)?r:[],{id:eT.id,params:C},...R.undos];return!!(0,c.sequenceExecute)(f,o).result&&(i.pushUndoRedo({unitID:m,undoMutations:v,redoMutations:f}),!0)},"handler")};function ex(e,t,n){let r=n+t.t("sheets.tabs.sheetCopy",""),o=2;for(;e.checkSheetName(r);)r=n+t.t("sheets.tabs.sheetCopy",`${o}`),o++;return r}_(ex,"getCopyUniqueSheetName");let eN={id:"sheet.mutation.move-range",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{from:n,to:r}=t;if(!n||!r)return!1;let o=e.get(c.IUniverInstanceService).getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let i=o.getSheetBySheetId(t.from.subUnitId),s=o.getSheetBySheetId(t.to.subUnitId);if(!i||!s)return!1;let a=i.getCellMatrix(),l=s.getCellMatrix();return new(0,c.ObjectMatrix)(n.value).forValue((e,t,n)=>{a.setValue(e,t,n)}),new(0,c.ObjectMatrix)(r.value).forValue((e,t,n)=>{l.setValue(e,t,n)}),!0},"handler")};var eO=Object.defineProperty,eD=Object.getOwnPropertyDescriptor,eP=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?eD(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&eO(t,n,i),i},"__decorateClass$e"),eA=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$e");let eV=(0,c.createIdentifier)("sheets-formula.ref-selections.service"),e$=(_(o7=class extends j{constructor(e){super(e)}_init(){let e=this._getAliveWorkbooks$().pipe((0,b.takeUntil)(this.dispose$));this.selectionMoveStart$=e.pipe((0,w.switchMap)(e=>(0,R.merge)(...e.map(e=>e.selectionMoveStart$)))),this.selectionMoving$=e.pipe((0,w.switchMap)(e=>(0,R.merge)(...e.map(e=>e.selectionMoving$)))),this.selectionMoveEnd$=e.pipe((0,w.switchMap)(e=>(0,R.merge)(...e.map(e=>e.selectionMoveEnd$))))}_getAliveWorkbooks$(){let e=this._instanceSrv.getAllUnitsForType(c.UniverInstanceType.UNIVER_SHEET);e.forEach(e=>this._ensureWorkbookSelection(e.getUnitId()));let t=new g.BehaviorSubject(e);return this.disposeWithMe(this._instanceSrv.getTypeOfUnitAdded$(c.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{this._ensureWorkbookSelection(e.getUnitId()),t.next([...t.getValue(),e])})),this.disposeWithMe(this._instanceSrv.getTypeOfUnitDisposed$(c.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{this._removeWorkbookSelection(e.getUnitId()),t.next(t.getValue().filter(t=>t!==e))})),t.pipe((0,C.map)(e=>e.map(e=>this._ensureWorkbookSelection(e.getUnitId()))))}},"RefSelectionsService"),o7);function eW(e){let t=e.get(c.IContextService).getContextValue(H);return e.get(t?eV:j)}e$=eP([eA(0,c.IUniverInstanceService)],e$),_(eW,"getSelectionsService");let ej={id:"sheet.operation.set-selections",type:c.CommandType.OPERATION,handler:/* @__PURE__ */_((e,t)=>{if(!t)return!1;let{selections:n,type:r,unitId:o,subUnitId:i}=t;return eW(e).setSelections(o,i,[...n],r),!0},"handler")};function eL(e,t,n=!0){let r=t.getMatrixWithMergedCells(...(0,c.selectionToArray)(e)),o=[];if(r.forValue((t,n,r)=>{if(void 0!==r.colSpan&&void 0!==r.rowSpan){let i={startRow:t,startColumn:n,endRow:t+r.rowSpan-1,endColumn:n+r.colSpan-1};(0,c.Rectangle).contains(e,i)||o.push(i)}}),0===o.length)return e;let i=(0,c.Rectangle).union(e,...o);return n?eL(i,t,n):i}function eB(e,t,n){let r=null;return n.getMatrixWithMergedCells(e,t,e,t).forValue((e,t,n)=>(r={actualRow:e,actualColumn:t,startRow:e,startColumn:t,isMerged:void 0!==n.rowSpan||void 0!==n.colSpan,isMergedMainCell:void 0!==n.rowSpan&&void 0!==n.colSpan,endRow:e+(void 0!==n.rowSpan?n.rowSpan-1:0),endColumn:t+(void 0!==n.colSpan?n.colSpan-1:0),rangeType:c.RANGE_TYPE.NORMAL},!1)),r||{actualColumn:t,actualRow:e,startRow:e,startColumn:t,endRow:e,endColumn:t,isMerged:!1,isMergedMainCell:!1,rangeType:c.RANGE_TYPE.NORMAL}}function eH(e,t,n){let{startRow:r,startColumn:o,endRow:i,endColumn:s}=e;return Number.isNaN(r)&&(e.startRow=0),Number.isNaN(i)&&(e.endRow=t-1),Number.isNaN(o)&&(e.startColumn=0),Number.isNaN(s)&&(e.endColumn=n-1),e}function eF(e,t){let n=Number.isNaN(e.startRow)?0:e.startRow,r=Number.isNaN(e.startColumn)?0:e.startColumn,o=t.getMergedCell(n,r);return o?{...o,actualRow:n,actualColumn:r,rangeType:c.RANGE_TYPE.NORMAL,isMerged:!0,isMergedMainCell:!0}:{startRow:n,startColumn:r,endRow:e.startRow,endColumn:e.startColumn,actualRow:n,actualColumn:r,rangeType:c.RANGE_TYPE.NORMAL,isMerged:!1,isMergedMainCell:!1}}_(eL,"alignToMergedCellsBorders"),_(eB,"getCellAtRowCol"),_(eH,"setEndForRange"),_(eF,"getPrimaryForRange");let eG=/* @__PURE__ */_((e,t,n)=>({id:ej.id,params:{unitId:t.getUnitId(),subUnitId:n.getSheetId(),reveal:!0,selections:[{range:e,primary:eF(e,n)}]}}),"followSelectionOperation");function eq(e){if(!e)return!1;let{range:t,primary:n}=e;return(0,c.Rectangle).equals(t,n)}function ez(e){function t(t,n){function r(t){for(let r=t.startRow;r<=t.endRow;r++)if(!e.getRowFiltered(r))for(let e=t.startColumn;e<=t.endColumn;e++)n(r,e,t)}_(r,"iterate"),r(t)}return _(t,"forOperableEach"),{forOperableEach:t}}function eY(e,t,n,r,o,i,s){let a={};for(let l=t;l<=n;l++)for(let t=r;t<=o;t++){let n=i?e.getCell(s,t):e.getCell(l,s);n&&n.s&&(a[l]||(a[l]={}),a[l][t]={s:n.s})}return a}_(eq,"isSingleCellSelection"),_(ez,"createRangeIteratorWithSkipFilteredRows"),_(eY,"copyRangeStyles");let eJ="sheet.command.move-range",eK={type:c.CommandType.COMMAND,id:eJ,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(c.IUniverInstanceService),a=e.get(c.ErrorService),l=e.get(c.LocaleService),u=e.get(X),d=eU(s);if(!d||!await u.beforeCommandExecute({id:eK.id,params:t}))return!1;let{worksheet:h,subUnitId:m,unitId:g}=d,p=eX(e,{unitId:g,subUnitId:m,range:t.fromRange},{unitId:g,subUnitId:m,range:t.toRange});if(null===p)return a.emit(l.t("sheets.info.acrossMergedCell")),!1;let I=u.onCommandExecute({id:eK.id,params:{...t}}),C=[...null!=(n=I.preRedos)?n:[],...p.redos,...I.redos,{id:ej.id,params:{unitId:g,subUnitId:m,selections:[{range:t.toRange,primary:eF(t.toRange,h)}]}}],R=[...null!=(r=I.preUndos)?r:[],...p.undos,...I.undos,{id:ej.id,params:{unitId:g,subUnitId:m,selections:[{range:t.fromRange,primary:eF(t.fromRange,h)}]}}];return!!(0,c.sequenceExecute)(C,o).result&&(i.pushUndoRedo({unitID:g,undoMutations:R,redoMutations:C}),!0)},"handler")};function eX(e,t,n,r=!1){let o=[],i=[],{range:s,subUnitId:a,unitId:l}=t,{range:u,subUnitId:d}=n,h=e.get(c.IUniverInstanceService).getUniverSheetInstance(l),m=null==h?void 0:h.getSheetBySheetId(d),g=null==h?void 0:h.getSheetBySheetId(a),p=null==m?void 0:m.getCellMatrix(),I=null==g?void 0:g.getCellMatrix();if(m&&g&&p&&I){let e=eL(u,m,!1);if(!(0,c.Rectangle).equals(u,e)&&!r)return null;let g=new c.ObjectMatrix,C=new c.ObjectMatrix,R=new c.ObjectMatrix;(0,c.Range).foreach(s,(e,t)=>{let n=I.getValue(e,t);if(g.setValue(e,t,(0,c.Tools).deepClone(n)),n){let r=null==h?void 0:h.getStyles().get(n.s);R.setValue(e,t,(0,c.Tools).deepClone(r))}C.setValue(e,t,null)});let f=new c.ObjectMatrix,v=new c.ObjectMatrix;(0,c.Range).foreach(u,(e,t)=>{f.setValue(e,t,(0,c.Tools).deepClone(p.getValue(e,t)))}),(0,c.Range).foreach(s,(e,t)=>{let n=(0,c.cellToRange)(e,t),r=(0,c.Rectangle).getRelativeRange(n,s),o=(0,c.Rectangle).getPositionRange(r,u),i=(0,c.Tools).deepClone(R.getValue(e,t)),a=(0,c.Tools).deepClone(g.getValue(e,t));a&&i&&(a.s=i),v.setValue(o.startRow,o.startColumn,a)});let S={fromRange:t.range,toRange:n.range,from:{value:C.getMatrix(),subUnitId:a},to:{value:v.getMatrix(),subUnitId:d},unitId:l},w={fromRange:n.range,toRange:t.range,from:{value:g.getMatrix(),subUnitId:a},to:{value:f.getMatrix(),subUnitId:d},unitId:l};o.push({id:eN.id,params:S}),i.push({id:eN.id,params:w})}return{redos:o,undos:i}}_(eX,"getMoveRangeUndoRedoMutations");var eZ=((s=eZ||{})[s.UNIVER_UNKNOWN=0]="UNIVER_UNKNOWN",s[s.UNIVER_DOC=1]="UNIVER_DOC",s[s.UNIVER_SHEET=2]="UNIVER_SHEET",s[s.UNIVER_SLIDE=3]="UNIVER_SLIDE",s[s.UNIVER_PROJECT=4]="UNIVER_PROJECT",s[s.UNRECOGNIZED=-1]="UNRECOGNIZED",s),eQ=((a=eQ||{})[a.View=0]="View",a[a.Edit=1]="Edit",a[a.ManageCollaborator=2]="ManageCollaborator",a[a.Print=3]="Print",a[a.Duplicate=4]="Duplicate",a[a.Comment=5]="Comment",a[a.Copy=6]="Copy",a[a.Share=7]="Share",a[a.Export=8]="Export",a[a.MoveWorksheet=9]="MoveWorksheet",a[a.DeleteWorksheet=10]="DeleteWorksheet",a[a.HideWorksheet=11]="HideWorksheet",a[a.RenameWorksheet=12]="RenameWorksheet",a[a.CreateWorksheet=13]="CreateWorksheet",a[a.SetWorksheetStyle=14]="SetWorksheetStyle",a[a.EditWorksheetCell=15]="EditWorksheetCell",a[a.InsertHyperlink=16]="InsertHyperlink",a[a.Sort=17]="Sort",a[a.Filter=18]="Filter",a[a.PivotTable=19]="PivotTable",a[a.FloatImg=20]="FloatImg",a[a.History=21]="History",a[a.RwHgtClWdt=22]="RwHgtClWdt",a[a.ViemRwHgtClWdt=23]="ViemRwHgtClWdt",a[a.ViewFilter=24]="ViewFilter",a[a.MoveSheet=25]="MoveSheet",a[a.DeleteSheet=26]="DeleteSheet",a[a.HideSheet=27]="HideSheet",a[a.CopySheet=28]="CopySheet",a[a.RenameSheet=29]="RenameSheet",a[a.CreateSheet=30]="CreateSheet",a[a.SelectProtectedCells=31]="SelectProtectedCells",a[a.SelectUnProtectedCells=32]="SelectUnProtectedCells",a[a.SetCellStyle=33]="SetCellStyle",a[a.SetCellValue=34]="SetCellValue",a[a.SetRowStyle=35]="SetRowStyle",a[a.SetColumnStyle=36]="SetColumnStyle",a[a.InsertRow=37]="InsertRow",a[a.InsertColumn=38]="InsertColumn",a[a.DeleteRow=39]="DeleteRow",a[a.DeleteColumn=40]="DeleteColumn",a[a.EditExtraObject=41]="EditExtraObject",a[a.Delete=42]="Delete",a[a.RecoverHistory=43]="RecoverHistory",a[a.ViewHistory=44]="ViewHistory",a[a.CreatePermissionObject=45]="CreatePermissionObject",a[a.UNRECOGNIZED=-1]="UNRECOGNIZED",a),e0=((l=e0||{})[l.Unkonwn=0]="Unkonwn",l[l.Workbook=1]="Workbook",l[l.Worksheet=2]="Worksheet",l[l.SelectRange=3]="SelectRange",l[l.Document=4]="Document",l[l.Slide=5]="Slide",l[l.UNRECOGNIZED=-1]="UNRECOGNIZED",l);let e1=class{constructor(e,t,n){E(this,"type",e0.SelectRange),E(this,"subType",eQ.Edit),E(this,"status",c.PermissionStatus.INIT),E(this,"value",!0),E(this,"id"),E(this,"unitId"),E(this,"subUnitId"),E(this,"permissionId"),this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${e0.SelectRange}.${eQ.Edit}.${n}`}};_(e1,"RangeProtectionPermissionEditPoint");let e2=e1,e5=class{constructor(e,t,n){E(this,"type",e0.SelectRange),E(this,"subType",eQ.View),E(this,"status",c.PermissionStatus.INIT),E(this,"value",!0),E(this,"id"),E(this,"unitId"),E(this,"subUnitId"),E(this,"permissionId"),this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${e0.SelectRange}.${eQ.View}.${n}`}};_(e5,"RangeProtectionPermissionViewPoint");let e3=e5,e4=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.Comment),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.Comment}_${e}`}};_(e4,"WorkbookCommentPermission");let e6=e4,e7=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.Copy),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.Copy}_${e}`}};_(e7,"WorkbookCopyPermission");let e8=e7,e9=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"subType",eQ.CopySheet),E(this,"status",c.PermissionStatus.INIT),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.CopySheet}_${e}`}};_(e9,"WorkbookCopySheetPermission");let te=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.CreatePermissionObject),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.CreatePermissionObject}_${e}`}};_(te,"WorkbookCreateProtectPermission");let tt=te,tn=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.CreateSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.CreateSheet}_${e}`}};_(tn,"WorkbookCreateSheetPermission");let tr=tn,to=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.DeleteSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.DeleteSheet}_${e}`}};_(to,"WorkbookDeleteSheetPermission");let ti=to,ts=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.Duplicate),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.Duplicate}_${e}`}};_(ts,"WorkbookDuplicatePermission");let ta=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.Edit),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.Edit}_${e}`}};_(ta,"WorkbookEditablePermission");let tl=ta,tu=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.Export),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.Export}_${e}`}};_(tu,"WorkbookExportPermission");let td=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.HideSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.HideSheet}_${e}`}};_(td,"WorkbookHideSheetPermission");let tc=td;_(class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.History),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.History}_${e}`}},"WorkbookHistoryPermission");let th=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.ManageCollaborator),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.ManageCollaborator}_${e}`}};_(th,"WorkbookManageCollaboratorPermission");let tm=th,tg=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.MoveSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.MoveSheet}_${e}`}};_(tg,"WorkbookMoveSheetPermission");let tp=tg,tI=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.Print),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.Print}_${e}`}};_(tI,"WorkbookPrintPermission");let tC=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.RecoverHistory),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.RecoverHistory}_${e}`}};_(tC,"WorkbookRecoverHistoryPermission");let tR=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.RenameSheet),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.RenameSheet}_${e}`}};_(tR,"WorkbookRenameSheetPermission");let tf=tR,tv=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.Share),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.Share}_${e}`}};_(tv,"WorkbookSharePermission");let tS=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.View),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.View}_${e}`}};_(tS,"WorkbookViewPermission");let tw=tS,tb=class{constructor(e){E(this,"id"),E(this,"value",!0),E(this,"type",e0.Workbook),E(this,"status",c.PermissionStatus.INIT),E(this,"subType",eQ.ViewHistory),this.unitId=e,this.unitId=e,this.id=`${this.type}.${eQ.ViewHistory}_${e}`}};_(tb,"WorkbookViewHistoryPermission");let ty=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.Copy),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.Copy}_${e}_${t}`}};_(ty,"WorksheetCopyPermission");let tM=ty,tU=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.DeleteColumn),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.DeleteColumn}_${e}_${t}`}};_(tU,"WorksheetDeleteColumnPermission");let t_=tU,tE=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.Delete),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.Delete}_${e}_${t}`}};_(tE,"WorksheetDeleteProtectionPermission");let tT=tE,tk=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.DeleteRow),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.DeleteRow}_${e}_${t}`}};_(tk,"WorksheetDeleteRowPermission");let tx=tk,tN=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.Edit),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.Edit}_${e}_${t}`}};_(tN,"WorksheetEditPermission");let tO=tN,tD=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.EditExtraObject),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.EditExtraObject}_${e}_${t}`}};_(tD,"WorksheetEditExtraObjectPermission");let tP=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.Filter),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.Filter}_${e}_${t}`}};_(tP,"WorksheetFilterPermission");let tA=tP,tV=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.InsertColumn),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.InsertColumn}_${e}_${t}`}};_(tV,"WorksheetInsertColumnPermission");let t$=tV,tW=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.InsertHyperlink),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.InsertHyperlink}_${e}_${t}`}};_(tW,"WorksheetInsertHyperlinkPermission");let tj=tW,tL=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.InsertRow),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.InsertRow}_${e}_${t}`}};_(tL,"WorksheetInsertRowPermission");let tB=tL,tH=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.ManageCollaborator),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.ManageCollaborator}_${e}_${t}`}};_(tH,"WorksheetManageCollaboratorPermission");let tF=tH,tG=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.PivotTable),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.PivotTable}_${e}_${t}`}};_(tG,"WorksheetPivotTablePermission"),_(class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.SelectProtectedCells),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.SelectProtectedCells}_${e}_${t}`}},"WorksheetSelectProtectedCellsPermission"),_(class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.SelectUnProtectedCells),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.SelectUnProtectedCells}_${e}_${t}`}},"WorksheetSelectUnProtectedCellsPermission");let tq=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.SetCellStyle),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.SetCellStyle}_${e}_${t}`}};_(tq,"WorksheetSetCellStylePermission");let tz=tq,tY=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.SetCellValue),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.SetCellValue}_${e}_${t}`}};_(tY,"WorksheetSetCellValuePermission");let tJ=tY,tK=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.SetColumnStyle),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.SetColumnStyle}_${e}_${t}`}};_(tK,"WorksheetSetColumnStylePermission");let tX=tK,tZ=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.SetRowStyle),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.SetRowStyle}_${e}_${t}`}};_(tZ,"WorksheetSetRowStylePermission");let tQ=tZ,t0=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.Sort),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.Sort}_${e}_${t}`}};_(t0,"WorksheetSortPermission");let t1=class{constructor(e,t){E(this,"value",!0),E(this,"type",e0.Worksheet),E(this,"status",c.PermissionStatus.INIT),E(this,"id"),E(this,"subType",eQ.View),this.unitId=e,this.subUnitId=t,this.id=`${this.type}.${eQ.View}_${e}_${t}`}};_(t1,"WorksheetViewPermission");let t2=t1,t5={id:"sheet.command.set-range-values",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n;let r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(c.IUniverInstanceService),a=e.get(j),l=e.get(X),u=e.get(c.IPermissionService),d=eU(s,t);if(!d)return!1;let{subUnitId:h,unitId:m,workbook:g,worksheet:p}=d,{value:I,range:C}=t,R=C?[C]:null==(n=a.getCurrentSelections())?void 0:n.map(e=>e.range);if(!R||!R.length||!u.getPermissionPoint(new tO(m,h).id))return!1;let f=new c.ObjectMatrix;if((0,c.Tools).isArray(I))for(let e=0;e<R.length;e++){let{startRow:t,startColumn:n,endRow:r,endColumn:o}=R[e];for(let e=0;e<=r-t;e++)for(let r=0;r<=o-n;r++)f.setValue(e+t,r+n,I[e][r])}else if((0,c.isICellData)(I))for(let e=0;e<R.length;e++){let{startRow:t,startColumn:n,endRow:r,endColumn:o}=R[e];for(let e=t;e<=r;e++)for(let t=n;t<=o;t++)f.setValue(e,t,I)}else r=I;let v={subUnitId:h,unitId:m,cellValue:null!=r?r:f.getMatrix()},S=em(e,v);if(!o.syncExecuteCommand(eg.id,v))return!1;let{undos:w,redos:b}=l.onCommandExecute({id:t5.id,params:{...v,range:R}});if((0,c.sequenceExecute)([...b],o).result){let e=eG(null!=C?C:f.getRange(),g,p);return i.pushUndoRedo({unitID:m,undoMutations:[{id:eg.id,params:S},...w,e],redoMutations:[{id:eg.id,params:v},...b,(0,c.Tools).deepClone(e)]}),!0}return!1},"handler")};function t3(e,t){let n=[],r=[],{unitId:o,subUnitId:i,range:s,shiftDimension:a,cellValue:l={}}=t,u=e.get(c.IUniverInstanceService),d=e.get(X),h=u.getUniverSheetInstance(o),m=null==h?void 0:h.getSheetBySheetId(i);if(m){let t=m.getCellMatrix(),u=t.getDataRange();if(s.startColumn<=u.endColumn||s.startRow<=u.endRow){let l,d;if(a===c.Dimension.COLUMNS){let e=Math.min(s.endRow,u.endRow),n=0;for(let r=s.startRow;r<=e;r++){let e=t.getRow(r);n=Math.max(n,e?(0,c.getArrayLength)(e)-1:0)}l={startRow:s.startRow,startColumn:s.startColumn,endRow:e,endColumn:n};let r=s.endColumn-s.startColumn+1;d={startRow:s.startRow,startColumn:l.startColumn+r,endRow:e,endColumn:l.endColumn+r}}else{let e=Math.min(s.endColumn,u.endColumn),t=u.endRow;l={startRow:s.startRow,startColumn:s.startColumn,endRow:t,endColumn:e};let n=s.endRow-s.startRow+1;d={startRow:l.startRow+n,startColumn:s.startColumn,endRow:l.endRow+n,endColumn:e}}let h=eX(e,{unitId:o,subUnitId:i,range:l},{unitId:o,subUnitId:i,range:d},!0);h&&(n.push(...h.redos),r.push(...h.undos))}if(0===Object.entries(l).length)for(let e=s.startRow;e<=s.endRow;e++){l[e]||(l[e]={});for(let t=s.startColumn;t<=s.endColumn;t++)l[e][t]=null}let h={subUnitId:i,unitId:o,cellValue:l},g=em(e,h),{undos:p,redos:I}=d.onCommandExecute({id:t5.id,params:{...h,range:s}});n.push({id:eg.id,params:h},...I),r.push({id:eg.id,params:g},...p)}return{redo:n,undo:r}}function t4(e,t){let n=[],r=[],{unitId:o,subUnitId:i,range:s,shiftDimension:a}=t,l=e.get(c.IUniverInstanceService),u=e.get(X),d=l.getUniverSheetInstance(o),h=null==d?void 0:d.getSheetBySheetId(i);if(h){let t=h.getCellMatrix(),l=t.getDataRange(),d={subUnitId:i,unitId:o,cellValue:eC([s])},m=em(e,d),g=u.onCommandExecute({id:t5.id,params:d});if(n.push({id:eg.id,params:d},...g.redos),r.push(...g.undos,{id:eg.id,params:m}),s.startColumn<=l.endColumn||s.startRow<=l.endRow){let u=null,d=null;if(a===c.Dimension.COLUMNS&&s.endColumn<l.endColumn){let e=Math.min(s.endRow,l.endRow),n=0;for(let r=s.startRow;r<=e;r++){let e=t.getRow(r);n=Math.max(n,e?(0,c.getArrayLength)(e)-1:0)}u={startRow:s.startRow,startColumn:s.endColumn+1,endRow:e,endColumn:n};let r=s.endColumn-s.startColumn+1;d={startRow:s.startRow,startColumn:u.startColumn-r,endRow:e,endColumn:u.endColumn-r}}if(a===c.Dimension.ROWS&&s.endRow<l.endRow){let e=Math.min(s.endColumn,l.endColumn),t=l.endRow;u={startRow:s.endRow+1,startColumn:s.startColumn,endRow:t,endColumn:e};let n=s.endRow-s.startRow+1;d={startRow:u.startRow-n,startColumn:s.startColumn,endRow:u.endRow-n,endColumn:e}}if(u&&d){let t=eX(e,{unitId:o,subUnitId:i,range:u},{unitId:o,subUnitId:i,range:d},!0);t&&(n.push(...t.redos),r.push(...t.undos))}}}return{redo:n,undo:r}}_(t3,"getInsertRangeMutations"),_(t4,"getRemoveRangeMutations"),_(function(e,t,n,r,o,i){let{startRow:s,endRow:a,startColumn:l,endColumn:u}=t;if(o===c.Dimension.ROWS){let t=a-s+1;for(let r=n;r>=s;r--)for(let n=l;n<=u;n++){let o=e.getValue(r,n);null==o?e.realDeleteValue(r+t,n):e.setValue(r+t,n,o)}for(let t=a;t>=s;t--)for(let n=l;n<=u;n++)i&&i[t]&&i[t][n]?e.setValue(t,n,i[t][n]):e.realDeleteValue(t,n)}else if(o===c.Dimension.COLUMNS){let t=u-l+1;for(let n=s;n<=a;n++)for(let o=r;o>=l;o--){let r=e.getValue(n,o);null==r?e.realDeleteValue(n,o+t):e.setValue(n,o+t,r)}for(let t=s;t<=a;t++)for(let n=u;n>=l;n--)i&&i[t]&&i[t][n]?e.setValue(t,n,i[t][n]):e.realDeleteValue(t,n)}},"handleInsertRangeMutation"),_(function(e,t,n,r,o){let{startRow:i,endRow:s,startColumn:a,endColumn:l}=t,u=s-i+1,d=l-a+1;if(o===c.Dimension.ROWS)for(let t=i;t<=n;t++)for(let n=a;n<=l;n++){let r=e.getValue(t+u,n);null==r?e.realDeleteValue(t,n):e.setValue(t,n,r)}else if(o===c.Dimension.COLUMNS)for(let t=i;t<=s;t++)for(let n=a;n<=r;n++){let r=e.getValue(t,n+d);null==r?e.realDeleteValue(t,n):e.setValue(t,n,r)}},"handleDeleteRangeMutation");let t6="sheet.command.delete-range-move-left",t7={type:c.CommandType.COMMAND,id:t6,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let i=e.get(c.ICommandService),s=e.get(c.IUndoRedoService),a=e.get(c.IUniverInstanceService),l=e.get(j),u=e.get(X),d=eU(a);if(!d)return!1;let{worksheet:h,workbook:m,subUnitId:g,unitId:p}=d,I=null==t?void 0:t.range;if(I||(I=null==(n=l.getCurrentLastSelection())?void 0:n.range),!I)return!1;let C={range:I,subUnitId:g,unitId:p,shiftDimension:c.Dimension.COLUMNS},R=u.onCommandExecute({id:t7.id,params:{range:I}}),{redo:f,undo:v}=t4(e,C),S=[...null!=(r=R.preRedos)?r:[],...f],w=[...R.undos,...v];return S.push(...R.redos),S.push(eG(I,m,h)),w.push(...null!=(o=R.preUndos)?o:[]),!!(0,c.sequenceExecute)(S,i).result&&(s.pushUndoRedo({unitID:p,undoMutations:w.reverse(),redoMutations:S}),!0)},"handler")},t8="sheet.command.delete-range-move-up",t9={type:c.CommandType.COMMAND,id:t8,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let i=e.get(c.ICommandService),s=e.get(c.IUndoRedoService),a=e.get(c.IUniverInstanceService),l=e.get(j),u=e.get(X),d=eU(a);if(!d)return!1;let{unitId:h,subUnitId:m,workbook:g,worksheet:p}=d,I=null==t?void 0:t.range;if(I||(I=null==(n=l.getCurrentLastSelection())?void 0:n.range),!I)return!1;let C={range:I,subUnitId:m,unitId:h,shiftDimension:c.Dimension.ROWS},R=u.onCommandExecute({id:t9.id,params:{range:I}}),{redo:f,undo:v}=t4(e,C),S=[...null!=(r=R.preRedos)?r:[],...f],w=[...R.undos,...v];return S.push(...R.redos),S.push(eG(I,g,p)),w.push(...null!=(o=R.preUndos)?o:[]),!!(0,c.sequenceExecute)(S,i).result&&(s.pushUndoRedo({unitID:h,undoMutations:w.reverse(),redoMutations:S}),!0)},"handler")},ne={type:c.CommandType.COMMAND,id:"sheet.command.delete-range-protection",async handler(e,t){if(!t)return!1;let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),{unitId:o,subUnitId:i,rule:s}=t,a={unitId:o,subUnitId:i,ruleIds:[s.id]};return await n.executeCommand(x.id,a)&&r.pushUndoRedo({unitID:o,redoMutations:[{id:x.id,params:a}],undoMutations:[{id:N.id,params:{unitId:o,subUnitId:i,rules:[s]}}]}),!0}},nt={id:"sheet.command.insert-defined-name",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService);if(!t)return!1;let o={...t};return!!n.syncExecuteCommand(h.SetDefinedNameMutation.id,o)&&(r.pushUndoRedo({unitID:t.unitId,undoMutations:[{id:h.RemoveDefinedNameMutation.id,params:o}],redoMutations:[{id:h.SetDefinedNameMutation.id,params:o}]}),!0)},"handler")},nn=/* @__PURE__ */_((e,t)=>{if(null==e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},"InsertRowMutationUndoFactory"),nr={id:"sheet.mutation.insert-row",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let{unitId:r,subUnitId:o,range:i,rowInfo:s}=t,a=e.get(c.IUniverInstanceService).getUniverSheetInstance(r);if(null==a)throw Error("universheet is null error!");let l=a.getSheetBySheetId(o);if(null==l)throw Error("worksheet is null error!");let u=l.getRowManager().getRowData(),d={h:l.getConfig().defaultRowHeight,hd:0},h=i.startRow,m=i.endRow-i.startRow+1;for(let e=h;e<h+m;e++)s?(0,c.insertMatrixArray)(e,null!=(n=s[e-i.startRow])?n:d,u):(0,c.insertMatrixArray)(e,d,u);return l.setRowCount(l.getRowCount()+i.endRow-i.startRow+1),l.getCellMatrix().insertRows(i.startRow,m),!0},"handler")},no=/* @__PURE__ */_((e,t)=>{if(null==e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range}},"InsertColMutationUndoFactory"),ni={id:"sheet.mutation.insert-col",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let r=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==r)throw Error("universheet is null error!");let o=r.getSheetBySheetId(t.subUnitId);if(!o)return!1;let i=o.getColumnManager(),{range:s,colInfo:a}=t,l=i.getColumnData(),u=s.startColumn,d=s.endColumn-s.startColumn+1,h=o.getConfig().defaultColumnWidth;for(let e=u;e<u+d;e++){let t={w:h,hd:0};a?(0,c.insertMatrixArray)(e,null!=(n=a[e-s.startColumn])?n:t,l):(0,c.insertMatrixArray)(e,t,l)}return o.setColumnCount(o.getColumnCount()+s.endColumn-s.startColumn+1),o.getCellMatrix().insertColumns(s.startColumn,d),!0},"handler")},ns=/* @__PURE__ */_((e,t)=>{let n=t.getRowManager().getRowData(),r=e.range,o=(0,c.sliceMatrixArray)(r.startRow,r.endRow,n),i=(0,c.concatMatrixArray)({},o);return{unitId:e.unitId,subUnitId:e.subUnitId,range:e.range,rowInfo:i}},"RemoveRowsUndoMutationFactory"),na={id:"sheet.mutation.remove-rows",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=t.range,i=r.getRowManager().getRowData();for(let e=o.startRow;e<=o.endRow;e++)r.getRowFiltered(e);let s=o.endRow-o.startRow+1;return(0,c.spliceArray)(o.startRow,s,i),r.getCellMatrix().removeRows(o.startRow,s),r.setRowCount(r.getRowCount()-s),!0},"handler")},nl=/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(null==r)throw Error("worksheet is null error!");let o=r.getColumnManager().getColumnData(),i=t.range,s=(0,c.sliceMatrixArray)(i.startColumn,i.endColumn,o),a=(0,c.concatMatrixArray)({},s);return{unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,colInfo:a}},"RemoveColMutationFactory"),nu={id:"sheet.mutation.remove-col",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=t.range,i=r.getColumnManager().getColumnData(),s=o.endColumn-o.startColumn+1;return(0,c.spliceArray)(o.startColumn,s,i),r.setColumnCount(r.getColumnCount()-s),r.getCellMatrix().removeColumns(o.startColumn,s),!0},"handler")},nd={type:c.CommandType.COMMAND,id:"sheet.command.insert-range-move-down",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let i=e.get(c.ICommandService),s=e.get(c.IUndoRedoService),a=e.get(c.IUniverInstanceService),l=e.get(j),u=e.get(X),d=e.get(c.ErrorService),h=e.get(c.LocaleService);if(l.isOverlapping())return d.emit(h.t("sheets.info.overlappingSelections")),!1;let m=eU(a);if(!m)return!1;let{unitId:g,subUnitId:p,worksheet:I,workbook:C}=m,R=null==t?void 0:t.range;if(R||(R=null==(n=l.getCurrentLastSelection())?void 0:n.range),!R)return!1;let f=[],v=[],S=I.getCellMatrix(),w=S.getDataRange(),b=Math.max(S.getSlice(w.startRow,w.endRow,R.startColumn,R.endColumn).getDataRange().endRow+(R.endRow-R.startRow+1)-w.endRow,0);if(b>0){let t=R.startRow-1,n=I.getRowHeight(t),r={unitId:g,subUnitId:p,range:{startRow:w.endRow+1,endRow:w.endRow+b,startColumn:w.startColumn,endColumn:w.endColumn},rowInfo:Array(b).fill(void 0).map(()=>({h:n,hd:c.BooleanNumber.FALSE}))};f.push({id:nr.id,params:r});let o=nn(e,r);v.push({id:na.id,params:o})}let y={};(0,c.Range).foreach(R,(e,t)=>{let n=I.getCell(e,t);n&&(y[e]||(y[e]={}),y[e][t]={s:n.s})});let{redo:M,undo:U}=t3(e,{range:R,subUnitId:p,unitId:g,shiftDimension:c.Dimension.ROWS,cellValue:y});f.push(...M),v.push(...U);let _=u.onCommandExecute({id:nd.id,params:{range:R}});return f.push(..._.redos),f.push(eG(R,C,I)),v.push(...null!=(r=_.preUndos)?r:[]),f.unshift(...null!=(o=_.preRedos)?o:[]),v.unshift(..._.undos),!!(0,c.sequenceExecute)(f,i)&&(s.pushUndoRedo({unitID:g,undoMutations:v.reverse(),redoMutations:f}),!0)},"handler")},nc="sheet.command.insert-range-move-right",nh={type:c.CommandType.COMMAND,id:nc,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let i=e.get(c.ICommandService),s=e.get(c.IUndoRedoService),a=e.get(c.IUniverInstanceService),l=e.get(j),u=e.get(X),d=e.get(c.ErrorService),h=e.get(c.LocaleService);if(l.isOverlapping())return d.emit(h.t("sheets.info.overlappingSelections")),!1;let m=eU(a);if(!m)return!1;let{workbook:g,worksheet:p,unitId:I,subUnitId:C}=m,R=null==t?void 0:t.range;if(R||(R=null==(n=l.getCurrentLastSelection())?void 0:n.range),!R)return!1;let f=[],v=[],S=p.getCellMatrix(),w=S.getDataRange(),b=Math.max(S.getSlice(R.startRow,R.endRow,w.startColumn,w.endColumn).getDataRange().endColumn+(R.endColumn-R.startColumn+1)-w.endColumn,0);if(b>0){let t=R.startColumn-1,n=p.getColumnWidth(t),r={unitId:I,subUnitId:C,range:{startRow:w.startRow+1,endRow:w.endRow,startColumn:w.endColumn+1,endColumn:w.endColumn+b},colInfo:Array(b).fill(void 0).map(()=>({w:n,hd:c.BooleanNumber.FALSE}))};f.push({id:ni.id,params:r});let o=no(e,r);v.push({id:nu.id,params:o})}let y={};(0,c.Range).foreach(R,(e,t)=>{let n=p.getCell(e,t);n&&n.s&&(y[e]||(y[e]={}),y[e][t]={s:n.s})});let{redo:M,undo:U}=t3(e,{range:R,subUnitId:C,unitId:I,shiftDimension:c.Dimension.COLUMNS,cellValue:y});f.push(...M),v.push(...U);let _=u.onCommandExecute({id:nh.id,params:{range:R}});return f.push(..._.redos),f.push(eG(R,g,p)),v.push(...null!=(r=_.preUndos)?r:[]),f.unshift(...null!=(o=_.preRedos)?o:[]),v.unshift(..._.undos),!!(0,c.sequenceExecute)(f,i).result&&(s.pushUndoRedo({unitID:I,undoMutations:v.reverse(),redoMutations:f}),!0)},"handler")},nm="sheet.command.insert-row",ng={type:c.CommandType.COMMAND,id:nm,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,i;let s=e.get(c.ICommandService),a=e.get(c.IUndoRedoService),l=e.get(c.IUniverInstanceService),u=e.get(X),d=eU(l,t);if(!d)return!1;let{workbook:h,worksheet:m}=d,{range:g,direction:p,unitId:I,subUnitId:C,cellValue:R}=t,{startRow:f,endRow:v}=g;g.rangeType=c.RANGE_TYPE.ROW;let S=p===c.Direction.UP?f:f-1,w=m.getRowHeight(S),b={unitId:I,subUnitId:C,range:g,rowInfo:Array(v-f+1).fill(void 0).map(()=>({h:w,hd:c.BooleanNumber.FALSE}))},y=nn(e,b);if(!await u.beforeCommandExecute({id:ng.id,params:b}))return!1;let M=[{id:nr.id,params:b}],U=[{id:na.id,params:y}];R&&M.push({id:eg.id,params:{unitId:I,subUnitId:C,cellValue:R}});let _=u.onCommandExecute({id:ng.id,params:t});return M.unshift(...null!=(n=_.preRedos)?n:[]),M.push(...null!=(r=_.redos)?r:[]),M.push(eG(g,h,m)),U.unshift(...null!=(o=_.preUndos)?o:[]),U.push(...null!=(i=_.undos)?i:[]),!!(0,c.sequenceExecute)(M,s).result&&(a.pushUndoRedo({unitID:t.unitId,undoMutations:U,redoMutations:M}),!0)},"handler")},np={type:c.CommandType.COMMAND,id:"sheet.command.insert-row-before",handler:/* @__PURE__ */_(async e=>{var t;let n;let r=null==(t=e.get(j).getCurrentSelections())?void 0:t.map(e=>e.range);if((null==r?void 0:r.length)!==1)return!1;n=r[0];let o=eU(e.get(c.IUniverInstanceService));if(!o)return!1;let{worksheet:i,subUnitId:s,unitId:a}=o,{startRow:l,endRow:u}=n,d=i.getColumnCount()-1,h={unitId:a,subUnitId:s,direction:c.Direction.UP,range:{startRow:l,endRow:u,startColumn:0,endColumn:d},cellValue:eY(i,l,u,0,d,!0,l-1)};return e.get(c.ICommandService).executeCommand(ng.id,h)},"handler")},nI={type:c.CommandType.COMMAND,id:"sheet.command.insert-row-after",handler:/* @__PURE__ */_(async e=>{var t;let n;let r=null==(t=e.get(j).getCurrentSelections())?void 0:t.map(e=>e.range);if((null==r?void 0:r.length)!==1)return!1;n=r[0];let o=eU(e.get(c.IUniverInstanceService));if(!o)return!1;let{worksheet:i,unitId:s,subUnitId:a}=o,l=n.endRow-n.startRow+1,u=n.endRow+1,d=n.endRow+l,h=i.getColumnCount()-1,m={unitId:s,subUnitId:a,direction:c.Direction.DOWN,range:{startRow:u,endRow:d,startColumn:0,endColumn:h,rangeType:c.RANGE_TYPE.ROW},cellValue:eY(i,u,d,0,h,!0,n.endRow)};return e.get(c.ICommandService).executeCommand(ng.id,m)},"handler")},nC="sheet.command.insert-col",nR={type:c.CommandType.COMMAND,id:nC,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,i;let s=e.get(c.ICommandService),a=e.get(c.IUndoRedoService),l=e.get(c.IUniverInstanceService),u=e.get(X),{range:d,direction:h,subUnitId:m,unitId:g,cellValue:p}=t,{startColumn:I,endColumn:C}=t.range;d.rangeType=c.RANGE_TYPE.COLUMN;let R=l.getUniverSheetInstance(t.unitId),f=R.getSheetBySheetId(t.subUnitId),v=h===c.Direction.LEFT?I:I-1,S=f.getColumnWidth(v),w={unitId:g,subUnitId:m,range:d,colInfo:Array(C-I+1).fill(void 0).map(()=>({w:S,hd:c.BooleanNumber.FALSE}))},b=no(e,w);if(!await u.beforeCommandExecute({id:nR.id,params:w}))return!1;let y=[{id:ni.id,params:w}],M=[{id:nu.id,params:b}];p&&y.push({id:eg.id,params:{unitId:g,subUnitId:m,cellValue:p}});let U=u.onCommandExecute({id:nR.id,params:t});return y.unshift(...null!=(n=U.preRedos)?n:[]),y.push(...null!=(r=U.redos)?r:[]),y.push(eG(d,R,f)),M.unshift(...null!=(o=U.preUndos)?o:[]),M.push(...null!=(i=U.undos)?i:[]),!!(0,c.sequenceExecute)(y,s).result&&(a.pushUndoRedo({unitID:t.unitId,undoMutations:M.filter(Boolean),redoMutations:y.filter(Boolean)}),!0)},"handler")},nf={type:c.CommandType.COMMAND,id:"sheet.command.insert-col-before",handler:/* @__PURE__ */_(async e=>{let t;let n=e.get(j).getCurrentSelections();if((null==n?void 0:n.length)!==1)return!1;t=n[0].range;let r=eU(e.get(c.IUniverInstanceService));if(!r)return!1;let{worksheet:o,unitId:i,subUnitId:s}=r,{startColumn:a,endColumn:l}=t,u=o.getRowCount()-1,d={unitId:i,subUnitId:s,direction:c.Direction.LEFT,range:{startColumn:a,endColumn:l,startRow:0,endRow:u,rangeType:c.RANGE_TYPE.COLUMN},cellValue:eY(o,0,u,a,l,!1,a-1)};return e.get(c.ICommandService).executeCommand(nR.id,d)},"handler")},nv={type:c.CommandType.COMMAND,id:"sheet.command.insert-col-after",handler:/* @__PURE__ */_(async e=>{let t;let n=e.get(j).getCurrentSelections();if((null==n?void 0:n.length)!==1)return!1;t=n[0].range;let r=eU(e.get(c.IUniverInstanceService));if(!r)return!1;let{worksheet:o,unitId:i,subUnitId:s}=r,a=t.endColumn-t.startColumn+1,l=t.endColumn+1,u=t.endColumn+a,d=o.getRowCount()-1,h={unitId:i,subUnitId:s,direction:c.Direction.RIGHT,range:{startColumn:l,endColumn:u,startRow:0,endRow:d},cellValue:eY(o,0,d,l,u,!1,t.endColumn)};return e.get(c.ICommandService).executeCommand(nR.id,h)},"handler")},nS={id:"sheet.command.insert-sheet",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n;let r=e.get(c.ICommandService),o=e.get(c.IUndoRedoService),i=e.get(c.IUniverInstanceService),s=e.get(c.LocaleService),a=eM(i,{unitId:null==t?void 0:t.unitId});if(!a)return!1;let{unitId:l,workbook:u}=a,d=u.getSheets().length,h=null==t?void 0:t.sheet,m=null==h?void 0:h.id,g=(0,c.mergeWorksheetSnapshotWithDefault)(h||{});t?(d=null!=(n=t.index)?n:d,g.id=m||(0,c.Tools).generateRandomId(),g.name=(null==h?void 0:h.name)||u.generateNewSheetName(`${s.t("sheets.tabs.sheet")}`)):(g.id=(0,c.Tools).generateRandomId(),g.name=u.generateNewSheetName(`${s.t("sheets.tabs.sheet")}`));let p={index:d,sheet:g,unitId:l},I=eb(e,p);return!!r.syncExecuteCommand(ey.id,p)&&(o.pushUndoRedo({unitID:l,undoMutations:[{id:eT.id,params:I}],redoMutations:[{id:ey.id,params:p}]}),!0)},"handler")};function nw(e,t){let{unitId:n,subUnitId:r,sourceRange:o,targetRange:i}=t,s=o.startRow>i.startRow,a=o.endRow-o.startRow+1;return s?{unitId:n,subUnitId:r,sourceRange:(0,c.Rectangle).clone(i),targetRange:{...o,endRow:o.endRow+a,startRow:o.startRow+a}}:{unitId:n,subUnitId:r,targetRange:(0,c.Rectangle).clone(o),sourceRange:{...i,endRow:i.endRow-a,startRow:i.startRow-a}}}_(nw,"MoveRowsMutationUndoFactory");let nb={id:"sheet.mutation.move-rows",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,sourceRange:o,targetRange:i}=t,s=e.get(c.IUniverInstanceService).getUniverSheetInstance(n);if(!s)throw Error("[MoveRowMutation] univerSheet is null!");let a=s.getSheetBySheetId(r);if(!a)throw Error("[MoveRowMutation] worksheet is null!");let l=o.startRow,u=o.endRow-o.startRow+1,d=i.startRow,h=a.getRowManager().getRowData();return(0,c.moveMatrixArray)(l,u,d,h),a.getCellMatrix().moveRows(l,u,d),!0},"handler")};function ny(e,t){let{unitId:n,subUnitId:r,sourceRange:o,targetRange:i}=t,s=o.startColumn>i.startColumn,a=o.endColumn-o.startColumn+1;return s?{unitId:n,subUnitId:r,sourceRange:(0,c.Rectangle).clone(i),targetRange:{...o,endColumn:o.endColumn+a,startColumn:o.startColumn+a}}:{unitId:n,subUnitId:r,targetRange:(0,c.Rectangle).clone(o),sourceRange:{...i,startColumn:i.startColumn-a,endColumn:i.endColumn-a}}}_(ny,"MoveColsMutationUndoFactory");let nM={id:"sheet.mutation.move-columns",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,sourceRange:o,targetRange:i}=t,s=e.get(c.IUniverInstanceService).getUniverSheetInstance(n);if(!s)throw Error("[MoveColumnMutation] univerSheet is null!");let a=s.getSheetBySheetId(r);if(!a)throw Error("[MoveColumnMutation] worksheet is null!");let l=o.startColumn,u=o.endColumn-o.startColumn+1,d=i.startColumn,h=a.getColumnManager().getColumnData();return(0,c.moveMatrixArray)(l,u,d,h),a.getCellMatrix().moveColumns(l,u,d),!0},"handler")};function nU(e,t){return t.getMergeData().some(t=>t.startRow<e&&e<=t.endRow)}function n_(e,t){return t.getMergeData().some(t=>t.startColumn<e&&e<=t.endColumn)}_(nU,"rowAcrossMergedCell"),_(n_,"columnAcrossMergedCell");let nE="sheet.command.move-rows",nT={id:nE,type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(j),{fromRange:{startRow:i},toRange:{startRow:s},range:a}=t,l=a?[nN(a)]:o.getCurrentSelections(),u=null==l?void 0:l.filter(e=>e.range.rangeType===c.RANGE_TYPE.ROW&&e.range.startRow<=i&&i<=e.range.endRow);if((null==u?void 0:u.length)!==1)return!1;let d=e.get(X),h=eU(e.get(c.IUniverInstanceService),t);if(!h)return!1;let{workbook:m,worksheet:g}=h,p=m.getUnitId(),I=g.getSheetId(),C=e.get(c.ErrorService),R=e.get(c.LocaleService),f=u[0].range,v=u[0].primary,S=eL(f,g,!1);if(!(0,c.Rectangle).equals(f,S))return C.emit(R.t("sheets.info.partOfCell")),!1;if(nU(s,g))return C.emit(R.t("sheets.info.acrossMergedCell")),!1;let w={...f,startRow:s,endRow:s+f.endRow-f.startRow},b={unitId:p,subUnitId:I,sourceRange:f,targetRange:w},y=nw(e,b),M=e.get(c.ICommandService),U=d.onCommandExecute({id:nT.id,params:t}),_=[...null!=(n=U.preRedos)?n:[],{id:nb.id,params:b}],E=[...null!=(r=U.preUndos)?r:[],{id:nb.id,params:y}];if(v){let e=s-i<0,t=f.endRow-f.startRow+1,n=e?w:{...w,startRow:w.startRow-t,endRow:w.endRow-t},r={unitId:p,subUnitId:I,selections:[{range:n,primary:eF(n,g),style:null}]};_.push({id:ej.id,params:r}),E.push({id:ej.id,params:{unitId:p,subUnitId:I,selections:[{range:f,primary:v,style:null}]}})}return _.push(...U.redos),E.push(...U.undos),!!(0,c.sequenceExecute)(_,M).result&&(e.get(c.IUndoRedoService).pushUndoRedo({unitID:p,undoMutations:E,redoMutations:_}),!0)},"handler")},nk="sheet.command.move-cols",nx={id:nk,type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(j),{fromRange:{startColumn:i},toRange:{startColumn:s},range:a}=t,l=a?[nN(a)]:o.getCurrentSelections(),u=null==l?void 0:l.filter(e=>e.range.rangeType===c.RANGE_TYPE.COLUMN&&e.range.startColumn<=i&&i<=e.range.endColumn);if((null==u?void 0:u.length)!==1)return!1;let d=e.get(X),h=eU(e.get(c.IUniverInstanceService),t);if(!h)return!1;let{workbook:m,worksheet:g}=h,p=m.getUnitId(),I=g.getSheetId(),C=e.get(c.ErrorService),R=e.get(c.LocaleService),f=u[0].range,v=u[0].primary,S=eL(f,g,!1);if(!(0,c.Rectangle).equals(f,S))return C.emit(R.t("sheets.info.partOfCell")),!1;if(n_(s,g))return C.emit(R.t("sheets.info.acrossMergedCell")),!1;let w={...f,startColumn:s,endColumn:s+f.endColumn-f.startColumn},b={unitId:p,subUnitId:I,sourceRange:f,targetRange:w},y=ny(e,b),M=e.get(c.ICommandService),U=d.onCommandExecute({id:nx.id,params:t}),_=[...null!=(n=U.preRedos)?n:[],{id:nM.id,params:b}],E=[...null!=(r=U.preUndos)?r:[],{id:nM.id,params:y}];if(v){let e=f.endColumn-f.startColumn+1,t=s-i<0?w:{...w,startColumn:w.startColumn-e,endColumn:w.endColumn-e},n={unitId:p,subUnitId:I,selections:[{range:t,primary:eF(t,g),style:null}]};_.push({id:ej.id,params:n}),E.push({id:ej.id,params:{unitId:p,subUnitId:I,selections:[{range:f,primary:v,style:null}]}})}return _.push(...U.redos),E.push(...U.undos),(0,c.sequenceExecute)(_,M).result&&e.get(c.IUndoRedoService).pushUndoRedo({unitID:p,undoMutations:E,redoMutations:_}),!0},"handler")};function nN(e){return{range:e,primary:null,style:null}}_(nN,"covertRangeToSelection");let nO={id:"sheet.command.remove-defined-name",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n,r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(X);if(!t)return!1;let a={...t},l=s.onCommandExecute({id:nO.id,params:t}),u=[...null!=(n=l.preRedos)?n:[],{id:h.RemoveDefinedNameMutation.id,params:a},...l.redos],d=[...null!=(r=l.preUndos)?r:[],{id:h.SetDefinedNameMutation.id,params:a},...l.undos];return!!(0,c.sequenceExecute)(u,o)&&(i.pushUndoRedo({unitID:t.unitId,undoMutations:d.filter(Boolean),redoMutations:u.filter(Boolean)}),!0)},"handler")},nD="sheet.command.remove-row",nP={type:c.CommandType.COMMAND,id:nD,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,i;let s=e.get(j),a=e.get(X),l=null==t?void 0:t.range;if(l||(l=null==(n=s.getCurrentLastSelection())?void 0:n.range),!l)return!1;let u=eU(e.get(c.IUniverInstanceService));if(!u)return!1;let{workbook:d,worksheet:h,subUnitId:m,unitId:g}=u;l={...l,startColumn:0,endColumn:Math.max(h.getMaxColumns()-1,0)};let p=[];for(let e=l.startRow;e<=l.endRow;e++)h.getRowFiltered(e)&&p.push(e);let I=[];if(p.length){let e=[l.startRow,...p.map(e=>e+1)],t=[...p.map(e=>e-1),l.endRow];for(let n=e.length-1;n>=0;n--)e[n]<=t[n]&&I.push({startRow:e[n],endRow:t[n],startColumn:l.startColumn,endColumn:l.endColumn})}else I.push(l);if(!await a.beforeCommandExecute({id:nP.id,params:{range:l,ranges:I}}))return!1;let C=[],R=[];I.forEach(e=>{let t={unitId:g,subUnitId:m,range:e},n={unitId:g,subUnitId:m,cellValue:h.getCellMatrix().getSlice(e.startRow,e.endRow,0,h.getColumnCount()-1).getMatrix()},r=ns(t,h);C.push({id:na.id,params:t}),R.unshift({id:nr.id,params:r},{id:eg.id,params:n})});let f=a.onCommandExecute({id:nP.id,params:{range:l,ranges:I}}),v=e.get(c.ICommandService);return!!(0,c.sequenceExecute)([...null!=(r=f.preRedos)?r:[],...C,...f.redos,eG(l,d,h)],v).result&&(e.get(c.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:[...null!=(o=f.preUndos)?o:[],...R,...f.undos],redoMutations:[...null!=(i=f.preRedos)?i:[],...C,...f.redos]}),!0)},"handler")},nA="sheet.command.remove-col",nV={type:c.CommandType.COMMAND,id:nA,handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,i;let s=e.get(j),a=e.get(X),l=null==t?void 0:t.range;if(l||(l=null==(n=s.getCurrentLastSelection())?void 0:n.range),!l)return!1;let u=eU(e.get(c.IUniverInstanceService));if(!u)return!1;let{workbook:d,worksheet:h,subUnitId:m,unitId:g}=u,p={unitId:g,subUnitId:m,range:l={...l,startRow:0,endRow:Math.max(h.getMaxRows()-1,0)}},I=nl(e,p),C={unitId:g,subUnitId:m,cellValue:h.getCellMatrix().getSlice(0,h.getRowCount()-1,l.startColumn,l.endColumn).getMatrix()};if(!await a.beforeCommandExecute({id:nV.id,params:{range:l}}))return!1;let R=a.onCommandExecute({id:nV.id,params:{range:l}}),f=e.get(c.ICommandService);return!!(0,c.sequenceExecute)([...null!=(r=R.preRedos)?r:[],{id:nu.id,params:p},...R.redos,eG(l,d,h)],f).result&&(e.get(c.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:[...null!=(o=R.preUndos)?o:[],{id:ni.id,params:I},{id:eg.id,params:C},...R.undos],redoMutations:[...null!=(i=R.preRedos)?i:[],{id:nu.id,params:p},...R.redos]}),!0)},"handler")},n$={id:"sheet.command.remove-sheet",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(c.IUniverInstanceService),a=e.get(X),l=eU(s,t);if(!l)return!1;let{unitId:u,subUnitId:d,workbook:h,worksheet:m}=l;if(h.getSheets().length<=1)return!1;let g={subUnitId:d,unitId:u,subUnitName:m.getName()},p=eE(e,g),I=a.onCommandExecute({id:n$.id,params:{unitId:u,subUnitId:d}}),C=[...null!=(n=I.preRedos)?n:[],{id:eT.id,params:g},...I.redos],R=[...null!=(r=I.preUndos)?r:[],{id:ey.id,params:p},...I.undos];return!!(0,c.sequenceExecute)(C,o).result&&(i.pushUndoRedo({unitID:u,undoMutations:R,redoMutations:C}),!0)},"handler")},nW=/* @__PURE__ */_((e,t)=>{if(null==e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:(0,c.Tools).deepClone(t.ranges)}},"AddMergeUndoMutationFactory"),nj={id:"sheet.mutation.add-worksheet-merge",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=r.getConfig().mergeData,i=t.ranges;for(let e=0;e<i.length;e++)o.push(i[e]);return r.getSpanModel().rebuild(o),!0},"handler")},nL=/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(null==r)throw Error("worksheet is null error!");let o=r.getConfig().mergeData,i=t.ranges,s=[];for(let e=0;e<i.length;e++)for(let t=o.length-1;t>=0;t--){let n=o[t],r=i[e];(0,c.Rectangle).intersects(n,r)&&s.push(o[t])}return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:s}},"RemoveMergeUndoMutationFactory"),nB={id:"sheet.mutation.remove-worksheet-merge",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=r.getConfig().mergeData,i=t.ranges;for(let e=0;e<i.length;e++)for(let t=o.length-1;t>=0;t--){let n=o[t],r=i[e];(0,c.Rectangle).intersects(n,r)&&o.splice(t,1)}return r.getSpanModel().rebuild(o),!0},"handler")},nH={type:c.CommandType.COMMAND,id:"sheet.command.remove-worksheet-merge",handler:/* @__PURE__ */_(async(e,t)=>{var n;let r=e.get(j),o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(c.IUniverInstanceService),a=(null==t?void 0:t.ranges)||(null==(n=r.getCurrentSelections())?void 0:n.map(e=>e.range));if(!(null!=a&&a.length))return!1;let l=eU(s);if(!l)return!1;let{subUnitId:u,unitId:d,worksheet:h}=l,m=h.getConfig().mergeData.filter(e=>a.some(t=>(0,c.Rectangle).intersects(t,e)));if(!m.length)return!1;let g=nL(e,{unitId:d,subUnitId:u,ranges:a}),p=r.getCurrentSelections();if(!(null!=p&&p.length))return!1;let I=(0,c.Tools).deepClone(p),C=(0,c.Tools).deepClone(p),R=C[C.length-1],{startRow:f,startColumn:v}=R.range;R.primary={startRow:f,startColumn:v,endRow:f,endColumn:v,actualRow:f,actualColumn:v,isMerged:!1,isMergedMainCell:!1};let S=nF(h,m),w={unitId:d,subUnitId:u,cellValue:S.redoParams.getMatrix()},b={unitId:d,subUnitId:u,cellValue:S.undoParams.getMatrix()},y=[{id:nB.id,params:g},{id:eg.id,params:w},{id:ej.id,params:{selections:C}}],M=[{id:nj.id,params:g},{id:eg.id,params:b},{id:ej.id,params:{selections:I}}];return!!(0,c.sequenceExecute)(y,o)&&(i.pushUndoRedo({unitID:d,undoMutations:M,redoMutations:y}),!0)},"handler")};function nF(e,t){let n=new c.ObjectMatrix,r=new c.ObjectMatrix;return t.forEach(t=>{let{startRow:o,startColumn:i,endColumn:s,endRow:a}=t,l=e.getCellMatrix().getValue(o,i);if(null!=l&&l.s)for(let e=o;e<=a;e++)for(let t=i;t<=s;t++)(e!==o||t!==i)&&(n.setValue(e,t,{s:l.s}),r.setValue(e,t,null))}),{redoParams:n,undoParams:r}}_(nF,"getSetRangeStyleParamsForRemoveMerge");let nG=/* @__PURE__ */_(e=>{let{order:t}=e,n={};return Object.keys(t).forEach(e=>{n[t[Number(e)]]=Number(e)}),{...e,order:n}},"ReorderRangeUndoMutationFactory"),nq={id:"sheet.mutation.reorder-range",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{subUnitId:n,unitId:r,range:o,order:i}=t,s=e.get(c.IUniverInstanceService).getUnit(r).getSheetBySheetId(n);if(!s)return!1;let a=new c.ObjectMatrix;(0,c.Range).foreach(o,(e,t)=>{if(i.hasOwnProperty(e)){let n=i[e],r=(0,c.Tools).deepClone(s.getCellRaw(n,t));a.setValue(e,t,r)}});let l=s.getCellMatrix();return a.forValue((e,t,n)=>{l.setValue(e,t,n)}),!0},"handler")},nz="sheet.command.reorder-range",nY={id:nz,type:c.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n,r;let{subUnitId:o,unitId:i,range:s,order:a}=t,l=e.get(c.ICommandService),u={id:nq.id,params:{unitId:i,subUnitId:o,order:a,range:s}},d={id:nq.id,params:nG(u.params)},h=e.get(X).onCommandExecute({id:nY.id,params:t}),m=[...null!=(n=h.preRedos)?n:[],u,...h.redos],g=[...null!=(r=h.preUndos)?r:[],d,...h.undos];return!!(0,c.sequenceExecute)(m,l).result&&(e.get(c.IUndoRedoService).pushUndoRedo({unitID:i,undoMutations:g,redoMutations:m}),!0)},"handler")},nJ=class{constructor(){E(this,"_borderInfo",{type:c.BorderType.ALL,color:"#000000",style:c.BorderStyleTypes.THIN,activeBorderType:!1}),E(this,"_borderInfo$",new g.BehaviorSubject(this._borderInfo)),E(this,"borderInfo$",this._borderInfo$.asObservable())}dispose(){this._borderInfo$.complete()}setType(e){this._borderInfo.type=e,this.setActiveBorderType(!0),this._refresh()}setColor(e){this._borderInfo.color=e,this._refresh()}setStyle(e){this._borderInfo.style=e,this._refresh()}setActiveBorderType(e){this._borderInfo.activeBorderType=e}getBorderInfo(){return this._borderInfo}_refresh(){this._borderInfo$.next(this._borderInfo)}};_(nJ,"BorderStyleManagerService");let nK=nJ;function nX(e,t){let{startRow:n,startColumn:r,endRow:o,endColumn:i}=e;for(let e=n;e<=o;e++)for(let n=r;n<=i;n++)t(e,n)}_(nX,"forEach");let nZ=/* @__PURE__ */_((e,t,n,r)=>{let{mr:o,worksheet:i}=e;t.startRow<0||t.startColumn<0||nX(t,(e,t)=>{var s,a;let l=i.getMergedCell(e,t),u=n;if(l&&(n.bc_tr||n.ml_tr||n.bl_tr||n.tl_mr||n.tl_bc||n.tl_br)){if(r){let e=(0,c.Tools).deepClone(null==(s=o.getValue(l.startRow,l.startColumn))?void 0:s.s);u=null!=e&&e.bd?Object.assign(e.bd,n):n}o.setValue(l.startRow,l.startColumn,{s:{bd:u}})}else{if(r){let r=(0,c.Tools).deepClone(null==(a=o.getValue(e,t))?void 0:a.s);u=null!=r&&r.bd?Object.assign(r.bd,n):n}o.setValue(e,t,{s:{bd:u}})}})},"setBorderStyleForRange"),nQ=/* @__PURE__ */_(e=>{let t={startRow:e.startRow-1,startColumn:e.startColumn,endRow:e.startRow-1,endColumn:e.endColumn},n={startRow:e.startRow,startColumn:e.startColumn-1,endRow:e.endRow,endColumn:e.startColumn-1},r={startRow:e.endRow+1,startColumn:e.startColumn,endRow:e.endRow+1,endColumn:e.endColumn},o={startRow:e.startRow,startColumn:e.endColumn+1,endRow:e.endRow,endColumn:e.endColumn+1},i={startRow:e.startRow,startColumn:e.startColumn,endRow:e.startRow,endColumn:e.endColumn};return{topRangeOut:t,leftRangeOut:n,bottomRangeOut:r,rightRangeOut:o,topRange:i,leftRange:{startRow:e.startRow,startColumn:e.startColumn,endRow:e.endRow,endColumn:e.startColumn},bottomRange:{startRow:e.endRow,startColumn:e.startColumn,endRow:e.endRow,endColumn:e.endColumn},rightRange:{startRow:e.startRow,startColumn:e.endColumn,endRow:e.endRow,endColumn:e.endColumn}}},"prepareEdgeRange");function n0(e,t,n){let{style:r,color:o,type:i}=e.getBorderInfo(),s=i===c.BorderType.TOP||i===c.BorderType.ALL||i===c.BorderType.OUTSIDE,a=i===c.BorderType.LEFT||i===c.BorderType.ALL||i===c.BorderType.OUTSIDE,l=i===c.BorderType.BOTTOM||i===c.BorderType.ALL||i===c.BorderType.OUTSIDE,u=i===c.BorderType.RIGHT||i===c.BorderType.ALL||i===c.BorderType.OUTSIDE,d=i===c.BorderType.VERTICAL||i===c.BorderType.ALL||i===c.BorderType.INSIDE,h=i===c.BorderType.HORIZONTAL||i===c.BorderType.ALL||i===c.BorderType.INSIDE,m=i.indexOf("tlbr")>-1,g=i.indexOf("tlbc")>-1,p=i.indexOf("tlmr")>-1,I=i.indexOf("bltr")>-1,C=i.indexOf("mltr")>-1,R=i.indexOf("bctr")>-1,f=n[0],{topRangeOut:v,leftRangeOut:S,bottomRangeOut:w,rightRangeOut:b,topRange:y,leftRange:M,bottomRange:U,rightRange:_}=nQ(f),E=new c.ObjectMatrix,{worksheet:T,unitId:k,subUnitId:x}=t;return{worksheet:T,unitId:k,subUnitId:x,style:r,color:o,type:i,top:s,left:a,right:u,bottom:l,vertical:d,horizontal:h,tl_br:m,tl_bc:g,tl_mr:p,bl_tr:I,ml_tr:C,bc_tr:R,topRangeOut:v,leftRangeOut:S,bottomRangeOut:w,rightRangeOut:b,topRange:y,leftRange:M,bottomRange:U,rightRange:_,range:f,mr:E,borderStyle:{s:r,cl:{rgb:o}}}}_(n0,"getBorderContext");let n1=/* @__PURE__ */_(e=>{let{range:t,mr:n,borderStyle:r,vertical:o,horizontal:i,worksheet:s}=e;o&&nX(t,(e,o)=>{var i,a,l;let u=s.getMergedCell(e,o);if(u){let s=null==(i=n.getValue(u.startRow,u.startColumn))?void 0:i.s;u.startColumn!==t.startColumn&&n.setValue(e,o,{s:{bd:null!=s&&s.bd?Object.assign(s.bd,{l:(0,c.Tools).deepClone(r)}):{l:(0,c.Tools).deepClone(r)}}})}else{if(o!==t.endColumn){let t=null==(a=n.getValue(e,o))?void 0:a.s;n.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{r:(0,c.Tools).deepClone(r)}):{r:(0,c.Tools).deepClone(r)}}})}if(o!==t.startColumn){let t=null==(l=n.getValue(e,o))?void 0:l.s;n.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{l:(0,c.Tools).deepClone(r)}):{l:(0,c.Tools).deepClone(r)}}})}}}),i&&nX(t,(e,o)=>{var i,a,l;let u=s.getMergedCell(e,o);if(u){let s=null==(i=n.getValue(u.startRow,u.startColumn))?void 0:i.s;u.startRow!==t.startRow&&n.setValue(e,o,{s:{bd:null!=s&&s.bd?Object.assign(s.bd,{t:(0,c.Tools).deepClone(r)}):{t:(0,c.Tools).deepClone(r)}}})}else{if(e!==t.endRow){let t=null==(a=n.getValue(e,o))?void 0:a.s;n.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{b:(0,c.Tools).deepClone(r)}):{b:(0,c.Tools).deepClone(r)}}})}if(e!==t.startRow){let t=null==(l=n.getValue(e,o))?void 0:l.s;n.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{t:(0,c.Tools).deepClone(r)}):{t:(0,c.Tools).deepClone(r)}}})}}})},"innerBorder");function n2(e){let{borderStyle:t,tl_br:n,tl_bc:r,tl_mr:o,bl_tr:i,ml_tr:s,bc_tr:a}=e,l=/* @__PURE__ */_((t,n,r)=>{nZ(e,t,n,r)},"setBorderStyle");n&&l(e.range,{tl_br:(0,c.Tools).deepClone(t)},!0),r&&l(e.range,{tl_bc:(0,c.Tools).deepClone(t)},!0),o&&l(e.range,{tl_mr:(0,c.Tools).deepClone(t)},!0),i&&l(e.range,{bl_tr:(0,c.Tools).deepClone(t)},!0),s&&l(e.range,{ml_tr:(0,c.Tools).deepClone(t)},!0),a&&l(e.range,{bc_tr:(0,c.Tools).deepClone(t)},!0)}_(n2,"otherBorders");let n5=/* @__PURE__ */_(e=>{let{top:t,left:n,right:r,bottom:o,borderStyle:i,bottomRange:s,topRange:a,leftRange:l,rightRange:u,bottomRangeOut:d,topRangeOut:h,leftRangeOut:m,rightRangeOut:g}=e,p=/* @__PURE__ */_((t,n,r)=>{nZ(e,t,n,r)},"setBorderStyle");t&&(p(h,{b:null}),p(a,{t:(0,c.Tools).deepClone(i)},!0)),o&&(p(d,{t:null}),p(s,{b:(0,c.Tools).deepClone(i)},!0)),n&&(p(m,{r:null}),p(l,{l:(0,c.Tools).deepClone(i)},!0)),r&&(p(g,{l:null}),p(u,{r:(0,c.Tools).deepClone(i)},!0))},"outlineBorder"),n3=/* @__PURE__ */_(e=>{let{range:t,worksheet:n,mr:r,top:o,bottom:i,left:s,right:a,vertical:l,horizontal:u,tl_br:d,tl_bc:c,tl_mr:h,bl_tr:m,ml_tr:g,bc_tr:p,topRange:I,bottomRange:C,leftRange:R,rightRange:f,topRangeOut:v,bottomRangeOut:S,leftRangeOut:w,rightRangeOut:b}=e,y=/* @__PURE__ */_((t,n,r)=>{nZ(e,t,n,r)},"setBorderStyle");o||i||s||a||l||u||d||c||h||m||g||p||(nX(t,(e,o)=>{var i,s,a,l,u,d,c,h;let m=n.getMergedCell(e,o);if(m){if(m.endColumn!==t.endColumn){let t=null==(i=r.getValue(m.startRow,m.startColumn))?void 0:i.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{r:null}):{r:null}}})}if(m.startColumn!==t.startColumn){let t=null==(s=r.getValue(m.startRow,m.startColumn))?void 0:s.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{l:null}):{l:null}}})}if(m.endRow!==t.endRow){let t=null==(a=r.getValue(m.startRow,m.startColumn))?void 0:a.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{b:null}):{b:null}}})}if(m.startRow!==t.startRow){let t=null==(l=r.getValue(m.startRow,m.startColumn))?void 0:l.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{t:null}):{t:null}}})}}else{if(o!==t.endColumn){let t=null==(u=r.getValue(e,o))?void 0:u.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{r:null}):{r:null}}})}if(o!==t.startColumn){let t=null==(d=r.getValue(e,o))?void 0:d.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{l:null}):{l:null}}})}if(e!==t.endRow){let t=null==(c=r.getValue(e,o))?void 0:c.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{b:null}):{b:null}}})}if(e!==t.startRow){let t=null==(h=r.getValue(e,o))?void 0:h.s;r.setValue(e,o,{s:{bd:null!=t&&t.bd?Object.assign(t.bd,{t:null}):{t:null}}})}}}),y(v,{b:null}),y(I,{t:null},!0),y(S,{t:null}),y(C,{b:null},!0),y(w,{r:null}),y(R,{l:null},!0),y(b,{l:null}),y(f,{r:null},!0),y(t,{tl_br:null},!0),y(t,{tl_bc:null},!0),y(t,{tl_mr:null},!0),y(t,{bl_tr:null},!0),y(t,{ml_tr:null},!0),y(t,{bc_tr:null},!0))},"clearBorder"),n4={id:"sheet.command.set-border",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{var n;let r=e.get(c.ICommandService),o=e.get(c.IUndoRedoService),i=e.get(c.IUniverInstanceService),s=e.get(j),a=e.get(nK),l=eU(i,t);if(!l)return!1;let u=null==(n=s.getCurrentSelections())?void 0:n.map(e=>e.range);if(!(null!=u&&u.length))return!1;let{activeBorderType:d}=a.getBorderInfo();if(!d)return!1;let h=n0(a,l,u);n1(h),n5(h),n2(h),n3(h);let{unitId:m,subUnitId:g,mr:p}=h,I={unitId:m,subUnitId:g,cellValue:p.getData()},C=em(e,I);return!!r.syncExecuteCommand(eg.id,I)&&(o.pushUndoRedo({unitID:m,undoMutations:[{id:eg.id,params:C}],redoMutations:[{id:eg.id,params:I}]}),!0)},"handler")},n6={id:"sheet.command.set-border-position",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{if(!t.value)return!1;let n=e.get(c.ICommandService);return e.get(nK).setType(t.value),n.executeCommand(n4.id)},"handler")},n7={id:"sheet.command.set-border-style",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService);return e.get(nK).setStyle(t.value),n.executeCommand(n4.id)},"handler")},n8={id:"sheet.command.set-border-color",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService);return e.get(nK).setColor(t.value),n.executeCommand(n4.id)},"handler")},n9={id:"sheet.command.set-border-basic",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_(async(e,t)=>{let{unitId:n,subUnitId:r,value:o}=t,{type:i,color:s,style:a}=o,l=e.get(c.ICommandService),u=e.get(nK);return u.setType(i),s&&u.setColor(s),u.setStyle(a),l.executeCommand(n4.id,{unitId:n,subUnitId:r})},"handler")};function re(e,t){if(null==e)return e;let n=(0,c.Tools).deepClone(e);if(null==t)return n;let r={};return"h"in t&&(r.h=n.h),"ia"in t&&(r.ia=n.ia),"ah"in t&&(r.ah=n.ah),"hd"in t&&(r.hd=n.hd),"s"in t&&(r.s=n.s),"custom"in t&&(r.custom=n.custom),r}function rt(e,t){if(null==e)return e;let n=(0,c.Tools).deepClone(e);if(null==t)return n;let r={};return"w"in t&&(r.w=n.w),"hd"in t&&(r.hd=n.hd),"s"in t&&(r.s=n.s),"custom"in t&&(r.custom=n.custom),r}_(re,"getOldRowData"),_(rt,"getOldColumnData");let rn=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,columnData:o}=e,i={},s=t.getColumnManager();for(let e in o){let t=o[e],n=s.getColumn(Number(e));i[e]=rt(n,t)}return{unitId:n,subUnitId:r,columnData:i}},"SetColDataMutationFactory"),rr={id:"sheet.mutation.set-col-data",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{columnData:n}=t,r=eU(e.get(c.IUniverInstanceService),t);if(!r)return!1;let{worksheet:o}=r,i=o.getColumnManager();for(let e in n){let t=n[e];if(null==t){i.removeColumn(Number(e));continue}Object.assign(i.getColumnOrCreate(Number(e)),t)}return!0},"handler")},ro={type:c.CommandType.COMMAND,id:"sheet.command.set-col-data",handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=eU(e.get(c.IUniverInstanceService),t);if(!o)return!1;let{columnData:i}=t,{unitId:s,subUnitId:a,worksheet:l}=o,u={subUnitId:a,unitId:s,columnData:i},d=rn(u,l);return!!n.syncExecuteCommand(rr.id,u)&&(r.pushUndoRedo({unitID:s,undoMutations:[{id:rr.id,params:d}],redoMutations:[{id:rr.id,params:u}]}),!0)},"handler")},ri=/* @__PURE__ */_((e,t)=>{if(null==e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetColHiddenUndoMutationFactory"),rs={id:"sheet.mutation.set-col-hidden",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startColumn;e<n.endColumn+1;e++){let t=r.getColumnOrCreate(e);null!=t&&(t.hd=c.BooleanNumber.TRUE)}}return!0},"handler")},ra=/* @__PURE__ */_((e,t)=>{if(null==e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetColVisibleUndoMutationFactory"),rl={id:"sheet.mutation.set-col-visible",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId).getColumnManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startColumn;e<n.endColumn+1;e++){let t=r.getColumnOrCreate(e);null!=t&&(t.hd=c.BooleanNumber.FALSE)}}return!0},"handler")},ru={type:c.CommandType.COMMAND,id:"sheet.command.set-col-visible-on-cols",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let{unitId:o,subUnitId:i,ranges:s}=t,a=e.get(X),l=e.get(c.ICommandService),u=eU(e.get(c.IUniverInstanceService),{unitId:o,subUnitId:i});if(!u)return!1;let{worksheet:d}=u,h={unitId:o,subUnitId:i,ranges:s},m={unitId:o,subUnitId:i,reveal:!0,selections:s.map(e=>({range:e,primary:eF(e,d),style:null}))},g=ra(e,h),p={unitId:o,subUnitId:i,selections:rm(s).map(e=>({range:e,primary:eF(e,d),style:null}))},I=(0,c.sequenceExecute)([{id:rl.id,params:h},{id:ej.id,params:m}],l),C=a.onCommandExecute({id:ru.id,params:t}),R=(0,c.sequenceExecute)([...C.redos],l);return I.result&&R.result&&e.get(c.IUndoRedoService).pushUndoRedo({unitID:o,undoMutations:[{id:rs.id,params:g},{id:ej.id,params:p},...null!=(n=C.undos)?n:[]],redoMutations:[...null!=(r=C.preRedos)?r:[],{id:rl.id,params:h},{id:ej.id,params:m},...C.redos]}),!0},"handler")},rd={type:c.CommandType.COMMAND,id:"sheet.command.set-selected-cols-visible",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(j),r=e.get(c.ICommandService),o=null==(t=n.getCurrentSelections())?void 0:t.map(e=>e.range).filter(e=>e.rangeType===c.RANGE_TYPE.COLUMN);if(!(null!=o&&o.length))return!1;let i=eU(e.get(c.IUniverInstanceService));if(!i)return!1;let{worksheet:s,unitId:a,subUnitId:l}=i,u=o.map(e=>s.getHiddenCols(e.startColumn,e.endColumn)).flat();return r.executeCommand(ru.id,{unitId:a,subUnitId:l,ranges:u})},"handler")},rc={type:c.CommandType.COMMAND,id:"sheet.command.set-col-hidden",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,i;let s=e.get(j),a=e.get(X),l=e.get(c.IUniverInstanceService),u=e.get(c.ICommandService),d=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=s.getCurrentSelections())?void 0:r.map(e=>e.range).filter(e=>e.rangeType===c.RANGE_TYPE.COLUMN);if(!(null!=d&&d.length))return!1;let h=eU(l,t);if(!h)return!1;let{worksheet:m,unitId:g,subUnitId:p}=h,I={unitId:g,subUnitId:p,ranges:d=rh(h.worksheet,d)},C={unitId:g,subUnitId:p,selections:rm(d).map(e=>({range:e,primary:eF(e,m),style:null}))},R=ri(e,I),f={unitId:g,subUnitId:p,reveal:!0,selections:d.map(e=>({range:e,primary:eF(e,m),style:null}))},v=(0,c.sequenceExecute)([{id:rs.id,params:I},{id:ej.id,params:C}],u),S=a.onCommandExecute({id:rc.id,params:I}),w=(0,c.sequenceExecute)([...S.redos],u);return!!v.result&&!!w.result&&(e.get(c.IUndoRedoService).pushUndoRedo({unitID:g,undoMutations:[{id:rl.id,params:R},{id:ej.id,params:f},...null!=(o=S.undos)?o:[]],redoMutations:[...null!=(i=S.preRedos)?i:[],{id:rs.id,params:I},{id:ej.id,params:C},...S.redos]}),!0)},"handler")};function rh(e,t){let n=e.getRowCount()-1,r=e.getHiddenCols(),o=[];return t.forEach(e=>{let t=r.filter(t=>t.startColumn>=e.startColumn&&t.endColumn<=e.endColumn);if(t.length){let r=e.startColumn;t.forEach(e=>{e.startColumn>r&&(o.push({startColumn:r,endColumn:e.startColumn-1,startRow:0,endRow:n}),r=e.endColumn+1)}),r<=e.endColumn&&o.push({startColumn:r,endColumn:e.endColumn,startRow:0,endRow:n})}else o.push(e)}),o}function rm(e){return rg(e).map(e=>{let t=0===e.startColumn?e.endColumn+1:e.startColumn-1;return{...e,startColumn:t,endColumn:t}})}function rg(e){let t;let n=[];return e.sort((e,t)=>e.startColumn-t.startColumn).forEach(e=>{if(!t){t=e;return}t.endColumn===e.startColumn-1?t.endColumn=e.endColumn:(n.push(t),t=e)}),n.push(t),n}_(rh,"divideRangesByHiddenCols"),_(rm,"getSelectionsAfterHiding$1"),_(rg,"mergeSelections$1");let rp={id:"sheet.command.set-defined-name",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{var n,r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(X);if(!t)return!1;let a={...t},l=(0,h.SetDefinedNameMutationFactory)(e,t),u=s.onCommandExecute({id:rp.id,params:t}),d=[...null!=(n=u.preRedos)?n:[],{id:h.RemoveDefinedNameMutation.id,params:l},{id:h.SetDefinedNameMutation.id,params:a},...u.redos],m=[...null!=(r=u.preUndos)?r:[],{id:h.RemoveDefinedNameMutation.id,params:a},{id:h.SetDefinedNameMutation.id,params:l},...u.undos];return!!(0,c.sequenceExecute)(d,o)&&(i.pushUndoRedo({unitID:t.unitId,undoMutations:m.filter(Boolean),redoMutations:d.filter(Boolean)}),!0)},"handler")},rI=/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(null==r)throw Error("worksheet is null error!");let o=r.getConfig().freeze;return{unitId:t.unitId,subUnitId:t.subUnitId,...o}},"SetFrozenMutationFactory"),rC={id:"sheet.mutation.set-frozen",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId);if(!r)return!1;let o=r.getConfig(),{startRow:i,startColumn:s,ySplit:a,xSplit:l}=t;return o.freeze={startRow:i,startColumn:s,ySplit:a,xSplit:l},!0},"handler")},rR={type:c.CommandType.COMMAND,id:"sheet.command.set-frozen",handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=eU(e.get(c.IUniverInstanceService),{unitId:t.unitId,subUnitId:t.subUnitId});if(!o)return!1;let{unitId:i,subUnitId:s,worksheet:a}=o,{startColumn:l,startRow:u,xSplit:d,ySplit:h}=t;if(u>=a.getRowCount()||l>=a.getColumnCount()||d>=a.getColumnCount()||h>=a.getRowCount())return!1;let m={unitId:i,subUnitId:s,...t},g=rI(e,m);return!!n.syncExecuteCommand(rC.id,m)&&(r.pushUndoRedo({unitID:i,undoMutations:[{id:rC.id,params:g}],redoMutations:[{id:rC.id,params:m}]}),!0)},"handler")},rf={type:c.CommandType.COMMAND,id:"sheet.command.set-frozen-cancel",handler:/* @__PURE__ */_(e=>{let t=e.get(c.ICommandService),n=e.get(c.IUndoRedoService),r=eU(e.get(c.IUniverInstanceService));if(!r)return!1;let{unitId:o,subUnitId:i}=r,s={unitId:o,subUnitId:i,startRow:-1,startColumn:-1,ySplit:0,xSplit:0},a=rI(e,s);return!!t.syncExecuteCommand(rC.id,s)&&(n.pushUndoRedo({unitID:o,undoMutations:[{id:rC.id,params:a}],redoMutations:[{id:rC.id,params:s}]}),!0)},"handler")},rv={id:"sheet.mutation.set-range-protection",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rule:o,ruleId:i}=t;return e.get(k).setRule(n,r,i,o),!0},"handler")},rS=(/* @__PURE__ */(e,t)=>{let{unitId:n,subUnitId:r,ruleId:o}=t,i=e.get(k).getRule(n,r,o);return i?{id:rv.id,params:{...t,rule:i}}:null},{type:c.CommandType.COMMAND,id:"sheet.command.set-range-protection",async handler(e,t){if(!t)return!1;let n=e.get(c.ICommandService),r=e.get(k),o=e.get(c.IUndoRedoService),{rule:i,permissionId:s,oldRule:a}=t,{unitId:l,subUnitId:u,ranges:d,name:h,description:m}=i;if(i.id){let e={unitId:l,subUnitId:u,ruleId:i.id,rule:{ranges:d,permissionId:s,id:r.createRuleId(l,u),name:h,description:m}};if(await n.executeCommand(rv.id,e)){let t=[{id:rv.id,params:e}],n=[{id:rv.id,params:{unitId:l,subUnitId:u,ruleId:i.id,rule:a}}];o.pushUndoRedo({unitID:l,redoMutations:t,undoMutations:n})}}return!0}}),rw=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rowData:o}=e,i={},s=t.getRowManager();for(let e in o){let t=o[e],n=s.getRow(Number(e));i[e]=re(n,t)}return{unitId:n,subUnitId:r,rowData:i}},"SetRowDataMutationFactory"),rb={id:"sheet.mutation.set-row-data",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{rowData:n}=t,r=eU(e.get(c.IUniverInstanceService),t);if(!r)return!1;let{worksheet:o}=r,i=o.getRowManager();for(let e in n){let t=n[e];if(null==t){i.removeRow(Number(e));continue}Object.assign(i.getRowOrCreate(Number(e)),t)}return!0},"handler")},ry={type:c.CommandType.COMMAND,id:"sheet.command.set-row-data",handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=eU(e.get(c.IUniverInstanceService),t);if(!o)return!1;let{rowData:i}=t,{unitId:s,subUnitId:a,worksheet:l}=o,u={subUnitId:a,unitId:s,rowData:i},d=rw(u,l);return!!n.syncExecuteCommand(rb.id,u)&&(r.pushUndoRedo({unitID:s,undoMutations:[{id:rb.id,params:d}],redoMutations:[{id:rb.id,params:u}]}),!0)},"handler")},rM=/* @__PURE__ */_((e,t)=>{if(null==e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetRowVisibleUndoMutationFactory"),rU={id:"sheet.mutation.set-row-visible",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startRow;e<n.endRow+1;e++){let t=r.getRowOrCreate(e);null!=t&&(t.hd=0)}}return!0},"handler")},r_=/* @__PURE__ */_((e,t)=>{if(null==e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId))throw Error("universheet is null error!");return{unitId:t.unitId,subUnitId:t.subUnitId,ranges:t.ranges}},"SetRowHiddenUndoMutationFactory"),rE={id:"sheet.mutation.set-row-hidden",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)throw Error("universheet is null error!");let r=n.getSheetBySheetId(t.subUnitId).getRowManager();for(let e=0;e<t.ranges.length;e++){let n=t.ranges[e];for(let e=n.startRow;e<n.endRow+1;e++){let t=r.getRowOrCreate(e);null!=t&&(t.hd=1)}}return!0},"handler")},rT={type:c.CommandType.COMMAND,id:"sheet.command.set-specific-rows-visible",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o;let{unitId:i,subUnitId:s,ranges:a}=t,l=e.get(c.ICommandService),u=e.get(c.IUndoRedoService),d=e.get(X),h=eU(e.get(c.IUniverInstanceService),{unitId:i,subUnitId:s});if(!h)return!1;let{worksheet:m}=h,g={unitId:i,subUnitId:s,ranges:a},p={unitId:i,subUnitId:s,reveal:!0,selections:a.map(e=>({range:e,primary:eF(e,m),style:null}))},I=rM(e,g),C={unitId:i,subUnitId:s,selections:rO(a).map(e=>({range:e,primary:eF(e,m),style:null}))},R=(0,c.sequenceExecute)([{id:rU.id,params:g},{id:ej.id,params:p}],l),f=d.onCommandExecute({id:rT.id,params:t}),v=(0,c.sequenceExecute)([...f.redos],l);return R.result&&v.result&&u.pushUndoRedo({unitID:i,undoMutations:[...null!=(n=f.preUndos)?n:[],{id:rE.id,params:I},{id:ej.id,params:C},...null!=(r=f.undos)?r:[]],redoMutations:[...null!=(o=f.preRedos)?o:[],{id:rU.id,params:g},{id:ej.id,params:p},...f.redos]}),!0},"handler")},rk={type:c.CommandType.COMMAND,id:"sheet.command.set-selected-rows-visible",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(j),r=e.get(c.IUniverInstanceService),o=e.get(c.ICommandService),i=null==(t=n.getCurrentSelections())?void 0:t.map(e=>e.range).filter(e=>e.rangeType===c.RANGE_TYPE.ROW);if(!(null!=i&&i.length))return!1;let s=eU(r);if(!s)return!1;let{worksheet:a,unitId:l,subUnitId:u}=s,d=i.map(e=>a.getHiddenRows(e.startRow,e.endRow)).flat();return o.executeCommand(rT.id,{unitId:l,subUnitId:u,ranges:d})},"handler")},rx={type:c.CommandType.COMMAND,id:"sheet.command.set-rows-hidden",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,i,s,a;let l=e.get(j),u=e.get(c.ICommandService),d=e.get(c.IUndoRedoService),h=e.get(c.IUniverInstanceService),m=e.get(X),g=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=l.getCurrentSelections())?void 0:r.map(e=>e.range).filter(e=>e.rangeType===c.RANGE_TYPE.ROW);if(!(null!=g&&g.length))return!1;let p=eU(h,t);if(!p)return!1;g=rN(p.worksheet,g);let{unitId:I,subUnitId:C,worksheet:R}=p,f={unitId:I,subUnitId:C,ranges:g},v={unitId:I,subUnitId:C,selections:rO(g).map(e=>({range:e,primary:eF(e,R),style:null}))},S=r_(e,f),w={unitId:I,subUnitId:C,reveal:!0,selections:g.map(e=>({range:e,primary:eF(e,R),style:null}))},b=m.onCommandExecute({id:rx.id,params:f});return(0,c.sequenceExecute)([...null!=(o=b.preRedos)?o:[],{id:rE.id,params:f},{id:ej.id,params:v},...b.redos],u).result&&d.pushUndoRedo({unitID:I,undoMutations:[...null!=(i=b.preUndos)?i:[],{id:rU.id,params:S},{id:ej.id,params:w},...null!=(s=b.undos)?s:[]],redoMutations:[...null!=(a=b.preRedos)?a:[],{id:rE.id,params:f},{id:ej.id,params:v},...b.redos]}),!0},"handler")};function rN(e,t){let n=e.getMaxColumns()-1,r=e.getHiddenRows(),o=[];return t.forEach(e=>{let t=r.filter(t=>t.startRow>=e.startRow&&t.endRow<=e.endRow);if(t.length){let r=e.startRow;t.forEach(e=>{e.startRow>r&&(o.push({startRow:r,endRow:e.startRow-1,startColumn:0,endColumn:n}),r=e.endRow+1)}),r<=e.endRow&&o.push({startRow:r,endRow:e.endRow,startColumn:0,endColumn:n})}else o.push(e)}),o}function rO(e){return rD(e).map(e=>{let t=0===e.startRow?e.endRow+1:e.startRow-1;return{...e,startRow:t,endRow:t}})}function rD(e){let t;let n=[];return e.sort((e,t)=>e.startRow-t.startRow).forEach(e=>{if(!t){t=e;return}e.startRow===t.endRow+1?t.endRow=e.endRow:(n.push(t),t=e)}),n.push(t),n}_(rN,"divideRangesByHiddenRows"),_(rO,"getSelectionsAfterHiding"),_(rD,"mergeSelections");let rP={type:c.CommandType.COMMAND,id:"sheet.command.set-style",handler:/* @__PURE__ */_(async(e,t)=>{var n;let r=eU(e.get(c.IUniverInstanceService),t);if(!r)return!1;let{unitId:o,subUnitId:i,worksheet:s}=r,{range:a,style:l}=t,u=e.get(c.ICommandService),d=e.get(c.IUndoRedoService),h=e.get(j),m=a?[a]:null==(n=h.getCurrentSelections())?void 0:n.map(e=>e.range);if(!(null!=m&&m.length))return!1;let g=new c.ObjectMatrix,p=ez(s);if((0,c.Tools).isArray(l.value))for(let e=0;e<m.length;e++)p.forOperableEach(m[e],(e,t,n)=>{g.setValue(e,t,{s:{[l.type]:l.value[e-n.startRow][t-n.startColumn]}})});else for(let e=0;e<m.length;e++){let t={s:{[l.type]:l.value}};p.forOperableEach(m[e],(e,n)=>g.setValue(e,n,t))}let I={subUnitId:i,unitId:o,cellValue:g.getMatrix()},C=em(e,I),R=u.syncExecuteCommand(eg.id,I),{undos:f,redos:v}=e.get(X).onCommandExecute({id:rP.id,params:t}),S=(0,c.sequenceExecute)([...v],u);return!!R&&!!S.result&&(d.pushUndoRedo({unitID:I.unitId,undoMutations:[{id:eg.id,params:C},...f],redoMutations:[{id:eg.id,params:I},...v]}),!0)},"handler")},rA={type:c.CommandType.COMMAND,id:"sheet.command.set-bold",handler:/* @__PURE__ */_(async e=>{let t=e.get(j).getCurrentLastSelection();if(!t)return!1;let n=eU(e.get(c.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,{actualRow:o,actualColumn:i}=t.primary,s={style:{type:"bl",value:r.getRange(o,i).getFontWeight()===c.FontWeight.BOLD?c.BooleanNumber.FALSE:c.BooleanNumber.TRUE}};return e.get(c.ICommandService).executeCommand(rP.id,s)},"handler")},rV={type:c.CommandType.COMMAND,id:"sheet.command.set-italic",handler:/* @__PURE__ */_(async e=>{let t=e.get(j).getCurrentLastSelection();if(!t)return!1;let n=eU(e.get(c.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,o=!0;if(t.primary){let{startRow:e,startColumn:n}=t.primary;o=r.getRange(e,n).getFontStyle()===c.FontItalic.ITALIC}let i={style:{type:"it",value:o?c.BooleanNumber.FALSE:c.BooleanNumber.TRUE}};return e.get(c.ICommandService).executeCommand(rP.id,i)},"handler")},r$={type:c.CommandType.COMMAND,id:"sheet.command.set-underline",handler:/* @__PURE__ */_(async e=>{let t=e.get(j).getCurrentLastSelection();if(!t)return!1;let n=eU(e.get(c.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,o=!0;t.primary&&(o=!!r.getRange(t.primary.startRow,t.primary.startColumn).getUnderline().s);let i={style:{type:"ul",value:{s:o?c.BooleanNumber.FALSE:c.BooleanNumber.TRUE}}};return e.get(c.ICommandService).executeCommand(rP.id,i)},"handler")},rW={type:c.CommandType.COMMAND,id:"sheet.command.set-stroke",handler:/* @__PURE__ */_(async e=>{let t=e.get(j).getCurrentLastSelection();if(!t)return!1;let n=eU(e.get(c.IUniverInstanceService));if(!n)return!1;let{worksheet:r}=n,o=!0;t.primary&&(o=!!r.getRange(t.primary.actualRow,t.primary.actualColumn).getStrikeThrough().s);let i={style:{type:"st",value:{s:o?c.BooleanNumber.FALSE:c.BooleanNumber.TRUE}}};return e.get(c.ICommandService).executeCommand(rP.id,i)},"handler")},rj=(c.CommandType.COMMAND,{type:c.CommandType.COMMAND,id:"sheet.command.set-font-family",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(c.ICommandService),r={style:{type:"ff",value:t.value}};return n.executeCommand(rP.id,r)},"handler")}),rL={type:c.CommandType.COMMAND,id:"sheet.command.set-font-size",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(c.ICommandService),r={style:{type:"fs",value:t.value}};return n.executeCommand(rP.id,r)},"handler")},rB={type:c.CommandType.COMMAND,id:"sheet.command.set-text-color",handler:/* @__PURE__ */_(async(e,t)=>{if(!t||!t.value)return!1;let n=e.get(c.ICommandService),r={style:{type:"cl",value:{rgb:t.value}}};return n.executeCommand(rP.id,r)},"handler")},rH={type:c.CommandType.COMMAND,id:"sheet.command.reset-text-color",handler:/* @__PURE__ */_(async e=>e.get(c.ICommandService).executeCommand(rP.id,{style:{type:"cl",value:{rgb:null}}}),"handler")},rF={type:c.CommandType.COMMAND,id:"sheet.command.set-background-color",handler:/* @__PURE__ */_(async(e,t)=>{if(!t||!t.value)return!1;let n=e.get(c.ICommandService),r={style:{type:"bg",value:{rgb:t.value}}};return n.executeCommand(rP.id,r)},"handler")},rG={type:c.CommandType.COMMAND,id:"sheet.command.reset-background-color",handler:/* @__PURE__ */_(async e=>e.get(c.ICommandService).executeCommand(rP.id,{style:{type:"bg",value:{rgb:null}}}),"handler")},rq={type:c.CommandType.COMMAND,id:"sheet.command.set-vertical-text-align",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(c.ICommandService),r={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"vt",value:t.value}};return n.executeCommand(rP.id,r)},"handler")},rz={type:c.CommandType.COMMAND,id:"sheet.command.set-horizontal-text-align",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(c.ICommandService),r={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"ht",value:t.value}};return n.executeCommand(rP.id,r)},"handler")},rY={type:c.CommandType.COMMAND,id:"sheet.command.set-text-wrap",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n=e.get(c.ICommandService),r={unitId:t.unitId,subUnitId:t.subUnitId,range:t.range,style:{type:"tb",value:t.value}};return n.executeCommand(rP.id,r)},"handler")},rJ={type:c.CommandType.COMMAND,id:"sheet.command.set-text-rotation",handler:/* @__PURE__ */_(async(e,t)=>{if(!t)return!1;let n="number"==typeof t.value?{a:t.value}:{a:0,v:c.BooleanNumber.TRUE};return e.get(c.ICommandService).executeCommand(rP.id,{style:{type:"tr",value:n}})},"handler")},rK=/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().tabColor;return{...(0,c.Tools).deepClone(t),color:n}},"SetTabColorUndoMutationFactory"),rX={id:"sheet.mutation.set-tab-color",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().tabColor=t.color,!0)},"handler")},rZ={type:c.CommandType.COMMAND,id:"sheet.command.set-tab-color",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=eU(e.get(c.IUniverInstanceService));if(!o)return!1;let{unitId:i,subUnitId:s}=o,a={color:t.value,unitId:i,subUnitId:s},l=rK(e,a);return!!n.syncExecuteCommand(rX.id,a)&&(r.pushUndoRedo({unitID:i,undoMutations:[{id:rX.id,params:l}],redoMutations:[{id:rX.id,params:a}]}),!0)},"handler")},rQ={id:"sheet.mutation.set-workbook-name",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUnit(t.unitId,c.UniverInstanceType.UNIVER_SHEET);return!!n&&(n.setName(t.name),!0)},"handler")},r0={type:c.CommandType.COMMAND,id:"sheet.command.set-workbook-name",handler:/* @__PURE__ */_(async(e,t)=>{var n;if(!e.get(c.IUniverInstanceService).getUnit(t.unitId,c.UniverInstanceType.UNIVER_SHEET))return!1;let r=e.get(X).onCommandExecute({id:r0.id,params:t}),o={name:t.name,unitId:t.unitId},i=[...null!=(n=r.preRedos)?n:[],{id:rQ.id,params:o},...r.redos],s=e.get(c.ICommandService);return(0,c.sequenceExecute)(i,s).result},"handler")},r1={id:"sheet.operation.set-worksheet-active",type:c.CommandType.OPERATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;for(let[,e]of n.getWorksheets())if(e.getSheetId()===t.subUnitId)return n.setActiveSheet(e),!0;return!1},"handler")},r2={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-activate",handler:/* @__PURE__ */_((e,t,n)=>{let r=e.get(c.ICommandService),o=eU(e.get(c.IUniverInstanceService),t);if(!o)return!1;let{unitId:i,subUnitId:s}=o;return new Promise(e=>{setTimeout(()=>{e(r.syncExecuteCommand(r1.id,{unitId:i,subUnitId:s},n))},4)})},"handler")},r5=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ranges:o}=e,i={},s=t.getColumnManager();for(let e=0;e<o.length;e++){let t=o[e];for(let e=t.startColumn;e<t.endColumn+1;e++){let t=s.getColumnOrCreate(e);i[e]=t.w}}return{unitId:n,subUnitId:r,ranges:o,colWidth:i}},"SetWorksheetColWidthMutationFactory"),r3={id:"sheet.mutation.set-worksheet-col-width",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let r=eU(e.get(c.IUniverInstanceService),t);if(!r)return!1;let{worksheet:o}=r,i=o.getConfig().defaultColumnWidth,s=o.getColumnManager(),a=t.ranges;for(let e=0;e<a.length;e++){let r=a[e];for(let e=r.startColumn;e<r.endColumn+1;e++){if(!o.getColVisible(e))continue;let r=s.getColumnOrCreate(e);"number"==typeof t.colWidth?r.w=t.colWidth:r.w=null!=(n=t.colWidth[e])?n:i}}return!0},"handler")},r4={type:c.CommandType.COMMAND,id:"sheet.command.delta-column-width",handler:/* @__PURE__ */_(async(e,t)=>{let n;let r=e.get(j).getCurrentSelections();if(!(null!=r&&r.length))return!1;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=eU(e.get(c.IUniverInstanceService));if(!s)return!1;let{worksheet:a,unitId:l,subUnitId:u}=s,{anchorCol:d,deltaX:h}=t,m=a.getColumnWidth(d)+h,g=1===r.length&&r[0].range.rangeType===c.RANGE_TYPE.ALL,p=r.filter(e=>e.range.rangeType===c.RANGE_TYPE.COLUMN),I=g?c.RANGE_TYPE.ALL:p.some(({range:e})=>{let{startColumn:t,endColumn:n}=e;return t<=d&&d<=n})?c.RANGE_TYPE.COLUMN:c.RANGE_TYPE.NORMAL;if(I===c.RANGE_TYPE.ALL){let e=a.getRowCount();n={subUnitId:u,unitId:l,colWidth:m,ranges:Array(a.getColumnCount()).fill(void 0).map((t,n)=>({startRow:0,endRow:e-1,startColumn:n,endColumn:n}))}}else n=I===c.RANGE_TYPE.COLUMN?{subUnitId:u,unitId:l,ranges:p.map(e=>(0,c.Rectangle).clone(e.range)),colWidth:m}:{subUnitId:u,unitId:l,colWidth:m,ranges:[{startRow:0,endRow:a.getMaxRows()-1,startColumn:d,endColumn:d}]};let{undos:C,redos:R}=e.get(X).onCommandExecute({id:r4.id,params:n}),f=r5(n,a),v=o.syncExecuteCommand(r3.id,n),S=(0,c.sequenceExecute)([...R],o);return v&&S.result&&i.pushUndoRedo({unitID:l,undoMutations:[{id:r3.id,params:f},...C],redoMutations:[{id:r3.id,params:n},...R]}),!0},"handler")},r6={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-col-width",handler:/* @__PURE__ */_(async(e,t)=>{var n,r,o,i;let s=e.get(j),a=e.get(c.ICommandService),l=e.get(c.IUndoRedoService),u=e.get(X),d=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=s.getCurrentSelections())?void 0:r.map(e=>e.range);if(!(null!=d&&d.length))return!1;let h=eU(e.get(c.IUniverInstanceService),t);if(!h)return!1;let{subUnitId:m,unitId:g,worksheet:p}=h,I={subUnitId:m,unitId:g,ranges:d,colWidth:t.value},C=r5(I,p),R=a.syncExecuteCommand(r3.id,I),{undos:f,redos:v}=e.get(X).onCommandExecute({id:r6.id,params:I}),S=u.onCommandExecute({id:r6.id,params:I}),w=(0,c.sequenceExecute)([...v,...S.redos],a);return!!R&&!!w.result&&(l.pushUndoRedo({unitID:g,undoMutations:[...null!=(o=S.preUndos)?o:[],{id:r3.id,params:C},...f],redoMutations:[...null!=(i=S.preRedos)?i:[],{id:r3.id,params:I},...v]}),!0)},"handler")},r7={type:c.CommandType.COMMAND,id:"sheet.command.set-col-is-auto-width",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=e.get(j),i=eU(e.get(c.IUniverInstanceService),t);if(!i)return!1;let{unitId:s,subUnitId:a}=i,l=[];if(null!=t&&t.ranges)l=[...t.ranges];else{let e=o.getCurrentSelections();for(let t=0;t<e.length;t++)l.push(e[t].range)}if(!(null!=l&&l.length))return!1;let u={unitId:s,subUnitId:a,ranges:l},{undos:d,redos:h}=e.get(X).onCommandExecute({id:r7.id,params:u});return!!(0,c.sequenceExecute)([...h],n).result&&(r.pushUndoRedo({unitID:s,undoMutations:[...d],redoMutations:[...h]}),!0)},"handler")},r8=/* @__PURE__ */_((e,t)=>{let n=e_(e.get(c.IUniverInstanceService),t);if(!n)throw Error("[SetWorksheetHideMutationFactory]: worksheet is null error!");let{worksheet:r}=n;return{hidden:r.isSheetHidden(),unitId:t.unitId,subUnitId:r.getSheetId()}},"SetWorksheetHideMutationFactory"),r9={id:"sheet.mutation.set-worksheet-hidden",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().hidden=t.hidden,!0)},"handler")},oe={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-hidden",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=e.get(c.ErrorService),i=e.get(c.LocaleService),s=eU(e.get(c.IUniverInstanceService),t);if(!s)return!1;let{workbook:a,worksheet:l,unitId:u,subUnitId:d}=s;if(l.getConfig().hidden===c.BooleanNumber.TRUE)return!1;let h={unitId:u,subUnitId:d,hidden:c.BooleanNumber.TRUE},m=r8(e,h);return 1===a.getSheets().filter(e=>e.getConfig().hidden===c.BooleanNumber.FALSE).length?(o.emit(i.t("sheets.info.hideSheet")),!1):!!n.syncExecuteCommand(r9.id,h)&&(r.pushUndoRedo({unitID:u,undoMutations:[{id:r9.id,params:m}],redoMutations:[{id:r9.id,params:h}]}),!0)},"handler")},ot=/* @__PURE__ */_((e,t)=>{let n=e_(e.get(c.IUniverInstanceService),t);if(!n)throw Error("[SetWorksheetNameMutationFactory]: worksheet is null error!");let{worksheet:r}=n;return{unitId:t.unitId,name:r.getName(),subUnitId:r.getSheetId()}},"SetWorksheetNameMutationFactory"),on={id:"sheet.mutation.set-worksheet-name",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(null==n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().name=t.name,!0)},"handler")},or={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-name",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(X),a=eU(e.get(c.IUniverInstanceService),t);if(!a)return!1;let{unitId:l,subUnitId:u}=a,d={subUnitId:u,name:t.name,unitId:l},h=ot(e,d),m=s.onCommandExecute({id:or.id,params:t}),g=[...null!=(n=m.preRedos)?n:[],{id:on.id,params:d},...m.redos],p=[...null!=(r=m.preUndos)?r:[],{id:on.id,params:h},...m.undos];return!!await (0,c.sequenceExecute)(g,o).result&&(i.pushUndoRedo({unitID:l,undoMutations:p,redoMutations:g}),!0)},"handler")},oo=/* @__PURE__ */_((e,t)=>({...(0,c.Tools).deepClone(t),toOrder:t.fromOrder,fromOrder:t.toOrder}),"SetWorksheetOrderUndoMutationFactory"),oi={id:"sheet.mutation.set-worksheet-order",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getConfig();return r.sheetOrder.splice(t.fromOrder,1),r.sheetOrder.splice(t.toOrder,0,t.subUnitId),!0},"handler")},os={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-order",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=eU(e.get(c.IUniverInstanceService),t);if(!o)return!1;let{workbook:i,unitId:s,subUnitId:a}=o,l={fromOrder:i.getConfig().sheetOrder.indexOf(a),toOrder:t.order,unitId:s,subUnitId:a},u=oo(e,l);return!!n.syncExecuteCommand(oi.id,l)&&(r.pushUndoRedo({unitID:s,undoMutations:[{id:oi.id,params:u}],redoMutations:[{id:oi.id,params:l}]}),!0)},"handler")},oa=class{constructor(e,t,n){E(this,"type",e0.SelectRange),E(this,"subType",eQ.Delete),E(this,"status",c.PermissionStatus.INIT),E(this,"value",!0),E(this,"id"),E(this,"unitId"),E(this,"subUnitId"),E(this,"permissionId"),this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${e0.SelectRange}.${eQ.Delete}.${n}`}};_(oa,"RangeProtectionPermissionDeleteProtectionPoint");let ol=class{constructor(e,t,n){E(this,"type",e0.SelectRange),E(this,"subType",eQ.ManageCollaborator),E(this,"status",c.PermissionStatus.INIT),E(this,"value",!0),E(this,"id"),E(this,"unitId"),E(this,"subUnitId"),E(this,"permissionId"),this.unitId=e,this.subUnitId=t,this.permissionId=n,this.id=`${e0.SelectRange}.${eQ.ManageCollaborator}.${n}`}};_(ol,"RangeProtectionPermissionManageCollaPoint");let ou=/* @__PURE__ */_(()=>[e3,e2,ol,oa],"getAllRangePermissionPoint"),od=[eQ.Edit,eQ.View,eQ.ManageCollaborator,eQ.Delete],oc=(/* @__PURE__ */(e="unitId",t="subUnitId",n="permissionId")=>ou().reduce((r,o)=>{let i=new o(e,t,n);return r[i.subType]=i.value,r},{}),/* @__PURE__ */_(()=>[tl,tI,e6,tw,e8,tu,tm,tr,ti,tf,tc,ts,tv,tp,e9,tb,tC,tt],"getAllWorkbookPermissionPoint")),oh=[eQ.Edit,eQ.Print,eQ.Comment,eQ.View,eQ.Copy,eQ.Export,eQ.ManageCollaborator,eQ.CreateSheet,eQ.DeleteSheet,eQ.RenameSheet,eQ.HideSheet,eQ.Duplicate,eQ.Share,eQ.MoveSheet,eQ.CopySheet,eQ.RecoverHistory,eQ.ViewHistory,eQ.CreatePermissionObject],om=/* @__PURE__ */_(()=>[tO,t2,tF,tT],"getAllWorksheetPermissionPoint"),og=/* @__PURE__ */_(()=>[tM,t_,tx,tD,tA,t$,tB,tj,tG,tz,tJ,tX,tQ,t0],"getAllWorksheetPermissionPointByPointPanel"),op=[eQ.Copy,eQ.DeleteColumn,eQ.DeleteRow,eQ.EditExtraObject,eQ.Filter,eQ.InsertColumn,eQ.InsertRow,eQ.InsertHyperlink,eQ.PivotTable,eQ.SetCellStyle,eQ.SetCellValue,eQ.SetColumnStyle,eQ.SetRowStyle,eQ.Sort],oI=class{constructor(){E(this,"_model",/* @__PURE__ */new Map),E(this,"_pointChange",new S.Subject),E(this,"pointChange$",this._pointChange.asObservable())}addRule(e){this._ensureSubUnitMap(e.unitId).set(e.subUnitId,e),this._pointChange.next(e)}deleteRule(e,t){var n,r,o;let i=null==(n=this._model.get(e))?void 0:n.get(t);i&&(null==(o=null==(r=this._model)?void 0:r.get(e))||o.delete(t),this._pointChange.next(i))}getRule(e,t){var n,r;return null==(r=null==(n=this._model)?void 0:n.get(e))?void 0:r.get(t)}toObject(){let e={};return[...this._model.keys()].forEach(t=>{let n=this._model.get(t);null!=n&&n.size&&(e[t]=[],[...n.keys()].forEach(r=>{let o=n.get(r);o&&e[t].push(o)}))}),e}fromObject(e){let t=/* @__PURE__ */new Map;Object.keys(e).forEach(n=>{let r=e[n];if(null!=r&&r.length){let e=/* @__PURE__ */new Map;r.forEach(t=>{e.set(t.subUnitId,t)}),t.set(n,e)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=/* @__PURE__ */new Map,this._model.set(e,t)),t}getTargetByPermissionId(e,t){let n=this._model.get(e);if(!n)return null;for(let[r,o]of n)if(o.permissionId===t)return[e,r]}};_(oI,"WorksheetProtectionPointModel");let oC=oI,oR=class{constructor(){E(this,"_model",/* @__PURE__ */new Map),E(this,"_ruleChange",new S.Subject),E(this,"_ruleRefresh",new S.Subject),E(this,"_resetOrder",new S.Subject),E(this,"ruleChange$",this._ruleChange.asObservable()),E(this,"ruleRefresh$",this._ruleRefresh.asObservable()),E(this,"resetOrder$",this._resetOrder.asObservable()),E(this,"_worksheetRuleInitStateChange",new g.BehaviorSubject(!1)),E(this,"worksheetRuleInitStateChange$",this._worksheetRuleInitStateChange.asObservable())}changeRuleInitState(e){this._worksheetRuleInitStateChange.next(e)}getSheetRuleInitState(){return this._worksheetRuleInitStateChange.value}addRule(e,t){this._ensureSubUnitMap(e).set(t.subUnitId,t),this._ruleChange.next({unitId:e,rule:t,type:"add",subUnitId:t.subUnitId})}deleteRule(e,t){var n,r,o;let i=null==(r=null==(n=this._model)?void 0:n.get(e))?void 0:r.get(t);i&&(null==(o=this._model.get(e))||o.delete(t),this._ruleChange.next({unitId:e,rule:i,type:"delete",subUnitId:t}))}setRule(e,t,n){var r,o;let i=this.getRule(e,t);i&&(null==(o=null==(r=this._model)?void 0:r.get(e))||o.set(t,n),this._ruleChange.next({unitId:e,oldRule:i,rule:n,type:"set",subUnitId:t}))}getRule(e,t){var n,r;return null==(r=null==(n=this._model)?void 0:n.get(e))?void 0:r.get(t)}toObject(){let e={};return[...this._model.keys()].forEach(t=>{let n=this._model.get(t);null!=n&&n.size&&(e[t]=[],[...n.keys()].forEach(r=>{let o=n.get(r);o&&e[t].push(o)}))}),e}fromObject(e){let t=/* @__PURE__ */new Map;Object.keys(e).forEach(n=>{let r=e[n];if(null!=r&&r.length){let e=/* @__PURE__ */new Map;r.forEach(t=>{e.set(t.subUnitId,t)}),t.set(n,e)}}),this._model=t}deleteUnitModel(e){this._model.delete(e)}_ensureSubUnitMap(e){let t=this._model.get(e);return t||(t=/* @__PURE__ */new Map,this._model.set(e,t)),t}ruleRefresh(e){this._ruleRefresh.next(e)}resetOrder(){this._resetOrder.next(Math.random())}getTargetByPermissionId(e,t){let n=this._model.get(e);if(!n)return null;for(let[r,o]of n)if(o.permissionId===t)return[e,r]}};_(oR,"WorksheetProtectionRuleModel");let of=oR;var ov=Object.defineProperty,oS=Object.getOwnPropertyDescriptor,ow=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?oS(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&ov(t,n,i),i},"__decorateClass$d"),ob=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$d");let oy=(o8=class extends c.RxDisposable{constructor(e,t,n,r,o,i,s){super(),this._permissionService=e,this._univerInstanceService=t,this._injector=n,this._worksheetProtectionRuleModel=r,this._worksheetProtectionPointRuleModel=o,this._resourceManagerService=i,this._rangeProtectionRuleModel=s,this._init(),this._initRuleChange(),this._initRuleSnapshot(),this._initPointSnapshot()}_init(){let e=/* @__PURE__ */_(e=>{let t=e.getUnitId(),n=/* @__PURE__ */_(e=>{let n=e.getSheetId();[...om(),...og()].forEach(e=>{let r=new e(t,n);this._permissionService.addPermissionPoint(r)})},"handleWorksheet");e.getSheets().forEach(e=>{n(e)}),e.sheetCreated$.subscribe(e=>{n(e)}),e.sheetDisposed$.subscribe(e=>{let n=e.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(t,n).forEach(e=>{[...ou()].forEach(r=>{let o=new r(t,n,e.permissionId);this._permissionService.deletePermissionPoint(o.id)})}),[...om(),...og()].forEach(e=>{let r=new e(t,n);this._permissionService.deletePermissionPoint(r.id)})})},"handleWorkbook");this._univerInstanceService.getAllUnitsForType(c.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this._univerInstanceService.getTypeOfUnitAdded$(c.UniverInstanceType.UNIVER_SHEET).pipe((0,b.takeUntil)(this.dispose$)).subscribe(e),this._univerInstanceService.getTypeOfUnitDisposed$(c.UniverInstanceType.UNIVER_SHEET).pipe((0,b.takeUntil)(this.dispose$)).subscribe(e=>{e.getSheets().forEach(t=>{let n=e.getUnitId(),r=t.getSheetId();om().forEach(e=>{let t=new e(n,r);this._permissionService.deletePermissionPoint(t.id)})})})}_initRuleChange(){this.disposeWithMe(this._worksheetProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":break;case"delete":om().forEach(t=>{let n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,!0)});break;case"set":om().forEach(t=>{let n=new t(e.unitId,e.subUnitId);this._permissionService.updatePermissionPoint(n.id,e.rule)})}}))}_initRuleSnapshot(){let e=/* @__PURE__ */_(()=>JSON.stringify(this._worksheetProtectionRuleModel.toObject()),"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:"SHEET_WORKSHEET_PROTECTION_PLUGIN",businesses:[eZ.UNIVER_SHEET],onLoad:/* @__PURE__ */_((e,t)=>{this._worksheetProtectionRuleModel.fromObject(t),Object.keys(t).forEach(t=>{om().forEach(n=>{let r=new n(e,t);r.value=!1,this._permissionService.addPermissionPoint(r)})}),this._worksheetProtectionRuleModel.changeRuleInitState(!0)},"onLoad"),onUnLoad:/* @__PURE__ */_(e=>{let t=this._univerInstanceService.getUnit(e);t&&(t.getSheets().forEach(t=>{let n=t.getSheetId();[...om(),...og()].forEach(t=>{let r=new t(e,n);this._permissionService.deletePermissionPoint(r.id)})}),oc().forEach(t=>{let n=new t(e);this._permissionService.deletePermissionPoint(n.id)})),this._worksheetProtectionRuleModel.deleteUnitModel(e)},"onUnLoad")}))}_initPointSnapshot(){let e=/* @__PURE__ */_(()=>JSON.stringify(this._worksheetProtectionPointRuleModel.toObject()),"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:"SHEET_WORKSHEET_PROTECTION_POINT_PLUGIN",businesses:[eZ.UNIVER_SHEET],onLoad:/* @__PURE__ */_((e,t)=>{this._worksheetProtectionPointRuleModel.fromObject(t),Object.keys(t).forEach(t=>{og().forEach(n=>{let r=new n(e,t);this._permissionService.addPermissionPoint(r)})})},"onLoad"),onUnLoad:/* @__PURE__ */_(e=>{this._worksheetProtectionPointRuleModel.deleteUnitModel(e)},"onUnLoad")}))}},_(o8,"WorksheetPermissionService"),o8);oy=ow([ob(0,(0,c.Inject)(c.IPermissionService)),ob(1,(0,c.Inject)(c.IUniverInstanceService)),ob(2,(0,c.Inject)(c.Injector)),ob(3,(0,c.Inject)(of)),ob(4,(0,c.Inject)(oC)),ob(5,(0,c.Inject)(c.IResourceManagerService)),ob(6,(0,c.Inject)(k))],oy);let oM={id:"sheet.mutation.set-worksheet-permission-points",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{rule:n}=t;return e.get(oC).addRule(n),!0},"handler")},oU={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-permission-points",async handler(e,t){if(!t)return!1;let n=e.get(c.ICommandService),{rule:r}=t;return n.executeCommand(oM.id,{rule:r,unitId:r.unitId,subUnitId:r.subUnitId}),!0}},o_=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ranges:o}=e,i={},s=t.getRowManager();for(let{startRow:e,endRow:t}of o)for(let n=e;n<t+1;n++){let e=s.getRowOrCreate(n);i[n]=e.h}return{unitId:n,subUnitId:r,ranges:o,rowHeight:i}},"SetWorksheetRowHeightMutationFactory"),oE=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,ranges:o}=e,i={},s=t.getRowManager();for(let{startRow:e,endRow:t}of o)for(let n=e;n<=t;n++){let e=s.getRowOrCreate(n);i[n]=e.ia}return{unitId:n,subUnitId:r,ranges:o,autoHeightInfo:i}},"SetWorksheetRowIsAutoHeightMutationFactory"),oT=/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rowsAutoHeightInfo:o}=e,i=[],s=t.getRowManager();for(let e of o){let{row:t}=e,{ah:n}=s.getRowOrCreate(t);i.push({row:t,autoHeight:n})}return{unitId:n,subUnitId:r,rowsAutoHeightInfo:i}},"SetWorksheetRowAutoHeightMutationFactory"),ok={id:"sheet.mutation.set-worksheet-row-height",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let{ranges:r,rowHeight:o}=t,i=eU(e.get(c.IUniverInstanceService),t);if(!i)return!1;let{worksheet:s}=i,a=s.getRowManager(),l=s.getConfig().defaultRowHeight;for(let{startRow:e,endRow:t}of r)for(let r=e;r<=t;r++){let e=a.getRowOrCreate(r);"number"==typeof o?e.h=o:e.h=null!=(n=o[r])?n:l,e.h=Math.min(2e3,e.h)}return!0},"handler")},ox={id:"sheet.mutation.set-worksheet-row-is-auto-height",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{var n;let{ranges:r,autoHeightInfo:o}=t,i=eU(e.get(c.IUniverInstanceService),t);if(!i)return!1;let s=i.worksheet.getRowManager();for(let{startRow:e,endRow:t}of r)for(let r=e;r<=t;r++){let e=s.getRowOrCreate(r);"number"==typeof o?e.ia=o:e.ia=null!=(n=o[r])?n:void 0}return!0},"handler")},oN={id:"sheet.mutation.set-worksheet-row-auto-height",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{rowsAutoHeightInfo:n}=t,r=eU(e.get(c.IUniverInstanceService),t);if(!r)return!1;let o=r.worksheet.getRowManager();for(let{row:e,autoHeight:t}of n)o.getRowOrCreate(e).ah=t;return!0},"handler")},oO={type:c.CommandType.COMMAND,id:"sheet.command.delta-row-height",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o;let i=e.get(j).getCurrentSelections(),s=e.get(X);if(!(null!=i&&i.length))return!1;let a=eU(e.get(c.IUniverInstanceService));if(!a)return!1;let{worksheet:l,subUnitId:u,unitId:d}=a,{anchorRow:h,deltaY:m}=t,g=l.getRowHeight(h)+m,p=1===i.length&&i[0].range.rangeType===c.RANGE_TYPE.ALL,I=i.filter(e=>e.range.rangeType===c.RANGE_TYPE.ROW),C=p?c.RANGE_TYPE.ALL:I.some(({range:e})=>{let{startRow:t,endRow:n}=e;return t<=h&&h<=n})?c.RANGE_TYPE.ROW:c.RANGE_TYPE.NORMAL;if(C===c.RANGE_TYPE.ALL){let e=l.getRowCount();o={subUnitId:u,unitId:d,rowHeight:g,ranges:Array(l.getColumnCount()).fill(void 0).map((t,n)=>({startRow:n,endRow:n,startColumn:0,endColumn:e-1}))}}else o=C===c.RANGE_TYPE.ROW?{subUnitId:u,unitId:d,ranges:I.map(e=>(0,c.Rectangle).clone(e.range)),rowHeight:g}:{subUnitId:u,unitId:d,rowHeight:g,ranges:[{startRow:h,endRow:h,startColumn:0,endColumn:l.getMaxColumns()-1}]};let R=o_(o,l),f={unitId:d,subUnitId:u,ranges:o.ranges,autoHeightInfo:c.BooleanNumber.FALSE},v=oE(f,l),S=e.get(c.ICommandService),w=e.get(c.IUndoRedoService),b=s.onCommandExecute({id:oO.id,params:o}),y=(0,c.sequenceExecute)([{id:ok.id,params:o},{id:ox.id,params:f}],S),M=(0,c.sequenceExecute)([...b.redos],S);return!!y.result&&!!M.result&&(w.pushUndoRedo({unitID:d,undoMutations:[...null!=(n=b.preUndos)?n:[],{id:ok.id,params:R},{id:ox.id,params:v},...b.undos],redoMutations:[...null!=(r=b.preRedos)?r:[],{id:ok.id,params:o},{id:ox.id,params:f},...b.redos]}),!0)},"handler")},oD={type:c.CommandType.COMMAND,id:"sheet.command.set-row-height",handler:/* @__PURE__ */_((e,t)=>{var n,r,o,i;let s=e.get(j),a=e.get(c.ICommandService),l=e.get(c.IUndoRedoService),u=e.get(c.IUniverInstanceService),d=e.get(X),h=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=s.getCurrentSelections())?void 0:r.map(e=>e.range);if(!(null!=h&&h.length))return!1;let m=eU(u,t);if(!m)return!1;let{unitId:g,subUnitId:p,worksheet:I}=m,C={subUnitId:p,unitId:g,ranges:h,rowHeight:t.value},R=o_(C,I),f={unitId:g,subUnitId:p,ranges:C.ranges,autoHeightInfo:c.BooleanNumber.FALSE},v=oE(f,I),S=(0,c.sequenceExecute)([{id:ok.id,params:C},{id:ox.id,params:f}],a),w=d.onCommandExecute({id:oD.id,params:C}),b=(0,c.sequenceExecute)([...w.redos],a);return!!S.result&&!!b.result&&(l.pushUndoRedo({unitID:g,undoMutations:[...null!=(o=w.preRedos)?o:[],{id:ok.id,params:R},{id:ox.id,params:v},...w.undos],redoMutations:[...null!=(i=w.preRedos)?i:[],{id:ok.id,params:C},{id:ox.id,params:f},...w.redos]}),!0)},"handler")},oP={type:c.CommandType.COMMAND,id:"sheet.command.set-row-is-auto-height",handler:/* @__PURE__ */_(async(e,t)=>{var n,r;let o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(j),a=eU(e.get(c.IUniverInstanceService),t);if(!a)return!1;let{unitId:l,subUnitId:u,worksheet:d}=a,h=null!=(n=null==t?void 0:t.ranges)&&n.length?t.ranges:null==(r=s.getCurrentSelections())?void 0:r.map(e=>e.range);if(!(null!=h&&h.length))return!1;let m={unitId:l,subUnitId:u,ranges:h,autoHeightInfo:c.BooleanNumber.TRUE},g=oE(m,d),p=o.syncExecuteCommand(ox.id,m),{undos:I,redos:C}=e.get(X).onCommandExecute({id:oP.id,params:m}),R=(0,c.sequenceExecute)([...C],o);return!!p&&!!R.result&&(i.pushUndoRedo({unitID:l,undoMutations:[{id:ox.id,params:g},...I],redoMutations:[{id:ox.id,params:m},...C]}),!0)},"handler")},oA={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-show",handler:/* @__PURE__ */_(async(e,t)=>{let{unitId:n,subUnitId:r}=t,o=e.get(c.ICommandService),i=e.get(c.IUndoRedoService),s=e.get(c.IUniverInstanceService);if(!eU(e.get(c.IUniverInstanceService)))return!1;let a=s.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!a)return!1;let l=a.getSheetBySheetId(r);if(!l||l.getConfig().hidden===c.BooleanNumber.FALSE)return!1;let u={unitId:n,subUnitId:r,hidden:c.BooleanNumber.FALSE},d=r8(e,u),h=o.syncExecuteCommand(r9.id,u),m=o.syncExecuteCommand(r1.id,{unitId:n,subUnitId:r});return!!h&&!!m&&(i.pushUndoRedo({unitID:n,undoMutations:[{id:r9.id,params:d}],redoMutations:[{id:r9.id,params:u}]}),!0)},"handler")},oV={id:"sheet.command.toggle-cell-checkbox",type:c.CommandType.COMMAND,handler:/* @__PURE__ */_((e,t)=>{if(!t)return!1;let{unitId:n,subUnitId:r,row:o,col:i,paragraphIndex:s}=t,a=e.get(c.IUniverInstanceService).getUnit(n,c.UniverInstanceType.UNIVER_SHEET),l=null==a?void 0:a.getSheetBySheetId(r),u=e.get(c.IUndoRedoService),d=e.get(c.ICommandService);if(!l)return!1;let h=l.getCell(o,i);if(!(null!=h&&h.p))return!1;let m=(0,c.Tools).deepClone(h.p),g=new c.DocumentDataModel(m),p=(0,c.BuildTextUtils).paragraph.bullet.toggleChecklist({document:g,paragraphIndex:s});if(!p)return!1;(0,c.TextX).apply(g.getBody(),p.serialize());let I={unitId:n,subUnitId:r,cellValue:{[o]:{[i]:{p:m,t:c.CellValueType.STRING}}}},C={id:eg.id,params:I},R=em(e,I),f={id:eg.id,params:R},v=[C];return u.pushUndoRedo({redoMutations:v,undoMutations:[f],unitID:n}),d.syncExecuteCommand(C.id,C.params)},"handler")},o$={id:"sheet.mutation.toggle-gridlines",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=eU(e.get(c.IUniverInstanceService),t);if(!n)return!1;let{worksheet:r}=n;return r.getConfig().showGridlines=t.showGridlines,!0},"handler")},oW={type:c.CommandType.COMMAND,id:"sheet.command.toggle-gridlines",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=eU(e.get(c.IUniverInstanceService));if(!o)return!1;let{worksheet:i}=o,s=i.getConfig().showGridlines;if(s===(null==t?void 0:t.showGridlines))return!1;let{unitId:a,subUnitId:l}=o,u={showGridlines:s===c.BooleanNumber.TRUE?c.BooleanNumber.FALSE:c.BooleanNumber.TRUE,unitId:a,subUnitId:l};return!!n.syncExecuteCommand(o$.id,u)&&(r.pushUndoRedo({unitID:a,undoMutations:[{id:o$.id,params:{showGridlines:s,unitId:a,subUnitId:l}}],redoMutations:[{id:o$.id,params:u}]}),!0)},"handler")},oj={id:"sheet.mutation.add-worksheet-protection",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,rule:r}=t;return e.get(of).addRule(n,r),!0},"handler")},oL={id:"sheet.mutation.delete-worksheet-protection",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r}=t;return e.get(of).deleteRule(n,r),!0},"handler")},oB={id:"sheet.mutation.empty",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_(()=>!0,"handler")},oH=/* @__PURE__ */_(e=>{let t=new c.ObjectMatrix;return e.forEach(e=>{(0,c.Range).foreach(e,(e,n)=>{t.setValue(e,n,1)})}),t.forValue((e,n)=>{let r=t.getValue(e-1,n);r&&t.setValue(e,n,r+1)}),t},"createTopMatrixFromRanges"),oF=/* @__PURE__ */_(e=>(e.forValue((t,n)=>{let r=e.getValue(t-1,n);r&&e.setValue(t,n,r+1)}),e),"createTopMatrixFromMatrix"),oG=/* @__PURE__ */_(e=>{let t={area:0},n=/* @__PURE__ */_((e,n)=>t.area<e&&(t.area=e,t.range=n,!0),"checkArea");return e.forValue((t,r,o)=>{let i=1,s=o;n(1*s,{startRow:t-s+1,endRow:t,startColumn:r,endColumn:r});let a={startRow:t-s+1,endRow:t,startColumn:0,endColumn:r};for(let o=r-1;o>=0&&e.getValue(t,o);o--){let r=(s=Math.min(e.getValue(t,o)||0,s))*++i;a.startColumn=o,a.startRow=t-s+1,n(r,a)}}),t},"findMaximalRectangle"),oq=/* @__PURE__ */_((e,t)=>{(0,c.Range).foreach(t,(t,n)=>{e.realDeleteValue(t,n)});for(let n=t.startColumn;n<=t.endColumn;n++){let r=t.endRow+1;if(e.getValue(r,n)>0){e.setValue(r,n,1);let t=r+1;for(;e.getValue(t,n)>0;)e.setValue(t,n,e.getValue(t-1,n)+1),t++}}return e},"filterLeftMatrix"),oz=/* @__PURE__ */_(e=>{let t=[],n=oG(e);for(;n.area>0;)n.range&&(t.push(n.range),oq(e,n.range)),n=oG(e);return t},"findAllRectangle"),oY=/* @__PURE__ */_(e=>oz(oH(e)),"rangeMerge");_(class{constructor(){E(this,"_matrix",new c.ObjectMatrix)}add(...e){return e.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{this._matrix.setValue(e,t,1)})}),this}subtract(...e){return e.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{this._matrix.realDeleteValue(e,t)})}),this}merge(){return oz(oF(this._matrix))}},"RangeMergeUtil");let oJ=(0,c.createIdentifier)("INumfmtService"),oK=/* @__PURE__ */_((e,t)=>{let n=e.get(oJ),{values:r,unitId:o,subUnitId:i}=t,s=[],a=[];Object.keys(r).forEach(e=>{r[e].ranges.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{let r=n.getValue(o,i,e,t);r?s.push({pattern:r.pattern,row:e,col:t}):a.push({startColumn:t,endColumn:t,startRow:e,endRow:e})})})});let l=[];if(s.length){let e=o0(o,i,s);Object.keys(e.values).forEach(t=>{let n=e.values[t];n.ranges=oY(n.ranges)}),l.push({id:oX.id,params:o0(o,i,s)})}return a.length&&l.push({id:oZ.id,params:{unitId:o,subUnitId:i,ranges:a}}),l},"factorySetNumfmtUndoMutation"),oX={id:"sheet.mutation.set.numfmt",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{if(!t)return!1;let{values:n,refMap:r}=t,o=e.get(oJ),i=t.unitId,s=t.subUnitId,a=Object.keys(n).reduce((e,t)=>{let o=r[t],i=n[t].ranges;return o&&e.push({...o,ranges:i}),e},[]);return o.setValues(i,s,a),!0},"handler")},oZ={id:"sheet.mutation.remove.numfmt",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{if(!t)return!1;let{unitId:n,subUnitId:r,ranges:o}=t;return e.get(oJ).deleteValues(n,r,o),!0},"handler")},oQ=/* @__PURE__ */_((e,t)=>{let n=e.get(oJ),{ranges:r,unitId:o,subUnitId:i}=t,s=[];if(r.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{let r=n.getValue(o,i,e,t);r&&s.push({pattern:r.pattern,row:e,col:t})})}),!s.length)return[];let a=o0(o,i,s);return Object.keys(a.values).forEach(e=>{let t=a.values[e];t.ranges=oY(t.ranges)}),[{id:oX.id,params:a}]},"factoryRemoveNumfmtUndoMutation"),o0=/* @__PURE__ */_((e,t,n)=>{let r=ep(n,"pattern"),o={},i={},s=eI();return Object.keys(r).forEach(e=>{let t=r[e],n=s();o[n]={pattern:e},t.forEach(e=>{i[n]||(i[n]={ranges:[]}),i[n].ranges.push((0,c.cellToRange)(e.row,e.col))})}),{unitId:e,subUnitId:t,refMap:o,values:i}},"transformCellsToRange"),o1={id:"sheet.mutation.set-worksheet-default-style",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{defaultStyle:n}=t,r=eU(e.get(c.IUniverInstanceService));if(!r)return!1;let{worksheet:o}=r;return!!o&&(o.setDefaultCellStyle(n),!0)},"handler")},o2=/* @__PURE__ */_((e,t)=>{let n=e_(e.get(c.IUniverInstanceService),t);if(!n)throw Error("[SetWorksheetDefaultStyleMutationFactory]: worksheet is null error!");let{worksheet:r}=n;return{unitId:t.unitId,subUnitId:r.getSheetId(),defaultStyle:r.getDefaultCellStyle()}},"SetWorksheetDefaultStyleMutationFactory"),o5={id:"sheet.mutation.set-worksheet-protection",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let{unitId:n,subUnitId:r,rule:o}=t;return e.get(of).setRule(n,r,o),!0},"handler")},o3={id:"sheet.operation.scroll-to-cell",type:c.CommandType.OPERATION,handler:/* @__PURE__ */_(()=>!0,"handler")},o4="ONLY_REGISTER_FORMULA_RELATED_MUTATIONS_KEY",o6="maxCellsPerSheet";var o7,o8,o9,ie=Object.defineProperty,it=Object.getOwnPropertyDescriptor,ir=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?it(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&ie(t,n,i),i},"__decorateClass$c"),io=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$c");let ii=(_(o9=class extends c.Disposable{constructor(e,t,n){var r;super(),this._commandService=e,this._configService=t,this._dataSyncPrimaryController=n,[eg,ni,nr,ey,eN,nb,nM,nu,na,eT,nB,oZ,nj,rQ,on,oX,nq,oB].forEach(e=>{var t;this._commandService.registerCommand(e),null==(t=this._dataSyncPrimaryController)||t.registerSyncingMutations(e)}),null!=(r=this._configService.getConfig(o4))&&r||[ev,eS,ew,ek,t7,t9,r4,oO,nv,nf,nR,nd,nh,nI,np,ng,nS,nx,eK,nT,nV,nP,n$,nY,nH,rG,rH,rF,n9,n8,n4,n6,n7,rc,rs,rl,r6,ro,rr,rf,rR,rC,rz,t5,oD,rx,rE,rU,ry,rb,rd,rk,ru,rT,rP,rZ,rX,rB,rJ,rY,rq,r0,r2,r1,oe,r9,or,os,oi,oN,ok,oP,ox,r3,ej,o3,nt,nO,rp,oA,oW,o$,oU,oj,o5,oL,oM,O,ne,rS,N,x,rv,oV,o1].forEach(e=>this.disposeWithMe(this._commandService.registerCommand(e))),this._configService.setConfig(o6,3e6)}},"BasicWorksheetController"),o9);ii=ir([io(0,c.ICommandService),io(1,c.IConfigService),io(2,(0,c.Optional)(m.DataSyncPrimaryController))],ii);var is,ia=Object.defineProperty,il=Object.getOwnPropertyDescriptor,iu=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?il(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&ia(t,n,i),i},"__decorateClass$b"),id=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$b");let ic=(_(is=class extends c.Disposable{constructor(e,t){super(),this._univerInstanceService=e,this._commandService=t,this._initialize()}_initialize(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(e.id!==h.SetFormulaCalculationResultMutation.id)return;let{unitData:t}=e.params,n=Object.keys(t),r=[];return n.forEach(e=>{let n=t[e];if(null==n)return!0;Object.keys(n).forEach(t=>{let o=n[t];if(null==o)return!0;let i=this._getMergedCellData(e,t,o);r.push({id:eg.id,params:{subUnitId:t,unitId:e,cellValue:i}})})}),r.every(e=>this._commandService.executeCommand(e.id,e.params,{onlyLocal:!0}))}))}_getMergedCellData(e,t,n){let r=this._univerInstanceService.getUniverSheetInstance(e),o=null==r?void 0:r.getStyles(),i=null==r?void 0:r.getSheetBySheetId(t),s=null==i?void 0:i.getCellMatrix(),a=new c.ObjectMatrix(n);return a.forValue((e,t,n)=>{let r=null==s?void 0:s.getValue(e,t),i=(0,h.handleNumfmtInCell)(r,n,o);a.setValue(e,t,i)}),a.clone()}},"CalculateResultApplyController"),is);ic=iu([id(0,(0,c.Inject)(c.IUniverInstanceService)),id(1,c.ICommandService)],ic);let ih={};var im=Object.defineProperty,ig=Object.getOwnPropertyDescriptor,ip=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?ig(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&im(t,n,i),i},"__decorateClass$a"),iI=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$a");let iC=(sR=class extends c.Disposable{constructor(e,t){super(),this._definedNamesService=e,this._resourceManagerService=t,this._initialize()}_initialize(){this._initSnapshot()}_initSnapshot(){let e=/* @__PURE__ */_(e=>{let t=this._definedNamesService.getDefinedNameMap(e);return t?JSON.stringify(t):""},"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({pluginName:"SHEET_DEFINED_NAME_PLUGIN",businesses:[c.UniverInstanceType.UNIVER_SHEET],toJson:/* @__PURE__ */_(t=>e(t),"toJson"),parseJson:/* @__PURE__ */_(e=>t(e),"parseJson"),onUnLoad:/* @__PURE__ */_(e=>{this._definedNamesService.removeUnitDefinedName(e)},"onUnLoad"),onLoad:/* @__PURE__ */_((e,t)=>{this._definedNamesService.registerDefinedNames(e,t)},"onLoad")}))}},_(sR,"DefinedNameDataController"),sR);iC=ip([iI(0,h.IDefinedNamesService),iI(1,c.IResourceManagerService)],iC);let iR={MoveRangeCommandId:eJ,InsertRowCommandId:nm,InsertColCommandId:nC,RemoveColCommandId:nA,RemoveRowCommandId:nD,DeleteRangeMoveLeftCommandId:t6,DeleteRangeMoveUpCommandId:t8,InsertRangeMoveDownCommandId:"sheet.command.insert-range-move-down",InsertRangeMoveRightCommandId:nc,MoveColsCommandId:nk,MoveRowsCommandId:nE,ReorderRangeCommandId:nz};var iv=((u=iv||{})[u.Set=0]="Set",u[u.Delete=1]="Delete",u[u.HorizontalMove=2]="HorizontalMove",u[u.VerticalMove=3]="VerticalMove",u[u.Unknown=4]="Unknown",u);let iS=Number.MAX_SAFE_INTEGER,iw=/* @__PURE__ */_(e=>{let t={...e},n=Number.isNaN(t.startRow)&&Number.isNaN(t.endRow)&&!Number.isNaN(t.startColumn)&&!Number.isNaN(t.endColumn),r=Number.isNaN(t.startColumn)&&Number.isNaN(t.endColumn)&&!Number.isNaN(t.startRow)&&!Number.isNaN(t.endRow);return(t.rangeType===c.RANGE_TYPE.COLUMN||n)&&(t.startRow=0,t.endRow=iS),(t.rangeType===c.RANGE_TYPE.ROW||r)&&(t.startColumn=0,t.endColumn=iS),t.rangeType===c.RANGE_TYPE.ALL&&(t.startColumn=0,t.endColumn=iS,t.startRow=0,t.endRow=iS),t},"handleRangeTypeInput"),ib=/* @__PURE__ */_(e=>{let t=e.rangeType;return e.rangeType===c.RANGE_TYPE.COLUMN?t=c.RANGE_TYPE.ROW:e.rangeType===c.RANGE_TYPE.ROW&&(t=c.RANGE_TYPE.COLUMN),{startRow:e.startColumn,endRow:e.endColumn,startColumn:e.startRow,endColumn:e.endRow,rangeType:t}},"rotateRange"),iy=/* @__PURE__ */_((e,t,n)=>{let r={...n},o={...t},i=/* @__PURE__ */_((e,t)=>{let n=Math.max(e.start,t.start),r=Math.min(e.end,t.end);return r<n?null:{start:n,end:r}},"getIntersects"),s=/* @__PURE__ */_(e=>e.end-e.start+1,"getLength"),a=/* @__PURE__ */_((e,t)=>({start:e.start-t.start,end:e.start-t.start+e.end-e.start}),"getRelative"),l=/* @__PURE__ */_((e,t)=>({start:t.start+e.start,end:t.start+e.start+e.end-e.start}),"getAbsolute"),u=t.start>e.start;if(u){let n=Math.min(e.end,t.start)-e.start+1;o.start-=n,o.end-=n}let d=s(e),c=i(e,r),h=c&&s(c)>=s(r);if(e.end<r.start)r.start-=d,r.end-=d;else if(c){let t=s(c);if(h){let t=l(a(r,e),o);r.start=t.start,r.end=t.end}else c.start>e.start?u?(r.end-=t+d,r.start-=d):r.end-=t:u?r.end-=t:r.start>e.start&&r.end>e.end?(r.start-=d,r.end-=d+t):r.end-=t}let m=i(o,r);return h||(o.start<=r.start?(r.start+=d,r.end+=d):m&&(u?o.end<=r.start||o.start<=r.start&&o.end>=r.start?(r.start+=d,r.end+=d):o.start>=r.start&&o.start<=r.end&&(r.end+=d):r.start<o.start&&r.end>o.start?r.end+=d:(r.start>=o.end||r.start>=o.start&&r.start<=o.end)&&(r.end+=d,r.start+=d))),{step:r.start-n.start,length:s(r)-s(n)}},"handleBaseMoveRowsCols"),iM=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!r||!n)return[];let o=iw(n),i=iw(r),s=iw(t),a=iy({start:o.startRow,end:o.endRow},{start:i.startRow,end:i.endRow},{start:s.startRow,end:s.endRow});return null===a?[{type:iv.Delete}]:[{type:iv.VerticalMove,step:a.step||0,length:a.length||0}]},"handleMoveRows"),iU=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!n||!r)return[t];let o=n.startRow,i=n.endRow-n.startRow+1,s=r.startRow,a=new c.ObjectMatrix;return(0,c.Range).foreach(t,(e,t)=>{a.setValue(e,t,1)}),a.moveRows(o,i,s),(0,c.queryObjectMatrix)(a,e=>1===e)},"handleMoveRowsCommon"),i_=/* @__PURE__ */_((e,t)=>{let{range:n,order:r}=e.params||{};if(!n||!r)return[t];let o=new c.ObjectMatrix;(0,c.Range).foreach(t,(e,t)=>{o.setValue(e,t,1)});let i=new c.ObjectMatrix;return(0,c.Range).foreach(n,(e,t)=>{var n;if(r.hasOwnProperty(e)){let s=r[e],a=null!=(n=o.getValue(s,t))?n:0;i.setValue(e,t,a)}}),i.forValue((e,t,n)=>{o.setValue(e,t,n)}),(0,c.queryObjectMatrix)(o,e=>1===e)},"handleReorderRangeCommon"),iE=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!r||!n)return[];let o=iw(n),i=iw(r),s=iw(t),a=iy({start:o.startColumn,end:o.endColumn},{start:i.startColumn,end:i.endColumn},{start:s.startColumn,end:s.endColumn});return null===a?[{type:iv.Delete}]:[{type:iv.HorizontalMove,step:a.step||0,length:a.length||0}]},"handleMoveCols"),iT=/* @__PURE__ */_((e,t)=>{let{fromRange:n,toRange:r}=e.params||{};if(!n||!r)return[t];let o=n.startColumn,i=n.endColumn-n.startColumn+1,s=r.startColumn,a=new c.ObjectMatrix;return(0,c.Range).foreach(t,(e,t)=>{a.setValue(e,t,1)}),a.moveColumns(o,i,s),(0,c.queryObjectMatrix)(a,e=>1===e)},"handleMoveColsCommon"),ik=/* @__PURE__ */_((e,t)=>{var n,r;let o=null==(n=e.params)?void 0:n.toRange,i=null==(r=e.params)?void 0:r.fromRange;if(!o||!i)return[];let s=[];if((0,c.Rectangle).contains(o,t)&&s.push({type:iv.Delete}),(0,c.Rectangle).contains(i,t)){s.push({type:iv.Delete});let e=(0,c.Rectangle).getRelativeRange(t,i),n=(0,c.Rectangle).getPositionRange(e,o);return[{type:iv.Set,range:n}]}return s},"handleMoveRange"),ix=/* @__PURE__ */_((e,t)=>{var n,r;let o=null==(n=e.params)?void 0:n.toRange,i=null==(r=e.params)?void 0:r.fromRange;if(!o||!i||!(0,c.Rectangle).intersects(i,t)&&!(0,c.Rectangle).intersects(o,t))return[t];if((0,c.Rectangle).contains(i,t)){let e=(0,c.Rectangle).getRelativeRange(t,i);return[(0,c.Rectangle).getPositionRange(e,o)]}let s=new c.ObjectMatrix;(0,c.Range).foreach(t,(e,t)=>{s.setValue(e,t,1)});let a=new c.ObjectMatrix,l=(0,c.Rectangle).getIntersects(i,t);l&&(0,c.Range).foreach(l,(e,t)=>{s.getValue(e,t)&&(s.setValue(e,t,void 0),a.setValue(e,t,1))});let u=o.startColumn-i.startColumn,d=o.startRow-i.startRow,h={startColumn:o.startColumn-u,endColumn:o.endColumn-u,startRow:o.startRow-d,endRow:o.endRow-d};return h&&(0,c.Range).foreach(h,(e,t)=>{var n;let r=e+d,o=t+u;s.setValue(r,o,null!=(n=a.getValue(e,t))?n:0)}),(0,c.queryObjectMatrix)(s,e=>1===e)},"handleMoveRangeCommon"),iN=/* @__PURE__ */_((e,t)=>{let n=iw(e),r=iw(t),o=/* @__PURE__ */_(e=>e.endColumn-e.startColumn+1,"getLength"),i=/* @__PURE__ */_(e=>e.endRow-e.startRow+1,"getRowLength");if(n.startRow<=r.startRow&&n.endRow>=r.endRow){if(r.startColumn<n.startColumn&&r.endColumn>=n.startColumn&&r.endColumn<=n.endColumn||r.startColumn<n.startColumn&&r.endColumn>=n.endColumn){let e=(0,c.Rectangle).getIntersects(r,n);if(e)return{step:0,length:-o(e)}}if(r.startColumn>=n.startColumn&&r.endColumn<=n.endColumn&&i(n)>=i(r))return null;if(r.startColumn>=n.startColumn&&r.startColumn<=n.endColumn&&r.endColumn>n.endColumn){let e=(0,c.Rectangle).getIntersects(r,n);if(e){let t=-o(e);return{step:-(o(n)-o(e)),length:t}}}if(r.startColumn>n.endColumn)return{step:-o(n),length:0}}return{step:0,length:0}},"handleBaseRemoveRange"),iO=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],i=iN(r,t);if(i){let{step:e,length:t}=i;o.push({type:iv.HorizontalMove,step:e,length:t})}else o.push({type:iv.Delete});return o},"handleIRemoveCol"),iD=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],i=iN(ib(r),ib(t));if(i){let{step:e,length:t}=i;o.push({type:iv.VerticalMove,step:e,length:t})}else o.push({type:iv.Delete});return o},"handleIRemoveRow"),iP=/* @__PURE__ */_((e,t)=>{let{range:n,order:r}=e.params||{};if(!n||!r)return[];if((0,c.Rectangle).contains(n,t)&&t.endRow===t.startRow){let e=[],n=t.startRow;for(let t in r)if(r[t]===n){let r=Number(t);return e.push({type:iv.VerticalMove,step:r-n,length:0}),e}}return[]},"handleReorderRange"),iA=/* @__PURE__ */_((e,t)=>{let n=iw(e),r=iw(t),o=/* @__PURE__ */_(e=>e.endColumn-e.startColumn+1,"getLength");if(n.startRow<=r.startRow&&n.endRow>=r.endRow){if(r.startColumn<n.startColumn&&r.endColumn>=n.startColumn&&r.endColumn<=n.endColumn||r.startColumn<n.startColumn&&r.endColumn>=n.endColumn)return{step:0,length:o(n)};if(r.startColumn>=n.startColumn&&r.endColumn<=n.endColumn||r.startColumn>n.startColumn&&r.startColumn<=n.endColumn&&r.endColumn>n.endColumn||r.startColumn>=n.endColumn)return{step:o(n),length:0}}return{step:0,length:0}},"handleBaseInsertRange");function iV(e,t,n){let r=[];if((0,c.Rectangle).contains(t,n)&&r.push({type:iv.Delete}),(0,c.Rectangle).contains(e,n)){r.push({type:iv.Delete});let o=(0,c.Rectangle).getRelativeRange(n,e),i=(0,c.Rectangle).getPositionRange(o,t);return[{type:iv.Set,range:i}]}return r}_(iV,"handleBaseMoveRange");let i$=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:i,length:s}=iA(ib(r),ib(t));return o.push({type:iv.VerticalMove,step:i,length:s}),o},"handleInsertRow"),iW=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:i,length:s}=iA(r,t);return o.push({type:iv.HorizontalMove,step:i,length:s}),o},"handleInsertCol"),ij=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:i,length:s}=iA(ib(r),ib(t));return o.push({type:iv.VerticalMove,step:i,length:s}),o},"handleInsertRangeMoveDown"),iL=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o=r.endRow-r.startRow+1,i={...r,startRow:r.startRow,endRow:Number.POSITIVE_INFINITY},s=(0,c.Rectangle).subtract(t,i),a=(0,c.Rectangle).getIntersects(i,t);if(!a)return[t];let l=new c.ObjectMatrix;return s.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{l.setValue(e,t,1)})}),a&&(0,c.Range).foreach(a,(e,t)=>{l.setValue(e+o,t,1)}),(0,c.queryObjectMatrix)(l,e=>1===e)},"handleInsertRangeMoveDownCommon"),iB=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],{step:i,length:s}=iA(r,t);return o.push({type:iv.HorizontalMove,step:i,length:s}),o},"handleInsertRangeMoveRight"),iH=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o=r.endColumn-r.startColumn+1,i={...r,startColumn:r.startColumn,endColumn:Number.POSITIVE_INFINITY},s=(0,c.Rectangle).subtract(t,i),a=(0,c.Rectangle).getIntersects(i,t);if(!a)return[t];let l=new c.ObjectMatrix;return s.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{l.setValue(e,t,1)})}),a&&(0,c.Range).foreach(a,(e,t)=>{l.setValue(e,t+o,1)}),(0,c.queryObjectMatrix)(l,e=>1===e)},"handleInsertRangeMoveRightCommon"),iF=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],i=iN(r,t);if(i){let{step:e,length:t}=i;o.push({type:iv.HorizontalMove,step:e,length:t})}else o.push({type:iv.Delete});return o},"handleDeleteRangeMoveLeft"),iG=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o={startRow:r.startRow,endRow:r.endRow,startColumn:r.startColumn,endColumn:Number.POSITIVE_INFINITY},i=r.endColumn-r.startColumn+1,s=(0,c.Rectangle).getIntersects(r,t),a=(0,c.Rectangle).subtract(t,o),l=(0,c.Rectangle).getIntersects(o,t);if(!s&&!l)return[t];let u=new c.ObjectMatrix;return l&&(0,c.Range).foreach(l,(e,t)=>{u.setValue(e,t-i,1)}),s&&(0,c.Range).foreach(s,(e,t)=>{u.setValue(e,t-i,0)}),a.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{u.setValue(e,t,1)})}),(0,c.queryObjectMatrix)(u,e=>1===e)},"handleDeleteRangeMoveLeftCommon"),iq=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[];let o=[],i=iN(ib(r),ib(t));if(i){let{step:e,length:t}=i;o.push({type:iv.VerticalMove,step:e,length:t})}else o.push({type:iv.Delete});return o},"handleDeleteRangeMoveUp"),iz=/* @__PURE__ */_((e,t)=>{var n;let r=null==(n=e.params)?void 0:n.range;if(!r)return[t];let o={...r,startRow:r.startRow,endRow:Number.POSITIVE_INFINITY},i=r.endRow-r.startRow+1,s=(0,c.Rectangle).getIntersects(r,t),a=(0,c.Rectangle).subtract(t,o),l=(0,c.Rectangle).getIntersects(o,t);if(!s&&!l)return[t];let u=new c.ObjectMatrix;return l&&(0,c.Range).foreach(l,(e,t)=>{u.setValue(e-i,t,1)}),s&&(0,c.Range).foreach(s,(e,t)=>{u.setValue(e-i,t,0)}),a.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{u.setValue(e,t,1)})}),(0,c.queryObjectMatrix)(u,e=>1===e)},"handleDeleteRangeMoveUpCommon"),iY=/* @__PURE__ */_((e,t)=>{var n;let r=null!=(n=e.ranges)?n:[e.range],o=new c.ObjectMatrix;return(0,c.Range).foreach(t,(e,t)=>{o.setValue(e,t,1)}),r.forEach(e=>{let t=e.startRow,n=e.endRow-t+1;o.removeRows(t,n)}),(0,c.queryObjectMatrix)(o,e=>1===e)},"handleRemoveRowCommon"),iJ=/* @__PURE__ */_((e,t)=>{let n={...t};return e.forEach(e=>{switch(e.type){case iv.Delete:n=null;break;case iv.HorizontalMove:if(!n)return;n.startColumn+=e.step,n.endColumn+=e.step+(e.length||0);break;case iv.VerticalMove:if(!n)return;n.startRow+=e.step,n.endRow+=e.step+(e.length||0);break;case iv.Set:n=e.range}}),n&&(n.endColumn<n.startColumn||n.endRow<n.startRow)?null:n},"runRefRangeMutations"),iK=/* @__PURE__ */_((e,t)=>{let n=[];switch(t.id){case iR.DeleteRangeMoveLeftCommandId:n=iF(t,e);break;case iR.DeleteRangeMoveUpCommandId:n=iq(t,e);break;case iR.InsertColCommandId:n=iW(t,e);break;case iR.InsertRangeMoveDownCommandId:n=ij(t,e);break;case iR.InsertRangeMoveRightCommandId:n=iB(t,e);break;case iR.InsertRowCommandId:n=i$(t,e);break;case iR.MoveColsCommandId:n=iE(t,e);break;case iR.MoveRangeCommandId:n=ik(t,e);break;case iR.MoveRowsCommandId:n=iM(t,e);break;case iR.RemoveColCommandId:n=iO(t,e);break;case iR.RemoveRowCommandId:n=iD(t,e);break;case iR.ReorderRangeCommandId:n=iP(t,e)}return iJ(n,e)},"handleDefaultRangeChangeWithEffectRefCommands"),iX=/* @__PURE__ */_((e,t,n)=>[t7.id,t9.id].includes(t.id)||i1(t,n).some(t=>(0,c.Rectangle).intersects(t,e))?iK(e,t):e,"handleDefaultRangeChangeWithEffectRefCommandsSkipNoInterests"),iZ=/* @__PURE__ */_((e,t)=>{let n=[];switch(t.id){case iR.DeleteRangeMoveLeftCommandId:return iG(t,e);case iR.DeleteRangeMoveUpCommandId:return iz(t,e);case iR.InsertRangeMoveDownCommandId:return iL(t,e);case iR.InsertRangeMoveRightCommandId:return iH(t,e);case iR.InsertColCommandId:n=iW(t,e);break;case iR.InsertRowCommandId:n=i$(t,e);break;case iR.MoveColsCommandId:return iT(t,e);case iR.MoveRangeCommandId:return ix(t,e);case iR.MoveRowsCommandId:return iU(t,e);case iR.ReorderRangeCommandId:return i_(t,e);case iR.RemoveColCommandId:n=iO(t,e);break;case iR.RemoveRowCommandId:return iY(t.params,e)}let r=iJ(n,e);return r?[r]:[]},"handleCommonDefaultRangeChangeWithEffectRefCommands"),iQ=/* @__PURE__ */_((e,t,n)=>[t7.id,t9.id,nd.id,nc].includes(t.id)||i1(t,n).some(t=>(0,c.Rectangle).intersects(t,e))?iZ(e,t):e,"handleCommonRangeChangeWithEffectRefCommandsSkipNoInterests");function i0(e,t){let{id:n,params:r}=t,o={length:0,step:0,type:iv.Unknown};switch(n){case eT.id:o.type=iv.Delete;break;case nb.id:(o=iy({start:r.sourceRange.startRow,end:r.sourceRange.endRow},{start:r.targetRange.startRow,end:r.targetRange.endRow},{start:e.startRow,end:e.endRow})).type=iv.VerticalMove;break;case nM.id:(o=iy({start:r.sourceRange.startColumn,end:r.sourceRange.endColumn},{start:r.targetRange.startColumn,end:r.targetRange.endColumn},{start:e.startColumn,end:e.endColumn})).type=iv.HorizontalMove;break;case nu.id:(o=iN(r.range,e))?o.type=iv.HorizontalMove:o={step:0,length:0,type:iv.Delete};break;case na.id:(o=iN(ib(r.range),ib(e)))?o.type=iv.VerticalMove:o={step:0,length:0,type:iv.Delete};break;case nr.id:(o=iA(ib(r.range),ib(e))).type=iv.VerticalMove;break;case ni.id:(o=iA(r.range,e)).type=iv.HorizontalMove;break;case eN.id:o=iV(r.fromRange||new(0,c.ObjectMatrix)(r.from).getRange(),r.toRange||new(0,c.ObjectMatrix)(r.to).getRange(),e)}return o?Array.isArray(o)?iJ(o,e):iJ([o],e):e}function i1(e,t){var n,r,o,i,s,a;let{selectionManagerService:l}=t;switch(e.id){case iR.MoveColsCommandId:{let t=e.params;return[t.fromRange,{...t.toRange,startColumn:t.toRange.startColumn-.5,endColumn:t.toRange.endColumn-.5}]}case iR.MoveRowsCommandId:{let t=e.params;return[t.fromRange,{...t.toRange,startRow:t.toRange.startRow-.5,endRow:t.toRange.startRow-.5}]}case iR.MoveRangeCommandId:return[e.params.fromRange,e.params.toRange];case iR.InsertRowCommandId:{let t=e.params.range;return[{...t,startRow:t.startRow-.5,endRow:t.endRow-.5}]}case iR.InsertColCommandId:{let t=e.params.range;return[{...t,startColumn:t.startColumn-.5,endColumn:t.endColumn-.5}]}case iR.RemoveRowCommandId:case iR.RemoveColCommandId:return[e.params.range];case iR.DeleteRangeMoveUpCommandId:case iR.InsertRangeMoveDownCommandId:{let t=(null==(n=e.params)?void 0:n.range)||(null==(o=null==(r=l.getCurrentSelections())?void 0:r.map(e=>e.range))?void 0:o[0]);return t?[t]:[]}case iR.DeleteRangeMoveLeftCommandId:case iR.InsertRangeMoveRightCommandId:{let t=(null==(i=e.params)?void 0:i.range)||(null==(a=null==(s=l.getCurrentSelections())?void 0:s.map(e=>e.range))?void 0:a[0]);return t?[t]:[]}case iR.ReorderRangeCommandId:{let{range:t,order:n}=e.params,r=[];for(let e=t.startRow;e<=t.endRow;e++)e in n&&r.push({startRow:e,endRow:e,startColumn:t.startColumn,endColumn:t.endColumn});return r}}}function i2(e){switch(e.id){case nM.id:{let t=e.params;return[t.sourceRange,{...t.targetRange,startColumn:t.targetRange.startColumn-.5,endColumn:t.targetRange.startColumn-.5}]}case nb.id:{let t=e.params;return[t.sourceRange,{...t.targetRange,startRow:t.targetRange.startRow-.5,endRow:t.targetRange.startRow-.5}]}case eN.id:{let t=e.params;return[new(0,c.ObjectMatrix)(t.from.value).getRange(),new(0,c.ObjectMatrix)(t.to.value).getRange()]}case ni.id:{let t=e.params.range;return[{...t,startColumn:t.startColumn-.5,endColumn:t.startColumn-.5}]}case nr.id:{let t=e.params.range;return[{...t,startRow:t.startRow-.5,endRow:t.startRow-.5}]}case nu.id:case na.id:return[e.params.range]}}_(i0,"adjustRangeOnMutation"),_(i1,"getEffectedRangesOnCommand"),_(i2,"getEffectedRangesOnMutation");var i5=Object.defineProperty,i3=Object.getOwnPropertyDescriptor,i4=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?i3(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&i5(t,n,i),i},"__decorateClass$9"),i6=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$9");let i7=(0,c.createInterceptorKey)("MERGE_REDO"),i8=(0,c.createInterceptorKey)("MERGE_UNDO"),i9=Math.floor(Number.MAX_SAFE_INTEGER/10),se=class extends c.Disposable{constructor(e,t,n,r,o=!1){super(),this._unitId=e,this._subUnitId=t,this._range=n,this._callback=r,this._skipIntersects=o}onMutation(e){var t,n;if((null==(t=e.params)?void 0:t.unitId)!==this._unitId)return;if(e.id===eN.id){let t=e.params;if(t.from.subUnitId!==this._subUnitId||t.to.subUnitId!==this._subUnitId)return}else if((null==(n=e.params)?void 0:n.subUnitId)!==this._subUnitId)return;if(!this._range)return;if(this._skipIntersects){if(e.id===eT.id)return;let t=i2(e);if(null!=t&&t.some(e=>(0,c.Rectangle).intersects(e,this._range)))return}let r=i0(this._range,e);if(r&&(0,c.Rectangle).equals(r,this._range))return!1;let o=this._range;this._range=r,this._callback(o,r)}};_(se,"WatchRange");let st=(sf=class extends c.Disposable{constructor(e,t,n,r){super(),E(this,"interceptor",new c.InterceptorManager({MERGE_REDO:i7,MERGE_UNDO:i8})),E(this,"_watchRanges",/* @__PURE__ */new Set),E(this,"_refRangeManagerMap",/* @__PURE__ */new Map),E(this,"_serializer",ss()),E(this,"_onRefRangeChange",/* @__PURE__ */_(()=>{this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */_(e=>{let t=this._univerInstanceService.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET).getActiveSheet(),n=sn(this._univerInstanceService),r=sr(this._univerInstanceService);if(!t||!n||!r)return{redos:[],undos:[],preRedos:[],preUndos:[]};let o=/* @__PURE__ */(_(()=>{switch(e.id){case iR.MoveColsCommandId:{let o=e.params,i=Math.min(o.fromRange.startColumn,o.toRange.startColumn);return this._checkRange([{...o.fromRange,startColumn:i,endColumn:t.getColumnCount()-1}],n,r)}case iR.MoveRowsCommandId:{let o=e.params,i=Math.min(o.fromRange.startRow,o.toRange.startRow);return this._checkRange([{...o.fromRange,startRow:i,endRow:t.getRowCount()-1}],n,r)}case iR.MoveRangeCommandId:return this._checkRange([e.params.fromRange,e.params.toRange],n,r);case iR.InsertRowCommandId:{let o={startRow:e.params.range.startRow,endRow:t.getRowCount()-1,startColumn:0,endColumn:t.getColumnCount()-1,rangeType:c.RANGE_TYPE.ROW};return this._checkRange([o],n,r)}case iR.InsertColCommandId:{let o=e.params.range.startColumn,i={startRow:0,endRow:t.getRowCount()-1,startColumn:o,endColumn:t.getColumnCount()-1,rangeType:c.RANGE_TYPE.COLUMN};return this._checkRange([i],n,r)}case iR.RemoveRowCommandId:{let o={startRow:e.params.range.startRow,endRow:t.getRowCount()-1,startColumn:0,endColumn:t.getColumnCount()-1,rangeType:c.RANGE_TYPE.ROW};return this._checkRange([o],n,r)}case iR.RemoveColCommandId:{let o=e.params.range.startColumn,i={startRow:0,endRow:t.getRowCount()-1,startColumn:o,endColumn:t.getColumnCount()-1,rangeType:c.RANGE_TYPE.COLUMN};return this._checkRange([i],n,r)}case iR.DeleteRangeMoveUpCommandId:case iR.InsertRangeMoveDownCommandId:{let t=e.params.range||so(this._selectionManagerService)[0],o={startRow:t.startRow,startColumn:t.startColumn,endColumn:t.endColumn,endRow:i9};return this._checkRange([o],n,r)}case iR.DeleteRangeMoveLeftCommandId:case iR.InsertRangeMoveRightCommandId:{let t=e.params.range||so(this._selectionManagerService)[0],o={startRow:t.startRow,startColumn:t.startColumn,endColumn:i9,endRow:t.endRow};return this._checkRange([o],n,r)}case iR.ReorderRangeCommandId:{let{range:t,order:o}=e.params,i=[];for(let e=t.startRow;e<=t.endRow;e++)e in o&&i.push({startRow:e,endRow:e,startColumn:t.startColumn,endColumn:t.endColumn});return this._checkRange(i,n,r)}}},"getEffectsCbList")()||[]).reduce((t,n)=>{let r=n(e);return t.push(r),t},[]).reduce((e,t)=>{var n,r;return e.redos.push(...t.redos),e.undos.push(...t.undos),e.preRedos.push(...null!=(n=t.preRedos)?n:[]),e.preUndos.push(...null!=(r=t.preUndos)?r:[]),e},{redos:[],undos:[],preUndos:[],preRedos:[]}),i=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(o.preRedos,null)||[],s=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_REDO)(o.redos,null)||[],a=this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(o.preUndos,null)||[];return{redos:s,undos:this.interceptor.fetchThroughInterceptors(this.interceptor.getInterceptPoints().MERGE_UNDO)(o.undos,null)||[],preRedos:i,preUndos:a}},"getMutations")})},"_onRefRangeChange")),E(this,"_checkRange",/* @__PURE__ */_((e,t,n)=>{let r=si(t,n),o=this._refRangeManagerMap.get(r);if(o){let t=/* @__PURE__ */new Set;return[...o.keys()].forEach(n=>{let r=o.get(n),i=this._serializer.deserialize(n),s={...i,startRow:+i.startRow,endRow:+i.endRow,startColumn:+i.startColumn,endColumn:+i.endColumn,rangeType:i.rangeType&&+i.rangeType};e.some(e=>(0,c.Rectangle).intersects(e,s))&&r&&r.forEach(e=>{t.add(e)})}),[...t]}return[]},"_checkRange")),E(this,"registerRefRange",/* @__PURE__ */_((e,t,n,r)=>{let o=n||sn(this._univerInstanceService),i=r||sr(this._univerInstanceService);if(!o||!i)return(0,c.toDisposable)(()=>{});let s=si(o,i),a=this._serializer.serialize(e),l=this._refRangeManagerMap.get(s);l||(l=/* @__PURE__ */new Map,this._refRangeManagerMap.set(s,l));let u=l.get(a);return u?u.add(t):l.set(a,/* @__PURE__ */new Set([t])),(0,c.toDisposable)(()=>{let e=l.get(a);e&&(e.delete(t),e.size||(l.delete(a),l.size||this._refRangeManagerMap.delete(s)))})},"registerRefRange")),this._commandService=e,this._sheetInterceptorService=t,this._univerInstanceService=n,this._selectionManagerService=r,this._onRefRangeChange(),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_REDO,{priority:-1,handler:/* @__PURE__ */_(e=>e,"handler")}),this.interceptor.intercept(this.interceptor.getInterceptPoints().MERGE_UNDO,{priority:-1,handler:/* @__PURE__ */_(e=>e,"handler")})}watchRange(e,t,n,r,o){let i;0===this._watchRanges.size&&(i=this._commandService.onCommandExecuted(e=>{if(e.type!==c.CommandType.MUTATION)return!1;for(let t of this._watchRanges)t.onMutation(e)}));let s=new se(e,t,n,r,o);this._watchRanges.add(s);let a=(0,c.toDisposable)(()=>{this._watchRanges.delete(s),0===this._watchRanges.size&&(null==i||i.dispose(),i=null)}),l=this.disposeWithMe(a);return(0,c.toDisposable)(()=>{l.dispose(),a.dispose()})}},_(sf,"RefRangeService"),sf);function sn(e){return e.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET).getUnitId()}function sr(e){var t;return null==(t=e.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET).getActiveSheet())?void 0:t.getSheetId()}function so(e){var t;return(null==(t=e.getCurrentSelections())?void 0:t.map(e=>e.range))||[]}function si(e,t){return`${e}_${t}`}function ss(){let e=["startRow","startColumn","endRow","endColumn","rangeType"];return{deserialize:/* @__PURE__ */_(t=>{let n=e.reduce((e,t,n)=>(e[String(n)]=t,e),{});return t.split("_").reduce((e,t,r)=>{let o=String(r);return t&&n[o]&&(e[n[o]]=t),e},{})},"deserialize"),serialize:/* @__PURE__ */_(t=>e.reduce((e,n,r)=>{let o=t[n];return void 0!==o?`${e}${r>0?"_":""}${o}`:`${e}`},""),"serialize")}}st=i4([i6(0,c.ICommandService),i6(1,(0,c.Inject)(X)),i6(2,(0,c.Inject)(c.IUniverInstanceService)),i6(3,(0,c.Inject)(j))],st),_(sn,"getUnitId"),_(sr,"getSubUnitId"),_(so,"getSelectionRanges"),_(si,"getRefRangId"),_(ss,"createRangeSerializer");var sa=Object.defineProperty,sl=Object.getOwnPropertyDescriptor,su=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?sl(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&sa(t,n,i),i},"__decorateClass$8"),sd=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$8");let sc=[ni.id,nr.id,nu.id,na.id],sh=[nb.id,nM.id];function sm(e,t){let n=e;if(void 0!==t){let e=[];for(let r=0;r<n.length;r++){let{startRow:o,endRow:i,startColumn:s,endColumn:a}=n[r];if(t===c.Dimension.ROWS)for(let t=o;t<=i;t++){let n={startRow:t,endRow:t,startColumn:s,endColumn:a};e.push(n)}else if(t===c.Dimension.COLUMNS)for(let t=s;t<=a;t++){let n={startRow:o,endRow:i,startColumn:t,endColumn:t};e.push(n)}}n=e}return n}_(sm,"getAddMergeMutationRangeByType");let sg=(0,c.createInterceptorKey)("mergeCellPermissionCheck"),sp=(sv=class extends c.Disposable{constructor(e,t,n,r,o,i){super(),E(this,"disposableCollection",new c.DisposableCollection),E(this,"interceptor",new c.InterceptorManager({MERGE_CELL_INTERCEPTOR_CHECK:sg})),this._commandService=e,this._refRangeService=t,this._univerInstanceService=n,this._injector=r,this._sheetInterceptorService=o,this._selectionManagerService=i,this._onRefRangeChange(),this._initCommandInterceptor(),this._commandExecutedListener()}_initCommandInterceptor(){let e=this;this._sheetInterceptorService.interceptCommand({getMutations(t){var n;switch(t.id){case ev.id:case ew.id:{let t=e._univerInstanceService.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET),r=t.getUnitId(),o=null==t?void 0:t.getActiveSheet();if(!o)return{redos:[],undos:[]};let i=o.getSheetId(),s=o.getConfig().mergeData,a=null==(n=e._selectionManagerService.getCurrentSelections())?void 0:n.map(e=>e.range);if(a&&a.length>0&&a.some(e=>s.some(t=>(0,c.Rectangle).intersects(t,e)))){let t={unitId:r,subUnitId:i,ranges:a},n=nL(e._injector,t);return{redos:[{id:nB.id,params:t}],undos:[{id:nj.id,params:n}]}}}}return{redos:[],undos:[]}}}),this._sheetInterceptorService.interceptRanges({getMutations:/* @__PURE__ */_(({unitId:e,subUnitId:t,ranges:n})=>{let r=[],o=[],i={redos:r,undos:o};if(!n||!n.length)return i;let s=eU(this._univerInstanceService,{unitId:e,subUnitId:t});if(!s)return i;let{worksheet:a}=s,l=a.getMergeData().filter(e=>n.some(t=>(0,c.Rectangle).intersects(e,t)));return l.length?(r.push({id:nB.id,params:{unitId:e,subUnitId:t,ranges:l}}),o.push({id:nj.id,params:{unitId:e,subUnitId:t,ranges:l}}),{undos:o,redos:r}):i},"getMutations")})}refRangeHandle(e,t,n){switch(e.id){case iR.MoveColsCommandId:{let r=e.params;return this._handleMoveColsCommand(r,t,n)}case iR.MoveRowsCommandId:{let r=e.params;return this._handleMoveRowsCommand(r,t,n)}case ng.id:{let r=e.params,o=r.unitId||t,i=r.subUnitId||n;return this._handleInsertRowCommand(r,o,i)}case nR.id:{let r=e.params,o=r.unitId||t,i=r.subUnitId||n;return this._handleInsertColCommand(r,o,i)}case nV.id:{let r=e.params;return this._handleRemoveColCommand(r,t,n)}case nP.id:{let r=e.params;return this._handleRemoveRowCommand(r,t,n)}case eK.id:{let r=e.params;return this._handleMoveRangeCommand(r,t,n)}case nh.id:{let r=e.params;return this._handleInsertRangeMoveRightCommand(r,t,n)}case nd.id:{let r=e.params;return this._handleInsertRangeMoveDownCommand(r,t,n)}case t9.id:{let r=e.params;return this._handleDeleteRangeMoveUpCommand(r,t,n)}case t7.id:{let r=e.params;return this._handleDeleteRangeMoveLeftCommand(r,t,n)}}return{redos:[],undos:[]}}_onRefRangeChange(){let e=/* @__PURE__ */_((e,t)=>{let n=this._univerInstanceService.getUniverSheetInstance(e);if(!n)return;let r=null==n?void 0:n.getSheetBySheetId(t);if(!r)return;this.disposableCollection.dispose();let o=r.getMergeData(),i=/* @__PURE__ */_(n=>this.refRangeHandle(n,e,t),"handler");o.forEach(n=>{this.disposableCollection.add(this._refRangeService.registerRefRange(n,i,e,t))})},"registerRefRange");this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===r1.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(o,r)}if(t.id===nj.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(n.unitId,n.subUnitId)}})),this._univerInstanceService.getCurrentTypeOfUnit$(c.UniverInstanceType.UNIVER_SHEET).pipe((0,I.first)(e=>!!e)).subscribe(t=>{let n=t.getActiveSheet();n&&e(t.getUnitId(),n.getSheetId())})}_handleMoveRowsCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let i=[...o.getMergeData()],s={unitId:t,subUnitId:n,ranges:[]},a={unitId:t,subUnitId:n,ranges:[]},{fromRange:l}=e,{startRow:u,endRow:d}=l;if(i.forEach(t=>{if(u<=t.startRow&&d>=t.endRow){s.ranges.push(t);let n=iJ(iM({id:iR.MoveRowsCommandId,params:e},t),t);n&&a.ranges.push(n)}}),0===s.ranges.length)return this._handleNull();let c=nL(this._injector,s),h=nW(this._injector,a);return{redos:[{id:nB.id,params:s},{id:nj.id,params:a}],undos:[{id:nB.id,params:h},{id:nj.id,params:c}]}}_handleMoveColsCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let i=[...o.getMergeData()],s={unitId:t,subUnitId:n,ranges:[]},a={unitId:t,subUnitId:n,ranges:[]},{fromRange:l}=e,{startColumn:u,endColumn:d}=l;if(i.forEach(t=>{if(u<=t.startColumn&&d>=t.endColumn){s.ranges.push(t);let n=iJ(iE({id:iR.MoveColsCommandId,params:e},t),t);n&&a.ranges.push(n)}}),0===s.ranges.length)return this._handleNull();let c=nL(this._injector,s),h=nW(this._injector,a);return{redos:[{id:nB.id,params:s},{id:nj.id,params:a}],undos:[{id:nB.id,params:h},{id:nj.id,params:c}]}}_handleMoveRangeCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let i=o.getMergeData(),s=i.filter(t=>(0,c.Rectangle).intersects(t,e.fromRange)),a=i.filter(t=>(0,c.Rectangle).intersects(t,e.toRange)),l=sm(s.map(t=>(0,c.Rectangle).getRelativeRange(t,e.fromRange)).map(t=>(0,c.Rectangle).getPositionRange(t,e.toRange))).filter(e=>!i.some(t=>(0,c.Rectangle).equals(e,t)));return{redos:[{id:nB.id,params:{unitId:t,subUnitId:n,ranges:s}},{id:nB.id,params:{unitId:t,subUnitId:n,ranges:a}},{id:nj.id,params:{unitId:t,subUnitId:n,ranges:l}}],undos:[{id:nB.id,params:{unitId:t,subUnitId:n,ranges:l}},{id:nj.id,params:{unitId:t,subUnitId:n,ranges:a}},{id:nj.id,params:{unitId:t,subUnitId:n,ranges:s}}]}}_handleInsertRowCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let{range:i}=e,{startRow:s,endRow:a}=i,l=(0,c.Tools).deepClone(o.getMergeData()).reduce((e,t)=>(s>t.startRow&&s<=t.endRow&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,c.Tools).deepClone(o.getMergeData()).reduce((e,t)=>(s>t.startRow&&s<=t.endRow&&(t.endRow+=a-s+1,this._checkIsMergeCell(t)&&e.push(t)),e),[]),d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m);return{redos:[{id:nB.id,params:d},{id:nj.id,params:m}],undos:[{id:nB.id,params:g},{id:nj.id,params:h}]}}_handleInsertColCommand(e,t,n){let{range:r}=e,o=sI(this._univerInstanceService,t);if(!o)return this._handleNull();let i=sC(o,n);if(!i)return this._handleNull();let{startColumn:s,endColumn:a}=r,l=(0,c.Tools).deepClone(i.getMergeData()).reduce((e,t)=>(s>t.startColumn&&s<=t.endColumn&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,c.Tools).deepClone(i.getMergeData()).reduce((e,t)=>(s>t.startColumn&&s<=t.endColumn&&(t.endColumn+=a-s+1,this._checkIsMergeCell(t)&&e.push(t)),e),[]),d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m);return{redos:[{id:nB.id,params:d},{id:nj.id,params:m}],undos:[{id:nB.id,params:g},{id:nj.id,params:h}]}}_handleRemoveColCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let{range:i}=e,{startColumn:s,endColumn:a}=i,l=(0,c.Tools).deepClone(o.getMergeData()).reduce((e,t)=>((0,c.Rectangle).intersects(i,t)&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,c.Tools).deepClone(o.getMergeData()).reduce((e,t)=>{if((0,c.Rectangle).intersects(i,t)){if(s<=t.startColumn&&a>=t.endColumn)return e;s>=t.startColumn&&a<=t.endColumn?t.endColumn-=a-s+1:s<t.startColumn?(t.startColumn=s,t.endColumn-=a-s+1):a>t.endColumn&&(t.endColumn=s-1),this._checkIsMergeCell(t)&&e.push(t)}return e},[]),d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m),p=[{id:nB.id,params:d}],I=[{id:nj.id,params:m}];return{preUndos:[{id:nB.id,params:g}],undos:[{id:nj.id,params:h}],preRedos:p,redos:I}}_handleRemoveRowCommand(e,t,n){let{range:r}=e,o=sI(this._univerInstanceService,t);if(!o)return this._handleNull();let i=sC(o,n);if(!i)return this._handleNull();let{startRow:s,endRow:a}=r,l=(0,c.Tools).deepClone(i.getMergeData()).reduce((e,t)=>((0,c.Rectangle).intersects(r,t)&&e.push(t),e),[]);if(0===l.length)return this._handleNull();let u=(0,c.Tools).deepClone(i.getMergeData()).reduce((e,t)=>{if((0,c.Rectangle).intersects(r,t)){if(s<=t.startRow&&a>=t.endRow)return e;s>=t.startRow&&a<=t.endRow?t.endRow-=a-s+1:s<t.startRow?(t.startRow=s,t.endRow-=a-s+1):a>t.endRow&&(t.endRow=s-1),this._checkIsMergeCell(t)&&e.push(t)}return e},[]),d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m),p=[{id:nB.id,params:d}],I=[{id:nj.id,params:m}];return{preUndos:[{id:nB.id,params:g}],undos:[{id:nj.id,params:h}],preRedos:p,redos:I}}_handleInsertRangeMoveRightCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let i=e.range,s=o.getMaxColumns()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o}=i;if((0,c.Rectangle).intersects({startRow:t,startColumn:r,endRow:n,endColumn:s},e)&&(l.push(e),(0,c.Rectangle).contains({startRow:t,startColumn:r,endRow:n,endColumn:s},e))){let t=o-r+1;u.push({startRow:e.startRow,startColumn:e.startColumn+t,endRow:e.endRow,endColumn:e.endColumn+t})}});let d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m);return{preRedos:[{id:nB.id,params:d}],redos:[{id:nj.id,params:m}],preUndos:[{id:nB.id,params:g}],undos:[{id:nj.id,params:h}]}}_handleInsertRangeMoveDownCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let i=e.range,s=o.getMaxRows()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,startColumn:n,endColumn:r,endRow:o}=i;if((0,c.Rectangle).intersects({startRow:t,startColumn:n,endRow:s,endColumn:r},e)&&(l.push(e),(0,c.Rectangle).contains({startRow:t,startColumn:n,endRow:s,endColumn:r},e))){let n=o-t+1;u.push({startRow:e.startRow+n,startColumn:e.startColumn,endRow:e.endRow+n,endColumn:e.endColumn})}});let d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m),p=[{id:nB.id,params:d}],I=[{id:nj.id,params:m}],C=[{id:nB.id,params:g}];return{redos:I,undos:[{id:nj.id,params:h}],preRedos:p,preUndos:C}}_handleDeleteRangeMoveUpCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let i=e.range,s=o.getMaxRows()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,startColumn:n,endColumn:r,endRow:o}=i;if((0,c.Rectangle).intersects({startRow:t,startColumn:n,endRow:s,endColumn:r},e)&&(l.push(e),(0,c.Rectangle).contains({startRow:t,startColumn:n,endRow:s,endColumn:r},e))){let n=o-t+1,r=(0,c.Rectangle).moveVertical(e,-n);u.push(r)}});let d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m),p=[{id:nB.id,params:d}],I=[{id:nj.id,params:m}],C=[{id:nB.id,params:g}];return{redos:I,undos:[{id:nj.id,params:h}],preRedos:p,preUndos:C}}_handleDeleteRangeMoveLeftCommand(e,t,n){let r=sI(this._univerInstanceService,t);if(!r)return this._handleNull();let o=sC(r,n);if(!o)return this._handleNull();let i=e.range,s=o.getMaxColumns()-1,a=o.getMergeData(),l=[],u=[];a.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o}=i;if((0,c.Rectangle).intersects({startRow:t,startColumn:r,endRow:n,endColumn:s},e)&&(l.push(e),(0,c.Rectangle).contains({startRow:t,startColumn:r,endRow:n,endColumn:s},e))){let t=o-r+1;u.push({startRow:e.startRow,startColumn:e.startColumn-t,endRow:e.endRow,endColumn:e.endColumn-t})}});let d={unitId:t,subUnitId:n,ranges:l},h=nL(this._injector,d),m={unitId:t,subUnitId:n,ranges:u},g=nW(this._injector,m);return{preRedos:[{id:nB.id,params:d}],redos:[{id:nj.id,params:m}],undos:[{id:nj.id,params:h}],preUndos:[{id:nB.id,params:g}]}}_checkIsMergeCell(e){return!(e.startRow===e.endRow&&e.startColumn===e.endColumn)}_handleNull(){return{redos:[],undos:[]}}_commandExecutedListener(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(sh.includes(e.id)){if(!e.params)return;let t=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let{sourceRange:r,targetRange:o}=e.params,i=r.startColumn===o.startColumn&&r.endColumn===o.endColumn,s=i?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,a=i?r.startRow:r.startColumn,l=i?o.startRow:o.startColumn,u=n.getConfig().mergeData,d=[];u.forEach(e=>{let{startRow:t,endRow:n,startColumn:o,endColumn:u,rangeType:h}=e;(0,c.Rectangle).intersects(e,r)||(i?a<t&&l>n?(t-=s,n-=s):a>n&&l<=t&&(t+=s,n+=s):a<o&&l>u?(o-=s,u-=s):a>u&&l<=o&&(o+=s,u+=s)),e.startRow===e.endRow&&e.startColumn===e.endColumn||d.push({startRow:t,endRow:n,startColumn:o,endColumn:u,rangeType:h})}),n.setMergeData(d),this.disposableCollection.dispose();let{unitId:h,subUnitId:m}=e.params,g=/* @__PURE__ */_(e=>this.refRangeHandle(e,h,m),"handler");d.forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,g,h,m))})}if(sc.includes(e.id)){let t=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let r=n.getConfig().mergeData,o=e.params;if(!o)return;let{range:i}=o,s=e.id.includes("row"),a=e.id.includes("insert"),l=s?i.startRow:i.startColumn,u=s?i.endRow:i.endColumn,d=u-l+1,c=[];r.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o,rangeType:i}=e;a?s?l<=t&&(t+=d,n+=d):l<=r&&(r+=d,o+=d):s?u<t&&(t-=d,n-=d):u<r&&(r-=d,o-=d),e.startRow===e.endRow&&e.startColumn===e.endColumn||c.push({startRow:t,endRow:n,startColumn:r,endColumn:o,rangeType:i})}),n.setMergeData(c),this.disposableCollection.dispose();let{unitId:h,subUnitId:m}=e.params,g=/* @__PURE__ */_(e=>this.refRangeHandle(e,h,m),"handler");c.forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,g,h,m))})}}))}},_(sv,"MergeCellController"),sv);function sI(e,t){return t?e.getUniverSheetInstance(t):e.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET)}function sC(e,t){return t?e.getSheetBySheetId(t):e.getActiveSheet()}sp=su([sd(0,(0,c.Inject)(c.ICommandService)),sd(1,(0,c.Inject)(st)),sd(2,(0,c.Inject)(c.IUniverInstanceService)),sd(3,(0,c.Inject)(c.Injector)),sd(4,(0,c.Inject)(X)),sd(5,(0,c.Inject)(j))],sp),_(sI,"getWorkbook"),_(sC,"getWorksheet");var sR,sf,sv,sS,sw=Object.defineProperty,sb=Object.getOwnPropertyDescriptor,sy=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?sb(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&sw(t,n,i),i},"__decorateClass$7"),sM=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$7");let sU=(sS=class extends c.Disposable{constructor(e){super(),this._sheetInterceptorService=e,this._initialize()}_initialize(){this._initInterceptorCellContent()}_initInterceptorCellContent(){this.disposeWithMe(this._sheetInterceptorService.intercept(F.CELL_CONTENT,{priority:11,effect:c.InterceptorEffectEnum.Value|c.InterceptorEffectEnum.Style,handler:/* @__PURE__ */_((e,t,n)=>{var r;let o=t.workbook.getStyles().getStyleByCell(e);return n(null!=(r=null==o?void 0:o.n)&&r.pattern?{...e}:(null==e?void 0:e.t)===c.CellValueType.NUMBER&&"number"==typeof(null==e?void 0:e.v)?{...e,v:(0,h.stripErrorMargin)(e.v)}:{...e})},"handler")}))}},_(sS,"NumberCellDisplayController"),sS);sU=sy([sM(0,(0,c.Inject)(X))],sU);var s_,sE=Object.defineProperty,sT=Object.getOwnPropertyDescriptor,sk=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?sT(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&sE(t,n,i),i},"__decorateClass$6"),sx=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$6");let sN=(s_=class extends c.Disposable{constructor(e,t,n){super(),E(this,"_cellRuleCache",/* @__PURE__ */new Map),E(this,"_permissionIdCache",/* @__PURE__ */new Map),E(this,"_cellInfoCache",/* @__PURE__ */new Map),E(this,"_rowInfoCache",/* @__PURE__ */new Map),E(this,"_colInfoCache",/* @__PURE__ */new Map),this._ruleModel=e,this._permissionService=t,this._univerInstanceService=n,this._initUpdateCellRuleCache(),this._initUpdateCellInfoCache(),this._initUpdateRowColInfoCache(),this._initCache()}_initCache(){this._univerInstanceService.getAllUnitsForType(c.UniverInstanceType.UNIVER_SHEET).forEach(e=>{e.getSheets().forEach(t=>{let n=e.getUnitId(),r=t.getSheetId();this.reBuildCache(n,r)})})}_initUpdateCellInfoCache(){this._permissionService.permissionPointUpdate$.pipe((0,p.filter)(e=>e.type===e0.SelectRange),(0,C.map)(e=>e)).subscribe(e=>{let{subUnitId:t,unitId:n,permissionId:r}=e,o=this._permissionIdCache.get(r);if(!o)return;let i=this._ruleModel.getRule(n,t,o);if(!i)return;let s=this._ensureCellInfoMap(n,t);i.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o}=e;for(let e=t;e<=n;e++)for(let t=r;t<=o;t++)s.delete(`${e}-${t}`)})}),this._ruleModel.ruleChange$.subscribe(e=>{var t;let{unitId:n,subUnitId:r}=e,o=this._ensureCellInfoMap(n,r);e.rule.ranges.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{o.delete(`${e}-${t}`)})}),"set"===e.type&&(null==(t=e.oldRule)||t.ranges.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{this._cellInfoCache.delete(`${e}-${t}`)})}))})}_initUpdateCellRuleCache(){this._ruleModel.ruleChange$.subscribe(e=>{let{type:t}=e;"add"===t?this._addCellRuleCache(e):"delete"===t?this._deleteCellRuleCache(e):(this._deleteCellRuleCache({...e,rule:e.oldRule}),this._addCellRuleCache(e))})}_ensureRuleMap(e,t){let n=this._cellRuleCache.get(e);n||(n=/* @__PURE__ */new Map,this._cellRuleCache.set(e,n));let r=n.get(t);return r||(r=/* @__PURE__ */new Map,n.set(t,r)),r}_ensureCellInfoMap(e,t){let n=this._cellInfoCache.get(e);n||(n=/* @__PURE__ */new Map,this._cellInfoCache.set(e,n));let r=n.get(t);return r||(r=/* @__PURE__ */new Map,n.set(t,r)),r}_ensureRowColInfoMap(e,t,n){let r="row"===n?this._rowInfoCache.get(e):this._colInfoCache.get(e);r||(r=/* @__PURE__ */new Map,"row"===n?this._rowInfoCache.set(e,r):this._colInfoCache.set(e,r));let o=r.get(t);return o||(o=/* @__PURE__ */new Map,r.set(t,o)),o}_addCellRuleCache(e){let{subUnitId:t,unitId:n,rule:r}=e,o=this._ensureRuleMap(n,t);r.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:i,endColumn:s}=e;for(let e=t;e<=n;e++)for(let t=i;t<=s;t++)o.set(`${e}-${t}`,r.id)}),this._permissionIdCache.set(r.permissionId,r.id)}_deleteCellRuleCache(e){let{subUnitId:t,unitId:n,rule:r}=e,o=this._ensureRuleMap(n,t),i=this._ensureCellInfoMap(n,t);r.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:s}=e;for(let e=t;e<=n;e++)for(let t=r;t<=s;t++)o.delete(`${e}-${t}`),i.delete(`${e}-${t}`)}),this._permissionIdCache.delete(r.permissionId)}_getSelectionActions(e,t,n){var r,o,i,s,a,l,u,d;let c=null==(o=null==(r=this._permissionService.getPermissionPoint(new e2(e,t,n.permissionId).id))?void 0:r.value)||o,h=null==(s=null==(i=this._permissionService.getPermissionPoint(new e3(e,t,n.permissionId).id))?void 0:i.value)||s,m=null!=(l=null==(a=this._permissionService.getPermissionPoint(new ol(e,t,n.permissionId).id))?void 0:a.value)&&l,g=null!=(d=null==(u=this._permissionService.getPermissionPoint(new oa(e,t,n.permissionId).id))?void 0:u.value)&&d;return{[eQ.Edit]:c,[eQ.View]:h,[eQ.ManageCollaborator]:m,[eQ.Delete]:g}}reBuildCache(e,t){let n=this._ensureRuleMap(e,t),r=this._ensureCellInfoMap(e,t);n.clear(),r.clear();let o=this._ensureRowColInfoMap(e,t,"row"),i=this._ensureRowColInfoMap(e,t,"col");o.clear(),i.clear(),this._ruleModel.getSubunitRuleList(e,t).forEach(s=>{let a=this._getSelectionActions(e,t,s),l={...a,ruleId:s.id,ranges:s.ranges};s.ranges.forEach(e=>{let{startRow:t,endRow:u,startColumn:d,endColumn:c}=e;for(let e=t;e<=u;e++){let t=o.get(`${e}`);t?t.set(s.id,a):o.set(`${e}`,/* @__PURE__ */new Map([[s.id,a]]));for(let t=d;t<=c;t++){n.set(`${e}-${t}`,s.id),r.set(`${e}-${t}`,l);let o=i.get(`${t}`);o?o.set(s.id,a):i.set(`${t}`,/* @__PURE__ */new Map([[s.id,a]]))}}}),this._permissionIdCache.set(s.permissionId,s.id)})}getRowPermissionInfo(e,t,n,r){var o;let i=null==(o=this._rowInfoCache.get(e))?void 0:o.get(t);if(!i)return!0;let s=i.get(`${n}`);return!s||r.every(e=>{for(let t of s.values())if(!1===t[e])return!1;return!0})}getColPermissionInfo(e,t,n,r){var o;let i=null==(o=this._colInfoCache.get(e))?void 0:o.get(t);if(!i)return!0;let s=i.get(`${n}`);return!s||r.every(e=>{for(let t of s.values())if(!1===t[e])return!1;return!0})}_initUpdateRowColInfoCache(){this._permissionService.permissionPointUpdate$.pipe((0,p.filter)(e=>e.type===e0.SelectRange),(0,C.map)(e=>e)).subscribe({next:/* @__PURE__ */_(e=>{let{subUnitId:t,unitId:n,permissionId:r}=e,o=this._permissionIdCache.get(r);if(!o)return;let i=this._ruleModel.getRule(n,t,o);if(!i)return;let s=this._ensureRowColInfoMap(n,t,"row"),a=this._ensureRowColInfoMap(n,t,"col"),l=this._getSelectionActions(n,t,i);i.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:i}=e;for(let e=t;e<=n;e++){let t=s.get(`${e}`);t?t.set(o,l):s.set(`${e}`,/* @__PURE__ */new Map([[o,l]]));for(let e=r;e<=i;e++){let t=a.get(`${e}`);t?t.set(o,l):a.set(`${e}`,/* @__PURE__ */new Map([[o,l]]))}}})},"next")}),this._ruleModel.ruleChange$.subscribe(e=>{if("delete"===e.type){let{unitId:t,subUnitId:n,rule:r}=e,o=this._ensureRowColInfoMap(t,n,"row"),i=this._ensureRowColInfoMap(t,n,"col");r.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:s,endColumn:a}=e;for(let e=t;e<=n;e++){let t=o.get(`${e}`);null==t||t.delete(r.id);for(let e=s;e<=a;e++){let t=i.get(`${e}`);null==t||t.delete(r.id)}}})}})}getCellInfo(e,t,n,r){var o,i;let s=this._ensureCellInfoMap(e,t),a=s.get(`${n}-${r}`);if(a)return a;let l=null==(i=null==(o=this._cellRuleCache.get(e))?void 0:o.get(t))?void 0:i.get(`${n}-${r}`);if(!l)return;let u=this._ruleModel.getRule(e,t,l);if(u){let o={...this._getSelectionActions(e,t,u),ruleId:l,ranges:u.ranges};return s.set(`${n}-${r}`,o),o}}deleteUnit(e){this._cellRuleCache.delete(e),this._cellInfoCache.delete(e),this._rowInfoCache.delete(e),this._colInfoCache.delete(e);let t=this._univerInstanceService.getUnit(e);null==t||t.getSheets().forEach(t=>{let n=t.getSheetId();this._ruleModel.getSubunitRuleList(e,n).forEach(e=>{this._permissionIdCache.delete(e.permissionId)})})}},_(s_,"RangeProtectionCache"),s_);sN=sk([sx(0,(0,c.Inject)(k)),sx(1,(0,c.Inject)(c.IPermissionService)),sx(2,(0,c.Inject)(c.IUniverInstanceService))],sN);var sO,sD=Object.defineProperty,sP=Object.getOwnPropertyDescriptor,sA=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?sP(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&sD(t,n,i),i},"__decorateClass$5"),sV=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$5");let s$=(_(sO=class{constructor(e,t){E(this,"_cache",new c.LRUMap(1e4)),this._selectionProtectionRuleModel=e,this._permissionService=t,this._init()}_init(){this._permissionService.permissionPointUpdate$.pipe((0,p.filter)(e=>e.type===e0.SelectRange),(0,p.filter)(e=>ou().some(t=>e instanceof t)),(0,C.map)(e=>e)).subscribe(e=>{for(let t of this._selectionProtectionRuleModel.getSubunitRuleList(e.unitId,e.subUnitId))t.permissionId===e.permissionId&&t.ranges.forEach(t=>{(0,c.Range).foreach(t,(t,n)=>{let r=this._createKey(e.unitId,e.subUnitId,t,n);this._cache.delete(r)})})}),this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{var t;e.rule.ranges.forEach(t=>{(0,c.Range).foreach(t,(t,n)=>{let r=this._createKey(e.unitId,e.subUnitId,t,n);this._cache.delete(r)})}),"set"===e.type&&(null==(t=e.oldRule)||t.ranges.forEach(t=>{(0,c.Range).foreach(t,(t,n)=>{let r=this._createKey(e.unitId,e.subUnitId,t,n);this._cache.delete(r)})}))})}_createKey(e,t,n,r){return`${e}_${t}_${n}_${r}`}getCellInfo(e,t,n,r){let o=this._selectionProtectionRuleModel.getSubunitRuleList(e,t);if(!o||!o.length)return[];let i=this._createKey(e,t,n,r),s=this._cache.get(i);if(s)return s;let a=[];for(let i of o)if(i.ranges.some(e=>e.startRow<=n&&e.endRow>=n&&e.startColumn<=r&&e.endColumn>=r)){let n=ou().reduce((n,r)=>{var o;let s=new r(e,t,i.permissionId),a=this._permissionService.getPermissionPoint(s.id);return n[s.subType]=null!=(o=null==a?void 0:a.value)?o:s.value,n},{});a.push({...n,ruleId:i.id,ranges:i.ranges})}return this._cache.set(i,a),a}clear(){this._cache.clear()}},"RangeProtectionRenderModel"),sO);s$=sA([sV(0,(0,c.Inject)(k)),sV(1,(0,c.Inject)(c.IPermissionService))],s$);let sW=(0,c.createIdentifier)("univer.exclusive-range-service"),sj=class extends c.Disposable{constructor(){super(...arguments),E(this,"_exclusiveRanges",/* @__PURE__ */new Map)}_ensureUnitMap(e){return this._exclusiveRanges.has(e)||this._exclusiveRanges.set(e,/* @__PURE__ */new Map),this._exclusiveRanges.get(e)}_ensureSubunitMap(e,t){let n=this._ensureUnitMap(e);return n.has(t)||n.set(t,/* @__PURE__ */new Map),n.get(t)}_ensureFeature(e,t,n){let r=this._ensureSubunitMap(e,t);return r.has(n)||r.set(n,[]),r.get(n)}addExclusiveRange(e,t,n,r){this._ensureFeature(e,t,n).push(...r)}getExclusiveRanges(e,t,n){var r,o;return null==(o=null==(r=this._exclusiveRanges.get(e))?void 0:r.get(t))?void 0:o.get(n)}clearExclusiveRanges(e,t,n){this._ensureFeature(e,t,n),this._exclusiveRanges.get(e).get(t).set(n,[])}clearExclusiveRangesByGroupId(e,t,n,r){let o=this.getExclusiveRanges(e,t,n);if(o){let i=o.filter(e=>e.groupId!==r);this._exclusiveRanges.get(e).get(t).set(n,i)}}getInterestGroupId(e){let t=[];return e.forEach(e=>{var n;let r=e.range,{unitId:o,sheetId:i}=r;if(!o||!i)return;let s=null==(n=this._exclusiveRanges.get(o))?void 0:n.get(i);if(s)for(let e of s.keys()){let n=s.get(e);if(n){for(let o of n)if((0,c.Rectangle).intersects(r,o.range)){t.push(e);break}}}}),t}};_(sj,"ExclusiveRangeService");var sL,sB=Object.defineProperty,sH=Object.getOwnPropertyDescriptor,sF=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?sH(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&sB(t,n,i),i},"__decorateClass$4"),sG=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$4");let sq=(_(sL=class extends c.Disposable{constructor(e,t,n){super(),this._resourceManagerService=e,this._univerInstanceService=t,this._logService=n}getValue(e,t,n,r){let o=this._univerInstanceService.getUniverSheetInstance(e);if(!o)return;let i=null==o?void 0:o.getSheetBySheetId(t);if(!i)return;let s=o.getStyles(),a=i.getCellRaw(n,r);if(null!=a&&a.s){let e=s.get(a.s);if(null!=e&&e.n)return e.n}return null}deleteValues(e,t,n){let r=this._univerInstanceService.getUniverSheetInstance(e);if(!r)return;let o=null==r?void 0:r.getSheetBySheetId(t);if(!o)return;let i=r.getStyles();n.forEach(e=>{(0,c.Range).foreach(e,(e,t)=>{let n=o.getCellRaw(e,t);if(!n)return;let r=null==n?void 0:n.s,s={...r&&i.get(r)||{}};delete s.n;let a=i.setValue(s);n.s=a})})}setValues(e,t,n){let r=this._univerInstanceService.getUniverSheetInstance(e);if(!r)return;let o=null==r?void 0:r.getSheetBySheetId(t);if(!o)return;let i=r.getStyles(),s=o.getCellMatrix();n.forEach(e=>{e.ranges.forEach(t=>{(0,c.Range).foreach(t,(t,n)=>{let r=o.getCellRaw(t,n);if(r){let t={...i.getStyleByCell(r)||{},n:{pattern:e.pattern}},n=i.setValue(t);r.s=n,e.pattern===y.DEFAULT_TEXT_FORMAT&&(r.t=c.CellValueType.STRING)}else{let r={n:{pattern:e.pattern}},o=i.setValue(r);o&&s.setValue(t,n,{s:o})}})})})}},"NumfmtService"),sL);sq=sF([sG(0,c.IResourceManagerService),sG(1,c.IUniverInstanceService),sG(2,c.ILogService)],sq);var sz=Object.defineProperty,sY=Object.getOwnPropertyDescriptor,sJ=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?sY(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&sz(t,n,i),i},"__decorateClass$3"),sK=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$3");let sX=[ni.id,nr.id,nu.id,na.id],sZ=[nb.id,nM.id],sQ=(s4=class extends c.Disposable{constructor(e,t,n,r,o,i,s,a){super(),E(this,"disposableCollection",new c.DisposableCollection),this._selectionProtectionRuleModel=e,this._univerInstanceService=t,this._commandService=n,this._refRangeService=r,this._selectionProtectionRenderModel=o,this._rangeProtectionCache=i,this._sheetInterceptorService=s,this._rangeProtectionRuleModel=a,this._onRefRangeChange(),this._correctPermissionRange(),this._initReBuildCache(),this._initRemoveSheet()}_onRefRangeChange(){let e=/* @__PURE__ */_((e,t)=>{let n=this._univerInstanceService.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!n||!(null==n?void 0:n.getSheetBySheetId(t)))return;this.disposableCollection.dispose();let r=/* @__PURE__ */_(n=>this.refRangeHandle(n,e,t),"handler");this._selectionProtectionRuleModel.getSubunitRuleList(e,t).reduce((e,t)=>[...e,...t.ranges],[]).forEach(n=>{this.disposableCollection.add(this._refRangeService.registerRefRange(n,r,e,t))})},"registerRefRange");this.disposeWithMe(this._commandService.onCommandExecuted(t=>{if(t.id===r2.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(o,r)}if(t.id===rv.id||t.id===N.id){let n=t.params,r=n.subUnitId,o=n.unitId;if(!r||!o)return;e(o,r)}}));let t=this._univerInstanceService.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(t){let n=t.getActiveSheet();if(!n)return;e(t.getUnitId(),n.getSheetId())}}refRangeHandle(e,t,n){switch(e.id){case nT.id:return this._getRefRangeMutationsByMoveRows(e.params,t,n);case nx.id:return this._getRefRangeMutationsByMoveCols(e.params,t,n);case ng.id:return this._getRefRangeMutationsByInsertRows(e.params,t,n);case nR.id:return this._getRefRangeMutationsByInsertCols(e.params,t,n);case nV.id:return this._getRefRangeMutationsByDeleteCols(e.params,t,n);case nP.id:return this._getRefRangeMutationsByDeleteRows(e.params,t,n)}return{redos:[],undos:[]}}_getRefRangeMutationsByDeleteCols(e,t,n){let r=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(t=>t.ranges.some(t=>(0,c.Rectangle).intersects(t,e.range))),o=e.range;if(r.length){let e=[],i=[];return r.forEach(r=>{let s=(0,c.Tools).deepClone(r),a=s.ranges.reduce((e,t)=>{if((0,c.Rectangle).intersects(t,o)){let n=(0,c.Tools).deepClone(t),{startColumn:r,endColumn:i}=o;if(r<=n.startColumn&&i>=n.endColumn)return e;r>=n.startColumn&&i<=n.endColumn?n.endColumn-=i-r+1:r<n.startColumn?(n.startColumn=r,n.endColumn-=i-r+1):i>n.endColumn&&(n.endColumn=r-1),this._checkIsRightRange(n)&&e.push(n)}return e},[]);s.ranges=a,s.ranges.length?(e.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:s,ruleId:r.id}}),i.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:r,ruleId:r.id}})):(e.push({id:x.id,params:{unitId:t,subUnitId:n,ruleIds:[r.id]}}),i.push({id:N.id,params:{unitId:t,subUnitId:n,name:"",rules:[r]}}))}),{redos:e,undos:i}}return{undos:[],redos:[]}}_getRefRangeMutationsByDeleteRows(e,t,n){let r=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(t=>t.ranges.some(t=>(0,c.Rectangle).intersects(t,e.range))),o=e.range;if(r.length){let e=[],i=[];return r.forEach(r=>{let s=(0,c.Tools).deepClone(r),a=s.ranges.reduce((e,t)=>{if((0,c.Rectangle).intersects(t,o)){let n=(0,c.Tools).deepClone(t),{startRow:r,endRow:i}=o;if(r<=n.startRow&&i>=n.endRow)return e;r>=n.startRow&&i<=n.endRow?n.endRow-=i-r+1:r<n.startRow?(n.startRow=r,n.endRow-=i-r+1):i>n.endRow&&(n.endRow=r-1),this._checkIsRightRange(n)&&e.push(n)}return e},[]);s.ranges=a,e.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:s,ruleId:r.id}}),i.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:r,ruleId:r.id}})}),{redos:e,undos:i}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertCols(e,t,n){let r=e.range.startColumn,o=e.range.endColumn-e.range.startColumn+1,i=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>r>e.startColumn&&r<=e.endColumn));if(i.length){let e=[],s=[];return i.forEach(i=>{let a=(0,c.Tools).deepClone(i),l=!1;a.ranges.forEach(e=>{r>e.startColumn&&r<=e.endColumn&&(e.endColumn+=o,l=!0)}),l&&(e.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:a,ruleId:i.id}}),s.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:i,ruleId:i.id}}))}),{redos:e,undos:s}}return{undos:[],redos:[]}}_getRefRangeMutationsByInsertRows(e,t,n){let r=e.range.startRow,o=e.range.endRow-e.range.startRow+1,i=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>r>e.startRow&&r<=e.endRow));if(i.length){let e=[],s=[];return i.forEach(i=>{let a=(0,c.Tools).deepClone(i),l=!1;a.ranges.forEach(e=>{r>e.startRow&&r<=e.endRow&&(e.endRow+=o,l=!0)}),l&&(e.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:a,ruleId:i.id}}),s.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:i,ruleId:i.id}}))}),{redos:e,undos:s}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveRows(e,t,n){let r=e.toRange,o=r.startRow,i=r.endRow-r.startRow+1,s=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>o>e.startRow&&o<=e.endRow));if(s.length){let r=[],a=[];return s.forEach(s=>{let l=(0,c.Tools).deepClone(s),u=e.fromRange.startRow,d=!1;l.ranges.forEach(e=>{o>e.startRow&&o<=e.endRow&&(u<e.startRow&&(e.startRow=e.startRow-i,e.endRow=e.endRow-i),e.endRow+=i,d=!0)}),d&&(r.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:l,ruleId:s.id}}),a.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:s,ruleId:s.id}}))}),{redos:r,undos:a}}return{undos:[],redos:[]}}_getRefRangeMutationsByMoveCols(e,t,n){let r=e.toRange,o=r.startColumn,i=r.endColumn-r.startColumn+1,s=this._selectionProtectionRuleModel.getSubunitRuleList(t,n).filter(e=>e.ranges.some(e=>o>e.startColumn&&o<=e.endColumn));if(s.length){let r=[],a=[];return s.forEach(s=>{let l=(0,c.Tools).deepClone(s),u=e.fromRange.startColumn,d=!1;l.ranges.forEach(e=>{o>e.startColumn&&o<=e.endColumn&&(u<e.startColumn&&(e.startColumn=e.startColumn-i,e.endColumn=e.endColumn-i),e.endColumn+=i,d=!0)}),d&&(r.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:l,ruleId:s.id}}),a.push({id:rv.id,params:{unitId:t,subUnitId:n,rule:s,ruleId:s.id}}))}),{redos:r,undos:a}}return{undos:[],redos:[]}}_correctPermissionRange(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(sZ.includes(e.id)){if(!e.params)return;let t=this._univerInstanceService.getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let{sourceRange:r,targetRange:o}=e.params,i=r.startColumn===o.startColumn&&r.endColumn===o.endColumn,s=i?r.endRow-r.startRow+1:r.endColumn-r.startColumn+1,a=i?r.startRow:r.startColumn,l=i?o.startRow:o.startColumn;this._selectionProtectionRuleModel.getSubunitRuleList(t.getUnitId(),n.getSheetId()).forEach(e=>{e.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:o,endColumn:u}=e;(0,c.Rectangle).intersects(e,r)||(i?a<t&&l>n?(t-=s,n-=s):a>n&&l<=t&&(t+=s,n+=s):a<o&&l>u?(o-=s,u-=s):a>u&&l<=o&&(o+=s,u+=s)),this._checkIsRightRange({startRow:t,endRow:n,startColumn:o,endColumn:u})&&(e.startColumn=o,e.endColumn=u,e.startRow=t,e.endRow=n)})}),this.disposableCollection.dispose();let{unitId:u,subUnitId:d}=e.params,h=/* @__PURE__ */_(e=>this.refRangeHandle(e,u,d),"handler");this._selectionProtectionRuleModel.getSubunitRuleList(u,d).reduce((e,t)=>[...e,...t.ranges],[]).forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,h,u,d))}),this._selectionProtectionRenderModel.clear()}if(sX.includes(e.id)){let t=this._univerInstanceService.getUniverSheetInstance(e.params.unitId);if(!t)return;let n=t.getSheetBySheetId(e.params.subUnitId);if(!n)return;let r=e.params;if(!r)return;let{range:o}=r,i=e.id.includes("row"),s=e.id.includes("insert"),a=i?o.startRow:o.startColumn,l=i?o.endRow:o.endColumn,u=l-a+1;this._selectionProtectionRuleModel.getSubunitRuleList(t.getUnitId(),n.getSheetId()).forEach(e=>{e.ranges.forEach(e=>{let{startRow:t,endRow:n,startColumn:r,endColumn:o}=e;s?i?a<=t&&(t+=u,n+=u):a<=r&&(r+=u,o+=u):i?l<t&&(t-=u,n-=u):l<r&&(r-=u,o-=u),this._checkIsRightRange({startRow:t,endRow:n,startColumn:r,endColumn:o})&&(e.startColumn=r,e.endColumn=o,e.startRow=t,e.endRow=n)})}),this.disposableCollection.dispose();let{unitId:d,subUnitId:c}=e.params,h=/* @__PURE__ */_(e=>this.refRangeHandle(e,d,c),"handler");this._selectionProtectionRuleModel.getSubunitRuleList(d,c).reduce((e,t)=>[...e,...t.ranges],[]).forEach(e=>{this.disposableCollection.add(this._refRangeService.registerRefRange(e,h,d,c))}),this._selectionProtectionRenderModel.clear()}}))}_checkIsRightRange(e){return e.startRow<=e.endRow&&e.startColumn<=e.endColumn}_initReBuildCache(){this.disposeWithMe(this._commandService.onCommandExecuted(e=>{if(sX.includes(e.id)||sZ.includes(e.id)){let{unitId:t,subUnitId:n}=e.params;this._rangeProtectionCache.reBuildCache(t,n)}}))}_initRemoveSheet(){this._sheetInterceptorService.interceptCommand({getMutations:/* @__PURE__ */_(e=>{let t=[],n=[];if(e.id===n$.id){let r=e.params,o=[],i=[];this._rangeProtectionRuleModel.getSubunitRuleList(r.unitId,r.subUnitId).forEach(e=>{o.push(e.id),i.push(e)}),o.length&&i.length&&(n.push({id:x.id,params:{unitId:r.unitId,subUnitId:r.subUnitId,ruleIds:o}}),t.push({id:N.id,params:{unitId:r.unitId,subUnitId:r.subUnitId,name:"",rules:i}}))}return{redos:[],undos:t,preRedos:n,preUndos:[]}},"getMutations")})}},_(s4,"RangeProtectionRefRangeService"),s4);sQ=sJ([sK(0,(0,c.Inject)(k)),sK(1,(0,c.Inject)(c.IUniverInstanceService)),sK(2,c.ICommandService),sK(3,(0,c.Inject)(st)),sK(4,(0,c.Inject)(s$)),sK(5,(0,c.Inject)(sN)),sK(6,(0,c.Inject)(X)),sK(7,(0,c.Inject)(k))],sQ);var s0=Object.defineProperty,s1=Object.getOwnPropertyDescriptor,s2=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?s1(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&s0(t,n,i),i},"__decorateClass$2"),s5=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$2");let s3=(s6=class extends c.Disposable{constructor(e,t,n,r,o){super(),this._selectionProtectionRuleModel=e,this._permissionService=t,this._resourceManagerService=n,this._selectionProtectionCache=r,this._univerInstanceService=o,this._initSnapshot(),this._initRuleChange()}_initRuleChange(){this.disposeWithMe(this._selectionProtectionRuleModel.ruleChange$.subscribe(e=>{switch(e.type){case"add":ou().forEach(t=>{let n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(n)});break;case"delete":ou().forEach(t=>{let n=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.deletePermissionPoint(n.id)});break;case"set":e.oldRule.permissionId!==e.rule.permissionId&&ou().forEach(t=>{let n=new t(e.unitId,e.subUnitId,e.oldRule.permissionId);this._permissionService.deletePermissionPoint(n.id);let r=new t(e.unitId,e.subUnitId,e.rule.permissionId);this._permissionService.addPermissionPoint(r)})}}))}_initSnapshot(){let e=/* @__PURE__ */_(e=>{let t=this._selectionProtectionRuleModel.toObject()[e];return t?JSON.stringify(t):""},"toJson"),t=/* @__PURE__ */_(e=>{if(!e)return{};try{return JSON.parse(e)}catch{return{}}},"parseJson");this.disposeWithMe(this._resourceManagerService.registerPluginResource({toJson:e,parseJson:t,pluginName:"SHEET_RANGE_PROTECTION_PLUGIN",businesses:[eZ.UNIVER_SHEET],onLoad:/* @__PURE__ */_((e,t)=>{let n=this._selectionProtectionRuleModel.toObject();n[e]=t,this._selectionProtectionRuleModel.fromObject(n);let r=[];Object.keys(t).forEach(n=>{let o=t[n];this._selectionProtectionRuleModel.getSubunitRuleList(e,n).forEach(t=>{r.push({objectID:t.permissionId,unitID:e,objectType:e0.SelectRange,actions:od})}),o.forEach(t=>{ou().forEach(r=>{let o=new r(e,n,t.permissionId);o.value=!1,this._permissionService.addPermissionPoint(o)})}),this._selectionProtectionCache.reBuildCache(e,n)})},"onLoad"),onUnLoad:/* @__PURE__ */_(e=>{this._selectionProtectionCache.deleteUnit(e)},"onUnLoad")}))}},_(s6,"RangeProtectionService"),s6);s3=s2([s5(0,(0,c.Inject)(k)),s5(1,(0,c.Inject)(c.IPermissionService)),s5(2,(0,c.Inject)(c.IResourceManagerService)),s5(3,(0,c.Inject)(sN)),s5(4,(0,c.Inject)(c.IUniverInstanceService))],s3);var s4,s6,s7,s8=Object.defineProperty,s9=Object.getOwnPropertyDescriptor,ae=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?s9(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&s8(t,n,i),i},"__decorateClass$1"),at=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam$1");let an=(s7=class extends c.Disposable{constructor(e,t,n,r,o){super(),this._permissionService=e,this._univerInstanceService=t,this._rangeProtectionRuleModel=n,this._worksheetProtectionRuleModel=r,this._worksheetProtectionPointModel=o,this._init()}_init(){let e=/* @__PURE__ */_(e=>{let t=e.getUnitId();oc().forEach(e=>{let n=new e(t);this._permissionService.addPermissionPoint(n)})},"handleWorkbook");this._univerInstanceService.getAllUnitsForType(c.UniverInstanceType.UNIVER_SHEET).forEach(t=>{e(t)}),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitAdded$(c.UniverInstanceType.UNIVER_SHEET).subscribe(t=>{e(t)})),this.disposeWithMe(this._univerInstanceService.getTypeOfUnitDisposed$(c.UniverInstanceType.UNIVER_SHEET).subscribe(e=>{let t=e.getUnitId();e.getSheets().forEach(e=>{let n=e.getSheetId();this._rangeProtectionRuleModel.getSubunitRuleList(t,n).forEach(e=>{[...ou()].forEach(r=>{let o=new r(t,n,e.permissionId);this._permissionService.deletePermissionPoint(o.id)})}),[...om(),...og()].forEach(e=>{let r=new e(t,n);this._permissionService.deletePermissionPoint(r.id)})}),oc().forEach(e=>{let n=new e(t);this._permissionService.deletePermissionPoint(n.id)}),this._rangeProtectionRuleModel.deleteUnitModel(t),this._worksheetProtectionPointModel.deleteUnitModel(t),this._worksheetProtectionRuleModel.deleteUnitModel(t)}))}},_(s7,"WorkbookPermissionService"),s7);an=ae([at(0,(0,c.Inject)(c.IPermissionService)),at(1,(0,c.Inject)(c.IUniverInstanceService)),at(2,(0,c.Inject)(k)),at(3,(0,c.Inject)(of)),at(4,(0,c.Inject)(oC))],an);var ar=Object.defineProperty,ao=Object.getOwnPropertyDescriptor,ai=/* @__PURE__ */_((e,t,n)=>t in e?ar(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,"__defNormalProp"),as=/* @__PURE__ */_((e,t,n,r)=>{for(var o,i=r>1?void 0:r?ao(t,n):t,s=e.length-1;s>=0;s--)(o=e[s])&&(i=(r?o(t,n,i):o(i))||i);return r&&i&&ar(t,n,i),i},"__decorateClass"),aa=/* @__PURE__ */_((e,t)=>(n,r)=>t(n,r,e),"__decorateParam"),al=/* @__PURE__ */_((e,t,n)=>ai(e,"symbol"!=typeof t?t+"":t,n),"__publicField");let au=(_(d=class extends c.Plugin{constructor(e=ih,t,n){super(),this._config=e,this._injector=t,this._configService=n;let{...r}=this._config;this._configService.setConfig("sheets.config",r),this._initConfig(),this._initDependencies()}_initConfig(){var e,t;null!=(e=this._config)&&e.onlyRegisterFormulaRelatedMutations&&this._configService.setConfig(o4,!0),null!=(t=this._config)&&t.isRowStylePrecedeColumnStyle&&this._configService.setConfig(c.IS_ROW_STYLE_PRECEDE_COLUMN_STYLE,!0)}_initDependencies(){var e;let t=[[nK],[j],[st],[an],[oJ,{useClass:sq}],[X],[ii],[sp],[sU],[iC],[oy],[of],[oC],[s$],[k],[sN],[sQ],[s3],[sW,{useClass:sj,deps:[j]}]];null!=(e=this._config)&&e.notExecuteFormula||t.push([ic]),(0,c.registerDependencies)(this._injector,(0,c.mergeOverrideWithDependencies)(t,this._config.override)),(0,c.touchDependencies)(this._injector,[[X],[s3],[sW]])}onStarting(){(0,c.touchDependencies)(this._injector,[[ii],[sp],[an],[oy]])}onRendered(){(0,c.touchDependencies)(this._injector,[[oJ]])}onReady(){(0,c.touchDependencies)(this._injector,[[ic],[iC],[sU],[s$],[sQ],[st]])}},"UniverSheetsPlugin"),d);al(au,"pluginName","SHEET_PLUGIN"),al(au,"type",c.UniverInstanceType.UNIVER_SHEET),au=as([(0,c.DependentOn)(h.UniverFormulaEnginePlugin),aa(1,(0,c.Inject)(c.Injector)),aa(2,c.IConfigService)],au);let ad=[ok.id,ox.id,oN.id,r3.id,r1.id,nb.id,nM.id,rs.id,rl.id,rE.id,rU.id,ni.id,nr.id,nu.id,na.id,o$.id],ac=[eg.id,eN.id,nB.id,nj.id,nq.id,o1.id,rb.id,rr.id],ah=1.5,am="rgba(255, 255, 255, 0.01)";function ag(e){let t=e.getCurrentTheme(),n=new(0,c.ColorKit)(t.primaryColor).setAlpha(.07).toRgbString();return{strokeWidth:1,stroke:t.primaryColor,fill:n,widgets:{},widgetSize:6,widgetStrokeWidth:1,widgetStroke:t.colorWhite,hasAutoFill:!0,AutofillSize:6,AutofillStrokeWidth:1,AutofillStroke:t.colorWhite,hasRowHeader:!0,rowHeaderFill:n,rowHeaderStroke:t.primaryColor,rowHeaderStrokeWidth:1,hasColumnHeader:!0,columnHeaderFill:n,columnHeaderStroke:t.primaryColor,columnHeaderStrokeWidth:1,expandCornerSize:40}}function ap(e){let{rangeWithCoord:t,primaryWithCoord:n,style:r}=e,o={range:{startRow:t.startRow,startColumn:t.startColumn,endRow:t.endRow,endColumn:t.endColumn,rangeType:t.rangeType,unitId:t.unitId,sheetId:t.sheetId},primary:null,style:r};return null!=n&&(o.primary=aI(n)),o}function aI(e){let{actualRow:t,actualColumn:n,isMerged:r,isMergedMainCell:o}=e,{startRow:i,startColumn:s,endRow:a,endColumn:l}=e.mergeInfo;return{actualRow:t,actualColumn:n,isMerged:r,isMergedMainCell:o,startRow:i,startColumn:s,endRow:a,endColumn:l}}function aC(e,t,n){let r=(0,c.getCellInfoInMergeData)(e,t,n),o=(0,c.makeCellRangeToRangeData)(r);if(o)return{range:o,primary:r,style:null}}_(ag,"getNormalSelectionStyle"),_(ap,"convertSelectionDataToRange"),_(aI,"convertPrimaryWithCoordToPrimary"),_(aC,"transformCellDataToSelectionData");let aR=/* @__PURE__ */_((e,t,n)=>{let r=e.get(j).getCurrentSelections(),{value:o,selections:i,unitId:s,subUnitId:a}=t;if(r){let e=r[(null==r?void 0:r.length)-1].primary;if(e){let{actualColumn:t,actualRow:l}=e,{startRow:u,startColumn:d,endRow:h,endColumn:m}=i[i.length-1];if(o===c.Dimension.COLUMNS){let e=n.find(e=>e.startColumn===t&&e.endColumn===t&&l===e.startRow);e&&(m=e.endColumn,u=e.startRow,h=e.endRow)}else if(o===c.Dimension.ROWS){let e=n.find(e=>e.startRow===l&&e.endRow===l&&t===e.startColumn);e&&(h=e.endRow,d=e.startColumn,m=e.endColumn)}let g={startRow:u,startColumn:d,endRow:h,endColumn:m,actualRow:l,actualColumn:t,isMerged:!0,isMergedMainCell:u===l&&d===t},p=r.map((e,t,n)=>({range:e.range,style:null,primary:t===n.length-1?g:null}));return{id:ej.id,params:{unitId:s,subUnitId:a,selections:p}}}}return null},"AddMergeRedoSelectionsOperationFactory"),af=/* @__PURE__ */_((e,t)=>{let n=e.get(j).getCurrentSelections(),{unitId:r,subUnitId:o}=t;if(n&&n[(null==n?void 0:n.length)-1].primary){let e={unitId:r,subUnitId:o,selections:[...n]};return{id:ej.id,params:e}}return null},"AddMergeUndoSelectionsOperationFactory");function av(e){return null!=e&&(void 0!==e.v&&null!==e.v&&""!==e.v||void 0!==e.p)}function aS(e,t){return e&&e.spanAnchor?av(t.getValue(e.spanAnchor.startRow,e.spanAnchor.startColumn)):av(e)}function aw(e,t,n,r,o){let i=e.getCellMatrix(),s=e.getSpanModel().getMergedCellRange(t,n,r,o),a=new c.ObjectMatrix;return i.forValue((e,t)=>{let n=i.getValue(e,t);n&&a.setValue(e,t,n)}),s.forEach(e=>{let{startColumn:t,startRow:n,endColumn:r,endRow:o}=e;(0,c.createRowColIter)(n,o,t,r).forEach((e,s)=>{e===n&&s===t&&a.setValue(e,s,{...i.getValue(e,s),spanAnchor:{startRow:n,endRow:o,startColumn:t,endColumn:r}}),(e!==n||s!==t)&&(a.realDeleteValue(e,s),a.setValue(e,s,{spanAnchor:{startRow:n,endRow:o,startColumn:t,endColumn:r}}))})}),a}function ab(e,t,n,r){let{startRow:o,startColumn:i,endRow:s}=e,a=null,l=!1;for(let e=o;e<=s;e++){let o=t.getValue(e,i-n);if(l=l||aS(o,t),!r&&l)break;o&&o.spanAnchor&&(a=a?{startRow:Math.min(o.spanAnchor.startRow,a.startRow),startColumn:Math.min(o.spanAnchor.startColumn,a.startColumn),endRow:Math.max(o.spanAnchor.endRow,a.endRow),endColumn:Math.max(o.spanAnchor.endColumn,a.endColumn)}:{startRow:o.spanAnchor.startRow,startColumn:o.spanAnchor.startColumn,endRow:o.spanAnchor.endRow,endColumn:o.spanAnchor.endColumn})}return l?(e.startColumn=e.startColumn-n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function ay(e,t,n,r){let{startRow:o,endColumn:i,endRow:s}=e,a=null,l=!1;for(let e=o;e<=s;e++){let o=t.getValue(e,i+n);if(l=l||aS(o,t),!r&&l)break;o&&o.spanAnchor&&(a=a?{startRow:Math.min(o.spanAnchor.startRow,a.startRow),startColumn:Math.min(o.spanAnchor.startColumn,a.startColumn),endRow:Math.max(o.spanAnchor.endRow,a.endRow),endColumn:Math.max(o.spanAnchor.endColumn,a.endColumn)}:{startRow:o.spanAnchor.startRow,startColumn:o.spanAnchor.startColumn,endRow:o.spanAnchor.endRow,endColumn:o.spanAnchor.endColumn})}return l?(e.endColumn=e.endColumn+n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function aM(e,t,n,r){let{startRow:o,startColumn:i,endColumn:s}=e,a=null,l=!1;for(let e=i;e<=s;e++){let i=t.getValue(o-n,e);if(l=l||aS(i,t),!r&&l)break;i&&i.spanAnchor&&(a=a?{startRow:Math.min(i.spanAnchor.startRow,a.startRow),startColumn:Math.min(i.spanAnchor.startColumn,a.startColumn),endRow:Math.max(i.spanAnchor.endRow,a.endRow),endColumn:Math.max(i.spanAnchor.endColumn,a.endColumn)}:{startRow:i.spanAnchor.startRow,startColumn:i.spanAnchor.startColumn,endRow:i.spanAnchor.endRow,endColumn:i.spanAnchor.endColumn})}return l?(e.startRow=e.startRow-n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function aU(e,t,n,r){let{startColumn:o,endColumn:i,endRow:s}=e,a=null,l=!1;for(let e=o;e<=i;e++){let o=t.getValue(s+n,e);if(l=l||aS(o,t),!r&&l)break;o&&o.spanAnchor&&(a=a?{startRow:Math.min(o.spanAnchor.startRow,a.startRow),startColumn:Math.min(o.spanAnchor.startColumn,a.startColumn),endRow:Math.max(o.spanAnchor.endRow,a.endRow),endColumn:Math.max(o.spanAnchor.endColumn,a.endColumn)}:{startRow:o.spanAnchor.startRow,startColumn:o.spanAnchor.startColumn,endRow:o.spanAnchor.endRow,endColumn:o.spanAnchor.endColumn})}return l?(e.endRow=e.endRow+n,{spanAnchor:a,hasValue:!0,range:e}):{spanAnchor:null,hasValue:!1,range:e}}function a_(e,t,n){let r=n.getMaxRows(),o=n.getMaxColumns(),i=aw(n,0,0,r-1,o-1),s=n.getSnapshot().mergeData.length>0,{left:a,right:l,up:u,down:d}=t,h=!0,m={...e},g=[];for(;h;){if(h=!1,u&&0!==m.startRow){let{hasValue:e,range:t,spanAnchor:n}=aM(m,i,1,s);if(n&&g.push(n),e){m=t,h=!0;continue}}if(d&&m.endRow!==r-1){let{hasValue:e,range:t,spanAnchor:n}=aU(m,i,1,s);if(n&&g.push(n),e){m=t,h=!0;continue}}if(a&&0!==m.startColumn){let{hasValue:e,range:t,spanAnchor:n}=ab(m,i,1,s);if(n&&g.push(n),e){m=t,h=!0;continue}}if(l&&m.endColumn!==o-1){let{hasValue:e,range:t,spanAnchor:n}=ay(m,i,1,s);if(n&&g.push(n),e){m=t,h=!0;continue}}}return g.length>0&&(m=(0,c.Rectangle).union(m,...g)),m}function aE(e,t){return t.some(t=>aT(e,t))}function aT(e,t){let{startRow:n,startColumn:r,endColumn:o,endRow:i}=t,s=e.getMatrixWithMergedCells(n,r,i,o),a=!1;return s.forValue((t,o,i)=>{if(i&&(t!==n||o!==r)&&e.cellHasValue(i))return a=!0,!1}),a}function ak(e,t,n,r){let o=[],i=[],s=n.getSheetId();return r.forEach(r=>{let a={unitId:t,subUnitId:s,cellValue:ax(n,r).getData()},l=em(e,a);o.push({id:eg.id,params:l}),i.push({id:eg.id,params:a})}),{undos:o,redos:i}}function ax(e,t){let{startRow:n,startColumn:r,endColumn:o,endRow:i}=t,s=e.getMatrixWithMergedCells(n,r,i,o,!0),a=new c.ObjectMatrix;return s.forValue((e,t,o)=>{o&&(e!==n||t!==r)&&a.setValue(e,t,null)}),a}_(av,"cellHasValue"),_(aS,"hasValueFromMatrixWithSpanInfo"),_(aw,"getMatrixWithSpanInfo"),_(ab,"getExpandedRangeLeft"),_(ay,"getExpandedRangeRight"),_(aM,"getExpandedRangeUp"),_(aU,"getExpandedRangeDown"),_(a_,"expandToContinuousRange"),_(aE,"checkCellContentInRanges"),_(aT,"checkCellContentInRange"),_(ak,"getClearContentMutationParamsForRanges"),_(ax,"getClearContentMutationParamForRange");let aN={type:c.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge",handler:/* @__PURE__ */_(async(e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),o=e.get(c.IUniverInstanceService),i=t.unitId,s=t.subUnitId,a=sm(t.selections,t.value),l=o.getUniverSheetInstance(i).getSheetBySheetId(s),u=[],d=[],h=aE(l,a),m={unitId:i,subUnitId:s,ranges:a},g={unitId:i,subUnitId:s,ranges:a};u.push({id:nB.id,params:m}),u.push({id:nj.id,params:g});let p=nL(e,m),I=nW(e,g);if(d.push({id:nB.id,params:I}),d.push({id:nj.id,params:p}),h){let t=ak(e,i,l,a);u.unshift(...t.redos),d.push(...t.undos)}return!!(0,c.sequenceExecute)(u,n).result&&(r.pushUndoRedo({unitID:i,undoMutations:d,redoMutations:u}),!0)},"handler")},aO={type:c.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-all",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(c.ICommandService),r=null==(t=e.get(j).getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=r&&r.length))return!1;let o=e.get(c.IUniverInstanceService).getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let i=o.getActiveSheet();if(!i)return!1;let s=o.getUnitId(),a=i.getSheetId();return n.executeCommand(aN.id,{selections:r,unitId:s,subUnitId:a})},"handler")},aD={type:c.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-vertical",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(c.ICommandService),r=null==(t=e.get(j).getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=r&&r.length))return!1;let o=e.get(c.IUniverInstanceService).getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let i=o.getActiveSheet();if(!i)return!1;let s=o.getUnitId(),a=i.getSheetId();return n.executeCommand(aN.id,{value:c.Dimension.COLUMNS,selections:r,unitId:s,subUnitId:a})},"handler")},aP={type:c.CommandType.COMMAND,id:"sheet.command.add-worksheet-merge-horizontal",handler:/* @__PURE__ */_(async e=>{var t;let n=e.get(c.ICommandService),r=null==(t=e.get(j).getCurrentSelections())?void 0:t.map(e=>e.range);if(!(null!=r&&r.length))return!1;let o=e.get(c.IUniverInstanceService).getCurrentUnitForType(c.UniverInstanceType.UNIVER_SHEET);if(!o)return!1;let i=o.getActiveSheet();if(!i)return!1;let s=o.getUnitId(),a=i.getSheetId();return n.executeCommand(aN.id,{value:c.Dimension.ROWS,selections:r,unitId:s,subUnitId:a})},"handler")};async function aA(e,t,n,r){let o=eU(e.get(c.IUniverInstanceService),{unitId:t,subUnitId:n});if(!o)return;let{worksheet:i}=o;if(i.getMergeData().some(e=>r.some(t=>(0,c.Rectangle).intersects(t,e))))throw Error("The ranges to be merged overlap with the existing merged cells");await e.get(c.ICommandService).executeCommand(aN.id,{unitId:t,subUnitId:n,selections:r})}_(aA,"addMergeCellsUtil");let aV={type:c.CommandType.COMMAND,id:"sheet.command.set-worksheet-default-style",handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.ICommandService),r=e.get(c.IUndoRedoService),{unitId:o}=t,i=o2(e,t);return!!n.syncExecuteCommand(o1.id,t)&&(r.pushUndoRedo({unitID:o,undoMutations:[{id:o1.id,params:i}],redoMutations:[{id:o1.id,params:t}]}),!0)},"handler")},a$=/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId).getSheetBySheetId(t.subUnitId).getConfig().rightToLeft;return{...(0,c.Tools).deepClone(t),rightToLeft:n}},"SetWorksheetRightToLeftUndoMutationFactory"),aW={id:"sheet.mutation.set-worksheet-right-to-left",type:c.CommandType.MUTATION,handler:/* @__PURE__ */_((e,t)=>{let n=e.get(c.IUniverInstanceService).getUniverSheetInstance(t.unitId);if(!n)return!1;let r=n.getSheetBySheetId(t.subUnitId);return!!r&&(r.getConfig().rightToLeft=t.rightToLeft,!0)},"handler")};c.CommandType.COMMAND,/* @__PURE__ */async(e,t)=>{var n;let r=e.get(c.ICommandService),o=e.get(c.IUndoRedoService),i=eU(e.get(c.IUniverInstanceService),t);if(!i)return!1;let{unitId:s,subUnitId:a}=i,l=c.BooleanNumber.FALSE;t&&(l=null!=(n=t.rightToLeft)?n:c.BooleanNumber.FALSE);let u={rightToLeft:l,unitId:s,subUnitId:a},d=a$(e,u);return!!r.syncExecuteCommand(aW.id,u)&&(o.pushUndoRedo({unitID:s,undoMutations:[{id:aW.id,params:d}],redoMutations:[{id:aW.id,params:u}]}),!0)}}),n("23cfA",function(n,r){e(n.exports,"switchMap",function(){return a});var o=t("b7gpN"),i=t("jSzwf"),s=t("iNetn");function a(e,t){return(0,i.operate)(function(n,r){var i=null,a=0,l=!1,u=function(){return l&&!i&&r.complete()};n.subscribe((0,s.createOperatorSubscriber)(r,function(n){null==i||i.unsubscribe();var l=0,d=a++;(0,o.innerFrom)(e(n,d)).subscribe(i=(0,s.createOperatorSubscriber)(r,function(e){return r.next(t?t(n,e,d,l++):e)},function(){i=null,u()}))},function(){l=!0,u()}))})}}),n("2BOVU",function(t,n){e(t.exports,"DEFAULT_TEXT_FORMAT",function(){return r});let r="@@@"});
//# sourceMappingURL=es.c8d85d43.js.map
